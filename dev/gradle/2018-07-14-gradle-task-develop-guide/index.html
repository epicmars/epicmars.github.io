<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Gradle构建：Task开发指南 | 
    风格与布局
  
</title><meta name="description" content="Android移动应用开发"><meta name="author" content="jastrelax">

<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png " sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0c344b">
<link rel="icon" href="/favicon.ico">




    
        
            <link rel="stylesheet" href="/dist/main.37ab3f61b95417873748.min.css">
        
    




<link rel="canonical" href="https://www.androidpi.com/dev/gradle/2018-07-14-gradle-task-develop-guide/"><meta property="og:title" content="Gradle构建：Task开发指南" />
<meta property="og:description" content="简单的任务 一个任务代表一个构建执行的一部分工作（atomic piece of work）。它可能是编译一些类、创建一个JAR、生成Javadoc或者将一存" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.androidpi.com/dev/gradle/2018-07-14-gradle-task-develop-guide/" />
<meta property="article:published_time" content="2018-07-14T11:23:10+08:00" />
<meta property="article:modified_time" content="2018-07-14T11:23:10+08:00" />
<meta itemprop="name" content="Gradle构建：Task开发指南">
<meta itemprop="description" content="简单的任务 一个任务代表一个构建执行的一部分工作（atomic piece of work）。它可能是编译一些类、创建一个JAR、生成Javadoc或者将一存">
<meta itemprop="datePublished" content="2018-07-14T11:23:10&#43;08:00" />
<meta itemprop="dateModified" content="2018-07-14T11:23:10&#43;08:00" />
<meta itemprop="wordCount" content="1154">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Gradle构建：Task开发指南"/>
<meta name="twitter:description" content="简单的任务 一个任务代表一个构建执行的一部分工作（atomic piece of work）。它可能是编译一些类、创建一个JAR、生成Javadoc或者将一存"/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand font-weight-bold" href="https://www.androidpi.com/">风格与布局</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="main-menu">
            <ul class="navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/android/">Android</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/blockchain/">Blockchain</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/book/">Books</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/cs/">CS</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/ee/">EE</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/java/">Java</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/puzzles/">Puzzles</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/web/">Web</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/backend/">后端</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/engineering/">工程与架构</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/dev/">开发</a></li>
                
            
            </ul>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    <div class="row">
        <div class="col">
            <article>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="mb-3">Gradle构建：Task开发指南</h2>

                        <div class="content">
                            <h2 id="简单的任务">简单的任务</h2>
<p>一个任务代表一个构建执行的一部分工作（atomic piece of work）。它可能是编译一些类、创建一个JAR、生成Javadoc或者将一存档文件（archives）发布到一个仓库。</p>
<h3 id="hello-world">Hello world</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">task hello <span style="color:#f92672">{</span>
    doLast <span style="color:#f92672">{</span>
        println <span style="color:#e6db74">&#39;Hello world!&#39;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="强化的任务">强化的任务</h2>
<p>除了简单执行的任务，任务还可以拥有自己的属性和方法。</p>
<h3 id="任务产出outcome">任务产出（outcome）</h3>
<p>当Gradle执行一个任务时，会根据任务的产出对其进行标记。这些标记取决于任务是否有操作要执行、是否应当执行这些操作、是否执行了这些操作、这些操作是否改变了什么。</p>
<h3 id="任务定义">任务定义</h3>
<p>build.gradle</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">task<span style="color:#f92672">(</span>hello<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    doLast <span style="color:#f92672">{</span>
        println <span style="color:#e6db74">&#34;hello&#34;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

task<span style="color:#f92672">(</span>copy<span style="color:#f92672">,</span> type: Copy<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    from<span style="color:#f92672">(</span>file<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;srcDir&#39;</span><span style="color:#f92672">))</span>
    into<span style="color:#f92672">(</span>buildDir<span style="color:#f92672">)</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>或者：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">tasks<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;hello&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    doLast <span style="color:#f92672">{</span>
        println <span style="color:#e6db74">&#34;hello&#34;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

tasks<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;copy&#39;</span><span style="color:#f92672">,</span> Copy<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    from<span style="color:#f92672">(</span>file<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;srcDir&#39;</span><span style="color:#f92672">))</span>
    into<span style="color:#f92672">(</span>buildDir<span style="color:#f92672">)</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="定位任务">定位任务</h3>
<ul>
<li>作为属性进行访问</li>
<li>使用tasks集合进行访问</li>
<li>通过路径进行访问</li>
</ul>
<h3 id="任务配置">任务配置</h3>
<p>注意：根据构建的生命周期，任务配置会在配置阶段执行。</p>
<ul>
<li>
<p>配置任务对象</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">task <span style="color:#a6e22e">myCopy</span><span style="color:#f92672">(</span>type: Copy<span style="color:#f92672">)</span>

Copy myCopy <span style="color:#f92672">=</span> task<span style="color:#f92672">(</span>myCopy<span style="color:#f92672">,</span> type: Copy<span style="color:#f92672">)</span>
myCopy<span style="color:#f92672">.</span><span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;resources&#39;</span>
myCopy<span style="color:#f92672">.</span><span style="color:#a6e22e">into</span> <span style="color:#e6db74">&#39;target&#39;</span>
myCopy<span style="color:#f92672">.</span><span style="color:#a6e22e">include</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;**/*.txt&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;**/*.xml&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;**/*.properties&#39;</span><span style="color:#f92672">)</span>
</code></pre></div></li>
<li>
<p>使用闭包进行配置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">task <span style="color:#a6e22e">myCopy</span><span style="color:#f92672">(</span>type: Copy<span style="color:#f92672">)</span>

myCopy <span style="color:#f92672">{</span>
from <span style="color:#e6db74">&#39;resources&#39;</span>
into <span style="color:#e6db74">&#39;target&#39;</span>
include<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;**/*.txt&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;**/*.xml&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;**/*.properties&#39;</span><span style="color:#f92672">)</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>使用闭包定义任务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">task <span style="color:#a6e22e">copy</span><span style="color:#f92672">(</span>type: Copy<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
from <span style="color:#e6db74">&#39;resources&#39;</span>
into <span style="color:#e6db74">&#39;target&#39;</span>
include<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;**/*.txt&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;**/*.xml&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;**/*.properties&#39;</span><span style="color:#f92672">)</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
</ul>
<h3 id="向任务构造器传递参数">向任务构造器传递参数</h3>
<p>定义一个使用@Inject注解的任务类：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomTask</span> <span style="color:#66d9ef">extends</span> DefaultTask <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> String message
    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> number

    <span style="color:#a6e22e">@Inject</span>
    CustomTask<span style="color:#f92672">(</span>String message<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> number<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">message</span> <span style="color:#f92672">=</span> message
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">number</span> <span style="color:#f92672">=</span> number
    <span style="color:#f92672">}</span>
</code></pre></div><p>然后可以向构造器传递参数了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">tasks<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;myTask&#39;</span><span style="color:#f92672">,</span> CustomTask<span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;hello&#39;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">42</span><span style="color:#f92672">)</span>

task <span style="color:#a6e22e">myTask</span><span style="color:#f92672">(</span>type: CustomTask<span style="color:#f92672">,</span> constructorArgs: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;hello&#39;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">42</span><span style="color:#f92672">])</span>
</code></pre></div><h3 id="向任务添加依赖">向任务添加依赖</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">project<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;projectA&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    task <span style="color:#a6e22e">taskX</span><span style="color:#f92672">(</span>dependsOn: <span style="color:#e6db74">&#39;:projectB:taskY&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        doLast <span style="color:#f92672">{</span>
            println <span style="color:#e6db74">&#39;taskX&#39;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

project<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;projectB&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    task taskY <span style="color:#f92672">{</span>
        doLast <span style="color:#f92672">{</span>
            println <span style="color:#e6db74">&#39;taskY&#39;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="任务排序">任务排序</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">task taskX <span style="color:#f92672">{</span>
    doLast <span style="color:#f92672">{</span>
        println <span style="color:#e6db74">&#39;taskX&#39;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
task taskY <span style="color:#f92672">{</span>
    doLast <span style="color:#f92672">{</span>
        println <span style="color:#e6db74">&#39;taskY&#39;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
taskY<span style="color:#f92672">.</span><span style="color:#a6e22e">mustRunAfter</span> taskX
</code></pre></div><h3 id="给任务添加描述">给任务添加描述</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">task <span style="color:#a6e22e">copy</span><span style="color:#f92672">(</span>type: Copy<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
   description <span style="color:#e6db74">&#39;Copies the resource directory to the target directory.&#39;</span>
   from <span style="color:#e6db74">&#39;resources&#39;</span>
   into <span style="color:#e6db74">&#39;target&#39;</span>
   include<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;**/*.txt&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;**/*.xml&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;**/*.properties&#39;</span><span style="color:#f92672">)</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="替换任务">替换任务</h3>
<p>有时你想替换一个任务，例如将一个Java插件添加的任务替换为一个不同类型的自定义任务：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">task <span style="color:#a6e22e">copy</span><span style="color:#f92672">(</span>type: Copy<span style="color:#f92672">)</span>

task <span style="color:#a6e22e">copy</span><span style="color:#f92672">(</span>overwrite: <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    doLast <span style="color:#f92672">{</span>
        println<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;I am the new one.&#39;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="跳过任务">跳过任务</h3>
<h3 id="增量构建">增量构建</h3>
<p>构建中的一项能力就是避免进行已经做过的工作。</p>
<h4 id="任务输入和输出">任务输入和输出</h4>
<p>在最常见的情形中，一个任务接收一些输入然后生成一些输出。如下图所示：</p>
<p><img src="/assets/images/gradle/task-inputs-outputs.png" alt="任务输入与输出"></p>
<p>作为增量构建的一部分，Gradle测试上一次构建中任务的的输入和输出是否有变化。如果没有，那么Gradle就认为任务是最新的（没有过时），因此会跳过执行其操作。注意，如果任务没有输出，那么增量构建不会起作用。</p>
<p>这意味着，你需要告诉Gradle那些任务属性是输入，那些是输出。如果一个任务属性影响到输出，那么一定要将其注册为输入，不然任务就会认为是最新的，但实际上可能不是。反之，如果属性不影响输出那就不要将其注册为输入。还需要注意的是，非确定性的任务对相同的输入可能产生不同的输出，这些不应当配置到增量构建中，因为up-to-date检查不会起作用。</p>
<h3 id="任务规则">任务规则</h3>
<p>有时你想拥有一个依赖于大的或无限数量参数范围的任务。一个优雅而具有表达力的方式就是任务规则：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">tasks<span style="color:#f92672">.</span><span style="color:#a6e22e">addRule</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Pattern: ping&lt;ID&gt;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> String taskName <span style="color:#f92672">-&gt;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>taskName<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ping&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        task<span style="color:#f92672">(</span>taskName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            doLast <span style="color:#f92672">{</span>
                println <span style="color:#e6db74">&#34;Pinging: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>taskName <span style="color:#f92672">-</span> <span style="color:#e6db74">&#39;ping&#39;</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="终结任务">终结任务</h3>
<p>当被终结的任务将要执行时，终结任务会自动加入到任务图中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">task taskX <span style="color:#f92672">{</span>
    doLast <span style="color:#f92672">{</span>
        println <span style="color:#e6db74">&#39;taskX&#39;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
task taskY <span style="color:#f92672">{</span>
    doLast <span style="color:#f92672">{</span>
        println <span style="color:#e6db74">&#39;taskY&#39;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

taskX<span style="color:#f92672">.</span><span style="color:#a6e22e">finalizedBy</span> taskY
</code></pre></div><h3 id="生命周期任务">生命周期任务</h3>
<p>生命周期任务是自身不进行工作的任务。它代表若干概念：</p>
<ul>
<li>一个工作流步骤</li>
<li>一个可以构建的东西</li>
<li>一个用来执行许多相同逻辑任务的便利任务</li>
</ul>

                        </div>
                    </div>
                </div>
            </article>
        </div>
    </div>
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    
                </ul>

                <p class="text-muted">
                    
                        Copyright &copy; 风格与布局 2020
                    
                </p>

                <p class="text-muted">
                Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with <a href="https://github.com/puresyntax71/hugo-theme-chunky-poster" target="_blank">Chunky Poster</a>.
                </p>

                <p class="text-muted">
                    <a href="http://beian.miit.gov.cn" target="_blank">蜀ICP备18005659号-1</a>
                </p>
            
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.d608eadfe5ac0688902e.min.js"></script>
        
    








    
</body>
</html>
