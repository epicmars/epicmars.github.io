<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Gradle构建：增量构建 | 
    风格与布局
  
</title><meta name="description" content="Android移动应用开发"><meta name="author" content="jastrelax">

<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png " sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0c344b">
<link rel="icon" href="/favicon.ico">




    
        
            <link rel="stylesheet" href="/dist/main.37ab3f61b95417873748.min.css">
        
    




<link rel="canonical" href="https://www.androidpi.com/dev/gradle/2018-07-14-gradle-incremental-build/"><meta property="og:title" content="Gradle构建：增量构建" />
<meta property="og:description" content="构建中的一项能力就是避免进行已经做过的工作。考虑编译的过程，一旦你的源代码已经编译过了，除非作出了影响输出的修改，那就没有必要重新编译。Gr" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.androidpi.com/dev/gradle/2018-07-14-gradle-incremental-build/" />
<meta property="article:published_time" content="2018-07-14T14:04:45+08:00" />
<meta property="article:modified_time" content="2018-07-14T14:04:45+08:00" />
<meta itemprop="name" content="Gradle构建：增量构建">
<meta itemprop="description" content="构建中的一项能力就是避免进行已经做过的工作。考虑编译的过程，一旦你的源代码已经编译过了，除非作出了影响输出的修改，那就没有必要重新编译。Gr">
<meta itemprop="datePublished" content="2018-07-14T14:04:45&#43;08:00" />
<meta itemprop="dateModified" content="2018-07-14T14:04:45&#43;08:00" />
<meta itemprop="wordCount" content="2543">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Gradle构建：增量构建"/>
<meta name="twitter:description" content="构建中的一项能力就是避免进行已经做过的工作。考虑编译的过程，一旦你的源代码已经编译过了，除非作出了影响输出的修改，那就没有必要重新编译。Gr"/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand font-weight-bold" href="https://www.androidpi.com/">风格与布局</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="main-menu">
            <ul class="navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/android/">Android</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/blockchain/">Blockchain</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/book/">Books</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/cs/">CS</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/ee/">EE</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/java/">Java</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/puzzles/">Puzzles</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/web/">Web</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/backend/">后端</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/engineering/">工程与架构</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/dev/">开发</a></li>
                
            
            </ul>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    <div class="row">
        <div class="col">
            <article>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="mb-3">Gradle构建：增量构建</h2>

                        <div class="content">
                            <p>构建中的一项能力就是避免进行已经做过的工作。考虑编译的过程，一旦你的源代码已经编译过了，除非作出了影响输出的修改，那就没有必要重新编译。Gradle原生就支持增量构建，你可能已经见到过了：在运行构建时，每次一个任务名称旁出现<code>UP-TO-DATE</code>文字就表明进行了增量构建。</p>
<h2 id="任务输入和输出">任务输入和输出</h2>
<p>在最常见的情形中，一个任务接收一些输入然后生成一些输出。如下图所示：</p>
<p><img src="/assets/images/gradle/task-inputs-outputs.png" alt="任务输入与输出"></p>
<p>作为增量构建的一部分，Gradle测试上一次构建中任务的的输入和输出是否有变化。如果没有，那么Gradle就认为任务是最新的（没有过时），因此会跳过执行其操作。注意，如果任务没有输出，那么增量构建不会起作用。</p>
<p>这意味着，你需要告诉Gradle那些任务属性是输入，那些是输出。如果一个任务属性影响到输出，那么一定要将其注册为输入，不然任务就会认为是最新的，但实际上可能不是。反之，如果属性不影响输出那就不要将其注册为输入。还需要注意的是，非确定性的任务对相同的输入可能产生不同的输出，这些不应当配置到增量构建中，因为up-to-date检查不会起作用。</p>
<h2 id="自定义任务类型">自定义任务类型</h2>
<p>如果你实现了一个自定义Task类型，那么需要以下两步就可以应用增量构建：</p>
<ol>
<li>为每个任务的输入和输出创建类型化属性（通过getter方法）</li>
<li>给每个这样的属性添加合适的注解</li>
</ol>
<blockquote>
<p>注意：注解必须放在Groovy属性的getter方法上。放在setter方法上的注解，或者一个Java域的注解（没有对应的注解getter方法）会被忽略。</p>
</blockquote>
<p>Gradle支持3种类型的输入和输出：</p>
<ul>
<li>
<p>简单值</p>
<p>例如字符串和数字。更一般地，一个简单值可以有任何实现<code>Serilizable</code>的类型。</p>
</li>
<li>
<p>文件系统类型</p>
<p>这包括标准的<code>File</code>类，以及Gradle的派生类型<code>FileCollection</code>和任何可以传递给<code>Project.file(java.lang.Object) </code>方法的类型，如单文件/目录属性，或者<code>Project.files(java.lang.Object[]), ProjectLayout.files(java.lang.Object[])</code>和<code>ProjectLayout.configurableFiles(java.lang.Object[])</code>方法。</p>
</li>
<li>
<p>嵌套值</p>
<p>与前两种类型不符的自定义类型，但拥有自己的输入和输出属性。实际上，该任务的输入或输出嵌套这些自定义类型内部。</p>
</li>
</ul>
<p>例如，想象你有一个处理各种类型模板的任务，如<code>FreeMarker</code>，<code>Velocity</code>，<code>Moustache</code>等。它接收模板源码文件并将其与一些模型数据结合起来，来生成模板文件的填充版。</p>
<p>该任务会有三个输入和一个输出：</p>
<ul>
<li>模板源代码文件</li>
<li>模型数据</li>
<li>模板引擎</li>
<li>输出文件输出位置</li>
</ul>
<p>在编写自定义任务类时，使用注解可以容易地将属性注册为输入和输出。为了说明这点，以下是一个任务实现框架，它有一些合适输入和输出，以及相应的注解：</p>
<p>buildSrc/src/main/java/org/example/ProcessTemplates.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#f92672">package</span> org<span style="color:#f92672">.</span><span style="color:#a6e22e">example</span><span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.io.File<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.util.HashMap<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.gradle.api.*<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.gradle.api.file.*<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.gradle.api.tasks.*<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProcessTemplates</span> <span style="color:#66d9ef">extends</span> DefaultTask <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> TemplateEngineType templateEngine<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> FileCollection sourceFiles<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> TemplateData templateData<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> File outputDir<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Input</span>
    <span style="color:#66d9ef">public</span> TemplateEngineType <span style="color:#a6e22e">getTemplateEngine</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">templateEngine</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@InputFiles</span>
    <span style="color:#66d9ef">public</span> FileCollection <span style="color:#a6e22e">getSourceFiles</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sourceFiles</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Nested</span>
    <span style="color:#66d9ef">public</span> TemplateData <span style="color:#a6e22e">getTemplateData</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">templateData</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@OutputDirectory</span>
    <span style="color:#66d9ef">public</span> File <span style="color:#a6e22e">getOutputDir</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">outputDir</span><span style="color:#f92672">;</span> <span style="color:#f92672">}</span>

    <span style="color:#75715e">// + setter methods for the above - assume we’ve defined them
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">@TaskAction</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processTemplates</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>buildSrc/src/main/java/org/example/TemplateData.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#f92672">package</span> org<span style="color:#f92672">.</span><span style="color:#a6e22e">example</span><span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.util.HashMap<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.util.Map<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.gradle.api.tasks.Input<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TemplateData</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> variables<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">TemplateData</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> variables<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> name<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">variables</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;(</span>variables<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Input</span>
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span><span style="color:#f92672">;</span> <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Input</span>
    <span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> getVariables<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">variables</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><pre><code>Output of gradle processTemplates

&gt; gradle processTemplates
&gt; Task :processTemplates


BUILD SUCCESSFUL in 0s
1 actionable task: 1 executed
Output of gradle processTemplates

# 再次执行任务

&gt; gradle processTemplates
&gt; Task :processTemplates UP-TO-DATE

BUILD SUCCESSFUL in 0s
1 actionable task: 1 up-to-date
</code></pre>
<p>对于这个例子，来依次理解下每个输入和输出：</p>
<ul>
<li>
<p><code>templateEngine</code></p>
<p>代表处理源码模板时使用哪个引擎，例如<code>FreeMarker</code>，<code>Velocity</code>，等。你可以将其实现为一个字符串，但这个例子中我们使用一个自定义枚举，因为它提供更强的类型信息和更高的安全性。由于枚举自动实现了<code>Serializable</code>，我们可以将其作为一个简单值，并使用<code>@Input</code>注解，正如可以在<code>String</code>类型上使用一样。</p>
</li>
<li>
<p><code>sourceFiles</code></p>
<p>表示任务要处理的源码模板。单个文件和文件集合需要对应的特殊注解。这里处理的是文件集合，因此使用的是<code>@InputFiles</code>注解。</p>
</li>
<li>
<p><code>templateData</code></p>
<p>这个例子中使用了一个自定义来代表模型数据。然而，它没有实现<code>Serializable</code>接口，因此我们不能使用<code>@Input</code>注解。这不是问题，因为<code>TemplateData</code>内部是一个字符串和具有可序列化类型参数的hash表，它们都是可序列化的，并且可以使用<code>@Input</code>注解。我们使用<code>@Nested</code>注解表明该值是嵌套的输入属性。</p>
</li>
<li>
<p><code>outputDir</code></p>
<p>代表生成文件的目录。对于输入文件，有若干注解用于输出文件和目录。一个代表单个目录的属性需要<code>@OutputDeirectory</code>。</p>
</li>
</ul>
<p>这些注解属性意味着，如果没有源文件、模板引擎、模型数据或者生成文件发生改变，那么Gradle会跳过任务的执行。</p>
<p>还有一个<strong>增量任务</strong>特性，即如果仅部分输入文件发生了变化，此时不能跳过该任务的执行，但可以仅处理发生变化的输入，对于一个将输入和输出进行1对1转换的任务来这个特性尤其有用。</p>
<h3 id="增量构建属性类型注解incremental-build-property-type-annotations">增量构建属性类型注解（Incremental build property type annotations）</h3>
<ul>
<li><code>@Input</code></li>
<li><code>@InputFile</code></li>
<li>等等</li>
</ul>
<h3 id="附加注解">附加注解</h3>
<ul>
<li><code>@SkipWhenEmpty</code></li>
<li><code>@Optional</code></li>
<li><code>@PathSensitive</code></li>
</ul>
<h2 id="运行时api">运行时API</h2>
<p>自定义任务类是增量构建的一种简便的方式，但你并不是总有这种选项。这就是为什么Gradle也提供了可选的API，可以应用到任意任务。</p>
<p>当你不能访问一个自定义任务类的源代码时，不能像前面一样添加注解。Gradle提供了运行时API用于这样的场景中。它也可以用于临时（ad-hoc）任务。</p>
<h3 id="运用到临时任务">运用到临时任务</h3>
<p>运行时API使用了一些合适命名的属性用于Gradle任务：</p>
<ul>
<li><code>Task.getInputs()</code>对应<code>TaskInputs</code></li>
<li><code>Task.getOutputs()</code>对应<code>TaskOutputs</code></li>
<li><code>Task.getDestroyables()</code>对应<code>TaskDestroyables</code></li>
</ul>
<p>这些对象的方法允许你指定为输入和输出作出贡献的文件、目录和值。实际上，运行时API提供了注解的绝大多数特性。唯一缺少的是声明实际的文件和目录。如果输出目录不存在那么它也不能创建，就是这样。</p>
<p>build.gradle</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">task processTemplatesAdHoc <span style="color:#f92672">{</span>
    inputs<span style="color:#f92672">.</span><span style="color:#a6e22e">property</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;engine&#34;</span><span style="color:#f92672">,</span> TemplateEngineType<span style="color:#f92672">.</span><span style="color:#a6e22e">FREEMARKER</span><span style="color:#f92672">)</span>
    inputs<span style="color:#f92672">.</span><span style="color:#a6e22e">files</span><span style="color:#f92672">(</span>fileTree<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;src/templates&#34;</span><span style="color:#f92672">))</span>
    inputs<span style="color:#f92672">.</span><span style="color:#a6e22e">property</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;templateData.name&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;docs&#34;</span><span style="color:#f92672">)</span>
    inputs<span style="color:#f92672">.</span><span style="color:#a6e22e">property</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;templateData.variables&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">[</span>year: <span style="color:#ae81ff">2013</span><span style="color:#f92672">])</span>
    outputs<span style="color:#f92672">.</span><span style="color:#a6e22e">dir</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;$buildDir/genOutput2&#34;</span><span style="color:#f92672">)</span>

    doLast <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Process the templates here
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>和前面一样，没有太多需要讲解的。首先，你应当有一个对应自定义的任务类，因为它有一些配置选项。这种情况下，没有任务属性来存储根源目录、输出目录的位置或其它设置。这是故意为之的，运行时API不需要任务有任何状态。从增量构建来讲，上面的临时任务的行为和自定义任务类是一样的。</p>
<p>参考：</p>
<ul>
<li><a href="https://docs.gradle.org/4.8/userguide/more_about_tasks.html#sec:up_to_date_checks">Authoring Tasks</a></li>
<li><a href="https://docs.gradle.org/4.8/userguide/custom_tasks.html#incremental_tasks">Writing Custom Task Classes</a></li>
</ul>

                        </div>
                    </div>
                </div>
            </article>
        </div>
    </div>
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    
                </ul>

                <p class="text-muted">
                    
                        Copyright &copy; 风格与布局 2020
                    
                </p>

                <p class="text-muted">
                Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with <a href="https://github.com/puresyntax71/hugo-theme-chunky-poster" target="_blank">Chunky Poster</a>.
                </p>

                <p class="text-muted">
                    <a href="http://beian.miit.gov.cn" target="_blank">蜀ICP备18005659号-1</a>
                </p>
            
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.d608eadfe5ac0688902e.min.js"></script>
        
    








    
</body>
</html>
