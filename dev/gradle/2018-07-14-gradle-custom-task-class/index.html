<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" >
        <meta lang="zh">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Gradle构建：自定义Task类 | 风格与布局</title>
<meta name="description" content="Gradle支持两种类型的任务，一种是使用一个操作闭包定义的简单任务，对于这种类型的任务，操作闭包决定了任务的行为，它对于实现构建脚本中的一">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/solid.css" integrity="sha384-TbilV5Lbhlwdyc4RuIV/JhD8NR+BfMrvz4BL5QFa2we1hQu6wvREr3v6XSRfCTRp" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/brands.css" integrity="sha384-7xAnn7Zm3QC1jFjVc1A6v/toepoG3JXboQYzbM0jrPzou9OFXm/fY6Z/XiIebl/k" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/fontawesome.css" integrity="sha384-ozJwkrqb90Oa3ZNb+yKFW2lToAWYdTiF1vt8JiH5ptTGHTGcN7qdoR1F95e0kYyG" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
        
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="/css/article.css" />

    </head>

    <body>
        <div class="site-wrapper">
                <header>
    <nav>
        <a class="home" href="https://www.androidpi.com/">首页</a>
    </nav>
    
</header>
                <div class="site-main">
                    
    <div class="main">
        <div class="article">
            <aside>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#打包一个任务类">打包一个任务类</a></li>
    <li><a href="#编写一个简单任务类">编写一个简单任务类</a></li>
    <li><a href="#独立工程">独立工程</a>
      <ul>
        <li><a href="#在另一个项目中使用你的任务类">在另一个项目中使用你的任务类</a></li>
        <li><a href="#为任务类编写测试">为任务类编写测试</a></li>
      </ul>
    </li>
    <li><a href="#增量任务">增量任务</a></li>
    <li><a href="#声明和使用命令行选项">声明和使用命令行选项</a></li>
    <li><a href="#worker-api">Worker API</a></li>
  </ul>
</nav>
            </aside>
            <article>
                <div class="title">
                    <h1 id="title">Gradle构建：自定义Task类</h1>
                </div>
                <div class="content">
                        <p>Gradle支持两种类型的任务，一种是使用一个操作闭包定义的简单任务，对于这种类型的任务，操作闭包决定了任务的行为，它对于实现构建脚本中的一次性任务较为有用。</p>
<p>另一种类型的任务是增强的任务，其行为是构建于任务中的，并且任务提供了一些可以配置的属性。大多数Gradle插件都使用增强的任务，不需要像简单任务那样实现任务行为，你仅仅需要定义任务，然后使用其属性进行配置就可以了。使用这种方式，增强的任务可以让你在许多不同的地方复用这种行为，甚至是在不同的构建中。</p>
<p>可以使用Groovy、Java或者Kotlin来实现一个任务类，通常而言，使用Java和Kotlin这样的静态类型语言的性能会比Groovy好。</p>
<h2 id="打包一个任务类">打包一个任务类</h2>
<p>有许多不同的地方可以放任务类的源码：</p>
<ul>
<li>
<p>构建脚本</p>
<p>可以将任务类直接包含到构建脚本中。这样的好处是你什么都不用做，任务类会自动进行编译并加入到构建脚本的classpath中。然而，该任务类在构建脚本外是不可见的，因此你不能再定义的脚本外复用该任务类。</p>
</li>
<li>
<p><code>buildSrc</code>工程</p>
<p>你可以将任务类的源码放到<code>rootProjectDir/buildSrc/src/main/groovy</code>目录，Gradle会编译并测试这些类，并将其加入到构建脚本的classpath中。该任务类对该构建的每个构建脚本都是可见的。然而它不能用于外部的构建，因此你不能在构建的外部复用该任务类。使用<code>buildSrc</code>工程达到了将任务类的声明（也就是任务应当做什么）和任务的实现（任务如何做）分离的效果。</p>
</li>
<li>
<p>独立工程</p>
<p>你可以为任务类创建一个单独的工程。该工程生成并发布一个JAR包，然后你就可以在不同的构建中使用它了。通常，这个JAR会包含一些自定义的插件，或者将若干相关的任务包含到单个的库中。</p>
</li>
</ul>
<h2 id="编写一个简单任务类">编写一个简单任务类</h2>
<p>为了实现一个自定义任务类，需要继承<a href="https://docs.gradle.org/4.8/dsl/org.gradle.api.DefaultTask.html"><code>DefaultTask</code></a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GreetingTask</span> <span style="color:#66d9ef">extends</span> DefaultTask <span style="color:#f92672">{</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>该任务没有做什么有用的事，需要给它添加一些行为。可以添加一个方法并使用<code>TaskAction</code>进行注解。Gardle会在任务执行时调用该方法。你不是必须使用一个方法来定义任务的行为。例如，你可以在一个任务构造器中的闭包中调用<code>doFirst()</code>和<code>doLast()</code>来添加行为。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GreetingTask</span> <span style="color:#66d9ef">extends</span> DefaultTask <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@TaskAction</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">greet</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        println <span style="color:#e6db74">&#39;hello from GreetingTask&#39;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// Create a task using the task type
</span><span style="color:#75715e"></span>task <span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span>type: GreetingTask
</code></pre></div><p>现在可以向任务添加一个属性，使得我们可以对其进行定制。任务是简单的POGO对象，并且你声明了一个任务就可以设置任务对象的熟悉或调用其方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GreetingTask</span> <span style="color:#66d9ef">extends</span> DefaultTask <span style="color:#f92672">{</span>
    String greeting <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hello from GreetingTask&#39;</span>

    <span style="color:#a6e22e">@TaskAction</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">greet</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        println greeting
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// Use the default greeting
</span><span style="color:#75715e"></span>task <span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span>type: GreetingTask<span style="color:#f92672">)</span>

<span style="color:#75715e">// Customize the greeting
</span><span style="color:#75715e"></span>task <span style="color:#a6e22e">greeting</span><span style="color:#f92672">(</span>type: GreetingTask<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    greeting <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;greetings from GreetingTask&#39;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="独立工程">独立工程</h2>
<p>这个工程仅仅是一个包含任务类并生成一个JAR包的Groovy工程。以下是该工程的一个简单的构建脚本，它应用Groovy插件，并将Gradle API作为其编译时依赖。</p>
<p>build.gradle</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">apply plugin: <span style="color:#e6db74">&#39;groovy&#39;</span>

dependencies <span style="color:#f92672">{</span>
    compile <span style="color:#a6e22e">gradleApi</span><span style="color:#f92672">()</span>
    compile <span style="color:#a6e22e">localGroovy</span><span style="color:#f92672">()</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>src/main/groovy/org/gradle/GreetingTask.groovy</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#f92672">package</span> org<span style="color:#f92672">.</span><span style="color:#a6e22e">gradle</span>

<span style="color:#f92672">import</span> org.gradle.api.DefaultTask
<span style="color:#f92672">import</span> org.gradle.api.tasks.TaskAction

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GreetingTask</span> <span style="color:#66d9ef">extends</span> DefaultTask <span style="color:#f92672">{</span>
    String greeting <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hello from GreetingTask&#39;</span>

    <span style="color:#a6e22e">@TaskAction</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">greet</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        println greeting
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="在另一个项目中使用你的任务类">在另一个项目中使用你的任务类</h3>
<p>为了在另外一个项目中使用该任务类，需要将类加入到构建脚本的classpath中。以下的例子中，包含任务类的JAR包发布到一个本地仓库中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy">buildscript <span style="color:#f92672">{</span>
    repositories <span style="color:#f92672">{</span>
        maven <span style="color:#f92672">{</span>
            url <span style="color:#a6e22e">uri</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;../repo&#39;</span><span style="color:#f92672">)</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    dependencies <span style="color:#f92672">{</span>
        classpath group: <span style="color:#e6db74">&#39;org.gradle&#39;</span><span style="color:#f92672">,</span> name: <span style="color:#e6db74">&#39;customPlugin&#39;</span><span style="color:#f92672">,</span>
                  version: <span style="color:#e6db74">&#39;1.0-SNAPSHOT&#39;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

task <span style="color:#a6e22e">greeting</span><span style="color:#f92672">(</span>type: org<span style="color:#f92672">.</span><span style="color:#a6e22e">gradle</span><span style="color:#f92672">.</span><span style="color:#a6e22e">GreetingTask</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    greeting <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;howdy!&#39;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="为任务类编写测试">为任务类编写测试</h3>
<p>在测试任务类时可以使用<code>ProjectBuilder</code>来创建<code>Project</code>实例：</p>
<p>src/test/groovy/org/gradle/GreetingTaskTest.groovy</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GreetingTaskTest</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">canAddTaskToProject</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        Project project <span style="color:#f92672">=</span> ProjectBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">().</span><span style="color:#a6e22e">build</span><span style="color:#f92672">()</span>
        <span style="color:#66d9ef">def</span> task <span style="color:#f92672">=</span> project<span style="color:#f92672">.</span><span style="color:#a6e22e">task</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;greeting&#39;</span><span style="color:#f92672">,</span> type: GreetingTask<span style="color:#f92672">)</span>
        assertTrue<span style="color:#f92672">(</span>task <span style="color:#66d9ef">instanceof</span> GreetingTask<span style="color:#f92672">)</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="增量任务">增量任务</h2>
<blockquote>
<p>注意：这是一个开发阶段的特性</p>
</blockquote>
<p>参考增量任务相关文章。</p>
<h2 id="声明和使用命令行选项">声明和使用命令行选项</h2>
<blockquote>
<p>注意：这是一个开发阶段的特性</p>
</blockquote>
<p>有时你想在命令行而非构建脚本中声明一个暴露出的任务属性的值。任务API支持对一个属性进行标记，使其在运行时自动生成一个对应的命令行参数。</p>
<h2 id="worker-api">Worker API</h2>
<blockquote>
<p>注意：这是一个开发阶段的特性</p>
</blockquote>
<p>在增量构建中的讨论中可以看出，一个任务进行的工作可以看做一些离散的单位（也就是一个输入子集被转换为一个特定的输出的子集）。很多时候，这些工作单元相互之间是高度独立的，以为着他们可以简单地整合到一起，并以任意的顺序执行，从而构成整个任务的工作。在但线程执行中，这些工作单元以某一顺序执行，然而如果有多个处理器，就可以进行并发执行，从而提高构建效率。</p>

                </div>
                
            </article>
        </div>
    </div>

                </div>
                <footer>
    Powered by <a target="_blank" href="https://gohugo.io/">Hugo</a> And 
    <a target="_blank" href="https://pages.github.com/">Github Pages</a>
</footer>
                <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
                

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>

                <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.12.0/styles/default.min.css">
                <script src="/js/highlight.pack.js"></script>
                <script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
                <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [
                ['$', '$'],
                ['\\(', '\\)']
            ],
            displayMath: [
                ['$$', '$$']
            ],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });
    MathJax.Hub.Queue(function () {



        var all = MathJax.Hub.getAllJax(),
            i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

    MathJax.Hub.Config({

        TeX: {
            equationNumbers: {
                autoNumber: "AMS"
            }
        }
    });
</script>
                <script type="text/javascript" src="/js/main.js"></script>
        </div>
    </body>

</html>