<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" >
        <meta lang="zh">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Java字节码工程：ASM介绍 | androidpi</title>
<meta name="description" content="ASM是一个通用的Java字节码操作和分析框架。它可以用于修改已有的class或者直接以二进制形式动态生成class。ASM提供了一些常用的">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/solid.css" integrity="sha384-TbilV5Lbhlwdyc4RuIV/JhD8NR+BfMrvz4BL5QFa2we1hQu6wvREr3v6XSRfCTRp" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/brands.css" integrity="sha384-7xAnn7Zm3QC1jFjVc1A6v/toepoG3JXboQYzbM0jrPzou9OFXm/fY6Z/XiIebl/k" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/fontawesome.css" integrity="sha384-ozJwkrqb90Oa3ZNb+yKFW2lToAWYdTiF1vt8JiH5ptTGHTGcN7qdoR1F95e0kYyG" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
        
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="/css/article.css" />

    </head>

    <body>
        <div class="site-wrapper">
                <header>
    <nav>
        <a class="home" href="https://www.androidpi.com/">首页</a>
    </nav>
    
</header>
                <div class="site-main">
                    
    <div class="main">
        <div class="article">
            <aside>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#java字节码">Java字节码</a>
      <ul>
        <li><a href="#jvmjava-virtual-machine">JVM（Java Virtual Machine）</a></li>
        <li><a href="#基于栈的虚拟机">基于栈的虚拟机</a></li>
      </ul>
    </li>
    <li><a href="#访问者模式visitor-pattern">访问者模式（Visitor Pattern）</a>
      <ul>
        <li><a href="#代码示例">代码示例：</a></li>
        <li><a href="#asm中的访问者visitors">ASM中的访问者（Visitors）</a></li>
      </ul>
    </li>
    <li><a href="#调用追踪仪">调用追踪仪</a>
      <ul>
        <li><a href="#配置">配置</a></li>
        <li><a href="#生成调用轨迹">生成调用轨迹</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
            </aside>
            <article>
                <div class="title">
                    <h1 id="title">Java字节码工程：ASM介绍</h1>
                </div>
                <div class="content">
                        <p><strong>ASM</strong>是一个通用的Java字节码操作和分析框架。它可以用于修改已有的class或者直接以二进制形式动态生成class。ASM提供了一些常用的字节码转换和分析算法，据此可以构建出自定义的复杂的转换和代码分析工具。ASM提供了与其它Java字节码框架相似的功能，但其专注于性能。因为它被设计和实现得尽可能小而快，它适合用在动态系统中（但当然也可以以静态的方式使用，例如在编译器中）。</p>
<p>ASM已经用在众多工程工程中，包括：</p>
<ul>
<li><code>OpenJDK</code>，用于生成lambda call sites，并且用于Nashorn编译器中</li>
<li><code>Groovy</code>编译器和<code>Kotlin</code>编译器</li>
<li><code>Cobertura</code>和<code>Jacoco</code></li>
<li><code>CGLIB</code>，用于动态生成<a href="https://github.com/cglib/cglib/blob/RELEASE_3_2_6/cglib/src/main/java/net/sf/cglib/core/ClassEmitter.java"><code>proxy</code></a>类（它用在如下工程中，如<code>Mockito</code>和<code>EasyMock</code>）</li>
<li><code>Gradle</code>，用于在运行时生成一些类</li>
</ul>
<h2 id="java字节码">Java字节码</h2>
<p>Java字节码是JVM的指令集。每个指令由一个字节的操作码(opcode)，以及后面跟随的零到多个操作数(operand)组成。例如，<code>iadd</code>，接收两个整形作为操作数并且将两者相加。以下是一个Java指令集的分组，可以帮助我们快速了解Java字节码都有些什么：</p>
<ul>
<li>加载和存储（例如, <code>aload_0</code>, <code>istore</code>）</li>
<li>算术和逻辑（例如, <code>ladd</code>, <code>fcmpl</code>）</li>
<li>类型转换（例如, <code>i2b</code>, <code>d2i</code>）</li>
<li>对象创建和操作（<code>new</code>, <code>putfield</code>）</li>
<li>操作数栈管理（例如，<code>swap</code>，<code>dup2</code>）</li>
<li>控制转移（例如，<code>ifeq</code>，<code>goto</code>）</li>
<li>方法调用和返回（例如，<code>invokespecial</code>, <code>areturn</code>）</li>
</ul>
<h3 id="jvmjava-virtual-machine">JVM（Java Virtual Machine）</h3>
<p>为了理解字节码的细节，我们需要讨论Java虚拟机是如何执行字节码的。JVM是一个独立于平台的执行环境，它将Java字节码转换为机器语言并进行执行。一个JVM是一个基于栈的机器。每个线程都有一个JVM栈，栈中存储着帧。一个帧在每次调用一个方法时调用，它由一个操作数栈、一个局部变量数组和一个对当前方法所在类的运行时常量池的引用组成。</p>
<p><img src="/assets/images/java/asm/jvm-stack.gif" alt="Java虚拟机栈"></p>
<p>更多关于JVM的知识可以参考<a href="https://www.artima.com/insidejvm/ed2/jvm.html">这里</a>。</p>
<h3 id="基于栈的虚拟机">基于栈的虚拟机</h3>
<p>为了更好地理解Java字节码，我们需要了解一些关于基于栈的虚拟机的知识。一个基于栈的虚拟机的内存结构中，操作数存储于一个栈数据结构中。通过从栈中弹出数据来执行操作，处理后将它们以后进先出的顺序压回栈中。在一个基于栈的虚拟机中，将两个数字相加通常需要以如下方式进行其中20，7和“result”是操作数）：</p>
<p><img src="/assets/images/java/asm/stack-based-vm.png" alt="基于栈的虚拟机"></p>
<p>如果你想了解更多关于这部分的内容，可以在<a href="https://markfaction.wordpress.com/2012/07/15/stack-based-vs-register-based-virtual-machine-architecture-and-the-dalvik-vm/">这里</a>找到更多关于基于栈的虚拟机和基于寄存器的虚拟机的知识。</p>
<p>例子，考虑如下Java代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span>
<span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        printOne<span style="color:#f92672">();</span>
        printOne<span style="color:#f92672">();</span>
        printTwo<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printOne</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello World&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printTwo</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        printOne<span style="color:#f92672">();</span>
        printOne<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>我们使用<code>javac</code>来编译Java程序，然后使用<code>javap -c</code>来反编译class文件，这样就可以看到java字节码。一个Java class文件（.class文件名后缀）是一个包含Java字节码并可以在JVM中执行的文件。以下是我们得到的字节码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Test</span><span style="color:#f92672">();</span>
    Code<span style="color:#f92672">:</span>
       0<span style="color:#f92672">:</span> aload_0       
       1<span style="color:#f92672">:</span> invokespecial <span style="color:#960050;background-color:#1e0010">#</span>1                  <span style="color:#75715e">// Method java/lang/Object.&#34;&#34;:()V
</span><span style="color:#75715e"></span>       4<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span>        

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">String</span><span style="color:#f92672">[]);</span>
    Code<span style="color:#f92672">:</span>
       0<span style="color:#f92672">:</span> invokestatic  <span style="color:#960050;background-color:#1e0010">#</span>2                  <span style="color:#75715e">// Method printOne:()V
</span><span style="color:#75715e"></span>       3<span style="color:#f92672">:</span> invokestatic  <span style="color:#960050;background-color:#1e0010">#</span>2                  <span style="color:#75715e">// Method printOne:()V
</span><span style="color:#75715e"></span>       6<span style="color:#f92672">:</span> invokestatic  <span style="color:#960050;background-color:#1e0010">#</span>3                  <span style="color:#75715e">// Method printTwo:()V
</span><span style="color:#75715e"></span>       9<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span>        

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printOne</span><span style="color:#f92672">();</span>
    Code<span style="color:#f92672">:</span>
       0<span style="color:#f92672">:</span> getstatic     <span style="color:#960050;background-color:#1e0010">#</span>4                  <span style="color:#75715e">// Field java/lang/System.out:Ljava/io/PrintStream;
</span><span style="color:#75715e"></span>       3<span style="color:#f92672">:</span> ldc           <span style="color:#960050;background-color:#1e0010">#</span>5                  <span style="color:#75715e">// String Hello World
</span><span style="color:#75715e"></span>       5<span style="color:#f92672">:</span> invokevirtual <span style="color:#960050;background-color:#1e0010">#</span>6                  <span style="color:#75715e">// Method java/io/PrintStream.println:(Ljava/lang/String;)V
</span><span style="color:#75715e"></span>       8<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span>        

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printTwo</span><span style="color:#f92672">();</span>
    Code<span style="color:#f92672">:</span>
       0<span style="color:#f92672">:</span> invokestatic  <span style="color:#960050;background-color:#1e0010">#</span>2                  <span style="color:#75715e">// Method printOne:()V
</span><span style="color:#75715e"></span>       3<span style="color:#f92672">:</span> invokestatic  <span style="color:#960050;background-color:#1e0010">#</span>2                  <span style="color:#75715e">// Method printOne:()V
</span><span style="color:#75715e"></span>       6<span style="color:#f92672">:</span> <span style="color:#66d9ef">return</span>        
<span style="color:#f92672">}</span>
</code></pre></div><p>解析：</p>
<ul>
<li>
<p>看看public的Test()构造器。这个构造器的字节码包含三个操作码指令。第一个操作码，<code>aload_0</code>，将索引为<code>0</code>的局部变量表中的值压入到操作数栈中。局部变量表用于给方法传递参数。下一个操作码指令，<code>invokespecial</code>，调用该类的超类的构造器。因为所有没有显式地继承任何其它类的类都隐式地继承<code>java.lang.Object</code>，因此编译器提供必要的字节码来调用这个基类的构造器。在这个操作码中，操作数栈中最顶部的值被弹出。最后一个指令，<code>return</code>，仅仅返回该返回的。字节码指令的索引数字不是连续的，因为有些操作码具有一些参数，这些参数会在字节码数组中占据一些空间。</p>
</li>
<li>
<p><code>#</code>号数字是用于在常量池中查找常量的常量索引。常量池是一个表结构的数据，代表各种字符串常量、类和接口名以及其它在class文件结构和其子结构中被引用的其它常量。我们可以使用<code>javac -c -v</code>查看整个常量池。</p>
</li>
<li>
<p>Java编程语言提供了两个基本类型的方法：实例方法（<code>invokevirtual</code>）和类方法（<code>invokestatic</code>，也称静态方法）。当Java虚拟机调用了一个类方法时，它根据对象引用的类型(type)来选择调用的方法，这总是在编译时就确定了的。另一方面，当虚拟机调用一个实例方法时，它根据对象的实际的类(class)来选择调用的方法，这只在运行时可以知晓。</p>
</li>
<li>
<p>这里有一个关于Java字节码的好的<a href="http://www.ibm.com/developerworks/library/it-haggar_bytecode/">技术文章</a>。</p>
</li>
</ul>
<h2 id="访问者模式visitor-pattern">访问者模式（Visitor Pattern）</h2>
<p>在软件工程的面向对象编程中，访问者模式是将一个算法从它所作用的对象结构上进行分离的方式。这种分离的实际效果是在无需改变这些对象结构的前提下向其中添加新的操作。</p>
<p>本质上讲，访问者模式允许一个人将新的虚方法（virtual functions）添加到一个类家族中，而无需改变类本身；取而代之的是创建一个实现了所有这些适合的特定虚方法的访问者类来达到我们的目的。访问者将实例引用作为输入，并通过双重分发（double dispatch）来实现目标。</p>
<p>访问者模式需要一个支持单分发（single dispatch）的编程语言。这种条件下，考虑两个对象，每个都是某种类类型，一个称为“element”，另一个称为“visitor”。一个元素有一个接收一个访问者作为参数的<code>accept()</code>方法。<code>accept()</code>方法调用访问者的一个<code>visit()</code>方法，元素将其自身作为参数传递给<code>visit()</code>方法。</p>
<h3 id="代码示例">代码示例：</h3>
<p>本例中我们会使用类似ASM中用于操作字节码的访问器模式来</p>
<ul>
<li>添加一个<code>accept(Visitor)</code>方法到“element”层次结构中</li>
<li>创建一个“visitor”基类，对每种类型的“element”类型它都有一个对应的<code>visit()</code>方法</li>
<li>创建一个“visitor”的派生类，用于在“elements”做相应的操作</li>
<li>客户端创建“visitor”对象，并将每个访问器对象都传递给<code>accept()</code>调用</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Element</span> <span style="color:#f92672">{</span>
   <span style="color:#75715e">// 1. accept(Visitor) interface
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span> Visitor v <span style="color:#f92672">);</span> <span style="color:#75715e">// first dispatch
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">This</span> <span style="color:#66d9ef">implements</span> Element <span style="color:#f92672">{</span>
   <span style="color:#75715e">// 1. accept(Visitor) implementation
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span>   <span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span> Visitor v <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
     v<span style="color:#f92672">.</span><span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> <span style="color:#66d9ef">this</span> <span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span> 
   <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">thiss</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
     <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;This&#34;</span><span style="color:#f92672">;</span>
   <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">That</span> <span style="color:#66d9ef">implements</span> Element <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span>   <span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span> Visitor v <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
     v<span style="color:#f92672">.</span><span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> <span style="color:#66d9ef">this</span> <span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
   <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">that</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
     <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;That&#34;</span><span style="color:#f92672">;</span>
   <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TheOther</span> <span style="color:#66d9ef">implements</span> Element <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span>   <span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span> Visitor v <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
     v<span style="color:#f92672">.</span><span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> <span style="color:#66d9ef">this</span> <span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
   <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">theOther</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
     <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;TheOther&#34;</span><span style="color:#f92672">;</span> 
   <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// 2. Create a &#34;visitor&#34; base class with a visit() method for every &#34;element&#34; type
</span><span style="color:#75715e"></span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Visitor</span> <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> This e <span style="color:#f92672">);</span> <span style="color:#75715e">// second dispatch
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> That e <span style="color:#f92672">);</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> TheOther e <span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// 3. Create a &#34;visitor&#34; derived class for each &#34;operation&#34; to perform on &#34;elements&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UpVisitor</span> <span style="color:#66d9ef">implements</span> Visitor <span style="color:#f92672">{</span>                   
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> This e <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span> <span style="color:#e6db74">&#34;do Up on &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">thiss</span><span style="color:#f92672">()</span> <span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> That e <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span> <span style="color:#e6db74">&#34;do Up on &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">that</span><span style="color:#f92672">()</span> <span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> TheOther e <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span> <span style="color:#e6db74">&#34;do Up on &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">theOther</span><span style="color:#f92672">()</span> <span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DownVisitor</span> <span style="color:#66d9ef">implements</span> Visitor <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> This e <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span> <span style="color:#e6db74">&#34;do Down on &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">thiss</span><span style="color:#f92672">()</span> <span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> That e <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span> <span style="color:#e6db74">&#34;do Down on &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">that</span><span style="color:#f92672">()</span> <span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span> TheOther e <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span> <span style="color:#e6db74">&#34;do Down on &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">theOther</span><span style="color:#f92672">()</span> <span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VisitorDemo</span> <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Element<span style="color:#f92672">[]</span> list <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">new</span> This<span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> That<span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> TheOther<span style="color:#f92672">()</span> <span style="color:#f92672">};</span>

   <span style="color:#75715e">// 4. Client creates &#34;visitor&#34; objects and passes each to accept() calls
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span> String<span style="color:#f92672">[]</span> args <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      UpVisitor    up   <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UpVisitor<span style="color:#f92672">();</span>
      DownVisitor  down <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DownVisitor<span style="color:#f92672">();</span>
      <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> list<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
         list<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span> up <span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> list<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
         list<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span> down <span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
   <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>其输出看起来是这样的：</p>
<pre><code>do Up on This                do Down on This
do Up on That                do Down on That
do Up on TheOther            do Down on TheOther
</code></pre>
<h3 id="asm中的访问者visitors">ASM中的访问者（Visitors）</h3>
<p>ASM使用了访问者模式。“Objects”或者“Acceptors”包含<code>ClassReader</code>类和<code>MethodNode</code>类。“Visitor”接口包括<code>ClassVisitor</code>，<code>AnnotationVisitor</code>，<code>FieldVisitor</code>和<code>MethodVisitor</code>。</p>
<p><code>accept()</code>方法属于<code>MethodNode</code>类并具有如下签名：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span>ClassVisitor cv<span style="color:#f92672">)</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span>MethodVisitor mv<span style="color:#f92672">)</span>
</code></pre></div><p><code>visit()</code>方法和其它方法家族，例如<code>visitField()</code>等，都是<code>ClassVisitor</code>类的一部分并具有如下签名：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> version<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> access<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String signature<span style="color:#f92672">,</span> String superName<span style="color:#f92672">,</span> String<span style="color:#f92672">[]</span> interfaces<span style="color:#f92672">)</span>

AnnotationVisitor <span style="color:#a6e22e">visitAnnotation</span><span style="color:#f92672">(</span>String desc<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> visible<span style="color:#f92672">)</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visitAttribute</span><span style="color:#f92672">(</span>Attribute attr<span style="color:#f92672">)</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visitEnd</span><span style="color:#f92672">()</span>

FieldVisitor <span style="color:#a6e22e">visitField</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> access<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String desc<span style="color:#f92672">,</span> String signature<span style="color:#f92672">,</span> Object value<span style="color:#f92672">)</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visitInnerClass</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> String outerName<span style="color:#f92672">,</span> String innerName<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> access<span style="color:#f92672">)</span>

MethodVisitor <span style="color:#a6e22e">visitMethod</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> access<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String desc<span style="color:#f92672">,</span> String signature<span style="color:#f92672">,</span> String<span style="color:#f92672">[]</span> exceptions<span style="color:#f92672">)</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visitOuterClass</span><span style="color:#f92672">(</span>String owner<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String desc<span style="color:#f92672">)</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visitSource</span><span style="color:#f92672">(</span>String source<span style="color:#f92672">,</span> String debug<span style="color:#f92672">)</span>

</code></pre></div><p><img src="/assets/images/java/asm/asm-visitor-pattern.gif" alt="ASM访问器模式"></p>
<h2 id="调用追踪仪">调用追踪仪</h2>
<p>在这一章节中，我们使用ASM实现了一个调用栈跟踪仪器。代码会记录每个方法并返回。输出日志可以容易地解析为一个调用上下文树。</p>
<h3 id="配置">配置</h3>
<p>你需要准备好JDK以及Apache Ant工具。本文的代码在<a href="http://web.cs.ucla.edu/~msb/cs239-tutorial/ASM-tutorial.zip">此处</a>，</p>
<h4 id="hello-asm拷贝class文件">Hello ASM：拷贝class文件</h4>
<p>我们的第一个ASM程序会简单地制作一个<code>.class</code>文件拷贝。这个代码后面会用到，<code>Copy.java</code>的代码如下所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> java.io.FileInputStream<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.io.FileOutputStream<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> org.objectweb.asm.ClassReader<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.objectweb.asm.ClassWriter<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Copy</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String args<span style="color:#f92672">[])</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        FileInputStream is <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span>args<span style="color:#f92672">[</span>0<span style="color:#f92672">]);</span>

        ClassReader cr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassReader<span style="color:#f92672">(</span>is<span style="color:#f92672">);</span>
        ClassWriter cw <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassWriter<span style="color:#f92672">(</span>ClassWriter<span style="color:#f92672">.</span><span style="color:#a6e22e">COMPUTE_FRAMES</span><span style="color:#f92672">);</span>
        cr<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">(</span>cw<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>

        FileOutputStream fos <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream<span style="color:#f92672">(</span>args<span style="color:#f92672">[</span>1<span style="color:#f92672">]);</span>
        fos<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>cw<span style="color:#f92672">.</span><span style="color:#a6e22e">toByteArray</span><span style="color:#f92672">());</span>
        fos<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

</code></pre></div><p>拷贝程序接收两个命令行参数：<code>args[0]</code>是要拷贝的<code>.class</code>文件，<code>args[1]</code>是要拷贝到的<code>.class</code>文件。</p>
<p>本例中我们使用了两个ASM类：<code>ClassReader</code>从文件读取Java字节码，<code>ClassWriter</code>将字节码写入到文件。ASM使用了访问者模式：<code>ClassWriter</code>实现了<code>ClassVisitor</code>接口，并且通过调用<code>cr.accept(cw, 0)</code>来触发<code>ClassReader</code>对字节码输入进行遍历，通过对<code>cw</code>的一系列调用来生成一样的字节码作为输出。</p>
<p>传递给<code>ClassWriter</code>构造器的参数<code>ClassWriter.COMPUTE_FRAMES</code>是可选的标志，它指示我们希望<code>ClassWriter</code>为我们计算栈帧的大小。<code>cr.accept</code>的第二个参数也是可选的。传入<code>0</code>表明我们想要默认的行为。</p>
<pre><code># Compile Copy
$ javac -cp asm-all-5.0.3.jar Copy.java

# Use Copy to copy itself
$ java -cp .:asm-all-5.0.3.jar Copy Copy.class Copy2.class
</code></pre>
<h3 id="生成调用轨迹">生成调用轨迹</h3>
<p>现在我们有了一些ASM基础，可以开始着手调用轨迹记录仪的开发。我们会记录方法调用并返回到<code>stderr</code>，对于每个方法调用都进行这样的操作并进行换行。例如，让我们考虑如下简单的Java程序：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span>
<span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        printOne<span style="color:#f92672">();</span>
        printOne<span style="color:#f92672">();</span>
        printTwo<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printOne</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello World&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printTwo</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        printOne<span style="color:#f92672">();</span>
        printOne<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>我们测量所有的调用点，并在调用前后将调用点打印到<code>stderr</code>，例如，对<code>Test.class</code>的调用记录与如下代码是等价的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestInstrumented</span>
<span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CALL printOne&#34;</span><span style="color:#f92672">);</span>
        printOne<span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RETURN printOne&#34;</span><span style="color:#f92672">);</span>

        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CALL printOne&#34;</span><span style="color:#f92672">);</span>
        printOne<span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RETURN printOne&#34;</span><span style="color:#f92672">);</span>

        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CALL printTwo&#34;</span><span style="color:#f92672">);</span>
        printTwo<span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RETURN printTwo&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printOne</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CALL println&#34;</span><span style="color:#f92672">);</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello World&#34;</span><span style="color:#f92672">);</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RETURN println&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printTwo</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CALL printOne&#34;</span><span style="color:#f92672">);</span>
        printOne<span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RETURN printOne&#34;</span><span style="color:#f92672">);</span>

        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CALL printOne&#34;</span><span style="color:#f92672">);</span>
        printOne<span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">err</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RETURN printOne&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>我们通过修改上面的<code>Copy</code>代码来实现记录仪，为了修改类文件，我们需要在<code>ClassReader</code>和<code>ClassWriter</code>之间插入一些代码，我们使用适配器模式来做到。适配器将（被适配的目标）对象包装起来，重写它的一些方法并委托给其它对象。这样就可以很容易地改变被包装的对象的行为。这里我们会适配<code>ClassWriter</code>类，这样当我们为调用点生成字节码时，也就在调用的前后生成了产生追踪日志的代码。</p>
<p>由于方法调用位置发生在方法内部，我们的记录工作会发生在方法定义内部。还有一点，由于方法定义在类中，我们需要遍历一个类来记录它的方法。</p>
<p>第一步是使用<code>ClassAdapter</code>来适配<code>ClassWriter</code>对象。默认所有继承于<code>ClassVisitor</code>的<code>ClassAdapter</code>方法都仅仅是简单地调用被适配的<code>ClassWriter</code>的相同的方法。大多数时候我们希望默认的行为。我们会重写<code>ClassWriter.visitMethod</code>方法，对一个类中的每个方法定义都会调用该方法一次。<code>visitMethod</code>会返回一个<code>MethodVisitor</code>对象，它用于处理方法正文。<code>ClassWriter.visitMehtod</code>返回一个<code>MethodVisitor</code>为一个方法生成字节码。我们会适配<code>ClassWriter.visitMethod</code>返回的<code>MethodVisitor</code>，并插入额外的打印调用轨迹的指令。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClassAdapter</span> <span style="color:#66d9ef">extends</span> ClassVisitor <span style="color:#66d9ef">implements</span> Opcodes <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ClassAdapter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ClassVisitor cv<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>ASM5<span style="color:#f92672">,</span> cv<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> MethodVisitor <span style="color:#a6e22e">visitMethod</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> access<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String name<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">final</span> String desc<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String signature<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String<span style="color:#f92672">[]</span> exceptions<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        MethodVisitor mv <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitMethod</span><span style="color:#f92672">(</span>access<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> desc<span style="color:#f92672">,</span> signature<span style="color:#f92672">,</span> exceptions<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> mv <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> MethodAdapter<span style="color:#f92672">(</span>mv<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MethodAdapter</span> <span style="color:#66d9ef">extends</span> MethodVisitor <span style="color:#66d9ef">implements</span> Opcodes <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MethodAdapter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> MethodVisitor mv<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>ASM5<span style="color:#f92672">,</span> mv<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visitMethodInsn</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> opcode<span style="color:#f92672">,</span> String owner<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String desc<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> itf<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">/* TODO: System.err.println(&#34;CALL&#34; + name); */</span>
  
        <span style="color:#75715e">/* do call */</span>
        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitMethodInsn</span><span style="color:#f92672">(</span>opcode<span style="color:#f92672">,</span> owner<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> desc<span style="color:#f92672">,</span> itf<span style="color:#f92672">);</span>

        <span style="color:#75715e">/* TODO: System.err.println(&#34;RETURN&#34; + name);  */</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>现在我们的<code>MethodAdapter</code>没有添加任何指令，它简单地将调用委托给包装的<code>MethodVisitor</code>即<code>mv</code>。现在我们有一个以Java语法编写的记录仪代码，但不知道如何用ASM的API去表达，我们可以使用<code>ASMifier</code>工具：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ javac TestInstrumented.java
$ java -cp .:asm-all-5.0.3.jar org.objectweb.asm.util.ASMifier TestInstrumented
/** WARNING: THINGS ARE ELIDED **/
<span style="color:#f92672">{</span>
mv <span style="color:#f92672">=</span> cw.visitMethod<span style="color:#f92672">(</span>ACC_PUBLIC + ACC_STATIC, <span style="color:#e6db74">&#34;printOne&#34;</span>, <span style="color:#e6db74">&#34;()V&#34;</span>, null, null<span style="color:#f92672">)</span>;
mv.visitCode<span style="color:#f92672">()</span>;

mv.visitFieldInsn<span style="color:#f92672">(</span>GETSTATIC, <span style="color:#e6db74">&#34;java/lang/System&#34;</span>, <span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#e6db74">&#34;Ljava/io/PrintStream;&#34;</span><span style="color:#f92672">)</span>;
mv.visitLdcInsn<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CALL println&#34;</span><span style="color:#f92672">)</span>;
mv.visitMethodInsn<span style="color:#f92672">(</span>INVOKEVIRTUAL, <span style="color:#e6db74">&#34;java/io/PrintStream&#34;</span>, <span style="color:#e6db74">&#34;println&#34;</span>, <span style="color:#e6db74">&#34;(Ljava/lang/String;)V&#34;</span>, false<span style="color:#f92672">)</span>;

mv.visitFieldInsn<span style="color:#f92672">(</span>GETSTATIC, <span style="color:#e6db74">&#34;java/lang/System&#34;</span>, <span style="color:#e6db74">&#34;out&#34;</span>, <span style="color:#e6db74">&#34;Ljava/io/PrintStream;&#34;</span><span style="color:#f92672">)</span>;
mv.visitLdcInsn<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello World&#34;</span><span style="color:#f92672">)</span>;
mv.visitMethodInsn<span style="color:#f92672">(</span>INVOKEVIRTUAL, <span style="color:#e6db74">&#34;java/io/PrintStream&#34;</span>, <span style="color:#e6db74">&#34;println&#34;</span>, <span style="color:#e6db74">&#34;(Ljava/lang/String;)V&#34;</span>, false<span style="color:#f92672">)</span>;

mv.visitFieldInsn<span style="color:#f92672">(</span>GETSTATIC, <span style="color:#e6db74">&#34;java/lang/System&#34;</span>, <span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#e6db74">&#34;Ljava/io/PrintStream;&#34;</span><span style="color:#f92672">)</span>;
mv.visitLdcInsn<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RETURN println&#34;</span><span style="color:#f92672">)</span>;
mv.visitMethodInsn<span style="color:#f92672">(</span>INVOKEVIRTUAL, <span style="color:#e6db74">&#34;java/io/PrintStream&#34;</span>, <span style="color:#e6db74">&#34;println&#34;</span>, <span style="color:#e6db74">&#34;(Ljava/lang/String;)V&#34;</span>, false<span style="color:#f92672">)</span>;

mv.visitInsn<span style="color:#f92672">(</span>RETURN<span style="color:#f92672">)</span>;
mv.visitMaxs<span style="color:#f92672">(</span>2, 0<span style="color:#f92672">)</span>;
mv.visitEnd<span style="color:#f92672">()</span>;
<span style="color:#f92672">}</span>
/** WARNING: MORE THINGS ARE ELIDED **/
</code></pre></div><p><code>ASMifier</code>的输出是一个生成<code>TestInstrumented.class</code>的程序，我们需求的重点是调用<code>System.err.println</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitFieldInsn</span><span style="color:#f92672">(</span>GETSTATIC<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;java/lang/System&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;err&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Ljava/io/PrintStream;&#34;</span><span style="color:#f92672">);</span>
mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitLdcInsn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CALL println&#34;</span><span style="color:#f92672">);</span>
mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitMethodInsn</span><span style="color:#f92672">(</span>INVOKEVIRTUAL<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;java/io/PrintStream&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;println&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;(Ljava/lang/String;)V&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</code></pre></div><p>现在我们知道如何调用<code>System.err.println</code>，我们可以完成我们的<code>MethodAdapter</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MethodAdapter</span> <span style="color:#66d9ef">extends</span> MethodVisitor <span style="color:#66d9ef">implements</span> Opcodes <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MethodAdapter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> MethodVisitor mv<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>ASM5<span style="color:#f92672">,</span> mv<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">visitMethodInsn</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> opcode<span style="color:#f92672">,</span> String owner<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String desc<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> itf<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">/* System.err.println(&#34;CALL&#34; + name); */</span>
        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitFieldInsn</span><span style="color:#f92672">(</span>GETSTATIC<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;java/lang/System&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;err&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Ljava/io/PrintStream;&#34;</span><span style="color:#f92672">);</span>
        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitLdcInsn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CALL &#34;</span> <span style="color:#f92672">+</span> name<span style="color:#f92672">);</span>
        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitMethodInsn</span><span style="color:#f92672">(</span>INVOKEVIRTUAL<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;java/io/PrintStream&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;println&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;(Ljava/lang/String;)V&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
  
        <span style="color:#75715e">/* do call */</span>
        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitMethodInsn</span><span style="color:#f92672">(</span>opcode<span style="color:#f92672">,</span> owner<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> desc<span style="color:#f92672">,</span> itf<span style="color:#f92672">);</span>

        <span style="color:#75715e">/* System.err.println(&#34;RETURN&#34; + name);  */</span>
        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitFieldInsn</span><span style="color:#f92672">(</span>Opcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">GETSTATIC</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;java/lang/System&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;err&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Ljava/io/PrintStream;&#34;</span><span style="color:#f92672">);</span>
        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitLdcInsn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RETURN &#34;</span> <span style="color:#f92672">+</span> name<span style="color:#f92672">);</span>
        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">visitMethodInsn</span><span style="color:#f92672">(</span>Opcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">INVOKEVIRTUAL</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;java/io/PrintStream&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;println&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;(Ljava/lang/String;)V&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>编译并运行例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Build Instrumenter</span>
$ javac -cp asm-all-5.0.3.jar Instrumenter.java

<span style="color:#75715e"># Build Example</span>
$ javac Test.java

<span style="color:#75715e"># Move Test.class out of the way</span>
$ cp Test.class Test.class.bak

<span style="color:#75715e"># Instrument Test</span>
$ java -cp .:asm-all-5.0.3.jar Instrumenter Test.class.bak Test.class

<span style="color:#75715e"># Run!</span>
$ java Test
CALL printOne
CALL println
Hello World
RETURN println
RETURN printOne
CALL printOne
CALL println
Hello World
RETURN println
RETURN printOne
CALL printTwo
CALL printOne
CALL println
Hello World
RETURN println
RETURN printOne
CALL printOne
CALL println
Hello World
RETURN println
RETURN printOne
RETURN printTwo
</code></pre></div><p>输出就是我们期望看到的，其中四个“Hello World”打印到标准输出，和输出到<code>stderr</code>的调用跟踪记录相互交错。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://asm.ow2.io/javadoc/overview-summary.html">ASM Java Doc</a></li>
<li><a href="https://asm.ow2.io/">ASM官方站点</a></li>
<li><a href="https://blog.csdn.net/conquer0715/article/details/51283610">ASM技术研究</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-asm30/index.html">AOP 的利器：ASM 3.0 介绍</a></li>
<li><a href="http://web.cs.ucla.edu/~msb/cs239-tutorial/">Instrumenting Java Bytecode with ASM</a></li>
</ul>

                </div>
                
            </article>
        </div>
    </div>

                </div>
                <footer>
    Powered by <a target="_blank" href="https://gohugo.io/">Hugo</a> And 
    <a target="_blank" href="https://pages.github.com/">Github Pages</a>
</footer>
                <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
                

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>

                <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.12.0/styles/default.min.css">
                <script src="/js/highlight.pack.js"></script>
                <script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
                <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [
                ['$', '$'],
                ['\\(', '\\)']
            ],
            displayMath: [
                ['$$', '$$']
            ],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });
    MathJax.Hub.Queue(function () {



        var all = MathJax.Hub.getAllJax(),
            i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

    MathJax.Hub.Config({

        TeX: {
            equationNumbers: {
                autoNumber: "AMS"
            }
        }
    });
</script>
                <script type="text/javascript" src="/js/main.js"></script>
        </div>
    </body>

</html>