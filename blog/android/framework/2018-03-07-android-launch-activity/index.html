<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Activity启动流程：总览 | AndroidPi</title>
<meta name=keywords content><meta name=description content="网络上已经有许多关于这个主题的文章了，但路只有自己走一遍才会熟悉，源码的分析与理解也是一样的。因此从这篇文章开始我将开始从源码阅读中去理解Android Framework层以及更多系统相关的知识点。从点到线再到面地去掌握Android开发的武艺。
src/com/android/launcher3/Launcher.java 点击桌面应用Lanucher3的快捷方式:
/** * Launches the intent referred by the clicked shortcut. * * @param v The view representing the clicked shortcut. */ public void onClick(View v) { // Make sure that rogue clicks don't get through while allapps is launching, or after the // view has detached (it's possible for this to happen if the view is removed mid touch). if (v.getWindowToken() == null) { return; } if (!"><meta name=author content="LEOY"><link rel=canonical href=https://epicmars.github.io/blog/android/framework/2018-03-07-android-launch-activity/><link crossorigin=anonymous href=/assets/css/stylesheet.1715a8df06a9f4f4b7cfb26895ef9124122a85cbef9cde37608112c4ba7767f6.css integrity="sha256-FxWo3wap9PS3z7Jole+RJBIqhcvvnN43YIESxLp3Z/Y=" rel="preload stylesheet" as=style><link rel=icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=icon type=image/png sizes=16x16 href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=icon type=image/png sizes=32x32 href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg%22><link rel=apple-touch-icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=mask-icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://epicmars.github.io/blog/android/framework/2018-03-07-android-launch-activity/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script defer crossorigin=anonymous src=/js/custom.f20a5212619392e989b6d24ad9ce42302014debfad4d3c8c01db030c36d03475.js integrity="sha256-8gpSEmGTkumJttJK2c5CMCAU3r+tTTyMAdsDDDbQNHU="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css integrity=sha384-Juol1FqnotbkyZUT5Z7gUPjQ9gzlwCENvUZTpQBAPxtusdwFLRy382PSDx5UUJ4/ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.js integrity=sha384-97gW6UIJxnlKemYavrqDHSX3SiygeOwIZhwyOKRfSaf0JWKRVj9hLASHgFTzT+0O crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-NMEMBZ8R90"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NMEMBZ8R90")}</script><meta property="og:title" content="Activity启动流程：总览"><meta property="og:description" content="网络上已经有许多关于这个主题的文章了，但路只有自己走一遍才会熟悉，源码的分析与理解也是一样的。因此从这篇文章开始我将开始从源码阅读中去理解Android Framework层以及更多系统相关的知识点。从点到线再到面地去掌握Android开发的武艺。
src/com/android/launcher3/Launcher.java 点击桌面应用Lanucher3的快捷方式:
/** * Launches the intent referred by the clicked shortcut. * * @param v The view representing the clicked shortcut. */ public void onClick(View v) { // Make sure that rogue clicks don't get through while allapps is launching, or after the // view has detached (it's possible for this to happen if the view is removed mid touch). if (v.getWindowToken() == null) { return; } if (!"><meta property="og:type" content="article"><meta property="og:url" content="https://epicmars.github.io/blog/android/framework/2018-03-07-android-launch-activity/"><meta property="og:image" content="https://epicmars.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="blog"><meta property="article:published_time" content="2018-03-07T21:10:03+08:00"><meta property="article:modified_time" content="2018-03-07T21:10:03+08:00"><meta property="og:site_name" content="androidpi"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://epicmars.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Activity启动流程：总览"><meta name=twitter:description content="网络上已经有许多关于这个主题的文章了，但路只有自己走一遍才会熟悉，源码的分析与理解也是一样的。因此从这篇文章开始我将开始从源码阅读中去理解Android Framework层以及更多系统相关的知识点。从点到线再到面地去掌握Android开发的武艺。
src/com/android/launcher3/Launcher.java 点击桌面应用Lanucher3的快捷方式:
/** * Launches the intent referred by the clicked shortcut. * * @param v The view representing the clicked shortcut. */ public void onClick(View v) { // Make sure that rogue clicks don't get through while allapps is launching, or after the // view has detached (it's possible for this to happen if the view is removed mid touch). if (v.getWindowToken() == null) { return; } if (!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://epicmars.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Android","item":"https://epicmars.github.io/blog/android/"},{"@type":"ListItem","position":3,"name":"Activity启动流程：总览","item":"https://epicmars.github.io/blog/android/framework/2018-03-07-android-launch-activity/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Activity启动流程：总览","name":"Activity启动流程：总览","description":"网络上已经有许多关于这个主题的文章了，但路只有自己走一遍才会熟悉，源码的分析与理解也是一样的。因此从这篇文章开始我将开始从源码阅读中去理解Android Framework层以及更多系统相关的知识点。从点到线再到面地去掌握Android开发的武艺。\nsrc/com/android/launcher3/Launcher.java 点击桌面应用Lanucher3的快捷方式:\n/** * Launches the intent referred by the clicked shortcut. * * @param v The view representing the clicked shortcut. */ public void onClick(View v) { // Make sure that rogue clicks don\u0026#39;t get through while allapps is launching, or after the // view has detached (it\u0026#39;s possible for this to happen if the view is removed mid touch). if (v.getWindowToken() == null) { return; } if (!","keywords":[],"articleBody":"网络上已经有许多关于这个主题的文章了，但路只有自己走一遍才会熟悉，源码的分析与理解也是一样的。因此从这篇文章开始我将开始从源码阅读中去理解Android Framework层以及更多系统相关的知识点。从点到线再到面地去掌握Android开发的武艺。\nsrc/com/android/launcher3/Launcher.java 点击桌面应用Lanucher3的快捷方式:\n/** * Launches the intent referred by the clicked shortcut. * * @param v The view representing the clicked shortcut. */ public void onClick(View v) { // Make sure that rogue clicks don't get through while allapps is launching, or after the // view has detached (it's possible for this to happen if the view is removed mid touch). if (v.getWindowToken() == null) { return; } if (!mWorkspace.isFinishedSwitchingState()) { return; } if (v instanceof Workspace) { if (mWorkspace.isInOverviewMode()) { mWorkspace.exitOverviewMode(true); } return; } if (v instanceof CellLayout) { if (mWorkspace.isInOverviewMode()) { mWorkspace.exitOverviewMode(mWorkspace.indexOfChild(v), true); } } Object tag = v.getTag(); if (tag instanceof ShortcutInfo) { // Open shortcut final ShortcutInfo shortcut = (ShortcutInfo) tag; final Intent intent = shortcut.intent; // Check for special shortcuts if (intent.getComponent() != null) { final String shortcutClass = intent.getComponent().getClassName(); if (shortcutClass.equals(WidgetAdder.class.getName())) { showAllApps(true, AppsCustomizePagedView.ContentType.Widgets, true); return; } else if (shortcutClass.equals(MemoryDumpActivity.class.getName())) { MemoryDumpActivity.startDump(this); return; } else if (shortcutClass.equals(ToggleWeightWatcher.class.getName())) { toggleShowWeightWatcher(); return; } } // Start activities int[] pos = new int[2]; v.getLocationOnScreen(pos); intent.setSourceBounds(new Rect(pos[0], pos[1], pos[0] + v.getWidth(), pos[1] + v.getHeight())); boolean success = startActivitySafely(v, intent, tag); mStats.recordLaunch(intent, shortcut); if (success \u0026\u0026 v instanceof BubbleTextView) { mWaitingForResume = (BubbleTextView) v; mWaitingForResume.setStayPressed(true); } } else if (tag instanceof FolderInfo) { if (v instanceof FolderIcon) { FolderIcon fi = (FolderIcon) v; handleFolderClick(fi); } } else if (v == mAllAppsButton) { if (isAllAppsVisible()) { showWorkspace(true); } else { onClickAllAppsButton(v); } } } boolean startActivitySafely(View v, Intent intent, Object tag) { boolean success = false; try { success = startActivity(v, intent, tag); } catch (ActivityNotFoundException e) { Toast.makeText(this, R.string.activity_not_found, Toast.LENGTH_SHORT).show(); Log.e(TAG, \"Unable to launch. tag=\" + tag + \" intent=\" + intent, e); } return success; } boolean startActivity(View v, Intent intent, Object tag) { intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); try { // Only launch using the new animation if the shortcut has not opted out (this is a // private contract between launcher and may be ignored in the future). boolean useLaunchAnimation = (v != null) \u0026\u0026 !intent.hasExtra(INTENT_EXTRA_IGNORE_LAUNCH_ANIMATION); if (useLaunchAnimation) { ActivityOptions opts = ActivityOptions.makeScaleUpAnimation(v, 0, 0, v.getMeasuredWidth(), v.getMeasuredHeight()); startActivity(intent, opts.toBundle()); } else { startActivity(intent); } return true; } catch (SecurityException e) { Toast.makeText(this, R.string.activity_not_found, Toast.LENGTH_SHORT).show(); Log.e(TAG, \"Launcher does not have the permission to launch \" + intent + \". Make sure to create a MAIN intent-filter for the corresponding activity \" + \"or use the exported attribute for this activity. \" + \"tag=\"+ tag + \" intent=\" + intent, e); } return false; } 上述过程中最终调用到Activity的startActivity方法：\n@Override public void startActivity(Intent intent, @Nullable Bundle options) { if (options != null) { startActivityForResult(intent, -1, options); } else { // Note we want to go through this call for compatibility with // applications that may have overridden the method. startActivityForResult(intent, -1); } } 然后调用startActivityForResult方法：\n/** * Launch an activity for which you would like a result when it finished. * When this activity exits, your * onActivityResult() method will be called with the given requestCode. * Using a negative requestCode is the same as calling * {@link #startActivity} (the activity is not launched as a sub-activity). * * Note that this method should only be used with Intent protocols * that are defined to return a result. In other protocols (such as * {@link Intent#ACTION_MAIN} or {@link Intent#ACTION_VIEW}), you may * not get the result when you expect. For example, if the activity you * are launching uses {@link Intent#FLAG_ACTIVITY_NEW_TASK}, it will not * run in your task and thus you will immediately receive a cancel result. * * As a special case, if you call startActivityForResult() with a requestCode * \u003e= 0 during the initial onCreate(Bundle savedInstanceState)/onResume() of your * activity, then your window will not be displayed until a result is * returned back from the started activity. This is to avoid visible * flickering when redirecting to another activity. * * This method throws {@link android.content.ActivityNotFoundException} * if there was no Activity found to run the given Intent. * * @param intent The intent to start. * @param requestCode If \u003e= 0, this code will be returned in * onActivityResult() when the activity exits. * @param options Additional options for how the Activity should be started. * See {@link android.content.Context#startActivity(Intent, Bundle)} * Context.startActivity(Intent, Bundle)} for more details. * * @throws android.content.ActivityNotFoundException * * @see #startActivity */ public void startActivityForResult(@RequiresPermission Intent intent, int requestCode, @Nullable Bundle options) { if (mParent == null) { options = transferSpringboardActivityOptions(options); Instrumentation.ActivityResult ar = mInstrumentation.execStartActivity( this, mMainThread.getApplicationThread(), mToken, this, intent, requestCode, options); if (ar != null) { mMainThread.sendActivityResult( mToken, mEmbeddedID, requestCode, ar.getResultCode(), ar.getResultData()); } if (requestCode \u003e= 0) { // If this start is requesting a result, we can avoid making // the activity visible until the result is received. Setting // this code during onCreate(Bundle savedInstanceState) or onResume() will keep the // activity hidden during this time, to avoid flickering. // This can only be done when a result is requested because // that guarantees we will get information back when the // activity is finished, no matter what happens to it. mStartedActivity = true; } cancelInputsAndStartExitTransition(options); // TODO Consider clearing/flushing other event sources and events for child windows. } else { if (options != null) { mParent.startActivityFromChild(this, intent, requestCode, options); } else { // Note we want to go through this method for compatibility with // existing applications that may have overridden it. mParent.startActivityFromChild(this, intent, requestCode); } } } 其中，参数requestCode为-1也就是不需要在onActivityResult()中返回结果，如果需要，options参数用于展示一个从图标到Activity界面的动画效果。进入代码正文，Activity的mParent参数是已经被弃用的ActivityGroup所遗留下的嵌套Activity问题，现在已改用Fragment。因此该参数一般为null，也就直接进入到类Instrumentation的execStartActivity()方法中:\n/** * Execute a startActivity call made by the application. The default * implementation takes care of updating any active {@link ActivityMonitor} * objects and dispatches this call to the system activity manager; you can * override this to watch for the application to start an activity, and * modify what happens when it does. * * This method returns an {@link ActivityResult} object, which you can * use when intercepting application calls to avoid performing the start * activity action but still return the result the application is * expecting. To do this, override this method to catch the call to start * activity so that it returns a new ActivityResult containing the results * you would like the application to see, and don't call up to the super * class. Note that an application is only expecting a result if * requestCode is \u0026gt;= 0. * * This method throws {@link android.content.ActivityNotFoundException} * if there was no Activity found to run the given Intent. * * @param who The Context from which the activity is being started. * @param contextThread The main thread of the Context from which the activity * is being started. * @param token Internal token identifying to the system who is starting * the activity; may be null. * @param target Which activity is performing the start (and thus receiving * any result); may be null if this call is not being made * from an activity. * @param intent The actual Intent to start. * @param requestCode Identifier for this request's result; less than zero * if the caller is not expecting a result. * @param options Addition options. * * @return To force the return of a particular result, return an * ActivityResult object containing the desired data; otherwise * return null. The default implementation always returns null. * * @throws android.content.ActivityNotFoundException * * @see Activity#startActivity(Intent) * @see Activity#startActivityForResult(Intent, int) * @see Activity#startActivityFromChild * * {@hide} */ public ActivityResult execStartActivity( Context who, IBinder contextThread, IBinder token, Activity target, Intent intent, int requestCode, Bundle options) { IApplicationThread whoThread = (IApplicationThread) contextThread; Uri referrer = target != null ? target.onProvideReferrer() : null; if (referrer != null) { intent.putExtra(Intent.EXTRA_REFERRER, referrer); } if (mActivityMonitors != null) { synchronized (mSync) { final int N = mActivityMonitors.size(); for (int i=0; i\u003cN; i++) { final ActivityMonitor am = mActivityMonitors.get(i); ActivityResult result = null; if (am.ignoreMatchingSpecificIntents()) { result = am.onStartActivity(intent); } if (result != null) { am.mHits++; return result; } else if (am.match(who, null, intent)) { am.mHits++; if (am.isBlocking()) { return requestCode \u003e= 0 ? am.getResult() : null; } break; } } } } try { intent.migrateExtraStreamToClipData(); intent.prepareToLeaveProcess(who); int result = ActivityManager.getService() .startActivity(whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != null ? target.mEmbeddedID : null, requestCode, 0, null, options); checkStartActivityResult(result, intent); } catch (RemoteException e) { throw new RuntimeException(\"Failure from system\", e); } return null; } 这个方法的用处注释里也说的很清楚了，即：\n执行一个由应用发起的startActivity调用。默认实现是更新所有活跃的ActivityMonitor对象，并将该调用分发给系统 activity manager；可以重写该方法来观察activity的启动并修改启动时的行为。\n注意，这里说的一个由应用发起的startActivity调用，由于启动Activity都会调用到该方法，如果是从Launcher启动的，那么该应用就是Launcher，当然也可以是其它应用。否则便是Activity所在的应用自身了。这里涉及到谁先与ActivityManager进行通信。\n方法中的contextThread参数是一个IBinder对象，是发起调用应用（简称源应用）主线程ActivityThread的一个ApplicationThread变量，在定义时直接进行实例化：\nfinal ApplicationThread mAppThread = new ApplicationThread() 那么这个ApplicationThread又是何方神圣，查找其定义会发现它是ActivityThread的一个私有内部类，也就是说只有ActivityThread可以直接使用该类。\nprivate class ApplicationThread extends IApplicationThread.Stub { ... } 它继承了IApplicationThread.Stub，看名字就像一个aidl接口生成的类，找到该aidl代码：\n/** * System private API for communicating with the application. This is given to * the activity manager by an application when it starts up, for the activity * manager to tell the application about things it needs to do. * * {@hide} */ oneway interface IApplicationThread { void schedulePauseActivity(IBinder token, boolean finished, boolean userLeaving, int configChanges, boolean dontReport); void scheduleStopActivity(IBinder token, boolean showWindow, int configChanges); void scheduleWindowVisibility(IBinder token, boolean showWindow); void scheduleResumeActivity(IBinder token, int procState, boolean isForward, in Bundle resumeArgs); void scheduleSendResult(IBinder token, in List\u003cResultInfo\u003e results); void scheduleLaunchActivity(in Intent intent, IBinder token, int ident, in ActivityInfo info, in Configuration curConfig, in Configuration overrideConfig, in CompatibilityInfo compatInfo, in String referrer, IVoiceInteractor voiceInteractor, int procState, in Bundle state, in PersistableBundle persistentState, in List\u003cResultInfo\u003e pendingResults, in List\u003cReferrerIntent\u003e pendingNewIntents, boolean notResumed, boolean isForward, in ProfilerInfo profilerInfo); void scheduleNewIntent( in List\u003cReferrerIntent\u003e intent, IBinder token, boolean andPause); void scheduleDestroyActivity(IBinder token, boolean finished, int configChanges); void scheduleReceiver(in Intent intent, in ActivityInfo info, in CompatibilityInfo compatInfo, int resultCode, in String data, in Bundle extras, boolean sync, int sendingUser, int processState); void scheduleCreateService(IBinder token, in ServiceInfo info, in CompatibilityInfo compatInfo, int processState); void scheduleStopService(IBinder token); void bindApplication(in String packageName, in ApplicationInfo info, in List\u003cProviderInfo\u003e providers, in ComponentName testName, in ProfilerInfo profilerInfo, in Bundle testArguments, IInstrumentationWatcher testWatcher, IUiAutomationConnection uiAutomationConnection, int debugMode, boolean enableBinderTracking, boolean trackAllocation, boolean restrictedBackupMode, boolean persistent, in Configuration config, in CompatibilityInfo compatInfo, in Map services, in Bundle coreSettings, in String buildSerial); ... } 注释上说：\nIApplicationThread用于和应用进行通信，在应用启动时将其传给activity manager，然后activity manager通知应用应该进行的操作。\n随后通过调用ActivityManager.getService().startActivity()方法，并将这个IApplicationThread对象作为参数传入，这里开始启动流程进入另一个阶段。\n上面execStartActivity()方法的另一个参数mToken也是一个IBinder对象，在attach()方法中赋值，这里暂不讨论。\nActivityManager启动Activity ActivityManager.getService()方法用于获取ActivityManagerService的代理，它是系统服务的一部分，负责管理四大组件的启动、生命周期调度，以及应用进程的管理和调度等工作。\nActivityManager.java\npublic static IActivityManager getService() { return IActivityManagerSingleton.get(); } private static final Singleton\u003cIActivityManager\u003e IActivityManagerSingleton = new Singleton\u003cIActivityManager\u003e() { @Override protected IActivityManager create() { final IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE); final IActivityManager am = IActivityManager.Stub.asInterface(b); return am; } }; 那么，ActivityManagerService是何时注册的，从SystemServer启动的代码中，可以看出： SystemServer.java\nprivate void startBootstrapServices() { ... // Activity manager runs the show. traceBeginAndSlog(\"StartActivityManager\"); mActivityManagerService = mSystemServiceManager.startService( ActivityManagerService.Lifecycle.class).getService(); mActivityManagerService.setSystemServiceManager(mSystemServiceManager); mActivityManagerService.setInstaller(installer); traceEnd() ... // Set up the Application instance for the system process and get started. traceBeginAndSlog(\"SetSystemProcess\"); mActivityManagerService.setSystemProcess(); traceEnd(); ... } 然后，mActivityManagerService.setSystemProcess()调用如下，这是它将自身注册到了ServiceManager。 ActivityManagerService.java\npublic void setSystemProcess() { try { ServiceManager.addService(Context.ACTIVITY_SERVICE, this, true); ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats); ServiceManager.addService(\"meminfo\", new MemBinder(this)); ServiceManager.addService(\"gfxinfo\", new GraphicsBinder(this)); ServiceManager.addService(\"dbinfo\", new DbBinder(this)); if (MONITOR_CPU_USAGE) { ServiceManager.addService(\"cpuinfo\", new CpuBinder(this)); } ServiceManager.addService(\"permission\", new PermissionController(this)); ServiceManager.addService(\"processinfo\", new ProcessInfoService(this)); ApplicationInfo info = mContext.getPackageManager().getApplicationInfo( \"android\", STOCK_PM_FLAGS | MATCH_SYSTEM_ONLY); mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader()); synchronized (this) { ProcessRecord app = newProcessRecordLocked(info, info.processName, false, 0); app.persistent = true; app.pid = MY_PID; app.maxAdj = ProcessList.SYSTEM_ADJ; app.makeActive(mSystemThread.getApplicationThread(), mProcessStats); synchronized (mPidsSelfLocked) { mPidsSelfLocked.put(app.pid, app); } updateLruProcessLocked(app, false, null); updateOomAdjLocked(); } } catch (PackageManager.NameNotFoundException e) { throw new RuntimeException( \"Unable to find android system package\", e); } } 因此ServiceManager.getService(Context.ACTIVITY_SERVICE)拿到的是ActivityManagerService，它继承了IActivityManager.Stub，这里也是一个aidl接口，它提供了与activity manager service通信的API，提供的是从应用到activity manager的调用。\nIActivityManager.aidl\n/** * System private API for talking with the activity manager service. This * provides calls from the application back to the activity manager. * * {@hide} */ interface IActivityManager { ... int startActivity(in IApplicationThread caller, in String callingPackage, in Intent intent, in String resolvedType, in IBinder resultTo, in String resultWho, int requestCode, int flags, in ProfilerInfo profilerInfo, in Bundle options); ... } 那么，很显然，ActivityManager.getService().startActivity()会利用Binder作进程间通信。\nActivityManagerService.java\n@Override public final int startActivity(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle bOptions) { // 获取源进程的UserId return startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo, resultWho, requestCode, startFlags, profilerInfo, bOptions, UserHandle.getCallingUserId()); } @Override public final int startActivityAsUser(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle bOptions, int userId) { enforceNotIsolatedCaller(\"startActivity\"); // 检查用户权限 userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId, false, ALLOW_FULL_ONLY, \"startActivity\", null); // TODO: Switch to user app stacks here. return mActivityStarter.startActivityMayWait(caller, -1, callingPackage, intent, resolvedType, null, null, resultTo, resultWho, requestCode, startFlags, profilerInfo, null, null, bOptions, false, userId, null, \"startActivityAsUser\"); } ActivityStarter.java\nfinal int startActivityMayWait(IApplicationThread caller, int callingUid, String callingPackage, Intent intent, String resolvedType, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, WaitResult outResult, Configuration globalConfig, Bundle bOptions, boolean ignoreTargetSecurity, int userId, TaskRecord inTask, String reason) { // Refuse possible leaked file descriptors if (intent != null \u0026\u0026 intent.hasFileDescriptors()) { throw new IllegalArgumentException(\"File descriptors passed in Intent\"); } mSupervisor.mActivityMetricsLogger.notifyActivityLaunching(); boolean componentSpecified = intent.getComponent() != null; // Save a copy in case ephemeral needs it final Intent ephemeralIntent = new Intent(intent); // Don't modify the client's object! intent = new Intent(intent); if (componentSpecified \u0026\u0026 intent.getData() != null \u0026\u0026 Intent.ACTION_VIEW.equals(intent.getAction()) \u0026\u0026 mService.getPackageManagerInternalLocked() .isInstantAppInstallerComponent(intent.getComponent())) { // intercept intents targeted directly to the ephemeral installer the // ephemeral installer should never be started with a raw URL; instead // adjust the intent so it looks like a \"normal\" instant app launch intent.setComponent(null /*component*/); componentSpecified = false; } ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId); if (rInfo == null) { UserInfo userInfo = mSupervisor.getUserInfo(userId); if (userInfo != null \u0026\u0026 userInfo.isManagedProfile()) { // Special case for managed profiles, if attempting to launch non-cryto aware // app in a locked managed profile from an unlocked parent allow it to resolve // as user will be sent via confirm credentials to unlock the profile. UserManager userManager = UserManager.get(mService.mContext); boolean profileLockedAndParentUnlockingOrUnlocked = false; long token = Binder.clearCallingIdentity(); try { UserInfo parent = userManager.getProfileParent(userId); profileLockedAndParentUnlockingOrUnlocked = (parent != null) \u0026\u0026 userManager.isUserUnlockingOrUnlocked(parent.id) \u0026\u0026 !userManager.isUserUnlockingOrUnlocked(userId); } finally { Binder.restoreCallingIdentity(token); } if (profileLockedAndParentUnlockingOrUnlocked) { rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId, PackageManager.MATCH_DIRECT_BOOT_AWARE | PackageManager.MATCH_DIRECT_BOOT_UNAWARE); } } } // Collect information about the target of the Intent. ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo); ActivityOptions options = ActivityOptions.fromBundle(bOptions); synchronized (mService) { final int realCallingPid = Binder.getCallingPid(); final int realCallingUid = Binder.getCallingUid(); int callingPid; if (callingUid \u003e= 0) { callingPid = -1; } else if (caller == null) { callingPid = realCallingPid; callingUid = realCallingUid; } else { callingPid = callingUid = -1; } final ActivityStack stack = mSupervisor.mFocusedStack; stack.mConfigWillChange = globalConfig != null \u0026\u0026 mService.getGlobalConfiguration().diff(globalConfig) != 0; if (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, \"Starting activity when config will change = \" + stack.mConfigWillChange); final long origId = Binder.clearCallingIdentity(); if (aInfo != null \u0026\u0026 (aInfo.applicationInfo.privateFlags \u0026 ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != 0) { // This may be a heavy-weight process! Check to see if we already // have another, different heavy-weight process running. if (aInfo.processName.equals(aInfo.applicationInfo.packageName)) { final ProcessRecord heavy = mService.mHeavyWeightProcess; if (heavy != null \u0026\u0026 (heavy.info.uid != aInfo.applicationInfo.uid || !heavy.processName.equals(aInfo.processName))) { int appCallingUid = callingUid; if (caller != null) { ProcessRecord callerApp = mService.getRecordForAppLocked(caller); if (callerApp != null) { appCallingUid = callerApp.info.uid; } else { Slog.w(TAG, \"Unable to find app for caller \" + caller + \" (pid=\" + callingPid + \") when starting: \" + intent.toString()); ActivityOptions.abort(options); return ActivityManager.START_PERMISSION_DENIED; } } IIntentSender target = mService.getIntentSenderLocked( ActivityManager.INTENT_SENDER_ACTIVITY, \"android\", appCallingUid, userId, null, null, 0, new Intent[] { intent }, new String[] { resolvedType }, PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_ONE_SHOT, null); Intent newIntent = new Intent(); if (requestCode \u003e= 0) { // Caller is requesting a result. newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_HAS_RESULT, true); } newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_INTENT, new IntentSender(target)); if (heavy.activities.size() \u003e 0) { ActivityRecord hist = heavy.activities.get(0); newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_APP, hist.packageName); newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_TASK, hist.getTask().taskId); } newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_NEW_APP, aInfo.packageName); newIntent.setFlags(intent.getFlags()); newIntent.setClassName(\"android\", HeavyWeightSwitcherActivity.class.getName()); intent = newIntent; resolvedType = null; caller = null; callingUid = Binder.getCallingUid(); callingPid = Binder.getCallingPid(); componentSpecified = true; rInfo = mSupervisor.resolveIntent(intent, null /*resolvedType*/, userId); aInfo = rInfo != null ? rInfo.activityInfo : null; if (aInfo != null) { aInfo = mService.getActivityInfoForUser(aInfo, userId); } } } } final ActivityRecord[] outRecord = new ActivityRecord[1]; int res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType, aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode, callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity, componentSpecified, outRecord, inTask, reason); Binder.restoreCallingIdentity(origId); if (stack.mConfigWillChange) { // If the caller also wants to switch to a new configuration, // do so now. This allows a clean switch, as we are waiting // for the current activity to pause (so we will not destroy // it), and have not yet started the next activity. mService.enforceCallingPermission(android.Manifest.permission.CHANGE_CONFIGURATION, \"updateConfiguration()\"); stack.mConfigWillChange = false; if (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, \"Updating to new configuration after starting activity.\"); mService.updateConfigurationLocked(globalConfig, null, false); } if (outResult != null) { outResult.result = res; if (res == ActivityManager.START_SUCCESS) { mSupervisor.mWaitingActivityLaunched.add(outResult); do { try { mService.wait(); } catch (InterruptedException e) { } } while (outResult.result != START_TASK_TO_FRONT \u0026\u0026 !outResult.timeout \u0026\u0026 outResult.who == null); if (outResult.result == START_TASK_TO_FRONT) { res = START_TASK_TO_FRONT; } } if (res == START_TASK_TO_FRONT) { final ActivityRecord r = outRecord[0]; // ActivityRecord may represent a different activity, but it should not be in // the resumed state. if (r.nowVisible \u0026\u0026 r.state == RESUMED) { outResult.timeout = false; outResult.who = r.realActivity; outResult.totalTime = 0; outResult.thisTime = 0; } else { outResult.thisTime = SystemClock.uptimeMillis(); mSupervisor.waitActivityVisible(r.realActivity, outResult); // Note: the timeout variable is not currently not ever set. do { try { mService.wait(); } catch (InterruptedException e) { } } while (!outResult.timeout \u0026\u0026 outResult.who == null); } } } mSupervisor.mActivityMetricsLogger.notifyActivityLaunched(res, outRecord[0]); return res; } } int startActivityLocked(IApplicationThread caller, Intent intent, Intent ephemeralIntent, String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, int requestCode, int callingPid, int callingUid, String callingPackage, int realCallingPid, int realCallingUid, int startFlags, ActivityOptions options, boolean ignoreTargetSecurity, boolean componentSpecified, ActivityRecord[] outActivity, TaskRecord inTask, String reason) { if (TextUtils.isEmpty(reason)) { throw new IllegalArgumentException(\"Need to specify a reason.\"); } mLastStartReason = reason; mLastStartActivityTimeMs = System.currentTimeMillis(); mLastStartActivityRecord[0] = null; mLastStartActivityResult = startActivity(caller, intent, ephemeralIntent, resolvedType, aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode, callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity, componentSpecified, mLastStartActivityRecord, inTask); if (outActivity != null) { // mLastStartActivityRecord[0] is set in the call to startActivity above. outActivity[0] = mLastStartActivityRecord[0]; } // Aborted results are treated as successes externally, but we must track them internally. return mLastStartActivityResult != START_ABORTED ? mLastStartActivityResult : START_SUCCESS; } /** DO NOT call this method directly. Use {@link #startActivityLocked} instead. */ private int startActivity(IApplicationThread caller, Intent intent, Intent ephemeralIntent, String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, int requestCode, int callingPid, int callingUid, String callingPackage, int realCallingPid, int realCallingUid, int startFlags, ActivityOptions options, boolean ignoreTargetSecurity, boolean componentSpecified, ActivityRecord[] outActivity, TaskRecord inTask) { int err = ActivityManager.START_SUCCESS; // Pull the optional Ephemeral Installer-only bundle out of the options early. final Bundle verificationBundle = options != null ? options.popAppVerificationBundle() : null; ProcessRecord callerApp = null; if (caller != null) { // 获取源进程记录 callerApp = mService.getRecordForAppLocked(caller); if (callerApp != null) { callingPid = callerApp.pid; callingUid = callerApp.info.uid; } else { Slog.w(TAG, \"Unable to find app for caller \" + caller + \" (pid=\" + callingPid + \") when starting: \" + intent.toString()); err = ActivityManager.START_PERMISSION_DENIED; } } final int userId = aInfo != null ? UserHandle.getUserId(aInfo.applicationInfo.uid) : 0; if (err == ActivityManager.START_SUCCESS) { Slog.i(TAG, \"START u\" + userId + \" {\" + intent.toShortString(true, true, true, false) + \"} from uid \" + callingUid); } ActivityRecord sourceRecord = null; ActivityRecord resultRecord = null; if (resultTo != null) { sourceRecord = mSupervisor.isInAnyStackLocked(resultTo); if (DEBUG_RESULTS) Slog.v(TAG_RESULTS, \"Will send result to \" + resultTo + \" \" + sourceRecord); if (sourceRecord != null) { if (requestCode \u003e= 0 \u0026\u0026 !sourceRecord.finishing) { resultRecord = sourceRecord; } } } final int launchFlags = intent.getFlags(); if ((launchFlags \u0026 Intent.FLAG_ACTIVITY_FORWARD_RESULT) != 0 \u0026\u0026 sourceRecord != null) { // Transfer the result target from the source activity to the new // one being started, including any failures. if (requestCode \u003e= 0) { ActivityOptions.abort(options); return ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT; } resultRecord = sourceRecord.resultTo; if (resultRecord != null \u0026\u0026 !resultRecord.isInStackLocked()) { resultRecord = null; } resultWho = sourceRecord.resultWho; requestCode = sourceRecord.requestCode; sourceRecord.resultTo = null; if (resultRecord != null) { resultRecord.removeResultsLocked(sourceRecord, resultWho, requestCode); } if (sourceRecord.launchedFromUid == callingUid) { // The new activity is being launched from the same uid as the previous // activity in the flow, and asking to forward its result back to the // previous. In this case the activity is serving as a trampoline between // the two, so we also want to update its launchedFromPackage to be the // same as the previous activity. Note that this is safe, since we know // these two packages come from the same uid; the caller could just as // well have supplied that same package name itself. This specifially // deals with the case of an intent picker/chooser being launched in the app // flow to redirect to an activity picked by the user, where we want the final // activity to consider it to have been launched by the previous app activity. callingPackage = sourceRecord.launchedFromPackage; } } if (err == ActivityManager.START_SUCCESS \u0026\u0026 intent.getComponent() == null) { // We couldn't find a class that can handle the given Intent. // That's the end of that! err = ActivityManager.START_INTENT_NOT_RESOLVED; } if (err == ActivityManager.START_SUCCESS \u0026\u0026 aInfo == null) { // We couldn't find the specific class specified in the Intent. // Also the end of the line. err = ActivityManager.START_CLASS_NOT_FOUND; } if (err == ActivityManager.START_SUCCESS \u0026\u0026 sourceRecord != null \u0026\u0026 sourceRecord.getTask().voiceSession != null) { // If this activity is being launched as part of a voice session, we need // to ensure that it is safe to do so. If the upcoming activity will also // be part of the voice session, we can only launch it if it has explicitly // said it supports the VOICE category, or it is a part of the calling app. if ((launchFlags \u0026 FLAG_ACTIVITY_NEW_TASK) == 0 \u0026\u0026 sourceRecord.info.applicationInfo.uid != aInfo.applicationInfo.uid) { try { intent.addCategory(Intent.CATEGORY_VOICE); if (!AppGlobals.getPackageManager().activitySupportsIntent( intent.getComponent(), intent, resolvedType)) { Slog.w(TAG, \"Activity being started in current voice task does not support voice: \" + intent); err = ActivityManager.START_NOT_VOICE_COMPATIBLE; } } catch (RemoteException e) { Slog.w(TAG, \"Failure checking voice capabilities\", e); err = ActivityManager.START_NOT_VOICE_COMPATIBLE; } } } if (err == ActivityManager.START_SUCCESS \u0026\u0026 voiceSession != null) { // If the caller is starting a new voice session, just make sure the target // is actually allowing it to run this way. try { if (!AppGlobals.getPackageManager().activitySupportsIntent(intent.getComponent(), intent, resolvedType)) { Slog.w(TAG, \"Activity being started in new voice task does not support: \" + intent); err = ActivityManager.START_NOT_VOICE_COMPATIBLE; } } catch (RemoteException e) { Slog.w(TAG, \"Failure checking voice capabilities\", e); err = ActivityManager.START_NOT_VOICE_COMPATIBLE; } } final ActivityStack resultStack = resultRecord == null ? null : resultRecord.getStack(); if (err != START_SUCCESS) { if (resultRecord != null) { resultStack.sendActivityResultLocked( -1, resultRecord, resultWho, requestCode, RESULT_CANCELED, null); } ActivityOptions.abort(options); return err; } boolean abort = !mSupervisor.checkStartAnyActivityPermission(intent, aInfo, resultWho, requestCode, callingPid, callingUid, callingPackage, ignoreTargetSecurity, callerApp, resultRecord, resultStack, options); abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid, callingPid, resolvedType, aInfo.applicationInfo); if (mService.mController != null) { try { // The Intent we give to the watcher has the extra data // stripped off, since it can contain private information. Intent watchIntent = intent.cloneFilter(); abort |= !mService.mController.activityStarting(watchIntent, aInfo.applicationInfo.packageName); } catch (RemoteException e) { mService.mController = null; } } mInterceptor.setStates(userId, realCallingPid, realCallingUid, startFlags, callingPackage); mInterceptor.intercept(intent, rInfo, aInfo, resolvedType, inTask, callingPid, callingUid, options); intent = mInterceptor.mIntent; rInfo = mInterceptor.mRInfo; aInfo = mInterceptor.mAInfo; resolvedType = mInterceptor.mResolvedType; inTask = mInterceptor.mInTask; callingPid = mInterceptor.mCallingPid; callingUid = mInterceptor.mCallingUid; options = mInterceptor.mActivityOptions; if (abort) { if (resultRecord != null) { resultStack.sendActivityResultLocked(-1, resultRecord, resultWho, requestCode, RESULT_CANCELED, null); } // We pretend to the caller that it was really started, but // they will just get a cancel result. ActivityOptions.abort(options); return START_ABORTED; } // If permissions need a review before any of the app components can run, we // launch the review activity and pass a pending intent to start the activity // we are to launching now after the review is completed. if (mService.mPermissionReviewRequired \u0026\u0026 aInfo != null) { if (mService.getPackageManagerInternalLocked().isPermissionsReviewRequired( aInfo.packageName, userId)) { IIntentSender target = mService.getIntentSenderLocked( ActivityManager.INTENT_SENDER_ACTIVITY, callingPackage, callingUid, userId, null, null, 0, new Intent[]{intent}, new String[]{resolvedType}, PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_ONE_SHOT, null); final int flags = intent.getFlags(); Intent newIntent = new Intent(Intent.ACTION_REVIEW_PERMISSIONS); newIntent.setFlags(flags | Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS); newIntent.putExtra(Intent.EXTRA_PACKAGE_NAME, aInfo.packageName); newIntent.putExtra(Intent.EXTRA_INTENT, new IntentSender(target)); if (resultRecord != null) { newIntent.putExtra(Intent.EXTRA_RESULT_NEEDED, true); } intent = newIntent; resolvedType = null; callingUid = realCallingUid; callingPid = realCallingPid; rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId); aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, null /*profilerInfo*/); if (DEBUG_PERMISSIONS_REVIEW) { Slog.i(TAG, \"START u\" + userId + \" {\" + intent.toShortString(true, true, true, false) + \"} from uid \" + callingUid + \" on display \" + (mSupervisor.mFocusedStack == null ? DEFAULT_DISPLAY : mSupervisor.mFocusedStack.mDisplayId)); } } } // If we have an ephemeral app, abort the process of launching the resolved intent. // Instead, launch the ephemeral installer. Once the installer is finished, it // starts either the intent we resolved here [on install error] or the ephemeral // app [on install success]. if (rInfo != null \u0026\u0026 rInfo.auxiliaryInfo != null) { intent = createLaunchIntent(rInfo.auxiliaryInfo, ephemeralIntent, callingPackage, verificationBundle, resolvedType, userId); resolvedType = null; callingUid = realCallingUid; callingPid = realCallingPid; aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, null /*profilerInfo*/); } ActivityRecord r = new ActivityRecord(mService, callerApp, callingPid, callingUid, callingPackage, intent, resolvedType, aInfo, mService.getGlobalConfiguration(), resultRecord, resultWho, requestCode, componentSpecified, voiceSession != null, mSupervisor, options, sourceRecord); if (outActivity != null) { outActivity[0] = r; } if (r.appTimeTracker == null \u0026\u0026 sourceRecord != null) { // If the caller didn't specify an explicit time tracker, we want to continue // tracking under any it has. r.appTimeTracker = sourceRecord.appTimeTracker; } final ActivityStack stack = mSupervisor.mFocusedStack; if (voiceSession == null \u0026\u0026 (stack.mResumedActivity == null || stack.mResumedActivity.info.applicationInfo.uid != callingUid)) { if (!mService.checkAppSwitchAllowedLocked(callingPid, callingUid, realCallingPid, realCallingUid, \"Activity start\")) { PendingActivityLaunch pal = new PendingActivityLaunch(r, sourceRecord, startFlags, stack, callerApp); mPendingActivityLaunches.add(pal); ActivityOptions.abort(options); return ActivityManager.START_SWITCHES_CANCELED; } } if (mService.mDidAppSwitch) { // This is the second allowed switch since we stopped switches, // so now just generally allow switches. Use case: user presses // home (switches disabled, switch to home, mDidAppSwitch now true); // user taps a home icon (coming from home so allowed, we hit here // and now allow anyone to switch again). mService.mAppSwitchesAllowedTime = 0; } else { mService.mDidAppSwitch = true; } doPendingActivityLaunchesLocked(false); return startActivity(r, sourceRecord, voiceSession, voiceInteractor, startFlags, true, options, inTask, outActivity); } private int startActivity(final ActivityRecord r, ActivityRecord sourceRecord, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, int startFlags, boolean doResume, ActivityOptions options, TaskRecord inTask, ActivityRecord[] outActivity) { int result = START_CANCELED; try { mService.mWindowManager.deferSurfaceLayout(); result = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor, startFlags, doResume, options, inTask, outActivity); } finally { // If we are not able to proceed, disassociate the activity from the task. Leaving an // activity in an incomplete state can lead to issues, such as performing operations // without a window container. if (!ActivityManager.isStartResultSuccessful(result) \u0026\u0026 mStartActivity.getTask() != null) { mStartActivity.getTask().removeActivity(mStartActivity); } mService.mWindowManager.continueSurfaceLayout(); } postStartActivityProcessing(r, result, mSupervisor.getLastStack().mStackId, mSourceRecord, mTargetStack); return result; } // Note: This method should only be called from {@link startActivity}. private int startActivityUnchecked(final ActivityRecord r, ActivityRecord sourceRecord, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, int startFlags, boolean doResume, ActivityOptions options, TaskRecord inTask, ActivityRecord[] outActivity) { setInitialState(r, options, inTask, doResume, startFlags, sourceRecord, voiceSession, voiceInteractor); computeLaunchingTaskFlags(); computeSourceStack(); mIntent.setFlags(mLaunchFlags); ActivityRecord reusedActivity = getReusableIntentActivity(); final int preferredLaunchStackId = (mOptions != null) ? mOptions.getLaunchStackId() : INVALID_STACK_ID; final int preferredLaunchDisplayId = (mOptions != null) ? mOptions.getLaunchDisplayId() : DEFAULT_DISPLAY; if (reusedActivity != null) { // When the flags NEW_TASK and CLEAR_TASK are set, then the task gets reused but // still needs to be a lock task mode violation since the task gets cleared out and // the device would otherwise leave the locked task. if (mSupervisor.isLockTaskModeViolation(reusedActivity.getTask(), (mLaunchFlags \u0026 (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK)) == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))) { mSupervisor.showLockTaskToast(); Slog.e(TAG, \"startActivityUnchecked: Attempt to violate Lock Task Mode\"); return START_RETURN_LOCK_TASK_MODE_VIOLATION; } if (mStartActivity.getTask() == null) { mStartActivity.setTask(reusedActivity.getTask()); } if (reusedActivity.getTask().intent == null) { // This task was started because of movement of the activity based on affinity... // Now that we are actually launching it, we can assign the base intent. reusedActivity.getTask().setIntent(mStartActivity); } // This code path leads to delivering a new intent, we want to make sure we schedule it // as the first operation, in case the activity will be resumed as a result of later // operations. if ((mLaunchFlags \u0026 FLAG_ACTIVITY_CLEAR_TOP) != 0 || isDocumentLaunchesIntoExisting(mLaunchFlags) || mLaunchSingleInstance || mLaunchSingleTask) { final TaskRecord task = reusedActivity.getTask(); // In this situation we want to remove all activities from the task up to the one // being started. In most cases this means we are resetting the task to its initial // state. final ActivityRecord top = task.performClearTaskForReuseLocked(mStartActivity, mLaunchFlags); // The above code can remove {@code reusedActivity} from the task, leading to the // the {@code ActivityRecord} removing its reference to the {@code TaskRecord}. The // task reference is needed in the call below to // {@link setTargetStackAndMoveToFrontIfNeeded}. if (reusedActivity.getTask() == null) { reusedActivity.setTask(task); } if (top != null) { if (top.frontOfTask) { // Activity aliases may mean we use different intents for the top activity, // so make sure the task now has the identity of the new intent. top.getTask().setIntent(mStartActivity); } deliverNewIntent(top); } } sendPowerHintForLaunchStartIfNeeded(false /* forceSend */, reusedActivity); reusedActivity = setTargetStackAndMoveToFrontIfNeeded(reusedActivity); final ActivityRecord outResult = outActivity != null \u0026\u0026 outActivity.length \u003e 0 ? outActivity[0] : null; // When there is a reused activity and the current result is a trampoline activity, // set the reused activity as the result. if (outResult != null \u0026\u0026 (outResult.finishing || outResult.noDisplay)) { outActivity[0] = reusedActivity; } if ((mStartFlags \u0026 START_FLAG_ONLY_IF_NEEDED) != 0) { // We don't need to start a new activity, and the client said not to do anything // if that is the case, so this is it! And for paranoia, make sure we have // correctly resumed the top activity. resumeTargetStackIfNeeded(); return START_RETURN_INTENT_TO_CALLER; } setTaskFromIntentActivity(reusedActivity); if (!mAddingToTask \u0026\u0026 mReuseTask == null) { // We didn't do anything... but it was needed (a.k.a., client don't use that // intent!) And for paranoia, make sure we have correctly resumed the top activity. resumeTargetStackIfNeeded(); if (outActivity != null \u0026\u0026 outActivity.length \u003e 0) { outActivity[0] = reusedActivity; } return START_TASK_TO_FRONT; } } if (mStartActivity.packageName == null) { final ActivityStack sourceStack = mStartActivity.resultTo != null ? mStartActivity.resultTo.getStack() : null; if (sourceStack != null) { sourceStack.sendActivityResultLocked(-1 /* callingUid */, mStartActivity.resultTo, mStartActivity.resultWho, mStartActivity.requestCode, RESULT_CANCELED, null /* data */); } ActivityOptions.abort(mOptions); return START_CLASS_NOT_FOUND; } // If the activity being launched is the same as the one currently at the top, then // we need to check if it should only be launched once. final ActivityStack topStack = mSupervisor.mFocusedStack; final ActivityRecord topFocused = topStack.topActivity(); final ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(mNotTop); final boolean dontStart = top != null \u0026\u0026 mStartActivity.resultTo == null \u0026\u0026 top.realActivity.equals(mStartActivity.realActivity) \u0026\u0026 top.userId == mStartActivity.userId \u0026\u0026 top.app != null \u0026\u0026 top.app.thread != null \u0026\u0026 ((mLaunchFlags \u0026 FLAG_ACTIVITY_SINGLE_TOP) != 0 || mLaunchSingleTop || mLaunchSingleTask); if (dontStart) { // For paranoia, make sure we have correctly resumed the top activity. topStack.mLastPausedActivity = null; if (mDoResume) { mSupervisor.resumeFocusedStackTopActivityLocked(); } ActivityOptions.abort(mOptions); if ((mStartFlags \u0026 START_FLAG_ONLY_IF_NEEDED) != 0) { // We don't need to start a new activity, and the client said not to do // anything if that is the case, so this is it! return START_RETURN_INTENT_TO_CALLER; } deliverNewIntent(top); // Don't use mStartActivity.task to show the toast. We're not starting a new activity // but reusing 'top'. Fields in mStartActivity may not be fully initialized. mSupervisor.handleNonResizableTaskIfNeeded(top.getTask(), preferredLaunchStackId, preferredLaunchDisplayId, topStack.mStackId); return START_DELIVERED_TO_TOP; } boolean newTask = false; final TaskRecord taskToAffiliate = (mLaunchTaskBehind \u0026\u0026 mSourceRecord != null) ? mSourceRecord.getTask() : null; // Should this be considered a new task? int result = START_SUCCESS; if (mStartActivity.resultTo == null \u0026\u0026 mInTask == null \u0026\u0026 !mAddingToTask \u0026\u0026 (mLaunchFlags \u0026 FLAG_ACTIVITY_NEW_TASK) != 0) { newTask = true; result = setTaskFromReuseOrCreateNewTask( taskToAffiliate, preferredLaunchStackId, topStack); } else if (mSourceRecord != null) { result = setTaskFromSourceRecord(); } else if (mInTask != null) { result = setTaskFromInTask(); } else { // This not being started from an existing activity, and not part of a new task... // just put it in the top task, though these days this case should never happen. setTaskToCurrentTopOrCreateNewTask(); } if (result != START_SUCCESS) { return result; } mService.grantUriPermissionFromIntentLocked(mCallingUid, mStartActivity.packageName, mIntent, mStartActivity.getUriPermissionsLocked(), mStartActivity.userId); mService.grantEphemeralAccessLocked(mStartActivity.userId, mIntent, mStartActivity.appInfo.uid, UserHandle.getAppId(mCallingUid)); if (mSourceRecord != null) { mStartActivity.getTask().setTaskToReturnTo(mSourceRecord); } if (newTask) { EventLog.writeEvent( EventLogTags.AM_CREATE_TASK, mStartActivity.userId, mStartActivity.getTask().taskId); } ActivityStack.logStartActivity( EventLogTags.AM_CREATE_ACTIVITY, mStartActivity, mStartActivity.getTask()); mTargetStack.mLastPausedActivity = null; sendPowerHintForLaunchStartIfNeeded(false /* forceSend */, mStartActivity); mTargetStack.startActivityLocked(mStartActivity, topFocused, newTask, mKeepCurTransition, mOptions); if (mDoResume) { final ActivityRecord topTaskActivity = mStartActivity.getTask().topRunningActivityLocked(); if (!mTargetStack.isFocusable() || (topTaskActivity != null \u0026\u0026 topTaskActivity.mTaskOverlay \u0026\u0026 mStartActivity != topTaskActivity)) { // If the activity is not focusable, we can't resume it, but still would like to // make sure it becomes visible as it starts (this will also trigger entry // animation). An example of this are PIP activities. // Also, we don't want to resume activities in a task that currently has an overlay // as the starting activity just needs to be in the visible paused state until the // over is removed. mTargetStack.ensureActivitiesVisibleLocked(null, 0, !PRESERVE_WINDOWS); // Go ahead and tell window manager to execute app transition for this activity // since the app transition will not be triggered through the resume channel. mWindowManager.executeAppTransition(); } else { // If the target stack was not previously focusable (previous top running activity // on that stack was not visible) then any prior calls to move the stack to the // will not update the focused stack. If starting the new activity now allows the // task stack to be focusable, then ensure that we now update the focused stack // accordingly. if (mTargetStack.isFocusable() \u0026\u0026 !mSupervisor.isFocusedStack(mTargetStack)) { mTargetStack.moveToFront(\"startActivityUnchecked\"); } mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity, mOptions); } } else { mTargetStack.addRecentActivityLocked(mStartActivity); } mSupervisor.updateUserStackLocked(mStartActivity.userId, mTargetStack); mSupervisor.handleNonResizableTaskIfNeeded(mStartActivity.getTask(), preferredLaunchStackId, preferredLaunchDisplayId, mTargetStack.mStackId); return START_SUCCESS; } ActivityStackSupervisor.java\nboolean resumeFocusedStackTopActivityLocked( ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions) { if (!readyToResume()) { return false; } if (targetStack != null \u0026\u0026 isFocusedStack(targetStack)) { return targetStack.resumeTopActivityUncheckedLocked(target, targetOptions); } final ActivityRecord r = mFocusedStack.topRunningActivityLocked(); if (r == null || r.state != RESUMED) { mFocusedStack.resumeTopActivityUncheckedLocked(null, null); } else if (r.state == RESUMED) { // Kick off any lingering app transitions form the MoveTaskToFront operation. mFocusedStack.executeAppTransition(targetOptions); } return false; ActivityStack.java\n/** * Ensure that the top activity in the stack is resumed. * * @param prev The previously resumed activity, for when in the process * of pausing; can be null to call from elsewhere. * @param options Activity options. * * @return Returns true if something is being resumed, or false if * nothing happened. * * NOTE: It is not safe to call this method directly as it can cause an activity in a * non-focused stack to be resumed. * Use {@link ActivityStackSupervisor#resumeFocusedStackTopActivityLocked} to resume the * right activity for the current system state. */ boolean resumeTopActivityUncheckedLocked(ActivityRecord prev, ActivityOptions options) { if (mStackSupervisor.inResumeTopActivity) { // Don't even start recursing. return false; } boolean result = false; try { // Protect against recursion. mStackSupervisor.inResumeTopActivity = true; result = resumeTopActivityInnerLocked(prev, options); } finally { mStackSupervisor.inResumeTopActivity = false; } // When resuming the top activity, it may be necessary to pause the top activity (for // example, returning to the lock screen. We suppress the normal pause logic in // {@link #resumeTopActivityUncheckedLocked}, since the top activity is resumed at the end. // We call the {@link ActivityStackSupervisor#checkReadyForSleepLocked} again here to ensure // any necessary pause logic occurs. In the case where the Activity will be shown regardless // of the lock screen, the call to {@link ActivityStackSupervisor#checkReadyForSleepLocked} // is skipped. final ActivityRecord next = topRunningActivityLocked(true /* focusableOnly */); if (next == null || !next.canTurnScreenOn()) { checkReadyForSleep(); } return result; } private boolean resumeTopActivityInnerLocked(ActivityRecord prev, ActivityOptions options) { if (!mService.mBooting \u0026\u0026 !mService.mBooted) { // Not ready yet! return false; } // Find the next top-most activity to resume in this stack that is not finishing and is // focusable. If it is not focusable, we will fall into the case below to resume the // top activity in the next focusable task. final ActivityRecord next = topRunningActivityLocked(true /* focusableOnly */); final boolean hasRunningActivity = next != null; // TODO: Maybe this entire condition can get removed? if (hasRunningActivity \u0026\u0026 getDisplay() == null) { return false; } mStackSupervisor.cancelInitializingActivities(); // Remember how we'll process this pause/resume situation, and ensure // that the state is reset however we wind up proceeding. final boolean userLeaving = mStackSupervisor.mUserLeaving; mStackSupervisor.mUserLeaving = false; if (!hasRunningActivity) { // There are no activities left in the stack, let's look somewhere else. return resumeTopActivityInNextFocusableStack(prev, options, \"noMoreActivities\"); } next.delayedResume = false; // If the top activity is the resumed one, nothing to do. if (mResumedActivity == next \u0026\u0026 next.state == ActivityState.RESUMED \u0026\u0026 mStackSupervisor.allResumedActivitiesComplete()) { // Make sure we have executed any pending transitions, since there // should be nothing left to do at this point. executeAppTransition(options); if (DEBUG_STATES) Slog.d(TAG_STATES, \"resumeTopActivityLocked: Top activity resumed \" + next); if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); return false; } final TaskRecord nextTask = next.getTask(); final TaskRecord prevTask = prev != null ? prev.getTask() : null; if (prevTask != null \u0026\u0026 prevTask.getStack() == this \u0026\u0026 prevTask.isOverHomeStack() \u0026\u0026 prev.finishing \u0026\u0026 prev.frontOfTask) { if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); if (prevTask == nextTask) { prevTask.setFrontOfTask(); } else if (prevTask != topTask()) { // This task is going away but it was supposed to return to the home stack. // Now the task above it has to return to the home task instead. final int taskNdx = mTaskHistory.indexOf(prevTask) + 1; mTaskHistory.get(taskNdx).setTaskToReturnTo(HOME_ACTIVITY_TYPE); } else if (!isOnHomeDisplay()) { return false; } else if (!isHomeStack()){ if (DEBUG_STATES) Slog.d(TAG_STATES, \"resumeTopActivityLocked: Launching home next\"); return isOnHomeDisplay() \u0026\u0026 mStackSupervisor.resumeHomeStackTask(prev, \"prevFinished\"); } } // If we are sleeping, and there is no resumed activity, and the top // activity is paused, well that is the state we want. if (shouldSleepOrShutDownActivities() \u0026\u0026 mLastPausedActivity == next \u0026\u0026 mStackSupervisor.allPausedActivitiesComplete()) { // Make sure we have executed any pending transitions, since there // should be nothing left to do at this point. executeAppTransition(options); if (DEBUG_STATES) Slog.d(TAG_STATES, \"resumeTopActivityLocked: Going to sleep and all paused\"); if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); return false; } // Make sure that the user who owns this activity is started. If not, // we will just leave it as is because someone should be bringing // another user's activities to the top of the stack. if (!mService.mUserController.hasStartedUserState(next.userId)) { Slog.w(TAG, \"Skipping resume of top activity \" + next + \": user \" + next.userId + \" is stopped\"); if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); return false; } // The activity may be waiting for stop, but that is no longer // appropriate for it. mStackSupervisor.mStoppingActivities.remove(next); mStackSupervisor.mGoingToSleepActivities.remove(next); next.sleeping = false; mStackSupervisor.mActivitiesWaitingForVisibleActivity.remove(next); if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, \"Resuming \" + next); // If we are currently pausing an activity, then don't do anything until that is done. if (!mStackSupervisor.allPausedActivitiesComplete()) { if (DEBUG_SWITCH || DEBUG_PAUSE || DEBUG_STATES) Slog.v(TAG_PAUSE, \"resumeTopActivityLocked: Skip resume: some activity pausing.\"); if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); return false; } mStackSupervisor.setLaunchSource(next.info.applicationInfo.uid); boolean lastResumedCanPip = false; final ActivityStack lastFocusedStack = mStackSupervisor.getLastStack(); if (lastFocusedStack != null \u0026\u0026 lastFocusedStack != this) { // So, why aren't we using prev here??? See the param comment on the method. prev doesn't // represent the last resumed activity. However, the last focus stack does if it isn't null. final ActivityRecord lastResumed = lastFocusedStack.mResumedActivity; lastResumedCanPip = lastResumed != null \u0026\u0026 lastResumed.checkEnterPictureInPictureState( \"resumeTopActivity\", userLeaving /* beforeStopping */); } // If the flag RESUME_WHILE_PAUSING is set, then continue to schedule the previous activity // to be paused, while at the same time resuming the new resume activity only if the // previous activity can't go into Pip since we want to give Pip activities a chance to // enter Pip before resuming the next activity. final boolean resumeWhilePausing = (next.info.flags \u0026 FLAG_RESUME_WHILE_PAUSING) != 0 \u0026\u0026 !lastResumedCanPip; boolean pausing = mStackSupervisor.pauseBackStacks(userLeaving, next, false); if (mResumedActivity != null) { if (DEBUG_STATES) Slog.d(TAG_STATES, \"resumeTopActivityLocked: Pausing \" + mResumedActivity); pausing |= startPausingLocked(userLeaving, false, next, false); } if (pausing \u0026\u0026 !resumeWhilePausing) { if (DEBUG_SWITCH || DEBUG_STATES) Slog.v(TAG_STATES, \"resumeTopActivityLocked: Skip resume: need to start pausing\"); // At this point we want to put the upcoming activity's process // at the top of the LRU list, since we know we will be needing it // very soon and it would be a waste to let it get killed if it // happens to be sitting towards the end. if (next.app != null \u0026\u0026 next.app.thread != null) { mService.updateLruProcessLocked(next.app, true, null); } if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); return true; } else if (mResumedActivity == next \u0026\u0026 next.state == ActivityState.RESUMED \u0026\u0026 mStackSupervisor.allResumedActivitiesComplete()) { // It is possible for the activity to be resumed when we paused back stacks above if the // next activity doesn't have to wait for pause to complete. // So, nothing else to-do except: // Make sure we have executed any pending transitions, since there // should be nothing left to do at this point. executeAppTransition(options); if (DEBUG_STATES) Slog.d(TAG_STATES, \"resumeTopActivityLocked: Top activity resumed (dontWaitForPause) \" + next); if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); return true; } // If the most recent activity was noHistory but was only stopped rather // than stopped+finished because the device went to sleep, we need to make // sure to finish it as we're making a new activity topmost. if (shouldSleepActivities() \u0026\u0026 mLastNoHistoryActivity != null \u0026\u0026 !mLastNoHistoryActivity.finishing) { if (DEBUG_STATES) Slog.d(TAG_STATES, \"no-history finish of \" + mLastNoHistoryActivity + \" on new resume\"); requestFinishActivityLocked(mLastNoHistoryActivity.appToken, Activity.RESULT_CANCELED, null, \"resume-no-history\", false); mLastNoHistoryActivity = null; } if (prev != null \u0026\u0026 prev != next) { if (!mStackSupervisor.mActivitiesWaitingForVisibleActivity.contains(prev) \u0026\u0026 next != null \u0026\u0026 !next.nowVisible) { mStackSupervisor.mActivitiesWaitingForVisibleActivity.add(prev); if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, \"Resuming top, waiting visible to hide: \" + prev); } else { // The next activity is already visible, so hide the previous // activity's windows right now so we can show the new one ASAP. // We only do this if the previous is finishing, which should mean // it is on top of the one being resumed so hiding it quickly // is good. Otherwise, we want to do the normal route of allowing // the resumed activity to be shown so we can decide if the // previous should actually be hidden depending on whether the // new one is found to be full-screen or not. if (prev.finishing) { prev.setVisibility(false); if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, \"Not waiting for visible to hide: \" + prev + \", waitingVisible=\" + mStackSupervisor.mActivitiesWaitingForVisibleActivity.contains(prev) + \", nowVisible=\" + next.nowVisible); } else { if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, \"Previous already visible but still waiting to hide: \" + prev + \", waitingVisible=\" + mStackSupervisor.mActivitiesWaitingForVisibleActivity.contains(prev) + \", nowVisible=\" + next.nowVisible); } } } // Launching this app's activity, make sure the app is no longer // considered stopped. try { AppGlobals.getPackageManager().setPackageStoppedState( next.packageName, false, next.userId); /* TODO: Verify if correct userid */ } catch (RemoteException e1) { } catch (IllegalArgumentException e) { Slog.w(TAG, \"Failed trying to unstop package \" + next.packageName + \": \" + e); } // We are starting up the next activity, so tell the window manager // that the previous one will be hidden soon. This way it can know // to ignore it when computing the desired screen orientation. boolean anim = true; if (prev != null) { if (prev.finishing) { if (DEBUG_TRANSITION) Slog.v(TAG_TRANSITION, \"Prepare close transition: prev=\" + prev); if (mNoAnimActivities.contains(prev)) { anim = false; mWindowManager.prepareAppTransition(TRANSIT_NONE, false); } else { mWindowManager.prepareAppTransition(prev.getTask() == next.getTask() ? TRANSIT_ACTIVITY_CLOSE : TRANSIT_TASK_CLOSE, false); } prev.setVisibility(false); } else { if (DEBUG_TRANSITION) Slog.v(TAG_TRANSITION, \"Prepare open transition: prev=\" + prev); if (mNoAnimActivities.contains(next)) { anim = false; mWindowManager.prepareAppTransition(TRANSIT_NONE, false); } else { mWindowManager.prepareAppTransition(prev.getTask() == next.getTask() ? TRANSIT_ACTIVITY_OPEN : next.mLaunchTaskBehind ? TRANSIT_TASK_OPEN_BEHIND : TRANSIT_TASK_OPEN, false); } } } else { if (DEBUG_TRANSITION) Slog.v(TAG_TRANSITION, \"Prepare open transition: no previous\"); if (mNoAnimActivities.contains(next)) { anim = false; mWindowManager.prepareAppTransition(TRANSIT_NONE, false); } else { mWindowManager.prepareAppTransition(TRANSIT_ACTIVITY_OPEN, false); } } Bundle resumeAnimOptions = null; if (anim) { ActivityOptions opts = next.getOptionsForTargetActivityLocked(); if (opts != null) { resumeAnimOptions = opts.toBundle(); } next.applyOptionsLocked(); } else { next.clearOptionsLocked(); } ActivityStack lastStack = mStackSupervisor.getLastStack(); if (next.app != null \u0026\u0026 next.app.thread != null) { if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, \"Resume running: \" + next + \" stopped=\" + next.stopped + \" visible=\" + next.visible); // If the previous activity is translucent, force a visibility update of // the next activity, so that it's added to WM's opening app list, and // transition animation can be set up properly. // For example, pressing Home button with a translucent activity in focus. // Launcher is already visible in this case. If we don't add it to opening // apps, maybeUpdateTransitToWallpaper() will fail to identify this as a // TRANSIT_WALLPAPER_OPEN animation, and run some funny animation. final boolean lastActivityTranslucent = lastStack != null \u0026\u0026 (!lastStack.mFullscreen || (lastStack.mLastPausedActivity != null \u0026\u0026 !lastStack.mLastPausedActivity.fullscreen)); // The contained logic must be synchronized, since we are both changing the visibility // and updating the {@link Configuration}. {@link ActivityRecord#setVisibility} will // ultimately cause the client code to schedule a layout. Since layouts retrieve the // current {@link Configuration}, we must ensure that the below code updates it before // the layout can occur. synchronized(mWindowManager.getWindowManagerLock()) { // This activity is now becoming visible. if (!next.visible || next.stopped || lastActivityTranslucent) { next.setVisibility(true); } // schedule launch ticks to collect information about slow apps. next.startLaunchTickingLocked(); ActivityRecord lastResumedActivity = lastStack == null ? null :lastStack.mResumedActivity; ActivityState lastState = next.state; mService.updateCpuStats(); if (DEBUG_STATES) Slog.v(TAG_STATES, \"Moving to RESUMED: \" + next + \" (in existing)\"); setResumedActivityLocked(next, \"resumeTopActivityInnerLocked\"); mService.updateLruProcessLocked(next.app, true, null); updateLRUListLocked(next); mService.updateOomAdjLocked(); // Have the window manager re-evaluate the orientation of // the screen based on the new activity order. boolean notUpdated = true; if (mStackSupervisor.isFocusedStack(this)) { // We have special rotation behavior when Keyguard is locked. Make sure all // activity visibilities are set correctly as well as the transition is updated // if needed to get the correct rotation behavior. // TODO: Remove this once visibilities are set correctly immediately when // starting an activity. if (mStackSupervisor.mKeyguardController.isKeyguardLocked()) { mStackSupervisor.ensureActivitiesVisibleLocked(null /* starting */, 0 /* configChanges */, false /* preserveWindows */); } final Configuration config = mWindowManager.updateOrientationFromAppTokens( mStackSupervisor.getDisplayOverrideConfiguration(mDisplayId), next.mayFreezeScreenLocked(next.app) ? next.appToken : null, mDisplayId); if (config != null) { next.frozenBeforeDestroy = true; } notUpdated = !mService.updateDisplayOverrideConfigurationLocked(config, next, false /* deferResume */, mDisplayId); } if (notUpdated) { // The configuration update wasn't able to keep the existing // instance of the activity, and instead started a new one. // We should be all done, but let's just make sure our activity // is still at the top and schedule another run if something // weird happened. ActivityRecord nextNext = topRunningActivityLocked(); if (DEBUG_SWITCH || DEBUG_STATES) Slog.i(TAG_STATES, \"Activity config changed during resume: \" + next + \", new next: \" + nextNext); if (nextNext != next) { // Do over! mStackSupervisor.scheduleResumeTopActivities(); } if (!next.visible || next.stopped) { next.setVisibility(true); } next.completeResumeLocked(); if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); return true; } try { // Deliver all pending results. ArrayList\u003cResultInfo\u003e a = next.results; if (a != null) { final int N = a.size(); if (!next.finishing \u0026\u0026 N \u003e 0) { if (DEBUG_RESULTS) Slog.v(TAG_RESULTS, \"Delivering results to \" + next + \": \" + a); next.app.thread.scheduleSendResult(next.appToken, a); } } if (next.newIntents != null) { next.app.thread.scheduleNewIntent( next.newIntents, next.appToken, false /* andPause */); } // Well the app will no longer be stopped. // Clear app token stopped state in window manager if needed. next.notifyAppResumed(next.stopped); EventLog.writeEvent(EventLogTags.AM_RESUME_ACTIVITY, next.userId, System.identityHashCode(next), next.getTask().taskId, next.shortComponentName); next.sleeping = false; mService.showUnsupportedZoomDialogIfNeededLocked(next); mService.showAskCompatModeDialogLocked(next); next.app.pendingUiClean = true; next.app.forceProcessStateUpTo(mService.mTopProcessState); next.clearOptionsLocked(); next.app.thread.scheduleResumeActivity(next.appToken, next.app.repProcState, mService.isNextTransitionForward(), resumeAnimOptions); if (DEBUG_STATES) Slog.d(TAG_STATES, \"resumeTopActivityLocked: Resumed \" + next); } catch (Exception e) { // Whoops, need to restart this activity! if (DEBUG_STATES) Slog.v(TAG_STATES, \"Resume failed; resetting state to \" + lastState + \": \" + next); next.state = lastState; if (lastStack != null) { lastStack.mResumedActivity = lastResumedActivity; } Slog.i(TAG, \"Restarting because process died: \" + next); if (!next.hasBeenLaunched) { next.hasBeenLaunched = true; } else if (SHOW_APP_STARTING_PREVIEW \u0026\u0026 lastStack != null \u0026\u0026 mStackSupervisor.isFrontStackOnDisplay(lastStack)) { next.showStartingWindow(null /* prev */, false /* newTask */, false /* taskSwitch */); } mStackSupervisor.startSpecificActivityLocked(next, true, false); if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); return true; } } // From this point on, if something goes wrong there is no way // to recover the activity. try { next.completeResumeLocked(); } catch (Exception e) { // If any exception gets thrown, toss away this // activity and try the next one. Slog.w(TAG, \"Exception thrown during resume of \" + next, e); requestFinishActivityLocked(next.appToken, Activity.RESULT_CANCELED, null, \"resume-exception\", true); if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); return true; } } else { // Whoops, need to restart this activity! if (!next.hasBeenLaunched) { next.hasBeenLaunched = true; } else { if (SHOW_APP_STARTING_PREVIEW) { next.showStartingWindow(null /* prev */, false /* newTask */, false /* taskSwich */); } if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, \"Restarting: \" + next); } if (DEBUG_STATES) Slog.d(TAG_STATES, \"resumeTopActivityLocked: Restarting \" + next); mStackSupervisor.startSpecificActivityLocked(next, true, true); } if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked(); return true; /** * Start pausing the currently resumed activity. It is an error to call this if there * is already an activity being paused or there is no resumed activity. * * @param userLeaving True if this should result in an onUserLeaving to the current activity. * @param uiSleeping True if this is happening with the user interface going to sleep (the * screen turning off). * @param resuming The activity we are currently trying to resume or null if this is not being * called as part of resuming the top activity, so we shouldn't try to instigate * a resume here if not null. * @param pauseImmediately True if the caller does not want to wait for the activity callback to * complete pausing. * @return Returns true if an activity now is in the PAUSING state, and we are waiting for * it to tell us when it is done. */ final boolean startPausingLocked(boolean userLeaving, boolean uiSleeping, ActivityRecord resuming, boolean pauseImmediately) { if (mPausingActivity != null) { Slog.wtf(TAG, \"Going to pause when pause is already pending for \" + mPausingActivity + \" state=\" + mPausingActivity.state); if (!shouldSleepActivities()) { // Avoid recursion among check for sleep and complete pause during sleeping. // Because activity will be paused immediately after resume, just let pause // be completed by the order of activity paused from clients. completePauseLocked(false, resuming); } } ActivityRecord prev = mResumedActivity; if (prev == null) { if (resuming == null) { Slog.wtf(TAG, \"Trying to pause when nothing is resumed\"); mStackSupervisor.resumeFocusedStackTopActivityLocked(); } return false; } if (DEBUG_STATES) Slog.v(TAG_STATES, \"Moving to PAUSING: \" + prev); else if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, \"Start pausing: \" + prev); mResumedActivity = null; mPausingActivity = prev; mLastPausedActivity = prev; mLastNoHistoryActivity = (prev.intent.getFlags() \u0026 Intent.FLAG_ACTIVITY_NO_HISTORY) != 0 || (prev.info.flags \u0026 ActivityInfo.FLAG_NO_HISTORY) != 0 ? prev : null; prev.state = ActivityState.PAUSING; prev.getTask().touchActiveTime(); clearLaunchTime(prev); final ActivityRecord next = mStackSupervisor.topRunningActivityLocked(); if (mService.mHasRecents \u0026\u0026 (next == null || next.noDisplay || next.getTask() != prev.getTask() || uiSleeping)) { prev.mUpdateTaskThumbnailWhenHidden = true; } stopFullyDrawnTraceIfNeeded(); mService.updateCpuStats(); if (prev.app != null \u0026\u0026 prev.app.thread != null) { if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, \"Enqueueing pending pause: \" + prev); try { EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY, prev.userId, System.identityHashCode(prev), prev.shortComponentName); mService.updateUsageStats(prev, false); prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing, userLeaving, prev.configChangeFlags, pauseImmediately); } catch (Exception e) { // Ignore exception, if process died other code will cleanup. Slog.w(TAG, \"Exception thrown during pause\", e); mPausingActivity = null; mLastPausedActivity = null; mLastNoHistoryActivity = null; } } else { mPausingActivity = null; mLastPausedActivity = null; mLastNoHistoryActivity = null; } // If we are not going to sleep, we want to ensure the device is // awake until the next activity is started. if (!uiSleeping \u0026\u0026 !mService.isSleepingOrShuttingDownLocked()) { mStackSupervisor.acquireLaunchWakelock(); } if (mPausingActivity != null) { // Have the window manager pause its key dispatching until the new // activity has started. If we're pausing the activity just because // the screen is being turned off and the UI is sleeping, don't interrupt // key dispatch; the same activity will pick it up again on wakeup. if (!uiSleeping) { prev.pauseKeyDispatchingLocked(); } else if (DEBUG_PAUSE) { Slog.v(TAG_PAUSE, \"Key dispatch not paused for screen off\"); } if (pauseImmediately) { // If the caller said they don't want to wait for the pause, then complete // the pause now. completePauseLocked(false, resuming); return false; } else { schedulePauseTimeout(prev); return true; } } else { // This activity failed to schedule the // pause, so just treat it as being paused now. if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, \"Activity not running, resuming next.\"); if (resuming == null) { mStackSupervisor.resumeFocusedStackTopActivityLocked(); } return false; } 如果要启动的activity的进程还不存在，那么会执行到mStackSupervisor.startSpecificActivityLocked(next, true, true);。 ActivityStackSupervisor.java\nvoid startSpecificActivityLocked(ActivityRecord r, boolean andResume, boolean checkConfig) { // Is this activity's application already running? ProcessRecord app = mService.getProcessRecordLocked(r.processName, r.info.applicationInfo.uid, true); r.getStack().setLaunchTime(r); if (app != null \u0026\u0026 app.thread != null) { try { if ((r.info.flags\u0026ActivityInfo.FLAG_MULTIPROCESS) == 0 || !\"android\".equals(r.info.packageName)) { // Don't add this if it is a platform component that is marked // to run in multiple processes, because this is actually // part of the framework so doesn't make sense to track as a // separate apk in the process. app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode, mService.mProcessStats); } realStartActivityLocked(r, app, andResume, checkConfig); return; } catch (RemoteException e) { Slog.w(TAG, \"Exception when starting activity \" + r.intent.getComponent().flattenToShortString(), e); } // If a dead object exception was thrown -- fall through to // restart the application. } mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0, \"activity\", r.intent.getComponent(), false, false, true); } 接着调用AMS的启动进程方法startProcessLocked()： ActivityManagerService.java\nfinal ProcessRecord startProcessLocked(String processName, ApplicationInfo info, boolean knownToBeDead, int intentFlags, String hostingType, ComponentName hostingName, boolean allowWhileBooting, boolean isolated, boolean keepIfLarge) { return startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingType, hostingName, allowWhileBooting, isolated, 0 /* isolatedUid */, keepIfLarge, null /* ABI override */, null /* entryPoint */, null /* entryPointArgs */, null /* crashHandler */); } final ProcessRecord startProcessLocked(String processName, ApplicationInfo info, boolean knownToBeDead, int intentFlags, String hostingType, ComponentName hostingName, boolean allowWhileBooting, boolean isolated, int isolatedUid, boolean keepIfLarge, String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler) { long startTime = SystemClock.elapsedRealtime(); ProcessRecord app; if (!isolated) { app = getProcessRecordLocked(processName, info.uid, keepIfLarge); checkTime(startTime, \"startProcess: after getProcessRecord\"); if ((intentFlags \u0026 Intent.FLAG_FROM_BACKGROUND) != 0) { // If we are in the background, then check to see if this process // is bad. If so, we will just silently fail. if (mAppErrors.isBadProcessLocked(info)) { if (DEBUG_PROCESSES) Slog.v(TAG, \"Bad process: \" + info.uid + \"/\" + info.processName); return null; } } else { // When the user is explicitly starting a process, then clear its // crash count so that we won't make it bad until they see at // least one crash dialog again, and make the process good again // if it had been bad. if (DEBUG_PROCESSES) Slog.v(TAG, \"Clearing bad process: \" + info.uid + \"/\" + info.processName); mAppErrors.resetProcessCrashTimeLocked(info); if (mAppErrors.isBadProcessLocked(info)) { EventLog.writeEvent(EventLogTags.AM_PROC_GOOD, UserHandle.getUserId(info.uid), info.uid, info.processName); mAppErrors.clearBadProcessLocked(info); if (app != null) { app.bad = false; } } } } else { // If this is an isolated process, it can't re-use an existing process. app = null; } // We don't have to do anything more if: // (1) There is an existing application record; and // (2) The caller doesn't think it is dead, OR there is no thread // object attached to it so we know it couldn't have crashed; and // (3) There is a pid assigned to it, so it is either starting or // already running. if (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES, \"startProcess: name=\" + processName + \" app=\" + app + \" knownToBeDead=\" + knownToBeDead + \" thread=\" + (app != null ? app.thread : null) + \" pid=\" + (app != null ? app.pid : -1)); if (app != null \u0026\u0026 app.pid \u003e 0) { if ((!knownToBeDead \u0026\u0026 !app.killed) || app.thread == null) { // We already have the app running, or are waiting for it to // come up (we have a pid but not yet its thread), so keep it. if (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES, \"App already running: \" + app); // If this is a new package in the process, add the package to the list app.addPackage(info.packageName, info.versionCode, mProcessStats); checkTime(startTime, \"startProcess: done, added package to proc\"); return app; } // An application record is attached to a previous process, // clean it up now. if (DEBUG_PROCESSES || DEBUG_CLEANUP) Slog.v(TAG_PROCESSES, \"App died: \" + app); checkTime(startTime, \"startProcess: bad proc running, killing\"); killProcessGroup(app.uid, app.pid); handleAppDiedLocked(app, true, true); checkTime(startTime, \"startProcess: done killing old proc\"); } String hostingNameStr = hostingName != null ? hostingName.flattenToShortString() : null; if (app == null) { checkTime(startTime, \"startProcess: creating new process record\"); app = newProcessRecordLocked(info, processName, isolated, isolatedUid); if (app == null) { Slog.w(TAG, \"Failed making new process record for \" + processName + \"/\" + info.uid + \" isolated=\" + isolated); return null; } app.crashHandler = crashHandler; checkTime(startTime, \"startProcess: done creating new process record\"); } else { // If this is a new package in the process, add the package to the list app.addPackage(info.packageName, info.versionCode, mProcessStats); checkTime(startTime, \"startProcess: added package to existing proc\"); } // If the system is not ready yet, then hold off on starting this // process until it is. if (!mProcessesReady \u0026\u0026 !isAllowedWhileBooting(info) \u0026\u0026 !allowWhileBooting) { if (!mProcessesOnHold.contains(app)) { mProcessesOnHold.add(app); } if (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES, \"System not ready, putting on hold: \" + app); checkTime(startTime, \"startProcess: returning with proc on hold\"); return app; } checkTime(startTime, \"startProcess: stepping in to startProcess\"); startProcessLocked( app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs); checkTime(startTime, \"startProcess: done starting proc!\"); return (app.pid != 0) ? app : null; } boolean isAllowedWhileBooting(ApplicationInfo ai) { return (ai.flags\u0026ApplicationInfo.FLAG_PERSISTENT) != 0; } private final void startProcessLocked(ProcessRecord app, String hostingType, String hostingNameStr) { startProcessLocked(app, hostingType, hostingNameStr, null /* abiOverride */, null /* entryPoint */, null /* entryPointArgs */); } private final void startProcessLocked(ProcessRecord app, String hostingType, String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs) { startProcessLocked(app, hostingType, hostingNameStr, false /* disableHiddenApiChecks */, null /* abiOverride */, null /* entryPoint */, null /* entryPointArgs */); } private final void startProcessLocked(ProcessRecord app, String hostingType, String hostingNameStr, boolean disableHiddenApiChecks, String abiOverride, String entryPoint, String[] entryPointArgs) { long startTime = SystemClock.elapsedRealtime(); if (app.pid \u003e 0 \u0026\u0026 app.pid != MY_PID) { checkTime(startTime, \"startProcess: removing from pids map\"); synchronized (mPidsSelfLocked) { mPidsSelfLocked.remove(app.pid); mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app); } checkTime(startTime, \"startProcess: done removing from pids map\"); app.setPid(0); } if (DEBUG_PROCESSES \u0026\u0026 mProcessesOnHold.contains(app)) Slog.v(TAG_PROCESSES, \"startProcessLocked removing on hold: \" + app); mProcessesOnHold.remove(app); checkTime(startTime, \"startProcess: starting to update cpu stats\"); updateCpuStats(); checkTime(startTime, \"startProcess: done updating cpu stats\"); try { try { final int userId = UserHandle.getUserId(app.uid); AppGlobals.getPackageManager().checkPackageStartable(app.info.packageName, userId); } catch (RemoteException e) { throw e.rethrowAsRuntimeException(); } int uid = app.uid; int[] gids = null; int mountExternal = Zygote.MOUNT_EXTERNAL_NONE; if (!app.isolated) { int[] permGids = null; try { checkTime(startTime, \"startProcess: getting gids from package manager\"); final IPackageManager pm = AppGlobals.getPackageManager(); permGids = pm.getPackageGids(app.info.packageName, MATCH_DEBUG_TRIAGED_MISSING, app.userId); StorageManagerInternal storageManagerInternal = LocalServices.getService( StorageManagerInternal.class); mountExternal = storageManagerInternal.getExternalStorageMountMode(uid, app.info.packageName); } catch (RemoteException e) { throw e.rethrowAsRuntimeException(); } /* * Add shared application and profile GIDs so applications can share some * resources like shared libraries and access user-wide resources */ if (ArrayUtils.isEmpty(permGids)) { gids = new int[3]; } else { gids = new int[permGids.length + 3]; System.arraycopy(permGids, 0, gids, 3, permGids.length); } gids[0] = UserHandle.getSharedAppGid(UserHandle.getAppId(uid)); gids[1] = UserHandle.getCacheAppGid(UserHandle.getAppId(uid)); gids[2] = UserHandle.getUserGid(UserHandle.getUserId(uid)); // Replace any invalid GIDs if (gids[0] == UserHandle.ERR_GID) gids[0] = gids[2]; if (gids[1] == UserHandle.ERR_GID) gids[1] = gids[2]; } checkTime(startTime, \"startProcess: building args\"); if (mFactoryTest != FactoryTest.FACTORY_TEST_OFF) { if (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL \u0026\u0026 mTopComponent != null \u0026\u0026 app.processName.equals(mTopComponent.getPackageName())) { uid = 0; } if (mFactoryTest == FactoryTest.FACTORY_TEST_HIGH_LEVEL \u0026\u0026 (app.info.flags\u0026ApplicationInfo.FLAG_FACTORY_TEST) != 0) { uid = 0; } } int runtimeFlags = 0; if ((app.info.flags \u0026 ApplicationInfo.FLAG_DEBUGGABLE) != 0) { runtimeFlags |= Zygote.DEBUG_ENABLE_JDWP; runtimeFlags |= Zygote.DEBUG_JAVA_DEBUGGABLE; // Also turn on CheckJNI for debuggable apps. It's quite // awkward to turn on otherwise. runtimeFlags |= Zygote.DEBUG_ENABLE_CHECKJNI; } // Run the app in safe mode if its manifest requests so or the // system is booted in safe mode. if ((app.info.flags \u0026 ApplicationInfo.FLAG_VM_SAFE_MODE) != 0 || mSafeMode == true) { runtimeFlags |= Zygote.DEBUG_ENABLE_SAFEMODE; } if (\"1\".equals(SystemProperties.get(\"debug.checkjni\"))) { runtimeFlags |= Zygote.DEBUG_ENABLE_CHECKJNI; } String genDebugInfoProperty = SystemProperties.get(\"debug.generate-debug-info\"); if (\"1\".equals(genDebugInfoProperty) || \"true\".equals(genDebugInfoProperty)) { runtimeFlags |= Zygote.DEBUG_GENERATE_DEBUG_INFO; } String genMiniDebugInfoProperty = SystemProperties.get(\"dalvik.vm.minidebuginfo\"); if (\"1\".equals(genMiniDebugInfoProperty) || \"true\".equals(genMiniDebugInfoProperty)) { runtimeFlags |= Zygote.DEBUG_GENERATE_MINI_DEBUG_INFO; } if (\"1\".equals(SystemProperties.get(\"debug.jni.logging\"))) { runtimeFlags |= Zygote.DEBUG_ENABLE_JNI_LOGGING; } if (\"1\".equals(SystemProperties.get(\"debug.assert\"))) { runtimeFlags |= Zygote.DEBUG_ENABLE_ASSERT; } if (mNativeDebuggingApp != null \u0026\u0026 mNativeDebuggingApp.equals(app.processName)) { // Enable all debug flags required by the native debugger. runtimeFlags |= Zygote.DEBUG_ALWAYS_JIT; // Don't interpret anything runtimeFlags |= Zygote.DEBUG_GENERATE_DEBUG_INFO; // Generate debug info runtimeFlags |= Zygote.DEBUG_NATIVE_DEBUGGABLE; // Disbale optimizations mNativeDebuggingApp = null; } if (app.info.isPrivilegedApp() \u0026\u0026 !SystemProperties.getBoolean(\"pm.dexopt.priv-apps\", true)) { runtimeFlags |= Zygote.DISABLE_VERIFIER; runtimeFlags |= Zygote.ONLY_USE_SYSTEM_OAT_FILES; } if (!app.info.isAllowedToUseHiddenApi() \u0026\u0026 !disableHiddenApiChecks \u0026\u0026 !mHiddenApiBlacklist.isDisabled()) { // This app is not allowed to use undocumented and private APIs, or blacklisting is // enabled. Set up its runtime with the appropriate flag. runtimeFlags |= Zygote.ENABLE_HIDDEN_API_CHECKS; } String invokeWith = null; if ((app.info.flags \u0026 ApplicationInfo.FLAG_DEBUGGABLE) != 0) { // Debuggable apps may include a wrapper script with their library directory. String wrapperFileName = app.info.nativeLibraryDir + \"/wrap.sh\"; StrictMode.ThreadPolicy oldPolicy = StrictMode.allowThreadDiskReads(); try { if (new File(wrapperFileName).exists()) { invokeWith = \"/system/bin/logwrapper \" + wrapperFileName; } } finally { StrictMode.setThreadPolicy(oldPolicy); } } String requiredAbi = (abiOverride != null) ? abiOverride : app.info.primaryCpuAbi; if (requiredAbi == null) { requiredAbi = Build.SUPPORTED_ABIS[0]; } String instructionSet = null; if (app.info.primaryCpuAbi != null) { instructionSet = VMRuntime.getInstructionSet(app.info.primaryCpuAbi); } app.gids = gids; app.requiredAbi = requiredAbi; app.instructionSet = instructionSet; // the per-user SELinux context must be set if (TextUtils.isEmpty(app.info.seInfoUser)) { Slog.wtf(TAG, \"SELinux tag not defined\", new IllegalStateException(\"SELinux tag not defined for \" + app.info.packageName + \" (uid \" + app.uid + \")\")); } final String seInfo = app.info.seInfo + (TextUtils.isEmpty(app.info.seInfoUser) ? \"\" : app.info.seInfoUser); // Start the process. It will either succeed and return a result containing // the PID of the new process, or else throw a RuntimeException. boolean isActivityProcess = (entryPoint == null); if (entryPoint == null) entryPoint = \"android.app.ActivityThread\"; Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"Start proc: \" + app.processName); checkTime(startTime, \"startProcess: asking zygote to start proc\"); ProcessStartResult startResult; if (hostingType.equals(\"webview_service\")) { startResult = startWebView(entryPoint, app.processName, uid, uid, gids, runtimeFlags, mountExternal, app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet, app.info.dataDir, null, entryPointArgs); } else { startResult = Process.start(entryPoint, app.processName, uid, uid, gids, runtimeFlags, mountExternal, app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet, app.info.dataDir, invokeWith, entryPointArgs); } checkTime(startTime, \"startProcess: returned from zygote!\"); Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); mBatteryStatsService.noteProcessStart(app.processName, app.info.uid); checkTime(startTime, \"startProcess: done updating battery stats\"); EventLog.writeEvent(EventLogTags.AM_PROC_START, UserHandle.getUserId(uid), startResult.pid, uid, app.processName, hostingType, hostingNameStr != null ? hostingNameStr : \"\"); try { AppGlobals.getPackageManager().logAppProcessStartIfNeeded(app.processName, app.uid, seInfo, app.info.sourceDir, startResult.pid); } catch (RemoteException ex) { // Ignore } if (app.persistent) { Watchdog.getInstance().processStarted(app.processName, startResult.pid); } checkTime(startTime, \"startProcess: building log message\"); StringBuilder buf = mStringBuilder; buf.setLength(0); buf.append(\"Start proc \"); buf.append(startResult.pid); buf.append(':'); buf.append(app.processName); buf.append('/'); UserHandle.formatUid(buf, uid); if (!isActivityProcess) { buf.append(\" [\"); buf.append(entryPoint); buf.append(\"]\"); } buf.append(\" for \"); buf.append(hostingType); if (hostingNameStr != null) { buf.append(\" \"); buf.append(hostingNameStr); } Slog.i(TAG, buf.toString()); app.setPid(startResult.pid); app.usingWrapper = startResult.usingWrapper; app.removed = false; app.killed = false; app.killedByAm = false; checkTime(startTime, \"startProcess: starting to update pids map\"); ProcessRecord oldApp; synchronized (mPidsSelfLocked) { oldApp = mPidsSelfLocked.get(startResult.pid); } // If there is already an app occupying that pid that hasn't been cleaned up if (oldApp != null \u0026\u0026 !app.isolated) { // Clean up anything relating to this pid first Slog.w(TAG, \"Reusing pid \" + startResult.pid + \" while app is still mapped to it\"); cleanUpApplicationRecordLocked(oldApp, false, false, -1, true /*replacingPid*/); } synchronized (mPidsSelfLocked) { this.mPidsSelfLocked.put(startResult.pid, app); if (isActivityProcess) { Message msg = mHandler.obtainMessage(PROC_START_TIMEOUT_MSG); msg.obj = app; mHandler.sendMessageDelayed(msg, startResult.usingWrapper ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT); } } checkTime(startTime, \"startProcess: done updating pids map\"); } catch (RuntimeException e) { Slog.e(TAG, \"Failure starting process \" + app.processName, e); // Something went very wrong while trying to start this process; one // common case is when the package is frozen due to an active // upgrade. To recover, clean up any active bookkeeping related to // starting this process. (We already invoked this method once when // the package was initially frozen through KILL_APPLICATION_MSG, so // it doesn't hurt to use it again.) forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid), false, false, true, false, false, UserHandle.getUserId(app.userId), \"start failure\"); } } 新的应用启动的入口是主线程ActivityThread的main方法，这里可以看到使用Lopper为主线程启动了消息循环，然后调用attach()方法: ActivityThread.java\npublic static void main(String[] args) { Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"ActivityThreadMain\"); // CloseGuard defaults to true and can be quite spammy. We // disable it here, but selectively enable it later (via // StrictMode) on debug builds, but using DropBox, not logs. CloseGuard.setEnabled(false); Environment.initForCurrentUser(); // Set the reporter for event logging in libcore EventLogger.setReporter(new EventLoggingReporter()); // Make sure TrustedCertificateStore looks in the right place for CA certificates final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId()); TrustedCertificateStore.setDefaultUserDirectory(configDir); Process.setArgV0(\"\"); Looper.prepareMainLooper(); ActivityThread thread = new ActivityThread(); thread.attach(false); if (sMainThreadHandler == null) { sMainThreadHandler = thread.getHandler(); } if (false) { Looper.myLooper().setMessageLogging(new LogPrinter(Log.DEBUG, \"ActivityThread\")); } // End of event ActivityThreadMain. Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); Looper.loop(); throw new RuntimeException(\"Main thread loop unexpectedly exited\"); } private void attach(boolean system) { sCurrentActivityThread = this; mSystemThread = system; if (!system) { ViewRootImpl.addFirstDrawHandler(new Runnable() { @Override public void run() { ensureJitEnabled(); } }); android.ddm.DdmHandleAppName.setAppName(\"\", UserHandle.myUserId()); RuntimeInit.setApplicationObject(mAppThread.asBinder()); final IActivityManager mgr = ActivityManager.getService(); try { mgr.attachApplication(mAppThread); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } // Watch for getting close to heap limit. BinderInternal.addGcWatcher(new Runnable() { @Override public void run() { if (!mSomeActivitiesChanged) { return; } Runtime runtime = Runtime.getRuntime(); long dalvikMax = runtime.maxMemory(); long dalvikUsed = runtime.totalMemory() - runtime.freeMemory(); if (dalvikUsed \u003e ((3*dalvikMax)/4)) { if (DEBUG_MEMORY_TRIM) Slog.d(TAG, \"Dalvik max=\" + (dalvikMax/1024) + \" total=\" + (runtime.totalMemory()/1024) + \" used=\" + (dalvikUsed/1024)); mSomeActivitiesChanged = false; try { mgr.releaseSomeActivities(mAppThread); } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } } }); } else { // Don't set application object here -- if the system crashes, // we can't display an alert, we just want to die die die. android.ddm.DdmHandleAppName.setAppName(\"system_process\", UserHandle.myUserId()); try { mInstrumentation = new Instrumentation(); ContextImpl context = ContextImpl.createAppContext( this, getSystemContext().mLoadedApk); mInitialApplication = context.mLoadedApk.makeApplication(true, null); mInitialApplication.onCreate(); } catch (Exception e) { throw new RuntimeException( \"Unable to instantiate Application():\" + e.toString(), e); } } // add dropbox logging to libcore DropBox.setReporter(new DropBoxReporter()); ViewRootImpl.ConfigChangedCallback configChangedCallback = (Configuration globalConfig) -\u003e { synchronized (mResourcesManager) { // We need to apply this change to the resources immediately, because upon returning // the view hierarchy will be informed about it. if (mResourcesManager.applyConfigurationToResourcesLocked(globalConfig, null /* compat */)) { updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(), mResourcesManager.getConfiguration().getLocales()); // This actually changed the resources! Tell everyone about it. if (mPendingConfiguration == null || mPendingConfiguration.isOtherSeqNewer(globalConfig)) { mPendingConfiguration = globalConfig; sendMessage(H.CONFIGURATION_CHANGED, globalConfig); } } } }; ViewRootImpl.addConfigCallback(configChangedCallback); } 这里获取AMS代理，然后调用AMS的attachApplication()，并将主线程的ApplicationThread对象传入，以进行IPC通信。 ActivityManagerService.java\n@Override public final void attachApplication(IApplicationThread thread) { synchronized (this) { int callingPid = Binder.getCallingPid(); final long origId = Binder.clearCallingIdentity(); attachApplicationLocked(thread, callingPid); Binder.restoreCallingIdentity(origId); } } private final boolean attachApplicationLocked(IApplicationThread thread, int pid) { // Find the application record that is being attached... either via // the pid if we are running in multiple processes, or just pull the // next app record if we are emulating process with anonymous threads. ProcessRecord app; long startTime = SystemClock.uptimeMillis(); if (pid != MY_PID \u0026\u0026 pid \u003e= 0) { synchronized (mPidsSelfLocked) { app = mPidsSelfLocked.get(pid); } } else { app = null; } if (app == null) { Slog.w(TAG, \"No pending application record for pid \" + pid + \" (IApplicationThread \" + thread + \"); dropping process\"); EventLog.writeEvent(EventLogTags.AM_DROP_PROCESS, pid); if (pid \u003e 0 \u0026\u0026 pid != MY_PID) { killProcessQuiet(pid); //TODO: killProcessGroup(app.info.uid, pid); } else { try { thread.scheduleExit(); } catch (Exception e) { // Ignore exceptions. } } return false; } // If this application record is still attached to a previous // process, clean it up now. if (app.thread != null) { handleAppDiedLocked(app, true, true); } // Tell the process all about itself. if (DEBUG_ALL) Slog.v( TAG, \"Binding process pid \" + pid + \" to record \" + app); final String processName = app.processName; try { AppDeathRecipient adr = new AppDeathRecipient( app, pid, thread); thread.asBinder().linkToDeath(adr, 0); app.deathRecipient = adr; } catch (RemoteException e) { app.resetPackageList(mProcessStats); startProcessLocked(app, \"link fail\", processName); return false; } EventLog.writeEvent(EventLogTags.AM_PROC_BOUND, app.userId, app.pid, app.processName); app.makeActive(thread, mProcessStats); app.curAdj = app.setAdj = app.verifiedAdj = ProcessList.INVALID_ADJ; app.curSchedGroup = app.setSchedGroup = ProcessList.SCHED_GROUP_DEFAULT; app.forcingToImportant = null; updateProcessForegroundLocked(app, false, false); app.hasShownUi = false; app.debugging = false; app.cached = false; app.killedByAm = false; app.killed = false; // We carefully use the same state that PackageManager uses for // filtering, since we use this flag to decide if we need to install // providers when user is unlocked later app.unlocked = StorageManager.isUserKeyUnlocked(app.userId); mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app); boolean normalMode = mProcessesReady || isAllowedWhileBooting(app.info); List\u003cProviderInfo\u003e providers = normalMode ? generateApplicationProvidersLocked(app) : null; if (providers != null \u0026\u0026 checkAppInLaunchingProvidersLocked(app)) { Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG); msg.obj = app; mHandler.sendMessageDelayed(msg, CONTENT_PROVIDER_PUBLISH_TIMEOUT); } checkTime(startTime, \"attachApplicationLocked: before bindApplication\"); if (!normalMode) { Slog.i(TAG, \"Launching preboot mode app: \" + app); } if (DEBUG_ALL) Slog.v( TAG, \"New app record \" + app + \" thread=\" + thread.asBinder() + \" pid=\" + pid); try { int testMode = ApplicationThreadConstants.DEBUG_OFF; if (mDebugApp != null \u0026\u0026 mDebugApp.equals(processName)) { testMode = mWaitForDebugger ? ApplicationThreadConstants.DEBUG_WAIT : ApplicationThreadConstants.DEBUG_ON; app.debugging = true; if (mDebugTransient) { mDebugApp = mOrigDebugApp; mWaitForDebugger = mOrigWaitForDebugger; } } boolean enableTrackAllocation = false; if (mTrackAllocationApp != null \u0026\u0026 mTrackAllocationApp.equals(processName)) { enableTrackAllocation = true; mTrackAllocationApp = null; } // If the app is being launched for restore or full backup, set it up specially boolean isRestrictedBackupMode = false; if (mBackupTarget != null \u0026\u0026 mBackupAppName.equals(processName)) { isRestrictedBackupMode = mBackupTarget.appInfo.uid \u003e= FIRST_APPLICATION_UID \u0026\u0026 ((mBackupTarget.backupMode == BackupRecord.RESTORE) || (mBackupTarget.backupMode == BackupRecord.RESTORE_FULL) || (mBackupTarget.backupMode == BackupRecord.BACKUP_FULL)); } if (app.instr != null) { notifyPackageUse(app.instr.mClass.getPackageName(), PackageManager.NOTIFY_PACKAGE_USE_INSTRUMENTATION); } if (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, \"Binding proc \" + processName + \" with config \" + getGlobalConfiguration()); ApplicationInfo appInfo = app.instr != null ? app.instr.mTargetInfo : app.info; app.compat = compatibilityInfoForPackageLocked(appInfo); ProfilerInfo profilerInfo = null; String preBindAgent = null; if (mProfileApp != null \u0026\u0026 mProfileApp.equals(processName)) { mProfileProc = app; if (mProfilerInfo != null) { // Send a profiler info object to the app if either a file is given, or // an agent should be loaded at bind-time. boolean needsInfo = mProfilerInfo.profileFile != null || mProfilerInfo.attachAgentDuringBind; profilerInfo = needsInfo ? new ProfilerInfo(mProfilerInfo) : null; if (mProfilerInfo.agent != null) { preBindAgent = mProfilerInfo.agent; } } } else if (app.instr != null \u0026\u0026 app.instr.mProfileFile != null) { profilerInfo = new ProfilerInfo(app.instr.mProfileFile, null, 0, false, false, null, false); } if (mAppAgentMap != null \u0026\u0026 mAppAgentMap.containsKey(processName)) { // We need to do a debuggable check here. See setAgentApp for why the check is // postponed to here. if ((app.info.flags \u0026 ApplicationInfo.FLAG_DEBUGGABLE) != 0) { String agent = mAppAgentMap.get(processName); // Do not overwrite already requested agent. if (profilerInfo == null) { profilerInfo = new ProfilerInfo(null, null, 0, false, false, mAppAgentMap.get(processName), true); } else if (profilerInfo.agent == null) { profilerInfo = profilerInfo.setAgent(mAppAgentMap.get(processName), true); } } } if (profilerInfo != null \u0026\u0026 profilerInfo.profileFd != null) { profilerInfo.profileFd = profilerInfo.profileFd.dup(); } // We deprecated Build.SERIAL and it is not accessible to // apps that target the v2 security sandbox. Since access to // the serial is now behind a permission we push down the value. String buildSerial = appInfo.targetSandboxVersion \u003c 2 ? sTheRealBuildSerial : Build.UNKNOWN; // Check if this is a secondary process that should be incorporated into some // currently active instrumentation. (Note we do this AFTER all of the profiling // stuff above because profiling can currently happen only in the primary // instrumentation process.) if (mActiveInstrumentation.size() \u003e 0 \u0026\u0026 app.instr == null) { for (int i = mActiveInstrumentation.size() - 1; i \u003e= 0 \u0026\u0026 app.instr == null; i--) { ActiveInstrumentation aInstr = mActiveInstrumentation.get(i); if (!aInstr.mFinished \u0026\u0026 aInstr.mTargetInfo.uid == app.uid) { if (aInstr.mTargetProcesses.length == 0) { // This is the wildcard mode, where every process brought up for // the target instrumentation should be included. if (aInstr.mTargetInfo.packageName.equals(app.info.packageName)) { app.instr = aInstr; aInstr.mRunningProcesses.add(app); } } else { for (String proc : aInstr.mTargetProcesses) { if (proc.equals(app.processName)) { app.instr = aInstr; aInstr.mRunningProcesses.add(app); break; } } } } } } // If we were asked to attach an agent on startup, do so now, before we're binding // application code. if (preBindAgent != null) { thread.attachAgent(preBindAgent); } checkTime(startTime, \"attachApplicationLocked: immediately before bindApplication\"); mStackSupervisor.mActivityMetricsLogger.notifyBindApplication(app); if (app.instr != null) { thread.bindApplication(processName, appInfo, providers, app.instr.mClass, profilerInfo, app.instr.mArguments, app.instr.mWatcher, app.instr.mUiAutomationConnection, testMode, mBinderTransactionTrackingEnabled, enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.persistent, new Configuration(getGlobalConfiguration()), app.compat, getCommonServicesLocked(app.isolated), mCoreSettingsObserver.getCoreSettingsLocked(), buildSerial); } else { thread.bindApplication(processName, appInfo, providers, null, profilerInfo, null, null, null, testMode, mBinderTransactionTrackingEnabled, enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.persistent, new Configuration(getGlobalConfiguration()), app.compat, getCommonServicesLocked(app.isolated), mCoreSettingsObserver.getCoreSettingsLocked(), buildSerial); } checkTime(startTime, \"attachApplicationLocked: immediately after bindApplication\"); updateLruProcessLocked(app, false, null); checkTime(startTime, \"attachApplicationLocked: after updateLruProcessLocked\"); app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis(); } catch (Exception e) { // todo: Yikes! What should we do? For now we will try to // start another process, but that could easily get us in // an infinite loop of restarting processes... Slog.wtf(TAG, \"Exception thrown during bind of \" + app, e); app.resetPackageList(mProcessStats); app.unlinkDeathRecipient(); startProcessLocked(app, \"bind fail\", processName); return false; } // Remove this record from the list of starting applications. mPersistentStartingProcesses.remove(app); if (DEBUG_PROCESSES \u0026\u0026 mProcessesOnHold.contains(app)) Slog.v(TAG_PROCESSES, \"Attach application locked removing on hold: \" + app); mProcessesOnHold.remove(app); boolean badApp = false; boolean didSomething = false; // See if the top visible activity is waiting to run in this process... if (normalMode) { try { if (mStackSupervisor.attachApplicationLocked(app)) { didSomething = true; } } catch (Exception e) { Slog.wtf(TAG, \"Exception thrown launching activities in \" + app, e); badApp = true; } } // Find any services that should be running in this process... if (!badApp) { try { didSomething |= mServices.attachApplicationLocked(app, processName); checkTime(startTime, \"attachApplicationLocked: after mServices.attachApplicationLocked\"); } catch (Exception e) { Slog.wtf(TAG, \"Exception thrown starting services in \" + app, e); badApp = true; } } // Check if a next-broadcast receiver is in this process... if (!badApp \u0026\u0026 isPendingBroadcastProcessLocked(pid)) { try { didSomething |= sendPendingBroadcastsLocked(app); checkTime(startTime, \"attachApplicationLocked: after sendPendingBroadcastsLocked\"); } catch (Exception e) { // If the app died trying to launch the receiver we declare it 'bad' Slog.wtf(TAG, \"Exception thrown dispatching broadcasts in \" + app, e); badApp = true; } } // Check whether the next backup agent is in this process... if (!badApp \u0026\u0026 mBackupTarget != null \u0026\u0026 mBackupTarget.app == app) { if (DEBUG_BACKUP) Slog.v(TAG_BACKUP, \"New app is backup target, launching agent for \" + app); notifyPackageUse(mBackupTarget.appInfo.packageName, PackageManager.NOTIFY_PACKAGE_USE_BACKUP); try { thread.scheduleCreateBackupAgent(mBackupTarget.appInfo, compatibilityInfoForPackageLocked(mBackupTarget.appInfo), mBackupTarget.backupMode); } catch (Exception e) { Slog.wtf(TAG, \"Exception thrown creating backup agent in \" + app, e); badApp = true; } } if (badApp) { app.kill(\"error during init\", true); handleAppDiedLocked(app, false, true); return false; } if (!didSomething) { updateOomAdjLocked(); checkTime(startTime, \"attachApplicationLocked: after updateOomAdjLocked\"); } return true; } 继续查看Activity相关调用流程，接着会调用到ActivityStackSupervisor的attachApplicationLocked()方法: ActivityStackSupervisor.java，最终和上述需要启动的activity的进程已存在的情况一样，都会调用到realStartActivityLocked()方法。\nboolean attachApplicationLocked(ProcessRecord app) throws RemoteException { final String processName = app.processName; boolean didSomething = false; for (int displayNdx = mActivityDisplays.size() - 1; displayNdx \u003e= 0; --displayNdx) { ArrayList\u003cActivityStack\u003e stacks = mActivityDisplays.valueAt(displayNdx).mStacks; for (int stackNdx = stacks.size() - 1; stackNdx \u003e= 0; --stackNdx) { final ActivityStack stack = stacks.get(stackNdx); if (!isFocusedStack(stack)) { continue; } stack.getAllRunningVisibleActivitiesLocked(mTmpActivityList); final ActivityRecord top = stack.topRunningActivityLocked(); final int size = mTmpActivityList.size(); for (int i = 0; i \u003c size; i++) { final ActivityRecord activity = mTmpActivityList.get(i); if (activity.app == null \u0026\u0026 app.uid == activity.info.applicationInfo.uid \u0026\u0026 processName.equals(activity.processName)) { try { if (realStartActivityLocked(activity, app, top == activity /* andResume */, true /* checkConfig */)) { didSomething = true; } } catch (RemoteException e) { Slog.w(TAG, \"Exception in new application when starting activity \" + top.intent.getComponent().flattenToShortString(), e); throw e; } } } } } if (!didSomething) { ensureActivitiesVisibleLocked(null, 0, !PRESERVE_WINDOWS); } return didSomething; } final boolean realStartActivityLocked(ActivityRecord r, ProcessRecord app, boolean andResume, boolean checkConfig) throws RemoteException { if (!allPausedActivitiesComplete()) { // While there are activities pausing we skipping starting any new activities until // pauses are complete. NOTE: that we also do this for activities that are starting in // the paused state because they will first be resumed then paused on the client side. if (DEBUG_SWITCH || DEBUG_PAUSE || DEBUG_STATES) Slog.v(TAG_PAUSE, \"realStartActivityLocked: Skipping start of r=\" + r + \" some activities pausing...\"); return false; } final TaskRecord task = r.getTask(); final ActivityStack stack = task.getStack(); beginDeferResume(); try { r.startFreezingScreenLocked(app, 0); // schedule launch ticks to collect information about slow apps. r.startLaunchTickingLocked(); r.app = app; if (mKeyguardController.isKeyguardLocked()) { r.notifyUnknownVisibilityLaunched(); } // Have the window manager re-evaluate the orientation of the screen based on the new // activity order. Note that as a result of this, it can call back into the activity // manager with a new orientation. We don't care about that, because the activity is // not currently running so we are just restarting it anyway. if (checkConfig) { final int displayId = r.getDisplayId(); final Configuration config = mWindowManager.updateOrientationFromAppTokens( getDisplayOverrideConfiguration(displayId), r.mayFreezeScreenLocked(app) ? r.appToken : null, displayId); // Deferring resume here because we're going to launch new activity shortly. // We don't want to perform a redundant launch of the same record while ensuring // configurations and trying to resume top activity of focused stack. mService.updateDisplayOverrideConfigurationLocked(config, r, true /* deferResume */, displayId); } if (r.getStack().checkKeyguardVisibility(r, true /* shouldBeVisible */, true /* isTop */)) { // We only set the visibility to true if the activity is allowed to be visible // based on // keyguard state. This avoids setting this into motion in window manager that is // later cancelled due to later calls to ensure visible activities that set // visibility back to false. r.setVisibility(true); } final int applicationInfoUid = (r.info.applicationInfo != null) ? r.info.applicationInfo.uid : -1; if ((r.userId != app.userId) || (r.appInfo.uid != applicationInfoUid)) { Slog.wtf(TAG, \"User ID for activity changing for \" + r + \" appInfo.uid=\" + r.appInfo.uid + \" info.ai.uid=\" + applicationInfoUid + \" old=\" + r.app + \" new=\" + app); } app.waitingToKill = null; r.launchCount++; r.lastLaunchTime = SystemClock.uptimeMillis(); if (DEBUG_ALL) Slog.v(TAG, \"Launching: \" + r); int idx = app.activities.indexOf(r); if (idx \u003c 0) { app.activities.add(r); } mService.updateLruProcessLocked(app, true, null); mService.updateOomAdjLocked(); if (task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE || task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE_PRIV) { setLockTaskModeLocked(task, LOCK_TASK_MODE_LOCKED, \"mLockTaskAuth==LAUNCHABLE\", false); } try { if (app.thread == null) { throw new RemoteException(); } List\u003cResultInfo\u003e results = null; List\u003cReferrerIntent\u003e newIntents = null; if (andResume) { // We don't need to deliver new intents and/or set results if activity is going // to pause immediately after launch. results = r.results; newIntents = r.newIntents; } if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, \"Launching: \" + r + \" icicle=\" + r.icicle + \" with results=\" + results + \" newIntents=\" + newIntents + \" andResume=\" + andResume); EventLog.writeEvent(EventLogTags.AM_RESTART_ACTIVITY, r.userId, System.identityHashCode(r), task.taskId, r.shortComponentName); if (r.isHomeActivity()) { // Home process is the root process of the task. mService.mHomeProcess = task.mActivities.get(0).app; } mService.notifyPackageUse(r.intent.getComponent().getPackageName(), PackageManager.NOTIFY_PACKAGE_USE_ACTIVITY); r.sleeping = false; r.forceNewConfig = false; mService.showUnsupportedZoomDialogIfNeededLocked(r); mService.showAskCompatModeDialogLocked(r); r.compat = mService.compatibilityInfoForPackageLocked(r.info.applicationInfo); ProfilerInfo profilerInfo = null; if (mService.mProfileApp != null \u0026\u0026 mService.mProfileApp.equals(app.processName)) { if (mService.mProfileProc == null || mService.mProfileProc == app) { mService.mProfileProc = app; ProfilerInfo profilerInfoSvc = mService.mProfilerInfo; if (profilerInfoSvc != null \u0026\u0026 profilerInfoSvc.profileFile != null) { if (profilerInfoSvc.profileFd != null) { try { profilerInfoSvc.profileFd = profilerInfoSvc.profileFd.dup(); } catch (IOException e) { profilerInfoSvc.closeFd(); } } profilerInfo = new ProfilerInfo(profilerInfoSvc); } } } app.hasShownUi = true; app.pendingUiClean = true; app.forceProcessStateUpTo(mService.mTopProcessState); // Because we could be starting an Activity in the system process this may not go // across a Binder interface which would create a new Configuration. Consequently // we have to always create a new Configuration here. final MergedConfiguration mergedConfiguration = new MergedConfiguration( mService.getGlobalConfiguration(), r.getMergedOverrideConfiguration()); r.setLastReportedConfiguration(mergedConfiguration); logIfTransactionTooLarge(r.intent, r.icicle); app.thread.scheduleLaunchActivity(new Intent(r.intent), r.appToken, System.identityHashCode(r), r.info, // TODO: Have this take the merged configuration instead of separate global // and override configs. mergedConfiguration.getGlobalConfiguration(), mergedConfiguration.getOverrideConfiguration(), r.compat, r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results, newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo); if ((app.info.privateFlags \u0026 ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != 0) { // This may be a heavy-weight process! Note that the package // manager will ensure that only activity can run in the main // process of the .apk, which is the only thing that will be // considered heavy-weight. if (app.processName.equals(app.info.packageName)) { if (mService.mHeavyWeightProcess != null \u0026\u0026 mService.mHeavyWeightProcess != app) { Slog.w(TAG, \"Starting new heavy weight process \" + app + \" when already running \" + mService.mHeavyWeightProcess); } mService.mHeavyWeightProcess = app; Message msg = mService.mHandler.obtainMessage( ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG); msg.obj = r; mService.mHandler.sendMessage(msg); } } } catch (RemoteException e) { if (r.launchFailed) { // This is the second time we failed -- finish activity // and give up. Slog.e(TAG, \"Second failure launching \" + r.intent.getComponent().flattenToShortString() + \", giving up\", e); mService.appDiedLocked(app); stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, null, \"2nd-crash\", false); return false; } // This is the first time we failed -- restart process and // retry. r.launchFailed = true; app.activities.remove(r); throw e; } } finally { endDeferResume(); } r.launchFailed = false; if (stack.updateLRUListLocked(r)) { Slog.w(TAG, \"Activity \" + r + \" being launched, but already in LRU list\"); } if (andResume \u0026\u0026 readyToResume()) { // As part of the process of launching, ActivityThread also performs // a resume. stack.minimalResumeActivityLocked(r); } else { // This activity is not starting in the resumed state... which should look like we asked // it to pause+stop (but remain visible), and it has done so and reported back the // current icicle and other state. if (DEBUG_STATES) Slog.v(TAG_STATES, \"Moving to PAUSED: \" + r + \" (starting in paused state)\"); r.state = PAUSED; } // Launch the new version setup screen if needed. We do this -after- // launching the initial activity (that is, home), so that it can have // a chance to initialize itself while in the background, making the // switch back to it faster and look better. if (isFocusedStack(stack)) { mService.startSetupActivityLocked(); } // Update any services we are bound to that might care about whether // their client may have activities. if (r.app != null) { mService.mServices.updateServiceConnectionActivitiesLocked(r.app); } return true; } 如果要启动的activity进程已经存在了，那么使用IApplicationThread对象调用最终回调activity自身的生命周期方法，对于前一个activity，会执行onPause的回调，对于当前启动的activity会执行onResume回调。\nActivityThread#ApplicationThread.java\n// we use token to identify this activity without having to send the // activity itself back to the activity manager. (matters more with ipc) @Override public final void scheduleLaunchActivity(Intent intent, IBinder token, int ident, ActivityInfo info, Configuration curConfig, Configuration overrideConfig, CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor, int procState, Bundle state, PersistableBundle persistentState, List\u003cResultInfo\u003e pendingResults, List\u003cReferrerIntent\u003e pendingNewIntents, boolean notResumed, boolean isForward, ProfilerInfo profilerInfo) { updateProcessState(procState, false); ActivityClientRecord r = new ActivityClientRecord(); r.token = token; r.ident = ident; r.intent = intent; r.referrer = referrer; r.voiceInteractor = voiceInteractor; r.activityInfo = info; r.compatInfo = compatInfo; r.state = state; r.persistentState = persistentState; r.pendingResults = pendingResults; r.pendingIntents = pendingNewIntents; r.startsNotResumed = notResumed; r.isForward = isForward; r.profilerInfo = profilerInfo; r.overrideConfig = overrideConfig; updatePendingConfiguration(curConfig); sendMessage(H.LAUNCH_ACTIVITY, r); } public final void schedulePauseActivity(IBinder token, boolean finished, boolean userLeaving, int configChanges, boolean dontReport) { int seq = getLifecycleSeq(); if (DEBUG_ORDER) Slog.d(TAG, \"pauseActivity \" + ActivityThread.this + \" operation received seq: \" + seq); sendMessage( finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY, token, (userLeaving ? USER_LEAVING : 0) | (dontReport ? DONT_REPORT : 0), configChanges, seq); } public final void scheduleResumeActivity(IBinder token, int processState, boolean isForward, Bundle resumeArgs) { int seq = getLifecycleSeq(); if (DEBUG_ORDER) Slog.d(TAG, \"resumeActivity \" + ActivityThread.this + \" operation received seq: \" + seq); updateProcessState(processState, false); sendMessage(H.RESUME_ACTIVITY, token, isForward ? 1 : 0, 0, seq); } 在消息LAUNCH_ACTIVITY发送出去后，由ActivityThread的Handler进行接收并处理，调用到handleLaunchActivity()方法： ActivityThread.java\nprivate void handleLaunchActivity(ActivityClientRecord r, Intent customIntent, String reason) { // If we are getting ready to gc after going to the background, well // we are back active so skip it. unscheduleGcIdler(); mSomeActivitiesChanged = true; if (r.profilerInfo != null) { mProfiler.setProfiler(r.profilerInfo); mProfiler.startProfiling(); } // Make sure we are running with the most recent config. handleConfigurationChanged(null, null); if (localLOGV) Slog.v( TAG, \"Handling launch of \" + r); // Initialize before creating the activity if (!ThreadedRenderer.sRendererDisabled) { GraphicsEnvironment.earlyInitEGL(); } WindowManagerGlobal.initialize(); Activity a = performLaunchActivity(r, customIntent); if (a != null) { r.createdConfig = new Configuration(mConfiguration); reportSizeConfigurations(r); Bundle oldState = r.state; handleResumeActivity(r.token, false, r.isForward, !r.activity.mFinished \u0026\u0026 !r.startsNotResumed, r.lastProcessedSeq, reason); if (!r.activity.mFinished \u0026\u0026 r.startsNotResumed) { // The activity manager actually wants this one to start out paused, because it // needs to be visible but isn't in the foreground. We accomplish this by going // through the normal startup (because activities expect to go through onResume() // the first time they run, before their window is displayed), and then pausing it. // However, in this case we do -not- need to do the full pause cycle (of freezing // and such) because the activity manager assumes it can just retain the current // state it has. performPauseActivityIfNeeded(r, reason); // We need to keep around the original state, in case we need to be created again. // But we only do this for pre-Honeycomb apps, which always save their state when // pausing, so we can not have them save their state when restarting from a paused // state. For HC and later, we want to (and can) let the state be saved as the // normal part of stopping the activity. if (r.isPreHoneycomb()) { r.state = oldState; } } } else { // If there was an error, for any reason, tell the activity manager to stop us. try { ActivityManager.getService() .finishActivity(r.token, Activity.RESULT_CANCELED, null, Activity.DONT_FINISH_TASK_WITH_ACTIVITY); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } } } private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) { // System.out.println(\"##### [\" + System.currentTimeMillis() + \"] ActivityThread.performLaunchActivity(\" + r + \")\"); ActivityInfo aInfo = r.activityInfo; if (r.loadedApk == null) { r.loadedApk = getLoadedApk(aInfo.applicationInfo, r.compatInfo, Context.CONTEXT_INCLUDE_CODE); } ComponentName component = r.intent.getComponent(); if (component == null) { component = r.intent.resolveActivity( mInitialApplication.getPackageManager()); r.intent.setComponent(component); } if (r.activityInfo.targetActivity != null) { component = new ComponentName(r.activityInfo.packageName, r.activityInfo.targetActivity); } ContextImpl appContext = createBaseContextForActivity(r); Activity activity = null; try { java.lang.ClassLoader cl = appContext.getClassLoader(); activity = mInstrumentation.newActivity( cl, component.getClassName(), r.intent); StrictMode.incrementExpectedActivityCount(activity.getClass()); r.intent.setExtrasClassLoader(cl); r.intent.prepareToEnterProcess(); if (r.state != null) { r.state.setClassLoader(cl); } } catch (Exception e) { if (!mInstrumentation.onException(activity, e)) { throw new RuntimeException( \"Unable to instantiate activity \" + component + \": \" + e.toString(), e); } } try { Application app = r.loadedApk.makeApplication(false, mInstrumentation); if (localLOGV) Slog.v(TAG, \"Performing launch of \" + r); if (localLOGV) Slog.v( TAG, r + \": app=\" + app + \", appName=\" + app.getPackageName() + \", pkg=\" + r.loadedApk.getPackageName() + \", comp=\" + r.intent.getComponent().toShortString() + \", dir=\" + r.loadedApk.getAppDir()); if (activity != null) { CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager()); Configuration config = new Configuration(mCompatConfiguration); if (r.overrideConfig != null) { config.updateFrom(r.overrideConfig); } if (DEBUG_CONFIGURATION) Slog.v(TAG, \"Launching activity \" + r.activityInfo.name + \" with config \" + config); Window window = null; if (r.mPendingRemoveWindow != null \u0026\u0026 r.mPreserveWindow) { window = r.mPendingRemoveWindow; r.mPendingRemoveWindow = null; r.mPendingRemoveWindowManager = null; } appContext.setOuterContext(activity); activity.attach(appContext, this, getInstrumentation(), r.token, r.ident, app, r.intent, r.activityInfo, title, r.parent, r.embeddedID, r.lastNonConfigurationInstances, config, r.referrer, r.voiceInteractor, window, r.configCallback); if (customIntent != null) { activity.mIntent = customIntent; } r.lastNonConfigurationInstances = null; checkAndBlockForNetworkAccess(); activity.mStartedActivity = false; int theme = r.activityInfo.getThemeResource(); if (theme != 0) { activity.setTheme(theme); } activity.mCalled = false; if (r.isPersistable()) { mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState); } else { mInstrumentation.callActivityOnCreate(activity, r.state); } if (!activity.mCalled) { throw new SuperNotCalledException( \"Activity \" + r.intent.getComponent().toShortString() + \" did not call through to super.onCreate()\"); } r.activity = activity; r.stopped = true; if (!r.activity.mFinished) { activity.performStart(); r.stopped = false; } if (!r.activity.mFinished) { if (r.isPersistable()) { if (r.state != null || r.persistentState != null) { mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state, r.persistentState); } } else if (r.state != null) { mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state); } } if (!r.activity.mFinished) { activity.mCalled = false; if (r.isPersistable()) { mInstrumentation.callActivityOnPostCreate(activity, r.state, r.persistentState); } else { mInstrumentation.callActivityOnPostCreate(activity, r.state); } if (!activity.mCalled) { throw new SuperNotCalledException( \"Activity \" + r.intent.getComponent().toShortString() + \" did not call through to super.onPostCreate()\"); } } } r.paused = true; mActivities.put(r.token, r); } catch (SuperNotCalledException e) { throw e; } catch (Exception e) { if (!mInstrumentation.onException(activity, e)) { throw new RuntimeException( \"Unable to start activity \" + component + \": \" + e.toString(), e); } } return activity; } 要启动的activity对象的创建等过程发生在performLaunchActivity()方法中：\n创建Context对象 创建Activity对象 创建Application对象 调用Activity.attach()方法，将Activity与Context及Application相关联。此处会创建Window，其实例时一个PhoneWindow对象。 调用Activity的onCreate(), onStart()生命周期回调。 Activity.java\nfinal void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor, Window window, ActivityConfigCallback activityConfigCallback) { attachBaseContext(context); mFragments.attachHost(null /*parent*/); mWindow = new PhoneWindow(this, window, activityConfigCallback); mWindow.setWindowControllerCallback(this); mWindow.setCallback(this); mWindow.setOnWindowDismissedCallback(this); mWindow.getLayoutInflater().setPrivateFactory(this); if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) { mWindow.setSoftInputMode(info.softInputMode); } if (info.uiOptions != 0) { mWindow.setUiOptions(info.uiOptions); } mUiThread = Thread.currentThread(); mMainThread = aThread; mInstrumentation = instr; mToken = token; mIdent = ident; mApplication = application; mIntent = intent; mReferrer = referrer; mComponent = intent.getComponent(); mActivityInfo = info; mTitle = title; mParent = parent; mEmbeddedID = id; mLastNonConfigurationInstances = lastNonConfigurationInstances; if (voiceInteractor != null) { if (lastNonConfigurationInstances != null) { mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor; } else { mVoiceInteractor = new VoiceInteractor(voiceInteractor, this, this, Looper.myLooper()); } } mWindow.setWindowManager( (WindowManager)context.getSystemService(Context.WINDOW_SERVICE), mToken, mComponent.flattenToString(), (info.flags \u0026 ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0); if (mParent != null) { mWindow.setContainer(mParent.getWindow()); } mWindowManager = mWindow.getWindowManager(); mCurrentConfig = config; mWidow.setColorMode(info.colorMode); } ActivityThread在performLaunchActivity()返回后，接着调用handleResumeActivity(), 这里会先调用performResumeActivity()进行生命周期回调，至此，启动到可见的全部生命周期回调完毕。 ActivityThread.java\nfinal void handleResumeActivity(IBinder token, boolean clearHide, boolean isForward, boolean reallyResume, int seq, String reason) { ActivityClientRecord r = mActivities.get(token); if (!checkAndUpdateLifecycleSeq(seq, r, \"resumeActivity\")) { return; } // If we are getting ready to gc after going to the background, well // we are back active so skip it. unscheduleGcIdler(); mSomeActivitiesChanged = true; // TODO Push resumeArgs into the activity for consideration r = performResumeActivity(token, clearHide, reason); if (r != null) { final Activity a = r.activity; if (localLOGV) Slog.v( TAG, \"Resume \" + r + \" started activity: \" + a.mStartedActivity + \", hideForNow: \" + r.hideForNow + \", finished: \" + a.mFinished); final int forwardBit = isForward ? WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : 0; // If the window hasn't yet been added to the window manager, // and this guy didn't finish itself or start another activity, // then go ahead and add the window. boolean willBeVisible = !a.mStartedActivity; if (!willBeVisible) { try { willBeVisible = ActivityManager.getService().willActivityBeVisible( a.getActivityToken()); } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } if (r.window == null \u0026\u0026 !a.mFinished \u0026\u0026 willBeVisible) { r.window = r.activity.getWindow(); View decor = r.window.getDecorView(); decor.setVisibility(View.INVISIBLE); ViewManager wm = a.getWindowManager(); WindowManager.LayoutParams l = r.window.getAttributes(); a.mDecor = decor; l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION; l.softInputMode |= forwardBit; if (r.mPreserveWindow) { a.mWindowAdded = true; r.mPreserveWindow = false; // Normally the ViewRoot sets up callbacks with the Activity // in addView-\u003eViewRootImpl#setView. If we are instead reusing // the decor view we have to notify the view root that the // callbacks may have changed. ViewRootImpl impl = decor.getViewRootImpl(); if (impl != null) { impl.notifyChildRebuilt(); } } if (a.mVisibleFromClient) { if (!a.mWindowAdded) { a.mWindowAdded = true; wm.addView(decor, l); } else { // The activity will get a callback for this {@link LayoutParams} change // earlier. However, at that time the decor will not be set (this is set // in this method), so no action will be taken. This call ensures the // callback occurs with the decor set. a.onWindowAttributesChanged(l); } } // If the window has already been added, but during resume // we started another activity, then don't yet make the // window visible. } else if (!willBeVisible) { if (localLOGV) Slog.v( TAG, \"Launch \" + r + \" mStartedActivity set\"); r.hideForNow = true; } // Get rid of anything left hanging around. cleanUpPendingRemoveWindows(r, false /* force */); // The window is now visible if it has been added, we are not // simply finishing, and we are not starting another activity. if (!r.activity.mFinished \u0026\u0026 willBeVisible \u0026\u0026 r.activity.mDecor != null \u0026\u0026 !r.hideForNow) { if (r.newConfig != null) { performConfigurationChangedForActivity(r, r.newConfig); if (DEBUG_CONFIGURATION) Slog.v(TAG, \"Resuming activity \" + r.activityInfo.name + \" with newConfig \" + r.activity.mCurrentConfig); r.newConfig = null; } if (localLOGV) Slog.v(TAG, \"Resuming \" + r + \" with isForward=\" + isForward); WindowManager.LayoutParams l = r.window.getAttributes(); if ((l.softInputMode \u0026 WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION) != forwardBit) { l.softInputMode = (l.softInputMode \u0026 (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)) | forwardBit; if (r.activity.mVisibleFromClient) { ViewManager wm = a.getWindowManager(); View decor = r.window.getDecorView(); wm.updateViewLayout(decor, l); } } r.activity.mVisibleFromServer = true; mNumVisibleActivities++; if (r.activity.mVisibleFromClient) { r.activity.makeVisible(); } } if (!r.onlyLocalRequest) { r.nextIdle = mNewActivities; mNewActivities = r; if (localLOGV) Slog.v( TAG, \"Scheduling idle handler for \" + r); Looper.myQueue().addIdleHandler(new Idler()); } r.onlyLocalRequest = false; // Tell the activity manager we have resumed. if (reallyResume) { try { ActivityManager.getService().activityResumed(token); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } } } else { // If an exception was thrown when trying to resume, then // just end this activity. try { ActivityManager.getService() .finishActivity(token, Activity.RESULT_CANCELED, null, Activity.DONT_FINISH_TASK_WITH_ACTIVITY); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } } } public final ActivityClientRecord performResumeActivity(IBinder token, boolean clearHide, String reason) { ActivityClientRecord r = mActivities.get(token); if (localLOGV) Slog.v(TAG, \"Performing resume of \" + r + \" finished=\" + r.activity.mFinished); if (r != null \u0026\u0026 !r.activity.mFinished) { if (clearHide) { r.hideForNow = false; r.activity.mStartedActivity = false; } try { r.activity.onStateNotSaved(); r.activity.mFragments.noteStateNotSaved(); checkAndBlockForNetworkAccess(); if (r.pendingIntents != null) { deliverNewIntents(r, r.pendingIntents); r.pendingIntents = null; } if (r.pendingResults != null) { deliverResults(r, r.pendingResults); r.pendingResults = null; } r.activity.performResume(); synchronized (mResourcesManager) { // If there is a pending local relaunch that was requested when the activity was // paused, it will put the activity into paused state when it finally happens. // Since the activity resumed before being relaunched, we don't want that to // happen, so we need to clear the request to relaunch paused. for (int i = mRelaunchingActivities.size() - 1; i \u003e= 0; i--) { final ActivityClientRecord relaunching = mRelaunchingActivities.get(i); if (relaunching.token == r.token \u0026\u0026 relaunching.onlyLocalRequest \u0026\u0026 relaunching.startsNotResumed) { relaunching.startsNotResumed = false; } } } EventLog.writeEvent(LOG_AM_ON_RESUME_CALLED, UserHandle.myUserId(), r.activity.getComponentName().getClassName(), reason); r.paused = false; r.stopped = false; r.state = null; r.persistentState = null; } catch (Exception e) { if (!mInstrumentation.onException(r.activity, e)) { throw new RuntimeException( \"Unable to resume activity \" + r.intent.getComponent().toShortString() + \": \" + e.toString(), e); } } } return r; } ","wordCount":"15070","inLanguage":"en","datePublished":"2018-03-07T21:10:03+08:00","dateModified":"2018-03-07T21:10:03+08:00","author":{"@type":"Person","name":"LEOY"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://epicmars.github.io/blog/android/framework/2018-03-07-android-launch-activity/"},"publisher":{"@type":"Organization","name":"AndroidPi","logo":{"@type":"ImageObject","url":"https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg"}}}</script></head><body id=top><script>const hasHeaderBg=!1</script><header class=header><div class=nav-container><nav class=nav><div class=logo><a href=/ accesskey=h title="AndroidPi (Alt + H)"><svg width="25" height="24" viewBox="0 0 25 24" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient x1="76.7202373%" y1="41.6070847%" x2="18.306123%" y2="65.5065085%" id="linearGradient-9_1k7ha4jv-1"><stop stop-color="#797beb" offset="0"/><stop stop-color="#373080" offset="100%"/></linearGradient></defs><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="_编组-7" fill="url(#linearGradient-9_1k7ha4jv-1)"><path d="M12.2746711.0C12.5125388.0 12.7434104.12583746 12.8693403.33556656l1.3852293 2.3769298h6.1425827C20.63502 2.71249636 20.8658915 2.83833382 20.9918215 3.04806292l1.7420308 2.97815322C22.8597822 6.23594524 22.8597822 6.5016021 22.7338523 6.7113312L22.6988718 6.76725896C22.6708873 6.80920478 22.6359068 6.8511506 22.5939301 6.88610545L21.2156969 9.24905331l3.050303 5.24322749L24.3429571 14.6041363C24.4339065 14.8138654 24.4548948 15.0795223 24.3919298 15.2682785l-1.6021086 2.7404602C22.6638912 18.2184678 22.4400158 18.3443053 22.195152 18.3443053L19.4176972 18.3582872 16.353402 23.6504515C16.227472 23.8601806 16.0035966 23.9860181 15.7587328 23.9860181L12.2886633 24H12.2396906C12.0158151 23.9860181 11.7989358 23.8601806 11.6869981 23.6644334l-1.490171-2.551704H4.13120166C4.0822289 21.1267113 4.04025225 21.1267113 3.9912795 21.1267113 3.75341183 21.1267113 3.52254028 21.0008739 3.39661034 20.7911448L1.79450165 18.0506845C1.66857171 17.8479464 1.66857171 17.5892805 1.79450165 17.3725604l1.37823324-2.3909117L.0944474553 9.69647539c-.1259299404-.20273813-.1259299404-.46140402.0-.678124089999999L1.80849387 6.02621614c.11193772-.2097291.34280928-.33556656.59466916-.33556656C2.466128 5.67666764 2.51510075 5.69064958 2.56407351 5.70463152H5.40449327L8.44080406.46140402C8.45479628.4194582 8.46179238.38450335 8.48278071.35653947L8.49677292.33556656C8.62270286.12583746 8.84657831.0 9.09144209.0H12.2816672 12.2746711zM9.04246933.72706088 5.74730256 6.41071949H2.3751786L8.93752771 17.6871541H5.59338819l-1.61610091 2.789397H10.5606247l1.6790659 2.8942616 6.5623491-11.3043985 1.6790659 2.8802797L23.7203035 14.9327119 20.4181406 9.24905331l1.6650737-2.8662977L9.00049268 6.39673755 10.6795586 3.51645791 9.04946544.72706088H9.04246933zM16.1435187 9.82930382 12.2187023 16.5755899 8.2938858 9.82930382h7.8496329z" id="_形状"/></g></g></svg></a><div class=logo-switches></div></div><ul id=menu><li><a href=/resources title=Resources><span>Resources</span></a></li><li><a href=/blog/ title=Blog><span>Blog</span></a></li><li><a href=/publication title=Publication><span>Publication</span></a></li><li><a href=/about title=About><span>About</span></a></li></ul></nav></div></header><div class=hero-container><div class=hero><h1 class=post-title>Activity启动流程：总览</h1><div class=post-meta><span title='2018-03-07 21:10:03 +0800 CST'>March 7, 2018</span>&nbsp;·&nbsp;71 min&nbsp;·&nbsp;15070 words&nbsp;·&nbsp;LEOY</div></div></div><main class=main><article class=post-single><div class=post-content><p>网络上已经有许多关于这个主题的文章了，但路只有自己走一遍才会熟悉，源码的分析与理解也是一样的。因此从这篇文章开始我将开始从源码阅读中去理解Android Framework层以及更多系统相关的知识点。从点到线再到面地去掌握Android开发的武艺。</p><h1 id=srccomandroidlauncher3launcherjava>src/com/android/launcher3/Launcher.java<a hidden class=anchor aria-hidden=true href=#srccomandroidlauncher3launcherjava>#</a></h1><p>点击桌面应用Lanucher3的快捷方式:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Launches the intent referred by the clicked shortcut.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param v The view representing the clicked shortcut.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onClick</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Make sure that rogue clicks don&#39;t get through while allapps is launching, or after the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// view has detached (it&#39;s possible for this to happen if the view is removed mid touch).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=na>getWindowToken</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mWorkspace</span><span class=p>.</span><span class=na>isFinishedSwitchingState</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Workspace</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mWorkspace</span><span class=p>.</span><span class=na>isInOverviewMode</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWorkspace</span><span class=p>.</span><span class=na>exitOverviewMode</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>CellLayout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mWorkspace</span><span class=p>.</span><span class=na>isInOverviewMode</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWorkspace</span><span class=p>.</span><span class=na>exitOverviewMode</span><span class=p>(</span><span class=n>mWorkspace</span><span class=p>.</span><span class=na>indexOfChild</span><span class=p>(</span><span class=n>v</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>getTag</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tag</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ShortcutInfo</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Open shortcut</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>ShortcutInfo</span><span class=w> </span><span class=n>shortcut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ShortcutInfo</span><span class=p>)</span><span class=w> </span><span class=n>tag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shortcut</span><span class=p>.</span><span class=na>intent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Check for special shortcuts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>shortcutClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>getClassName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shortcutClass</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>WidgetAdder</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>showAllApps</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>AppsCustomizePagedView</span><span class=p>.</span><span class=na>ContentType</span><span class=p>.</span><span class=na>Widgets</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shortcutClass</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>MemoryDumpActivity</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>MemoryDumpActivity</span><span class=p>.</span><span class=na>startDump</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shortcutClass</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>ToggleWeightWatcher</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>toggleShowWeightWatcher</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Start activities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>v</span><span class=p>.</span><span class=na>getLocationOnScreen</span><span class=p>(</span><span class=n>pos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>intent</span><span class=p>.</span><span class=na>setSourceBounds</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Rect</span><span class=p>(</span><span class=n>pos</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>pos</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span><span class=w> </span><span class=n>pos</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>getHeight</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>success</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>startActivitySafely</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>tag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mStats</span><span class=p>.</span><span class=na>recordLaunch</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>shortcut</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>success</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>BubbleTextView</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWaitingForResume</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>BubbleTextView</span><span class=p>)</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWaitingForResume</span><span class=p>.</span><span class=na>setStayPressed</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tag</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>FolderInfo</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>FolderIcon</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>FolderIcon</span><span class=w> </span><span class=n>fi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>FolderIcon</span><span class=p>)</span><span class=w> </span><span class=n>v</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>handleFolderClick</span><span class=p>(</span><span class=n>fi</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>mAllAppsButton</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isAllAppsVisible</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>showWorkspace</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>onClickAllAppsButton</span><span class=p>(</span><span class=n>v</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>startActivitySafely</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>tag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>success</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>success</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>startActivity</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>tag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ActivityNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Toast</span><span class=p>.</span><span class=na>makeText</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=p>.</span><span class=na>string</span><span class=p>.</span><span class=na>activity_not_found</span><span class=p>,</span><span class=w> </span><span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_SHORT</span><span class=p>).</span><span class=na>show</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Unable to launch. tag=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; intent=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>success</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>startActivity</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>tag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>intent</span><span class=p>.</span><span class=na>addFlags</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=na>FLAG_ACTIVITY_NEW_TASK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Only launch using the new animation if the shortcut has not opted out (this is a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// private contract between launcher and may be ignored in the future).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>useLaunchAnimation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>!</span><span class=n>intent</span><span class=p>.</span><span class=na>hasExtra</span><span class=p>(</span><span class=n>INTENT_EXTRA_IGNORE_LAUNCH_ANIMATION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>useLaunchAnimation</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>opts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityOptions</span><span class=p>.</span><span class=na>makeScaleUpAnimation</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>v</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>(),</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>startActivity</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>opts</span><span class=p>.</span><span class=na>toBundle</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>startActivity</span><span class=p>(</span><span class=n>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>SecurityException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Toast</span><span class=p>.</span><span class=na>makeText</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=p>.</span><span class=na>string</span><span class=p>.</span><span class=na>activity_not_found</span><span class=p>,</span><span class=w> </span><span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_SHORT</span><span class=p>).</span><span class=na>show</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Launcher does not have the permission to launch &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>intent</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;. Make sure to create a MAIN intent-filter for the corresponding activity &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;or use the exported attribute for this activity. &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;tag=&#34;</span><span class=o>+</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; intent=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>上述过程中最终调用到Activity的<code>startActivity</code>方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>options</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>startActivityForResult</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Note we want to go through this call for compatibility with</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// applications that may have overridden the method.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>startActivityForResult</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后调用<code>startActivityForResult</code>方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Launch an activity for which you would like a result when it finished.
</span></span></span><span class=line><span class=cl><span class=cm>     * When this activity exits, your
</span></span></span><span class=line><span class=cl><span class=cm>     * onActivityResult() method will be called with the given requestCode.
</span></span></span><span class=line><span class=cl><span class=cm>     * Using a negative requestCode is the same as calling
</span></span></span><span class=line><span class=cl><span class=cm>     * {@link #startActivity} (the activity is not launched as a sub-activity).
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;Note that this method should only be used with Intent protocols
</span></span></span><span class=line><span class=cl><span class=cm>     * that are defined to return a result.  In other protocols (such as
</span></span></span><span class=line><span class=cl><span class=cm>     * {@link Intent#ACTION_MAIN} or {@link Intent#ACTION_VIEW}), you may
</span></span></span><span class=line><span class=cl><span class=cm>     * not get the result when you expect.  For example, if the activity you
</span></span></span><span class=line><span class=cl><span class=cm>     * are launching uses {@link Intent#FLAG_ACTIVITY_NEW_TASK}, it will not
</span></span></span><span class=line><span class=cl><span class=cm>     * run in your task and thus you will immediately receive a cancel result.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;As a special case, if you call startActivityForResult() with a requestCode
</span></span></span><span class=line><span class=cl><span class=cm>     * &gt;= 0 during the initial onCreate(Bundle savedInstanceState)/onResume() of your
</span></span></span><span class=line><span class=cl><span class=cm>     * activity, then your window will not be displayed until a result is
</span></span></span><span class=line><span class=cl><span class=cm>     * returned back from the started activity.  This is to avoid visible
</span></span></span><span class=line><span class=cl><span class=cm>     * flickering when redirecting to another activity.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;This method throws {@link android.content.ActivityNotFoundException}
</span></span></span><span class=line><span class=cl><span class=cm>     * if there was no Activity found to run the given Intent.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param intent The intent to start.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param requestCode If &gt;= 0, this code will be returned in
</span></span></span><span class=line><span class=cl><span class=cm>     *                    onActivityResult() when the activity exits.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param options Additional options for how the Activity should be started.
</span></span></span><span class=line><span class=cl><span class=cm>     * See {@link android.content.Context#startActivity(Intent, Bundle)}
</span></span></span><span class=line><span class=cl><span class=cm>     * Context.startActivity(Intent, Bundle)} for more details.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws android.content.ActivityNotFoundException
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @see #startActivity
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startActivityForResult</span><span class=p>(</span><span class=nd>@RequiresPermission</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mParent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transferSpringboardActivityOptions</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Instrumentation</span><span class=p>.</span><span class=na>ActivityResult</span><span class=w> </span><span class=n>ar</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>execStartActivity</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>mMainThread</span><span class=p>.</span><span class=na>getApplicationThread</span><span class=p>(),</span><span class=w> </span><span class=n>mToken</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ar</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mMainThread</span><span class=p>.</span><span class=na>sendActivityResult</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mToken</span><span class=p>,</span><span class=w> </span><span class=n>mEmbeddedID</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>ar</span><span class=p>.</span><span class=na>getResultCode</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ar</span><span class=p>.</span><span class=na>getResultData</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestCode</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If this start is requesting a result, we can avoid making</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the activity visible until the result is received.  Setting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// activity hidden during this time, to avoid flickering.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// This can only be done when a result is requested because</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// that guarantees we will get information back when the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// activity is finished, no matter what happens to it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mStartedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cancelInputsAndStartExitTransition</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// TODO Consider clearing/flushing other event sources and events for child windows.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>options</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mParent</span><span class=p>.</span><span class=na>startActivityFromChild</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Note we want to go through this method for compatibility with</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// existing applications that may have overridden it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mParent</span><span class=p>.</span><span class=na>startActivityFromChild</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>其中，参数<code>requestCode</code>为-1也就是不需要在<code>onActivityResult()</code>中返回结果，如果需要，<code>options</code>参数用于展示一个从图标到Activity界面的动画效果。进入代码正文，Activity的mParent参数是已经被弃用的ActivityGroup所遗留下的嵌套Activity问题，现在已改用Fragment。因此该参数一般为<code>null</code>，也就直接进入到类<code>Instrumentation</code>的<code>execStartActivity()</code>方法中:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Execute a startActivity call made by the application.  The default 
</span></span></span><span class=line><span class=cl><span class=cm>     * implementation takes care of updating any active {@link ActivityMonitor}
</span></span></span><span class=line><span class=cl><span class=cm>     * objects and dispatches this call to the system activity manager; you can
</span></span></span><span class=line><span class=cl><span class=cm>     * override this to watch for the application to start an activity, and 
</span></span></span><span class=line><span class=cl><span class=cm>     * modify what happens when it does.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;This method returns an {@link ActivityResult} object, which you can 
</span></span></span><span class=line><span class=cl><span class=cm>     * use when intercepting application calls to avoid performing the start 
</span></span></span><span class=line><span class=cl><span class=cm>     * activity action but still return the result the application is 
</span></span></span><span class=line><span class=cl><span class=cm>     * expecting.  To do this, override this method to catch the call to start 
</span></span></span><span class=line><span class=cl><span class=cm>     * activity so that it returns a new ActivityResult containing the results 
</span></span></span><span class=line><span class=cl><span class=cm>     * you would like the application to see, and don&#39;t call up to the super 
</span></span></span><span class=line><span class=cl><span class=cm>     * class.  Note that an application is only expecting a result if 
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;var&gt;requestCode&lt;/var&gt; is &amp;gt;= 0.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;This method throws {@link android.content.ActivityNotFoundException}
</span></span></span><span class=line><span class=cl><span class=cm>     * if there was no Activity found to run the given Intent.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param who The Context from which the activity is being started.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param contextThread The main thread of the Context from which the activity
</span></span></span><span class=line><span class=cl><span class=cm>     *                      is being started.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param token Internal token identifying to the system who is starting 
</span></span></span><span class=line><span class=cl><span class=cm>     *              the activity; may be null.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param target Which activity is performing the start (and thus receiving 
</span></span></span><span class=line><span class=cl><span class=cm>     *               any result); may be null if this call is not being made
</span></span></span><span class=line><span class=cl><span class=cm>     *               from an activity.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param intent The actual Intent to start.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param requestCode Identifier for this request&#39;s result; less than zero 
</span></span></span><span class=line><span class=cl><span class=cm>     *                    if the caller is not expecting a result.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param options Addition options.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return To force the return of a particular result, return an 
</span></span></span><span class=line><span class=cl><span class=cm>     *         ActivityResult object containing the desired data; otherwise
</span></span></span><span class=line><span class=cl><span class=cm>     *         return null.  The default implementation always returns null.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws android.content.ActivityNotFoundException
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @see Activity#startActivity(Intent)
</span></span></span><span class=line><span class=cl><span class=cm>     * @see Activity#startActivityForResult(Intent, int)
</span></span></span><span class=line><span class=cl><span class=cm>     * @see Activity#startActivityFromChild
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * {@hide}
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ActivityResult</span><span class=w> </span><span class=nf>execStartActivity</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Context</span><span class=w> </span><span class=n>who</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>contextThread</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>whoThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>IApplicationThread</span><span class=p>)</span><span class=w> </span><span class=n>contextThread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Uri</span><span class=w> </span><span class=n>referrer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>target</span><span class=p>.</span><span class=na>onProvideReferrer</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>referrer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>intent</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=na>EXTRA_REFERRER</span><span class=p>,</span><span class=w> </span><span class=n>referrer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mActivityMonitors</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mSync</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActivityMonitors</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=o>=</span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>&lt;</span><span class=n>N</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityMonitor</span><span class=w> </span><span class=n>am</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActivityMonitors</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ActivityResult</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>am</span><span class=p>.</span><span class=na>ignoreMatchingSpecificIntents</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>am</span><span class=p>.</span><span class=na>onStartActivity</span><span class=p>(</span><span class=n>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>am</span><span class=p>.</span><span class=na>mHits</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>am</span><span class=p>.</span><span class=na>match</span><span class=p>(</span><span class=n>who</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>am</span><span class=p>.</span><span class=na>mHits</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>am</span><span class=p>.</span><span class=na>isBlocking</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>return</span><span class=w> </span><span class=n>requestCode</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>am</span><span class=p>.</span><span class=na>getResult</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>intent</span><span class=p>.</span><span class=na>migrateExtraStreamToClipData</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>intent</span><span class=p>.</span><span class=na>prepareToLeaveProcess</span><span class=p>(</span><span class=n>who</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>startActivity</span><span class=p>(</span><span class=n>whoThread</span><span class=p>,</span><span class=w> </span><span class=n>who</span><span class=p>.</span><span class=na>getBasePackageName</span><span class=p>(),</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>intent</span><span class=p>.</span><span class=na>resolveTypeIfNeeded</span><span class=p>(</span><span class=n>who</span><span class=p>.</span><span class=na>getContentResolver</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>target</span><span class=p>.</span><span class=na>mEmbeddedID</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkStartActivityResult</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;Failure from system&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这个方法的用处注释里也说的很清楚了，即：</p><blockquote><p>执行一个由应用发起的startActivity调用。默认实现是更新所有活跃的<code>ActivityMonitor</code>对象，并将该调用分发给系统 activity manager；可以重写该方法来观察activity的启动并修改启动时的行为。</p></blockquote><p>注意，这里说的一个由应用发起的startActivity调用，由于启动Activity都会调用到该方法，如果是从Launcher启动的，那么该应用就是Launcher，当然也可以是其它应用。否则便是Activity所在的应用自身了。这里涉及到谁先与ActivityManager进行通信。</p><p>方法中的<code>contextThread</code>参数是一个IBinder对象，是发起调用应用（简称源应用）主线程<code>ActivityThread</code>的一个<code>ApplicationThread</code>变量，在定义时直接进行实例化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=n>ApplicationThread</span><span class=w> </span><span class=n>mAppThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ApplicationThread</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></div><p>那么这个<code>ApplicationThread</code>又是何方神圣，查找其定义会发现它是<code>ActivityThread</code>的一个私有内部类，也就是说只有<code>ActivityThread</code>可以直接使用该类。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>class</span> <span class=nc>ApplicationThread</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>IApplicationThread</span><span class=p>.</span><span class=na>Stub</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>它继承了<code>IApplicationThread.Stub</code>，看名字就像一个aidl接口生成的类，找到该aidl代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * System private API for communicating with the application.  This is given to
</span></span></span><span class=line><span class=cl><span class=cm> * the activity manager by an application  when it starts up, for the activity
</span></span></span><span class=line><span class=cl><span class=cm> * manager to tell the application about things it needs to do.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * {@hide}
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>oneway</span><span class=w> </span><span class=kd>interface</span> <span class=nc>IApplicationThread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>schedulePauseActivity</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>finished</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>userLeaving</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>configChanges</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>dontReport</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleStopActivity</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>showWindow</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>configChanges</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleWindowVisibility</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>showWindow</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleResumeActivity</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>procState</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isForward</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>resumeArgs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleSendResult</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ResultInfo</span><span class=o>&gt;</span><span class=w> </span><span class=n>results</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleLaunchActivity</span><span class=p>(</span><span class=n>in</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ident</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>curConfig</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>overrideConfig</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>CompatibilityInfo</span><span class=w> </span><span class=n>compatInfo</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>referrer</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>procState</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>state</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>PersistableBundle</span><span class=w> </span><span class=n>persistentState</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ResultInfo</span><span class=o>&gt;</span><span class=w> </span><span class=n>pendingResults</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ReferrerIntent</span><span class=o>&gt;</span><span class=w> </span><span class=n>pendingNewIntents</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>notResumed</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isForward</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleNewIntent</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ReferrerIntent</span><span class=o>&gt;</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>andPause</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleDestroyActivity</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>finished</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>configChanges</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleReceiver</span><span class=p>(</span><span class=n>in</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>CompatibilityInfo</span><span class=w> </span><span class=n>compatInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>resultCode</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>extras</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>sync</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>sendingUser</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>processState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleCreateService</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>ServiceInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>CompatibilityInfo</span><span class=w> </span><span class=n>compatInfo</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>processState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleStopService</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>bindApplication</span><span class=p>(</span><span class=n>in</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>packageName</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>ApplicationInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ProviderInfo</span><span class=o>&gt;</span><span class=w> </span><span class=n>providers</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>ComponentName</span><span class=w> </span><span class=n>testName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>testArguments</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>IInstrumentationWatcher</span><span class=w> </span><span class=n>testWatcher</span><span class=p>,</span><span class=w> </span><span class=n>IUiAutomationConnection</span><span class=w> </span><span class=n>uiAutomationConnection</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>debugMode</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>enableBinderTracking</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>trackAllocation</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>restrictedBackupMode</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>persistent</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>CompatibilityInfo</span><span class=w> </span><span class=n>compatInfo</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Map</span><span class=w> </span><span class=n>services</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>coreSettings</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>buildSerial</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>注释上说：</p><blockquote><p>IApplicationThread用于和应用进行通信，在应用启动时将其传给activity manager，然后activity manager通知应用应该进行的操作。</p></blockquote><p>随后通过调用<code>ActivityManager.getService().startActivity()</code>方法，并将这个<code>IApplicationThread</code>对象作为参数传入，这里开始启动流程进入另一个阶段。</p><p>上面<code>execStartActivity()</code>方法的另一个参数<code>mToken</code>也是一个IBinder对象，在<code>attach()</code>方法中赋值，这里暂不讨论。</p><h3 id=activitymanager启动activity>ActivityManager启动Activity<a hidden class=anchor aria-hidden=true href=#activitymanager启动activity>#</a></h3><p><code>ActivityManager.getService()</code>方法用于获取ActivityManagerService的代理，它是系统服务的一部分，负责管理四大组件的启动、生命周期调度，以及应用进程的管理和调度等工作。</p><p>ActivityManager.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>IActivityManager</span><span class=w> </span><span class=nf>getService</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>IActivityManagerSingleton</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Singleton</span><span class=o>&lt;</span><span class=n>IActivityManager</span><span class=o>&gt;</span><span class=w> </span><span class=n>IActivityManagerSingleton</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=o>&lt;</span><span class=n>IActivityManager</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>protected</span><span class=w> </span><span class=n>IActivityManager</span><span class=w> </span><span class=nf>create</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>getService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>ACTIVITY_SERVICE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=n>IActivityManager</span><span class=w> </span><span class=n>am</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IActivityManager</span><span class=p>.</span><span class=na>Stub</span><span class=p>.</span><span class=na>asInterface</span><span class=p>(</span><span class=n>b</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>am</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>那么，ActivityManagerService是何时注册的，从<code>SystemServer</code>启动的代码中，可以看出：
SystemServer.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startBootstrapServices</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Activity manager runs the show.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>traceBeginAndSlog</span><span class=p>(</span><span class=s>&#34;StartActivityManager&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mActivityManagerService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSystemServiceManager</span><span class=p>.</span><span class=na>startService</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityManagerService</span><span class=p>.</span><span class=na>Lifecycle</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>getService</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mActivityManagerService</span><span class=p>.</span><span class=na>setSystemServiceManager</span><span class=p>(</span><span class=n>mSystemServiceManager</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mActivityManagerService</span><span class=p>.</span><span class=na>setInstaller</span><span class=p>(</span><span class=n>installer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>traceEnd</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Set up the Application instance for the system process and get started.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>traceBeginAndSlog</span><span class=p>(</span><span class=s>&#34;SetSystemProcess&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mActivityManagerService</span><span class=p>.</span><span class=na>setSystemProcess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>traceEnd</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后，<code>mActivityManagerService.setSystemProcess()</code>调用如下，这是它将自身注册到了<code>ServiceManager</code>。
ActivityManagerService.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setSystemProcess</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>addService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>ACTIVITY_SERVICE</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>addService</span><span class=p>(</span><span class=n>ProcessStats</span><span class=p>.</span><span class=na>SERVICE_NAME</span><span class=p>,</span><span class=w> </span><span class=n>mProcessStats</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>addService</span><span class=p>(</span><span class=s>&#34;meminfo&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MemBinder</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>addService</span><span class=p>(</span><span class=s>&#34;gfxinfo&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GraphicsBinder</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>addService</span><span class=p>(</span><span class=s>&#34;dbinfo&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DbBinder</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>MONITOR_CPU_USAGE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>addService</span><span class=p>(</span><span class=s>&#34;cpuinfo&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CpuBinder</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>addService</span><span class=p>(</span><span class=s>&#34;permission&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PermissionController</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>addService</span><span class=p>(</span><span class=s>&#34;processinfo&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ProcessInfoService</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ApplicationInfo</span><span class=w> </span><span class=n>info</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mContext</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>().</span><span class=na>getApplicationInfo</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;android&#34;</span><span class=p>,</span><span class=w> </span><span class=n>STOCK_PM_FLAGS</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>MATCH_SYSTEM_ONLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mSystemThread</span><span class=p>.</span><span class=na>installSystemApplicationInfo</span><span class=p>(</span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>getClass</span><span class=p>().</span><span class=na>getClassLoader</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newProcessRecordLocked</span><span class=p>(</span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=na>processName</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>persistent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MY_PID</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>maxAdj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ProcessList</span><span class=p>.</span><span class=na>SYSTEM_ADJ</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>makeActive</span><span class=p>(</span><span class=n>mSystemThread</span><span class=p>.</span><span class=na>getApplicationThread</span><span class=p>(),</span><span class=w> </span><span class=n>mProcessStats</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mPidsSelfLocked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mPidsSelfLocked</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>pid</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>updateLruProcessLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>updateOomAdjLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>PackageManager</span><span class=p>.</span><span class=na>NameNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;Unable to find android system package&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>因此<code>ServiceManager.getService(Context.ACTIVITY_SERVICE)</code>拿到的是<code>ActivityManagerService</code>，它继承了IActivityManager.Stub，这里也是一个aidl接口，它提供了与activity manager service通信的API，提供的是从应用到activity manager的调用。</p><p>IActivityManager.aidl</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * System private API for talking with the activity manager service.  This
</span></span></span><span class=line><span class=cl><span class=cm> * provides calls from the application back to the activity manager.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * {@hide}
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>interface</span> <span class=nc>IActivityManager</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivity</span><span class=p>(</span><span class=n>in</span><span class=w> </span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>in</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>那么，很显然，<code>ActivityManager.getService().startActivity()</code>会利用Binder作进程间通信。</p><p>ActivityManagerService.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivity</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>bOptions</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取源进程的UserId</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>startActivityAsUser</span><span class=p>(</span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>bOptions</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getCallingUserId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivityAsUser</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>bOptions</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enforceNotIsolatedCaller</span><span class=p>(</span><span class=s>&#34;startActivity&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 检查用户权限</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mUserController</span><span class=p>.</span><span class=na>handleIncomingUser</span><span class=p>(</span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingPid</span><span class=p>(),</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingUid</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>ALLOW_FULL_ONLY</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startActivity&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// TODO: Switch to user app stacks here.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mActivityStarter</span><span class=p>.</span><span class=na>startActivityMayWait</span><span class=p>(</span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>bOptions</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startActivityAsUser&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ActivityStarter.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivityMayWait</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>callingUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>IVoiceInteractionSession</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>IBinder</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>WaitResult</span><span class=w> </span><span class=n>outResult</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Configuration</span><span class=w> </span><span class=n>globalConfig</span><span class=p>,</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>bOptions</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>ignoreTargetSecurity</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>reason</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Refuse possible leaked file descriptors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>intent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>hasFileDescriptors</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;File descriptors passed in Intent&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>mActivityMetricsLogger</span><span class=p>.</span><span class=na>notifyActivityLaunching</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>componentSpecified</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Save a copy in case ephemeral needs it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>ephemeralIntent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=n>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Don&#39;t modify the client&#39;s object!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>intent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=n>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>componentSpecified</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getData</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>Intent</span><span class=p>.</span><span class=na>ACTION_VIEW</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>intent</span><span class=p>.</span><span class=na>getAction</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>getPackageManagerInternalLocked</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>isInstantAppInstallerComponent</span><span class=p>(</span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// intercept intents targeted directly to the ephemeral installer the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ephemeral installer should never be started with a raw URL; instead</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// adjust the intent so it looks like a &#34;normal&#34; instant app launch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>intent</span><span class=p>.</span><span class=na>setComponent</span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=cm>/*component*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>componentSpecified</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ResolveInfo</span><span class=w> </span><span class=n>rInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>resolveIntent</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rInfo</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>UserInfo</span><span class=w> </span><span class=n>userInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>getUserInfo</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>userInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>userInfo</span><span class=p>.</span><span class=na>isManagedProfile</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Special case for managed profiles, if attempting to launch non-cryto aware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// app in a locked managed profile from an unlocked parent allow it to resolve</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// as user will be sent via confirm credentials to unlock the profile.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>UserManager</span><span class=w> </span><span class=n>userManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UserManager</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>mContext</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>profileLockedAndParentUnlockingOrUnlocked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>clearCallingIdentity</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>UserInfo</span><span class=w> </span><span class=n>parent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userManager</span><span class=p>.</span><span class=na>getProfileParent</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>profileLockedAndParentUnlockingOrUnlocked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>parent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>userManager</span><span class=p>.</span><span class=na>isUserUnlockingOrUnlocked</span><span class=p>(</span><span class=n>parent</span><span class=p>.</span><span class=na>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>userManager</span><span class=p>.</span><span class=na>isUserUnlockingOrUnlocked</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Binder</span><span class=p>.</span><span class=na>restoreCallingIdentity</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>profileLockedAndParentUnlockingOrUnlocked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>rInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>resolveIntent</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>PackageManager</span><span class=p>.</span><span class=na>MATCH_DIRECT_BOOT_AWARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>|</span><span class=w> </span><span class=n>PackageManager</span><span class=p>.</span><span class=na>MATCH_DIRECT_BOOT_UNAWARE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Collect information about the target of the Intent.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>aInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>resolveActivity</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>rInfo</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityOptions</span><span class=p>.</span><span class=na>fromBundle</span><span class=p>(</span><span class=n>bOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mService</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>realCallingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingPid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>realCallingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingUid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>callingPid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>callingUid</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>caller</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>realCallingPid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>realCallingUid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>stack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>mFocusedStack</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stack</span><span class=p>.</span><span class=na>mConfigWillChange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>globalConfig</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>getGlobalConfiguration</span><span class=p>().</span><span class=na>diff</span><span class=p>(</span><span class=n>globalConfig</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_CONFIGURATION</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_CONFIGURATION</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;Starting activity when config will change = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>stack</span><span class=p>.</span><span class=na>mConfigWillChange</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>origId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>clearCallingIdentity</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>aInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=n>aInfo</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>privateFlags</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>&amp;</span><span class=w> </span><span class=n>ApplicationInfo</span><span class=p>.</span><span class=na>PRIVATE_FLAG_CANT_SAVE_STATE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// This may be a heavy-weight process!  Check to see if we already</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// have another, different heavy-weight process running.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>aInfo</span><span class=p>.</span><span class=na>processName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>aInfo</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>packageName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>heavy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>mHeavyWeightProcess</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>heavy</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>heavy</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>aInfo</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>uid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>heavy</span><span class=p>.</span><span class=na>processName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>aInfo</span><span class=p>.</span><span class=na>processName</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kt>int</span><span class=w> </span><span class=n>appCallingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callingUid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>caller</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>callerApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>getRecordForAppLocked</span><span class=p>(</span><span class=n>caller</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>callerApp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>appCallingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callerApp</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>uid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Unable to find app for caller &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>caller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; (pid=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>callingPid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;) when starting: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=o>+</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>ActivityOptions</span><span class=p>.</span><span class=na>abort</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>return</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_PERMISSION_DENIED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>IIntentSender</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>getIntentSenderLocked</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>INTENT_SENDER_ACTIVITY</span><span class=p>,</span><span class=w> </span><span class=s>&#34;android&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>appCallingUid</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>intent</span><span class=w> </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>resolvedType</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=n>PendingIntent</span><span class=p>.</span><span class=na>FLAG_CANCEL_CURRENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=o>|</span><span class=w> </span><span class=n>PendingIntent</span><span class=p>.</span><span class=na>FLAG_ONE_SHOT</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Intent</span><span class=w> </span><span class=n>newIntent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestCode</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// Caller is requesting a result.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>newIntent</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=n>HeavyWeightSwitcherActivity</span><span class=p>.</span><span class=na>KEY_HAS_RESULT</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>newIntent</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=n>HeavyWeightSwitcherActivity</span><span class=p>.</span><span class=na>KEY_INTENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>new</span><span class=w> </span><span class=n>IntentSender</span><span class=p>(</span><span class=n>target</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>heavy</span><span class=p>.</span><span class=na>activities</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>hist</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>heavy</span><span class=p>.</span><span class=na>activities</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>newIntent</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=n>HeavyWeightSwitcherActivity</span><span class=p>.</span><span class=na>KEY_CUR_APP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>hist</span><span class=p>.</span><span class=na>packageName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>newIntent</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=n>HeavyWeightSwitcherActivity</span><span class=p>.</span><span class=na>KEY_CUR_TASK</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>hist</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>taskId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>newIntent</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=n>HeavyWeightSwitcherActivity</span><span class=p>.</span><span class=na>KEY_NEW_APP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>aInfo</span><span class=p>.</span><span class=na>packageName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>newIntent</span><span class=p>.</span><span class=na>setFlags</span><span class=p>(</span><span class=n>intent</span><span class=p>.</span><span class=na>getFlags</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>newIntent</span><span class=p>.</span><span class=na>setClassName</span><span class=p>(</span><span class=s>&#34;android&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>HeavyWeightSwitcherActivity</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>intent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newIntent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>resolvedType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>caller</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>callingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingUid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>callingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingPid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>componentSpecified</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>rInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>resolveIntent</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=cm>/*resolvedType*/</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>aInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>rInfo</span><span class=p>.</span><span class=na>activityInfo</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>aInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>aInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>getActivityInfoForUser</span><span class=p>(</span><span class=n>aInfo</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=o>[]</span><span class=w> </span><span class=n>outRecord</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ActivityRecord</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>startActivityLocked</span><span class=p>(</span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>ephemeralIntent</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>aInfo</span><span class=p>,</span><span class=w> </span><span class=n>rInfo</span><span class=p>,</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>callingPid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>callingUid</span><span class=p>,</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>realCallingPid</span><span class=p>,</span><span class=w> </span><span class=n>realCallingUid</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>ignoreTargetSecurity</span><span class=p>,</span><span class=w> </span><span class=n>componentSpecified</span><span class=p>,</span><span class=w> </span><span class=n>outRecord</span><span class=p>,</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>reason</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Binder</span><span class=p>.</span><span class=na>restoreCallingIdentity</span><span class=p>(</span><span class=n>origId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stack</span><span class=p>.</span><span class=na>mConfigWillChange</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If the caller also wants to switch to a new configuration,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// do so now.  This allows a clean switch, as we are waiting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// for the current activity to pause (so we will not destroy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// it), and have not yet started the next activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>enforceCallingPermission</span><span class=p>(</span><span class=n>android</span><span class=p>.</span><span class=na>Manifest</span><span class=p>.</span><span class=na>permission</span><span class=p>.</span><span class=na>CHANGE_CONFIGURATION</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;updateConfiguration()&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stack</span><span class=p>.</span><span class=na>mConfigWillChange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_CONFIGURATION</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_CONFIGURATION</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;Updating to new configuration after starting activity.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>updateConfigurationLocked</span><span class=p>(</span><span class=n>globalConfig</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>outResult</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>outResult</span><span class=p>.</span><span class=na>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_SUCCESS</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>mWaitingActivityLaunched</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>outResult</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mService</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>outResult</span><span class=p>.</span><span class=na>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>START_TASK_TO_FRONT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>outResult</span><span class=p>.</span><span class=na>timeout</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>outResult</span><span class=p>.</span><span class=na>who</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>outResult</span><span class=p>.</span><span class=na>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>START_TASK_TO_FRONT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>START_TASK_TO_FRONT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>START_TASK_TO_FRONT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>outRecord</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ActivityRecord may represent a different activity, but it should not be in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// the resumed state.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>nowVisible</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>RESUMED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>outResult</span><span class=p>.</span><span class=na>timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>outResult</span><span class=p>.</span><span class=na>who</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>realActivity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>outResult</span><span class=p>.</span><span class=na>totalTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>outResult</span><span class=p>.</span><span class=na>thisTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>outResult</span><span class=p>.</span><span class=na>thisTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>waitActivityVisible</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>realActivity</span><span class=p>,</span><span class=w> </span><span class=n>outResult</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Note: the timeout variable is not currently not ever set.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>mService</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>outResult</span><span class=p>.</span><span class=na>timeout</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>outResult</span><span class=p>.</span><span class=na>who</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>mActivityMetricsLogger</span><span class=p>.</span><span class=na>notifyActivityLaunched</span><span class=p>(</span><span class=n>res</span><span class=p>,</span><span class=w> </span><span class=n>outRecord</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivityLocked</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>ephemeralIntent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>aInfo</span><span class=p>,</span><span class=w> </span><span class=n>ResolveInfo</span><span class=w> </span><span class=n>rInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>IVoiceInteractionSession</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>IBinder</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>callingPid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>callingUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>realCallingPid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>realCallingUid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>ignoreTargetSecurity</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>componentSpecified</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityRecord</span><span class=o>[]</span><span class=w> </span><span class=n>outActivity</span><span class=p>,</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>reason</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>reason</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Need to specify a reason.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLastStartReason</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reason</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLastStartActivityTimeMs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLastStartActivityRecord</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLastStartActivityResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>startActivity</span><span class=p>(</span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>ephemeralIntent</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>aInfo</span><span class=p>,</span><span class=w> </span><span class=n>rInfo</span><span class=p>,</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingPid</span><span class=p>,</span><span class=w> </span><span class=n>callingUid</span><span class=p>,</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>realCallingPid</span><span class=p>,</span><span class=w> </span><span class=n>realCallingUid</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>ignoreTargetSecurity</span><span class=p>,</span><span class=w> </span><span class=n>componentSpecified</span><span class=p>,</span><span class=w> </span><span class=n>mLastStartActivityRecord</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>inTask</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>outActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// mLastStartActivityRecord[0] is set in the call to startActivity above.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>outActivity</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mLastStartActivityRecord</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Aborted results are treated as successes externally, but we must track them internally.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mLastStartActivityResult</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>START_ABORTED</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>mLastStartActivityResult</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>START_SUCCESS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** DO NOT call this method directly. Use {@link #startActivityLocked} instead. */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivity</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>ephemeralIntent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>aInfo</span><span class=p>,</span><span class=w> </span><span class=n>ResolveInfo</span><span class=w> </span><span class=n>rInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>IVoiceInteractionSession</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>IBinder</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>callingPid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>callingUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>realCallingPid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>realCallingUid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>ignoreTargetSecurity</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>componentSpecified</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityRecord</span><span class=o>[]</span><span class=w> </span><span class=n>outActivity</span><span class=p>,</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>inTask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_SUCCESS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Pull the optional Ephemeral Installer-only bundle out of the options early.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>verificationBundle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>=</span><span class=w> </span><span class=n>options</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>options</span><span class=p>.</span><span class=na>popAppVerificationBundle</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>callerApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>caller</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获取源进程记录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>callerApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>getRecordForAppLocked</span><span class=p>(</span><span class=n>caller</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>callerApp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callerApp</span><span class=p>.</span><span class=na>pid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callerApp</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>uid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Unable to find app for caller &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>caller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; (pid=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>callingPid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;) when starting: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_PERMISSION_DENIED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>aInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getUserId</span><span class=p>(</span><span class=n>aInfo</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>uid</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_SUCCESS</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;START u&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; {&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>toShortString</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;} from uid &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>callingUid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>sourceRecord</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>resultRecord</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resultTo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sourceRecord</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>isInAnyStackLocked</span><span class=p>(</span><span class=n>resultTo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_RESULTS</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_RESULTS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;Will send result to &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>resultTo</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestCode</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>sourceRecord</span><span class=p>.</span><span class=na>finishing</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>resultRecord</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>launchFlags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getFlags</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>launchFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>Intent</span><span class=p>.</span><span class=na>FLAG_ACTIVITY_FORWARD_RESULT</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>sourceRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Transfer the result target from the source activity to the new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// one being started, including any failures.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestCode</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityOptions</span><span class=p>.</span><span class=na>abort</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_FORWARD_AND_REQUEST_CONFLICT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>resultRecord</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>.</span><span class=na>resultTo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resultRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>resultRecord</span><span class=p>.</span><span class=na>isInStackLocked</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultRecord</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>resultWho</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>.</span><span class=na>resultWho</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>requestCode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>.</span><span class=na>requestCode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sourceRecord</span><span class=p>.</span><span class=na>resultTo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resultRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultRecord</span><span class=p>.</span><span class=na>removeResultsLocked</span><span class=p>(</span><span class=n>sourceRecord</span><span class=p>,</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceRecord</span><span class=p>.</span><span class=na>launchedFromUid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>callingUid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// The new activity is being launched from the same uid as the previous</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// activity in the flow, and asking to forward its result back to the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// previous.  In this case the activity is serving as a trampoline between</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the two, so we also want to update its launchedFromPackage to be the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// same as the previous activity.  Note that this is safe, since we know</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// these two packages come from the same uid; the caller could just as</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// well have supplied that same package name itself.  This specifially</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// deals with the case of an intent picker/chooser being launched in the app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// flow to redirect to an activity picked by the user, where we want the final</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// activity to consider it to have been launched by the previous app activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingPackage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>.</span><span class=na>launchedFromPackage</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_SUCCESS</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// We couldn&#39;t find a class that can handle the given Intent.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// That&#39;s the end of that!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_INTENT_NOT_RESOLVED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_SUCCESS</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>aInfo</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// We couldn&#39;t find the specific class specified in the Intent.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Also the end of the line.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_CLASS_NOT_FOUND</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_SUCCESS</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>sourceRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>voiceSession</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If this activity is being launched as part of a voice session, we need</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// to ensure that it is safe to do so.  If the upcoming activity will also</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// be part of the voice session, we can only launch it if it has explicitly</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// said it supports the VOICE category, or it is a part of the calling app.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>launchFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>FLAG_ACTIVITY_NEW_TASK</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>aInfo</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>uid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>intent</span><span class=p>.</span><span class=na>addCategory</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=na>CATEGORY_VOICE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>AppGlobals</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>().</span><span class=na>activitySupportsIntent</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>(),</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34;Activity being started in current voice task does not support voice: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=o>+</span><span class=w> </span><span class=n>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_NOT_VOICE_COMPATIBLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failure checking voice capabilities&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_NOT_VOICE_COMPATIBLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_SUCCESS</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>voiceSession</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the caller is starting a new voice session, just make sure the target</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// is actually allowing it to run this way.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>AppGlobals</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>().</span><span class=na>activitySupportsIntent</span><span class=p>(</span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34;Activity being started in new voice task does not support: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=n>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_NOT_VOICE_COMPATIBLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failure checking voice capabilities&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_NOT_VOICE_COMPATIBLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>resultStack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resultRecord</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>resultRecord</span><span class=p>.</span><span class=na>getStack</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>START_SUCCESS</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resultRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultStack</span><span class=p>.</span><span class=na>sendActivityResultLocked</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>-</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>resultRecord</span><span class=p>,</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>RESULT_CANCELED</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityOptions</span><span class=p>.</span><span class=na>abort</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>abort</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>checkStartAnyActivityPermission</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>aInfo</span><span class=p>,</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>callingPid</span><span class=p>,</span><span class=w> </span><span class=n>callingUid</span><span class=p>,</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>ignoreTargetSecurity</span><span class=p>,</span><span class=w> </span><span class=n>callerApp</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultRecord</span><span class=p>,</span><span class=w> </span><span class=n>resultStack</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>abort</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=o>!</span><span class=n>mService</span><span class=p>.</span><span class=na>mIntentFirewall</span><span class=p>.</span><span class=na>checkStartActivity</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>callingUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingPid</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>aInfo</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>mController</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// The Intent we give to the watcher has the extra data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// stripped off, since it can contain private information.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Intent</span><span class=w> </span><span class=n>watchIntent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>cloneFilter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>abort</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=o>!</span><span class=n>mService</span><span class=p>.</span><span class=na>mController</span><span class=p>.</span><span class=na>activityStarting</span><span class=p>(</span><span class=n>watchIntent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>aInfo</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>packageName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>mController</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mInterceptor</span><span class=p>.</span><span class=na>setStates</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>realCallingPid</span><span class=p>,</span><span class=w> </span><span class=n>realCallingUid</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>callingPackage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mInterceptor</span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>rInfo</span><span class=p>,</span><span class=w> </span><span class=n>aInfo</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w> </span><span class=n>callingPid</span><span class=p>,</span><span class=w> </span><span class=n>callingUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>intent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInterceptor</span><span class=p>.</span><span class=na>mIntent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>rInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInterceptor</span><span class=p>.</span><span class=na>mRInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>aInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInterceptor</span><span class=p>.</span><span class=na>mAInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>resolvedType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInterceptor</span><span class=p>.</span><span class=na>mResolvedType</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>inTask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInterceptor</span><span class=p>.</span><span class=na>mInTask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>callingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInterceptor</span><span class=p>.</span><span class=na>mCallingPid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>callingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInterceptor</span><span class=p>.</span><span class=na>mCallingUid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInterceptor</span><span class=p>.</span><span class=na>mActivityOptions</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>abort</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resultRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultStack</span><span class=p>.</span><span class=na>sendActivityResultLocked</span><span class=p>(</span><span class=o>-</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>resultRecord</span><span class=p>,</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>RESULT_CANCELED</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// We pretend to the caller that it was really started, but</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// they will just get a cancel result.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityOptions</span><span class=p>.</span><span class=na>abort</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>START_ABORTED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If permissions need a review before any of the app components can run, we</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// launch the review activity and pass a pending intent to start the activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// we are to launching now after the review is completed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>mPermissionReviewRequired</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>aInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>getPackageManagerInternalLocked</span><span class=p>().</span><span class=na>isPermissionsReviewRequired</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>aInfo</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>IIntentSender</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>getIntentSenderLocked</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>INTENT_SENDER_ACTIVITY</span><span class=p>,</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>callingUid</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=o>[]</span><span class=p>{</span><span class=n>intent</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=n>resolvedType</span><span class=p>},</span><span class=w> </span><span class=n>PendingIntent</span><span class=p>.</span><span class=na>FLAG_CANCEL_CURRENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>|</span><span class=w> </span><span class=n>PendingIntent</span><span class=p>.</span><span class=na>FLAG_ONE_SHOT</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getFlags</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Intent</span><span class=w> </span><span class=n>newIntent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=na>ACTION_REVIEW_PERMISSIONS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>newIntent</span><span class=p>.</span><span class=na>setFlags</span><span class=p>(</span><span class=n>flags</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>Intent</span><span class=p>.</span><span class=na>FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>newIntent</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=na>EXTRA_PACKAGE_NAME</span><span class=p>,</span><span class=w> </span><span class=n>aInfo</span><span class=p>.</span><span class=na>packageName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>newIntent</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=na>EXTRA_INTENT</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IntentSender</span><span class=p>(</span><span class=n>target</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resultRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>newIntent</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=na>EXTRA_RESULT_NEEDED</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>intent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newIntent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resolvedType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>realCallingUid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>realCallingPid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>rInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>resolveIntent</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>aInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>resolveActivity</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>rInfo</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kc>null</span><span class=w> </span><span class=cm>/*profilerInfo*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PERMISSIONS_REVIEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;START u&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; {&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>toShortString</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;} from uid &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>callingUid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; on display &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>mFocusedStack</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>?</span><span class=w> </span><span class=n>DEFAULT_DISPLAY</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>mFocusedStack</span><span class=p>.</span><span class=na>mDisplayId</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If we have an ephemeral app, abort the process of launching the resolved intent.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Instead, launch the ephemeral installer. Once the installer is finished, it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// starts either the intent we resolved here [on install error] or the ephemeral</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// app [on install success].</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>rInfo</span><span class=p>.</span><span class=na>auxiliaryInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>intent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createLaunchIntent</span><span class=p>(</span><span class=n>rInfo</span><span class=p>.</span><span class=na>auxiliaryInfo</span><span class=p>,</span><span class=w> </span><span class=n>ephemeralIntent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>verificationBundle</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>resolvedType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>callingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>realCallingUid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>callingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>realCallingPid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>aInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>resolveActivity</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>rInfo</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=cm>/*profilerInfo*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ActivityRecord</span><span class=p>(</span><span class=n>mService</span><span class=p>,</span><span class=w> </span><span class=n>callerApp</span><span class=p>,</span><span class=w> </span><span class=n>callingPid</span><span class=p>,</span><span class=w> </span><span class=n>callingUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>aInfo</span><span class=p>,</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>getGlobalConfiguration</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultRecord</span><span class=p>,</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>componentSpecified</span><span class=p>,</span><span class=w> </span><span class=n>voiceSession</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSupervisor</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>outActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>outActivity</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>appTimeTracker</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>sourceRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the caller didn&#39;t specify an explicit time tracker, we want to continue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// tracking under any it has.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>appTimeTracker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>.</span><span class=na>appTimeTracker</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>stack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>mFocusedStack</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>voiceSession</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>stack</span><span class=p>.</span><span class=na>mResumedActivity</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>stack</span><span class=p>.</span><span class=na>mResumedActivity</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>callingUid</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mService</span><span class=p>.</span><span class=na>checkAppSwitchAllowedLocked</span><span class=p>(</span><span class=n>callingPid</span><span class=p>,</span><span class=w> </span><span class=n>callingUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>realCallingPid</span><span class=p>,</span><span class=w> </span><span class=n>realCallingUid</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Activity start&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>PendingActivityLaunch</span><span class=w> </span><span class=n>pal</span><span class=w> </span><span class=o>=</span><span class=w>  </span><span class=k>new</span><span class=w> </span><span class=n>PendingActivityLaunch</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>sourceRecord</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>stack</span><span class=p>,</span><span class=w> </span><span class=n>callerApp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPendingActivityLaunches</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>pal</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityOptions</span><span class=p>.</span><span class=na>abort</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>START_SWITCHES_CANCELED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>mDidAppSwitch</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// This is the second allowed switch since we stopped switches,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// so now just generally allow switches.  Use case: user presses</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// home (switches disabled, switch to home, mDidAppSwitch now true);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// user taps a home icon (coming from home so allowed, we hit here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// and now allow anyone to switch again).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mService</span><span class=p>.</span><span class=na>mAppSwitchesAllowedTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mService</span><span class=p>.</span><span class=na>mDidAppSwitch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>doPendingActivityLaunchesLocked</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>startActivity</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>,</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w> </span><span class=n>outActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivity</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>IVoiceInteractionSession</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>doResume</span><span class=p>,</span><span class=w> </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityRecord</span><span class=o>[]</span><span class=w> </span><span class=n>outActivity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>START_CANCELED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mService</span><span class=p>.</span><span class=na>mWindowManager</span><span class=p>.</span><span class=na>deferSurfaceLayout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>startActivityUnchecked</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>,</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>doResume</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w> </span><span class=n>outActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If we are not able to proceed, disassociate the activity from the task. Leaving an</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// activity in an incomplete state can lead to issues, such as performing operations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// without a window container.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>isStartResultSuccessful</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>removeActivity</span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mService</span><span class=p>.</span><span class=na>mWindowManager</span><span class=p>.</span><span class=na>continueSurfaceLayout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>postStartActivityProcessing</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>getLastStack</span><span class=p>().</span><span class=na>mStackId</span><span class=p>,</span><span class=w>  </span><span class=n>mSourceRecord</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mTargetStack</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Note: This method should only be called from {@link startActivity}.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivityUnchecked</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>IVoiceInteractionSession</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>doResume</span><span class=p>,</span><span class=w> </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityRecord</span><span class=o>[]</span><span class=w> </span><span class=n>outActivity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setInitialState</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w> </span><span class=n>doResume</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>,</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>voiceInteractor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>computeLaunchingTaskFlags</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>computeSourceStack</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mIntent</span><span class=p>.</span><span class=na>setFlags</span><span class=p>(</span><span class=n>mLaunchFlags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>reusedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getReusableIntentActivity</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>preferredLaunchStackId</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>mOptions</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>mOptions</span><span class=p>.</span><span class=na>getLaunchStackId</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>INVALID_STACK_ID</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>preferredLaunchDisplayId</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>mOptions</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>mOptions</span><span class=p>.</span><span class=na>getLaunchDisplayId</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>DEFAULT_DISPLAY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reusedActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// When the flags NEW_TASK and CLEAR_TASK are set, then the task gets reused but</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// still needs to be a lock task mode violation since the task gets cleared out and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the device would otherwise leave the locked task.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>isLockTaskModeViolation</span><span class=p>(</span><span class=n>reusedActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=n>mLaunchFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=n>FLAG_ACTIVITY_NEW_TASK</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>FLAG_ACTIVITY_CLEAR_TASK</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>==</span><span class=w> </span><span class=p>(</span><span class=n>FLAG_ACTIVITY_NEW_TASK</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>FLAG_ACTIVITY_CLEAR_TASK</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>showLockTaskToast</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startActivityUnchecked: Attempt to violate Lock Task Mode&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>START_RETURN_LOCK_TASK_MODE_VIOLATION</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>setTask</span><span class=p>(</span><span class=n>reusedActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reusedActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>intent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// This task was started because of movement of the activity based on affinity...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Now that we are actually launching it, we can assign the base intent.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>reusedActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>setIntent</span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// This code path leads to delivering a new intent, we want to make sure we schedule it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// as the first operation, in case the activity will be resumed as a result of later</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// operations.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>mLaunchFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>FLAG_ACTIVITY_CLEAR_TOP</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>||</span><span class=w> </span><span class=n>isDocumentLaunchesIntoExisting</span><span class=p>(</span><span class=n>mLaunchFlags</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>||</span><span class=w> </span><span class=n>mLaunchSingleInstance</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mLaunchSingleTask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reusedActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// In this situation we want to remove all activities from the task up to the one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// being started. In most cases this means we are resetting the task to its initial</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// state.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span><span class=p>.</span><span class=na>performClearTaskForReuseLocked</span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mLaunchFlags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// The above code can remove {@code reusedActivity} from the task, leading to the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the {@code ActivityRecord} removing its reference to the {@code TaskRecord}. The</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// task reference is needed in the call below to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// {@link setTargetStackAndMoveToFrontIfNeeded}.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reusedActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>reusedActivity</span><span class=p>.</span><span class=na>setTask</span><span class=p>(</span><span class=n>task</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>top</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>top</span><span class=p>.</span><span class=na>frontOfTask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Activity aliases may mean we use different intents for the top activity,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// so make sure the task now has the identity of the new intent.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>top</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>setIntent</span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>deliverNewIntent</span><span class=p>(</span><span class=n>top</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendPowerHintForLaunchStartIfNeeded</span><span class=p>(</span><span class=kc>false</span><span class=w> </span><span class=cm>/* forceSend */</span><span class=p>,</span><span class=w> </span><span class=n>reusedActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>reusedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>setTargetStackAndMoveToFrontIfNeeded</span><span class=p>(</span><span class=n>reusedActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>outResult</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>outActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>outActivity</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>outActivity</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// When there is a reused activity and the current result is a trampoline activity,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// set the reused activity as the result.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>outResult</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>outResult</span><span class=p>.</span><span class=na>finishing</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>outResult</span><span class=p>.</span><span class=na>noDisplay</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>outActivity</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reusedActivity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>mStartFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>START_FLAG_ONLY_IF_NEEDED</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We don&#39;t need to start a new activity, and the client said not to do anything</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// if that is the case, so this is it!  And for paranoia, make sure we have</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// correctly resumed the top activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resumeTargetStackIfNeeded</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>START_RETURN_INTENT_TO_CALLER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setTaskFromIntentActivity</span><span class=p>(</span><span class=n>reusedActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mAddingToTask</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mReuseTask</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We didn&#39;t do anything...  but it was needed (a.k.a., client don&#39;t use that</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// intent!)  And for paranoia, make sure we have correctly resumed the top activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resumeTargetStackIfNeeded</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>outActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>outActivity</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>outActivity</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reusedActivity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>START_TASK_TO_FRONT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>packageName</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>sourceStack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>resultTo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>?</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>resultTo</span><span class=p>.</span><span class=na>getStack</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceStack</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sourceStack</span><span class=p>.</span><span class=na>sendActivityResultLocked</span><span class=p>(</span><span class=o>-</span><span class=n>1</span><span class=w> </span><span class=cm>/* callingUid */</span><span class=p>,</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>resultTo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>RESULT_CANCELED</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kc>null</span><span class=w> </span><span class=cm>/* data */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityOptions</span><span class=p>.</span><span class=na>abort</span><span class=p>(</span><span class=n>mOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>START_CLASS_NOT_FOUND</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If the activity being launched is the same as the one currently at the top, then</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// we need to check if it should only be launched once.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>topStack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>mFocusedStack</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>topFocused</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>topStack</span><span class=p>.</span><span class=na>topActivity</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>topStack</span><span class=p>.</span><span class=na>topRunningNonDelayedActivityLocked</span><span class=p>(</span><span class=n>mNotTop</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>dontStart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>resultTo</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>top</span><span class=p>.</span><span class=na>realActivity</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>realActivity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>top</span><span class=p>.</span><span class=na>userId</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>userId</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>top</span><span class=p>.</span><span class=na>app</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>top</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>((</span><span class=n>mLaunchFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>FLAG_ACTIVITY_SINGLE_TOP</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>mLaunchSingleTop</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mLaunchSingleTask</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dontStart</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// For paranoia, make sure we have correctly resumed the top activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>topStack</span><span class=p>.</span><span class=na>mLastPausedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDoResume</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>resumeFocusedStackTopActivityLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityOptions</span><span class=p>.</span><span class=na>abort</span><span class=p>(</span><span class=n>mOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>mStartFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>START_FLAG_ONLY_IF_NEEDED</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We don&#39;t need to start a new activity, and the client said not to do</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// anything if that is the case, so this is it!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>START_RETURN_INTENT_TO_CALLER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>deliverNewIntent</span><span class=p>(</span><span class=n>top</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Don&#39;t use mStartActivity.task to show the toast. We&#39;re not starting a new activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// but reusing &#39;top&#39;. Fields in mStartActivity may not be fully initialized.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>handleNonResizableTaskIfNeeded</span><span class=p>(</span><span class=n>top</span><span class=p>.</span><span class=na>getTask</span><span class=p>(),</span><span class=w> </span><span class=n>preferredLaunchStackId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>preferredLaunchDisplayId</span><span class=p>,</span><span class=w> </span><span class=n>topStack</span><span class=p>.</span><span class=na>mStackId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>START_DELIVERED_TO_TOP</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>newTask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>taskToAffiliate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>mLaunchTaskBehind</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mSourceRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>?</span><span class=w> </span><span class=n>mSourceRecord</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Should this be considered a new task?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>START_SUCCESS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>resultTo</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mInTask</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mAddingToTask</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>mLaunchFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>FLAG_ACTIVITY_NEW_TASK</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newTask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>setTaskFromReuseOrCreateNewTask</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>taskToAffiliate</span><span class=p>,</span><span class=w> </span><span class=n>preferredLaunchStackId</span><span class=p>,</span><span class=w> </span><span class=n>topStack</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSourceRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>setTaskFromSourceRecord</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mInTask</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>setTaskFromInTask</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// This not being started from an existing activity, and not part of a new task...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// just put it in the top task, though these days this case should never happen.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setTaskToCurrentTopOrCreateNewTask</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>START_SUCCESS</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mService</span><span class=p>.</span><span class=na>grantUriPermissionFromIntentLocked</span><span class=p>(</span><span class=n>mCallingUid</span><span class=p>,</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mIntent</span><span class=p>,</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>getUriPermissionsLocked</span><span class=p>(),</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mService</span><span class=p>.</span><span class=na>grantEphemeralAccessLocked</span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w> </span><span class=n>mIntent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>appInfo</span><span class=p>.</span><span class=na>uid</span><span class=p>,</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getAppId</span><span class=p>(</span><span class=n>mCallingUid</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSourceRecord</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>setTaskToReturnTo</span><span class=p>(</span><span class=n>mSourceRecord</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>newTask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>EventLog</span><span class=p>.</span><span class=na>writeEvent</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>EventLogTags</span><span class=p>.</span><span class=na>AM_CREATE_TASK</span><span class=p>,</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>taskId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityStack</span><span class=p>.</span><span class=na>logStartActivity</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>EventLogTags</span><span class=p>.</span><span class=na>AM_CREATE_ACTIVITY</span><span class=p>,</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>,</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mTargetStack</span><span class=p>.</span><span class=na>mLastPausedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sendPowerHintForLaunchStartIfNeeded</span><span class=p>(</span><span class=kc>false</span><span class=w> </span><span class=cm>/* forceSend */</span><span class=p>,</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mTargetStack</span><span class=p>.</span><span class=na>startActivityLocked</span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>,</span><span class=w> </span><span class=n>topFocused</span><span class=p>,</span><span class=w> </span><span class=n>newTask</span><span class=p>,</span><span class=w> </span><span class=n>mKeepCurTransition</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDoResume</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>topTaskActivity</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>topRunningActivityLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mTargetStack</span><span class=p>.</span><span class=na>isFocusable</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>topTaskActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>topTaskActivity</span><span class=p>.</span><span class=na>mTaskOverlay</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mStartActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>topTaskActivity</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If the activity is not focusable, we can&#39;t resume it, but still would like to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// make sure it becomes visible as it starts (this will also trigger entry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// animation). An example of this are PIP activities.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Also, we don&#39;t want to resume activities in a task that currently has an overlay</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// as the starting activity just needs to be in the visible paused state until the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// over is removed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mTargetStack</span><span class=p>.</span><span class=na>ensureActivitiesVisibleLocked</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=o>!</span><span class=n>PRESERVE_WINDOWS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Go ahead and tell window manager to execute app transition for this activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// since the app transition will not be triggered through the resume channel.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>executeAppTransition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If the target stack was not previously focusable (previous top running activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// on that stack was not visible) then any prior calls to move the stack to the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// will not update the focused stack.  If starting the new activity now allows the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// task stack to be focusable, then ensure that we now update the focused stack</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// accordingly.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mTargetStack</span><span class=p>.</span><span class=na>isFocusable</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>isFocusedStack</span><span class=p>(</span><span class=n>mTargetStack</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mTargetStack</span><span class=p>.</span><span class=na>moveToFront</span><span class=p>(</span><span class=s>&#34;startActivityUnchecked&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>resumeFocusedStackTopActivityLocked</span><span class=p>(</span><span class=n>mTargetStack</span><span class=p>,</span><span class=w> </span><span class=n>mStartActivity</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mTargetStack</span><span class=p>.</span><span class=na>addRecentActivityLocked</span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>updateUserStackLocked</span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w> </span><span class=n>mTargetStack</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mSupervisor</span><span class=p>.</span><span class=na>handleNonResizableTaskIfNeeded</span><span class=p>(</span><span class=n>mStartActivity</span><span class=p>.</span><span class=na>getTask</span><span class=p>(),</span><span class=w> </span><span class=n>preferredLaunchStackId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>preferredLaunchDisplayId</span><span class=p>,</span><span class=w> </span><span class=n>mTargetStack</span><span class=p>.</span><span class=na>mStackId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>START_SUCCESS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ActivityStackSupervisor.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>resumeFocusedStackTopActivityLocked</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>targetStack</span><span class=p>,</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>targetOptions</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>readyToResume</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>targetStack</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>isFocusedStack</span><span class=p>(</span><span class=n>targetStack</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>targetStack</span><span class=p>.</span><span class=na>resumeTopActivityUncheckedLocked</span><span class=p>(</span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>targetOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mFocusedStack</span><span class=p>.</span><span class=na>topRunningActivityLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>RESUMED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mFocusedStack</span><span class=p>.</span><span class=na>resumeTopActivityUncheckedLocked</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>RESUMED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Kick off any lingering app transitions form the MoveTaskToFront operation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mFocusedStack</span><span class=p>.</span><span class=na>executeAppTransition</span><span class=p>(</span><span class=n>targetOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span></code></pre></div><p>ActivityStack.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Ensure that the top activity in the stack is resumed.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param prev The previously resumed activity, for when in the process
</span></span></span><span class=line><span class=cl><span class=cm>     * of pausing; can be null to call from elsewhere.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param options Activity options.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return Returns true if something is being resumed, or false if
</span></span></span><span class=line><span class=cl><span class=cm>     * nothing happened.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * NOTE: It is not safe to call this method directly as it can cause an activity in a
</span></span></span><span class=line><span class=cl><span class=cm>     *       non-focused stack to be resumed.
</span></span></span><span class=line><span class=cl><span class=cm>     *       Use {@link ActivityStackSupervisor#resumeFocusedStackTopActivityLocked} to resume the
</span></span></span><span class=line><span class=cl><span class=cm>     *       right activity for the current system state.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=nf>resumeTopActivityUncheckedLocked</span><span class=p>(</span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>inResumeTopActivity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Don&#39;t even start recursing.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Protect against recursion.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>inResumeTopActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resumeTopActivityInnerLocked</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>inResumeTopActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// When resuming the top activity, it may be necessary to pause the top activity (for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// example, returning to the lock screen. We suppress the normal pause logic in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// {@link #resumeTopActivityUncheckedLocked}, since the top activity is resumed at the end.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// We call the {@link ActivityStackSupervisor#checkReadyForSleepLocked} again here to ensure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// any necessary pause logic occurs. In the case where the Activity will be shown regardless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// of the lock screen, the call to {@link ActivityStackSupervisor#checkReadyForSleepLocked}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// is skipped.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>topRunningActivityLocked</span><span class=p>(</span><span class=kc>true</span><span class=w> </span><span class=cm>/* focusableOnly */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>next</span><span class=p>.</span><span class=na>canTurnScreenOn</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkReadyForSleep</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>resumeTopActivityInnerLocked</span><span class=p>(</span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mService</span><span class=p>.</span><span class=na>mBooting</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mService</span><span class=p>.</span><span class=na>mBooted</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Not ready yet!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Find the next top-most activity to resume in this stack that is not finishing and is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// focusable. If it is not focusable, we will fall into the case below to resume the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// top activity in the next focusable task.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>topRunningActivityLocked</span><span class=p>(</span><span class=kc>true</span><span class=w> </span><span class=cm>/* focusableOnly */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasRunningActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// TODO: Maybe this entire condition can get removed?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasRunningActivity</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>getDisplay</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>cancelInitializingActivities</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Remember how we&#39;ll process this pause/resume situation, and ensure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// that the state is reset however we wind up proceeding.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>userLeaving</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mUserLeaving</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mUserLeaving</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasRunningActivity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// There are no activities left in the stack, let&#39;s look somewhere else.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>resumeTopActivityInNextFocusableStack</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=s>&#34;noMoreActivities&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>next</span><span class=p>.</span><span class=na>delayedResume</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If the top activity is the resumed one, nothing to do.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mResumedActivity</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ActivityState</span><span class=p>.</span><span class=na>RESUMED</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>allResumedActivitiesComplete</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Make sure we have executed any pending transitions, since there</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// should be nothing left to do at this point.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>executeAppTransition</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;resumeTopActivityLocked: Top activity resumed &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>nextTask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>getTask</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>prevTask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>prev</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prevTask</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>prevTask</span><span class=p>.</span><span class=na>getStack</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>this</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>prevTask</span><span class=p>.</span><span class=na>isOverHomeStack</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>prev</span><span class=p>.</span><span class=na>finishing</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>prev</span><span class=p>.</span><span class=na>frontOfTask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w>  </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prevTask</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>nextTask</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>prevTask</span><span class=p>.</span><span class=na>setFrontOfTask</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prevTask</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>topTask</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// This task is going away but it was supposed to return to the home stack.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Now the task above it has to return to the home task instead.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>taskNdx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mTaskHistory</span><span class=p>.</span><span class=na>indexOf</span><span class=p>(</span><span class=n>prevTask</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mTaskHistory</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>taskNdx</span><span class=p>).</span><span class=na>setTaskToReturnTo</span><span class=p>(</span><span class=n>HOME_ACTIVITY_TYPE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isOnHomeDisplay</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isHomeStack</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;resumeTopActivityLocked: Launching home next&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>isOnHomeDisplay</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>resumeHomeStackTask</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=s>&#34;prevFinished&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If we are sleeping, and there is no resumed activity, and the top</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// activity is paused, well that is the state we want.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldSleepOrShutDownActivities</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mLastPausedActivity</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>next</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>allPausedActivitiesComplete</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Make sure we have executed any pending transitions, since there</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// should be nothing left to do at this point.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>executeAppTransition</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;resumeTopActivityLocked: Going to sleep and all paused&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Make sure that the user who owns this activity is started.  If not,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// we will just leave it as is because someone should be bringing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// another user&#39;s activities to the top of the stack.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mService</span><span class=p>.</span><span class=na>mUserController</span><span class=p>.</span><span class=na>hasStartedUserState</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>userId</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Skipping resume of top activity &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: user &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>userId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; is stopped&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// The activity may be waiting for stop, but that is no longer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// appropriate for it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mStoppingActivities</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mGoingToSleepActivities</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>next</span><span class=p>.</span><span class=na>sleeping</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mActivitiesWaitingForVisibleActivity</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_SWITCH</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Resuming &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If we are currently pausing an activity, then don&#39;t do anything until that is done.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>allPausedActivitiesComplete</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>DEBUG_PAUSE</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PAUSE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;resumeTopActivityLocked: Skip resume: some activity pausing.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>setLaunchSource</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>uid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>lastResumedCanPip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>lastFocusedStack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>getLastStack</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastFocusedStack</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>lastFocusedStack</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// So, why aren&#39;t we using prev here??? See the param comment on the method. prev doesn&#39;t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// represent the last resumed activity. However, the last focus stack does if it isn&#39;t null.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>lastResumed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastFocusedStack</span><span class=p>.</span><span class=na>mResumedActivity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lastResumedCanPip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastResumed</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>lastResumed</span><span class=p>.</span><span class=na>checkEnterPictureInPictureState</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;resumeTopActivity&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userLeaving</span><span class=w> </span><span class=cm>/* beforeStopping */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If the flag RESUME_WHILE_PAUSING is set, then continue to schedule the previous activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// to be paused, while at the same time resuming the new resume activity only if the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// previous activity can&#39;t go into Pip since we want to give Pip activities a chance to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// enter Pip before resuming the next activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>resumeWhilePausing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>FLAG_RESUME_WHILE_PAUSING</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>lastResumedCanPip</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>pausing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>pauseBackStacks</span><span class=p>(</span><span class=n>userLeaving</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mResumedActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;resumeTopActivityLocked: Pausing &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mResumedActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pausing</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>startPausingLocked</span><span class=p>(</span><span class=n>userLeaving</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pausing</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>resumeWhilePausing</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;resumeTopActivityLocked: Skip resume: need to start pausing&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// At this point we want to put the upcoming activity&#39;s process</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// at the top of the LRU list, since we know we will be needing it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// very soon and it would be a waste to let it get killed if it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// happens to be sitting towards the end.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>updateLruProcessLocked</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mResumedActivity</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ActivityState</span><span class=p>.</span><span class=na>RESUMED</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>allResumedActivitiesComplete</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// It is possible for the activity to be resumed when we paused back stacks above if the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// next activity doesn&#39;t have to wait for pause to complete.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// So, nothing else to-do except:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Make sure we have executed any pending transitions, since there</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// should be nothing left to do at this point.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>executeAppTransition</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;resumeTopActivityLocked: Top activity resumed (dontWaitForPause) &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If the most recent activity was noHistory but was only stopped rather</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// than stopped+finished because the device went to sleep, we need to make</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// sure to finish it as we&#39;re making a new activity topmost.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldSleepActivities</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mLastNoHistoryActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>!</span><span class=n>mLastNoHistoryActivity</span><span class=p>.</span><span class=na>finishing</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;no-history finish of &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mLastNoHistoryActivity</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; on new resume&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>requestFinishActivityLocked</span><span class=p>(</span><span class=n>mLastNoHistoryActivity</span><span class=p>.</span><span class=na>appToken</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=p>.</span><span class=na>RESULT_CANCELED</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=s>&#34;resume-no-history&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLastNoHistoryActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prev</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mActivitiesWaitingForVisibleActivity</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>prev</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>next</span><span class=p>.</span><span class=na>nowVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mActivitiesWaitingForVisibleActivity</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_SWITCH</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;Resuming top, waiting visible to hide: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// The next activity is already visible, so hide the previous</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// activity&#39;s windows right now so we can show the new one ASAP.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We only do this if the previous is finishing, which should mean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// it is on top of the one being resumed so hiding it quickly</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// is good.  Otherwise, we want to do the normal route of allowing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the resumed activity to be shown so we can decide if the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// previous should actually be hidden depending on whether the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// new one is found to be full-screen or not.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prev</span><span class=p>.</span><span class=na>finishing</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>prev</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_SWITCH</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34;Not waiting for visible to hide: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, waitingVisible=&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mActivitiesWaitingForVisibleActivity</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>prev</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, nowVisible=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>nowVisible</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_SWITCH</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34;Previous already visible but still waiting to hide: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>prev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, waitingVisible=&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mActivitiesWaitingForVisibleActivity</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>prev</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, nowVisible=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>nowVisible</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Launching this app&#39;s activity, make sure the app is no longer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// considered stopped.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AppGlobals</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>().</span><span class=na>setPackageStoppedState</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>userId</span><span class=p>);</span><span class=w> </span><span class=cm>/* TODO: Verify if correct userid */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalArgumentException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failed trying to unstop package &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>packageName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// We are starting up the next activity, so tell the window manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// that the previous one will be hidden soon.  This way it can know</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// to ignore it when computing the desired screen orientation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>anim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prev</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prev</span><span class=p>.</span><span class=na>finishing</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_TRANSITION</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_TRANSITION</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;Prepare close transition: prev=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mNoAnimActivities</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>prev</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>anim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>prepareAppTransition</span><span class=p>(</span><span class=n>TRANSIT_NONE</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>prepareAppTransition</span><span class=p>(</span><span class=n>prev</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>?</span><span class=w> </span><span class=n>TRANSIT_ACTIVITY_CLOSE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>:</span><span class=w> </span><span class=n>TRANSIT_TASK_CLOSE</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>prev</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_TRANSITION</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_TRANSITION</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;Prepare open transition: prev=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mNoAnimActivities</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>next</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>anim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>prepareAppTransition</span><span class=p>(</span><span class=n>TRANSIT_NONE</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>prepareAppTransition</span><span class=p>(</span><span class=n>prev</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>?</span><span class=w> </span><span class=n>TRANSIT_ACTIVITY_OPEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>:</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>mLaunchTaskBehind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>?</span><span class=w> </span><span class=n>TRANSIT_TASK_OPEN_BEHIND</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>:</span><span class=w> </span><span class=n>TRANSIT_TASK_OPEN</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_TRANSITION</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_TRANSITION</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Prepare open transition: no previous&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mNoAnimActivities</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>next</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>anim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>prepareAppTransition</span><span class=p>(</span><span class=n>TRANSIT_NONE</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>prepareAppTransition</span><span class=p>(</span><span class=n>TRANSIT_ACTIVITY_OPEN</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bundle</span><span class=w> </span><span class=n>resumeAnimOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>anim</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>opts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>getOptionsForTargetActivityLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>opts</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resumeAnimOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>opts</span><span class=p>.</span><span class=na>toBundle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>next</span><span class=p>.</span><span class=na>applyOptionsLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>next</span><span class=p>.</span><span class=na>clearOptionsLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>lastStack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>getLastStack</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_SWITCH</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Resume running: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; stopped=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>stopped</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; visible=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>visible</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the previous activity is translucent, force a visibility update of</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the next activity, so that it&#39;s added to WM&#39;s opening app list, and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// transition animation can be set up properly.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// For example, pressing Home button with a translucent activity in focus.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Launcher is already visible in this case. If we don&#39;t add it to opening</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// apps, maybeUpdateTransitToWallpaper() will fail to identify this as a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// TRANSIT_WALLPAPER_OPEN animation, and run some funny animation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>lastActivityTranslucent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastStack</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>lastStack</span><span class=p>.</span><span class=na>mFullscreen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>lastStack</span><span class=p>.</span><span class=na>mLastPausedActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>lastStack</span><span class=p>.</span><span class=na>mLastPausedActivity</span><span class=p>.</span><span class=na>fullscreen</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// The contained logic must be synchronized, since we are both changing the visibility</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// and updating the {@link Configuration}. {@link ActivityRecord#setVisibility} will</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ultimately cause the client code to schedule a layout. Since layouts retrieve the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// current {@link Configuration}, we must ensure that the below code updates it before</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the layout can occur.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>getWindowManagerLock</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// This activity is now becoming visible.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>next</span><span class=p>.</span><span class=na>visible</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>stopped</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>lastActivityTranslucent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// schedule launch ticks to collect information about slow apps.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>next</span><span class=p>.</span><span class=na>startLaunchTickingLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>lastResumedActivity</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lastStack</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>:</span><span class=n>lastStack</span><span class=p>.</span><span class=na>mResumedActivity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityState</span><span class=w> </span><span class=n>lastState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>state</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>updateCpuStats</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Moving to RESUMED: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; (in existing)&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setResumedActivityLocked</span><span class=p>(</span><span class=n>next</span><span class=p>,</span><span class=w> </span><span class=s>&#34;resumeTopActivityInnerLocked&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>updateLruProcessLocked</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>updateLRUListLocked</span><span class=p>(</span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>updateOomAdjLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Have the window manager re-evaluate the orientation of</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the screen based on the new activity order.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>notUpdated</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>isFocusedStack</span><span class=p>(</span><span class=k>this</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// We have special rotation behavior when Keyguard is locked. Make sure all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// activity visibilities are set correctly as well as the transition is updated</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// if needed to get the correct rotation behavior.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// TODO: Remove this once visibilities are set correctly immediately when</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// starting an activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mKeyguardController</span><span class=p>.</span><span class=na>isKeyguardLocked</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>ensureActivitiesVisibleLocked</span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=cm>/* starting */</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>0</span><span class=w> </span><span class=cm>/* configChanges */</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/* preserveWindows */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>updateOrientationFromAppTokens</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>getDisplayOverrideConfiguration</span><span class=p>(</span><span class=n>mDisplayId</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>next</span><span class=p>.</span><span class=na>mayFreezeScreenLocked</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>appToken</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>mDisplayId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>config</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>next</span><span class=p>.</span><span class=na>frozenBeforeDestroy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>notUpdated</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mService</span><span class=p>.</span><span class=na>updateDisplayOverrideConfigurationLocked</span><span class=p>(</span><span class=n>config</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=kc>false</span><span class=w> </span><span class=cm>/* deferResume */</span><span class=p>,</span><span class=w> </span><span class=n>mDisplayId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>notUpdated</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// The configuration update wasn&#39;t able to keep the existing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// instance of the activity, and instead started a new one.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// We should be all done, but let&#39;s just make sure our activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// is still at the top and schedule another run if something</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// weird happened.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>nextNext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>topRunningActivityLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34;Activity config changed during resume: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, new next: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>nextNext</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextNext</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Do over!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>scheduleResumeTopActivities</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>next</span><span class=p>.</span><span class=na>visible</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>stopped</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>next</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>completeResumeLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Deliver all pending results.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>ResultInfo</span><span class=o>&gt;</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>results</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>next</span><span class=p>.</span><span class=na>finishing</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_RESULTS</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_RESULTS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=s>&#34;Delivering results to &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>a</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>thread</span><span class=p>.</span><span class=na>scheduleSendResult</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>appToken</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>newIntents</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>thread</span><span class=p>.</span><span class=na>scheduleNewIntent</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>next</span><span class=p>.</span><span class=na>newIntents</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>appToken</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/* andPause */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Well the app will no longer be stopped.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Clear app token stopped state in window manager if needed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>notifyAppResumed</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>stopped</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>EventLog</span><span class=p>.</span><span class=na>writeEvent</span><span class=p>(</span><span class=n>EventLogTags</span><span class=p>.</span><span class=na>AM_RESUME_ACTIVITY</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>System</span><span class=p>.</span><span class=na>identityHashCode</span><span class=p>(</span><span class=n>next</span><span class=p>),</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>taskId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>next</span><span class=p>.</span><span class=na>shortComponentName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>sleeping</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mService</span><span class=p>.</span><span class=na>showUnsupportedZoomDialogIfNeededLocked</span><span class=p>(</span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mService</span><span class=p>.</span><span class=na>showAskCompatModeDialogLocked</span><span class=p>(</span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>pendingUiClean</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>forceProcessStateUpTo</span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>mTopProcessState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>clearOptionsLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>thread</span><span class=p>.</span><span class=na>scheduleResumeActivity</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>appToken</span><span class=p>,</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>repProcState</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mService</span><span class=p>.</span><span class=na>isNextTransitionForward</span><span class=p>(),</span><span class=w> </span><span class=n>resumeAnimOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w> </span><span class=s>&#34;resumeTopActivityLocked: Resumed &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Whoops, need to restart this activity!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Resume failed; resetting state to &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>lastState</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastState</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastStack</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lastStack</span><span class=p>.</span><span class=na>mResumedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastResumedActivity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Restarting because process died: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>next</span><span class=p>.</span><span class=na>hasBeenLaunched</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>next</span><span class=p>.</span><span class=na>hasBeenLaunched</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>SHOW_APP_STARTING_PREVIEW</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>lastStack</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>isFrontStackOnDisplay</span><span class=p>(</span><span class=n>lastStack</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>next</span><span class=p>.</span><span class=na>showStartingWindow</span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=cm>/* prev */</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/* newTask */</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=kc>false</span><span class=w> </span><span class=cm>/* taskSwitch */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>startSpecificActivityLocked</span><span class=p>(</span><span class=n>next</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// From this point on, if something goes wrong there is no way</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// to recover the activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>next</span><span class=p>.</span><span class=na>completeResumeLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If any exception gets thrown, toss away this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// activity and try the next one.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Exception thrown during resume of &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>requestFinishActivityLocked</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>appToken</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=p>.</span><span class=na>RESULT_CANCELED</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;resume-exception&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Whoops, need to restart this activity!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>next</span><span class=p>.</span><span class=na>hasBeenLaunched</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>next</span><span class=p>.</span><span class=na>hasBeenLaunched</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>SHOW_APP_STARTING_PREVIEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=p>.</span><span class=na>showStartingWindow</span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=cm>/* prev */</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/* newTask */</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=kc>false</span><span class=w> </span><span class=cm>/* taskSwich */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_SWITCH</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Restarting: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w> </span><span class=s>&#34;resumeTopActivityLocked: Restarting &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>next</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>startSpecificActivityLocked</span><span class=p>(</span><span class=n>next</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STACK</span><span class=p>)</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>validateTopActivitiesLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Start pausing the currently resumed activity.  It is an error to call this if there
</span></span></span><span class=line><span class=cl><span class=cm>     * is already an activity being paused or there is no resumed activity.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param userLeaving True if this should result in an onUserLeaving to the current activity.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param uiSleeping True if this is happening with the user interface going to sleep (the
</span></span></span><span class=line><span class=cl><span class=cm>     * screen turning off).
</span></span></span><span class=line><span class=cl><span class=cm>     * @param resuming The activity we are currently trying to resume or null if this is not being
</span></span></span><span class=line><span class=cl><span class=cm>     *                 called as part of resuming the top activity, so we shouldn&#39;t try to instigate
</span></span></span><span class=line><span class=cl><span class=cm>     *                 a resume here if not null.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param pauseImmediately True if the caller does not want to wait for the activity callback to
</span></span></span><span class=line><span class=cl><span class=cm>     *                         complete pausing.
</span></span></span><span class=line><span class=cl><span class=cm>     * @return Returns true if an activity now is in the PAUSING state, and we are waiting for
</span></span></span><span class=line><span class=cl><span class=cm>     * it to tell us when it is done.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>startPausingLocked</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>userLeaving</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>uiSleeping</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>resuming</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>pauseImmediately</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPausingActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Going to pause when pause is already pending for &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mPausingActivity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; state=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mPausingActivity</span><span class=p>.</span><span class=na>state</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>shouldSleepActivities</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Avoid recursion among check for sleep and complete pause during sleeping.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Because activity will be paused immediately after resume, just let pause</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// be completed by the order of activity paused from clients.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>completePauseLocked</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>resuming</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mResumedActivity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prev</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resuming</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Trying to pause when nothing is resumed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>resumeFocusedStackTopActivityLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Moving to PAUSING: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PAUSE</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PAUSE</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Start pausing: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mResumedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mPausingActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prev</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLastPausedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prev</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLastNoHistoryActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>prev</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getFlags</span><span class=p>()</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>Intent</span><span class=p>.</span><span class=na>FLAG_ACTIVITY_NO_HISTORY</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>prev</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ActivityInfo</span><span class=p>.</span><span class=na>FLAG_NO_HISTORY</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>prev</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>prev</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityState</span><span class=p>.</span><span class=na>PAUSING</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>prev</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>touchActiveTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>clearLaunchTime</span><span class=p>(</span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>topRunningActivityLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>mHasRecents</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>noDisplay</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>prev</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>uiSleeping</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>prev</span><span class=p>.</span><span class=na>mUpdateTaskThumbnailWhenHidden</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stopFullyDrawnTraceIfNeeded</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mService</span><span class=p>.</span><span class=na>updateCpuStats</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prev</span><span class=p>.</span><span class=na>app</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>prev</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PAUSE</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PAUSE</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Enqueueing pending pause: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>EventLog</span><span class=p>.</span><span class=na>writeEvent</span><span class=p>(</span><span class=n>EventLogTags</span><span class=p>.</span><span class=na>AM_PAUSE_ACTIVITY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>prev</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>identityHashCode</span><span class=p>(</span><span class=n>prev</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>prev</span><span class=p>.</span><span class=na>shortComponentName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>updateUsageStats</span><span class=p>(</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>prev</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>thread</span><span class=p>.</span><span class=na>schedulePauseActivity</span><span class=p>(</span><span class=n>prev</span><span class=p>.</span><span class=na>appToken</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=p>.</span><span class=na>finishing</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>userLeaving</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=p>.</span><span class=na>configChangeFlags</span><span class=p>,</span><span class=w> </span><span class=n>pauseImmediately</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Ignore exception, if process died other code will cleanup.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Exception thrown during pause&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPausingActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mLastPausedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mLastNoHistoryActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPausingActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLastPausedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLastNoHistoryActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If we are not going to sleep, we want to ensure the device is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// awake until the next activity is started.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>uiSleeping</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mService</span><span class=p>.</span><span class=na>isSleepingOrShuttingDownLocked</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>acquireLaunchWakelock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPausingActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Have the window manager pause its key dispatching until the new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// activity has started.  If we&#39;re pausing the activity just because</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the screen is being turned off and the UI is sleeping, don&#39;t interrupt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// key dispatch; the same activity will pick it up again on wakeup.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>uiSleeping</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>prev</span><span class=p>.</span><span class=na>pauseKeyDispatchingLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PAUSE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PAUSE</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Key dispatch not paused for screen off&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pauseImmediately</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If the caller said they don&#39;t want to wait for the pause, then complete</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the pause now.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>completePauseLocked</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>resuming</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>schedulePauseTimeout</span><span class=p>(</span><span class=n>prev</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// This activity failed to schedule the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// pause, so just treat it as being paused now.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PAUSE</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PAUSE</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Activity not running, resuming next.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resuming</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>resumeFocusedStackTopActivityLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>如果要启动的activity的进程还不存在，那么会执行到<code>mStackSupervisor.startSpecificActivityLocked(next, true, true);</code>。
ActivityStackSupervisor.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>startSpecificActivityLocked</span><span class=p>(</span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>andResume</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>checkConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Is this activity&#39;s application already running?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>getProcessRecordLocked</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>processName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>uid</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>getStack</span><span class=p>().</span><span class=na>setLaunchTime</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>r</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>flags</span><span class=o>&amp;</span><span class=n>ActivityInfo</span><span class=p>.</span><span class=na>FLAG_MULTIPROCESS</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=s>&#34;android&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>packageName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Don&#39;t add this if it is a platform component that is marked</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// to run in multiple processes, because this is actually</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// part of the framework so doesn&#39;t make sense to track as a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// separate apk in the process.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>app</span><span class=p>.</span><span class=na>addPackage</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>versionCode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mService</span><span class=p>.</span><span class=na>mProcessStats</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>realStartActivityLocked</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>andResume</span><span class=p>,</span><span class=w> </span><span class=n>checkConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Exception when starting activity &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>flattenToShortString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If a dead object exception was thrown -- fall through to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// restart the application.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mService</span><span class=p>.</span><span class=na>startProcessLocked</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>processName</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;activity&#34;</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>(),</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>接着调用AMS的启动进程方法<code>startProcessLocked()</code>：
ActivityManagerService.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ProcessRecord</span><span class=w> </span><span class=nf>startProcessLocked</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>processName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ApplicationInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>knownToBeDead</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>intentFlags</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>hostingType</span><span class=p>,</span><span class=w> </span><span class=n>ComponentName</span><span class=w> </span><span class=n>hostingName</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>allowWhileBooting</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>isolated</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>keepIfLarge</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>startProcessLocked</span><span class=p>(</span><span class=n>processName</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>knownToBeDead</span><span class=p>,</span><span class=w> </span><span class=n>intentFlags</span><span class=p>,</span><span class=w> </span><span class=n>hostingType</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>hostingName</span><span class=p>,</span><span class=w> </span><span class=n>allowWhileBooting</span><span class=p>,</span><span class=w> </span><span class=n>isolated</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=cm>/* isolatedUid */</span><span class=p>,</span><span class=w> </span><span class=n>keepIfLarge</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kc>null</span><span class=w> </span><span class=cm>/* ABI override */</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=cm>/* entryPoint */</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=cm>/* entryPointArgs */</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kc>null</span><span class=w> </span><span class=cm>/* crashHandler */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ProcessRecord</span><span class=w> </span><span class=nf>startProcessLocked</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>processName</span><span class=p>,</span><span class=w> </span><span class=n>ApplicationInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>knownToBeDead</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>intentFlags</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hostingType</span><span class=p>,</span><span class=w> </span><span class=n>ComponentName</span><span class=w> </span><span class=n>hostingName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>allowWhileBooting</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isolated</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>isolatedUid</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>keepIfLarge</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>abiOverride</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>entryPoint</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>entryPointArgs</span><span class=p>,</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>crashHandler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>elapsedRealtime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isolated</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getProcessRecordLocked</span><span class=p>(</span><span class=n>processName</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=na>uid</span><span class=p>,</span><span class=w> </span><span class=n>keepIfLarge</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: after getProcessRecord&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>intentFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>Intent</span><span class=p>.</span><span class=na>FLAG_FROM_BACKGROUND</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If we are in the background, then check to see if this process</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// is bad.  If so, we will just silently fail.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAppErrors</span><span class=p>.</span><span class=na>isBadProcessLocked</span><span class=p>(</span><span class=n>info</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PROCESSES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Bad process: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=na>uid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;/&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=na>processName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// When the user is explicitly starting a process, then clear its</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// crash count so that we won&#39;t make it bad until they see at</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// least one crash dialog again, and make the process good again</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// if it had been bad.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PROCESSES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Clearing bad process: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=na>uid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34;/&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=na>processName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAppErrors</span><span class=p>.</span><span class=na>resetProcessCrashTimeLocked</span><span class=p>(</span><span class=n>info</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAppErrors</span><span class=p>.</span><span class=na>isBadProcessLocked</span><span class=p>(</span><span class=n>info</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>EventLog</span><span class=p>.</span><span class=na>writeEvent</span><span class=p>(</span><span class=n>EventLogTags</span><span class=p>.</span><span class=na>AM_PROC_GOOD</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getUserId</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>uid</span><span class=p>),</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=na>uid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>info</span><span class=p>.</span><span class=na>processName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAppErrors</span><span class=p>.</span><span class=na>clearBadProcessLocked</span><span class=p>(</span><span class=n>info</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>bad</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If this is an isolated process, it can&#39;t re-use an existing process.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// We don&#39;t have to do anything more if:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// (1) There is an existing application record; and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// (2) The caller doesn&#39;t think it is dead, OR there is no thread</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//     object attached to it so we know it couldn&#39;t have crashed; and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// (3) There is a pid assigned to it, so it is either starting or</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//     already running.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PROCESSES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PROCESSES</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: name=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>processName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; app=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; knownToBeDead=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>knownToBeDead</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; thread=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; pid=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>pid</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>pid</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=o>!</span><span class=n>knownToBeDead</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>app</span><span class=p>.</span><span class=na>killed</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We already have the app running, or are waiting for it to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// come up (we have a pid but not yet its thread), so keep it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PROCESSES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PROCESSES</span><span class=p>,</span><span class=w> </span><span class=s>&#34;App already running: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If this is a new package in the process, add the package to the list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>addPackage</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=na>versionCode</span><span class=p>,</span><span class=w> </span><span class=n>mProcessStats</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: done, added package to proc&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// An application record is attached to a previous process,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// clean it up now.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PROCESSES</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>DEBUG_CLEANUP</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PROCESSES</span><span class=p>,</span><span class=w> </span><span class=s>&#34;App died: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: bad proc running, killing&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>killProcessGroup</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>uid</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>handleAppDiedLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: done killing old proc&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>hostingNameStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hostingName</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>?</span><span class=w> </span><span class=n>hostingName</span><span class=p>.</span><span class=na>flattenToShortString</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: creating new process record&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newProcessRecordLocked</span><span class=p>(</span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>processName</span><span class=p>,</span><span class=w> </span><span class=n>isolated</span><span class=p>,</span><span class=w> </span><span class=n>isolatedUid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failed making new process record for &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>processName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;/&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; isolated=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>isolated</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>crashHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>crashHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: done creating new process record&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If this is a new package in the process, add the package to the list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>addPackage</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=na>versionCode</span><span class=p>,</span><span class=w> </span><span class=n>mProcessStats</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: added package to existing proc&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If the system is not ready yet, then hold off on starting this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// process until it is.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mProcessesReady</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isAllowedWhileBooting</span><span class=p>(</span><span class=n>info</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>allowWhileBooting</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mProcessesOnHold</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>app</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mProcessesOnHold</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PROCESSES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PROCESSES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;System not ready, putting on hold: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: returning with proc on hold&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: stepping in to startProcess&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>startProcessLocked</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>hostingType</span><span class=p>,</span><span class=w> </span><span class=n>hostingNameStr</span><span class=p>,</span><span class=w> </span><span class=n>abiOverride</span><span class=p>,</span><span class=w> </span><span class=n>entryPoint</span><span class=p>,</span><span class=w> </span><span class=n>entryPointArgs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: done starting proc!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>pid</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isAllowedWhileBooting</span><span class=p>(</span><span class=n>ApplicationInfo</span><span class=w> </span><span class=n>ai</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>ai</span><span class=p>.</span><span class=na>flags</span><span class=o>&amp;</span><span class=n>ApplicationInfo</span><span class=p>.</span><span class=na>FLAG_PERSISTENT</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startProcessLocked</span><span class=p>(</span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>hostingType</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hostingNameStr</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>startProcessLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>hostingType</span><span class=p>,</span><span class=w> </span><span class=n>hostingNameStr</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=cm>/* abiOverride */</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kc>null</span><span class=w> </span><span class=cm>/* entryPoint */</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=cm>/* entryPointArgs */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startProcessLocked</span><span class=p>(</span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hostingType</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>hostingNameStr</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>abiOverride</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>entryPoint</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>entryPointArgs</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>startProcessLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>hostingType</span><span class=p>,</span><span class=w> </span><span class=n>hostingNameStr</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/* disableHiddenApiChecks */</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kc>null</span><span class=w> </span><span class=cm>/* abiOverride */</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=cm>/* entryPoint */</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=cm>/* entryPointArgs */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startProcessLocked</span><span class=p>(</span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>hostingType</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>hostingNameStr</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>disableHiddenApiChecks</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>abiOverride</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>entryPoint</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>entryPointArgs</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>elapsedRealtime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>pid</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>pid</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>MY_PID</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: removing from pids map&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mPidsSelfLocked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPidsSelfLocked</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mHandler</span><span class=p>.</span><span class=na>removeMessages</span><span class=p>(</span><span class=n>PROC_START_TIMEOUT_MSG</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: done removing from pids map&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>setPid</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PROCESSES</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mProcessesOnHold</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>app</span><span class=p>))</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PROCESSES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;startProcessLocked removing on hold: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mProcessesOnHold</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: starting to update cpu stats&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>updateCpuStats</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: done updating cpu stats&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getUserId</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>uid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>AppGlobals</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>().</span><span class=na>checkPackageStartable</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>rethrowAsRuntimeException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>uid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>uid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>gids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>mountExternal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>MOUNT_EXTERNAL_NONE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>app</span><span class=p>.</span><span class=na>isolated</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>permGids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: getting gids from package manager&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=n>IPackageManager</span><span class=w> </span><span class=n>pm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AppGlobals</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>permGids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pm</span><span class=p>.</span><span class=na>getPackageGids</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>MATCH_DEBUG_TRIAGED_MISSING</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>StorageManagerInternal</span><span class=w> </span><span class=n>storageManagerInternal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LocalServices</span><span class=p>.</span><span class=na>getService</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>StorageManagerInternal</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mountExternal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>storageManagerInternal</span><span class=p>.</span><span class=na>getExternalStorageMountMode</span><span class=p>(</span><span class=n>uid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>packageName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>rethrowAsRuntimeException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>                 * Add shared application and profile GIDs so applications can share some
</span></span></span><span class=line><span class=cl><span class=cm>                 * resources like shared libraries and access user-wide resources
</span></span></span><span class=line><span class=cl><span class=cm>                 */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ArrayUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>permGids</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>gids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>3</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>gids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>permGids</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>3</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>arraycopy</span><span class=p>(</span><span class=n>permGids</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>gids</span><span class=p>,</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>permGids</span><span class=p>.</span><span class=na>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>gids</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getSharedAppGid</span><span class=p>(</span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getAppId</span><span class=p>(</span><span class=n>uid</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>gids</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getCacheAppGid</span><span class=p>(</span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getAppId</span><span class=p>(</span><span class=n>uid</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>gids</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getUserGid</span><span class=p>(</span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getUserId</span><span class=p>(</span><span class=n>uid</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Replace any invalid GIDs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gids</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>ERR_GID</span><span class=p>)</span><span class=w> </span><span class=n>gids</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>gids</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gids</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>ERR_GID</span><span class=p>)</span><span class=w> </span><span class=n>gids</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>gids</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: building args&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mFactoryTest</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>FactoryTest</span><span class=p>.</span><span class=na>FACTORY_TEST_OFF</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mFactoryTest</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>FactoryTest</span><span class=p>.</span><span class=na>FACTORY_TEST_LOW_LEVEL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mTopComponent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mTopComponent</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>uid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mFactoryTest</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>FactoryTest</span><span class=p>.</span><span class=na>FACTORY_TEST_HIGH_LEVEL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>flags</span><span class=o>&amp;</span><span class=n>ApplicationInfo</span><span class=p>.</span><span class=na>FLAG_FACTORY_TEST</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>uid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ApplicationInfo</span><span class=p>.</span><span class=na>FLAG_DEBUGGABLE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_ENABLE_JDWP</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_JAVA_DEBUGGABLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Also turn on CheckJNI for debuggable apps. It&#39;s quite</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// awkward to turn on otherwise.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_ENABLE_CHECKJNI</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Run the app in safe mode if its manifest requests so or the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// system is booted in safe mode.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ApplicationInfo</span><span class=p>.</span><span class=na>FLAG_VM_SAFE_MODE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSafeMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_ENABLE_SAFEMODE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>SystemProperties</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;debug.checkjni&#34;</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_ENABLE_CHECKJNI</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>genDebugInfoProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemProperties</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;debug.generate-debug-info&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>genDebugInfoProperty</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>genDebugInfoProperty</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_GENERATE_DEBUG_INFO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>genMiniDebugInfoProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemProperties</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;dalvik.vm.minidebuginfo&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>genMiniDebugInfoProperty</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>genMiniDebugInfoProperty</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_GENERATE_MINI_DEBUG_INFO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>SystemProperties</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;debug.jni.logging&#34;</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_ENABLE_JNI_LOGGING</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>SystemProperties</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;debug.assert&#34;</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_ENABLE_ASSERT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mNativeDebuggingApp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mNativeDebuggingApp</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Enable all debug flags required by the native debugger.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_ALWAYS_JIT</span><span class=p>;</span><span class=w>          </span><span class=c1>// Don&#39;t interpret anything</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_GENERATE_DEBUG_INFO</span><span class=p>;</span><span class=w> </span><span class=c1>// Generate debug info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DEBUG_NATIVE_DEBUGGABLE</span><span class=p>;</span><span class=w>   </span><span class=c1>// Disbale optimizations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mNativeDebuggingApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>isPrivilegedApp</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>!</span><span class=n>SystemProperties</span><span class=p>.</span><span class=na>getBoolean</span><span class=p>(</span><span class=s>&#34;pm.dexopt.priv-apps&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>DISABLE_VERIFIER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>ONLY_USE_SYSTEM_OAT_FILES</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>isAllowedToUseHiddenApi</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>!</span><span class=n>disableHiddenApiChecks</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>!</span><span class=n>mHiddenApiBlacklist</span><span class=p>.</span><span class=na>isDisabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// This app is not allowed to use undocumented and private APIs, or blacklisting is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// enabled. Set up its runtime with the appropriate flag.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runtimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>ENABLE_HIDDEN_API_CHECKS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>invokeWith</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ApplicationInfo</span><span class=p>.</span><span class=na>FLAG_DEBUGGABLE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Debuggable apps may include a wrapper script with their library directory.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>wrapperFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>nativeLibraryDir</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;/wrap.sh&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>StrictMode</span><span class=p>.</span><span class=na>ThreadPolicy</span><span class=w> </span><span class=n>oldPolicy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>StrictMode</span><span class=p>.</span><span class=na>allowThreadDiskReads</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>wrapperFileName</span><span class=p>).</span><span class=na>exists</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>invokeWith</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/system/bin/logwrapper &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>wrapperFileName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>StrictMode</span><span class=p>.</span><span class=na>setThreadPolicy</span><span class=p>(</span><span class=n>oldPolicy</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>requiredAbi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>abiOverride</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>abiOverride</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>primaryCpuAbi</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requiredAbi</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>requiredAbi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Build</span><span class=p>.</span><span class=na>SUPPORTED_ABIS</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>instructionSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>primaryCpuAbi</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>instructionSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VMRuntime</span><span class=p>.</span><span class=na>getInstructionSet</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>primaryCpuAbi</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>gids</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>gids</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>requiredAbi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requiredAbi</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>instructionSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>instructionSet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the per-user SELinux context must be set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>seInfoUser</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;SELinux tag not defined&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;SELinux tag not defined for &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>packageName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; (uid &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;)&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>seInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>seInfo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>seInfoUser</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>seInfoUser</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Start the process.  It will either succeed and return a result containing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the PID of the new process, or else throw a RuntimeException.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>isActivityProcess</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>entryPoint</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entryPoint</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=n>entryPoint</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;android.app.ActivityThread&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Start proc: &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: asking zygote to start proc&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ProcessStartResult</span><span class=w> </span><span class=n>startResult</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hostingType</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;webview_service&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>startResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>startWebView</span><span class=p>(</span><span class=n>entryPoint</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>,</span><span class=w> </span><span class=n>uid</span><span class=p>,</span><span class=w> </span><span class=n>uid</span><span class=p>,</span><span class=w> </span><span class=n>gids</span><span class=p>,</span><span class=w> </span><span class=n>runtimeFlags</span><span class=p>,</span><span class=w> </span><span class=n>mountExternal</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>targetSdkVersion</span><span class=p>,</span><span class=w> </span><span class=n>seInfo</span><span class=p>,</span><span class=w> </span><span class=n>requiredAbi</span><span class=p>,</span><span class=w> </span><span class=n>instructionSet</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>dataDir</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>entryPointArgs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>startResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Process</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>entryPoint</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>,</span><span class=w> </span><span class=n>uid</span><span class=p>,</span><span class=w> </span><span class=n>uid</span><span class=p>,</span><span class=w> </span><span class=n>gids</span><span class=p>,</span><span class=w> </span><span class=n>runtimeFlags</span><span class=p>,</span><span class=w> </span><span class=n>mountExternal</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>targetSdkVersion</span><span class=p>,</span><span class=w> </span><span class=n>seInfo</span><span class=p>,</span><span class=w> </span><span class=n>requiredAbi</span><span class=p>,</span><span class=w> </span><span class=n>instructionSet</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>dataDir</span><span class=p>,</span><span class=w> </span><span class=n>invokeWith</span><span class=p>,</span><span class=w> </span><span class=n>entryPointArgs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: returned from zygote!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mBatteryStatsService</span><span class=p>.</span><span class=na>noteProcessStart</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>uid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: done updating battery stats&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>EventLog</span><span class=p>.</span><span class=na>writeEvent</span><span class=p>(</span><span class=n>EventLogTags</span><span class=p>.</span><span class=na>AM_PROC_START</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getUserId</span><span class=p>(</span><span class=n>uid</span><span class=p>),</span><span class=w> </span><span class=n>startResult</span><span class=p>.</span><span class=na>pid</span><span class=p>,</span><span class=w> </span><span class=n>uid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>,</span><span class=w> </span><span class=n>hostingType</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>hostingNameStr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>hostingNameStr</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>AppGlobals</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>().</span><span class=na>logAppProcessStartIfNeeded</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>uid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>seInfo</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>sourceDir</span><span class=p>,</span><span class=w> </span><span class=n>startResult</span><span class=p>.</span><span class=na>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Ignore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>persistent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Watchdog</span><span class=p>.</span><span class=na>getInstance</span><span class=p>().</span><span class=na>processStarted</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>,</span><span class=w> </span><span class=n>startResult</span><span class=p>.</span><span class=na>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: building log message&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>StringBuilder</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mStringBuilder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=na>setLength</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;Start proc &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>startResult</span><span class=p>.</span><span class=na>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=sc>&#39;:&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=sc>&#39;/&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>formatUid</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>uid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isActivityProcess</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34; [&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>entryPoint</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34; for &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>hostingType</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hostingNameStr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>hostingNameStr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>setPid</span><span class=p>(</span><span class=n>startResult</span><span class=p>.</span><span class=na>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>usingWrapper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>startResult</span><span class=p>.</span><span class=na>usingWrapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>removed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>killed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>killedByAm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: starting to update pids map&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>oldApp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mPidsSelfLocked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>oldApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPidsSelfLocked</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>startResult</span><span class=p>.</span><span class=na>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If there is already an app occupying that pid that hasn&#39;t been cleaned up</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>oldApp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>app</span><span class=p>.</span><span class=na>isolated</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Clean up anything relating to this pid first</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Reusing pid &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>startResult</span><span class=p>.</span><span class=na>pid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; while app is still mapped to it&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cleanUpApplicationRecordLocked</span><span class=p>(</span><span class=n>oldApp</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kc>true</span><span class=w> </span><span class=cm>/*replacingPid*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mPidsSelfLocked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>mPidsSelfLocked</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>startResult</span><span class=p>.</span><span class=na>pid</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isActivityProcess</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mHandler</span><span class=p>.</span><span class=na>obtainMessage</span><span class=p>(</span><span class=n>PROC_START_TIMEOUT_MSG</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>msg</span><span class=p>.</span><span class=na>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mHandler</span><span class=p>.</span><span class=na>sendMessageDelayed</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>startResult</span><span class=p>.</span><span class=na>usingWrapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>?</span><span class=w> </span><span class=n>PROC_START_TIMEOUT_WITH_WRAPPER</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>PROC_START_TIMEOUT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startProcess: done updating pids map&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failure starting process &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Something went very wrong while trying to start this process; one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// common case is when the package is frozen due to an active</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// upgrade. To recover, clean up any active bookkeeping related to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// starting this process. (We already invoked this method once when</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the package was initially frozen through KILL_APPLICATION_MSG, so</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// it doesn&#39;t hurt to use it again.)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>forceStopPackageLocked</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getAppId</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>uid</span><span class=p>),</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getUserId</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>userId</span><span class=p>),</span><span class=w> </span><span class=s>&#34;start failure&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>新的应用启动的入口是主线程ActivityThread的main方法，这里可以看到使用Lopper为主线程启动了消息循环，然后调用<code>attach()</code>方法:
ActivityThread.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>,</span><span class=w> </span><span class=s>&#34;ActivityThreadMain&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// CloseGuard defaults to true and can be quite spammy.  We</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// disable it here, but selectively enable it later (via</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// StrictMode) on debug builds, but using DropBox, not logs.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CloseGuard</span><span class=p>.</span><span class=na>setEnabled</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Environment</span><span class=p>.</span><span class=na>initForCurrentUser</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Set the reporter for event logging in libcore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventLogger</span><span class=p>.</span><span class=na>setReporter</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>EventLoggingReporter</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Make sure TrustedCertificateStore looks in the right place for CA certificates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>File</span><span class=w> </span><span class=n>configDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Environment</span><span class=p>.</span><span class=na>getUserConfigDirectory</span><span class=p>(</span><span class=n>UserHandle</span><span class=p>.</span><span class=na>myUserId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TrustedCertificateStore</span><span class=p>.</span><span class=na>setDefaultUserDirectory</span><span class=p>(</span><span class=n>configDir</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Process</span><span class=p>.</span><span class=na>setArgV0</span><span class=p>(</span><span class=s>&#34;&lt;pre-initialized&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Looper</span><span class=p>.</span><span class=na>prepareMainLooper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityThread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ActivityThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>thread</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sMainThreadHandler</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sMainThreadHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thread</span><span class=p>.</span><span class=na>getHandler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kc>false</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Looper</span><span class=p>.</span><span class=na>myLooper</span><span class=p>().</span><span class=na>setMessageLogging</span><span class=p>(</span><span class=k>new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>LogPrinter</span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;ActivityThread&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// End of event ActivityThreadMain.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Looper</span><span class=p>.</span><span class=na>loop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;Main thread loop unexpectedly exited&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>attach</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>system</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sCurrentActivityThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mSystemThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>system</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>system</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ViewRootImpl</span><span class=p>.</span><span class=na>addFirstDrawHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ensureJitEnabled</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>android</span><span class=p>.</span><span class=na>ddm</span><span class=p>.</span><span class=na>DdmHandleAppName</span><span class=p>.</span><span class=na>setAppName</span><span class=p>(</span><span class=s>&#34;&lt;pre-initialized&gt;&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                    </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>myUserId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RuntimeInit</span><span class=p>.</span><span class=na>setApplicationObject</span><span class=p>(</span><span class=n>mAppThread</span><span class=p>.</span><span class=na>asBinder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>IActivityManager</span><span class=w> </span><span class=n>mgr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mgr</span><span class=p>.</span><span class=na>attachApplication</span><span class=p>(</span><span class=n>mAppThread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Watch for getting close to heap limit.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BinderInternal</span><span class=p>.</span><span class=na>addGcWatcher</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nd>@Override</span><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mSomeActivitiesChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Runtime</span><span class=w> </span><span class=n>runtime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>long</span><span class=w> </span><span class=n>dalvikMax</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>runtime</span><span class=p>.</span><span class=na>maxMemory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>long</span><span class=w> </span><span class=n>dalvikUsed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>runtime</span><span class=p>.</span><span class=na>totalMemory</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>runtime</span><span class=p>.</span><span class=na>freeMemory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dalvikUsed</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=p>((</span><span class=n>3</span><span class=o>*</span><span class=n>dalvikMax</span><span class=p>)</span><span class=o>/</span><span class=n>4</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_MEMORY_TRIM</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Dalvik max=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>dalvikMax</span><span class=o>/</span><span class=n>1024</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; total=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>runtime</span><span class=p>.</span><span class=na>totalMemory</span><span class=p>()</span><span class=o>/</span><span class=n>1024</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; used=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>dalvikUsed</span><span class=o>/</span><span class=n>1024</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mSomeActivitiesChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mgr</span><span class=p>.</span><span class=na>releaseSomeActivities</span><span class=p>(</span><span class=n>mAppThread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Don&#39;t set application object here -- if the system crashes,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// we can&#39;t display an alert, we just want to die die die.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>android</span><span class=p>.</span><span class=na>ddm</span><span class=p>.</span><span class=na>DdmHandleAppName</span><span class=p>.</span><span class=na>setAppName</span><span class=p>(</span><span class=s>&#34;system_process&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>myUserId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInstrumentation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Instrumentation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ContextImpl</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContextImpl</span><span class=p>.</span><span class=na>createAppContext</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>getSystemContext</span><span class=p>().</span><span class=na>mLoadedApk</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInitialApplication</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=na>mLoadedApk</span><span class=p>.</span><span class=na>makeApplication</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInitialApplication</span><span class=p>.</span><span class=na>onCreate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;Unable to instantiate Application():&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// add dropbox logging to libcore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DropBox</span><span class=p>.</span><span class=na>setReporter</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>DropBoxReporter</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ViewRootImpl</span><span class=p>.</span><span class=na>ConfigChangedCallback</span><span class=w> </span><span class=n>configChangedCallback</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Configuration</span><span class=w> </span><span class=n>globalConfig</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mResourcesManager</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We need to apply this change to the resources immediately, because upon returning</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the view hierarchy will be informed about it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mResourcesManager</span><span class=p>.</span><span class=na>applyConfigurationToResourcesLocked</span><span class=p>(</span><span class=n>globalConfig</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kc>null</span><span class=w> </span><span class=cm>/* compat */</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>updateLocaleListFromAppContext</span><span class=p>(</span><span class=n>mInitialApplication</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mResourcesManager</span><span class=p>.</span><span class=na>getConfiguration</span><span class=p>().</span><span class=na>getLocales</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// This actually changed the resources! Tell everyone about it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPendingConfiguration</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>||</span><span class=w> </span><span class=n>mPendingConfiguration</span><span class=p>.</span><span class=na>isOtherSeqNewer</span><span class=p>(</span><span class=n>globalConfig</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mPendingConfiguration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>globalConfig</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>sendMessage</span><span class=p>(</span><span class=n>H</span><span class=p>.</span><span class=na>CONFIGURATION_CHANGED</span><span class=p>,</span><span class=w> </span><span class=n>globalConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ViewRootImpl</span><span class=p>.</span><span class=na>addConfigCallback</span><span class=p>(</span><span class=n>configChangedCallback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这里获取AMS代理，然后调用AMS的<code>attachApplication()</code>，并将主线程的ApplicationThread对象传入，以进行IPC通信。
ActivityManagerService.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>attachApplication</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>thread</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>callingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingPid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>origId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>clearCallingIdentity</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>attachApplicationLocked</span><span class=p>(</span><span class=n>thread</span><span class=p>,</span><span class=w> </span><span class=n>callingPid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Binder</span><span class=p>.</span><span class=na>restoreCallingIdentity</span><span class=p>(</span><span class=n>origId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>attachApplicationLocked</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>thread</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Find the application record that is being attached...  either via</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// the pid if we are running in multiple processes, or just pull the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// next app record if we are emulating process with anonymous threads.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>MY_PID</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mPidsSelfLocked</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPidsSelfLocked</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;No pending application record for pid &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>pid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; (IApplicationThread &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;); dropping process&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>EventLog</span><span class=p>.</span><span class=na>writeEvent</span><span class=p>(</span><span class=n>EventLogTags</span><span class=p>.</span><span class=na>AM_DROP_PROCESS</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>MY_PID</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>killProcessQuiet</span><span class=p>(</span><span class=n>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//TODO: killProcessGroup(app.info.uid, pid);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>thread</span><span class=p>.</span><span class=na>scheduleExit</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Ignore exceptions.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If this application record is still attached to a previous</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// process, clean it up now.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>handleAppDiedLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Tell the process all about itself.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_ALL</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Binding process pid &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>pid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; to record &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>processName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AppDeathRecipient</span><span class=w> </span><span class=n>adr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AppDeathRecipient</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>thread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>thread</span><span class=p>.</span><span class=na>asBinder</span><span class=p>().</span><span class=na>linkToDeath</span><span class=p>(</span><span class=n>adr</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>deathRecipient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>resetPackageList</span><span class=p>(</span><span class=n>mProcessStats</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>startProcessLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=s>&#34;link fail&#34;</span><span class=p>,</span><span class=w> </span><span class=n>processName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventLog</span><span class=p>.</span><span class=na>writeEvent</span><span class=p>(</span><span class=n>EventLogTags</span><span class=p>.</span><span class=na>AM_PROC_BOUND</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>pid</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>makeActive</span><span class=p>(</span><span class=n>thread</span><span class=p>,</span><span class=w> </span><span class=n>mProcessStats</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>curAdj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>setAdj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>verifiedAdj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ProcessList</span><span class=p>.</span><span class=na>INVALID_ADJ</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>curSchedGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>setSchedGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ProcessList</span><span class=p>.</span><span class=na>SCHED_GROUP_DEFAULT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>forcingToImportant</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>updateProcessForegroundLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>hasShownUi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>debugging</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>cached</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>killedByAm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>killed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// We carefully use the same state that PackageManager uses for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// filtering, since we use this flag to decide if we need to install</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// providers when user is unlocked later</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>app</span><span class=p>.</span><span class=na>unlocked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>StorageManager</span><span class=p>.</span><span class=na>isUserKeyUnlocked</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mHandler</span><span class=p>.</span><span class=na>removeMessages</span><span class=p>(</span><span class=n>PROC_START_TIMEOUT_MSG</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>normalMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mProcessesReady</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>isAllowedWhileBooting</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ProviderInfo</span><span class=o>&gt;</span><span class=w> </span><span class=n>providers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>normalMode</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>generateApplicationProvidersLocked</span><span class=p>(</span><span class=n>app</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>providers</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>checkAppInLaunchingProvidersLocked</span><span class=p>(</span><span class=n>app</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mHandler</span><span class=p>.</span><span class=na>obtainMessage</span><span class=p>(</span><span class=n>CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>msg</span><span class=p>.</span><span class=na>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mHandler</span><span class=p>.</span><span class=na>sendMessageDelayed</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>CONTENT_PROVIDER_PUBLISH_TIMEOUT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;attachApplicationLocked: before bindApplication&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>normalMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Launching preboot mode app: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_ALL</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;New app record &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s>&#34; thread=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>thread</span><span class=p>.</span><span class=na>asBinder</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; pid=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>testMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ApplicationThreadConstants</span><span class=p>.</span><span class=na>DEBUG_OFF</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDebugApp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mDebugApp</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>processName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>testMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWaitForDebugger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>?</span><span class=w> </span><span class=n>ApplicationThreadConstants</span><span class=p>.</span><span class=na>DEBUG_WAIT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>:</span><span class=w> </span><span class=n>ApplicationThreadConstants</span><span class=p>.</span><span class=na>DEBUG_ON</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>debugging</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDebugTransient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mDebugApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mOrigDebugApp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mWaitForDebugger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mOrigWaitForDebugger</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>enableTrackAllocation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mTrackAllocationApp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mTrackAllocationApp</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>processName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>enableTrackAllocation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mTrackAllocationApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the app is being launched for restore or full backup, set it up specially</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>isRestrictedBackupMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mBackupTarget</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mBackupAppName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>processName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>isRestrictedBackupMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mBackupTarget</span><span class=p>.</span><span class=na>appInfo</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>FIRST_APPLICATION_UID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>((</span><span class=n>mBackupTarget</span><span class=p>.</span><span class=na>backupMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>BackupRecord</span><span class=p>.</span><span class=na>RESTORE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>mBackupTarget</span><span class=p>.</span><span class=na>backupMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>BackupRecord</span><span class=p>.</span><span class=na>RESTORE_FULL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>mBackupTarget</span><span class=p>.</span><span class=na>backupMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>BackupRecord</span><span class=p>.</span><span class=na>BACKUP_FULL</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>notifyPackageUse</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mClass</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                 </span><span class=n>PackageManager</span><span class=p>.</span><span class=na>NOTIFY_PACKAGE_USE_INSTRUMENTATION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_CONFIGURATION</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_CONFIGURATION</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Binding proc &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=n>processName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; with config &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>getGlobalConfiguration</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ApplicationInfo</span><span class=w> </span><span class=n>appInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mTargetInfo</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>compat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>compatibilityInfoForPackageLocked</span><span class=p>(</span><span class=n>appInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>preBindAgent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mProfileApp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mProfileApp</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>processName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mProfileProc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mProfilerInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Send a profiler info object to the app if either a file is given, or</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// an agent should be loaded at bind-time.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>boolean</span><span class=w> </span><span class=n>needsInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mProfilerInfo</span><span class=p>.</span><span class=na>profileFile</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>||</span><span class=w> </span><span class=n>mProfilerInfo</span><span class=p>.</span><span class=na>attachAgentDuringBind</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>profilerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>needsInfo</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=p>(</span><span class=n>mProfilerInfo</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mProfilerInfo</span><span class=p>.</span><span class=na>agent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>preBindAgent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mProfilerInfo</span><span class=p>.</span><span class=na>agent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mProfileFile</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>profilerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mProfileFile</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAppAgentMap</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mAppAgentMap</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>processName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We need to do a debuggable check here. See setAgentApp for why the check is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// postponed to here.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ApplicationInfo</span><span class=p>.</span><span class=na>FLAG_DEBUGGABLE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>String</span><span class=w> </span><span class=n>agent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAppAgentMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>processName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Do not overwrite already requested agent.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>profilerInfo</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>profilerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>mAppAgentMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>processName</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>profilerInfo</span><span class=p>.</span><span class=na>agent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>profilerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>.</span><span class=na>setAgent</span><span class=p>(</span><span class=n>mAppAgentMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>processName</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>profilerInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>.</span><span class=na>profileFd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>profilerInfo</span><span class=p>.</span><span class=na>profileFd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>.</span><span class=na>profileFd</span><span class=p>.</span><span class=na>dup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// We deprecated Build.SERIAL and it is not accessible to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// apps that target the v2 security sandbox. Since access to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the serial is now behind a permission we push down the value.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>buildSerial</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>appInfo</span><span class=p>.</span><span class=na>targetSandboxVersion</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>?</span><span class=w> </span><span class=n>sTheRealBuildSerial</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Build</span><span class=p>.</span><span class=na>UNKNOWN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Check if this is a secondary process that should be incorporated into some</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// currently active instrumentation.  (Note we do this AFTER all of the profiling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// stuff above because profiling can currently happen only in the primary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// instrumentation process.)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mActiveInstrumentation</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActiveInstrumentation</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>--</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ActiveInstrumentation</span><span class=w> </span><span class=n>aInstr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActiveInstrumentation</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>aInstr</span><span class=p>.</span><span class=na>mFinished</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>aInstr</span><span class=p>.</span><span class=na>mTargetInfo</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>uid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>aInstr</span><span class=p>.</span><span class=na>mTargetProcesses</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// This is the wildcard mode, where every process brought up for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// the target instrumentation should be included.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>aInstr</span><span class=p>.</span><span class=na>mTargetInfo</span><span class=p>.</span><span class=na>packageName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>packageName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>aInstr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>aInstr</span><span class=p>.</span><span class=na>mRunningProcesses</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>proc</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>aInstr</span><span class=p>.</span><span class=na>mTargetProcesses</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>proc</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>aInstr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>aInstr</span><span class=p>.</span><span class=na>mRunningProcesses</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If we were asked to attach an agent on startup, do so now, before we&#39;re binding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// application code.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>preBindAgent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>attachAgent</span><span class=p>(</span><span class=n>preBindAgent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;attachApplicationLocked: immediately before bindApplication&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>mActivityMetricsLogger</span><span class=p>.</span><span class=na>notifyBindApplication</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>bindApplication</span><span class=p>(</span><span class=n>processName</span><span class=p>,</span><span class=w> </span><span class=n>appInfo</span><span class=p>,</span><span class=w> </span><span class=n>providers</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mClass</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mArguments</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mWatcher</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mUiAutomationConnection</span><span class=p>,</span><span class=w> </span><span class=n>testMode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mBinderTransactionTrackingEnabled</span><span class=p>,</span><span class=w> </span><span class=n>enableTrackAllocation</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>isRestrictedBackupMode</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>normalMode</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>persistent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=n>getGlobalConfiguration</span><span class=p>()),</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>compat</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>getCommonServicesLocked</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>isolated</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mCoreSettingsObserver</span><span class=p>.</span><span class=na>getCoreSettingsLocked</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>buildSerial</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>bindApplication</span><span class=p>(</span><span class=n>processName</span><span class=p>,</span><span class=w> </span><span class=n>appInfo</span><span class=p>,</span><span class=w> </span><span class=n>providers</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>testMode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mBinderTransactionTrackingEnabled</span><span class=p>,</span><span class=w> </span><span class=n>enableTrackAllocation</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>isRestrictedBackupMode</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>normalMode</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>persistent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=n>getGlobalConfiguration</span><span class=p>()),</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>compat</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>getCommonServicesLocked</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>isolated</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mCoreSettingsObserver</span><span class=p>.</span><span class=na>getCoreSettingsLocked</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>buildSerial</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;attachApplicationLocked: immediately after bindApplication&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>updateLruProcessLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;attachApplicationLocked: after updateLruProcessLocked&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>lastRequestedGc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>lastLowMemory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// todo: Yikes!  What should we do?  For now we will try to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// start another process, but that could easily get us in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// an infinite loop of restarting processes...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Exception thrown during bind of &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>resetPackageList</span><span class=p>(</span><span class=n>mProcessStats</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>unlinkDeathRecipient</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>startProcessLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=s>&#34;bind fail&#34;</span><span class=p>,</span><span class=w> </span><span class=n>processName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Remove this record from the list of starting applications.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mPersistentStartingProcesses</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PROCESSES</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mProcessesOnHold</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>app</span><span class=p>))</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PROCESSES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;Attach application locked removing on hold: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mProcessesOnHold</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>badApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>didSomething</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// See if the top visible activity is waiting to run in this process...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>normalMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>attachApplicationLocked</span><span class=p>(</span><span class=n>app</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>didSomething</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Exception thrown launching activities in &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>badApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Find any services that should be running in this process...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>badApp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>didSomething</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>mServices</span><span class=p>.</span><span class=na>attachApplicationLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>processName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;attachApplicationLocked: after mServices.attachApplicationLocked&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Exception thrown starting services in &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>badApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Check if a next-broadcast receiver is in this process...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>badApp</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>isPendingBroadcastProcessLocked</span><span class=p>(</span><span class=n>pid</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>didSomething</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>sendPendingBroadcastsLocked</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;attachApplicationLocked: after sendPendingBroadcastsLocked&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If the app died trying to launch the receiver we declare it &#39;bad&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Exception thrown dispatching broadcasts in &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>badApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Check whether the next backup agent is in this process...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>badApp</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mBackupTarget</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mBackupTarget</span><span class=p>.</span><span class=na>app</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>app</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_BACKUP</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_BACKUP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;New app is backup target, launching agent for &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notifyPackageUse</span><span class=p>(</span><span class=n>mBackupTarget</span><span class=p>.</span><span class=na>appInfo</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                             </span><span class=n>PackageManager</span><span class=p>.</span><span class=na>NOTIFY_PACKAGE_USE_BACKUP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>scheduleCreateBackupAgent</span><span class=p>(</span><span class=n>mBackupTarget</span><span class=p>.</span><span class=na>appInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>compatibilityInfoForPackageLocked</span><span class=p>(</span><span class=n>mBackupTarget</span><span class=p>.</span><span class=na>appInfo</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mBackupTarget</span><span class=p>.</span><span class=na>backupMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Exception thrown creating backup agent in &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>badApp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>badApp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>kill</span><span class=p>(</span><span class=s>&#34;error during init&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>handleAppDiedLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>didSomething</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>updateOomAdjLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkTime</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=s>&#34;attachApplicationLocked: after updateOomAdjLocked&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>继续查看Activity相关调用流程，接着会调用到ActivityStackSupervisor的<code>attachApplicationLocked()</code>方法:
ActivityStackSupervisor.java，最终和上述需要启动的activity的进程已存在的情况一样，都会调用到<code>realStartActivityLocked()</code>方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>attachApplicationLocked</span><span class=p>(</span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>app</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>RemoteException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>processName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>didSomething</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>displayNdx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActivityDisplays</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>displayNdx</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=o>--</span><span class=n>displayNdx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>ActivityStack</span><span class=o>&gt;</span><span class=w> </span><span class=n>stacks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActivityDisplays</span><span class=p>.</span><span class=na>valueAt</span><span class=p>(</span><span class=n>displayNdx</span><span class=p>).</span><span class=na>mStacks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>stackNdx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stacks</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>stackNdx</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=o>--</span><span class=n>stackNdx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>stack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stacks</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>stackNdx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isFocusedStack</span><span class=p>(</span><span class=n>stack</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stack</span><span class=p>.</span><span class=na>getAllRunningVisibleActivitiesLocked</span><span class=p>(</span><span class=n>mTmpActivityList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stack</span><span class=p>.</span><span class=na>topRunningActivityLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mTmpActivityList</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>activity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mTmpActivityList</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>app</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>activity</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>uid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>processName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>processName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>realStartActivityLocked</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>top</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>activity</span><span class=w> </span><span class=cm>/* andResume */</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=cm>/* checkConfig */</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>didSomething</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Exception in new application when starting activity &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=n>top</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>flattenToShortString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>didSomething</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ensureActivitiesVisibleLocked</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=o>!</span><span class=n>PRESERVE_WINDOWS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>didSomething</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>realStartActivityLocked</span><span class=p>(</span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>ProcessRecord</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>andResume</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>checkConfig</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>RemoteException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>allPausedActivitiesComplete</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// While there are activities pausing we skipping starting any new activities until</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// pauses are complete. NOTE: that we also do this for activities that are starting in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the paused state because they will first be resumed then paused on the client side.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>DEBUG_PAUSE</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_PAUSE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;realStartActivityLocked: Skipping start of r=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; some activities pausing...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>getTask</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>stack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span><span class=p>.</span><span class=na>getStack</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>beginDeferResume</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>startFreezingScreenLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// schedule launch ticks to collect information about slow apps.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>startLaunchTickingLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mKeyguardController</span><span class=p>.</span><span class=na>isKeyguardLocked</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>notifyUnknownVisibilityLaunched</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Have the window manager re-evaluate the orientation of the screen based on the new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// activity order.  Note that as a result of this, it can call back into the activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// manager with a new orientation.  We don&#39;t care about that, because the activity is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// not currently running so we are just restarting it anyway.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>checkConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>displayId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>getDisplayId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>updateOrientationFromAppTokens</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>getDisplayOverrideConfiguration</span><span class=p>(</span><span class=n>displayId</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>r</span><span class=p>.</span><span class=na>mayFreezeScreenLocked</span><span class=p>(</span><span class=n>app</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>appToken</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>displayId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Deferring resume here because we&#39;re going to launch new activity shortly.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We don&#39;t want to perform a redundant launch of the same record while ensuring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// configurations and trying to resume top activity of focused stack.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>updateDisplayOverrideConfigurationLocked</span><span class=p>(</span><span class=n>config</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=cm>/* deferResume */</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>displayId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>getStack</span><span class=p>().</span><span class=na>checkKeyguardVisibility</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=cm>/* shouldBeVisible */</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kc>true</span><span class=w> </span><span class=cm>/* isTop */</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We only set the visibility to true if the activity is allowed to be visible</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// based on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// keyguard state. This avoids setting this into motion in window manager that is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// later cancelled due to later calls to ensure visible activities that set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// visibility back to false.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>applicationInfoUid</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>r</span><span class=p>.</span><span class=na>userId</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>userId</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>appInfo</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>applicationInfoUid</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;User ID for activity changing for &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; appInfo.uid=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>appInfo</span><span class=p>.</span><span class=na>uid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; info.ai.uid=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>applicationInfoUid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; old=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>app</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; new=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=p>.</span><span class=na>waitingToKill</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>launchCount</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>lastLaunchTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_ALL</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Launching: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>activities</span><span class=p>.</span><span class=na>indexOf</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>idx</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>activities</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mService</span><span class=p>.</span><span class=na>updateLruProcessLocked</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mService</span><span class=p>.</span><span class=na>updateOomAdjLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>task</span><span class=p>.</span><span class=na>mLockTaskAuth</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LOCK_TASK_AUTH_LAUNCHABLE</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>task</span><span class=p>.</span><span class=na>mLockTaskAuth</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LOCK_TASK_AUTH_LAUNCHABLE_PRIV</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setLockTaskModeLocked</span><span class=p>(</span><span class=n>task</span><span class=p>,</span><span class=w> </span><span class=n>LOCK_TASK_MODE_LOCKED</span><span class=p>,</span><span class=w> </span><span class=s>&#34;mLockTaskAuth==LAUNCHABLE&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>thread</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RemoteException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ResultInfo</span><span class=o>&gt;</span><span class=w> </span><span class=n>results</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ReferrerIntent</span><span class=o>&gt;</span><span class=w> </span><span class=n>newIntents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>andResume</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// We don&#39;t need to deliver new intents and/or set results if activity is going</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// to pause immediately after launch.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>results</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>results</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>newIntents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>newIntents</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_SWITCH</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_SWITCH</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;Launching: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; icicle=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>icicle</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; with results=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>results</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; newIntents=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>newIntents</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; andResume=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>andResume</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>EventLog</span><span class=p>.</span><span class=na>writeEvent</span><span class=p>(</span><span class=n>EventLogTags</span><span class=p>.</span><span class=na>AM_RESTART_ACTIVITY</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>identityHashCode</span><span class=p>(</span><span class=n>r</span><span class=p>),</span><span class=w> </span><span class=n>task</span><span class=p>.</span><span class=na>taskId</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>shortComponentName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>isHomeActivity</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Home process is the root process of the task.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mService</span><span class=p>.</span><span class=na>mHomeProcess</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>task</span><span class=p>.</span><span class=na>mActivities</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>).</span><span class=na>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>notifyPackageUse</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>getPackageName</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>PackageManager</span><span class=p>.</span><span class=na>NOTIFY_PACKAGE_USE_ACTIVITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>sleeping</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>forceNewConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>showUnsupportedZoomDialogIfNeededLocked</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mService</span><span class=p>.</span><span class=na>showAskCompatModeDialogLocked</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>compat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>compatibilityInfoForPackageLocked</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>mProfileApp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>mProfileApp</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>mProfileProc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>mProfileProc</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>app</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mService</span><span class=p>.</span><span class=na>mProfileProc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfoSvc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>mProfilerInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>profilerInfoSvc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>profilerInfoSvc</span><span class=p>.</span><span class=na>profileFile</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>profilerInfoSvc</span><span class=p>.</span><span class=na>profileFd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>profilerInfoSvc</span><span class=p>.</span><span class=na>profileFd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>profilerInfoSvc</span><span class=p>.</span><span class=na>profileFd</span><span class=p>.</span><span class=na>dup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>profilerInfoSvc</span><span class=p>.</span><span class=na>closeFd</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>profilerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=p>(</span><span class=n>profilerInfoSvc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>hasShownUi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>pendingUiClean</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>forceProcessStateUpTo</span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>mTopProcessState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Because we could be starting an Activity in the system process this may not go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// across a Binder interface which would create a new Configuration. Consequently</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// we have to always create a new Configuration here.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>MergedConfiguration</span><span class=w> </span><span class=n>mergedConfiguration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MergedConfiguration</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mService</span><span class=p>.</span><span class=na>getGlobalConfiguration</span><span class=p>(),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>getMergedOverrideConfiguration</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>setLastReportedConfiguration</span><span class=p>(</span><span class=n>mergedConfiguration</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>logIfTransactionTooLarge</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>icicle</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>thread</span><span class=p>.</span><span class=na>scheduleLaunchActivity</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>appToken</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>identityHashCode</span><span class=p>(</span><span class=n>r</span><span class=p>),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>info</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// TODO: Have this take the merged configuration instead of separate global</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// and override configs.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mergedConfiguration</span><span class=p>.</span><span class=na>getGlobalConfiguration</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mergedConfiguration</span><span class=p>.</span><span class=na>getOverrideConfiguration</span><span class=p>(),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>compat</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>r</span><span class=p>.</span><span class=na>launchedFromPackage</span><span class=p>,</span><span class=w> </span><span class=n>task</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>repProcState</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>icicle</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=p>,</span><span class=w> </span><span class=n>results</span><span class=p>,</span><span class=w> </span><span class=n>newIntents</span><span class=p>,</span><span class=w> </span><span class=o>!</span><span class=n>andResume</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mService</span><span class=p>.</span><span class=na>isNextTransitionForward</span><span class=p>(),</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>privateFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ApplicationInfo</span><span class=p>.</span><span class=na>PRIVATE_FLAG_CANT_SAVE_STATE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// This may be a heavy-weight process!  Note that the package</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// manager will ensure that only activity can run in the main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// process of the .apk, which is the only thing that will be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// considered heavy-weight.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>processName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>packageName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mService</span><span class=p>.</span><span class=na>mHeavyWeightProcess</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>mHeavyWeightProcess</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>app</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Starting new heavy weight process &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; when already running &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>mHeavyWeightProcess</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mService</span><span class=p>.</span><span class=na>mHeavyWeightProcess</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>mHandler</span><span class=p>.</span><span class=na>obtainMessage</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>ActivityManagerService</span><span class=p>.</span><span class=na>POST_HEAVY_NOTIFICATION_MSG</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>msg</span><span class=p>.</span><span class=na>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mService</span><span class=p>.</span><span class=na>mHandler</span><span class=p>.</span><span class=na>sendMessage</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>launchFailed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// This is the second time we failed -- finish activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// and give up.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Second failure launching &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>flattenToShortString</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, giving up&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mService</span><span class=p>.</span><span class=na>appDiedLocked</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>stack</span><span class=p>.</span><span class=na>requestFinishActivityLocked</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>appToken</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=p>.</span><span class=na>RESULT_CANCELED</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34;2nd-crash&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// This is the first time we failed -- restart process and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// retry.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>launchFailed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>app</span><span class=p>.</span><span class=na>activities</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>endDeferResume</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>launchFailed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stack</span><span class=p>.</span><span class=na>updateLRUListLocked</span><span class=p>(</span><span class=n>r</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Activity &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; being launched, but already in LRU list&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>andResume</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>readyToResume</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// As part of the process of launching, ActivityThread also performs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// a resume.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stack</span><span class=p>.</span><span class=na>minimalResumeActivityLocked</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// This activity is not starting in the resumed state... which should look like we asked</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// it to pause+stop (but remain visible), and it has done so and reported back the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// current icicle and other state.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STATES</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_STATES</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;Moving to PAUSED: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; (starting in paused state)&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PAUSED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Launch the new version setup screen if needed.  We do this -after-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// launching the initial activity (that is, home), so that it can have</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// a chance to initialize itself while in the background, making the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// switch back to it faster and look better.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isFocusedStack</span><span class=p>(</span><span class=n>stack</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mService</span><span class=p>.</span><span class=na>startSetupActivityLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Update any services we are bound to that might care about whether</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// their client may have activities.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>app</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mService</span><span class=p>.</span><span class=na>mServices</span><span class=p>.</span><span class=na>updateServiceConnectionActivitiesLocked</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>    
</span></span></span></code></pre></div><p>如果要启动的activity进程已经存在了，那么使用IApplicationThread对象调用最终回调activity自身的生命周期方法，对于前一个activity，会执行onPause的回调，对于当前启动的activity会执行onResume回调。</p><p>ActivityThread#ApplicationThread.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>                </span><span class=c1>// we use token to identify this activity without having to send the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// activity itself back to the activity manager. (matters more with ipc)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleLaunchActivity</span><span class=p>(</span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ident</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>curConfig</span><span class=p>,</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>overrideConfig</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>CompatibilityInfo</span><span class=w> </span><span class=n>compatInfo</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>referrer</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>procState</span><span class=p>,</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>state</span><span class=p>,</span><span class=w> </span><span class=n>PersistableBundle</span><span class=w> </span><span class=n>persistentState</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ResultInfo</span><span class=o>&gt;</span><span class=w> </span><span class=n>pendingResults</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ReferrerIntent</span><span class=o>&gt;</span><span class=w> </span><span class=n>pendingNewIntents</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>notResumed</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isForward</span><span class=p>,</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>updateProcessState</span><span class=p>(</span><span class=n>procState</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ActivityClientRecord</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>ident</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ident</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>referrer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>referrer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>info</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>compatInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>compatInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>persistentState</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>pendingResults</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pendingResults</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>pendingIntents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pendingNewIntents</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>startsNotResumed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>notResumed</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>isForward</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isForward</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>profilerInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>overrideConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>overrideConfig</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>updatePendingConfiguration</span><span class=p>(</span><span class=n>curConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendMessage</span><span class=p>(</span><span class=n>H</span><span class=p>.</span><span class=na>LAUNCH_ACTIVITY</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>schedulePauseActivity</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>finished</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>userLeaving</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>configChanges</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>dontReport</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>seq</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLifecycleSeq</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_ORDER</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;pauseActivity &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ActivityThread</span><span class=p>.</span><span class=na>this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; operation received seq: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>seq</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendMessage</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>finished</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>H</span><span class=p>.</span><span class=na>PAUSE_ACTIVITY_FINISHING</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>H</span><span class=p>.</span><span class=na>PAUSE_ACTIVITY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>token</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>(</span><span class=n>userLeaving</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>USER_LEAVING</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>dontReport</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>DONT_REPORT</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>configChanges</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>seq</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleResumeActivity</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>processState</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>isForward</span><span class=p>,</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>resumeArgs</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>seq</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLifecycleSeq</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_ORDER</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;resumeActivity &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ActivityThread</span><span class=p>.</span><span class=na>this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; operation received seq: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>seq</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>updateProcessState</span><span class=p>(</span><span class=n>processState</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendMessage</span><span class=p>(</span><span class=n>H</span><span class=p>.</span><span class=na>RESUME_ACTIVITY</span><span class=p>,</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>isForward</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>seq</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在消息LAUNCH_ACTIVITY发送出去后，由ActivityThread的Handler进行接收并处理，调用到<code>handleLaunchActivity()</code>方法：
ActivityThread.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleLaunchActivity</span><span class=p>(</span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>customIntent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>reason</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If we are getting ready to gc after going to the background, well</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// we are back active so skip it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unscheduleGcIdler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mSomeActivitiesChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>profilerInfo</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mProfiler</span><span class=p>.</span><span class=na>setProfiler</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>profilerInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mProfiler</span><span class=p>.</span><span class=na>startProfiling</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Make sure we are running with the most recent config.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>handleConfigurationChanged</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Handling launch of &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Initialize before creating the activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ThreadedRenderer</span><span class=p>.</span><span class=na>sRendererDisabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>GraphicsEnvironment</span><span class=p>.</span><span class=na>earlyInitEGL</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>initialize</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Activity</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>performLaunchActivity</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>customIntent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>createdConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=n>mConfiguration</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>reportSizeConfigurations</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Bundle</span><span class=w> </span><span class=n>oldState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>handleResumeActivity</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>isForward</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>startsNotResumed</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>lastProcessedSeq</span><span class=p>,</span><span class=w> </span><span class=n>reason</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>startsNotResumed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// The activity manager actually wants this one to start out paused, because it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// needs to be visible but isn&#39;t in the foreground. We accomplish this by going</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// through the normal startup (because activities expect to go through onResume()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the first time they run, before their window is displayed), and then pausing it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// However, in this case we do -not- need to do the full pause cycle (of freezing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// and such) because the activity manager assumes it can just retain the current</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// state it has.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>performPauseActivityIfNeeded</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>reason</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We need to keep around the original state, in case we need to be created again.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// But we only do this for pre-Honeycomb apps, which always save their state when</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// pausing, so we can not have them save their state when restarting from a paused</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// state. For HC and later, we want to (and can) let the state be saved as the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// normal part of stopping the activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>isPreHoneycomb</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldState</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If there was an error, for any reason, tell the activity manager to stop us.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>finishActivity</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=p>.</span><span class=na>RESULT_CANCELED</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Activity</span><span class=p>.</span><span class=na>DONT_FINISH_TASK_WITH_ACTIVITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=nf>performLaunchActivity</span><span class=p>(</span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>customIntent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// System.out.println(&#34;##### [&#34; + System.currentTimeMillis() + &#34;] ActivityThread.performLaunchActivity(&#34; + r + &#34;)&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>aInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>loadedApk</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>loadedApk</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLoadedApk</span><span class=p>(</span><span class=n>aInfo</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>compatInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Context</span><span class=p>.</span><span class=na>CONTEXT_INCLUDE_CODE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ComponentName</span><span class=w> </span><span class=n>component</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>component</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>component</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>resolveActivity</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInitialApplication</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>setComponent</span><span class=p>(</span><span class=n>component</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>targetActivity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>component</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ComponentName</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>targetActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ContextImpl</span><span class=w> </span><span class=n>appContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createBaseContextForActivity</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ClassLoader</span><span class=w> </span><span class=n>cl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>appContext</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>activity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>newActivity</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>component</span><span class=p>.</span><span class=na>getClassName</span><span class=p>(),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>StrictMode</span><span class=p>.</span><span class=na>incrementExpectedActivityCount</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>setExtrasClassLoader</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>prepareToEnterProcess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>setClassLoader</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>onException</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;Unable to instantiate activity &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Application</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>loadedApk</span><span class=p>.</span><span class=na>makeApplication</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>mInstrumentation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Performing launch of &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: app=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, appName=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, pkg=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>loadedApk</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, comp=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>toShortString</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, dir=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>loadedApk</span><span class=p>.</span><span class=na>getAppDir</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>activity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>CharSequence</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>loadLabel</span><span class=p>(</span><span class=n>appContext</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=n>mCompatConfiguration</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>overrideConfig</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>config</span><span class=p>.</span><span class=na>updateFrom</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>overrideConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_CONFIGURATION</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Launching activity &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; with config &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>config</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Window</span><span class=w> </span><span class=n>window</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindow</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>mPreserveWindow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>window</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindow</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindowManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>appContext</span><span class=p>.</span><span class=na>setOuterContext</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>activity</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=n>appContext</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>getInstrumentation</span><span class=p>(),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>r</span><span class=p>.</span><span class=na>ident</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>,</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>parent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>r</span><span class=p>.</span><span class=na>embeddedID</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>lastNonConfigurationInstances</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>r</span><span class=p>.</span><span class=na>referrer</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=p>,</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>configCallback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>customIntent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>activity</span><span class=p>.</span><span class=na>mIntent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>customIntent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>lastNonConfigurationInstances</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>checkAndBlockForNetworkAccess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>activity</span><span class=p>.</span><span class=na>mStartedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>theme</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>getThemeResource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>theme</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>activity</span><span class=p>.</span><span class=na>setTheme</span><span class=p>(</span><span class=n>theme</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>activity</span><span class=p>.</span><span class=na>mCalled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>isPersistable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnCreate</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnCreate</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>activity</span><span class=p>.</span><span class=na>mCalled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SuperNotCalledException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;Activity &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>toShortString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34; did not call through to super.onCreate()&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>activity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>stopped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>activity</span><span class=p>.</span><span class=na>performStart</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>stopped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>isPersistable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnRestoreInstanceState</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnRestoreInstanceState</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>activity</span><span class=p>.</span><span class=na>mCalled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>isPersistable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnPostCreate</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnPostCreate</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>activity</span><span class=p>.</span><span class=na>mCalled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SuperNotCalledException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34;Activity &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>toShortString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34; did not call through to super.onPostCreate()&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>paused</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mActivities</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>SuperNotCalledException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>onException</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;Unable to start activity &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>activity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>要启动的activity对象的创建等过程发生在<code>performLaunchActivity()</code>方法中：</p><ol><li>创建Context对象</li><li>创建Activity对象</li><li>创建Application对象</li><li>调用<code>Activity.attach()</code>方法，将Activity与Context及Application相关联。此处会创建Window，其实例时一个PhoneWindow对象。</li><li>调用Activity的<code>onCreate(), onStart()</code>生命周期回调。</li></ol><p>Activity.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>attach</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>ActivityThread</span><span class=w> </span><span class=n>aThread</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Instrumentation</span><span class=w> </span><span class=n>instr</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ident</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Application</span><span class=w> </span><span class=n>application</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CharSequence</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>parent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>NonConfigurationInstances</span><span class=w> </span><span class=n>lastNonConfigurationInstances</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>referrer</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Window</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>ActivityConfigCallback</span><span class=w> </span><span class=n>activityConfigCallback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>attachBaseContext</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mFragments</span><span class=p>.</span><span class=na>attachHost</span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=cm>/*parent*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PhoneWindow</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>activityConfigCallback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setWindowControllerCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setOnWindowDismissedCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>getLayoutInflater</span><span class=p>().</span><span class=na>setPrivateFactory</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_STATE_UNSPECIFIED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setSoftInputMode</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>softInputMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>uiOptions</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setUiOptions</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>uiOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mUiThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mMainThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>aThread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mInstrumentation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>instr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mIdent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ident</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mApplication</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>application</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mIntent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mReferrer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>referrer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mComponent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mActivityInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>info</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mTitle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>title</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mParent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mEmbeddedID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLastNonConfigurationInstances</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastNonConfigurationInstances</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>voiceInteractor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastNonConfigurationInstances</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mVoiceInteractor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastNonConfigurationInstances</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mVoiceInteractor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>VoiceInteractor</span><span class=p>(</span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Looper</span><span class=p>.</span><span class=na>myLooper</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setWindowManager</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>WindowManager</span><span class=p>)</span><span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>WINDOW_SERVICE</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mToken</span><span class=p>,</span><span class=w> </span><span class=n>mComponent</span><span class=p>.</span><span class=na>flattenToString</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ActivityInfo</span><span class=p>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mParent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setContainer</span><span class=p>(</span><span class=n>mParent</span><span class=p>.</span><span class=na>getWindow</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindowManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>getWindowManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mCurrentConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWidow</span><span class=p>.</span><span class=na>setColorMode</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>colorMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ActivityThread在<code>performLaunchActivity()</code>返回后，接着调用<code>handleResumeActivity()</code>, 这里会先调用<code>performResumeActivity()</code>进行生命周期回调，至此，启动到可见的全部生命周期回调完毕。
ActivityThread.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleResumeActivity</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>clearHide</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isForward</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>reallyResume</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>seq</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>reason</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActivities</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>checkAndUpdateLifecycleSeq</span><span class=p>(</span><span class=n>seq</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=s>&#34;resumeActivity&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If we are getting ready to gc after going to the background, well</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// we are back active so skip it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unscheduleGcIdler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mSomeActivitiesChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// TODO Push resumeArgs into the activity for consideration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>performResumeActivity</span><span class=p>(</span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>clearHide</span><span class=p>,</span><span class=w> </span><span class=n>reason</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Resume &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; started activity: &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>a</span><span class=p>.</span><span class=na>mStartedActivity</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, hideForNow: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>hideForNow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, finished: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>mFinished</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>forwardBit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isForward</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the window hasn&#39;t yet been added to the window manager,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// and this guy didn&#39;t finish itself or start another activity,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// then go ahead and add the window.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>willBeVisible</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>a</span><span class=p>.</span><span class=na>mStartedActivity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>willBeVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>willBeVisible</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>().</span><span class=na>willActivityBeVisible</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>a</span><span class=p>.</span><span class=na>getActivityToken</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>a</span><span class=p>.</span><span class=na>mFinished</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>willBeVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>getWindow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>View</span><span class=w> </span><span class=n>decor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getDecorView</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>decor</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>View</span><span class=p>.</span><span class=na>INVISIBLE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ViewManager</span><span class=w> </span><span class=n>wm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>getWindowManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>a</span><span class=p>.</span><span class=na>mDecor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>l</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>TYPE_BASE_APPLICATION</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>forwardBit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>mPreserveWindow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>a</span><span class=p>.</span><span class=na>mWindowAdded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>mPreserveWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Normally the ViewRoot sets up callbacks with the Activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// in addView-&gt;ViewRootImpl#setView. If we are instead reusing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// the decor view we have to notify the view root that the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// callbacks may have changed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ViewRootImpl</span><span class=w> </span><span class=n>impl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decor</span><span class=p>.</span><span class=na>getViewRootImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>impl</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>impl</span><span class=p>.</span><span class=na>notifyChildRebuilt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=na>mVisibleFromClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>a</span><span class=p>.</span><span class=na>mWindowAdded</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>a</span><span class=p>.</span><span class=na>mWindowAdded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>wm</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>decor</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// The activity will get a callback for this {@link LayoutParams} change</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// earlier. However, at that time the decor will not be set (this is set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// in this method), so no action will be taken. This call ensures the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// callback occurs with the decor set.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>a</span><span class=p>.</span><span class=na>onWindowAttributesChanged</span><span class=p>(</span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the window has already been added, but during resume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// we started another activity, then don&#39;t yet make the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// window visible.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>willBeVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Launch &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; mStartedActivity set&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>hideForNow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Get rid of anything left hanging around.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cleanUpPendingRemoveWindows</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/* force */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// The window is now visible if it has been added, we are not</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// simply finishing, and we are not starting another activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>willBeVisible</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mDecor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>hideForNow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>newConfig</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>performConfigurationChangedForActivity</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>newConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_CONFIGURATION</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Resuming activity &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; with newConfig &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mCurrentConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>newConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Resuming &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; with isForward=&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>isForward</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>!=</span><span class=w> </span><span class=n>forwardBit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>|</span><span class=w> </span><span class=n>forwardBit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mVisibleFromClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ViewManager</span><span class=w> </span><span class=n>wm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>getWindowManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>View</span><span class=w> </span><span class=n>decor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getDecorView</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>wm</span><span class=p>.</span><span class=na>updateViewLayout</span><span class=p>(</span><span class=n>decor</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mVisibleFromServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mNumVisibleActivities</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mVisibleFromClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>makeVisible</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>onlyLocalRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>nextIdle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mNewActivities</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mNewActivities</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Scheduling idle handler for &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Looper</span><span class=p>.</span><span class=na>myQueue</span><span class=p>().</span><span class=na>addIdleHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Idler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>onlyLocalRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Tell the activity manager we have resumed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reallyResume</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>().</span><span class=na>activityResumed</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If an exception was thrown when trying to resume, then</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// just end this activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>finishActivity</span><span class=p>(</span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=p>.</span><span class=na>RESULT_CANCELED</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Activity</span><span class=p>.</span><span class=na>DONT_FINISH_TASK_WITH_ACTIVITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=nf>performResumeActivity</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>clearHide</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>reason</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActivities</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Performing resume of &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; finished=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>clearHide</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>hideForNow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mStartedActivity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>onStateNotSaved</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFragments</span><span class=p>.</span><span class=na>noteStateNotSaved</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>checkAndBlockForNetworkAccess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>pendingIntents</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>deliverNewIntents</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>pendingIntents</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>pendingIntents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>pendingResults</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>deliverResults</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>pendingResults</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>pendingResults</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>performResume</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mResourcesManager</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// If there is a pending local relaunch that was requested when the activity was</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// paused, it will put the activity into paused state when it finally happens.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Since the activity resumed before being relaunched, we don&#39;t want that to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// happen, so we need to clear the request to relaunch paused.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRelaunchingActivities</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>--</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>relaunching</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRelaunchingActivities</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>relaunching</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>relaunching</span><span class=p>.</span><span class=na>onlyLocalRequest</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>relaunching</span><span class=p>.</span><span class=na>startsNotResumed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>relaunching</span><span class=p>.</span><span class=na>startsNotResumed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>EventLog</span><span class=p>.</span><span class=na>writeEvent</span><span class=p>(</span><span class=n>LOG_AM_ON_RESUME_CALLED</span><span class=p>,</span><span class=w> </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>myUserId</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>getComponentName</span><span class=p>().</span><span class=na>getClassName</span><span class=p>(),</span><span class=w> </span><span class=n>reason</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>paused</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>stopped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>onException</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;Unable to resume activity &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>toShortString</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://epicmars.github.io/>AndroidPi</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 8" fill="currentcolor"><path d="M12 8H0l6-8z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>