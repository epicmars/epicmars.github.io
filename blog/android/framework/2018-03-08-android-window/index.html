<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Window与WindowManager机制 | AndroidPi</title>
<meta name=keywords content><meta name=description content="接着Activity的启动流程分析Window的添加过程，与Activity相关联的window的创建发生在Activity.performLaunchActivity()方法中，当activity实例创建后，会调用该activity的attach()方法，该方法中会创建window的实例，它是一个PhoneWindow对象，但此时该window实例还未设置布局，也未添加到WindowManager中：
Activity.java
final void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor, Window window, ActivityConfigCallback activityConfigCallback) { attachBaseContext(context); mFragments.attachHost(null /*parent*/); mWindow = new PhoneWindow(this, window, activityConfigCallback); mWindow.setWindowControllerCallback(this); mWindow.setCallback(this); mWindow.setOnWindowDismissedCallback(this); mWindow.getLayoutInflater().setPrivateFactory(this); if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) { mWindow.setSoftInputMode(info.softInputMode); } if (info.uiOptions != 0) { mWindow.setUiOptions(info.uiOptions); } mUiThread = Thread.currentThread(); mMainThread = aThread; mInstrumentation = instr; mToken = token; mIdent = ident; mApplication = application; mIntent = intent; mReferrer = referrer; mComponent = intent."><meta name=author content="LEOY"><link rel=canonical href=https://epicmars.github.io/blog/android/framework/2018-03-08-android-window/><link crossorigin=anonymous href=/assets/css/stylesheet.3045213cee0439fa94bd732879be5b19072f75f4d28f6e62dd58c34f5243e49f.css integrity="sha256-MEUhPO4EOfqUvXMoeb5bGQcvdfTSj25i3VjDT1JD5J8=" rel="preload stylesheet" as=style><link rel=icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=icon type=image/png sizes=16x16 href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=icon type=image/png sizes=32x32 href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg%22><link rel=apple-touch-icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=mask-icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://epicmars.github.io/blog/android/framework/2018-03-08-android-window/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script defer crossorigin=anonymous src=/js/custom.f20a5212619392e989b6d24ad9ce42302014debfad4d3c8c01db030c36d03475.js integrity="sha256-8gpSEmGTkumJttJK2c5CMCAU3r+tTTyMAdsDDDbQNHU="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css integrity=sha384-Juol1FqnotbkyZUT5Z7gUPjQ9gzlwCENvUZTpQBAPxtusdwFLRy382PSDx5UUJ4/ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.js integrity=sha384-97gW6UIJxnlKemYavrqDHSX3SiygeOwIZhwyOKRfSaf0JWKRVj9hLASHgFTzT+0O crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-NMEMBZ8R90"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NMEMBZ8R90")}</script><meta property="og:title" content="Window与WindowManager机制"><meta property="og:description" content="接着Activity的启动流程分析Window的添加过程，与Activity相关联的window的创建发生在Activity.performLaunchActivity()方法中，当activity实例创建后，会调用该activity的attach()方法，该方法中会创建window的实例，它是一个PhoneWindow对象，但此时该window实例还未设置布局，也未添加到WindowManager中：
Activity.java
final void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor, Window window, ActivityConfigCallback activityConfigCallback) { attachBaseContext(context); mFragments.attachHost(null /*parent*/); mWindow = new PhoneWindow(this, window, activityConfigCallback); mWindow.setWindowControllerCallback(this); mWindow.setCallback(this); mWindow.setOnWindowDismissedCallback(this); mWindow.getLayoutInflater().setPrivateFactory(this); if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) { mWindow.setSoftInputMode(info.softInputMode); } if (info.uiOptions != 0) { mWindow.setUiOptions(info.uiOptions); } mUiThread = Thread.currentThread(); mMainThread = aThread; mInstrumentation = instr; mToken = token; mIdent = ident; mApplication = application; mIntent = intent; mReferrer = referrer; mComponent = intent."><meta property="og:type" content="article"><meta property="og:url" content="https://epicmars.github.io/blog/android/framework/2018-03-08-android-window/"><meta property="og:image" content="https://epicmars.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="blog"><meta property="article:published_time" content="2018-03-10T22:22:08+08:00"><meta property="article:modified_time" content="2018-03-10T22:22:08+08:00"><meta property="og:site_name" content="androidpi"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://epicmars.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Window与WindowManager机制"><meta name=twitter:description content="接着Activity的启动流程分析Window的添加过程，与Activity相关联的window的创建发生在Activity.performLaunchActivity()方法中，当activity实例创建后，会调用该activity的attach()方法，该方法中会创建window的实例，它是一个PhoneWindow对象，但此时该window实例还未设置布局，也未添加到WindowManager中：
Activity.java
final void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor, Window window, ActivityConfigCallback activityConfigCallback) { attachBaseContext(context); mFragments.attachHost(null /*parent*/); mWindow = new PhoneWindow(this, window, activityConfigCallback); mWindow.setWindowControllerCallback(this); mWindow.setCallback(this); mWindow.setOnWindowDismissedCallback(this); mWindow.getLayoutInflater().setPrivateFactory(this); if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) { mWindow.setSoftInputMode(info.softInputMode); } if (info.uiOptions != 0) { mWindow.setUiOptions(info.uiOptions); } mUiThread = Thread.currentThread(); mMainThread = aThread; mInstrumentation = instr; mToken = token; mIdent = ident; mApplication = application; mIntent = intent; mReferrer = referrer; mComponent = intent."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://epicmars.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Android","item":"https://epicmars.github.io/blog/android/"},{"@type":"ListItem","position":3,"name":"Window与WindowManager机制","item":"https://epicmars.github.io/blog/android/framework/2018-03-08-android-window/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Window与WindowManager机制","name":"Window与WindowManager机制","description":"接着Activity的启动流程分析Window的添加过程，与Activity相关联的window的创建发生在Activity.performLaunchActivity()方法中，当activity实例创建后，会调用该activity的attach()方法，该方法中会创建window的实例，它是一个PhoneWindow对象，但此时该window实例还未设置布局，也未添加到WindowManager中：\nActivity.java\nfinal void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor, Window window, ActivityConfigCallback activityConfigCallback) { attachBaseContext(context); mFragments.attachHost(null /*parent*/); mWindow = new PhoneWindow(this, window, activityConfigCallback); mWindow.setWindowControllerCallback(this); mWindow.setCallback(this); mWindow.setOnWindowDismissedCallback(this); mWindow.getLayoutInflater().setPrivateFactory(this); if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) { mWindow.setSoftInputMode(info.softInputMode); } if (info.uiOptions != 0) { mWindow.setUiOptions(info.uiOptions); } mUiThread = Thread.currentThread(); mMainThread = aThread; mInstrumentation = instr; mToken = token; mIdent = ident; mApplication = application; mIntent = intent; mReferrer = referrer; mComponent = intent.","keywords":[],"articleBody":"接着Activity的启动流程分析Window的添加过程，与Activity相关联的window的创建发生在Activity.performLaunchActivity()方法中，当activity实例创建后，会调用该activity的attach()方法，该方法中会创建window的实例，它是一个PhoneWindow对象，但此时该window实例还未设置布局，也未添加到WindowManager中：\nActivity.java\nfinal void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor, Window window, ActivityConfigCallback activityConfigCallback) { attachBaseContext(context); mFragments.attachHost(null /*parent*/); mWindow = new PhoneWindow(this, window, activityConfigCallback); mWindow.setWindowControllerCallback(this); mWindow.setCallback(this); mWindow.setOnWindowDismissedCallback(this); mWindow.getLayoutInflater().setPrivateFactory(this); if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) { mWindow.setSoftInputMode(info.softInputMode); } if (info.uiOptions != 0) { mWindow.setUiOptions(info.uiOptions); } mUiThread = Thread.currentThread(); mMainThread = aThread; mInstrumentation = instr; mToken = token; mIdent = ident; mApplication = application; mIntent = intent; mReferrer = referrer; mComponent = intent.getComponent(); mActivityInfo = info; mTitle = title; mParent = parent; mEmbeddedID = id; mLastNonConfigurationInstances = lastNonConfigurationInstances; if (voiceInteractor != null) { if (lastNonConfigurationInstances != null) { mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor; } else { mVoiceInteractor = new VoiceInteractor(voiceInteractor, this, this, Looper.myLooper()); } } mWindow.setWindowManager( (WindowManager)context.getSystemService(Context.WINDOW_SERVICE), mToken, mComponent.flattenToString(), (info.flags \u0026 ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0); if (mParent != null) { mWindow.setContainer(mParent.getWindow()); } mWindowManager = mWindow.getWindowManager(); mCurrentConfig = config; mWidow.setColorMode(info.colorMode); } 这是通过Window.setWindowManager()设置该Window的WindowManager，它是一个WindowManagerImpl实例，它也被赋值给Activity的mWindowManager，并且通过Activity.getSystemService(@ServiceName @NonNull String name)方法返回的就是该WindowManager。\nWindow.java\n/** * Set the window manager for use by this Window to, for example, * display panels. This is not used for displaying the * Window itself -- that must be done by the client. * * @param wm The window manager for adding new windows. */ public void setWindowManager(WindowManager wm, IBinder appToken, String appName, boolean hardwareAccelerated) { mAppToken = appToken; mAppName = appName; mHardwareAccelerated = hardwareAccelerated || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, false); if (wm == null) { wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE); } mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(this); } 随后在Activity的onCreate()方法中通过setContentView为window对象设置了一个布局。onResume生命周期回调后，采用使用WindowManager将Window真正添加到其中。这里可以发现，如果不指定要设置的布局参数，它会将View的布局参数设置为new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT)，这也是为什么在使用DialogFragment时，通过onCreateView创建的视图的根结点布局参数会被覆盖。\nPhoneWindow.java\n@Override public void setContentView(View view) { setContentView(view, new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT)); } ActivityThread.java\nfinal void handleResumeActivity(IBinder token, boolean clearHide, boolean isForward, boolean reallyResume, int seq, String reason) { ActivityClientRecord r = mActivities.get(token); if (!checkAndUpdateLifecycleSeq(seq, r, \"resumeActivity\")) { return; } // If we are getting ready to gc after going to the background, well // we are back active so skip it. unscheduleGcIdler(); mSomeActivitiesChanged = true; // TODO Push resumeArgs into the activity for consideration r = performResumeActivity(token, clearHide, reason); if (r != null) { final Activity a = r.activity; if (localLOGV) Slog.v( TAG, \"Resume \" + r + \" started activity: \" + a.mStartedActivity + \", hideForNow: \" + r.hideForNow + \", finished: \" + a.mFinished); final int forwardBit = isForward ? WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : 0; // If the window hasn't yet been added to the window manager, // and this guy didn't finish itself or start another activity, // then go ahead and add the window. boolean willBeVisible = !a.mStartedActivity; if (!willBeVisible) { try { willBeVisible = ActivityManager.getService().willActivityBeVisible( a.getActivityToken()); } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } if (r.window == null \u0026\u0026 !a.mFinished \u0026\u0026 willBeVisible) { // 拿到window r.window = r.activity.getWindow(); View decor = r.window.getDecorView(); decor.setVisibility(View.INVISIBLE); ViewManager wm = a.getWindowManager(); WindowManager.LayoutParams l = r.window.getAttributes(); a.mDecor = decor; l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION; l.softInputMode |= forwardBit; if (r.mPreserveWindow) { a.mWindowAdded = true; r.mPreserveWindow = false; // Normally the ViewRoot sets up callbacks with the Activity // in addView-\u003eViewRootImpl#setView. If we are instead reusing // the decor view we have to notify the view root that the // callbacks may have changed. ViewRootImpl impl = decor.getViewRootImpl(); if (impl != null) { impl.notifyChildRebuilt(); } } if (a.mVisibleFromClient) { if (!a.mWindowAdded) { a.mWindowAdded = true; // 添加window wm.addView(decor, l); } else { // The activity will get a callback for this {@link LayoutParams} change // earlier. However, at that time the decor will not be set (this is set // in this method), so no action will be taken. This call ensures the // callback occurs with the decor set. a.onWindowAttributesChanged(l); } } // If the window has already been added, but during resume // we started another activity, then don't yet make the // window visible. } else if (!willBeVisible) { if (localLOGV) Slog.v( TAG, \"Launch \" + r + \" mStartedActivity set\"); r.hideForNow = true; } // Get rid of anything left hanging around. cleanUpPendingRemoveWindows(r, false /* force */); // The window is now visible if it has been added, we are not // simply finishing, and we are not starting another activity. if (!r.activity.mFinished \u0026\u0026 willBeVisible \u0026\u0026 r.activity.mDecor != null \u0026\u0026 !r.hideForNow) { if (r.newConfig != null) { performConfigurationChangedForActivity(r, r.newConfig); if (DEBUG_CONFIGURATION) Slog.v(TAG, \"Resuming activity \" + r.activityInfo.name + \" with newConfig \" + r.activity.mCurrentConfig); r.newConfig = null; } if (localLOGV) Slog.v(TAG, \"Resuming \" + r + \" with isForward=\" + isForward); WindowManager.LayoutParams l = r.window.getAttributes(); if ((l.softInputMode \u0026 WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION) != forwardBit) { l.softInputMode = (l.softInputMode \u0026 (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)) | forwardBit; if (r.activity.mVisibleFromClient) { ViewManager wm = a.getWindowManager(); View decor = r.window.getDecorView(); wm.updateViewLayout(decor, l); } } r.activity.mVisibleFromServer = true; mNumVisibleActivities++; if (r.activity.mVisibleFromClient) { r.activity.makeVisible(); } } if (!r.onlyLocalRequest) { r.nextIdle = mNewActivities; mNewActivities = r; if (localLOGV) Slog.v( TAG, \"Scheduling idle handler for \" + r); Looper.myQueue().addIdleHandler(new Idler()); } r.onlyLocalRequest = false; // Tell the activity manager we have resumed. if (reallyResume) { try { ActivityManager.getService().activityResumed(token); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } } } else { // If an exception was thrown when trying to resume, then // just end this activity. try { ActivityManager.getService() .finishActivity(token, Activity.RESULT_CANCELED, null, Activity.DONT_FINISH_TASK_WITH_ACTIVITY); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } } } 现在我们聚焦到上面的wm.addView(decor, l)调用，其中当前Activity对应的Window，它是一个PhoneWindow实例，另外几个对象的实例定义如下：\nwm\n它是与Activity的Window对象持有的一个WindowManagerImpl实例\ndecor\n它是该PhoneWindow的DecorView\nl\n它是该PhoneWindow的布局参数，其默认值采用如下构造器进行初始化。\npublic interface WindowManager extends ViewManager { public static class LayoutParams extends ViewGroup.LayoutParams implements Parcelable { public LayoutParams() { super(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT); type = TYPE_APPLICATION; format = PixelFormat.OPAQUE; } } } 其中WindowManagerImpl用于为绑定到特定context、display或父window的操作提供与系统window manager进行低层级的通信，再看该它是如何添加视图的，可以发现它将添加的工作委托给了WindowManagerGlobal。\nWindowManagerImpl.java\n@Override public void addView(@NonNull View view, @NonNull ViewGroup.LayoutParams params) { applyDefaultToken(params); mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow); } WindowManagerGlobal是一个单例，与WindowManagerImpl相同的是，它也用于为各种操作提供与系统window manager进行低层级的通信。但不与特定的context相关。\nWindowManagerGlobal.java\npublic void addView(View view, ViewGroup.LayoutParams params, Display display, Window parentWindow) { if (view == null) { throw new IllegalArgumentException(\"view must not be null\"); } if (display == null) { throw new IllegalArgumentException(\"display must not be null\"); } if (!(params instanceof WindowManager.LayoutParams)) { throw new IllegalArgumentException(\"Params must be WindowManager.LayoutParams\"); } final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params; if (parentWindow != null) { parentWindow.adjustLayoutParamsForSubWindow(wparams); } else { // If there's no parent, then hardware acceleration for this view is // set from the application's hardware acceleration setting. final Context context = view.getContext(); if (context != null \u0026\u0026 (context.getApplicationInfo().flags \u0026 ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != 0) { wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED; } } ViewRootImpl root; View panelParentView = null; synchronized (mLock) { // Start watching for system property changes. if (mSystemPropertyUpdater == null) { mSystemPropertyUpdater = new Runnable() { @Override public void run() { synchronized (mLock) { for (int i = mRoots.size() - 1; i \u003e= 0; --i) { mRoots.get(i).loadSystemProperties(); } } } }; SystemProperties.addChangeCallback(mSystemPropertyUpdater); } int index = findViewLocked(view, false); if (index \u003e= 0) { if (mDyingViews.contains(view)) { // Don't wait for MSG_DIE to make it's way through root's queue. mRoots.get(index).doDie(); } else { throw new IllegalStateException(\"View \" + view + \" has already been added to the window manager.\"); } // The previous removeView() had not completed executing. Now it has. } // If this is a panel window, then find the window it is being // attached to for future reference. if (wparams.type \u003e= WindowManager.LayoutParams.FIRST_SUB_WINDOW \u0026\u0026 wparams.type \u003c= WindowManager.LayoutParams.LAST_SUB_WINDOW) { final int count = mViews.size(); for (int i = 0; i \u003c count; i++) { if (mRoots.get(i).mWindow.asBinder() == wparams.token) { panelParentView = mViews.get(i); } } } root = new ViewRootImpl(view.getContext(), display); view.setLayoutParams(wparams); mViews.add(view); mRoots.add(root); mParams.add(wparams); // do this last because it fires off messages to start doing things try { root.setView(view, wparams, panelParentView); } catch (RuntimeException e) { // BadTokenException or InvalidDisplayException, clean up. if (index \u003e= 0) { removeViewLocked(index, true); } throw e; } } } 可以发现它新建了一个ViewRootImpl实例，它将PhoneWindow的布局参数设置为DecorView的布局参数，然后调用ViewRootImpl.setView(View view, WindowManager.LayoutParams attrs, View panelParentView)方法。\nViewRootImpl.java\n/** * We have one child */ public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) { synchronized (this) { if (mView == null) { mView = view; mAttachInfo.mDisplayState = mDisplay.getState(); mDisplayManager.registerDisplayListener(mDisplayListener, mHandler); mViewLayoutDirectionInitial = mView.getRawLayoutDirection(); mFallbackEventHandler.setView(view); mWindowAttributes.copyFrom(attrs); if (mWindowAttributes.packageName == null) { mWindowAttributes.packageName = mBasePackageName; } attrs = mWindowAttributes; setTag(); if (DEBUG_KEEP_SCREEN_ON \u0026\u0026 (mClientWindowLayoutFlags \u0026 WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON) != 0 \u0026\u0026 (attrs.flags\u0026WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON) == 0) { Slog.d(mTag, \"setView: FLAG_KEEP_SCREEN_ON changed from true to false!\"); } // Keep track of the actual window flags supplied by the client. mClientWindowLayoutFlags = attrs.flags; setAccessibilityFocus(null, null); if (view instanceof RootViewSurfaceTaker) { mSurfaceHolderCallback = ((RootViewSurfaceTaker)view).willYouTakeTheSurface(); if (mSurfaceHolderCallback != null) { mSurfaceHolder = new TakenSurfaceHolder(); mSurfaceHolder.setFormat(PixelFormat.UNKNOWN); mSurfaceHolder.addCallback(mSurfaceHolderCallback); } } // Compute surface insets required to draw at specified Z value. // TODO: Use real shadow insets for a constant max Z. if (!attrs.hasManualSurfaceInsets) { attrs.setSurfaceInsets(view, false /*manual*/, true /*preservePrevious*/); } CompatibilityInfo compatibilityInfo = mDisplay.getDisplayAdjustments().getCompatibilityInfo(); mTranslator = compatibilityInfo.getTranslator(); // If the application owns the surface, don't enable hardware acceleration if (mSurfaceHolder == null) { enableHardwareAcceleration(attrs); } boolean restore = false; if (mTranslator != null) { mSurface.setCompatibilityTranslator(mTranslator); restore = true; attrs.backup(); mTranslator.translateWindowLayout(attrs); } if (DEBUG_LAYOUT) Log.d(mTag, \"WindowLayout in setView:\" + attrs); if (!compatibilityInfo.supportsScreen()) { attrs.privateFlags |= WindowManager.LayoutParams.PRIVATE_FLAG_COMPATIBLE_WINDOW; mLastInCompatMode = true; } mSoftInputMode = attrs.softInputMode; mWindowAttributesChanged = true; mWindowAttributesChangesFlag = WindowManager.LayoutParams.EVERYTHING_CHANGED; mAttachInfo.mRootView = view; mAttachInfo.mScalingRequired = mTranslator != null; mAttachInfo.mApplicationScale = mTranslator == null ? 1.0f : mTranslator.applicationScale; if (panelParentView != null) { mAttachInfo.mPanelParentWindowToken = panelParentView.getApplicationWindowToken(); } mAdded = true; int res; /* = WindowManagerImpl.ADD_OKAY; */ // Schedule the first layout -before- adding to the window // manager, to make sure we do the relayout before receiving // any other events from the system. requestLayout(); if ((mWindowAttributes.inputFeatures \u0026 WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == 0) { mInputChannel = new InputChannel(); } mForceDecorViewVisibility = (mWindowAttributes.privateFlags \u0026 PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY) != 0; try { mOrigWindowType = mWindowAttributes.type; mAttachInfo.mRecomputeGlobalAttributes = true; collectViewAttributes(); res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes getHostVisibility(), mDisplay.getDisplayId(), mAttachInfo.mContentInsets, mAttachInfo.mStableInsets, mAttachInfo.mOutsets, mInputChannel); } catch (RemoteException e) { mAdded = false; mView = null; mAttachInfo.mRootView = null; mInputChannel = null; mFallbackEventHandler.setView(null); unscheduleTraversals(); setAccessibilityFocus(null, null); throw new RuntimeException(\"Adding window failed\", e); } finally { if (restore) { attrs.restore(); } } if (mTranslator != null) { mTranslator.translateRectInScreenToAppWindow(mAttachInfo.mContentInsets); } mPendingOverscanInsets.set(0, 0, 0, 0); mPendingContentInsets.set(mAttachInfo.mContentInsets); mPendingStableInsets.set(mAttachInfo.mStableInsets); mPendingVisibleInsets.set(0, 0, 0, 0); mAttachInfo.mAlwaysConsumeNavBar = (res \u0026 WindowManagerGlobal.ADD_FLAG_ALWAYS_CONSUME_NAV_BAR) != 0; mPendingAlwaysConsumeNavBar = mAttachInfo.mAlwaysConsumeNavBar; if (DEBUG_LAYOUT) Log.v(mTag, \"Added window \" + mWindow); if (res \u003c WindowManagerGlobal.ADD_OKAY) { mAttachInfo.mRootView = null; mAdded = false; mFallbackEventHandler.setView(null); unscheduleTraversals(); setAccessibilityFocus(null, null); switch (res) { case WindowManagerGlobal.ADD_BAD_APP_TOKEN: case WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN: throw new WindowManager.BadTokenException( \"Unable to add window -- token \" + attrs.token + \" is not valid; is your activity running?\"); case WindowManagerGlobal.ADD_NOT_APP_TOKEN: throw new WindowManager.BadTokenException( \"Unable to add window -- token \" + attrs.token + \" is not for an application\"); case WindowManagerGlobal.ADD_APP_EXITING: throw new WindowManager.BadTokenException( \"Unable to add window -- app for token \" + attrs.token + \" is exiting\"); case WindowManagerGlobal.ADD_DUPLICATE_ADD: throw new WindowManager.BadTokenException( \"Unable to add window -- window \" + mWindow + \" has already been added\"); case WindowManagerGlobal.ADD_STARTING_NOT_NEEDED: // Silently ignore -- we would have just removed it // right away, anyway. return; case WindowManagerGlobal.ADD_MULTIPLE_SINGLETON: throw new WindowManager.BadTokenException(\"Unable to add window \" + mWindow + \" -- another window of type \" + mWindowAttributes.type + \" already exists\"); case WindowManagerGlobal.ADD_PERMISSION_DENIED: throw new WindowManager.BadTokenException(\"Unable to add window \" + mWindow + \" -- permission denied for window type \" + mWindowAttributes.type); case WindowManagerGlobal.ADD_INVALID_DISPLAY: throw new WindowManager.InvalidDisplayException(\"Unable to add window \" + mWindow + \" -- the specified display can not be found\"); case WindowManagerGlobal.ADD_INVALID_TYPE: throw new WindowManager.InvalidDisplayException(\"Unable to add window \" + mWindow + \" -- the specified window type \" + mWindowAttributes.type + \" is not valid\"); } throw new RuntimeException( \"Unable to add window -- unknown error code \" + res); } if (view instanceof RootViewSurfaceTaker) { mInputQueueCallback = ((RootViewSurfaceTaker)view).willYouTakeTheInputQueue(); } if (mInputChannel != null) { if (mInputQueueCallback != null) { mInputQueue = new InputQueue(); mInputQueueCallback.onInputQueueCreated(mInputQueue); } mInputEventReceiver = new WindowInputEventReceiver(mInputChannel, Looper.myLooper()); } view.assignParent(this); mAddedTouchMode = (res \u0026 WindowManagerGlobal.ADD_FLAG_IN_TOUCH_MODE) != 0; mAppVisible = (res \u0026 WindowManagerGlobal.ADD_FLAG_APP_VISIBLE) != 0; if (mAccessibilityManager.isEnabled()) { mAccessibilityInteractionConnectionManager.ensureConnection(); } if (view.getImportantForAccessibility() == View.IMPORTANT_FOR_ACCESSIBILITY_AUTO) { view.setImportantForAccessibility(View.IMPORTANT_FOR_ACCESSIBILITY_YES); } // Set up the input pipeline. CharSequence counterSuffix = attrs.getTitle(); mSyntheticInputStage = new SyntheticInputStage(); InputStage viewPostImeStage = new ViewPostImeInputStage(mSyntheticInputStage); InputStage nativePostImeStage = new NativePostImeInputStage(viewPostImeStage, \"aq:native-post-ime:\" + counterSuffix); InputStage earlyPostImeStage = new EarlyPostImeInputStage(nativePostImeStage); InputStage imeStage = new ImeInputStage(earlyPostImeStage, \"aq:ime:\" + counterSuffix); InputStage viewPreImeStage = new ViewPreImeInputStage(imeStage); InputStage nativePreImeStage = new NativePreImeInputStage(viewPreImeStage, \"aq:native-pre-ime:\" + counterSuffix); mFirstInputStage = nativePreImeStage; mFirstPostImeInputStage = earlyPostImeStage; mPendingInputEventQueueLengthCounterName = \"aq:pending:\" + counterSuffix; } } } @Override public void requestLayout() { if (!mHandlingLayoutInLayoutRequest) { checkThread(); mLayoutRequested = true; scheduleTraversals(); } } 最终调用到ViewRootImpl的requestLayout()进行首次布局遍历，完成布局的绘制。然后添加Window进行界面展示，这里拿到一个窗口会话WindowSession，并调用其addToDisplay方法：\nSession.java\n@Override public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs, int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets, Rect outOutsets, InputChannel outInputChannel) { return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId, outContentInsets, outStableInsets, outOutsets, outInputChannel); } 实际上调用到的是WindowManagerService的添加窗口的方法：\nWindowManagerService.java\npublic int addWindow(Session session, IWindow client, int seq, WindowManager.LayoutParams attrs, int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets, Rect outOutsets, InputChannel outInputChannel) { int[] appOp = new int[1]; int res = mPolicy.checkAddPermission(attrs, appOp); if (res != WindowManagerGlobal.ADD_OKAY) { return res; } boolean reportNewConfig = false; WindowState parentWindow = null; long origId; final int callingUid = Binder.getCallingUid(); final int type = attrs.type; synchronized(mWindowMap) { if (!mDisplayReady) { throw new IllegalStateException(\"Display has not been initialialized\"); } final DisplayContent displayContent = mRoot.getDisplayContentOrCreate(displayId); if (displayContent == null) { Slog.w(TAG_WM, \"Attempted to add window to a display that does not exist: \" + displayId + \". Aborting.\"); return WindowManagerGlobal.ADD_INVALID_DISPLAY; } if (!displayContent.hasAccess(session.mUid) \u0026\u0026 !mDisplayManagerInternal.isUidPresentOnDisplay(session.mUid, displayId)) { Slog.w(TAG_WM, \"Attempted to add window to a display for which the application \" + \"does not have access: \" + displayId + \". Aborting.\"); return WindowManagerGlobal.ADD_INVALID_DISPLAY; } if (mWindowMap.containsKey(client.asBinder())) { Slog.w(TAG_WM, \"Window \" + client + \" is already added\"); return WindowManagerGlobal.ADD_DUPLICATE_ADD; } if (type \u003e= FIRST_SUB_WINDOW \u0026\u0026 type \u003c= LAST_SUB_WINDOW) { parentWindow = windowForClientLocked(null, attrs.token, false); if (parentWindow == null) { Slog.w(TAG_WM, \"Attempted to add window with token that is not a window: \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN; } if (parentWindow.mAttrs.type \u003e= FIRST_SUB_WINDOW \u0026\u0026 parentWindow.mAttrs.type \u003c= LAST_SUB_WINDOW) { Slog.w(TAG_WM, \"Attempted to add window with token that is a sub-window: \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN; } } if (type == TYPE_PRIVATE_PRESENTATION \u0026\u0026 !displayContent.isPrivate()) { Slog.w(TAG_WM, \"Attempted to add private presentation window to a non-private display. Aborting.\"); return WindowManagerGlobal.ADD_PERMISSION_DENIED; } AppWindowToken atoken = null; final boolean hasParent = parentWindow != null; // Use existing parent window token for child windows since they go in the same token // as there parent window so we can apply the same policy on them. WindowToken token = displayContent.getWindowToken( hasParent ? parentWindow.mAttrs.token : attrs.token); // If this is a child window, we want to apply the same type checking rules as the // parent window type. final int rootType = hasParent ? parentWindow.mAttrs.type : type; boolean addToastWindowRequiresToken = false; if (token == null) { if (rootType \u003e= FIRST_APPLICATION_WINDOW \u0026\u0026 rootType \u003c= LAST_APPLICATION_WINDOW) { Slog.w(TAG_WM, \"Attempted to add application window with unknown token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } if (rootType == TYPE_INPUT_METHOD) { Slog.w(TAG_WM, \"Attempted to add input method window with unknown token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } if (rootType == TYPE_VOICE_INTERACTION) { Slog.w(TAG_WM, \"Attempted to add voice interaction window with unknown token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } if (rootType == TYPE_WALLPAPER) { Slog.w(TAG_WM, \"Attempted to add wallpaper window with unknown token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } if (rootType == TYPE_DREAM) { Slog.w(TAG_WM, \"Attempted to add Dream window with unknown token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } if (rootType == TYPE_QS_DIALOG) { Slog.w(TAG_WM, \"Attempted to add QS dialog window with unknown token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } if (rootType == TYPE_ACCESSIBILITY_OVERLAY) { Slog.w(TAG_WM, \"Attempted to add Accessibility overlay window with unknown token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } if (type == TYPE_TOAST) { // Apps targeting SDK above N MR1 cannot arbitrary add toast windows. if (doesAddToastWindowRequireToken(attrs.packageName, callingUid, parentWindow)) { Slog.w(TAG_WM, \"Attempted to add a toast window with unknown token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } } final IBinder binder = attrs.token != null ? attrs.token : client.asBinder(); token = new WindowToken(this, binder, type, false, displayContent, session.mCanAddInternalSystemWindow); } else if (rootType \u003e= FIRST_APPLICATION_WINDOW \u0026\u0026 rootType \u003c= LAST_APPLICATION_WINDOW) { atoken = token.asAppWindowToken(); if (atoken == null) { Slog.w(TAG_WM, \"Attempted to add window with non-application token \" + token + \". Aborting.\"); return WindowManagerGlobal.ADD_NOT_APP_TOKEN; } else if (atoken.removed) { Slog.w(TAG_WM, \"Attempted to add window with exiting application token \" + token + \". Aborting.\"); return WindowManagerGlobal.ADD_APP_EXITING; } } else if (rootType == TYPE_INPUT_METHOD) { if (token.windowType != TYPE_INPUT_METHOD) { Slog.w(TAG_WM, \"Attempted to add input method window with bad token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } } else if (rootType == TYPE_VOICE_INTERACTION) { if (token.windowType != TYPE_VOICE_INTERACTION) { Slog.w(TAG_WM, \"Attempted to add voice interaction window with bad token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } } else if (rootType == TYPE_WALLPAPER) { if (token.windowType != TYPE_WALLPAPER) { Slog.w(TAG_WM, \"Attempted to add wallpaper window with bad token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } } else if (rootType == TYPE_DREAM) { if (token.windowType != TYPE_DREAM) { Slog.w(TAG_WM, \"Attempted to add Dream window with bad token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } } else if (rootType == TYPE_ACCESSIBILITY_OVERLAY) { if (token.windowType != TYPE_ACCESSIBILITY_OVERLAY) { Slog.w(TAG_WM, \"Attempted to add Accessibility overlay window with bad token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } } else if (type == TYPE_TOAST) { // Apps targeting SDK above N MR1 cannot arbitrary add toast windows. addToastWindowRequiresToken = doesAddToastWindowRequireToken(attrs.packageName, callingUid, parentWindow); if (addToastWindowRequiresToken \u0026\u0026 token.windowType != TYPE_TOAST) { Slog.w(TAG_WM, \"Attempted to add a toast window with bad token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } } else if (type == TYPE_QS_DIALOG) { if (token.windowType != TYPE_QS_DIALOG) { Slog.w(TAG_WM, \"Attempted to add QS dialog window with bad token \" + attrs.token + \". Aborting.\"); return WindowManagerGlobal.ADD_BAD_APP_TOKEN; } } else if (token.asAppWindowToken() != null) { Slog.w(TAG_WM, \"Non-null appWindowToken for system window of rootType=\" + rootType); // It is not valid to use an app token with other system types; we will // instead make a new token for it (as if null had been passed in for the token). attrs.token = null; token = new WindowToken(this, client.asBinder(), type, false, displayContent, session.mCanAddInternalSystemWindow); } final WindowState win = new WindowState(this, session, client, token, parentWindow, appOp[0], seq, attrs, viewVisibility, session.mUid, session.mCanAddInternalSystemWindow); if (win.mDeathRecipient == null) { // Client has apparently died, so there is no reason to // continue. Slog.w(TAG_WM, \"Adding window client \" + client.asBinder() + \" that is dead, aborting.\"); return WindowManagerGlobal.ADD_APP_EXITING; } if (win.getDisplayContent() == null) { Slog.w(TAG_WM, \"Adding window to Display that has been removed.\"); return WindowManagerGlobal.ADD_INVALID_DISPLAY; } mPolicy.adjustWindowParamsLw(win.mAttrs); win.setShowToOwnerOnlyLocked(mPolicy.checkShowToOwnerOnly(attrs)); res = mPolicy.prepareAddWindowLw(win, attrs); if (res != WindowManagerGlobal.ADD_OKAY) { return res; } final boolean openInputChannels = (outInputChannel != null \u0026\u0026 (attrs.inputFeatures \u0026 INPUT_FEATURE_NO_INPUT_CHANNEL) == 0); if (openInputChannels) { win.openInputChannel(outInputChannel); } // If adding a toast requires a token for this app we always schedule hiding // toast windows to make sure they don't stick around longer then necessary. // We hide instead of remove such windows as apps aren't prepared to handle // windows being removed under them. // // If the app is older it can add toasts without a token and hence overlay // other apps. To be maximally compatible with these apps we will hide the // window after the toast timeout only if the focused window is from another // UID, otherwise we allow unlimited duration. When a UID looses focus we // schedule hiding all of its toast windows. if (type == TYPE_TOAST) { if (!getDefaultDisplayContentLocked().canAddToastWindowForUid(callingUid)) { Slog.w(TAG_WM, \"Adding more than one toast window for UID at a time.\"); return WindowManagerGlobal.ADD_DUPLICATE_ADD; } // Make sure this happens before we moved focus as one can make the // toast focusable to force it not being hidden after the timeout. // Focusable toasts are always timed out to prevent a focused app to // show a focusable toasts while it has focus which will be kept on // the screen after the activity goes away. if (addToastWindowRequiresToken || (attrs.flags \u0026 LayoutParams.FLAG_NOT_FOCUSABLE) == 0 || mCurrentFocus == null || mCurrentFocus.mOwnerUid != callingUid) { mH.sendMessageDelayed( mH.obtainMessage(H.WINDOW_HIDE_TIMEOUT, win), win.mAttrs.hideTimeoutMilliseconds); } } // From now on, no exceptions or errors allowed! res = WindowManagerGlobal.ADD_OKAY; if (mCurrentFocus == null) { mWinAddedSinceNullFocus.add(win); } if (excludeWindowTypeFromTapOutTask(type)) { displayContent.mTapExcludedWindows.add(win); } origId = Binder.clearCallingIdentity(); win.attach(); mWindowMap.put(client.asBinder(), win); if (win.mAppOp != AppOpsManager.OP_NONE) { int startOpResult = mAppOps.startOpNoThrow(win.mAppOp, win.getOwningUid(), win.getOwningPackage()); if ((startOpResult != AppOpsManager.MODE_ALLOWED) \u0026\u0026 (startOpResult != AppOpsManager.MODE_DEFAULT)) { win.setAppOpVisibilityLw(false); } } final boolean hideSystemAlertWindows = !mHidingNonSystemOverlayWindows.isEmpty(); win.setForceHideNonSystemOverlayWindowIfNeeded(hideSystemAlertWindows); final AppWindowToken aToken = token.asAppWindowToken(); if (type == TYPE_APPLICATION_STARTING \u0026\u0026 aToken != null) { aToken.startingWindow = win; if (DEBUG_STARTING_WINDOW) Slog.v (TAG_WM, \"addWindow: \" + aToken + \" startingWindow=\" + win); } boolean imMayMove = true; win.mToken.addWindow(win); if (type == TYPE_INPUT_METHOD) { win.mGivenInsetsPending = true; setInputMethodWindowLocked(win); imMayMove = false; } else if (type == TYPE_INPUT_METHOD_DIALOG) { displayContent.computeImeTarget(true /* updateImeTarget */); imMayMove = false; } else { if (type == TYPE_WALLPAPER) { displayContent.mWallpaperController.clearLastWallpaperTimeoutTime(); displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER; } else if ((attrs.flags\u0026FLAG_SHOW_WALLPAPER) != 0) { displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER; } else if (displayContent.mWallpaperController.isBelowWallpaperTarget(win)) { // If there is currently a wallpaper being shown, and // the base layer of the new window is below the current // layer of the target window, then adjust the wallpaper. // This is to avoid a new window being placed between the // wallpaper and its target. displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER; } } // If the window is being added to a stack that's currently adjusted for IME, // make sure to apply the same adjust to this new window. win.applyAdjustForImeIfNeeded(); if (type == TYPE_DOCK_DIVIDER) { mRoot.getDisplayContent(displayId).getDockedDividerController().setWindow(win); } final WindowStateAnimator winAnimator = win.mWinAnimator; winAnimator.mEnterAnimationPending = true; winAnimator.mEnteringAnimation = true; // Check if we need to prepare a transition for replacing window first. if (atoken != null \u0026\u0026 atoken.isVisible() \u0026\u0026 !prepareWindowReplacementTransition(atoken)) { // If not, check if need to set up a dummy transition during display freeze // so that the unfreeze wait for the apps to draw. This might be needed if // the app is relaunching. prepareNoneTransitionForRelaunching(atoken); } if (displayContent.isDefaultDisplay) { final DisplayInfo displayInfo = displayContent.getDisplayInfo(); final Rect taskBounds; if (atoken != null \u0026\u0026 atoken.getTask() != null) { taskBounds = mTmpRect; atoken.getTask().getBounds(mTmpRect); } else { taskBounds = null; } if (mPolicy.getInsetHintLw(win.mAttrs, taskBounds, displayInfo.rotation, displayInfo.logicalWidth, displayInfo.logicalHeight, outContentInsets, outStableInsets, outOutsets)) { res |= WindowManagerGlobal.ADD_FLAG_ALWAYS_CONSUME_NAV_BAR; } } else { outContentInsets.setEmpty(); outStableInsets.setEmpty(); } if (mInTouchMode) { res |= WindowManagerGlobal.ADD_FLAG_IN_TOUCH_MODE; } if (win.mAppToken == null || !win.mAppToken.isClientHidden()) { res |= WindowManagerGlobal.ADD_FLAG_APP_VISIBLE; } mInputMonitor.setUpdateInputWindowsNeededLw(); boolean focusChanged = false; if (win.canReceiveKeys()) { focusChanged = updateFocusedWindowLocked(UPDATE_FOCUS_WILL_ASSIGN_LAYERS, false /*updateInputWindows*/); if (focusChanged) { imMayMove = false; } } if (imMayMove) { displayContent.computeImeTarget(true /* updateImeTarget */); } // Don't do layout here, the window must call // relayout to be displayed, so we'll do it there. displayContent.assignWindowLayers(false /* setLayoutNeeded */); if (focusChanged) { mInputMonitor.setInputFocusLw(mCurrentFocus, false /*updateInputWindows*/); } mInputMonitor.updateInputWindowsLw(false /*force*/); if (localLOGV || DEBUG_ADD_REMOVE) Slog.v(TAG_WM, \"addWindow: New client \" + client.asBinder() + \": window=\" + win + \" Callers=\" + Debug.getCallers(5)); if (win.isVisibleOrAdding() \u0026\u0026 updateOrientationFromAppTokensLocked(false, displayId)) { reportNewConfig = true; } } if (reportNewConfig) { sendNewConfiguration(displayId); } Binder.restoreCallingIdentity(origId); return res; } // TODO: Move to DisplayContent boolean updateFocusedWindowLocked(int mode, boolean updateInputWindows) { WindowState newFocus = mRoot.computeFocusedWindow(); if (mCurrentFocus != newFocus) { Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, \"wmUpdateFocus\"); // This check makes sure that we don't already have the focus // change message pending. mH.removeMessages(H.REPORT_FOCUS_CHANGE); mH.sendEmptyMessage(H.REPORT_FOCUS_CHANGE); // TODO(multidisplay): Focused windows on default display only. final DisplayContent displayContent = getDefaultDisplayContentLocked(); boolean imWindowChanged = false; if (mInputMethodWindow != null) { final WindowState prevTarget = mInputMethodTarget; final WindowState newTarget = displayContent.computeImeTarget(true /* updateImeTarget*/); imWindowChanged = prevTarget != newTarget; if (mode != UPDATE_FOCUS_WILL_ASSIGN_LAYERS \u0026\u0026 mode != UPDATE_FOCUS_WILL_PLACE_SURFACES) { final int prevImeAnimLayer = mInputMethodWindow.mWinAnimator.mAnimLayer; displayContent.assignWindowLayers(false /* setLayoutNeeded */); imWindowChanged |= prevImeAnimLayer != mInputMethodWindow.mWinAnimator.mAnimLayer; } } if (imWindowChanged) { mWindowsChanged = true; displayContent.setLayoutNeeded(); newFocus = mRoot.computeFocusedWindow(); } if (DEBUG_FOCUS_LIGHT || localLOGV) Slog.v(TAG_WM, \"Changing focus from \" + mCurrentFocus + \" to \" + newFocus + \" Callers=\" + Debug.getCallers(4)); final WindowState oldFocus = mCurrentFocus; mCurrentFocus = newFocus; mLosingFocus.remove(newFocus); if (mCurrentFocus != null) { mWinAddedSinceNullFocus.clear(); mWinRemovedSinceNullFocus.clear(); } int focusChanged = mPolicy.focusChangedLw(oldFocus, newFocus); if (imWindowChanged \u0026\u0026 oldFocus != mInputMethodWindow) { // Focus of the input method window changed. Perform layout if needed. if (mode == UPDATE_FOCUS_PLACING_SURFACES) { displayContent.performLayout(true /*initial*/, updateInputWindows); focusChanged \u0026= ~FINISH_LAYOUT_REDO_LAYOUT; } else if (mode == UPDATE_FOCUS_WILL_PLACE_SURFACES) { // Client will do the layout, but we need to assign layers // for handleNewWindowLocked() below. displayContent.assignWindowLayers(false /* setLayoutNeeded */); } } if ((focusChanged \u0026 FINISH_LAYOUT_REDO_LAYOUT) != 0) { // The change in focus caused us to need to do a layout. Okay. displayContent.setLayoutNeeded(); if (mode == UPDATE_FOCUS_PLACING_SURFACES) { displayContent.performLayout(true /*initial*/, updateInputWindows); } } if (mode != UPDATE_FOCUS_WILL_ASSIGN_LAYERS) { // If we defer assigning layers, then the caller is responsible for // doing this part. mInputMonitor.setInputFocusLw(mCurrentFocus, updateInputWindows); } displayContent.adjustForImeIfNeeded(); // We may need to schedule some toast windows to be removed. The toasts for an app that // does not have input focus are removed within a timeout to prevent apps to redress // other apps' UI. displayContent.scheduleToastWindowsTimeoutIfNeededLocked(oldFocus, newFocus); Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER); return true; } return false; } @Override public void handleMessage(Message msg) { if (DEBUG_WINDOW_TRACE) { Slog.v(TAG_WM, \"handleMessage: entry what=\" + msg.what); } switch (msg.what) { case REPORT_FOCUS_CHANGE: { WindowState lastFocus; WindowState newFocus; AccessibilityController accessibilityController = null; synchronized(mWindowMap) { // TODO(multidisplay): Accessibility supported only of default desiplay. if (mAccessibilityController != null \u0026\u0026 getDefaultDisplayContentLocked() .getDisplayId() == DEFAULT_DISPLAY) { accessibilityController = mAccessibilityController; } lastFocus = mLastFocus; newFocus = mCurrentFocus; if (lastFocus == newFocus) { // Focus is not changing, so nothing to do. return; } mLastFocus = newFocus; if (DEBUG_FOCUS_LIGHT) Slog.i(TAG_WM, \"Focus moving from \" + lastFocus + \" to \" + newFocus); if (newFocus != null \u0026\u0026 lastFocus != null \u0026\u0026 !newFocus.isDisplayedLw()) { //Slog.i(TAG_WM, \"Delaying loss of focus...\"); mLosingFocus.add(lastFocus); lastFocus = null; } } // First notify the accessibility manager for the change so it has // the windows before the newly focused one starts firing eventgs. if (accessibilityController != null) { accessibilityController.onWindowFocusChangedNotLocked(); } //System.out.println(\"Changing focus from \" + lastFocus // + \" to \" + newFocus); if (newFocus != null) { if (DEBUG_FOCUS_LIGHT) Slog.i(TAG_WM, \"Gaining focus: \" + newFocus); newFocus.reportFocusChangedSerialized(true, mInTouchMode); notifyFocusChanged(); } if (lastFocus != null) { if (DEBUG_FOCUS_LIGHT) Slog.i(TAG_WM, \"Losing focus: \" + lastFocus); lastFocus.reportFocusChangedSerialized(false, mInTouchMode); } } break; ... } } WindowState.java\n/** * Report a focus change. Must be called with no locks held, and consistently * from the same serialized thread (such as dispatched from a handler). */ void reportFocusChangedSerialized(boolean focused, boolean inTouchMode) { try { mClient.windowFocusChanged(focused, inTouchMode); } catch (RemoteException e) { } if (mFocusCallbacks != null) { final int N = mFocusCallbacks.beginBroadcast(); for (int i=0; i\u003cN; i++) { IWindowFocusObserver obs = mFocusCallbacks.getBroadcastItem(i); try { if (focused) { obs.focusGained(mWindowId.asBinder()); } else { obs.focusLost(mWindowId.asBinder()); } } catch (RemoteException e) { } } mFocusCallbacks.finishBroadcast(); } } IWindow.aidl\n/** * API back to a client window that the Window Manager uses to inform it of * interesting things happening. * * {@hide} */ oneway interface IWindow { /** * ===== NOTICE ===== * The first method must remain the first method. Scripts * and tools rely on their transaction number to work properly. */ /** * Invoked by the view server to tell a window to execute the specified * command. Any response from the receiver must be sent through the * specified file descriptor. */ void executeCommand(String command, String parameters, in ParcelFileDescriptor descriptor); void resized(in Rect frame, in Rect overscanInsets, in Rect contentInsets, in Rect visibleInsets, in Rect stableInsets, in Rect outsets, boolean reportDraw, in MergedConfiguration newMergedConfiguration, in Rect backDropFrame, boolean forceLayout, boolean alwaysConsumeNavBar, int displayId); void moved(int newX, int newY); void dispatchAppVisibility(boolean visible); void dispatchGetNewSurface(); /** * Tell the window that it is either gaining or losing focus. Keep it up * to date on the current state showing navigational focus (touch mode) too. */ void windowFocusChanged(boolean hasFocus, boolean inTouchMode) ... } ViewRootImpl#W.java\nstatic class W extends IWindow.Stub { ... @Override public void windowFocusChanged(boolean hasFocus, boolean inTouchMode) { final ViewRootImpl viewAncestor = mViewAncestor.get(); if (viewAncestor != null) { viewAncestor.windowFocusChanged(hasFocus, inTouchMode); } } ... } ViewRootImpl.java\npublic void windowFocusChanged(boolean hasFocus, boolean inTouchMode) { Message msg = Message.obtain(); msg.what = MSG_WINDOW_FOCUS_CHANGED; msg.arg1 = hasFocus ? 1 : 0; msg.arg2 = inTouchMode ? 1 : 0; mHandler.sendMessage(msg); } @Override public void handleMessage(Message msg) { switch (msg.what) { ... case MSG_WINDOW_FOCUS_CHANGED: { if (mAdded) { boolean hasWindowFocus = msg.arg1 != 0; mAttachInfo.mHasWindowFocus = hasWindowFocus; profileRendering(hasWindowFocus); if (hasWindowFocus) { boolean inTouchMode = msg.arg2 != 0; ensureTouchModeLocally(inTouchMode); if (mAttachInfo.mThreadedRenderer != null \u0026\u0026 mSurface.isValid()){ mFullRedrawNeeded = true; try { final WindowManager.LayoutParams lp = mWindowAttributes; final Rect surfaceInsets = lp != null ? lp.surfaceInsets : null; mAttachInfo.mThreadedRenderer.initializeIfNeeded( mWidth, mHeight, mAttachInfo, mSurface, surfaceInsets); } catch (OutOfResourcesException e) { Log.e(mTag, \"OutOfResourcesException locking surface\", e); try { if (!mWindowSession.outOfMemory(mWindow)) { Slog.w(mTag, \"No processes killed for memory; killing self\"); Process.killProcess(Process.myPid()); } } catch (RemoteException ex) { } // Retry in a bit. sendMessageDelayed(obtainMessage(msg.what, msg.arg1, msg.arg2), 500); return; } } } mLastWasImTarget = WindowManager.LayoutParams .mayUseInputMethod(mWindowAttributes.flags); InputMethodManager imm = InputMethodManager.peekInstance(); if (imm != null \u0026\u0026 mLastWasImTarget \u0026\u0026 !isInLocalFocusMode()) { imm.onPreWindowFocus(mView, hasWindowFocus); } if (mView != null) { mAttachInfo.mKeyDispatchState.reset(); mView.dispatchWindowFocusChanged(hasWindowFocus); mAttachInfo.mTreeObserver.dispatchOnWindowFocusChange(hasWindowFocus); if (mAttachInfo.mTooltipHost != null) { mAttachInfo.mTooltipHost.hideTooltip(); } } // Note: must be done after the focus change callbacks, // so all of the view state is set up correctly. if (hasWindowFocus) { if (imm != null \u0026\u0026 mLastWasImTarget \u0026\u0026 !isInLocalFocusMode()) { imm.onPostWindowFocus(mView, mView.findFocus(), mWindowAttributes.softInputMode, !mHasHadWindowFocus, mWindowAttributes.flags); } // Clear the forward bit. We can just do this directly, since // the window manager doesn't care about it. mWindowAttributes.softInputMode \u0026= ~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION; ((WindowManager.LayoutParams)mView.getLayoutParams()) .softInputMode \u0026= ~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION; mHasHadWindowFocus = true; } else { if (mPointerCapture) { handlePointerCaptureChanged(false); } } } } break; ... } } mView.dispatchWindowFocusChanged(hasWindowFocus)\nView.java\n/** * Called when the window containing this view gains or loses window focus. * ViewGroups should override to route to their children. * * @param hasFocus True if the window containing this view now has focus, * false otherwise. */ public void dispatchWindowFocusChanged(boolean hasFocus) { onWindowFocusChanged(hasFocus); } DecorView.java\n@Override public void onWindowFocusChanged(boolean hasWindowFocus) { super.onWindowFocusChanged(hasWindowFocus); // If the user is chording a menu shortcut, release the chord since // this window lost focus if (mWindow.hasFeature(Window.FEATURE_OPTIONS_PANEL) \u0026\u0026 !hasWindowFocus \u0026\u0026 mWindow.mPanelChordingKey != 0) { mWindow.closePanel(Window.FEATURE_OPTIONS_PANEL); } final Window.Callback cb = mWindow.getCallback(); if (cb != null \u0026\u0026 !mWindow.isDestroyed() \u0026\u0026 mFeatureId \u003c 0) { cb.onWindowFocusChanged(hasWindowFocus); } if (mPrimaryActionMode != null) { mPrimaryActionMode.onWindowFocusChanged(hasWindowFocus); } if (mFloatingActionMode != null) { mFloatingActionMode.onWindowFocusChanged(hasWindowFocus); } updateElevation(); } ","wordCount":"4947","inLanguage":"en","datePublished":"2018-03-10T22:22:08+08:00","dateModified":"2018-03-10T22:22:08+08:00","author":{"@type":"Person","name":"LEOY"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://epicmars.github.io/blog/android/framework/2018-03-08-android-window/"},"publisher":{"@type":"Organization","name":"AndroidPi","logo":{"@type":"ImageObject","url":"https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg"}}}</script></head><body id=top><script>const hasHeaderBg=!1</script><header class=header><div class=nav-container><nav class=nav><div class=logo><a href=/ accesskey=h title="AndroidPi (Alt + H)"><svg width="25" height="24" viewBox="0 0 25 24" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient x1="76.7202373%" y1="41.6070847%" x2="18.306123%" y2="65.5065085%" id="linearGradient-9_1k7ha4jv-1"><stop stop-color="#797beb" offset="0"/><stop stop-color="#373080" offset="100%"/></linearGradient></defs><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="_编组-7" fill="url(#linearGradient-9_1k7ha4jv-1)"><path d="M12.2746711.0C12.5125388.0 12.7434104.12583746 12.8693403.33556656l1.3852293 2.3769298h6.1425827C20.63502 2.71249636 20.8658915 2.83833382 20.9918215 3.04806292l1.7420308 2.97815322C22.8597822 6.23594524 22.8597822 6.5016021 22.7338523 6.7113312L22.6988718 6.76725896C22.6708873 6.80920478 22.6359068 6.8511506 22.5939301 6.88610545L21.2156969 9.24905331l3.050303 5.24322749L24.3429571 14.6041363C24.4339065 14.8138654 24.4548948 15.0795223 24.3919298 15.2682785l-1.6021086 2.7404602C22.6638912 18.2184678 22.4400158 18.3443053 22.195152 18.3443053L19.4176972 18.3582872 16.353402 23.6504515C16.227472 23.8601806 16.0035966 23.9860181 15.7587328 23.9860181L12.2886633 24H12.2396906C12.0158151 23.9860181 11.7989358 23.8601806 11.6869981 23.6644334l-1.490171-2.551704H4.13120166C4.0822289 21.1267113 4.04025225 21.1267113 3.9912795 21.1267113 3.75341183 21.1267113 3.52254028 21.0008739 3.39661034 20.7911448L1.79450165 18.0506845C1.66857171 17.8479464 1.66857171 17.5892805 1.79450165 17.3725604l1.37823324-2.3909117L.0944474553 9.69647539c-.1259299404-.20273813-.1259299404-.46140402.0-.678124089999999L1.80849387 6.02621614c.11193772-.2097291.34280928-.33556656.59466916-.33556656C2.466128 5.67666764 2.51510075 5.69064958 2.56407351 5.70463152H5.40449327L8.44080406.46140402C8.45479628.4194582 8.46179238.38450335 8.48278071.35653947L8.49677292.33556656C8.62270286.12583746 8.84657831.0 9.09144209.0H12.2816672 12.2746711zM9.04246933.72706088 5.74730256 6.41071949H2.3751786L8.93752771 17.6871541H5.59338819l-1.61610091 2.789397H10.5606247l1.6790659 2.8942616 6.5623491-11.3043985 1.6790659 2.8802797L23.7203035 14.9327119 20.4181406 9.24905331l1.6650737-2.8662977L9.00049268 6.39673755 10.6795586 3.51645791 9.04946544.72706088H9.04246933zM16.1435187 9.82930382 12.2187023 16.5755899 8.2938858 9.82930382h7.8496329z" id="_形状"/></g></g></svg></a><div class=logo-switches></div></div><ul id=menu><li><a href=/resources title=Resources><span>Resources</span></a></li><li><a href=/blog/ title=Blog><span>Blog</span></a></li><li><a href=/publication title=Publication><span>Publication</span></a></li><li><a href=/about title=About><span>About</span></a></li></ul></nav></div></header><div class=hero-container><div class=hero><h1 class=post-title>Window与WindowManager机制</h1><div class=post-meta><span title='2018-03-10 22:22:08 +0800 CST'>March 10, 2018</span>&nbsp;·&nbsp;24 min&nbsp;·&nbsp;4947 words&nbsp;·&nbsp;LEOY</div></div></div><main class=main><article class=post-single><div class=post-content><p>接着Activity的启动流程分析Window的添加过程，与Activity相关联的window的创建发生在<code>Activity.performLaunchActivity()</code>方法中，当activity实例创建后，会调用该activity的<code>attach()</code>方法，该方法中会创建window的实例，它是一个<code>PhoneWindow</code>对象，但此时该window实例还未设置布局，也未添加到WindowManager中：</p><p>Activity.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>attach</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>ActivityThread</span><span class=w> </span><span class=n>aThread</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Instrumentation</span><span class=w> </span><span class=n>instr</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ident</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Application</span><span class=w> </span><span class=n>application</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CharSequence</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>parent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>NonConfigurationInstances</span><span class=w> </span><span class=n>lastNonConfigurationInstances</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>referrer</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Window</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>ActivityConfigCallback</span><span class=w> </span><span class=n>activityConfigCallback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>attachBaseContext</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mFragments</span><span class=p>.</span><span class=na>attachHost</span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=cm>/*parent*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PhoneWindow</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>activityConfigCallback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setWindowControllerCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setOnWindowDismissedCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>getLayoutInflater</span><span class=p>().</span><span class=na>setPrivateFactory</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_STATE_UNSPECIFIED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setSoftInputMode</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>softInputMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>uiOptions</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setUiOptions</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>uiOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mUiThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mMainThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>aThread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mInstrumentation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>instr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mIdent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ident</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mApplication</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>application</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mIntent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mReferrer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>referrer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mComponent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mActivityInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>info</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mTitle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>title</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mParent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mEmbeddedID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLastNonConfigurationInstances</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastNonConfigurationInstances</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>voiceInteractor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastNonConfigurationInstances</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mVoiceInteractor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastNonConfigurationInstances</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mVoiceInteractor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>VoiceInteractor</span><span class=p>(</span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Looper</span><span class=p>.</span><span class=na>myLooper</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setWindowManager</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>WindowManager</span><span class=p>)</span><span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>WINDOW_SERVICE</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mToken</span><span class=p>,</span><span class=w> </span><span class=n>mComponent</span><span class=p>.</span><span class=na>flattenToString</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ActivityInfo</span><span class=p>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mParent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setContainer</span><span class=p>(</span><span class=n>mParent</span><span class=p>.</span><span class=na>getWindow</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindowManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>getWindowManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mCurrentConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWidow</span><span class=p>.</span><span class=na>setColorMode</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>colorMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这是通过<code>Window.setWindowManager()</code>设置该<code>Window</code>的<code>WindowManager</code>，它是一个<code>WindowManagerImpl</code>实例，它也被赋值给<code>Activity</code>的<code>mWindowManager</code>，并且通过<code>Activity.getSystemService(@ServiceName @NonNull String name)</code>方法返回的就是该<code>WindowManager</code>。</p><p>Window.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Set the window manager for use by this Window to, for example,
</span></span></span><span class=line><span class=cl><span class=cm>     * display panels.  This is &lt;em&gt;not&lt;/em&gt; used for displaying the
</span></span></span><span class=line><span class=cl><span class=cm>     * Window itself -- that must be done by the client.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param wm The window manager for adding new windows.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setWindowManager</span><span class=p>(</span><span class=n>WindowManager</span><span class=w> </span><span class=n>wm</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>appToken</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>appName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>hardwareAccelerated</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mAppToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>appToken</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mAppName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>appName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mHardwareAccelerated</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hardwareAccelerated</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>SystemProperties</span><span class=p>.</span><span class=na>getBoolean</span><span class=p>(</span><span class=n>PROPERTY_HARDWARE_UI</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>wm</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>wm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>WindowManager</span><span class=p>)</span><span class=n>mContext</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>WINDOW_SERVICE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindowManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>WindowManagerImpl</span><span class=p>)</span><span class=n>wm</span><span class=p>).</span><span class=na>createLocalWindowManager</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>随后在Activity的onCreate()方法中通过<code>setContentView</code>为window对象设置了一个布局。onResume生命周期回调后，采用使用WindowManager将Window真正添加到其中。这里可以发现，如果不指定要设置的布局参数，它会将View的布局参数设置为<code>new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT)</code>，这也是为什么在使用<code>DialogFragment</code>时，通过<code>onCreateView</code>创建的视图的根结点布局参数会被覆盖。</p><p>PhoneWindow.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setContentView</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setContentView</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>(</span><span class=n>MATCH_PARENT</span><span class=p>,</span><span class=w> </span><span class=n>MATCH_PARENT</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ActivityThread.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleResumeActivity</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>clearHide</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isForward</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>reallyResume</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>seq</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>reason</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActivities</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>checkAndUpdateLifecycleSeq</span><span class=p>(</span><span class=n>seq</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=s>&#34;resumeActivity&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If we are getting ready to gc after going to the background, well</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// we are back active so skip it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unscheduleGcIdler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mSomeActivitiesChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// TODO Push resumeArgs into the activity for consideration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>performResumeActivity</span><span class=p>(</span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>clearHide</span><span class=p>,</span><span class=w> </span><span class=n>reason</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Resume &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; started activity: &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>a</span><span class=p>.</span><span class=na>mStartedActivity</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, hideForNow: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>hideForNow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, finished: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>mFinished</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>forwardBit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isForward</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the window hasn&#39;t yet been added to the window manager,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// and this guy didn&#39;t finish itself or start another activity,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// then go ahead and add the window.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>willBeVisible</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>a</span><span class=p>.</span><span class=na>mStartedActivity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>willBeVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>willBeVisible</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>().</span><span class=na>willActivityBeVisible</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>a</span><span class=p>.</span><span class=na>getActivityToken</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>a</span><span class=p>.</span><span class=na>mFinished</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>willBeVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 拿到window</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>getWindow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>View</span><span class=w> </span><span class=n>decor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getDecorView</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>decor</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>View</span><span class=p>.</span><span class=na>INVISIBLE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ViewManager</span><span class=w> </span><span class=n>wm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>getWindowManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>a</span><span class=p>.</span><span class=na>mDecor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>l</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>TYPE_BASE_APPLICATION</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>forwardBit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>mPreserveWindow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>a</span><span class=p>.</span><span class=na>mWindowAdded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>mPreserveWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Normally the ViewRoot sets up callbacks with the Activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// in addView-&gt;ViewRootImpl#setView. If we are instead reusing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// the decor view we have to notify the view root that the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// callbacks may have changed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ViewRootImpl</span><span class=w> </span><span class=n>impl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decor</span><span class=p>.</span><span class=na>getViewRootImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>impl</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>impl</span><span class=p>.</span><span class=na>notifyChildRebuilt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=na>mVisibleFromClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>a</span><span class=p>.</span><span class=na>mWindowAdded</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>a</span><span class=p>.</span><span class=na>mWindowAdded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// 添加window</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>wm</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>decor</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// The activity will get a callback for this {@link LayoutParams} change</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// earlier. However, at that time the decor will not be set (this is set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// in this method), so no action will be taken. This call ensures the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// callback occurs with the decor set.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>a</span><span class=p>.</span><span class=na>onWindowAttributesChanged</span><span class=p>(</span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the window has already been added, but during resume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// we started another activity, then don&#39;t yet make the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// window visible.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>willBeVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Launch &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; mStartedActivity set&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>hideForNow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Get rid of anything left hanging around.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cleanUpPendingRemoveWindows</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/* force */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// The window is now visible if it has been added, we are not</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// simply finishing, and we are not starting another activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>willBeVisible</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mDecor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>hideForNow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>newConfig</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>performConfigurationChangedForActivity</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>newConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_CONFIGURATION</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Resuming activity &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; with newConfig &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mCurrentConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>newConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Resuming &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; with isForward=&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>isForward</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>!=</span><span class=w> </span><span class=n>forwardBit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>|</span><span class=w> </span><span class=n>forwardBit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mVisibleFromClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ViewManager</span><span class=w> </span><span class=n>wm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>getWindowManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>View</span><span class=w> </span><span class=n>decor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getDecorView</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>wm</span><span class=p>.</span><span class=na>updateViewLayout</span><span class=p>(</span><span class=n>decor</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mVisibleFromServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mNumVisibleActivities</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mVisibleFromClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>makeVisible</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>onlyLocalRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>nextIdle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mNewActivities</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mNewActivities</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Scheduling idle handler for &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Looper</span><span class=p>.</span><span class=na>myQueue</span><span class=p>().</span><span class=na>addIdleHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Idler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>onlyLocalRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Tell the activity manager we have resumed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reallyResume</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>().</span><span class=na>activityResumed</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If an exception was thrown when trying to resume, then</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// just end this activity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>finishActivity</span><span class=p>(</span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=p>.</span><span class=na>RESULT_CANCELED</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Activity</span><span class=p>.</span><span class=na>DONT_FINISH_TASK_WITH_ACTIVITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>现在我们聚焦到上面的<code>wm.addView(decor, l)</code>调用，其中当前Activity对应的<code>Window</code>，它是一个<code>PhoneWindow</code>实例，另外几个对象的实例定义如下：</p><ul><li><p><code>wm</code></p><p>它是与Activity的Window对象持有的一个<code>WindowManagerImpl</code>实例</p></li><li><p><code>decor</code></p><p>它是该<code>PhoneWindow</code>的<code>DecorView</code></p></li><li><p><code>l</code></p><p>它是该<code>PhoneWindow</code>的布局参数，其默认值采用如下构造器进行初始化。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>WindowManager</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ViewManager</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>LayoutParams</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Parcelable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>LayoutParams</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>(</span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>,</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TYPE_APPLICATION</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>format</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PixelFormat</span><span class=p>.</span><span class=na>OPAQUE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li></ul><p>其中WindowManagerImpl用于为绑定到特定context、display或父window的操作提供与系统window manager进行低层级的通信，再看该它是如何添加视图的，可以发现它将添加的工作委托给了<code>WindowManagerGlobal</code>。</p><p>WindowManagerImpl.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addView</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>applyDefaultToken</span><span class=p>(</span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mGlobal</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>,</span><span class=w> </span><span class=n>mContext</span><span class=p>.</span><span class=na>getDisplay</span><span class=p>(),</span><span class=w> </span><span class=n>mParentWindow</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>WindowManagerGlobal是一个单例，与WindowManagerImpl相同的是，它也用于为各种操作提供与系统window manager进行低层级的通信。但不与特定的context相关。</p><p>WindowManagerGlobal.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addView</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>params</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Display</span><span class=w> </span><span class=n>display</span><span class=p>,</span><span class=w> </span><span class=n>Window</span><span class=w> </span><span class=n>parentWindow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>view</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;view must not be null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>display</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;display must not be null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>params</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Params must be WindowManager.LayoutParams&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>wparams</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>)</span><span class=w> </span><span class=n>params</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>parentWindow</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>parentWindow</span><span class=p>.</span><span class=na>adjustLayoutParamsForSubWindow</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If there&#39;s no parent, then hardware acceleration for this view is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// set from the application&#39;s hardware acceleration setting.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>context</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationInfo</span><span class=p>().</span><span class=na>flags</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>&amp;</span><span class=w> </span><span class=n>ApplicationInfo</span><span class=p>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>wparams</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ViewRootImpl</span><span class=w> </span><span class=n>root</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>View</span><span class=w> </span><span class=n>panelParentView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mLock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Start watching for system property changes.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSystemPropertyUpdater</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSystemPropertyUpdater</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nd>@Override</span><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mLock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRoots</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=o>--</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>loadSystemProperties</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SystemProperties</span><span class=p>.</span><span class=na>addChangeCallback</span><span class=p>(</span><span class=n>mSystemPropertyUpdater</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findViewLocked</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>index</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDyingViews</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>view</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Don&#39;t wait for MSG_DIE to make it&#39;s way through root&#39;s queue.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>).</span><span class=na>doDie</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;View &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>view</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34; has already been added to the window manager.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// The previous removeView() had not completed executing. Now it has.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If this is a panel window, then find the window it is being</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// attached to for future reference.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>wparams</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>FIRST_SUB_WINDOW</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>wparams</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>LAST_SUB_WINDOW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mViews</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>mWindow</span><span class=p>.</span><span class=na>asBinder</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>wparams</span><span class=p>.</span><span class=na>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>panelParentView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mViews</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>root</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ViewRootImpl</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>(),</span><span class=w> </span><span class=n>display</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>view</span><span class=p>.</span><span class=na>setLayoutParams</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mViews</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>view</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mRoots</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>root</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mParams</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// do this last because it fires off messages to start doing things</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>root</span><span class=p>.</span><span class=na>setView</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>wparams</span><span class=p>,</span><span class=w> </span><span class=n>panelParentView</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// BadTokenException or InvalidDisplayException, clean up.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>index</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>removeViewLocked</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可以发现它新建了一个<code>ViewRootImpl</code>实例，它将<code>PhoneWindow</code>的布局参数设置为<code>DecorView</code>的布局参数，然后调用<code>ViewRootImpl.setView(View view, WindowManager.LayoutParams attrs, View panelParentView)</code>方法。</p><p>ViewRootImpl.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * We have one child
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setView</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>attrs</span><span class=p>,</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>panelParentView</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mView</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>view</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mDisplayState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mDisplay</span><span class=p>.</span><span class=na>getState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mDisplayManager</span><span class=p>.</span><span class=na>registerDisplayListener</span><span class=p>(</span><span class=n>mDisplayListener</span><span class=p>,</span><span class=w> </span><span class=n>mHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mViewLayoutDirectionInitial</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mView</span><span class=p>.</span><span class=na>getRawLayoutDirection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mFallbackEventHandler</span><span class=p>.</span><span class=na>setView</span><span class=p>(</span><span class=n>view</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>copyFrom</span><span class=p>(</span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>packageName</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>packageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mBasePackageName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>attrs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setTag</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_KEEP_SCREEN_ON</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>mClientWindowLayoutFlags</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>FLAG_KEEP_SCREEN_ON</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>attrs</span><span class=p>.</span><span class=na>flags</span><span class=o>&amp;</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>FLAG_KEEP_SCREEN_ON</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;setView: FLAG_KEEP_SCREEN_ON changed from true to false!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Keep track of the actual window flags supplied by the client.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mClientWindowLayoutFlags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>flags</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setAccessibilityFocus</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>view</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>RootViewSurfaceTaker</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mSurfaceHolderCallback</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>((</span><span class=n>RootViewSurfaceTaker</span><span class=p>)</span><span class=n>view</span><span class=p>).</span><span class=na>willYouTakeTheSurface</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSurfaceHolderCallback</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mSurfaceHolder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TakenSurfaceHolder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>setFormat</span><span class=p>(</span><span class=n>PixelFormat</span><span class=p>.</span><span class=na>UNKNOWN</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>mSurfaceHolderCallback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Compute surface insets required to draw at specified Z value.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// TODO: Use real shadow insets for a constant max Z.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>attrs</span><span class=p>.</span><span class=na>hasManualSurfaceInsets</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>attrs</span><span class=p>.</span><span class=na>setSurfaceInsets</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/*manual*/</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=cm>/*preservePrevious*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>CompatibilityInfo</span><span class=w> </span><span class=n>compatibilityInfo</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mDisplay</span><span class=p>.</span><span class=na>getDisplayAdjustments</span><span class=p>().</span><span class=na>getCompatibilityInfo</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mTranslator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>compatibilityInfo</span><span class=p>.</span><span class=na>getTranslator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If the application owns the surface, don&#39;t enable hardware acceleration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSurfaceHolder</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>enableHardwareAcceleration</span><span class=p>(</span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>restore</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mTranslator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mSurface</span><span class=p>.</span><span class=na>setCompatibilityTranslator</span><span class=p>(</span><span class=n>mTranslator</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>restore</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>attrs</span><span class=p>.</span><span class=na>backup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mTranslator</span><span class=p>.</span><span class=na>translateWindowLayout</span><span class=p>(</span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;WindowLayout in setView:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>compatibilityInfo</span><span class=p>.</span><span class=na>supportsScreen</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>attrs</span><span class=p>.</span><span class=na>privateFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>PRIVATE_FLAG_COMPATIBLE_WINDOW</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mLastInCompatMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSoftInputMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>softInputMode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWindowAttributesChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWindowAttributesChangesFlag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>EVERYTHING_CHANGED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mRootView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>view</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mScalingRequired</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mTranslator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mApplicationScale</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mTranslator</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>mTranslator</span><span class=p>.</span><span class=na>applicationScale</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>panelParentView</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mPanelParentWindowToken</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>=</span><span class=w> </span><span class=n>panelParentView</span><span class=p>.</span><span class=na>getApplicationWindowToken</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAdded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w> </span><span class=cm>/* = WindowManagerImpl.ADD_OKAY; */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Schedule the first layout -before- adding to the window</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// manager, to make sure we do the relayout before receiving</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// any other events from the system.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>requestLayout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>inputFeatures</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>INPUT_FEATURE_NO_INPUT_CHANNEL</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mInputChannel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InputChannel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mForceDecorViewVisibility</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>privateFlags</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=w> </span><span class=n>PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mOrigWindowType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>type</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mRecomputeGlobalAttributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>collectViewAttributes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindowSession</span><span class=p>.</span><span class=na>addToDisplay</span><span class=p>(</span><span class=n>mWindow</span><span class=p>,</span><span class=w> </span><span class=n>mSeq</span><span class=p>,</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=nf>getHostVisibility</span><span class=p>(),</span><span class=w> </span><span class=n>mDisplay</span><span class=p>.</span><span class=na>getDisplayId</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mContentInsets</span><span class=p>,</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mStableInsets</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOutsets</span><span class=p>,</span><span class=w> </span><span class=n>mInputChannel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAdded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mRootView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mInputChannel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mFallbackEventHandler</span><span class=p>.</span><span class=na>setView</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>unscheduleTraversals</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setAccessibilityFocus</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;Adding window failed&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>restore</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>attrs</span><span class=p>.</span><span class=na>restore</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mTranslator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mTranslator</span><span class=p>.</span><span class=na>translateRectInScreenToAppWindow</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mContentInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPendingOverscanInsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPendingContentInsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mContentInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPendingStableInsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mStableInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPendingVisibleInsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mAlwaysConsumeNavBar</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_FLAG_ALWAYS_CONSUME_NAV_BAR</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPendingAlwaysConsumeNavBar</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mAlwaysConsumeNavBar</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Added window &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mWindow</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_OKAY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mRootView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAdded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mFallbackEventHandler</span><span class=p>.</span><span class=na>setView</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>unscheduleTraversals</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setAccessibilityFocus</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>case</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>case</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_SUBWINDOW_TOKEN</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>BadTokenException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=s>&#34;Unable to add window -- token &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; is not valid; is your activity running?&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>case</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_NOT_APP_TOKEN</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>BadTokenException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=s>&#34;Unable to add window -- token &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; is not for an application&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>case</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_APP_EXITING</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>BadTokenException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=s>&#34;Unable to add window -- app for token &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; is exiting&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>case</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_DUPLICATE_ADD</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>BadTokenException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=s>&#34;Unable to add window -- window &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mWindow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; has already been added&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>case</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_STARTING_NOT_NEEDED</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// Silently ignore -- we would have just removed it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// right away, anyway.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>case</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_MULTIPLE_SINGLETON</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>BadTokenException</span><span class=p>(</span><span class=s>&#34;Unable to add window &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=n>mWindow</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; -- another window of type &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; already exists&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>case</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_PERMISSION_DENIED</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>BadTokenException</span><span class=p>(</span><span class=s>&#34;Unable to add window &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=n>mWindow</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; -- permission denied for window type &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>type</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>case</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_INVALID_DISPLAY</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>InvalidDisplayException</span><span class=p>(</span><span class=s>&#34;Unable to add window &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=n>mWindow</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; -- the specified display can not be found&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>case</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_INVALID_TYPE</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>InvalidDisplayException</span><span class=p>(</span><span class=s>&#34;Unable to add window &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=n>mWindow</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; -- the specified window type &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>+</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; is not valid&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34;Unable to add window -- unknown error code &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>res</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>view</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>RootViewSurfaceTaker</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mInputQueueCallback</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>((</span><span class=n>RootViewSurfaceTaker</span><span class=p>)</span><span class=n>view</span><span class=p>).</span><span class=na>willYouTakeTheInputQueue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mInputChannel</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mInputQueueCallback</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mInputQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InputQueue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mInputQueueCallback</span><span class=p>.</span><span class=na>onInputQueueCreated</span><span class=p>(</span><span class=n>mInputQueue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mInputEventReceiver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowInputEventReceiver</span><span class=p>(</span><span class=n>mInputChannel</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Looper</span><span class=p>.</span><span class=na>myLooper</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=p>.</span><span class=na>assignParent</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAddedTouchMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_FLAG_IN_TOUCH_MODE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAppVisible</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_FLAG_APP_VISIBLE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAccessibilityManager</span><span class=p>.</span><span class=na>isEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAccessibilityInteractionConnectionManager</span><span class=p>.</span><span class=na>ensureConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getImportantForAccessibility</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>IMPORTANT_FOR_ACCESSIBILITY_AUTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>view</span><span class=p>.</span><span class=na>setImportantForAccessibility</span><span class=p>(</span><span class=n>View</span><span class=p>.</span><span class=na>IMPORTANT_FOR_ACCESSIBILITY_YES</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Set up the input pipeline.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>CharSequence</span><span class=w> </span><span class=n>counterSuffix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>getTitle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSyntheticInputStage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SyntheticInputStage</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>InputStage</span><span class=w> </span><span class=n>viewPostImeStage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ViewPostImeInputStage</span><span class=p>(</span><span class=n>mSyntheticInputStage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>InputStage</span><span class=w> </span><span class=n>nativePostImeStage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NativePostImeInputStage</span><span class=p>(</span><span class=n>viewPostImeStage</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;aq:native-post-ime:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>counterSuffix</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>InputStage</span><span class=w> </span><span class=n>earlyPostImeStage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EarlyPostImeInputStage</span><span class=p>(</span><span class=n>nativePostImeStage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>InputStage</span><span class=w> </span><span class=n>imeStage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ImeInputStage</span><span class=p>(</span><span class=n>earlyPostImeStage</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;aq:ime:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>counterSuffix</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>InputStage</span><span class=w> </span><span class=n>viewPreImeStage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ViewPreImeInputStage</span><span class=p>(</span><span class=n>imeStage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>InputStage</span><span class=w> </span><span class=n>nativePreImeStage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NativePreImeInputStage</span><span class=p>(</span><span class=n>viewPreImeStage</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;aq:native-pre-ime:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>counterSuffix</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mFirstInputStage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nativePreImeStage</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mFirstPostImeInputStage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>earlyPostImeStage</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPendingInputEventQueueLengthCounterName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;aq:pending:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>counterSuffix</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>requestLayout</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mHandlingLayoutInLayoutRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLayoutRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>scheduleTraversals</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>最终调用到ViewRootImpl的requestLayout()进行首次布局遍历，完成布局的绘制。然后添加Window进行界面展示，这里拿到一个窗口会话WindowSession，并调用其addToDisplay方法：</p><p>Session.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>addToDisplay</span><span class=p>(</span><span class=n>IWindow</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>seq</span><span class=p>,</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>attrs</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>viewVisibility</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>displayId</span><span class=p>,</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>outContentInsets</span><span class=p>,</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>outStableInsets</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Rect</span><span class=w> </span><span class=n>outOutsets</span><span class=p>,</span><span class=w> </span><span class=n>InputChannel</span><span class=w> </span><span class=n>outInputChannel</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mService</span><span class=p>.</span><span class=na>addWindow</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>seq</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>,</span><span class=w> </span><span class=n>viewVisibility</span><span class=p>,</span><span class=w> </span><span class=n>displayId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>outContentInsets</span><span class=p>,</span><span class=w> </span><span class=n>outStableInsets</span><span class=p>,</span><span class=w> </span><span class=n>outOutsets</span><span class=p>,</span><span class=w> </span><span class=n>outInputChannel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> 
</span></span></span></code></pre></div><p>实际上调用到的是WindowManagerService的添加窗口的方法：</p><p>WindowManagerService.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>addWindow</span><span class=p>(</span><span class=n>Session</span><span class=w> </span><span class=n>session</span><span class=p>,</span><span class=w> </span><span class=n>IWindow</span><span class=w> </span><span class=n>client</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>seq</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>attrs</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>viewVisibility</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>displayId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Rect</span><span class=w> </span><span class=n>outContentInsets</span><span class=p>,</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>outStableInsets</span><span class=p>,</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>outOutsets</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>InputChannel</span><span class=w> </span><span class=n>outInputChannel</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>appOp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPolicy</span><span class=p>.</span><span class=na>checkAddPermission</span><span class=p>(</span><span class=n>attrs</span><span class=p>,</span><span class=w> </span><span class=n>appOp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_OKAY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>reportNewConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>WindowState</span><span class=w> </span><span class=n>parentWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>origId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>callingUid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingUid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>type</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>mWindowMap</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mDisplayReady</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Display has not been initialialized&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>DisplayContent</span><span class=w> </span><span class=n>displayContent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRoot</span><span class=p>.</span><span class=na>getDisplayContentOrCreate</span><span class=p>(</span><span class=n>displayId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>displayContent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add window to a display that does not exist: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>displayId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_INVALID_DISPLAY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>displayContent</span><span class=p>.</span><span class=na>hasAccess</span><span class=p>(</span><span class=n>session</span><span class=p>.</span><span class=na>mUid</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mDisplayManagerInternal</span><span class=p>.</span><span class=na>isUidPresentOnDisplay</span><span class=p>(</span><span class=n>session</span><span class=p>.</span><span class=na>mUid</span><span class=p>,</span><span class=w> </span><span class=n>displayId</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add window to a display for which the application &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34;does not have access: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>displayId</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_INVALID_DISPLAY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mWindowMap</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>asBinder</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Window &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; is already added&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_DUPLICATE_ADD</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>FIRST_SUB_WINDOW</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>type</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>LAST_SUB_WINDOW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>parentWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>windowForClientLocked</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>parentWindow</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add window with token that is not a window: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_SUBWINDOW_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>parentWindow</span><span class=p>.</span><span class=na>mAttrs</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>FIRST_SUB_WINDOW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>parentWindow</span><span class=p>.</span><span class=na>mAttrs</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>LAST_SUB_WINDOW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add window with token that is a sub-window: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_SUBWINDOW_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_PRIVATE_PRESENTATION</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>displayContent</span><span class=p>.</span><span class=na>isPrivate</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add private presentation window to a non-private display.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_PERMISSION_DENIED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AppWindowToken</span><span class=w> </span><span class=n>atoken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasParent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parentWindow</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Use existing parent window token for child windows since they go in the same token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// as there parent window so we can apply the same policy on them.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>WindowToken</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>displayContent</span><span class=p>.</span><span class=na>getWindowToken</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>hasParent</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>parentWindow</span><span class=p>.</span><span class=na>mAttrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If this is a child window, we want to apply the same type checking rules as the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// parent window type.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>rootType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hasParent</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>parentWindow</span><span class=p>.</span><span class=na>mAttrs</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>type</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>addToastWindowRequiresToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>FIRST_APPLICATION_WINDOW</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>rootType</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>LAST_APPLICATION_WINDOW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add application window with unknown token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_INPUT_METHOD</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add input method window with unknown token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_VOICE_INTERACTION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add voice interaction window with unknown token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_WALLPAPER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add wallpaper window with unknown token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_DREAM</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add Dream window with unknown token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_QS_DIALOG</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add QS dialog window with unknown token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_ACCESSIBILITY_OVERLAY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add Accessibility overlay window with unknown token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_TOAST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Apps targeting SDK above N MR1 cannot arbitrary add toast windows.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>doesAddToastWindowRequireToken</span><span class=p>(</span><span class=n>attrs</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w> </span><span class=n>callingUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>parentWindow</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add a toast window with unknown token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>binder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=na>asBinder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowToken</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>binder</span><span class=p>,</span><span class=w> </span><span class=n>type</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>displayContent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>session</span><span class=p>.</span><span class=na>mCanAddInternalSystemWindow</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>FIRST_APPLICATION_WINDOW</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>rootType</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>LAST_APPLICATION_WINDOW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>atoken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>asAppWindowToken</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>atoken</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add window with non-application token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_NOT_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>atoken</span><span class=p>.</span><span class=na>removed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add window with exiting application token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_APP_EXITING</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_INPUT_METHOD</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=na>windowType</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TYPE_INPUT_METHOD</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add input method window with bad token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_VOICE_INTERACTION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=na>windowType</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TYPE_VOICE_INTERACTION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add voice interaction window with bad token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_WALLPAPER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=na>windowType</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TYPE_WALLPAPER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add wallpaper window with bad token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_DREAM</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=na>windowType</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TYPE_DREAM</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add Dream window with bad token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rootType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_ACCESSIBILITY_OVERLAY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=na>windowType</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TYPE_ACCESSIBILITY_OVERLAY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add Accessibility overlay window with bad token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_TOAST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Apps targeting SDK above N MR1 cannot arbitrary add toast windows.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>addToastWindowRequiresToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>doesAddToastWindowRequireToken</span><span class=p>(</span><span class=n>attrs</span><span class=p>.</span><span class=na>packageName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>callingUid</span><span class=p>,</span><span class=w> </span><span class=n>parentWindow</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>addToastWindowRequiresToken</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>windowType</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TYPE_TOAST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add a toast window with bad token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_QS_DIALOG</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=na>windowType</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TYPE_QS_DIALOG</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Attempted to add QS dialog window with bad token &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.  Aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_BAD_APP_TOKEN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=na>asAppWindowToken</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Non-null appWindowToken for system window of rootType=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>rootType</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// It is not valid to use an app token with other system types; we will</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// instead make a new token for it (as if null had been passed in for the token).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>attrs</span><span class=p>.</span><span class=na>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowToken</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=na>asBinder</span><span class=p>(),</span><span class=w> </span><span class=n>type</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>displayContent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>session</span><span class=p>.</span><span class=na>mCanAddInternalSystemWindow</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>WindowState</span><span class=w> </span><span class=n>win</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowState</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>session</span><span class=p>,</span><span class=w> </span><span class=n>client</span><span class=p>,</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>parentWindow</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>appOp</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>seq</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>,</span><span class=w> </span><span class=n>viewVisibility</span><span class=p>,</span><span class=w> </span><span class=n>session</span><span class=p>.</span><span class=na>mUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>session</span><span class=p>.</span><span class=na>mCanAddInternalSystemWindow</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>win</span><span class=p>.</span><span class=na>mDeathRecipient</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Client has apparently died, so there is no reason to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// continue.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Adding window client &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=na>asBinder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; that is dead, aborting.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_APP_EXITING</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>win</span><span class=p>.</span><span class=na>getDisplayContent</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Adding window to Display that has been removed.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_INVALID_DISPLAY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPolicy</span><span class=p>.</span><span class=na>adjustWindowParamsLw</span><span class=p>(</span><span class=n>win</span><span class=p>.</span><span class=na>mAttrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>win</span><span class=p>.</span><span class=na>setShowToOwnerOnlyLocked</span><span class=p>(</span><span class=n>mPolicy</span><span class=p>.</span><span class=na>checkShowToOwnerOnly</span><span class=p>(</span><span class=n>attrs</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPolicy</span><span class=p>.</span><span class=na>prepareAddWindowLw</span><span class=p>(</span><span class=n>win</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_OKAY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>openInputChannels</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>outInputChannel</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>attrs</span><span class=p>.</span><span class=na>inputFeatures</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>INPUT_FEATURE_NO_INPUT_CHANNEL</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w>  </span><span class=p>(</span><span class=n>openInputChannels</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>win</span><span class=p>.</span><span class=na>openInputChannel</span><span class=p>(</span><span class=n>outInputChannel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If adding a toast requires a token for this app we always schedule hiding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// toast windows to make sure they don&#39;t stick around longer then necessary.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// We hide instead of remove such windows as apps aren&#39;t prepared to handle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// windows being removed under them.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the app is older it can add toasts without a token and hence overlay</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// other apps. To be maximally compatible with these apps we will hide the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// window after the toast timeout only if the focused window is from another</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// UID, otherwise we allow unlimited duration. When a UID looses focus we</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// schedule hiding all of its toast windows.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_TOAST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>getDefaultDisplayContentLocked</span><span class=p>().</span><span class=na>canAddToastWindowForUid</span><span class=p>(</span><span class=n>callingUid</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Adding more than one toast window for UID at a time.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_DUPLICATE_ADD</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Make sure this happens before we moved focus as one can make the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// toast focusable to force it not being hidden after the timeout.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Focusable toasts are always timed out to prevent a focused app to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// show a focusable toasts while it has focus which will be kept on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the screen after the activity goes away.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>addToastWindowRequiresToken</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>attrs</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>FLAG_NOT_FOCUSABLE</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=n>mCurrentFocus</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=n>mCurrentFocus</span><span class=p>.</span><span class=na>mOwnerUid</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>callingUid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mH</span><span class=p>.</span><span class=na>sendMessageDelayed</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mH</span><span class=p>.</span><span class=na>obtainMessage</span><span class=p>(</span><span class=n>H</span><span class=p>.</span><span class=na>WINDOW_HIDE_TIMEOUT</span><span class=p>,</span><span class=w> </span><span class=n>win</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>win</span><span class=p>.</span><span class=na>mAttrs</span><span class=p>.</span><span class=na>hideTimeoutMilliseconds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// From now on, no exceptions or errors allowed!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_OKAY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mCurrentFocus</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWinAddedSinceNullFocus</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>win</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>excludeWindowTypeFromTapOutTask</span><span class=p>(</span><span class=n>type</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>displayContent</span><span class=p>.</span><span class=na>mTapExcludedWindows</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>win</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>origId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>clearCallingIdentity</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>win</span><span class=p>.</span><span class=na>attach</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindowMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>asBinder</span><span class=p>(),</span><span class=w> </span><span class=n>win</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>win</span><span class=p>.</span><span class=na>mAppOp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>AppOpsManager</span><span class=p>.</span><span class=na>OP_NONE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>startOpResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAppOps</span><span class=p>.</span><span class=na>startOpNoThrow</span><span class=p>(</span><span class=n>win</span><span class=p>.</span><span class=na>mAppOp</span><span class=p>,</span><span class=w> </span><span class=n>win</span><span class=p>.</span><span class=na>getOwningUid</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>win</span><span class=p>.</span><span class=na>getOwningPackage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>startOpResult</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>AppOpsManager</span><span class=p>.</span><span class=na>MODE_ALLOWED</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>(</span><span class=n>startOpResult</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>AppOpsManager</span><span class=p>.</span><span class=na>MODE_DEFAULT</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>win</span><span class=p>.</span><span class=na>setAppOpVisibilityLw</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hideSystemAlertWindows</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mHidingNonSystemOverlayWindows</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>win</span><span class=p>.</span><span class=na>setForceHideNonSystemOverlayWindowIfNeeded</span><span class=p>(</span><span class=n>hideSystemAlertWindows</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>AppWindowToken</span><span class=w> </span><span class=n>aToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>asAppWindowToken</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_APPLICATION_STARTING</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>aToken</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>aToken</span><span class=p>.</span><span class=na>startingWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>win</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_STARTING_WINDOW</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=w> </span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;addWindow: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>aToken</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; startingWindow=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>win</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>imMayMove</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>win</span><span class=p>.</span><span class=na>mToken</span><span class=p>.</span><span class=na>addWindow</span><span class=p>(</span><span class=n>win</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_INPUT_METHOD</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>win</span><span class=p>.</span><span class=na>mGivenInsetsPending</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setInputMethodWindowLocked</span><span class=p>(</span><span class=n>win</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>imMayMove</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_INPUT_METHOD_DIALOG</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>displayContent</span><span class=p>.</span><span class=na>computeImeTarget</span><span class=p>(</span><span class=kc>true</span><span class=w> </span><span class=cm>/* updateImeTarget */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>imMayMove</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_WALLPAPER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>displayContent</span><span class=p>.</span><span class=na>mWallpaperController</span><span class=p>.</span><span class=na>clearLastWallpaperTimeoutTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>displayContent</span><span class=p>.</span><span class=na>pendingLayoutChanges</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>FINISH_LAYOUT_REDO_WALLPAPER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>attrs</span><span class=p>.</span><span class=na>flags</span><span class=o>&amp;</span><span class=n>FLAG_SHOW_WALLPAPER</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>displayContent</span><span class=p>.</span><span class=na>pendingLayoutChanges</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>FINISH_LAYOUT_REDO_WALLPAPER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>displayContent</span><span class=p>.</span><span class=na>mWallpaperController</span><span class=p>.</span><span class=na>isBelowWallpaperTarget</span><span class=p>(</span><span class=n>win</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// If there is currently a wallpaper being shown, and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// the base layer of the new window is below the current</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// layer of the target window, then adjust the wallpaper.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// This is to avoid a new window being placed between the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// wallpaper and its target.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>displayContent</span><span class=p>.</span><span class=na>pendingLayoutChanges</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>FINISH_LAYOUT_REDO_WALLPAPER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the window is being added to a stack that&#39;s currently adjusted for IME,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// make sure to apply the same adjust to this new window.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>win</span><span class=p>.</span><span class=na>applyAdjustForImeIfNeeded</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TYPE_DOCK_DIVIDER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mRoot</span><span class=p>.</span><span class=na>getDisplayContent</span><span class=p>(</span><span class=n>displayId</span><span class=p>).</span><span class=na>getDockedDividerController</span><span class=p>().</span><span class=na>setWindow</span><span class=p>(</span><span class=n>win</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>WindowStateAnimator</span><span class=w> </span><span class=n>winAnimator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>win</span><span class=p>.</span><span class=na>mWinAnimator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>winAnimator</span><span class=p>.</span><span class=na>mEnterAnimationPending</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>winAnimator</span><span class=p>.</span><span class=na>mEnteringAnimation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Check if we need to prepare a transition for replacing window first.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>atoken</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>atoken</span><span class=p>.</span><span class=na>isVisible</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>prepareWindowReplacementTransition</span><span class=p>(</span><span class=n>atoken</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If not, check if need to set up a dummy transition during display freeze</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// so that the unfreeze wait for the apps to draw. This might be needed if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the app is relaunching.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>prepareNoneTransitionForRelaunching</span><span class=p>(</span><span class=n>atoken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>displayContent</span><span class=p>.</span><span class=na>isDefaultDisplay</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>DisplayInfo</span><span class=w> </span><span class=n>displayInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>displayContent</span><span class=p>.</span><span class=na>getDisplayInfo</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>taskBounds</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>atoken</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>atoken</span><span class=p>.</span><span class=na>getTask</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>taskBounds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mTmpRect</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>atoken</span><span class=p>.</span><span class=na>getTask</span><span class=p>().</span><span class=na>getBounds</span><span class=p>(</span><span class=n>mTmpRect</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>taskBounds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPolicy</span><span class=p>.</span><span class=na>getInsetHintLw</span><span class=p>(</span><span class=n>win</span><span class=p>.</span><span class=na>mAttrs</span><span class=p>,</span><span class=w> </span><span class=n>taskBounds</span><span class=p>,</span><span class=w> </span><span class=n>displayInfo</span><span class=p>.</span><span class=na>rotation</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>displayInfo</span><span class=p>.</span><span class=na>logicalWidth</span><span class=p>,</span><span class=w> </span><span class=n>displayInfo</span><span class=p>.</span><span class=na>logicalHeight</span><span class=p>,</span><span class=w> </span><span class=n>outContentInsets</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>outStableInsets</span><span class=p>,</span><span class=w> </span><span class=n>outOutsets</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>res</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_FLAG_ALWAYS_CONSUME_NAV_BAR</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>outContentInsets</span><span class=p>.</span><span class=na>setEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>outStableInsets</span><span class=p>.</span><span class=na>setEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mInTouchMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>res</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_FLAG_IN_TOUCH_MODE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>win</span><span class=p>.</span><span class=na>mAppToken</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>win</span><span class=p>.</span><span class=na>mAppToken</span><span class=p>.</span><span class=na>isClientHidden</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>res</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>ADD_FLAG_APP_VISIBLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mInputMonitor</span><span class=p>.</span><span class=na>setUpdateInputWindowsNeededLw</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>focusChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>win</span><span class=p>.</span><span class=na>canReceiveKeys</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>focusChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>updateFocusedWindowLocked</span><span class=p>(</span><span class=n>UPDATE_FOCUS_WILL_ASSIGN_LAYERS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kc>false</span><span class=w> </span><span class=cm>/*updateInputWindows*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>focusChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>imMayMove</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>imMayMove</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>displayContent</span><span class=p>.</span><span class=na>computeImeTarget</span><span class=p>(</span><span class=kc>true</span><span class=w> </span><span class=cm>/* updateImeTarget */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Don&#39;t do layout here, the window must call</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// relayout to be displayed, so we&#39;ll do it there.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>displayContent</span><span class=p>.</span><span class=na>assignWindowLayers</span><span class=p>(</span><span class=kc>false</span><span class=w> </span><span class=cm>/* setLayoutNeeded */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>focusChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInputMonitor</span><span class=p>.</span><span class=na>setInputFocusLw</span><span class=p>(</span><span class=n>mCurrentFocus</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/*updateInputWindows*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mInputMonitor</span><span class=p>.</span><span class=na>updateInputWindowsLw</span><span class=p>(</span><span class=kc>false</span><span class=w> </span><span class=cm>/*force*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>DEBUG_ADD_REMOVE</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;addWindow: New client &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=na>asBinder</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: window=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>win</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; Callers=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Debug</span><span class=p>.</span><span class=na>getCallers</span><span class=p>(</span><span class=n>5</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>win</span><span class=p>.</span><span class=na>isVisibleOrAdding</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>updateOrientationFromAppTokensLocked</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>displayId</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>reportNewConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reportNewConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendNewConfiguration</span><span class=p>(</span><span class=n>displayId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Binder</span><span class=p>.</span><span class=na>restoreCallingIdentity</span><span class=p>(</span><span class=n>origId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// TODO: Move to DisplayContent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>updateFocusedWindowLocked</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>mode</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>updateInputWindows</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>WindowState</span><span class=w> </span><span class=n>newFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRoot</span><span class=p>.</span><span class=na>computeFocusedWindow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mCurrentFocus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>newFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>TRACE_TAG_WINDOW_MANAGER</span><span class=p>,</span><span class=w> </span><span class=s>&#34;wmUpdateFocus&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// This check makes sure that we don&#39;t already have the focus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// change message pending.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mH</span><span class=p>.</span><span class=na>removeMessages</span><span class=p>(</span><span class=n>H</span><span class=p>.</span><span class=na>REPORT_FOCUS_CHANGE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mH</span><span class=p>.</span><span class=na>sendEmptyMessage</span><span class=p>(</span><span class=n>H</span><span class=p>.</span><span class=na>REPORT_FOCUS_CHANGE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// TODO(multidisplay): Focused windows on default display only.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>DisplayContent</span><span class=w> </span><span class=n>displayContent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getDefaultDisplayContentLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>imWindowChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mInputMethodWindow</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>WindowState</span><span class=w> </span><span class=n>prevTarget</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInputMethodTarget</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>WindowState</span><span class=w> </span><span class=n>newTarget</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>displayContent</span><span class=p>.</span><span class=na>computeImeTarget</span><span class=p>(</span><span class=kc>true</span><span class=w> </span><span class=cm>/* updateImeTarget*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>imWindowChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prevTarget</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>newTarget</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>UPDATE_FOCUS_WILL_ASSIGN_LAYERS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>UPDATE_FOCUS_WILL_PLACE_SURFACES</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>prevImeAnimLayer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInputMethodWindow</span><span class=p>.</span><span class=na>mWinAnimator</span><span class=p>.</span><span class=na>mAnimLayer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>displayContent</span><span class=p>.</span><span class=na>assignWindowLayers</span><span class=p>(</span><span class=kc>false</span><span class=w> </span><span class=cm>/* setLayoutNeeded */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>imWindowChanged</span><span class=w> </span><span class=o>|=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>prevImeAnimLayer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mInputMethodWindow</span><span class=p>.</span><span class=na>mWinAnimator</span><span class=p>.</span><span class=na>mAnimLayer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>imWindowChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWindowsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>displayContent</span><span class=p>.</span><span class=na>setLayoutNeeded</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>newFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRoot</span><span class=p>.</span><span class=na>computeFocusedWindow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_FOCUS_LIGHT</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Changing focus from &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mCurrentFocus</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; to &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>newFocus</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; Callers=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Debug</span><span class=p>.</span><span class=na>getCallers</span><span class=p>(</span><span class=n>4</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>WindowState</span><span class=w> </span><span class=n>oldFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mCurrentFocus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mCurrentFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newFocus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLosingFocus</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>newFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mCurrentFocus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWinAddedSinceNullFocus</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWinRemovedSinceNullFocus</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>focusChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPolicy</span><span class=p>.</span><span class=na>focusChangedLw</span><span class=p>(</span><span class=n>oldFocus</span><span class=p>,</span><span class=w> </span><span class=n>newFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>imWindowChanged</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>oldFocus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mInputMethodWindow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Focus of the input method window changed. Perform layout if needed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>UPDATE_FOCUS_PLACING_SURFACES</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>displayContent</span><span class=p>.</span><span class=na>performLayout</span><span class=p>(</span><span class=kc>true</span><span class=w> </span><span class=cm>/*initial*/</span><span class=p>,</span><span class=w>  </span><span class=n>updateInputWindows</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>focusChanged</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>FINISH_LAYOUT_REDO_LAYOUT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>UPDATE_FOCUS_WILL_PLACE_SURFACES</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Client will do the layout, but we need to assign layers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// for handleNewWindowLocked() below.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>displayContent</span><span class=p>.</span><span class=na>assignWindowLayers</span><span class=p>(</span><span class=kc>false</span><span class=w> </span><span class=cm>/* setLayoutNeeded */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>focusChanged</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>FINISH_LAYOUT_REDO_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// The change in focus caused us to need to do a layout.  Okay.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>displayContent</span><span class=p>.</span><span class=na>setLayoutNeeded</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>UPDATE_FOCUS_PLACING_SURFACES</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>displayContent</span><span class=p>.</span><span class=na>performLayout</span><span class=p>(</span><span class=kc>true</span><span class=w> </span><span class=cm>/*initial*/</span><span class=p>,</span><span class=w> </span><span class=n>updateInputWindows</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>UPDATE_FOCUS_WILL_ASSIGN_LAYERS</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If we defer assigning layers, then the caller is responsible for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// doing this part.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInputMonitor</span><span class=p>.</span><span class=na>setInputFocusLw</span><span class=p>(</span><span class=n>mCurrentFocus</span><span class=p>,</span><span class=w> </span><span class=n>updateInputWindows</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>displayContent</span><span class=p>.</span><span class=na>adjustForImeIfNeeded</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// We may need to schedule some toast windows to be removed. The toasts for an app that</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// does not have input focus are removed within a timeout to prevent apps to redress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// other apps&#39; UI.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>displayContent</span><span class=p>.</span><span class=na>scheduleToastWindowsTimeoutIfNeededLocked</span><span class=p>(</span><span class=n>oldFocus</span><span class=p>,</span><span class=w> </span><span class=n>newFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>TRACE_TAG_WINDOW_MANAGER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleMessage</span><span class=p>(</span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_WINDOW_TRACE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;handleMessage: entry what=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>what</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=p>.</span><span class=na>what</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=n>REPORT_FOCUS_CHANGE</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>WindowState</span><span class=w> </span><span class=n>lastFocus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>WindowState</span><span class=w> </span><span class=n>newFocus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>AccessibilityController</span><span class=w> </span><span class=n>accessibilityController</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>mWindowMap</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// TODO(multidisplay): Accessibility supported only of default desiplay.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAccessibilityController</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>getDefaultDisplayContentLocked</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>.</span><span class=na>getDisplayId</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>DEFAULT_DISPLAY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>accessibilityController</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAccessibilityController</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lastFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mLastFocus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>newFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mCurrentFocus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastFocus</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>newFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// Focus is not changing, so nothing to do.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mLastFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newFocus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_FOCUS_LIGHT</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Focus moving from &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lastFocus</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34; to &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>newFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>newFocus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>lastFocus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>newFocus</span><span class=p>.</span><span class=na>isDisplayedLw</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>//Slog.i(TAG_WM, &#34;Delaying loss of focus...&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mLosingFocus</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>lastFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>lastFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// First notify the accessibility manager for the change so it has</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// the windows before the newly focused one starts firing eventgs.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>accessibilityController</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>accessibilityController</span><span class=p>.</span><span class=na>onWindowFocusChangedNotLocked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//System.out.println(&#34;Changing focus from &#34; + lastFocus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//                   + &#34; to &#34; + newFocus);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>newFocus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_FOCUS_LIGHT</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Gaining focus: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>newFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>newFocus</span><span class=p>.</span><span class=na>reportFocusChangedSerialized</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>mInTouchMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>notifyFocusChanged</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastFocus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_FOCUS_LIGHT</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG_WM</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Losing focus: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lastFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lastFocus</span><span class=p>.</span><span class=na>reportFocusChangedSerialized</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>mInTouchMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>WindowState.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Report a focus change.  Must be called with no locks held, and consistently
</span></span></span><span class=line><span class=cl><span class=cm>     * from the same serialized thread (such as dispatched from a handler).
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>reportFocusChangedSerialized</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>focused</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>inTouchMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mClient</span><span class=p>.</span><span class=na>windowFocusChanged</span><span class=p>(</span><span class=n>focused</span><span class=p>,</span><span class=w> </span><span class=n>inTouchMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mFocusCallbacks</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mFocusCallbacks</span><span class=p>.</span><span class=na>beginBroadcast</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=o>=</span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>&lt;</span><span class=n>N</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>IWindowFocusObserver</span><span class=w> </span><span class=n>obs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mFocusCallbacks</span><span class=p>.</span><span class=na>getBroadcastItem</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>focused</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>obs</span><span class=p>.</span><span class=na>focusGained</span><span class=p>(</span><span class=n>mWindowId</span><span class=p>.</span><span class=na>asBinder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>obs</span><span class=p>.</span><span class=na>focusLost</span><span class=p>(</span><span class=n>mWindowId</span><span class=p>.</span><span class=na>asBinder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mFocusCallbacks</span><span class=p>.</span><span class=na>finishBroadcast</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>IWindow.aidl</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * API back to a client window that the Window Manager uses to inform it of
</span></span></span><span class=line><span class=cl><span class=cm> * interesting things happening.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * {@hide}
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>oneway</span><span class=w> </span><span class=kd>interface</span> <span class=nc>IWindow</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ===== NOTICE =====
</span></span></span><span class=line><span class=cl><span class=cm>     * The first method must remain the first method. Scripts
</span></span></span><span class=line><span class=cl><span class=cm>     * and tools rely on their transaction number to work properly.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Invoked by the view server to tell a window to execute the specified
</span></span></span><span class=line><span class=cl><span class=cm>     * command. Any response from the receiver must be sent through the
</span></span></span><span class=line><span class=cl><span class=cm>     * specified file descriptor.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>executeCommand</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>command</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>parameters</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>ParcelFileDescriptor</span><span class=w> </span><span class=n>descriptor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>resized</span><span class=p>(</span><span class=n>in</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>frame</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>overscanInsets</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>contentInsets</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>visibleInsets</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>stableInsets</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>outsets</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>reportDraw</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>in</span><span class=w> </span><span class=n>MergedConfiguration</span><span class=w> </span><span class=n>newMergedConfiguration</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>backDropFrame</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>forceLayout</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>alwaysConsumeNavBar</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>displayId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>moved</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>newX</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>newY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>dispatchAppVisibility</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>visible</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>dispatchGetNewSurface</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Tell the window that it is either gaining or losing focus.  Keep it up
</span></span></span><span class=line><span class=cl><span class=cm>     * to date on the current state showing navigational focus (touch mode) too.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>windowFocusChanged</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>hasFocus</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>inTouchMode</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ViewRootImpl#W.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>W</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>IWindow</span><span class=p>.</span><span class=na>Stub</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>windowFocusChanged</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>hasFocus</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>inTouchMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>ViewRootImpl</span><span class=w> </span><span class=n>viewAncestor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mViewAncestor</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>viewAncestor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>viewAncestor</span><span class=p>.</span><span class=na>windowFocusChanged</span><span class=p>(</span><span class=n>hasFocus</span><span class=p>,</span><span class=w> </span><span class=n>inTouchMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ViewRootImpl.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>windowFocusChanged</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>hasFocus</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>inTouchMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Message</span><span class=p>.</span><span class=na>obtain</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>msg</span><span class=p>.</span><span class=na>what</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MSG_WINDOW_FOCUS_CHANGED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>msg</span><span class=p>.</span><span class=na>arg1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hasFocus</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>msg</span><span class=p>.</span><span class=na>arg2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inTouchMode</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mHandler</span><span class=p>.</span><span class=na>sendMessage</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleMessage</span><span class=p>(</span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=p>.</span><span class=na>what</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>MSG_WINDOW_FOCUS_CHANGED</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAdded</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasWindowFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>arg1</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mHasWindowFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hasWindowFocus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>profileRendering</span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kt>boolean</span><span class=w> </span><span class=n>inTouchMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>arg2</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ensureTouchModeLocally</span><span class=p>(</span><span class=n>inTouchMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mSurface</span><span class=p>.</span><span class=na>isValid</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mFullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=kd>final</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=kd>final</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>surfaceInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>surfaceInsets</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>initializeIfNeeded</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>mHeight</span><span class=p>,</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>,</span><span class=w> </span><span class=n>mSurface</span><span class=p>,</span><span class=w> </span><span class=n>surfaceInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>OutOfResourcesException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;OutOfResourcesException locking surface&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mWindowSession</span><span class=p>.</span><span class=na>outOfMemory</span><span class=p>(</span><span class=n>mWindow</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;No processes killed for memory; killing self&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>Process</span><span class=p>.</span><span class=na>killProcess</span><span class=p>(</span><span class=n>Process</span><span class=p>.</span><span class=na>myPid</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>// Retry in a bit.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>sendMessageDelayed</span><span class=p>(</span><span class=n>obtainMessage</span><span class=p>(</span><span class=n>msg</span><span class=p>.</span><span class=na>what</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>arg1</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>arg2</span><span class=p>),</span><span class=w> </span><span class=n>500</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mLastWasImTarget</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>mayUseInputMethod</span><span class=p>(</span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>flags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>InputMethodManager</span><span class=w> </span><span class=n>imm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>InputMethodManager</span><span class=p>.</span><span class=na>peekInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>imm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mLastWasImTarget</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isInLocalFocusMode</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>imm</span><span class=p>.</span><span class=na>onPreWindowFocus</span><span class=p>(</span><span class=n>mView</span><span class=p>,</span><span class=w> </span><span class=n>hasWindowFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mView</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mKeyDispatchState</span><span class=p>.</span><span class=na>reset</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mView</span><span class=p>.</span><span class=na>dispatchWindowFocusChanged</span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTreeObserver</span><span class=p>.</span><span class=na>dispatchOnWindowFocusChange</span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTooltipHost</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTooltipHost</span><span class=p>.</span><span class=na>hideTooltip</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Note: must be done after the focus change callbacks,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// so all of the view state is set up correctly.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>imm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mLastWasImTarget</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isInLocalFocusMode</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>imm</span><span class=p>.</span><span class=na>onPostWindowFocus</span><span class=p>(</span><span class=n>mView</span><span class=p>,</span><span class=w> </span><span class=n>mView</span><span class=p>.</span><span class=na>findFocus</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>softInputMode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>!</span><span class=n>mHasHadWindowFocus</span><span class=p>,</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>flags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Clear the forward bit.  We can just do this directly, since</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// the window manager doesn&#39;t care about it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>&amp;=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>~</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>((</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>)</span><span class=n>mView</span><span class=p>.</span><span class=na>getLayoutParams</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>&amp;=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=o>~</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mHasHadWindowFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPointerCapture</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>handlePointerCaptureChanged</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>mView.dispatchWindowFocusChanged(hasWindowFocus)</p><p>View.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Called when the window containing this view gains or loses window focus.
</span></span></span><span class=line><span class=cl><span class=cm>     * ViewGroups should override to route to their children.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param hasFocus True if the window containing this view now has focus,
</span></span></span><span class=line><span class=cl><span class=cm>     *        false otherwise.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dispatchWindowFocusChanged</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>hasFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>onWindowFocusChanged</span><span class=p>(</span><span class=n>hasFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>DecorView.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onWindowFocusChanged</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>hasWindowFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onWindowFocusChanged</span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If the user is chording a menu shortcut, release the chord since</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// this window lost focus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mWindow</span><span class=p>.</span><span class=na>hasFeature</span><span class=p>(</span><span class=n>Window</span><span class=p>.</span><span class=na>FEATURE_OPTIONS_PANEL</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>hasWindowFocus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>mPanelChordingKey</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindow</span><span class=p>.</span><span class=na>closePanel</span><span class=p>(</span><span class=n>Window</span><span class=p>.</span><span class=na>FEATURE_OPTIONS_PANEL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Window</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=n>cb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>getCallback</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cb</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mWindow</span><span class=p>.</span><span class=na>isDestroyed</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mFeatureId</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cb</span><span class=p>.</span><span class=na>onWindowFocusChanged</span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPrimaryActionMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPrimaryActionMode</span><span class=p>.</span><span class=na>onWindowFocusChanged</span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mFloatingActionMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mFloatingActionMode</span><span class=p>.</span><span class=na>onWindowFocusChanged</span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>updateElevation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://epicmars.github.io/>AndroidPi</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 8" fill="currentcolor"><path d="M12 8H0l6-8z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>