<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>源码分析：理解Context | AndroidPi</title>
<meta name=keywords content><meta name=description content="Context一般翻译为上下文，它提供了一个应用环境的全局接口，用于访问指定应用的资源和类，以及各种应用级别的操作，如启动Activities与Service、发送广播与注册广播接收器、接收Intents、获取系统服务等等。
Application的Context ActivityThread.java
public static void main(String[] args) { // ... ActivityThread thread = new ActivityThread(); thread.attach(false); // ... } private void attach(boolean system) { // ... if (!system) { // ... final IActivityManager mgr = ActivityManager.getService(); try { mgr.attachApplication(mAppThread); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } // ... } // ... } ActivityManagerService.java
@Override public final void attachApplication(IApplicationThread thread) { synchronized (this) { int callingPid = Binder.getCallingPid(); final long origId = Binder."><meta name=author content="LEOY"><link rel=canonical href=https://epicmars.github.io/blog/android/framework/2018-06-14-android-understanding-context/><link crossorigin=anonymous href=/assets/css/stylesheet.1715a8df06a9f4f4b7cfb26895ef9124122a85cbef9cde37608112c4ba7767f6.css integrity="sha256-FxWo3wap9PS3z7Jole+RJBIqhcvvnN43YIESxLp3Z/Y=" rel="preload stylesheet" as=style><link rel=icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=icon type=image/png sizes=16x16 href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=icon type=image/png sizes=32x32 href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg%22><link rel=apple-touch-icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=mask-icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://epicmars.github.io/blog/android/framework/2018-06-14-android-understanding-context/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script defer crossorigin=anonymous src=/js/custom.f20a5212619392e989b6d24ad9ce42302014debfad4d3c8c01db030c36d03475.js integrity="sha256-8gpSEmGTkumJttJK2c5CMCAU3r+tTTyMAdsDDDbQNHU="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css integrity=sha384-Juol1FqnotbkyZUT5Z7gUPjQ9gzlwCENvUZTpQBAPxtusdwFLRy382PSDx5UUJ4/ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.js integrity=sha384-97gW6UIJxnlKemYavrqDHSX3SiygeOwIZhwyOKRfSaf0JWKRVj9hLASHgFTzT+0O crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-NMEMBZ8R90"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NMEMBZ8R90")}</script><meta property="og:title" content="源码分析：理解Context"><meta property="og:description" content="Context一般翻译为上下文，它提供了一个应用环境的全局接口，用于访问指定应用的资源和类，以及各种应用级别的操作，如启动Activities与Service、发送广播与注册广播接收器、接收Intents、获取系统服务等等。
Application的Context ActivityThread.java
public static void main(String[] args) { // ... ActivityThread thread = new ActivityThread(); thread.attach(false); // ... } private void attach(boolean system) { // ... if (!system) { // ... final IActivityManager mgr = ActivityManager.getService(); try { mgr.attachApplication(mAppThread); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } // ... } // ... } ActivityManagerService.java
@Override public final void attachApplication(IApplicationThread thread) { synchronized (this) { int callingPid = Binder.getCallingPid(); final long origId = Binder."><meta property="og:type" content="article"><meta property="og:url" content="https://epicmars.github.io/blog/android/framework/2018-06-14-android-understanding-context/"><meta property="og:image" content="https://epicmars.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="blog"><meta property="article:published_time" content="2018-06-14T21:22:35+08:00"><meta property="article:modified_time" content="2018-06-14T21:22:35+08:00"><meta property="og:site_name" content="androidpi"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://epicmars.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="源码分析：理解Context"><meta name=twitter:description content="Context一般翻译为上下文，它提供了一个应用环境的全局接口，用于访问指定应用的资源和类，以及各种应用级别的操作，如启动Activities与Service、发送广播与注册广播接收器、接收Intents、获取系统服务等等。
Application的Context ActivityThread.java
public static void main(String[] args) { // ... ActivityThread thread = new ActivityThread(); thread.attach(false); // ... } private void attach(boolean system) { // ... if (!system) { // ... final IActivityManager mgr = ActivityManager.getService(); try { mgr.attachApplication(mAppThread); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } // ... } // ... } ActivityManagerService.java
@Override public final void attachApplication(IApplicationThread thread) { synchronized (this) { int callingPid = Binder.getCallingPid(); final long origId = Binder."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://epicmars.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Android","item":"https://epicmars.github.io/blog/android/"},{"@type":"ListItem","position":3,"name":"源码分析：理解Context","item":"https://epicmars.github.io/blog/android/framework/2018-06-14-android-understanding-context/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"源码分析：理解Context","name":"源码分析：理解Context","description":"Context一般翻译为上下文，它提供了一个应用环境的全局接口，用于访问指定应用的资源和类，以及各种应用级别的操作，如启动Activities与Service、发送广播与注册广播接收器、接收Intents、获取系统服务等等。\nApplication的Context ActivityThread.java\npublic static void main(String[] args) { // ... ActivityThread thread = new ActivityThread(); thread.attach(false); // ... } private void attach(boolean system) { // ... if (!system) { // ... final IActivityManager mgr = ActivityManager.getService(); try { mgr.attachApplication(mAppThread); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } // ... } // ... } ActivityManagerService.java\n@Override public final void attachApplication(IApplicationThread thread) { synchronized (this) { int callingPid = Binder.getCallingPid(); final long origId = Binder.","keywords":[],"articleBody":"Context一般翻译为上下文，它提供了一个应用环境的全局接口，用于访问指定应用的资源和类，以及各种应用级别的操作，如启动Activities与Service、发送广播与注册广播接收器、接收Intents、获取系统服务等等。\nApplication的Context ActivityThread.java\npublic static void main(String[] args) { // ... ActivityThread thread = new ActivityThread(); thread.attach(false); // ... } private void attach(boolean system) { // ... if (!system) { // ... final IActivityManager mgr = ActivityManager.getService(); try { mgr.attachApplication(mAppThread); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } // ... } // ... } ActivityManagerService.java\n@Override public final void attachApplication(IApplicationThread thread) { synchronized (this) { int callingPid = Binder.getCallingPid(); final long origId = Binder.clearCallingIdentity(); attachApplicationLocked(thread, callingPid); Binder.restoreCallingIdentity(origId); } } private final boolean attachApplicationLocked(IApplicationThread thread, int pid) { // ... if (app.instr != null) { thread.bindApplication(processName, appInfo, providers, app.instr.mClass, profilerInfo, app.instr.mArguments, app.instr.mWatcher, app.instr.mUiAutomationConnection, testMode, mBinderTransactionTrackingEnabled, enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.persistent, new Configuration(getGlobalConfiguration()), app.compat, getCommonServicesLocked(app.isolated), mCoreSettingsObserver.getCoreSettingsLocked(), buildSerial); } else { thread.bindApplication(processName, appInfo, providers, null, profilerInfo, null, null, null, testMode, mBinderTransactionTrackingEnabled, enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.persistent, new Configuration(getGlobalConfiguration()), app.compat, getCommonServicesLocked(app.isolated), mCoreSettingsObserver.getCoreSettingsLocked(), buildSerial); } // ... } ActivityThread.java\nprivate void handleBindApplication(AppBindData data) { // ... final ContextImpl appContext = ContextImpl.createAppContext(this, data.loadedApk); // ... try { // If the app is being launched for full backup or restore, bring it up in // a restricted environment with the base application class. app = data.loadedApk.makeApplication(data.restrictedBackupMode, null); mInitialApplication = app; // ... } // ... } LoadedApk.java\npublic Application makeApplication(boolean forceDefaultAppClass, Instrumentation instrumentation) { if (mApplication != null) { return mApplication; } Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"makeApplication\"); Application app = null; String appClass = mApplicationInfo.className; if (forceDefaultAppClass || (appClass == null)) { appClass = \"android.app.Application\"; } try { java.lang.ClassLoader cl = getClassLoader(); if (!mPackageName.equals(\"android\")) { Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"initializeJavaContextClassLoader\"); initializeJavaContextClassLoader(); Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); } ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, this); app = mActivityThread.mInstrumentation.newApplication( cl, appClass, appContext); appContext.setOuterContext(app); } catch (Exception e) { if (!mActivityThread.mInstrumentation.onException(app, e)) { Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); throw new RuntimeException( \"Unable to instantiate application \" + appClass + \": \" + e.toString(), e); } } mActivityThread.mAllApplications.add(app); mApplication = app; if (instrumentation != null) { try { instrumentation.callApplicationOnCreate(app); } catch (Exception e) { if (!instrumentation.onException(app, e)) { Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); throw new RuntimeException( \"Unable to create application \" + app.getClass().getName() + \": \" + e.toString(), e); } } } // Rewrite the R 'constants' for all library apks. SparseArray\u003cString\u003e packageIdentifiers = getAssets().getAssignedPackageIdentifiers(); final int N = packageIdentifiers.size(); for (int i = 0; i \u003c N; i++) { final int id = packageIdentifiers.keyAt(i); if (id == 0x01 || id == 0x7f) { continue; } rewriteRValues(getClassLoader(), packageIdentifiers.valueAt(i), id); } Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); return app; } ContextImpl.java\nstatic ContextImpl createAppContext(ActivityThread mainThread, LoadedApk loadedApk) { if (loadedApk == null) throw new IllegalArgumentException(\"loadedApk\"); ContextImpl context = new ContextImpl(null, mainThread, loadedApk, null, null, null, 0, null); context.setResources(loadedApk.getResources()); return context; } Activity的Context ActivityThread.java\nprivate Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) { // ... ContextImpl appContext = createBaseContextForActivity(r); // ... if (activity != null) { CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager()); Configuration config = new Configuration(mCompatConfiguration); if (r.overrideConfig != null) { config.updateFrom(r.overrideConfig); } if (DEBUG_CONFIGURATION) Slog.v(TAG, \"Launching activity \" + r.activityInfo.name + \" with config \" + config); Window window = null; if (r.mPendingRemoveWindow != null \u0026\u0026 r.mPreserveWindow) { window = r.mPendingRemoveWindow; r.mPendingRemoveWindow = null; r.mPendingRemoveWindowManager = null; } appContext.setOuterContext(activity); activity.attach(appContext, this, getInstrumentation(), r.token, r.ident, app, r.intent, r.activityInfo, title, r.parent, r.embeddedID, r.lastNonConfigurationInstances, config, r.referrer, r.voiceInteractor, window, r.configCallback); // ... } private ContextImpl createBaseContextForActivity(ActivityClientRecord r) { final int displayId; try { displayId = ActivityManager.getService().getActivityDisplayId(r.token); } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } ContextImpl appContext = ContextImpl.createActivityContext( this, r.loadedApk, r.activityInfo, r.token, displayId, r.overrideConfig); final DisplayManagerGlobal dm = DisplayManagerGlobal.getInstance(); // For debugging purposes, if the activity's package name contains the value of // the \"debug.use-second-display\" system property as a substring, then show // its content on a secondary display if there is one. String pkgName = SystemProperties.get(\"debug.second-display.pkg\"); if (pkgName != null \u0026\u0026 !pkgName.isEmpty() \u0026\u0026 r.loadedApk.mPackageName.contains(pkgName)) { for (int id : dm.getDisplayIds()) { if (id != Display.DEFAULT_DISPLAY) { Display display = dm.getCompatibleDisplay(id, appContext.getResources()); appContext = (ContextImpl) appContext.createDisplayContext(display); break; } } } return appContext; } Activity.java\nfinal void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor, Window window, ActivityConfigCallback activityConfigCallback) { attachBaseContext(context); mFragments.attachHost(null /*parent*/); mWindow = new PhoneWindow(this, window, activityConfigCallback); mWindow.setWindowControllerCallback(this); mWindow.setCallback(this); mWindow.setOnWindowDismissedCallback(this); mWindow.getLayoutInflater().setPrivateFactory(this); if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) { mWindow.setSoftInputMode(info.softInputMode); } if (info.uiOptions != 0) { mWindow.setUiOptions(info.uiOptions); } mUiThread = Thread.currentThread(); mMainThread = aThread; mInstrumentation = instr; mToken = token; mIdent = ident; mApplication = application; mIntent = intent; mReferrer = referrer; mComponent = intent.getComponent(); mActivityInfo = info; mTitle = title; mParent = parent; mEmbeddedID = id; mLastNonConfigurationInstances = lastNonConfigurationInstances; if (voiceInteractor != null) { if (lastNonConfigurationInstances != null) { mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor; } else { mVoiceInteractor = new VoiceInteractor(voiceInteractor, this, this, Looper.myLooper()); } } mWindow.setWindowManager( (WindowManager)context.getSystemService(Context.WINDOW_SERVICE), mToken, mComponent.flattenToString(), (info.flags \u0026 ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0); if (mParent != null) { mWindow.setContainer(mParent.getWindow()); } mWindowManager = mWindow.getWindowManager(); mCurrentConfig = config; mWindow.setColorMode(info.colorMode); } ContextImpl.java\nstatic ContextImpl createActivityContext(ActivityThread mainThread, LoadedApk loadedApk, ActivityInfo activityInfo, IBinder activityToken, int displayId, Configuration overrideConfiguration) { if (loadedApk == null) throw new IllegalArgumentException(\"loadedApk\"); String[] splitDirs = loadedApk.getSplitResDirs(); ClassLoader classLoader = loadedApk.getClassLoader(); if (loadedApk.getApplicationInfo().requestsIsolatedSplitLoading()) { Trace.traceBegin(Trace.TRACE_TAG_RESOURCES, \"SplitDependencies\"); try { classLoader = loadedApk.getSplitClassLoader(activityInfo.splitName); splitDirs = loadedApk.getSplitPaths(activityInfo.splitName); } catch (NameNotFoundException e) { // Nothing above us can handle a NameNotFoundException, better crash. throw new RuntimeException(e); } finally { Trace.traceEnd(Trace.TRACE_TAG_RESOURCES); } } ContextImpl context = new ContextImpl(null, mainThread, loadedApk, activityInfo.splitName, activityToken, null, 0, classLoader); // Clamp display ID to DEFAULT_DISPLAY if it is INVALID_DISPLAY. displayId = (displayId != Display.INVALID_DISPLAY) ? displayId : Display.DEFAULT_DISPLAY; final CompatibilityInfo compatInfo = (displayId == Display.DEFAULT_DISPLAY) ? loadedApk.getCompatibilityInfo() : CompatibilityInfo.DEFAULT_COMPATIBILITY_INFO; final ResourcesManager resourcesManager = ResourcesManager.getInstance(); // Create the base resources for which all configuration contexts for this Activity // will be rebased upon. context.setResources(resourcesManager.createBaseActivityResources(activityToken, loadedApk.getResDir(), splitDirs, loadedApk.getOverlayDirs(), loadedApk.getApplicationInfo().sharedLibraryFiles, displayId, overrideConfiguration, compatInfo, classLoader)); context.mDisplay = resourcesManager.getAdjustedDisplay(displayId, context.getResources()); return context; } View的Context View属于一个Window，具体来说的是PhoneWindow，PhoneWindow在实例化时使用的当前Activity作为参数，在设置View时的代码如下：\nPhoneWindow.java\n@Override public void setContentView(int layoutResID) { // Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window // decor, when theme attributes and the like are crystalized. Do not check the feature // before this happens. if (mContentParent == null) { installDecor(); } else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) { mContentParent.removeAllViews(); } if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) { final Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID, getContext()); transitionTo(newScene); } else { mLayoutInflater.inflate(layoutResID, mContentParent); } mContentParent.requestApplyInsets(); final Callback cb = getCallback(); if (cb != null \u0026\u0026 !isDestroyed()) { cb.onContentChanged(); } mContentParentExplicitlySet = true; } public PhoneWindow(Context context) { super(context); mLayoutInflater = LayoutInflater.from(context); } LayoutInflater.java\n/** * Obtains the LayoutInflater from the given context. */ public static LayoutInflater from(Context context) { LayoutInflater LayoutInflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE); if (LayoutInflater == null) { throw new AssertionError(\"LayoutInflater not found.\"); } return LayoutInflater; } 其中LayoutInflater直接从静态方法获取，那么获取到的LayoutInflater实例是没有与特定Context绑定的，但是这个Context是PhoneWindow所在Activity，那么为了让LayoutInflater绑定一个Context必须进行多态处理，那么可以发现Activity的一级父类ContextThemeWrapper重写了getSystemService方法，正是此处将Context绑定到LayoutInflater：\nContextThemeWrapper.java，\n@Override public Object getSystemService(String name) { if (LAYOUT_INFLATER_SERVICE.equals(name)) { if (mInflater == null) { mInflater = LayoutInflater.from(getBaseContext()).cloneInContext(this); } return mInflater; } return getBaseContext().getSystemService(name); } View.getContext()是否可以直接转型为Activity 为了使用支持库的ActionBar特征有时会使用AppCompatActivity作为Activity的父类，此时，根据上面的分析，使用LayoutInflater.from(getBaseContext())方法拿到的LayoutInflater实际上是Activity的一个实例变量。在AppCompatActivity的onCreate方法中，通过调用delegate.installViewFactory()为该LayoutInflater实例设置Factory2变量，然后在设置界面时setContentView(int res)会调用到代理AppCompatDelegate中的setContentView(int res)，而该代理的实例继承了AppCompatDelegateImplV9，而AppCompatDelegateImplV9实现了LayoutInflater.Factory2接口，并将其设置为上面的LayoutInflater实例中，最终在从布局文件创建视图时，AppCompatDelegateImplV9对LayoutInflater.Factory2中方法的实现中，会使用AppCompatViewInflater来对单个的View进行处理，将其替换为支持库中的类：\nfinal View createView(View parent, final String name, @NonNull Context context, @NonNull AttributeSet attrs, boolean inheritContext, boolean readAndroidTheme, boolean readAppTheme, boolean wrapContext) { final Context originalContext = context; // We can emulate Lollipop's android:theme attribute propagating down the view hierarchy // by using the parent's context if (inheritContext \u0026\u0026 parent != null) { context = parent.getContext(); } if (readAndroidTheme || readAppTheme) { // We then apply the theme on the context, if specified context = themifyContext(context, attrs, readAndroidTheme, readAppTheme); } if (wrapContext) { context = TintContextWrapper.wrap(context); } View view = null; // We need to 'inject' our tint aware Views in place of the standard framework versions switch (name) { case \"TextView\": view = createTextView(context, attrs); verifyNotNull(view, name); break; case \"ImageView\": view = createImageView(context, attrs); verifyNotNull(view, name); break; case \"Button\": view = createButton(context, attrs); verifyNotNull(view, name); break; case \"EditText\": view = createEditText(context, attrs); verifyNotNull(view, name); break; case \"Spinner\": view = createSpinner(context, attrs); verifyNotNull(view, name); break; case \"ImageButton\": view = createImageButton(context, attrs); verifyNotNull(view, name); break; case \"CheckBox\": view = createCheckBox(context, attrs); verifyNotNull(view, name); break; case \"RadioButton\": view = createRadioButton(context, attrs); verifyNotNull(view, name); break; case \"CheckedTextView\": view = createCheckedTextView(context, attrs); verifyNotNull(view, name); break; case \"AutoCompleteTextView\": view = createAutoCompleteTextView(context, attrs); verifyNotNull(view, name); break; case \"MultiAutoCompleteTextView\": view = createMultiAutoCompleteTextView(context, attrs); verifyNotNull(view, name); break; case \"RatingBar\": view = createRatingBar(context, attrs); verifyNotNull(view, name); break; case \"SeekBar\": view = createSeekBar(context, attrs); verifyNotNull(view, name); break; default: // The fallback that allows extending class to take over view inflation // for other tags. Note that we don't check that the result is not-null. // That allows the custom inflater path to fall back on the default one // later in this method. view = createView(context, name, attrs); } if (view == null \u0026\u0026 originalContext != context) { // If the original context does not equal our themed context, then we need to manually // inflate it using the name so that android:theme takes effect. view = createViewFromTag(context, name, attrs); } if (view != null) { // If we have created a view, check its android:onClick checkOnClickListener(view, attrs); } return view; } 可以看到，此时拿到的View所持有的Context已经不是原来的Activity了，很可能会是一个将原来Activity实例包裹起来的ContextWrapper实例。因此如果从View中拿到Context后，并不能直接转型为Activity，而是应当将其一层一层剥开，才能拿到最原始的Activity实例。\n","wordCount":"1431","inLanguage":"en","datePublished":"2018-06-14T21:22:35+08:00","dateModified":"2018-06-14T21:22:35+08:00","author":{"@type":"Person","name":"LEOY"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://epicmars.github.io/blog/android/framework/2018-06-14-android-understanding-context/"},"publisher":{"@type":"Organization","name":"AndroidPi","logo":{"@type":"ImageObject","url":"https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg"}}}</script></head><body id=top><script>const hasHeaderBg=!1</script><header class=header><div class=nav-container><nav class=nav><div class=logo><a href=/ accesskey=h title="AndroidPi (Alt + H)"><svg width="25" height="24" viewBox="0 0 25 24" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient x1="76.7202373%" y1="41.6070847%" x2="18.306123%" y2="65.5065085%" id="linearGradient-9_1k7ha4jv-1"><stop stop-color="#797beb" offset="0"/><stop stop-color="#373080" offset="100%"/></linearGradient></defs><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="_编组-7" fill="url(#linearGradient-9_1k7ha4jv-1)"><path d="M12.2746711.0C12.5125388.0 12.7434104.12583746 12.8693403.33556656l1.3852293 2.3769298h6.1425827C20.63502 2.71249636 20.8658915 2.83833382 20.9918215 3.04806292l1.7420308 2.97815322C22.8597822 6.23594524 22.8597822 6.5016021 22.7338523 6.7113312L22.6988718 6.76725896C22.6708873 6.80920478 22.6359068 6.8511506 22.5939301 6.88610545L21.2156969 9.24905331l3.050303 5.24322749L24.3429571 14.6041363C24.4339065 14.8138654 24.4548948 15.0795223 24.3919298 15.2682785l-1.6021086 2.7404602C22.6638912 18.2184678 22.4400158 18.3443053 22.195152 18.3443053L19.4176972 18.3582872 16.353402 23.6504515C16.227472 23.8601806 16.0035966 23.9860181 15.7587328 23.9860181L12.2886633 24H12.2396906C12.0158151 23.9860181 11.7989358 23.8601806 11.6869981 23.6644334l-1.490171-2.551704H4.13120166C4.0822289 21.1267113 4.04025225 21.1267113 3.9912795 21.1267113 3.75341183 21.1267113 3.52254028 21.0008739 3.39661034 20.7911448L1.79450165 18.0506845C1.66857171 17.8479464 1.66857171 17.5892805 1.79450165 17.3725604l1.37823324-2.3909117L.0944474553 9.69647539c-.1259299404-.20273813-.1259299404-.46140402.0-.678124089999999L1.80849387 6.02621614c.11193772-.2097291.34280928-.33556656.59466916-.33556656C2.466128 5.67666764 2.51510075 5.69064958 2.56407351 5.70463152H5.40449327L8.44080406.46140402C8.45479628.4194582 8.46179238.38450335 8.48278071.35653947L8.49677292.33556656C8.62270286.12583746 8.84657831.0 9.09144209.0H12.2816672 12.2746711zM9.04246933.72706088 5.74730256 6.41071949H2.3751786L8.93752771 17.6871541H5.59338819l-1.61610091 2.789397H10.5606247l1.6790659 2.8942616 6.5623491-11.3043985 1.6790659 2.8802797L23.7203035 14.9327119 20.4181406 9.24905331l1.6650737-2.8662977L9.00049268 6.39673755 10.6795586 3.51645791 9.04946544.72706088H9.04246933zM16.1435187 9.82930382 12.2187023 16.5755899 8.2938858 9.82930382h7.8496329z" id="_形状"/></g></g></svg></a><div class=logo-switches></div></div><ul id=menu><li><a href=/resources title=Resources><span>Resources</span></a></li><li><a href=/blog/ title=Blog><span>Blog</span></a></li><li><a href=/publication title=Publication><span>Publication</span></a></li><li><a href=/about title=About><span>About</span></a></li></ul></nav></div></header><div class=hero-container><div class=hero><h1 class=post-title>源码分析：理解Context</h1><div class=post-meta><span title='2018-06-14 21:22:35 +0800 CST'>June 14, 2018</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1431 words&nbsp;·&nbsp;LEOY</div></div></div><main class=main><article class=post-single><div class=post-content><p>Context一般翻译为上下文，它提供了一个应用环境的全局接口，用于访问指定应用的资源和类，以及各种应用级别的操作，如启动Activities与Service、发送广播与注册广播接收器、接收Intents、获取系统服务等等。</p><h2 id=application的context>Application的Context<a hidden class=anchor aria-hidden=true href=#application的context>#</a></h2><p>ActivityThread.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ActivityThread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ActivityThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>attach</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>system</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>system</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>IActivityManager</span><span class=w> </span><span class=n>mgr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mgr</span><span class=p>.</span><span class=na>attachApplication</span><span class=p>(</span><span class=n>mAppThread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ActivityManagerService.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>attachApplication</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>thread</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>callingPid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingPid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>origId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>clearCallingIdentity</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>attachApplicationLocked</span><span class=p>(</span><span class=n>thread</span><span class=p>,</span><span class=w> </span><span class=n>callingPid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Binder</span><span class=p>.</span><span class=na>restoreCallingIdentity</span><span class=p>(</span><span class=n>origId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>attachApplicationLocked</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>thread</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>bindApplication</span><span class=p>(</span><span class=n>processName</span><span class=p>,</span><span class=w> </span><span class=n>appInfo</span><span class=p>,</span><span class=w> </span><span class=n>providers</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mClass</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mArguments</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mWatcher</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>app</span><span class=p>.</span><span class=na>instr</span><span class=p>.</span><span class=na>mUiAutomationConnection</span><span class=p>,</span><span class=w> </span><span class=n>testMode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mBinderTransactionTrackingEnabled</span><span class=p>,</span><span class=w> </span><span class=n>enableTrackAllocation</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>isRestrictedBackupMode</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>normalMode</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>persistent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=n>getGlobalConfiguration</span><span class=p>()),</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>compat</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>getCommonServicesLocked</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>isolated</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mCoreSettingsObserver</span><span class=p>.</span><span class=na>getCoreSettingsLocked</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>buildSerial</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>bindApplication</span><span class=p>(</span><span class=n>processName</span><span class=p>,</span><span class=w> </span><span class=n>appInfo</span><span class=p>,</span><span class=w> </span><span class=n>providers</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>testMode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mBinderTransactionTrackingEnabled</span><span class=p>,</span><span class=w> </span><span class=n>enableTrackAllocation</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>isRestrictedBackupMode</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>normalMode</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>persistent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=n>getGlobalConfiguration</span><span class=p>()),</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>compat</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>getCommonServicesLocked</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=na>isolated</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mCoreSettingsObserver</span><span class=p>.</span><span class=na>getCoreSettingsLocked</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>buildSerial</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ActivityThread.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleBindApplication</span><span class=p>(</span><span class=n>AppBindData</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ContextImpl</span><span class=w> </span><span class=n>appContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContextImpl</span><span class=p>.</span><span class=na>createAppContext</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>loadedApk</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the app is being launched for full backup or restore, bring it up in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// a restricted environment with the base application class.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>loadedApk</span><span class=p>.</span><span class=na>makeApplication</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>restrictedBackupMode</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mInitialApplication</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>LoadedApk.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Application</span><span class=w> </span><span class=nf>makeApplication</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>forceDefaultAppClass</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Instrumentation</span><span class=w> </span><span class=n>instrumentation</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mApplication</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>mApplication</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>,</span><span class=w> </span><span class=s>&#34;makeApplication&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Application</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>appClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mApplicationInfo</span><span class=p>.</span><span class=na>className</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>forceDefaultAppClass</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>appClass</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>appClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;android.app.Application&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ClassLoader</span><span class=w> </span><span class=n>cl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mPackageName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;android&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;initializeJavaContextClassLoader&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>initializeJavaContextClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ContextImpl</span><span class=w> </span><span class=n>appContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContextImpl</span><span class=p>.</span><span class=na>createAppContext</span><span class=p>(</span><span class=n>mActivityThread</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActivityThread</span><span class=p>.</span><span class=na>mInstrumentation</span><span class=p>.</span><span class=na>newApplication</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>appClass</span><span class=p>,</span><span class=w> </span><span class=n>appContext</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>appContext</span><span class=p>.</span><span class=na>setOuterContext</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mActivityThread</span><span class=p>.</span><span class=na>mInstrumentation</span><span class=p>.</span><span class=na>onException</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;Unable to instantiate application &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>appClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mActivityThread</span><span class=p>.</span><span class=na>mAllApplications</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mApplication</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>instrumentation</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>instrumentation</span><span class=p>.</span><span class=na>callApplicationOnCreate</span><span class=p>(</span><span class=n>app</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>instrumentation</span><span class=p>.</span><span class=na>onException</span><span class=p>(</span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;Unable to create application &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Rewrite the R &#39;constants&#39; for all library apks.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SparseArray</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>packageIdentifiers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getAssets</span><span class=p>().</span><span class=na>getAssignedPackageIdentifiers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>packageIdentifiers</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>N</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>packageIdentifiers</span><span class=p>.</span><span class=na>keyAt</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0x01</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0x7f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rewriteRValues</span><span class=p>(</span><span class=n>getClassLoader</span><span class=p>(),</span><span class=w> </span><span class=n>packageIdentifiers</span><span class=p>.</span><span class=na>valueAt</span><span class=p>(</span><span class=n>i</span><span class=p>),</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ContextImpl.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>ContextImpl</span><span class=w> </span><span class=nf>createAppContext</span><span class=p>(</span><span class=n>ActivityThread</span><span class=w> </span><span class=n>mainThread</span><span class=p>,</span><span class=w> </span><span class=n>LoadedApk</span><span class=w> </span><span class=n>loadedApk</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadedApk</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;loadedApk&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ContextImpl</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ContextImpl</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>mainThread</span><span class=p>,</span><span class=w> </span><span class=n>loadedApk</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>context</span><span class=p>.</span><span class=na>setResources</span><span class=p>(</span><span class=n>loadedApk</span><span class=p>.</span><span class=na>getResources</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>context</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=activity的context>Activity的Context<a hidden class=anchor aria-hidden=true href=#activity的context>#</a></h2><p>ActivityThread.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=nf>performLaunchActivity</span><span class=p>(</span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>customIntent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ContextImpl</span><span class=w> </span><span class=n>appContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createBaseContextForActivity</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>activity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CharSequence</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>loadLabel</span><span class=p>(</span><span class=n>appContext</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=n>mCompatConfiguration</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>overrideConfig</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>config</span><span class=p>.</span><span class=na>updateFrom</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>overrideConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_CONFIGURATION</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Launching activity &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; with config &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>config</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Window</span><span class=w> </span><span class=n>window</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindow</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>mPreserveWindow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>window</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindow</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>mPendingRemoveWindowManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>appContext</span><span class=p>.</span><span class=na>setOuterContext</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>activity</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=n>appContext</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>getInstrumentation</span><span class=p>(),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>ident</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>,</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>parent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>embeddedID</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>lastNonConfigurationInstances</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>referrer</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=p>,</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>configCallback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ContextImpl</span><span class=w> </span><span class=nf>createBaseContextForActivity</span><span class=p>(</span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>displayId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>displayId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>().</span><span class=na>getActivityDisplayId</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ContextImpl</span><span class=w> </span><span class=n>appContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContextImpl</span><span class=p>.</span><span class=na>createActivityContext</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>loadedApk</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=n>displayId</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>overrideConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>DisplayManagerGlobal</span><span class=w> </span><span class=n>dm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DisplayManagerGlobal</span><span class=p>.</span><span class=na>getInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// For debugging purposes, if the activity&#39;s package name contains the value of</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// the &#34;debug.use-second-display&#34; system property as a substring, then show</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// its content on a secondary display if there is one.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>pkgName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemProperties</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;debug.second-display.pkg&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pkgName</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>pkgName</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>loadedApk</span><span class=p>.</span><span class=na>mPackageName</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>pkgName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>dm</span><span class=p>.</span><span class=na>getDisplayIds</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Display</span><span class=p>.</span><span class=na>DEFAULT_DISPLAY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Display</span><span class=w> </span><span class=n>display</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>dm</span><span class=p>.</span><span class=na>getCompatibleDisplay</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>appContext</span><span class=p>.</span><span class=na>getResources</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>appContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ContextImpl</span><span class=p>)</span><span class=w> </span><span class=n>appContext</span><span class=p>.</span><span class=na>createDisplayContext</span><span class=p>(</span><span class=n>display</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>appContext</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Activity.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>attach</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>ActivityThread</span><span class=w> </span><span class=n>aThread</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Instrumentation</span><span class=w> </span><span class=n>instr</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ident</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Application</span><span class=w> </span><span class=n>application</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CharSequence</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>parent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>NonConfigurationInstances</span><span class=w> </span><span class=n>lastNonConfigurationInstances</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>referrer</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Window</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>ActivityConfigCallback</span><span class=w> </span><span class=n>activityConfigCallback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>attachBaseContext</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mFragments</span><span class=p>.</span><span class=na>attachHost</span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=cm>/*parent*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PhoneWindow</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>activityConfigCallback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setWindowControllerCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setOnWindowDismissedCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>getLayoutInflater</span><span class=p>().</span><span class=na>setPrivateFactory</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_STATE_UNSPECIFIED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setSoftInputMode</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>softInputMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>uiOptions</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setUiOptions</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>uiOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mUiThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mMainThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>aThread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mInstrumentation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>instr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mIdent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ident</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mApplication</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>application</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mIntent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mReferrer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>referrer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mComponent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mActivityInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>info</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mTitle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>title</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mParent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mEmbeddedID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLastNonConfigurationInstances</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastNonConfigurationInstances</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>voiceInteractor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastNonConfigurationInstances</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mVoiceInteractor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lastNonConfigurationInstances</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mVoiceInteractor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>VoiceInteractor</span><span class=p>(</span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Looper</span><span class=p>.</span><span class=na>myLooper</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setWindowManager</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>WindowManager</span><span class=p>)</span><span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>WINDOW_SERVICE</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mToken</span><span class=p>,</span><span class=w> </span><span class=n>mComponent</span><span class=p>.</span><span class=na>flattenToString</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ActivityInfo</span><span class=p>.</span><span class=na>FLAG_HARDWARE_ACCELERATED</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mParent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setContainer</span><span class=p>(</span><span class=n>mParent</span><span class=p>.</span><span class=na>getWindow</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindowManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>getWindowManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mCurrentConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setColorMode</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>colorMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ContextImpl.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>ContextImpl</span><span class=w> </span><span class=nf>createActivityContext</span><span class=p>(</span><span class=n>ActivityThread</span><span class=w> </span><span class=n>mainThread</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LoadedApk</span><span class=w> </span><span class=n>loadedApk</span><span class=p>,</span><span class=w> </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>activityInfo</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>activityToken</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>displayId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Configuration</span><span class=w> </span><span class=n>overrideConfiguration</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadedApk</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;loadedApk&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>splitDirs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadedApk</span><span class=p>.</span><span class=na>getSplitResDirs</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClassLoader</span><span class=w> </span><span class=n>classLoader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadedApk</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadedApk</span><span class=p>.</span><span class=na>getApplicationInfo</span><span class=p>().</span><span class=na>requestsIsolatedSplitLoading</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_RESOURCES</span><span class=p>,</span><span class=w> </span><span class=s>&#34;SplitDependencies&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>classLoader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadedApk</span><span class=p>.</span><span class=na>getSplitClassLoader</span><span class=p>(</span><span class=n>activityInfo</span><span class=p>.</span><span class=na>splitName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>splitDirs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadedApk</span><span class=p>.</span><span class=na>getSplitPaths</span><span class=p>(</span><span class=n>activityInfo</span><span class=p>.</span><span class=na>splitName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NameNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Nothing above us can handle a NameNotFoundException, better crash.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_RESOURCES</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ContextImpl</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ContextImpl</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>mainThread</span><span class=p>,</span><span class=w> </span><span class=n>loadedApk</span><span class=p>,</span><span class=w> </span><span class=n>activityInfo</span><span class=p>.</span><span class=na>splitName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>activityToken</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>classLoader</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Clamp display ID to DEFAULT_DISPLAY if it is INVALID_DISPLAY.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>displayId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>displayId</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Display</span><span class=p>.</span><span class=na>INVALID_DISPLAY</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>displayId</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Display</span><span class=p>.</span><span class=na>DEFAULT_DISPLAY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>CompatibilityInfo</span><span class=w> </span><span class=n>compatInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>displayId</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Display</span><span class=p>.</span><span class=na>DEFAULT_DISPLAY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>?</span><span class=w> </span><span class=n>loadedApk</span><span class=p>.</span><span class=na>getCompatibilityInfo</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>:</span><span class=w> </span><span class=n>CompatibilityInfo</span><span class=p>.</span><span class=na>DEFAULT_COMPATIBILITY_INFO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ResourcesManager</span><span class=w> </span><span class=n>resourcesManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ResourcesManager</span><span class=p>.</span><span class=na>getInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Create the base resources for which all configuration contexts for this Activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// will be rebased upon.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>context</span><span class=p>.</span><span class=na>setResources</span><span class=p>(</span><span class=n>resourcesManager</span><span class=p>.</span><span class=na>createBaseActivityResources</span><span class=p>(</span><span class=n>activityToken</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>loadedApk</span><span class=p>.</span><span class=na>getResDir</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>splitDirs</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>loadedApk</span><span class=p>.</span><span class=na>getOverlayDirs</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>loadedApk</span><span class=p>.</span><span class=na>getApplicationInfo</span><span class=p>().</span><span class=na>sharedLibraryFiles</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>displayId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>overrideConfiguration</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>compatInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>classLoader</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>context</span><span class=p>.</span><span class=na>mDisplay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resourcesManager</span><span class=p>.</span><span class=na>getAdjustedDisplay</span><span class=p>(</span><span class=n>displayId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>context</span><span class=p>.</span><span class=na>getResources</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>context</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=view的context>View的Context<a hidden class=anchor aria-hidden=true href=#view的context>#</a></h2><p>View属于一个Window，具体来说的是PhoneWindow，PhoneWindow在实例化时使用的当前Activity作为参数，在设置View时的代码如下：</p><p>PhoneWindow.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setContentView</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>layoutResID</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// decor, when theme attributes and the like are crystalized. Do not check the feature</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// before this happens.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mContentParent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>installDecor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasFeature</span><span class=p>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mContentParent</span><span class=p>.</span><span class=na>removeAllViews</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasFeature</span><span class=p>(</span><span class=n>FEATURE_CONTENT_TRANSITIONS</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Scene</span><span class=w> </span><span class=n>newScene</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Scene</span><span class=p>.</span><span class=na>getSceneForLayout</span><span class=p>(</span><span class=n>mContentParent</span><span class=p>,</span><span class=w> </span><span class=n>layoutResID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>getContext</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>transitionTo</span><span class=p>(</span><span class=n>newScene</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLayoutInflater</span><span class=p>.</span><span class=na>inflate</span><span class=p>(</span><span class=n>layoutResID</span><span class=p>,</span><span class=w> </span><span class=n>mContentParent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mContentParent</span><span class=p>.</span><span class=na>requestApplyInsets</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Callback</span><span class=w> </span><span class=n>cb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getCallback</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cb</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isDestroyed</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cb</span><span class=p>.</span><span class=na>onContentChanged</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mContentParentExplicitlySet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>PhoneWindow</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLayoutInflater</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LayoutInflater</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>LayoutInflater.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Obtains the LayoutInflater from the given context.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>LayoutInflater</span><span class=w> </span><span class=nf>from</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LayoutInflater</span><span class=w> </span><span class=n>LayoutInflater</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>LayoutInflater</span><span class=p>)</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>LAYOUT_INFLATER_SERVICE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LayoutInflater</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AssertionError</span><span class=p>(</span><span class=s>&#34;LayoutInflater not found.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>LayoutInflater</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>其中LayoutInflater直接从静态方法获取，那么获取到的LayoutInflater实例是没有与特定Context绑定的，但是这个Context是PhoneWindow所在Activity，那么为了让LayoutInflater绑定一个Context必须进行多态处理，那么可以发现Activity的一级父类<code>ContextThemeWrapper</code>重写了<code>getSystemService</code>方法，正是此处将Context绑定到LayoutInflater：</p><p>ContextThemeWrapper.java，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getSystemService</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LAYOUT_INFLATER_SERVICE</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>name</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mInflater</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInflater</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LayoutInflater</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>getBaseContext</span><span class=p>()).</span><span class=na>cloneInContext</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>mInflater</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getBaseContext</span><span class=p>().</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=viewgetcontext是否可以直接转型为activity>View.getContext()是否可以直接转型为Activity<a hidden class=anchor aria-hidden=true href=#viewgetcontext是否可以直接转型为activity>#</a></h2><p>为了使用支持库的ActionBar特征有时会使用<code>AppCompatActivity</code>作为Activity的父类，此时，根据上面的分析，使用<code>LayoutInflater.from(getBaseContext())</code>方法拿到的<code>LayoutInflater</code>实际上是Activity的一个实例变量。在<code>AppCompatActivity</code>的onCreate方法中，通过调用<code>delegate.installViewFactory()</code>为该<code>LayoutInflater</code>实例设置<code>Factory2</code>变量，然后在设置界面时<code>setContentView(int res)</code>会调用到代理<code>AppCompatDelegate</code>中的<code>setContentView(int res)</code>，而该代理的实例继承了<code>AppCompatDelegateImplV9</code>，而<code>AppCompatDelegateImplV9</code>实现了<code>LayoutInflater.Factory2</code>接口，并将其设置为上面的<code>LayoutInflater</code>实例中，最终在从布局文件创建视图时，<code>AppCompatDelegateImplV9</code>对<code>LayoutInflater.Factory2</code>中方法的实现中，会使用<code>AppCompatViewInflater</code>来对单个的View进行处理，将其替换为支持库中的类：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=nf>createView</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>parent</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>AttributeSet</span><span class=w> </span><span class=n>attrs</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>inheritContext</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>readAndroidTheme</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>readAppTheme</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>wrapContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>originalContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// We can emulate Lollipop&#39;s android:theme attribute propagating down the view hierarchy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// by using the parent&#39;s context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>inheritContext</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>parent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parent</span><span class=p>.</span><span class=na>getContext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>readAndroidTheme</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>readAppTheme</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// We then apply the theme on the context, if specified</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>themifyContext</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>,</span><span class=w> </span><span class=n>readAndroidTheme</span><span class=p>,</span><span class=w> </span><span class=n>readAppTheme</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>wrapContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TintContextWrapper</span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// We need to &#39;inject&#39; our tint aware Views in place of the standard framework versions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;TextView&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createTextView</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;ImageView&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createImageView</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;Button&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createButton</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;EditText&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createEditText</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;Spinner&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createSpinner</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;ImageButton&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createImageButton</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;CheckBox&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createCheckBox</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;RadioButton&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createRadioButton</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;CheckedTextView&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createCheckedTextView</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;AutoCompleteTextView&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createAutoCompleteTextView</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;MultiAutoCompleteTextView&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createMultiAutoCompleteTextView</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;RatingBar&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createRatingBar</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=s>&#34;SeekBar&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createSeekBar</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>verifyNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// The fallback that allows extending class to take over view inflation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// for other tags. Note that we don&#39;t check that the result is not-null.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// That allows the custom inflater path to fall back on the default one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// later in this method.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createView</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>view</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>originalContext</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the original context does not equal our themed context, then we need to manually</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// inflate it using the name so that android:theme takes effect.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createViewFromTag</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>view</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If we have created a view, check its android:onClick</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkOnClickListener</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>attrs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>view</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可以看到，此时拿到的View所持有的<code>Context</code>已经不是原来的<code>Activity</code>了，很可能会是一个将原来<code>Activity</code>实例包裹起来的<code>ContextWrapper</code>实例。因此如果从View中拿到Context后，并不能直接转型为Activity，而是应当将其一层一层剥开，才能拿到最原始的Activity实例。</p></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://epicmars.github.io/>AndroidPi</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 8" fill="currentcolor"><path d="M12 8H0l6-8z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>