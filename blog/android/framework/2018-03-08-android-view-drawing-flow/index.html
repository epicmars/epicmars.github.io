<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android View绘制流程 | AndroidPi</title>
<meta name=keywords content><meta name=description content="概述 当一个Activity接收到焦点，它会请求对其布局进行绘制。Android框架会处理绘制的流程，但Activity必须提供布局层次的一个根节点。
绘制从布局的根节点开始，它需要对布局树进行测量并进行绘制。绘制通过遍历布局树对每个与失效区域（invalid region）相交的View进行绘制。依次地，每个ViewGroup请求它的每个子View进行绘制（使用draw()方法）并且每个View负责绘制它自身。因为布局树采用前序遍历，这意味着父View会在子View之前（也就是图层的下方）绘制，同时该父View的兄弟View会以它们在树中出现的顺序进行绘制。
框架不会绘制失效区域外的View对象，并且会处理好View背景的绘制，你可以通过调用invalidate()方法来强制一个View进行绘制。
布局的绘制需要经过两个过程的处理：
测量
测量过程在measure(int, int)方法中实现，它是对View树的自上而下的遍历。在递归过程中，每个View将尺寸规范沿树从上往下推，在测量过程的结尾，每个View都存储其测量结果。
布局
布局过程在layout(int, int, int, int)中实现，它也是自上而下的。在这个过程中，每个父View负责对其所有子View的位置进行定位，它需要使用测量过程中计算出的视图尺寸。
当一个View对象的measure()方法返回时，其getMeasuredWidth()和getMeasuredHeight()值必须被设定，对于该View的所有子孙View对象也是一样。一个View对象的测量的宽度和高度必须遵循父View施加的约束。这可以保证在测量过程的结尾，所有父视图都接收子视图的测量。一个父视图可能会在其子视图上多次调用measure()方法。例如，父视图可能使用未指定的尺寸规格对所有子视图进行测量，来找到子视图想要有多大，如果所有子视图不受约束的尺寸之和太大或者太小，这时候父视图会使用实际的尺寸规格再次调用measure()（也就是说，如果子视图不同意它们自己获取的空间，那么父视图会在第二次测量过程中介入并设定测量规则）。
为了初始化一个布局，可以调用requestLayout()。通常当一个View相信它当前的边界已经不适合它了，那么它会在自身上调用该方法。
测量过程采用两个类对尺寸进行沟通：
ViewGroup.LayoutParams
用于View对象来告知它们的父级它们想要如何被测量和定位。基础ViewGroup.LayoutParams仅描述了View在宽度和高度上想要有多大。对于每个尺寸，它可以指定如下值：
一个确切的数字 MATCH_PARENT，表示View想和父级一样大（不包括父级的padding） WRAP_CONTENT，表示View想要刚好足够包围其内容的大小（包括padding） MeasureSpec
用于从上往下将测量需求从父级推给子级。MeasureSpec可以有如下三种模式：
UNSPECIFIED：一个父视图可以用他来确定一个子View所期望的尺寸。例如，一个LinearLayout可以在其子视图上调用measure()，其中将高度设置为UNSPECIFIED并且宽度设置为EXACTLY 240来找出给定一个240像素的宽度时，子视图期望有多高。 EXACTLY：用于父视图给子视图施加一个确定的尺寸。子视图必须使用该尺寸，并且保证它所有的后代视图都是符合该尺寸限制的。 AT MOST：用于父视图给子视图施加一个最大的尺寸。子视图必须保证它以及其所有的后代都符合该尺寸的限制。 源码分析 整体流程 绘制从布局的根节点开始，它需要测量和和绘制布局树。 从ViewRootImpl的首次布局请求开始：
ViewRootImpl.java
final class TraversalRunnable implements Runnable { @Override public void run() { doTraversal(); } } @Override public void requestLayout() { if (!mHandlingLayoutInLayoutRequest) { checkThread(); mLayoutRequested = true; scheduleTraversals(); } } void scheduleTraversals() { if (!mTraversalScheduled) { mTraversalScheduled = true; mTraversalBarrier = mHandler."><meta name=author content="LEOY"><link rel=canonical href=https://epicmars.github.io/blog/android/framework/2018-03-08-android-view-drawing-flow/><link crossorigin=anonymous href=/assets/css/stylesheet.3045213cee0439fa94bd732879be5b19072f75f4d28f6e62dd58c34f5243e49f.css integrity="sha256-MEUhPO4EOfqUvXMoeb5bGQcvdfTSj25i3VjDT1JD5J8=" rel="preload stylesheet" as=style><link rel=icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=icon type=image/png sizes=16x16 href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=icon type=image/png sizes=32x32 href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg%22><link rel=apple-touch-icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><link rel=mask-icon href=https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://epicmars.github.io/blog/android/framework/2018-03-08-android-view-drawing-flow/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script defer crossorigin=anonymous src=/js/custom.f20a5212619392e989b6d24ad9ce42302014debfad4d3c8c01db030c36d03475.js integrity="sha256-8gpSEmGTkumJttJK2c5CMCAU3r+tTTyMAdsDDDbQNHU="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css integrity=sha384-Juol1FqnotbkyZUT5Z7gUPjQ9gzlwCENvUZTpQBAPxtusdwFLRy382PSDx5UUJ4/ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.js integrity=sha384-97gW6UIJxnlKemYavrqDHSX3SiygeOwIZhwyOKRfSaf0JWKRVj9hLASHgFTzT+0O crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-NMEMBZ8R90"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NMEMBZ8R90")}</script><meta property="og:title" content="Android View绘制流程"><meta property="og:description" content="概述 当一个Activity接收到焦点，它会请求对其布局进行绘制。Android框架会处理绘制的流程，但Activity必须提供布局层次的一个根节点。
绘制从布局的根节点开始，它需要对布局树进行测量并进行绘制。绘制通过遍历布局树对每个与失效区域（invalid region）相交的View进行绘制。依次地，每个ViewGroup请求它的每个子View进行绘制（使用draw()方法）并且每个View负责绘制它自身。因为布局树采用前序遍历，这意味着父View会在子View之前（也就是图层的下方）绘制，同时该父View的兄弟View会以它们在树中出现的顺序进行绘制。
框架不会绘制失效区域外的View对象，并且会处理好View背景的绘制，你可以通过调用invalidate()方法来强制一个View进行绘制。
布局的绘制需要经过两个过程的处理：
测量
测量过程在measure(int, int)方法中实现，它是对View树的自上而下的遍历。在递归过程中，每个View将尺寸规范沿树从上往下推，在测量过程的结尾，每个View都存储其测量结果。
布局
布局过程在layout(int, int, int, int)中实现，它也是自上而下的。在这个过程中，每个父View负责对其所有子View的位置进行定位，它需要使用测量过程中计算出的视图尺寸。
当一个View对象的measure()方法返回时，其getMeasuredWidth()和getMeasuredHeight()值必须被设定，对于该View的所有子孙View对象也是一样。一个View对象的测量的宽度和高度必须遵循父View施加的约束。这可以保证在测量过程的结尾，所有父视图都接收子视图的测量。一个父视图可能会在其子视图上多次调用measure()方法。例如，父视图可能使用未指定的尺寸规格对所有子视图进行测量，来找到子视图想要有多大，如果所有子视图不受约束的尺寸之和太大或者太小，这时候父视图会使用实际的尺寸规格再次调用measure()（也就是说，如果子视图不同意它们自己获取的空间，那么父视图会在第二次测量过程中介入并设定测量规则）。
为了初始化一个布局，可以调用requestLayout()。通常当一个View相信它当前的边界已经不适合它了，那么它会在自身上调用该方法。
测量过程采用两个类对尺寸进行沟通：
ViewGroup.LayoutParams
用于View对象来告知它们的父级它们想要如何被测量和定位。基础ViewGroup.LayoutParams仅描述了View在宽度和高度上想要有多大。对于每个尺寸，它可以指定如下值：
一个确切的数字 MATCH_PARENT，表示View想和父级一样大（不包括父级的padding） WRAP_CONTENT，表示View想要刚好足够包围其内容的大小（包括padding） MeasureSpec
用于从上往下将测量需求从父级推给子级。MeasureSpec可以有如下三种模式：
UNSPECIFIED：一个父视图可以用他来确定一个子View所期望的尺寸。例如，一个LinearLayout可以在其子视图上调用measure()，其中将高度设置为UNSPECIFIED并且宽度设置为EXACTLY 240来找出给定一个240像素的宽度时，子视图期望有多高。 EXACTLY：用于父视图给子视图施加一个确定的尺寸。子视图必须使用该尺寸，并且保证它所有的后代视图都是符合该尺寸限制的。 AT MOST：用于父视图给子视图施加一个最大的尺寸。子视图必须保证它以及其所有的后代都符合该尺寸的限制。 源码分析 整体流程 绘制从布局的根节点开始，它需要测量和和绘制布局树。 从ViewRootImpl的首次布局请求开始：
ViewRootImpl.java
final class TraversalRunnable implements Runnable { @Override public void run() { doTraversal(); } } @Override public void requestLayout() { if (!mHandlingLayoutInLayoutRequest) { checkThread(); mLayoutRequested = true; scheduleTraversals(); } } void scheduleTraversals() { if (!mTraversalScheduled) { mTraversalScheduled = true; mTraversalBarrier = mHandler."><meta property="og:type" content="article"><meta property="og:url" content="https://epicmars.github.io/blog/android/framework/2018-03-08-android-view-drawing-flow/"><meta property="og:image" content="https://epicmars.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="blog"><meta property="article:published_time" content="2018-03-11T15:00:39+08:00"><meta property="article:modified_time" content="2018-03-11T15:00:39+08:00"><meta property="og:site_name" content="androidpi"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://epicmars.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Android View绘制流程"><meta name=twitter:description content="概述 当一个Activity接收到焦点，它会请求对其布局进行绘制。Android框架会处理绘制的流程，但Activity必须提供布局层次的一个根节点。
绘制从布局的根节点开始，它需要对布局树进行测量并进行绘制。绘制通过遍历布局树对每个与失效区域（invalid region）相交的View进行绘制。依次地，每个ViewGroup请求它的每个子View进行绘制（使用draw()方法）并且每个View负责绘制它自身。因为布局树采用前序遍历，这意味着父View会在子View之前（也就是图层的下方）绘制，同时该父View的兄弟View会以它们在树中出现的顺序进行绘制。
框架不会绘制失效区域外的View对象，并且会处理好View背景的绘制，你可以通过调用invalidate()方法来强制一个View进行绘制。
布局的绘制需要经过两个过程的处理：
测量
测量过程在measure(int, int)方法中实现，它是对View树的自上而下的遍历。在递归过程中，每个View将尺寸规范沿树从上往下推，在测量过程的结尾，每个View都存储其测量结果。
布局
布局过程在layout(int, int, int, int)中实现，它也是自上而下的。在这个过程中，每个父View负责对其所有子View的位置进行定位，它需要使用测量过程中计算出的视图尺寸。
当一个View对象的measure()方法返回时，其getMeasuredWidth()和getMeasuredHeight()值必须被设定，对于该View的所有子孙View对象也是一样。一个View对象的测量的宽度和高度必须遵循父View施加的约束。这可以保证在测量过程的结尾，所有父视图都接收子视图的测量。一个父视图可能会在其子视图上多次调用measure()方法。例如，父视图可能使用未指定的尺寸规格对所有子视图进行测量，来找到子视图想要有多大，如果所有子视图不受约束的尺寸之和太大或者太小，这时候父视图会使用实际的尺寸规格再次调用measure()（也就是说，如果子视图不同意它们自己获取的空间，那么父视图会在第二次测量过程中介入并设定测量规则）。
为了初始化一个布局，可以调用requestLayout()。通常当一个View相信它当前的边界已经不适合它了，那么它会在自身上调用该方法。
测量过程采用两个类对尺寸进行沟通：
ViewGroup.LayoutParams
用于View对象来告知它们的父级它们想要如何被测量和定位。基础ViewGroup.LayoutParams仅描述了View在宽度和高度上想要有多大。对于每个尺寸，它可以指定如下值：
一个确切的数字 MATCH_PARENT，表示View想和父级一样大（不包括父级的padding） WRAP_CONTENT，表示View想要刚好足够包围其内容的大小（包括padding） MeasureSpec
用于从上往下将测量需求从父级推给子级。MeasureSpec可以有如下三种模式：
UNSPECIFIED：一个父视图可以用他来确定一个子View所期望的尺寸。例如，一个LinearLayout可以在其子视图上调用measure()，其中将高度设置为UNSPECIFIED并且宽度设置为EXACTLY 240来找出给定一个240像素的宽度时，子视图期望有多高。 EXACTLY：用于父视图给子视图施加一个确定的尺寸。子视图必须使用该尺寸，并且保证它所有的后代视图都是符合该尺寸限制的。 AT MOST：用于父视图给子视图施加一个最大的尺寸。子视图必须保证它以及其所有的后代都符合该尺寸的限制。 源码分析 整体流程 绘制从布局的根节点开始，它需要测量和和绘制布局树。 从ViewRootImpl的首次布局请求开始：
ViewRootImpl.java
final class TraversalRunnable implements Runnable { @Override public void run() { doTraversal(); } } @Override public void requestLayout() { if (!mHandlingLayoutInLayoutRequest) { checkThread(); mLayoutRequested = true; scheduleTraversals(); } } void scheduleTraversals() { if (!mTraversalScheduled) { mTraversalScheduled = true; mTraversalBarrier = mHandler."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://epicmars.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Android","item":"https://epicmars.github.io/blog/android/"},{"@type":"ListItem","position":3,"name":"Android View绘制流程","item":"https://epicmars.github.io/blog/android/framework/2018-03-08-android-view-drawing-flow/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android View绘制流程","name":"Android View绘制流程","description":"概述 当一个Activity接收到焦点，它会请求对其布局进行绘制。Android框架会处理绘制的流程，但Activity必须提供布局层次的一个根节点。\n绘制从布局的根节点开始，它需要对布局树进行测量并进行绘制。绘制通过遍历布局树对每个与失效区域（invalid region）相交的View进行绘制。依次地，每个ViewGroup请求它的每个子View进行绘制（使用draw()方法）并且每个View负责绘制它自身。因为布局树采用前序遍历，这意味着父View会在子View之前（也就是图层的下方）绘制，同时该父View的兄弟View会以它们在树中出现的顺序进行绘制。\n框架不会绘制失效区域外的View对象，并且会处理好View背景的绘制，你可以通过调用invalidate()方法来强制一个View进行绘制。\n布局的绘制需要经过两个过程的处理：\n测量\n测量过程在measure(int, int)方法中实现，它是对View树的自上而下的遍历。在递归过程中，每个View将尺寸规范沿树从上往下推，在测量过程的结尾，每个View都存储其测量结果。\n布局\n布局过程在layout(int, int, int, int)中实现，它也是自上而下的。在这个过程中，每个父View负责对其所有子View的位置进行定位，它需要使用测量过程中计算出的视图尺寸。\n当一个View对象的measure()方法返回时，其getMeasuredWidth()和getMeasuredHeight()值必须被设定，对于该View的所有子孙View对象也是一样。一个View对象的测量的宽度和高度必须遵循父View施加的约束。这可以保证在测量过程的结尾，所有父视图都接收子视图的测量。一个父视图可能会在其子视图上多次调用measure()方法。例如，父视图可能使用未指定的尺寸规格对所有子视图进行测量，来找到子视图想要有多大，如果所有子视图不受约束的尺寸之和太大或者太小，这时候父视图会使用实际的尺寸规格再次调用measure()（也就是说，如果子视图不同意它们自己获取的空间，那么父视图会在第二次测量过程中介入并设定测量规则）。\n为了初始化一个布局，可以调用requestLayout()。通常当一个View相信它当前的边界已经不适合它了，那么它会在自身上调用该方法。\n测量过程采用两个类对尺寸进行沟通：\nViewGroup.LayoutParams\n用于View对象来告知它们的父级它们想要如何被测量和定位。基础ViewGroup.LayoutParams仅描述了View在宽度和高度上想要有多大。对于每个尺寸，它可以指定如下值：\n一个确切的数字 MATCH_PARENT，表示View想和父级一样大（不包括父级的padding） WRAP_CONTENT，表示View想要刚好足够包围其内容的大小（包括padding） MeasureSpec\n用于从上往下将测量需求从父级推给子级。MeasureSpec可以有如下三种模式：\nUNSPECIFIED：一个父视图可以用他来确定一个子View所期望的尺寸。例如，一个LinearLayout可以在其子视图上调用measure()，其中将高度设置为UNSPECIFIED并且宽度设置为EXACTLY 240来找出给定一个240像素的宽度时，子视图期望有多高。 EXACTLY：用于父视图给子视图施加一个确定的尺寸。子视图必须使用该尺寸，并且保证它所有的后代视图都是符合该尺寸限制的。 AT MOST：用于父视图给子视图施加一个最大的尺寸。子视图必须保证它以及其所有的后代都符合该尺寸的限制。 源码分析 整体流程 绘制从布局的根节点开始，它需要测量和和绘制布局树。 从ViewRootImpl的首次布局请求开始：\nViewRootImpl.java\nfinal class TraversalRunnable implements Runnable { @Override public void run() { doTraversal(); } } @Override public void requestLayout() { if (!mHandlingLayoutInLayoutRequest) { checkThread(); mLayoutRequested = true; scheduleTraversals(); } } void scheduleTraversals() { if (!mTraversalScheduled) { mTraversalScheduled = true; mTraversalBarrier = mHandler.","keywords":[],"articleBody":"概述 当一个Activity接收到焦点，它会请求对其布局进行绘制。Android框架会处理绘制的流程，但Activity必须提供布局层次的一个根节点。\n绘制从布局的根节点开始，它需要对布局树进行测量并进行绘制。绘制通过遍历布局树对每个与失效区域（invalid region）相交的View进行绘制。依次地，每个ViewGroup请求它的每个子View进行绘制（使用draw()方法）并且每个View负责绘制它自身。因为布局树采用前序遍历，这意味着父View会在子View之前（也就是图层的下方）绘制，同时该父View的兄弟View会以它们在树中出现的顺序进行绘制。\n框架不会绘制失效区域外的View对象，并且会处理好View背景的绘制，你可以通过调用invalidate()方法来强制一个View进行绘制。\n布局的绘制需要经过两个过程的处理：\n测量\n测量过程在measure(int, int)方法中实现，它是对View树的自上而下的遍历。在递归过程中，每个View将尺寸规范沿树从上往下推，在测量过程的结尾，每个View都存储其测量结果。\n布局\n布局过程在layout(int, int, int, int)中实现，它也是自上而下的。在这个过程中，每个父View负责对其所有子View的位置进行定位，它需要使用测量过程中计算出的视图尺寸。\n当一个View对象的measure()方法返回时，其getMeasuredWidth()和getMeasuredHeight()值必须被设定，对于该View的所有子孙View对象也是一样。一个View对象的测量的宽度和高度必须遵循父View施加的约束。这可以保证在测量过程的结尾，所有父视图都接收子视图的测量。一个父视图可能会在其子视图上多次调用measure()方法。例如，父视图可能使用未指定的尺寸规格对所有子视图进行测量，来找到子视图想要有多大，如果所有子视图不受约束的尺寸之和太大或者太小，这时候父视图会使用实际的尺寸规格再次调用measure()（也就是说，如果子视图不同意它们自己获取的空间，那么父视图会在第二次测量过程中介入并设定测量规则）。\n为了初始化一个布局，可以调用requestLayout()。通常当一个View相信它当前的边界已经不适合它了，那么它会在自身上调用该方法。\n测量过程采用两个类对尺寸进行沟通：\nViewGroup.LayoutParams\n用于View对象来告知它们的父级它们想要如何被测量和定位。基础ViewGroup.LayoutParams仅描述了View在宽度和高度上想要有多大。对于每个尺寸，它可以指定如下值：\n一个确切的数字 MATCH_PARENT，表示View想和父级一样大（不包括父级的padding） WRAP_CONTENT，表示View想要刚好足够包围其内容的大小（包括padding） MeasureSpec\n用于从上往下将测量需求从父级推给子级。MeasureSpec可以有如下三种模式：\nUNSPECIFIED：一个父视图可以用他来确定一个子View所期望的尺寸。例如，一个LinearLayout可以在其子视图上调用measure()，其中将高度设置为UNSPECIFIED并且宽度设置为EXACTLY 240来找出给定一个240像素的宽度时，子视图期望有多高。 EXACTLY：用于父视图给子视图施加一个确定的尺寸。子视图必须使用该尺寸，并且保证它所有的后代视图都是符合该尺寸限制的。 AT MOST：用于父视图给子视图施加一个最大的尺寸。子视图必须保证它以及其所有的后代都符合该尺寸的限制。 源码分析 整体流程 绘制从布局的根节点开始，它需要测量和和绘制布局树。 从ViewRootImpl的首次布局请求开始：\nViewRootImpl.java\nfinal class TraversalRunnable implements Runnable { @Override public void run() { doTraversal(); } } @Override public void requestLayout() { if (!mHandlingLayoutInLayoutRequest) { checkThread(); mLayoutRequested = true; scheduleTraversals(); } } void scheduleTraversals() { if (!mTraversalScheduled) { mTraversalScheduled = true; mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier(); mChoreographer.postCallback( Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null); if (!mUnbufferedInputDispatch) { scheduleConsumeBatchedInput(); } notifyRendererOfFramePending(); pokeDrawLockIfNeeded(); } } void doTraversal() { if (mTraversalScheduled) { mTraversalScheduled = false; mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier); if (mProfile) { Debug.startMethodTracing(\"ViewAncestor\"); } performTraversals(); if (mProfile) { Debug.stopMethodTracing(); mProfile = false; } } } private void performTraversals() { // cache mView since it is used so much below... final View host = mView; if (DBG) { System.out.println(\"======================================\"); System.out.println(\"performTraversals\"); host.debug(); } if (host == null || !mAdded) return; mIsInTraversal = true; mWillDrawSoon = true; boolean windowSizeMayChange = false; boolean newSurface = false; boolean surfaceChanged = false; WindowManager.LayoutParams lp = mWindowAttributes; int desiredWindowWidth; int desiredWindowHeight; final int viewVisibility = getHostVisibility(); final boolean viewVisibilityChanged = !mFirst \u0026\u0026 (mViewVisibility != viewVisibility || mNewSurfaceNeeded); final boolean viewUserVisibilityChanged = !mFirst \u0026\u0026 ((mViewVisibility == View.VISIBLE) != (viewVisibility == View.VISIBLE)); WindowManager.LayoutParams params = null; if (mWindowAttributesChanged) { mWindowAttributesChanged = false; surfaceChanged = true; params = lp; } CompatibilityInfo compatibilityInfo = mDisplay.getDisplayAdjustments().getCompatibilityInfo(); if (compatibilityInfo.supportsScreen() == mLastInCompatMode) { params = lp; mFullRedrawNeeded = true; mLayoutRequested = true; if (mLastInCompatMode) { params.privateFlags \u0026= ~WindowManager.LayoutParams.PRIVATE_FLAG_COMPATIBLE_WINDOW; mLastInCompatMode = false; } else { params.privateFlags |= WindowManager.LayoutParams.PRIVATE_FLAG_COMPATIBLE_WINDOW; mLastInCompatMode = true; } } mWindowAttributesChangesFlag = 0; Rect frame = mWinFrame; if (mFirst) { mFullRedrawNeeded = true; mLayoutRequested = true; final Configuration config = mContext.getResources().getConfiguration(); if (shouldUseDisplaySize(lp)) { // NOTE -- system code, won't try to do compat mode. Point size = new Point(); mDisplay.getRealSize(size); desiredWindowWidth = size.x; desiredWindowHeight = size.y; } else { desiredWindowWidth = dipToPx(config.screenWidthDp); desiredWindowHeight = dipToPx(config.screenHeightDp); } // We used to use the following condition to choose 32 bits drawing caches: // PixelFormat.hasAlpha(lp.format) || lp.format == PixelFormat.RGBX_8888 // However, windows are now always 32 bits by default, so choose 32 bits mAttachInfo.mUse32BitDrawingCache = true; mAttachInfo.mHasWindowFocus = false; mAttachInfo.mWindowVisibility = viewVisibility; mAttachInfo.mRecomputeGlobalAttributes = false; mLastConfigurationFromResources.setTo(config); mLastSystemUiVisibility = mAttachInfo.mSystemUiVisibility; // Set the layout direction if it has not been set before (inherit is the default) if (mViewLayoutDirectionInitial == View.LAYOUT_DIRECTION_INHERIT) { host.setLayoutDirection(config.getLayoutDirection()); } host.dispatchAttachedToWindow(mAttachInfo, 0); mAttachInfo.mTreeObserver.dispatchOnWindowAttachedChange(true); dispatchApplyInsets(host); //Log.i(mTag, \"Screen on initialized: \" + attachInfo.mKeepScreenOn); } else { desiredWindowWidth = frame.width(); desiredWindowHeight = frame.height(); if (desiredWindowWidth != mWidth || desiredWindowHeight != mHeight) { if (DEBUG_ORIENTATION) Log.v(mTag, \"View \" + host + \" resized to: \" + frame); mFullRedrawNeeded = true; mLayoutRequested = true; windowSizeMayChange = true; } } if (viewVisibilityChanged) { mAttachInfo.mWindowVisibility = viewVisibility; host.dispatchWindowVisibilityChanged(viewVisibility); if (viewUserVisibilityChanged) { host.dispatchVisibilityAggregated(viewVisibility == View.VISIBLE); } if (viewVisibility != View.VISIBLE || mNewSurfaceNeeded) { endDragResizing(); destroyHardwareResources(); } if (viewVisibility == View.GONE) { // After making a window gone, we will count it as being // shown for the first time the next time it gets focus. mHasHadWindowFocus = false; } } // Non-visible windows can't hold accessibility focus. if (mAttachInfo.mWindowVisibility != View.VISIBLE) { host.clearAccessibilityFocus(); } // Execute enqueued actions on every traversal in case a detached view enqueued an action getRunQueue().executeActions(mAttachInfo.mHandler); boolean insetsChanged = false; boolean layoutRequested = mLayoutRequested \u0026\u0026 (!mStopped || mReportNextDraw); if (layoutRequested) { final Resources res = mView.getContext().getResources(); if (mFirst) { // make sure touch mode code executes by setting cached value // to opposite of the added touch mode. mAttachInfo.mInTouchMode = !mAddedTouchMode; ensureTouchModeLocally(mAddedTouchMode); } else { if (!mPendingOverscanInsets.equals(mAttachInfo.mOverscanInsets)) { insetsChanged = true; } if (!mPendingContentInsets.equals(mAttachInfo.mContentInsets)) { insetsChanged = true; } if (!mPendingStableInsets.equals(mAttachInfo.mStableInsets)) { insetsChanged = true; } if (!mPendingVisibleInsets.equals(mAttachInfo.mVisibleInsets)) { mAttachInfo.mVisibleInsets.set(mPendingVisibleInsets); if (DEBUG_LAYOUT) Log.v(mTag, \"Visible insets changing to: \" + mAttachInfo.mVisibleInsets); } if (!mPendingOutsets.equals(mAttachInfo.mOutsets)) { insetsChanged = true; } if (mPendingAlwaysConsumeNavBar != mAttachInfo.mAlwaysConsumeNavBar) { insetsChanged = true; } if (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT || lp.height == ViewGroup.LayoutParams.WRAP_CONTENT) { windowSizeMayChange = true; if (shouldUseDisplaySize(lp)) { // NOTE -- system code, won't try to do compat mode. Point size = new Point(); mDisplay.getRealSize(size); desiredWindowWidth = size.x; desiredWindowHeight = size.y; } else { Configuration config = res.getConfiguration(); desiredWindowWidth = dipToPx(config.screenWidthDp); desiredWindowHeight = dipToPx(config.screenHeightDp); } } } // Ask host how big it wants to be windowSizeMayChange |= measureHierarchy(host, lp, res, desiredWindowWidth, desiredWindowHeight); } if (collectViewAttributes()) { params = lp; } if (mAttachInfo.mForceReportNewAttributes) { mAttachInfo.mForceReportNewAttributes = false; params = lp; } if (mFirst || mAttachInfo.mViewVisibilityChanged) { mAttachInfo.mViewVisibilityChanged = false; int resizeMode = mSoftInputMode \u0026 WindowManager.LayoutParams.SOFT_INPUT_MASK_ADJUST; // If we are in auto resize mode, then we need to determine // what mode to use now. if (resizeMode == WindowManager.LayoutParams.SOFT_INPUT_ADJUST_UNSPECIFIED) { final int N = mAttachInfo.mScrollContainers.size(); for (int i=0; i\u003cN; i++) { if (mAttachInfo.mScrollContainers.get(i).isShown()) { resizeMode = WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE; } } if (resizeMode == 0) { resizeMode = WindowManager.LayoutParams.SOFT_INPUT_ADJUST_PAN; } if ((lp.softInputMode \u0026 WindowManager.LayoutParams.SOFT_INPUT_MASK_ADJUST) != resizeMode) { lp.softInputMode = (lp.softInputMode \u0026 ~WindowManager.LayoutParams.SOFT_INPUT_MASK_ADJUST) | resizeMode; params = lp; } } } if (params != null) { if ((host.mPrivateFlags \u0026 View.PFLAG_REQUEST_TRANSPARENT_REGIONS) != 0) { if (!PixelFormat.formatHasAlpha(params.format)) { params.format = PixelFormat.TRANSLUCENT; } } mAttachInfo.mOverscanRequested = (params.flags \u0026 WindowManager.LayoutParams.FLAG_LAYOUT_IN_OVERSCAN) != 0; } if (mApplyInsetsRequested) { mApplyInsetsRequested = false; mLastOverscanRequested = mAttachInfo.mOverscanRequested; dispatchApplyInsets(host); if (mLayoutRequested) { // Short-circuit catching a new layout request here, so // we don't need to go through two layout passes when things // change due to fitting system windows, which can happen a lot. windowSizeMayChange |= measureHierarchy(host, lp, mView.getContext().getResources(), desiredWindowWidth, desiredWindowHeight); } } if (layoutRequested) { // Clear this now, so that if anything requests a layout in the // rest of this function we will catch it and re-run a full // layout pass. mLayoutRequested = false; } boolean windowShouldResize = layoutRequested \u0026\u0026 windowSizeMayChange \u0026\u0026 ((mWidth != host.getMeasuredWidth() || mHeight != host.getMeasuredHeight()) || (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT \u0026\u0026 frame.width() \u003c desiredWindowWidth \u0026\u0026 frame.width() != mWidth) || (lp.height == ViewGroup.LayoutParams.WRAP_CONTENT \u0026\u0026 frame.height() \u003c desiredWindowHeight \u0026\u0026 frame.height() != mHeight)); windowShouldResize |= mDragResizing \u0026\u0026 mResizeMode == RESIZE_MODE_FREEFORM; // If the activity was just relaunched, it might have unfrozen the task bounds (while // relaunching), so we need to force a call into window manager to pick up the latest // bounds. windowShouldResize |= mActivityRelaunched; // Determine whether to compute insets. // If there are no inset listeners remaining then we may still need to compute // insets in case the old insets were non-empty and must be reset. final boolean computesInternalInsets = mAttachInfo.mTreeObserver.hasComputeInternalInsetsListeners() || mAttachInfo.mHasNonEmptyGivenInternalInsets; boolean insetsPending = false; int relayoutResult = 0; boolean updatedConfiguration = false; final int surfaceGenerationId = mSurface.getGenerationId(); final boolean isViewVisible = viewVisibility == View.VISIBLE; final boolean windowRelayoutWasForced = mForceNextWindowRelayout; if (mFirst || windowShouldResize || insetsChanged || viewVisibilityChanged || params != null || mForceNextWindowRelayout) { mForceNextWindowRelayout = false; if (isViewVisible) { // If this window is giving internal insets to the window // manager, and it is being added or changing its visibility, // then we want to first give the window manager \"fake\" // insets to cause it to effectively ignore the content of // the window during layout. This avoids it briefly causing // other windows to resize/move based on the raw frame of the // window, waiting until we can finish laying out this window // and get back to the window manager with the ultimately // computed insets. insetsPending = computesInternalInsets \u0026\u0026 (mFirst || viewVisibilityChanged); } if (mSurfaceHolder != null) { mSurfaceHolder.mSurfaceLock.lock(); mDrawingAllowed = true; } boolean hwInitialized = false; boolean contentInsetsChanged = false; boolean hadSurface = mSurface.isValid(); try { if (DEBUG_LAYOUT) { Log.i(mTag, \"host=w:\" + host.getMeasuredWidth() + \", h:\" + host.getMeasuredHeight() + \", params=\" + params); } if (mAttachInfo.mThreadedRenderer != null) { // relayoutWindow may decide to destroy mSurface. As that decision // happens in WindowManager service, we need to be defensive here // and stop using the surface in case it gets destroyed. if (mAttachInfo.mThreadedRenderer.pauseSurface(mSurface)) { // Animations were running so we need to push a frame // to resume them mDirty.set(0, 0, mWidth, mHeight); } mChoreographer.mFrameInfo.addFlags(FrameInfo.FLAG_WINDOW_LAYOUT_CHANGED); } relayoutResult = relayoutWindow(params, viewVisibility, insetsPending); if (DEBUG_LAYOUT) Log.v(mTag, \"relayout: frame=\" + frame.toShortString() + \" overscan=\" + mPendingOverscanInsets.toShortString() + \" content=\" + mPendingContentInsets.toShortString() + \" visible=\" + mPendingVisibleInsets.toShortString() + \" visible=\" + mPendingStableInsets.toShortString() + \" outsets=\" + mPendingOutsets.toShortString() + \" surface=\" + mSurface); final Configuration pendingMergedConfig = mPendingMergedConfiguration.getMergedConfiguration(); if (pendingMergedConfig.seq != 0) { if (DEBUG_CONFIGURATION) Log.v(mTag, \"Visible with new config: \" + pendingMergedConfig); performConfigurationChange(mPendingMergedConfiguration, !mFirst, INVALID_DISPLAY /* same display */); pendingMergedConfig.seq = 0; updatedConfiguration = true; } final boolean overscanInsetsChanged = !mPendingOverscanInsets.equals( mAttachInfo.mOverscanInsets); contentInsetsChanged = !mPendingContentInsets.equals( mAttachInfo.mContentInsets); final boolean visibleInsetsChanged = !mPendingVisibleInsets.equals( mAttachInfo.mVisibleInsets); final boolean stableInsetsChanged = !mPendingStableInsets.equals( mAttachInfo.mStableInsets); final boolean outsetsChanged = !mPendingOutsets.equals(mAttachInfo.mOutsets); final boolean surfaceSizeChanged = (relayoutResult \u0026 WindowManagerGlobal.RELAYOUT_RES_SURFACE_RESIZED) != 0; final boolean alwaysConsumeNavBarChanged = mPendingAlwaysConsumeNavBar != mAttachInfo.mAlwaysConsumeNavBar; if (contentInsetsChanged) { mAttachInfo.mContentInsets.set(mPendingContentInsets); if (DEBUG_LAYOUT) Log.v(mTag, \"Content insets changing to: \" + mAttachInfo.mContentInsets); } if (overscanInsetsChanged) { mAttachInfo.mOverscanInsets.set(mPendingOverscanInsets); if (DEBUG_LAYOUT) Log.v(mTag, \"Overscan insets changing to: \" + mAttachInfo.mOverscanInsets); // Need to relayout with content insets. contentInsetsChanged = true; } if (stableInsetsChanged) { mAttachInfo.mStableInsets.set(mPendingStableInsets); if (DEBUG_LAYOUT) Log.v(mTag, \"Decor insets changing to: \" + mAttachInfo.mStableInsets); // Need to relayout with content insets. contentInsetsChanged = true; } if (alwaysConsumeNavBarChanged) { mAttachInfo.mAlwaysConsumeNavBar = mPendingAlwaysConsumeNavBar; contentInsetsChanged = true; } if (contentInsetsChanged || mLastSystemUiVisibility != mAttachInfo.mSystemUiVisibility || mApplyInsetsRequested || mLastOverscanRequested != mAttachInfo.mOverscanRequested || outsetsChanged) { mLastSystemUiVisibility = mAttachInfo.mSystemUiVisibility; mLastOverscanRequested = mAttachInfo.mOverscanRequested; mAttachInfo.mOutsets.set(mPendingOutsets); mApplyInsetsRequested = false; dispatchApplyInsets(host); } if (visibleInsetsChanged) { mAttachInfo.mVisibleInsets.set(mPendingVisibleInsets); if (DEBUG_LAYOUT) Log.v(mTag, \"Visible insets changing to: \" + mAttachInfo.mVisibleInsets); } if (!hadSurface) { if (mSurface.isValid()) { // If we are creating a new surface, then we need to // completely redraw it. Also, when we get to the // point of drawing it we will hold off and schedule // a new traversal instead. This is so we can tell the // window manager about all of the windows being displayed // before actually drawing them, so it can display then // all at once. newSurface = true; mFullRedrawNeeded = true; mPreviousTransparentRegion.setEmpty(); // Only initialize up-front if transparent regions are not // requested, otherwise defer to see if the entire window // will be transparent if (mAttachInfo.mThreadedRenderer != null) { try { hwInitialized = mAttachInfo.mThreadedRenderer.initialize( mSurface); if (hwInitialized \u0026\u0026 (host.mPrivateFlags \u0026 View.PFLAG_REQUEST_TRANSPARENT_REGIONS) == 0) { // Don't pre-allocate if transparent regions // are requested as they may not be needed mSurface.allocateBuffers(); } } catch (OutOfResourcesException e) { handleOutOfResourcesException(e); return; } } } } else if (!mSurface.isValid()) { // If the surface has been removed, then reset the scroll // positions. if (mLastScrolledFocus != null) { mLastScrolledFocus.clear(); } mScrollY = mCurScrollY = 0; if (mView instanceof RootViewSurfaceTaker) { ((RootViewSurfaceTaker) mView).onRootViewScrollYChanged(mCurScrollY); } if (mScroller != null) { mScroller.abortAnimation(); } // Our surface is gone if (mAttachInfo.mThreadedRenderer != null \u0026\u0026 mAttachInfo.mThreadedRenderer.isEnabled()) { mAttachInfo.mThreadedRenderer.destroy(); } } else if ((surfaceGenerationId != mSurface.getGenerationId() || surfaceSizeChanged || windowRelayoutWasForced) \u0026\u0026 mSurfaceHolder == null \u0026\u0026 mAttachInfo.mThreadedRenderer != null) { mFullRedrawNeeded = true; try { // Need to do updateSurface (which leads to CanvasContext::setSurface and // re-create the EGLSurface) if either the Surface changed (as indicated by // generation id), or WindowManager changed the surface size. The latter is // because on some chips, changing the consumer side's BufferQueue size may // not take effect immediately unless we create a new EGLSurface. // Note that frame size change doesn't always imply surface size change (eg. // drag resizing uses fullscreen surface), need to check surfaceSizeChanged // flag from WindowManager. mAttachInfo.mThreadedRenderer.updateSurface(mSurface); } catch (OutOfResourcesException e) { handleOutOfResourcesException(e); return; } } final boolean freeformResizing = (relayoutResult \u0026 WindowManagerGlobal.RELAYOUT_RES_DRAG_RESIZING_FREEFORM) != 0; final boolean dockedResizing = (relayoutResult \u0026 WindowManagerGlobal.RELAYOUT_RES_DRAG_RESIZING_DOCKED) != 0; final boolean dragResizing = freeformResizing || dockedResizing; if (mDragResizing != dragResizing) { if (dragResizing) { mResizeMode = freeformResizing ? RESIZE_MODE_FREEFORM : RESIZE_MODE_DOCKED_DIVIDER; startDragResizing(mPendingBackDropFrame, mWinFrame.equals(mPendingBackDropFrame), mPendingVisibleInsets, mPendingStableInsets, mResizeMode); } else { // We shouldn't come here, but if we come we should end the resize. endDragResizing(); } } if (!USE_MT_RENDERER) { if (dragResizing) { mCanvasOffsetX = mWinFrame.left; mCanvasOffsetY = mWinFrame.top; } else { mCanvasOffsetX = mCanvasOffsetY = 0; } } } catch (RemoteException e) { } if (DEBUG_ORIENTATION) Log.v( TAG, \"Relayout returned: frame=\" + frame + \", surface=\" + mSurface); mAttachInfo.mWindowLeft = frame.left; mAttachInfo.mWindowTop = frame.top; // !!FIXME!! This next section handles the case where we did not get the // window size we asked for. We should avoid this by getting a maximum size from // the window session beforehand. if (mWidth != frame.width() || mHeight != frame.height()) { mWidth = frame.width(); mHeight = frame.height(); } if (mSurfaceHolder != null) { // The app owns the surface; tell it about what is going on. if (mSurface.isValid()) { // XXX .copyFrom() doesn't work! //mSurfaceHolder.mSurface.copyFrom(mSurface); mSurfaceHolder.mSurface = mSurface; } mSurfaceHolder.setSurfaceFrameSize(mWidth, mHeight); mSurfaceHolder.mSurfaceLock.unlock(); if (mSurface.isValid()) { if (!hadSurface) { mSurfaceHolder.ungetCallbacks(); mIsCreating = true; SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks(); if (callbacks != null) { for (SurfaceHolder.Callback c : callbacks) { c.surfaceCreated(mSurfaceHolder); } } surfaceChanged = true; } if (surfaceChanged || surfaceGenerationId != mSurface.getGenerationId()) { SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks(); if (callbacks != null) { for (SurfaceHolder.Callback c : callbacks) { c.surfaceChanged(mSurfaceHolder, lp.format, mWidth, mHeight); } } } mIsCreating = false; } else if (hadSurface) { mSurfaceHolder.ungetCallbacks(); SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks(); if (callbacks != null) { for (SurfaceHolder.Callback c : callbacks) { c.surfaceDestroyed(mSurfaceHolder); } } mSurfaceHolder.mSurfaceLock.lock(); try { mSurfaceHolder.mSurface = new Surface(); } finally { mSurfaceHolder.mSurfaceLock.unlock(); } } } final ThreadedRenderer threadedRenderer = mAttachInfo.mThreadedRenderer; if (threadedRenderer != null \u0026\u0026 threadedRenderer.isEnabled()) { if (hwInitialized || mWidth != threadedRenderer.getWidth() || mHeight != threadedRenderer.getHeight() || mNeedsRendererSetup) { threadedRenderer.setup(mWidth, mHeight, mAttachInfo, mWindowAttributes.surfaceInsets); mNeedsRendererSetup = false; } } if (!mStopped || mReportNextDraw) { boolean focusChangedDueToTouchMode = ensureTouchModeLocally( (relayoutResult\u0026WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != 0); if (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth() || mHeight != host.getMeasuredHeight() || contentInsetsChanged || updatedConfiguration) { int childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width); int childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height); if (DEBUG_LAYOUT) Log.v(mTag, \"Ooops, something changed! mWidth=\" + mWidth + \" measuredWidth=\" + host.getMeasuredWidth() + \" mHeight=\" + mHeight + \" measuredHeight=\" + host.getMeasuredHeight() + \" coveredInsetsChanged=\" + contentInsetsChanged); // Ask host how big it wants to be performMeasure(childWidthMeasureSpec, childHeightMeasureSpec); // Implementation of weights from WindowManager.LayoutParams // We just grow the dimensions as needed and re-measure if // needs be int width = host.getMeasuredWidth(); int height = host.getMeasuredHeight(); boolean measureAgain = false; if (lp.horizontalWeight \u003e 0.0f) { width += (int) ((mWidth - width) * lp.horizontalWeight); childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(width, MeasureSpec.EXACTLY); measureAgain = true; } if (lp.verticalWeight \u003e 0.0f) { height += (int) ((mHeight - height) * lp.verticalWeight); childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(height, MeasureSpec.EXACTLY); measureAgain = true; } if (measureAgain) { if (DEBUG_LAYOUT) Log.v(mTag, \"And hey let's measure once more: width=\" + width + \" height=\" + height); performMeasure(childWidthMeasureSpec, childHeightMeasureSpec); } layoutRequested = true; } } } else { // Not the first pass and no window/insets/visibility change but the window // may have moved and we need check that and if so to update the left and right // in the attach info. We translate only the window frame since on window move // the window manager tells us only for the new frame but the insets are the // same and we do not want to translate them more than once. maybeHandleWindowMove(frame); } final boolean didLayout = layoutRequested \u0026\u0026 (!mStopped || mReportNextDraw); boolean triggerGlobalLayoutListener = didLayout || mAttachInfo.mRecomputeGlobalAttributes; if (didLayout) { performLayout(lp, mWidth, mHeight); // By this point all views have been sized and positioned // We can compute the transparent area if ((host.mPrivateFlags \u0026 View.PFLAG_REQUEST_TRANSPARENT_REGIONS) != 0) { // start out transparent // TODO: AVOID THAT CALL BY CACHING THE RESULT? host.getLocationInWindow(mTmpLocation); mTransparentRegion.set(mTmpLocation[0], mTmpLocation[1], mTmpLocation[0] + host.mRight - host.mLeft, mTmpLocation[1] + host.mBottom - host.mTop); host.gatherTransparentRegion(mTransparentRegion); if (mTranslator != null) { mTranslator.translateRegionInWindowToScreen(mTransparentRegion); } if (!mTransparentRegion.equals(mPreviousTransparentRegion)) { mPreviousTransparentRegion.set(mTransparentRegion); mFullRedrawNeeded = true; // reconfigure window manager try { mWindowSession.setTransparentRegion(mWindow, mTransparentRegion); } catch (RemoteException e) { } } } if (DBG) { System.out.println(\"======================================\"); System.out.println(\"performTraversals -- after setFrame\"); host.debug(); } } if (triggerGlobalLayoutListener) { mAttachInfo.mRecomputeGlobalAttributes = false; mAttachInfo.mTreeObserver.dispatchOnGlobalLayout(); } if (computesInternalInsets) { // Clear the original insets. final ViewTreeObserver.InternalInsetsInfo insets = mAttachInfo.mGivenInternalInsets; insets.reset(); // Compute new insets in place. mAttachInfo.mTreeObserver.dispatchOnComputeInternalInsets(insets); mAttachInfo.mHasNonEmptyGivenInternalInsets = !insets.isEmpty(); // Tell the window manager. if (insetsPending || !mLastGivenInsets.equals(insets)) { mLastGivenInsets.set(insets); // Translate insets to screen coordinates if needed. final Rect contentInsets; final Rect visibleInsets; final Region touchableRegion; if (mTranslator != null) { contentInsets = mTranslator.getTranslatedContentInsets(insets.contentInsets); visibleInsets = mTranslator.getTranslatedVisibleInsets(insets.visibleInsets); touchableRegion = mTranslator.getTranslatedTouchableArea(insets.touchableRegion); } else { contentInsets = insets.contentInsets; visibleInsets = insets.visibleInsets; touchableRegion = insets.touchableRegion; } try { mWindowSession.setInsets(mWindow, insets.mTouchableInsets, contentInsets, visibleInsets, touchableRegion); } catch (RemoteException e) { } } } if (mFirst \u0026\u0026 sAlwaysAssignFocus) { // handle first focus request if (DEBUG_INPUT_RESIZE) Log.v(mTag, \"First: mView.hasFocus()=\" + mView.hasFocus()); if (mView != null) { if (!mView.hasFocus()) { mView.restoreDefaultFocus(); if (DEBUG_INPUT_RESIZE) Log.v(mTag, \"First: requested focused view=\" + mView.findFocus()); } else { if (DEBUG_INPUT_RESIZE) Log.v(mTag, \"First: existing focused view=\" + mView.findFocus()); } } } final boolean changedVisibility = (viewVisibilityChanged || mFirst) \u0026\u0026 isViewVisible; final boolean hasWindowFocus = mAttachInfo.mHasWindowFocus \u0026\u0026 isViewVisible; final boolean regainedFocus = hasWindowFocus \u0026\u0026 mLostWindowFocus; if (regainedFocus) { mLostWindowFocus = false; } else if (!hasWindowFocus \u0026\u0026 mHadWindowFocus) { mLostWindowFocus = true; } if (changedVisibility || regainedFocus) { // Toasts are presented as notifications - don't present them as windows as well boolean isToast = (mWindowAttributes == null) ? false : (mWindowAttributes.type == WindowManager.LayoutParams.TYPE_TOAST); if (!isToast) { host.sendAccessibilityEvent(AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED); } } mFirst = false; mWillDrawSoon = false; mNewSurfaceNeeded = false; mActivityRelaunched = false; mViewVisibility = viewVisibility; mHadWindowFocus = hasWindowFocus; if (hasWindowFocus \u0026\u0026 !isInLocalFocusMode()) { final boolean imTarget = WindowManager.LayoutParams .mayUseInputMethod(mWindowAttributes.flags); if (imTarget != mLastWasImTarget) { mLastWasImTarget = imTarget; InputMethodManager imm = InputMethodManager.peekInstance(); if (imm != null \u0026\u0026 imTarget) { imm.onPreWindowFocus(mView, hasWindowFocus); imm.onPostWindowFocus(mView, mView.findFocus(), mWindowAttributes.softInputMode, !mHasHadWindowFocus, mWindowAttributes.flags); } } } // Remember if we must report the next draw. if ((relayoutResult \u0026 WindowManagerGlobal.RELAYOUT_RES_FIRST_TIME) != 0) { reportNextDraw(); } boolean cancelDraw = mAttachInfo.mTreeObserver.dispatchOnPreDraw() || !isViewVisible; if (!cancelDraw \u0026\u0026 !newSurface) { if (mPendingTransitions != null \u0026\u0026 mPendingTransitions.size() \u003e 0) { for (int i = 0; i \u003c mPendingTransitions.size(); ++i) { mPendingTransitions.get(i).startChangingAnimations(); } mPendingTransitions.clear(); } performDraw(); } else { if (isViewVisible) { // Try again scheduleTraversals(); } else if (mPendingTransitions != null \u0026\u0026 mPendingTransitions.size() \u003e 0) { for (int i = 0; i \u003c mPendingTransitions.size(); ++i) { mPendingTransitions.get(i).endChangingAnimations(); } mPendingTransitions.clear(); } } mIsInTraversal = false; } /** * Figures out the measure spec for the root view in a window based on it's * layout params. * * @param windowSize * The available width or height of the window * * @param rootDimension * The layout params for one dimension (width or height) of the * window. * * @return The measure spec to use to measure the root view. */ private static int getRootMeasureSpec(int windowSize, int rootDimension) { int measureSpec; switch (rootDimension) { case ViewGroup.LayoutParams.MATCH_PARENT: // Window can't resize. Force root view to be windowSize. measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY); break; case ViewGroup.LayoutParams.WRAP_CONTENT: // Window can resize. Set max size for root view. measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST); break; default: // Window wants to be an exact size. Force root view to be that size. measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY); break; } return measureSpec; } private void performMeasure(int childWidthMeasureSpec, int childHeightMeasureSpec) { if (mView == null) { return; } Trace.traceBegin(Trace.TRACE_TAG_VIEW, \"measure\"); try { mView.measure(childWidthMeasureSpec, childHeightMeasureSpec); } finally { Trace.traceEnd(Trace.TRACE_TAG_VIEW); } } private void performLayout(WindowManager.LayoutParams lp, int desiredWindowWidth, int desiredWindowHeight) { mLayoutRequested = false; mScrollMayChange = true; mInLayout = true; final View host = mView; if (host == null) { return; } if (DEBUG_ORIENTATION || DEBUG_LAYOUT) { Log.v(mTag, \"Laying out \" + host + \" to (\" + host.getMeasuredWidth() + \", \" + host.getMeasuredHeight() + \")\"); } Trace.traceBegin(Trace.TRACE_TAG_VIEW, \"layout\"); try { host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight()); mInLayout = false; int numViewsRequestingLayout = mLayoutRequesters.size(); if (numViewsRequestingLayout \u003e 0) { // requestLayout() was called during layout. // If no layout-request flags are set on the requesting views, there is no problem. // If some requests are still pending, then we need to clear those flags and do // a full request/measure/layout pass to handle this situation. ArrayList\u003cView\u003e validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, false); if (validLayoutRequesters != null) { // Set this flag to indicate that any further requests are happening during // the second pass, which may result in posting those requests to the next // frame instead mHandlingLayoutInLayoutRequest = true; // Process fresh layout requests, then measure and layout int numValidRequests = validLayoutRequesters.size(); for (int i = 0; i \u003c numValidRequests; ++i) { final View view = validLayoutRequesters.get(i); Log.w(\"View\", \"requestLayout() improperly called by \" + view + \" during layout: running second layout pass\"); view.requestLayout(); } measureHierarchy(host, lp, mView.getContext().getResources(), desiredWindowWidth, desiredWindowHeight); mInLayout = true; host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight()); mHandlingLayoutInLayoutRequest = false; // Check the valid requests again, this time without checking/clearing the // layout flags, since requests happening during the second pass get noop'd validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, true); if (validLayoutRequesters != null) { final ArrayList\u003cView\u003e finalRequesters = validLayoutRequesters; // Post second-pass requests to the next frame getRunQueue().post(new Runnable() { @Override public void run() { int numValidRequests = finalRequesters.size(); for (int i = 0; i \u003c numValidRequests; ++i) { final View view = finalRequesters.get(i); Log.w(\"View\", \"requestLayout() improperly called by \" + view + \" during second layout pass: posting in next frame\"); view.requestLayout(); } } }); } } } } finally { Trace.traceEnd(Trace.TRACE_TAG_VIEW); } mInLayout = false; } private void performDraw() { if (mAttachInfo.mDisplayState == Display.STATE_OFF \u0026\u0026 !mReportNextDraw) { return; } else if (mView == null) { return; } final boolean fullRedrawNeeded = mFullRedrawNeeded; mFullRedrawNeeded = false; mIsDrawing = true; Trace.traceBegin(Trace.TRACE_TAG_VIEW, \"draw\"); try { draw(fullRedrawNeeded); } finally { mIsDrawing = false; Trace.traceEnd(Trace.TRACE_TAG_VIEW); } // For whatever reason we didn't create a HardwareRenderer, end any // hardware animations that are now dangling if (mAttachInfo.mPendingAnimatingRenderNodes != null) { final int count = mAttachInfo.mPendingAnimatingRenderNodes.size(); for (int i = 0; i \u003c count; i++) { mAttachInfo.mPendingAnimatingRenderNodes.get(i).endAllAnimators(); } mAttachInfo.mPendingAnimatingRenderNodes.clear(); } if (mReportNextDraw) { mReportNextDraw = false; // if we're using multi-thread renderer, wait for the window frame draws if (mWindowDrawCountDown != null) { try { mWindowDrawCountDown.await(); } catch (InterruptedException e) { Log.e(mTag, \"Window redraw count down interruped!\"); } mWindowDrawCountDown = null; } if (mAttachInfo.mThreadedRenderer != null) { mAttachInfo.mThreadedRenderer.fence(); mAttachInfo.mThreadedRenderer.setStopped(mStopped); } if (LOCAL_LOGV) { Log.v(mTag, \"FINISHED DRAWING: \" + mWindowAttributes.getTitle()); } if (mSurfaceHolder != null \u0026\u0026 mSurface.isValid()) { SurfaceCallbackHelper sch = new SurfaceCallbackHelper(this::postDrawFinished); SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks(); sch.dispatchSurfaceRedrawNeededAsync(mSurfaceHolder, callbacks); } else { pendingDrawFinished(); } } } 测量 ViewRootImpl的mView是所在Window的顶级布局DecorView，它继承了FrameLayout布局，执行的measure()继承于View： View.java\n/** * * This is called to find out how big a view should be. The parent * supplies constraint information in the width and height parameters. * * * * The actual measurement work of a view is performed in * {@link #onMeasure(int, int)}, called by this method. Therefore, only * {@link #onMeasure(int, int)} can and must be overridden by subclasses. * * * * @param widthMeasureSpec Horizontal space requirements as imposed by the * parent * @param heightMeasureSpec Vertical space requirements as imposed by the * parent * * @see #onMeasure(int, int) */ public final void measure(int widthMeasureSpec, int heightMeasureSpec) { boolean optical = isLayoutModeOptical(this); if (optical != isLayoutModeOptical(mParent)) { Insets insets = getOpticalInsets(); int oWidth = insets.left + insets.right; int oHeight = insets.top + insets.bottom; widthMeasureSpec = MeasureSpec.adjust(widthMeasureSpec, optical ? -oWidth : oWidth); heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight); } // Suppress sign extension for the low bytes long key = (long) widthMeasureSpec \u003c\u003c 32 | (long) heightMeasureSpec \u0026 0xffffffffL; if (mMeasureCache == null) mMeasureCache = new LongSparseLongArray(2); final boolean forceLayout = (mPrivateFlags \u0026 PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT; // Optimize layout by avoiding an extra EXACTLY pass when the view is // already measured as the correct size. In API 23 and below, this // extra pass is required to make LinearLayout re-distribute weight. final boolean specChanged = widthMeasureSpec != mOldWidthMeasureSpec || heightMeasureSpec != mOldHeightMeasureSpec; final boolean isSpecExactly = MeasureSpec.getMode(widthMeasureSpec) == MeasureSpec.EXACTLY \u0026\u0026 MeasureSpec.getMode(heightMeasureSpec) == MeasureSpec.EXACTLY; final boolean matchesSpecSize = getMeasuredWidth() == MeasureSpec.getSize(widthMeasureSpec) \u0026\u0026 getMeasuredHeight() == MeasureSpec.getSize(heightMeasureSpec); final boolean needsLayout = specChanged \u0026\u0026 (sAlwaysRemeasureExactly || !isSpecExactly || !matchesSpecSize); if (forceLayout || needsLayout) { // first clears the measured dimension flag mPrivateFlags \u0026= ~PFLAG_MEASURED_DIMENSION_SET; resolveRtlPropertiesIfNeeded(); int cacheIndex = forceLayout ? -1 : mMeasureCache.indexOfKey(key); if (cacheIndex \u003c 0 || sIgnoreMeasureCache) { // measure ourselves, this should set the measured dimension flag back onMeasure(widthMeasureSpec, heightMeasureSpec); mPrivateFlags3 \u0026= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT; } else { long value = mMeasureCache.valueAt(cacheIndex); // Casting a long to int drops the high 32 bits, no mask needed setMeasuredDimensionRaw((int) (value \u003e\u003e 32), (int) value); mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT; } // flag not set, setMeasuredDimension() was not invoked, we raise // an exception to warn the developer if ((mPrivateFlags \u0026 PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) { throw new IllegalStateException(\"View with id \" + getId() + \": \" + getClass().getName() + \"#onMeasure() did not set the\" + \" measured dimension by calling\" + \" setMeasuredDimension()\"); } mPrivateFlags |= PFLAG_LAYOUT_REQUIRED; } mOldWidthMeasureSpec = widthMeasureSpec; mOldHeightMeasureSpec = heightMeasureSpec; mMeasureCache.put(key, ((long) mMeasuredWidth) \u003c\u003c 32 | (long) mMeasuredHeight \u0026 0xffffffffL); // suppress sign extension } /** * * Measure the view and its content to determine the measured width and the * measured height. This method is invoked by {@link #measure(int, int)} and * should be overridden by subclasses to provide accurate and efficient * measurement of their contents. * * * * CONTRACT: When overriding this method, you * must call {@link #setMeasuredDimension(int, int)} to store the * measured width and height of this view. Failure to do so will trigger an * IllegalStateException, thrown by * {@link #measure(int, int)}. Calling the superclass' * {@link #onMeasure(int, int)} is a valid use. * * * * The base class implementation of measure defaults to the background size, * unless a larger size is allowed by the MeasureSpec. Subclasses should * override {@link #onMeasure(int, int)} to provide better measurements of * their content. * * * * If this method is overridden, it is the subclass's responsibility to make * sure the measured height and width are at least the view's minimum height * and width ({@link #getSuggestedMinimumHeight()} and * {@link #getSuggestedMinimumWidth()}). * * * @param widthMeasureSpec horizontal space requirements as imposed by the parent. * The requirements are encoded with * {@link android.view.View.MeasureSpec}. * @param heightMeasureSpec vertical space requirements as imposed by the parent. * The requirements are encoded with * {@link android.view.View.MeasureSpec}. * * @see #getMeasuredWidth() * @see #getMeasuredHeight() * @see #setMeasuredDimension(int, int) * @see #getSuggestedMinimumHeight() * @see #getSuggestedMinimumWidth() * @see android.view.View.MeasureSpec#getMode(int) * @see android.view.View.MeasureSpec#getSize(int) */ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec), getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec)); } /** * Utility to return a default size. Uses the supplied size if the * MeasureSpec imposed no constraints. Will get larger if allowed * by the MeasureSpec. * * @param size Default size for this view * @param measureSpec Constraints imposed by the parent * @return The size this view should be. */ public static int getDefaultSize(int size, int measureSpec) { int result = size; int specMode = MeasureSpec.getMode(measureSpec); int specSize = MeasureSpec.getSize(measureSpec); switch (specMode) { case MeasureSpec.UNSPECIFIED: result = size; break; case MeasureSpec.AT_MOST: case MeasureSpec.EXACTLY: result = specSize; break; } return result; } DecorView.java\n@Override protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { final DisplayMetrics metrics = getContext().getResources().getDisplayMetrics(); final boolean isPortrait = getResources().getConfiguration().orientation == ORIENTATION_PORTRAIT; final int widthMode = getMode(widthMeasureSpec); final int heightMode = getMode(heightMeasureSpec); boolean fixedWidth = false; mApplyFloatingHorizontalInsets = false; if (widthMode == AT_MOST) { final TypedValue tvw = isPortrait ? mWindow.mFixedWidthMinor : mWindow.mFixedWidthMajor; if (tvw != null \u0026\u0026 tvw.type != TypedValue.TYPE_NULL) { final int w; if (tvw.type == TypedValue.TYPE_DIMENSION) { w = (int) tvw.getDimension(metrics); } else if (tvw.type == TypedValue.TYPE_FRACTION) { w = (int) tvw.getFraction(metrics.widthPixels, metrics.widthPixels); } else { w = 0; } if (DEBUG_MEASURE) Log.d(mLogTag, \"Fixed width: \" + w); final int widthSize = MeasureSpec.getSize(widthMeasureSpec); if (w \u003e 0) { widthMeasureSpec = MeasureSpec.makeMeasureSpec( Math.min(w, widthSize), EXACTLY); fixedWidth = true; } else { widthMeasureSpec = MeasureSpec.makeMeasureSpec( widthSize - mFloatingInsets.left - mFloatingInsets.right, AT_MOST); mApplyFloatingHorizontalInsets = true; } } } mApplyFloatingVerticalInsets = false; if (heightMode == AT_MOST) { final TypedValue tvh = isPortrait ? mWindow.mFixedHeightMajor : mWindow.mFixedHeightMinor; if (tvh != null \u0026\u0026 tvh.type != TypedValue.TYPE_NULL) { final int h; if (tvh.type == TypedValue.TYPE_DIMENSION) { h = (int) tvh.getDimension(metrics); } else if (tvh.type == TypedValue.TYPE_FRACTION) { h = (int) tvh.getFraction(metrics.heightPixels, metrics.heightPixels); } else { h = 0; } if (DEBUG_MEASURE) Log.d(mLogTag, \"Fixed height: \" + h); final int heightSize = MeasureSpec.getSize(heightMeasureSpec); if (h \u003e 0) { heightMeasureSpec = MeasureSpec.makeMeasureSpec( Math.min(h, heightSize), EXACTLY); } else if ((mWindow.getAttributes().flags \u0026 FLAG_LAYOUT_IN_SCREEN) == 0) { heightMeasureSpec = MeasureSpec.makeMeasureSpec( heightSize - mFloatingInsets.top - mFloatingInsets.bottom, AT_MOST); mApplyFloatingVerticalInsets = true; } } } getOutsets(mOutsets); if (mOutsets.top \u003e 0 || mOutsets.bottom \u003e 0) { int mode = MeasureSpec.getMode(heightMeasureSpec); if (mode != MeasureSpec.UNSPECIFIED) { int height = MeasureSpec.getSize(heightMeasureSpec); heightMeasureSpec = MeasureSpec.makeMeasureSpec( height + mOutsets.top + mOutsets.bottom, mode); } } if (mOutsets.left \u003e 0 || mOutsets.right \u003e 0) { int mode = MeasureSpec.getMode(widthMeasureSpec); if (mode != MeasureSpec.UNSPECIFIED) { int width = MeasureSpec.getSize(widthMeasureSpec); widthMeasureSpec = MeasureSpec.makeMeasureSpec( width + mOutsets.left + mOutsets.right, mode); } } super.onMeasure(widthMeasureSpec, heightMeasureSpec); int width = getMeasuredWidth(); boolean measure = false; widthMeasureSpec = MeasureSpec.makeMeasureSpec(width, EXACTLY); if (!fixedWidth \u0026\u0026 widthMode == AT_MOST) { final TypedValue tv = isPortrait ? mWindow.mMinWidthMinor : mWindow.mMinWidthMajor; if (tv.type != TypedValue.TYPE_NULL) { final int min; if (tv.type == TypedValue.TYPE_DIMENSION) { min = (int)tv.getDimension(metrics); } else if (tv.type == TypedValue.TYPE_FRACTION) { min = (int)tv.getFraction(mAvailableWidth, mAvailableWidth); } else { min = 0; } if (DEBUG_MEASURE) Log.d(mLogTag, \"Adjust for min width: \" + min + \", value::\" + tv.coerceToString() + \", mAvailableWidth=\" + mAvailableWidth); if (width \u003c min) { widthMeasureSpec = MeasureSpec.makeMeasureSpec(min, EXACTLY); measure = true; } } } // TODO: Support height? if (measure) { super.onMeasure(widthMeasureSpec, heightMeasureSpec); } } FrameLayout.java\n@Override protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { int count = getChildCount(); final boolean measureMatchParentChildren = MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY || MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY; mMatchParentChildren.clear(); int maxHeight = 0; int maxWidth = 0; int childState = 0; for (int i = 0; i \u003c count; i++) { final View child = getChildAt(i); if (mMeasureAllChildren || child.getVisibility() != GONE) { measureChildWithMargins(child, widthMeasureSpec, 0, heightMeasureSpec, 0); final LayoutParams lp = (LayoutParams) child.getLayoutParams(); maxWidth = Math.max(maxWidth, child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin); maxHeight = Math.max(maxHeight, child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin); childState = combineMeasuredStates(childState, child.getMeasuredState()); if (measureMatchParentChildren) { if (lp.width == LayoutParams.MATCH_PARENT || lp.height == LayoutParams.MATCH_PARENT) { mMatchParentChildren.add(child); } } } } // Account for padding too maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground(); maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground(); // Check against our minimum height and width maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight()); maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth()); // Check against our foreground's minimum height and width final Drawable drawable = getForeground(); if (drawable != null) { maxHeight = Math.max(maxHeight, drawable.getMinimumHeight()); maxWidth = Math.max(maxWidth, drawable.getMinimumWidth()); } setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState), resolveSizeAndState(maxHeight, heightMeasureSpec, childState \u003c\u003c MEASURED_HEIGHT_STATE_SHIFT)); count = mMatchParentChildren.size(); if (count \u003e 1) { for (int i = 0; i \u003c count; i++) { final View child = mMatchParentChildren.get(i); final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams(); final int childWidthMeasureSpec; if (lp.width == LayoutParams.MATCH_PARENT) { final int width = Math.max(0, getMeasuredWidth() - getPaddingLeftWithForeground() - getPaddingRightWithForeground() - lp.leftMargin - lp.rightMargin); childWidthMeasureSpec = MeasureSpec.makeMeasureSpec( width, MeasureSpec.EXACTLY); } else { childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec, getPaddingLeftWithForeground() + getPaddingRightWithForeground() + lp.leftMargin + lp.rightMargin, lp.width); } final int childHeightMeasureSpec; if (lp.height == LayoutParams.MATCH_PARENT) { final int height = Math.max(0, getMeasuredHeight() - getPaddingTopWithForeground() - getPaddingBottomWithForeground() - lp.topMargin - lp.bottomMargin); childHeightMeasureSpec = MeasureSpec.makeMeasureSpec( height, MeasureSpec.EXACTLY); } else { childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec, getPaddingTopWithForeground() + getPaddingBottomWithForeground() + lp.topMargin + lp.bottomMargin, lp.height); } child.measure(childWidthMeasureSpec, childHeightMeasureSpec); } } } ViewGroup.java\n/** * Ask one of the children of this view to measure itself, taking into * account both the MeasureSpec requirements for this view and its padding * and margins. The child must have MarginLayoutParams The heavy lifting is * done in getChildMeasureSpec. * * @param child The child to measure * @param parentWidthMeasureSpec The width requirements for this view * @param widthUsed Extra space that has been used up by the parent * horizontally (possibly by other children of the parent) * @param parentHeightMeasureSpec The height requirements for this view * @param heightUsed Extra space that has been used up by the parent * vertically (possibly by other children of the parent) */ protected void measureChildWithMargins(View child, int parentWidthMeasureSpec, int widthUsed, int parentHeightMeasureSpec, int heightUsed) { final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams(); final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec, mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin + widthUsed, lp.width); final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec, mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin + heightUsed, lp.height); child.measure(childWidthMeasureSpec, childHeightMeasureSpec); } /** * Does the hard part of measureChildren: figuring out the MeasureSpec to * pass to a particular child. This method figures out the right MeasureSpec * for one dimension (height or width) of one child view. * * The goal is to combine information from our MeasureSpec with the * LayoutParams of the child to get the best possible results. For example, * if the this view knows its size (because its MeasureSpec has a mode of * EXACTLY), and the child has indicated in its LayoutParams that it wants * to be the same size as the parent, the parent should ask the child to * layout given an exact size. * * @param spec The requirements for this view * @param padding The padding of this view for the current dimension and * margins, if applicable * @param childDimension How big the child wants to be in the current * dimension * @return a MeasureSpec integer for the child */ public static int getChildMeasureSpec(int spec, int padding, int childDimension) { int specMode = MeasureSpec.getMode(spec); int specSize = MeasureSpec.getSize(spec); int size = Math.max(0, specSize - padding); int resultSize = 0; int resultMode = 0; switch (specMode) { // Parent has imposed an exact size on us case MeasureSpec.EXACTLY: if (childDimension \u003e= 0) { resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // Child wants to be our size. So be it. resultSize = size; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // Child wants to determine its own size. It can't be // bigger than us. resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // Parent has imposed a maximum size on us case MeasureSpec.AT_MOST: if (childDimension \u003e= 0) { // Child wants a specific size... so be it resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // Child wants to be our size, but our size is not fixed. // Constrain child to not be bigger than us. resultSize = size; resultMode = MeasureSpec.AT_MOST; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // Child wants to determine its own size. It can't be // bigger than us. resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // Parent asked to see how big we want to be case MeasureSpec.UNSPECIFIED: if (childDimension \u003e= 0) { // Child wants a specific size... let him have it resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // Child wants to be our size... find out how big it should // be resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size; resultMode = MeasureSpec.UNSPECIFIED; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // Child wants to determine its own size.... find out how // big it should be resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size; resultMode = MeasureSpec.UNSPECIFIED; } break; } //noinspection ResourceType return MeasureSpec.makeMeasureSpec(resultSize, resultMode); } 布局 在ViewRootImpl的performLayout()方法中调用了DecorView的layout()方法，DecorView未重写FrameLayout的这一方法： FrameLayout.java\n@Override public final void layout(int l, int t, int r, int b) { if (!mSuppressLayout \u0026\u0026 (mTransition == null || !mTransition.isChangingLayout())) { if (mTransition != null) { mTransition.layoutChange(this); } super.layout(l, t, r, b); } else { // record the fact that we noop'd it; request layout when transition finishes mLayoutCalledWhileSuppressed = true; } } View.java\n/** * Assign a size and position to a view and all of its * descendants * * This is the second phase of the layout mechanism. * (The first is measuring). In this phase, each parent calls * layout on all of its children to position them. * This is typically done using the child measurements * that were stored in the measure pass().\n* * Derived classes should not override this method. * Derived classes with children should override * onLayout. In that method, they should * call layout on each of their children.\n* * @param l Left position, relative to parent * @param t Top position, relative to parent * @param r Right position, relative to parent * @param b Bottom position, relative to parent */ @SuppressWarnings({\"unchecked\"}) public void layout(int l, int t, int r, int b) { if ((mPrivateFlags3 \u0026 PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != 0) { onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec); mPrivateFlags3 \u0026= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT; } int oldL = mLeft; int oldT = mTop; int oldB = mBottom; int oldR = mRight; boolean changed = isLayoutModeOptical(mParent) ? setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b); if (changed || (mPrivateFlags \u0026 PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) { onLayout(changed, l, t, r, b); if (shouldDrawRoundScrollbar()) { if(mRoundScrollbarRenderer == null) { mRoundScrollbarRenderer = new RoundScrollbarRenderer(this); } } else { mRoundScrollbarRenderer = null; } mPrivateFlags \u0026= ~PFLAG_LAYOUT_REQUIRED; ListenerInfo li = mListenerInfo; if (li != null \u0026\u0026 li.mOnLayoutChangeListeners != null) { ArrayList\u003cOnLayoutChangeListener\u003e listenersCopy = (ArrayList\u003cOnLayoutChangeListener\u003e)li.mOnLayoutChangeListeners.clone(); int numListeners = listenersCopy.size(); for (int i = 0; i \u003c numListeners; ++i) { listenersCopy.get(i).onLayoutChange(this, l, t, r, b, oldL, oldT, oldR, oldB); } } } mPrivateFlags \u0026= ~PFLAG_FORCE_LAYOUT; mPrivateFlags3 |= PFLAG3_IS_LAID_OUT; if ((mPrivateFlags3 \u0026 PFLAG3_NOTIFY_AUTOFILL_ENTER_ON_LAYOUT) != 0) { mPrivateFlags3 \u0026= ~PFLAG3_NOTIFY_AUTOFILL_ENTER_ON_LAYOUT; notifyEnterOrExitForAutoFillIfNeeded(true); } } DecorView.java\n@Override protected void onLayout(boolean changed, int left, int top, int right, int bottom) { super.onLayout(changed, left, top, right, bottom); getOutsets(mOutsets); if (mOutsets.left \u003e 0) { offsetLeftAndRight(-mOutsets.left); } if (mOutsets.top \u003e 0) { offsetTopAndBottom(-mOutsets.top); } if (mApplyFloatingVerticalInsets) { offsetTopAndBottom(mFloatingInsets.top); } if (mApplyFloatingHorizontalInsets) { offsetLeftAndRight(mFloatingInsets.left); } // If the application changed its SystemUI metrics, we might also have to adapt // our shadow elevation. updateElevation(); mAllowUpdateElevation = true; if (changed \u0026\u0026 mResizeMode == RESIZE_MODE_DOCKED_DIVIDER) { getViewRootImpl().requestInvalidateRootRenderNode(); } } FrameLayout.java\n@Override protected void onLayout(boolean changed, int left, int top, int right, int bottom) { layoutChildren(left, top, right, bottom, false /* no force left gravity */); } void layoutChildren(int left, int top, int right, int bottom, boolean forceLeftGravity) { final int count = getChildCount(); final int parentLeft = getPaddingLeftWithForeground(); final int parentRight = right - left - getPaddingRightWithForeground(); final int parentTop = getPaddingTopWithForeground(); final int parentBottom = bottom - top - getPaddingBottomWithForeground(); for (int i = 0; i \u003c count; i++) { final View child = getChildAt(i); if (child.getVisibility() != GONE) { final LayoutParams lp = (LayoutParams) child.getLayoutParams(); final int width = child.getMeasuredWidth(); final int height = child.getMeasuredHeight(); int childLeft; int childTop; int gravity = lp.gravity; if (gravity == -1) { gravity = DEFAULT_CHILD_GRAVITY; } final int layoutDirection = getLayoutDirection(); final int absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection); final int verticalGravity = gravity \u0026 Gravity.VERTICAL_GRAVITY_MASK; switch (absoluteGravity \u0026 Gravity.HORIZONTAL_GRAVITY_MASK) { case Gravity.CENTER_HORIZONTAL: childLeft = parentLeft + (parentRight - parentLeft - width) / 2 + lp.leftMargin - lp.rightMargin; break; case Gravity.RIGHT: if (!forceLeftGravity) { childLeft = parentRight - width - lp.rightMargin; break; } case Gravity.LEFT: default: childLeft = parentLeft + lp.leftMargin; } switch (verticalGravity) { case Gravity.TOP: childTop = parentTop + lp.topMargin; break; case Gravity.CENTER_VERTICAL: childTop = parentTop + (parentBottom - parentTop - height) / 2 + lp.topMargin - lp.bottomMargin; break; case Gravity.BOTTOM: childTop = parentBottom - height - lp.bottomMargin; break; default: childTop = parentTop + lp.topMargin; } child.layout(childLeft, childTop, childLeft + width, childTop + height); } } } 绘制 ViewRootImpl在performDraw()方法中调用draw()方法， ViewRootImpl.java\nprivate void draw(boolean fullRedrawNeeded) { Surface surface = mSurface; if (!surface.isValid()) { return; } if (DEBUG_FPS) { trackFPS(); } if (!sFirstDrawComplete) { synchronized (sFirstDrawHandlers) { sFirstDrawComplete = true; final int count = sFirstDrawHandlers.size(); for (int i = 0; i\u003c count; i++) { mHandler.post(sFirstDrawHandlers.get(i)); } } } scrollToRectOrFocus(null, false); if (mAttachInfo.mViewScrollChanged) { mAttachInfo.mViewScrollChanged = false; mAttachInfo.mTreeObserver.dispatchOnScrollChanged(); } boolean animating = mScroller != null \u0026\u0026 mScroller.computeScrollOffset(); final int curScrollY; if (animating) { curScrollY = mScroller.getCurrY(); } else { curScrollY = mScrollY; } if (mCurScrollY != curScrollY) { mCurScrollY = curScrollY; fullRedrawNeeded = true; if (mView instanceof RootViewSurfaceTaker) { ((RootViewSurfaceTaker) mView).onRootViewScrollYChanged(mCurScrollY); } } final float appScale = mAttachInfo.mApplicationScale; final boolean scalingRequired = mAttachInfo.mScalingRequired; int resizeAlpha = 0; final Rect dirty = mDirty; if (mSurfaceHolder != null) { // The app owns the surface, we won't draw. dirty.setEmpty(); if (animating \u0026\u0026 mScroller != null) { mScroller.abortAnimation(); } return; } if (fullRedrawNeeded) { mAttachInfo.mIgnoreDirtyState = true; dirty.set(0, 0, (int) (mWidth * appScale + 0.5f), (int) (mHeight * appScale + 0.5f)); } if (DEBUG_ORIENTATION || DEBUG_DRAW) { Log.v(mTag, \"Draw \" + mView + \"/\" + mWindowAttributes.getTitle() + \": dirty={\" + dirty.left + \",\" + dirty.top + \",\" + dirty.right + \",\" + dirty.bottom + \"} surface=\" + surface + \" surface.isValid()=\" + surface.isValid() + \", appScale:\" + appScale + \", width=\" + mWidth + \", height=\" + mHeight); } mAttachInfo.mTreeObserver.dispatchOnDraw(); int xOffset = -mCanvasOffsetX; int yOffset = -mCanvasOffsetY + curScrollY; final WindowManager.LayoutParams params = mWindowAttributes; final Rect surfaceInsets = params != null ? params.surfaceInsets : null; if (surfaceInsets != null) { xOffset -= surfaceInsets.left; yOffset -= surfaceInsets.top; // Offset dirty rect for surface insets. dirty.offset(surfaceInsets.left, surfaceInsets.right); } boolean accessibilityFocusDirty = false; final Drawable drawable = mAttachInfo.mAccessibilityFocusDrawable; if (drawable != null) { final Rect bounds = mAttachInfo.mTmpInvalRect; final boolean hasFocus = getAccessibilityFocusedRect(bounds); if (!hasFocus) { bounds.setEmpty(); } if (!bounds.equals(drawable.getBounds())) { accessibilityFocusDirty = true; } } mAttachInfo.mDrawingTime = mChoreographer.getFrameTimeNanos() / TimeUtils.NANOS_PER_MS; if (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) { if (mAttachInfo.mThreadedRenderer != null \u0026\u0026 mAttachInfo.mThreadedRenderer.isEnabled()) { // If accessibility focus moved, always invalidate the root. boolean invalidateRoot = accessibilityFocusDirty || mInvalidateRootRequested; mInvalidateRootRequested = false; // Draw with hardware renderer. mIsAnimating = false; if (mHardwareYOffset != yOffset || mHardwareXOffset != xOffset) { mHardwareYOffset = yOffset; mHardwareXOffset = xOffset; invalidateRoot = true; } if (invalidateRoot) { mAttachInfo.mThreadedRenderer.invalidateRoot(); } dirty.setEmpty(); // Stage the content drawn size now. It will be transferred to the renderer // shortly before the draw commands get send to the renderer. final boolean updated = updateContentDrawBounds(); if (mReportNextDraw) { // report next draw overrides setStopped() // This value is re-sync'd to the value of mStopped // in the handling of mReportNextDraw post-draw. mAttachInfo.mThreadedRenderer.setStopped(false); } if (updated) { requestDrawWindow(); } mAttachInfo.mThreadedRenderer.draw(mView, mAttachInfo, this); } else { // If we get here with a disabled \u0026 requested hardware renderer, something went // wrong (an invalidate posted right before we destroyed the hardware surface // for instance) so we should just bail out. Locking the surface with software // rendering at this point would lock it forever and prevent hardware renderer // from doing its job when it comes back. // Before we request a new frame we must however attempt to reinitiliaze the // hardware renderer if it's in requested state. This would happen after an // eglTerminate() for instance. if (mAttachInfo.mThreadedRenderer != null \u0026\u0026 !mAttachInfo.mThreadedRenderer.isEnabled() \u0026\u0026 mAttachInfo.mThreadedRenderer.isRequested()) { try { mAttachInfo.mThreadedRenderer.initializeIfNeeded( mWidth, mHeight, mAttachInfo, mSurface, surfaceInsets); } catch (OutOfResourcesException e) { handleOutOfResourcesException(e); return; } mFullRedrawNeeded = true; scheduleTraversals(); return; } if (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) { return; } } } if (animating) { mFullRedrawNeeded = true; scheduleTraversals(); } } 其中调用mAttachInfo.mThreadedRenderer.draw(mView, mAttachInfo, this)进入视图绘制。 ThreadedRenderer.java\n/** * Draws the specified view. * * @param view The view to draw. * @param attachInfo AttachInfo tied to the specified view. * @param callbacks Callbacks invoked when drawing happens. */ void draw(View view, AttachInfo attachInfo, DrawCallbacks callbacks) { attachInfo.mIgnoreDirtyState = true; final Choreographer choreographer = attachInfo.mViewRootImpl.mChoreographer; choreographer.mFrameInfo.markDrawStart(); updateRootDisplayList(view, callbacks); attachInfo.mIgnoreDirtyState = false; // register animating rendernodes which started animating prior to renderer // creation, which is typical for animators started prior to first draw if (attachInfo.mPendingAnimatingRenderNodes != null) { final int count = attachInfo.mPendingAnimatingRenderNodes.size(); for (int i = 0; i \u003c count; i++) { registerAnimatingRenderNode( attachInfo.mPendingAnimatingRenderNodes.get(i)); } attachInfo.mPendingAnimatingRenderNodes.clear(); // We don't need this anymore as subsequent calls to // ViewRootImpl#attachRenderNodeAnimator will go directly to us. attachInfo.mPendingAnimatingRenderNodes = null; } final long[] frameInfo = choreographer.mFrameInfo.mFrameInfo; int syncResult = nSyncAndDrawFrame(mNativeProxy, frameInfo, frameInfo.length); if ((syncResult \u0026 SYNC_LOST_SURFACE_REWARD_IF_FOUND) != 0) { setEnabled(false); attachInfo.mViewRootImpl.mSurface.release(); // Invalidate since we failed to draw. This should fetch a Surface // if it is still needed or do nothing if we are no longer drawing attachInfo.mViewRootImpl.invalidate(); } if ((syncResult \u0026 SYNC_INVALIDATE_REQUIRED) != 0) { attachInfo.mViewRootImpl.invalidate(); } } private void updateRootDisplayList(View view, DrawCallbacks callbacks) { Trace.traceBegin(Trace.TRACE_TAG_VIEW, \"Record View#draw()\"); updateViewTreeDisplayList(view); if (mRootNodeNeedsUpdate || !mRootNode.isValid()) { DisplayListCanvas canvas = mRootNode.start(mSurfaceWidth, mSurfaceHeight); try { final int saveCount = canvas.save(); canvas.translate(mInsetLeft, mInsetTop); callbacks.onPreDraw(canvas); canvas.insertReorderBarrier(); canvas.drawRenderNode(view.updateDisplayListIfDirty()); canvas.insertInorderBarrier(); callbacks.onPostDraw(canvas); canvas.restoreToCount(saveCount); mRootNodeNeedsUpdate = false; } finally { mRootNode.end(canvas); } } Trace.traceEnd(Trace.TRACE_TAG_VIEW); } canvas.drawRenderNode(view.updateDisplayListIfDirty()) View.java\n/** * Gets the RenderNode for the view, and updates its DisplayList (if needed and supported) * @hide */ @NonNull public RenderNode updateDisplayListIfDirty() { final RenderNode renderNode = mRenderNode; if (!canHaveDisplayList()) { // can't populate RenderNode, don't try return renderNode; } if ((mPrivateFlags \u0026 PFLAG_DRAWING_CACHE_VALID) == 0 || !renderNode.isValid() || (mRecreateDisplayList)) { // Don't need to recreate the display list, just need to tell our // children to restore/recreate theirs if (renderNode.isValid() \u0026\u0026 !mRecreateDisplayList) { mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID; mPrivateFlags \u0026= ~PFLAG_DIRTY_MASK; dispatchGetDisplayList(); return renderNode; // no work needed } // If we got here, we're recreating it. Mark it as such to ensure that // we copy in child display lists into ours in drawChild() mRecreateDisplayList = true; int width = mRight - mLeft; int height = mBottom - mTop; int layerType = getLayerType(); final DisplayListCanvas canvas = renderNode.start(width, height); canvas.setHighContrastText(mAttachInfo.mHighContrastText); try { if (layerType == LAYER_TYPE_SOFTWARE) { buildDrawingCache(true); Bitmap cache = getDrawingCache(true); if (cache != null) { canvas.drawBitmap(cache, 0, 0, mLayerPaint); } } else { computeScroll(); canvas.translate(-mScrollX, -mScrollY); mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID; mPrivateFlags \u0026= ~PFLAG_DIRTY_MASK; // Fast path for layouts with no backgrounds if ((mPrivateFlags \u0026 PFLAG_SKIP_DRAW) == PFLAG_SKIP_DRAW) { dispatchDraw(canvas); drawAutofilledHighlight(canvas); if (mOverlay != null \u0026\u0026 !mOverlay.isEmpty()) { mOverlay.getOverlayView().draw(canvas); } if (debugDraw()) { debugDrawFocus(canvas); } } else { draw(canvas); } } } finally { renderNode.end(canvas); setDisplayListProperties(renderNode); } } else { mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID; mPrivateFlags \u0026= ~PFLAG_DIRTY_MASK; } return renderNode; } /** * Manually render this view (and all of its children) to the given Canvas. * The view must have already done a full layout before this function is * called. When implementing a view, implement * {@link #onDraw(android.graphics.Canvas)} instead of overriding this method. * If you do need to override this method, call the superclass version. * * @param canvas The Canvas to which the View is rendered. */ @CallSuper public void draw(Canvas canvas) { final int privateFlags = mPrivateFlags; final boolean dirtyOpaque = (privateFlags \u0026 PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE \u0026\u0026 (mAttachInfo == null || !mAttachInfo.mIgnoreDirtyState); mPrivateFlags = (privateFlags \u0026 ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN; /* * Draw traversal performs several drawing steps which must be executed * in the appropriate order: * * 1. Draw the background * 2. If necessary, save the canvas' layers to prepare for fading * 3. Draw view's content * 4. Draw children * 5. If necessary, draw the fading edges and restore layers * 6. Draw decorations (scrollbars for instance) */ // Step 1, draw the background, if needed int saveCount; if (!dirtyOpaque) { drawBackground(canvas); } // skip step 2 \u0026 5 if possible (common case) final int viewFlags = mViewFlags; boolean horizontalEdges = (viewFlags \u0026 FADING_EDGE_HORIZONTAL) != 0; boolean verticalEdges = (viewFlags \u0026 FADING_EDGE_VERTICAL) != 0; if (!verticalEdges \u0026\u0026 !horizontalEdges) { // Step 3, draw the content if (!dirtyOpaque) onDraw(canvas); // Step 4, draw the children dispatchDraw(canvas); drawAutofilledHighlight(canvas); // Overlay is part of the content and draws beneath Foreground if (mOverlay != null \u0026\u0026 !mOverlay.isEmpty()) { mOverlay.getOverlayView().dispatchDraw(canvas); } // Step 6, draw decorations (foreground, scrollbars) onDrawForeground(canvas); // Step 7, draw the default focus highlight drawDefaultFocusHighlight(canvas); if (debugDraw()) { debugDrawFocus(canvas); } // we're done... return; } /* * Here we do the full fledged routine... * (this is an uncommon case where speed matters less, * this is why we repeat some of the tests that have been * done above) */ boolean drawTop = false; boolean drawBottom = false; boolean drawLeft = false; boolean drawRight = false; float topFadeStrength = 0.0f; float bottomFadeStrength = 0.0f; float leftFadeStrength = 0.0f; float rightFadeStrength = 0.0f; // Step 2, save the canvas' layers int paddingLeft = mPaddingLeft; final boolean offsetRequired = isPaddingOffsetRequired(); if (offsetRequired) { paddingLeft += getLeftPaddingOffset(); } int left = mScrollX + paddingLeft; int right = left + mRight - mLeft - mPaddingRight - paddingLeft; int top = mScrollY + getFadeTop(offsetRequired); int bottom = top + getFadeHeight(offsetRequired); if (offsetRequired) { right += getRightPaddingOffset(); bottom += getBottomPaddingOffset(); } final ScrollabilityCache scrollabilityCache = mScrollCache; final float fadeHeight = scrollabilityCache.fadingEdgeLength; int length = (int) fadeHeight; // clip the fade length if top and bottom fades overlap // overlapping fades produce odd-looking artifacts if (verticalEdges \u0026\u0026 (top + length \u003e bottom - length)) { length = (bottom - top) / 2; } // also clip horizontal fades if necessary if (horizontalEdges \u0026\u0026 (left + length \u003e right - length)) { length = (right - left) / 2; } if (verticalEdges) { topFadeStrength = Math.max(0.0f, Math.min(1.0f, getTopFadingEdgeStrength())); drawTop = topFadeStrength * fadeHeight \u003e 1.0f; bottomFadeStrength = Math.max(0.0f, Math.min(1.0f, getBottomFadingEdgeStrength())); drawBottom = bottomFadeStrength * fadeHeight \u003e 1.0f; } if (horizontalEdges) { leftFadeStrength = Math.max(0.0f, Math.min(1.0f, getLeftFadingEdgeStrength())); drawLeft = leftFadeStrength * fadeHeight \u003e 1.0f; rightFadeStrength = Math.max(0.0f, Math.min(1.0f, getRightFadingEdgeStrength())); drawRight = rightFadeStrength * fadeHeight \u003e 1.0f; } saveCount = canvas.getSaveCount(); int solidColor = getSolidColor(); if (solidColor == 0) { final int flags = Canvas.HAS_ALPHA_LAYER_SAVE_FLAG; if (drawTop) { canvas.saveLayer(left, top, right, top + length, null, flags); } if (drawBottom) { canvas.saveLayer(left, bottom - length, right, bottom, null, flags); } if (drawLeft) { canvas.saveLayer(left, top, left + length, bottom, null, flags); } if (drawRight) { canvas.saveLayer(right - length, top, right, bottom, null, flags); } } else { scrollabilityCache.setFadeColor(solidColor); } // Step 3, draw the content if (!dirtyOpaque) onDraw(canvas); // Step 4, draw the children dispatchDraw(canvas); // Step 5, draw the fade effect and restore layers final Paint p = scrollabilityCache.paint; final Matrix matrix = scrollabilityCache.matrix; final Shader fade = scrollabilityCache.shader; if (drawTop) { matrix.setScale(1, fadeHeight * topFadeStrength); matrix.postTranslate(left, top); fade.setLocalMatrix(matrix); p.setShader(fade); canvas.drawRect(left, top, right, top + length, p); } if (drawBottom) { matrix.setScale(1, fadeHeight * bottomFadeStrength); matrix.postRotate(180); matrix.postTranslate(left, bottom); fade.setLocalMatrix(matrix); p.setShader(fade); canvas.drawRect(left, bottom - length, right, bottom, p); } if (drawLeft) { matrix.setScale(1, fadeHeight * leftFadeStrength); matrix.postRotate(-90); matrix.postTranslate(left, top); fade.setLocalMatrix(matrix); p.setShader(fade); canvas.drawRect(left, top, left + length, bottom, p); } if (drawRight) { matrix.setScale(1, fadeHeight * rightFadeStrength); matrix.postRotate(90); matrix.postTranslate(right, top); fade.setLocalMatrix(matrix); p.setShader(fade); canvas.drawRect(right - length, top, right, bottom, p); } canvas.restoreToCount(saveCount); drawAutofilledHighlight(canvas); // Overlay is part of the content and draws beneath Foreground if (mOverlay != null \u0026\u0026 !mOverlay.isEmpty()) { mOverlay.getOverlayView().dispatchDraw(canvas); } // Step 6, draw decorations (foreground, scrollbars) onDrawForeground(canvas); if (debugDraw()) { debugDrawFocus(canvas); } } 参考：\nHow Android Draws Views ","wordCount":"8259","inLanguage":"en","datePublished":"2018-03-11T15:00:39+08:00","dateModified":"2018-03-11T15:00:39+08:00","author":{"@type":"Person","name":"LEOY"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://epicmars.github.io/blog/android/framework/2018-03-08-android-view-drawing-flow/"},"publisher":{"@type":"Organization","name":"AndroidPi","logo":{"@type":"ImageObject","url":"https://acd-assets.alicdn.com/acd_work/tongyi/assets/logo.svg"}}}</script></head><body id=top><script>const hasHeaderBg=!1</script><header class=header><div class=nav-container><nav class=nav><div class=logo><a href=/ accesskey=h title="AndroidPi (Alt + H)"><svg width="25" height="24" viewBox="0 0 25 24" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient x1="76.7202373%" y1="41.6070847%" x2="18.306123%" y2="65.5065085%" id="linearGradient-9_1k7ha4jv-1"><stop stop-color="#797beb" offset="0"/><stop stop-color="#373080" offset="100%"/></linearGradient></defs><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="_编组-7" fill="url(#linearGradient-9_1k7ha4jv-1)"><path d="M12.2746711.0C12.5125388.0 12.7434104.12583746 12.8693403.33556656l1.3852293 2.3769298h6.1425827C20.63502 2.71249636 20.8658915 2.83833382 20.9918215 3.04806292l1.7420308 2.97815322C22.8597822 6.23594524 22.8597822 6.5016021 22.7338523 6.7113312L22.6988718 6.76725896C22.6708873 6.80920478 22.6359068 6.8511506 22.5939301 6.88610545L21.2156969 9.24905331l3.050303 5.24322749L24.3429571 14.6041363C24.4339065 14.8138654 24.4548948 15.0795223 24.3919298 15.2682785l-1.6021086 2.7404602C22.6638912 18.2184678 22.4400158 18.3443053 22.195152 18.3443053L19.4176972 18.3582872 16.353402 23.6504515C16.227472 23.8601806 16.0035966 23.9860181 15.7587328 23.9860181L12.2886633 24H12.2396906C12.0158151 23.9860181 11.7989358 23.8601806 11.6869981 23.6644334l-1.490171-2.551704H4.13120166C4.0822289 21.1267113 4.04025225 21.1267113 3.9912795 21.1267113 3.75341183 21.1267113 3.52254028 21.0008739 3.39661034 20.7911448L1.79450165 18.0506845C1.66857171 17.8479464 1.66857171 17.5892805 1.79450165 17.3725604l1.37823324-2.3909117L.0944474553 9.69647539c-.1259299404-.20273813-.1259299404-.46140402.0-.678124089999999L1.80849387 6.02621614c.11193772-.2097291.34280928-.33556656.59466916-.33556656C2.466128 5.67666764 2.51510075 5.69064958 2.56407351 5.70463152H5.40449327L8.44080406.46140402C8.45479628.4194582 8.46179238.38450335 8.48278071.35653947L8.49677292.33556656C8.62270286.12583746 8.84657831.0 9.09144209.0H12.2816672 12.2746711zM9.04246933.72706088 5.74730256 6.41071949H2.3751786L8.93752771 17.6871541H5.59338819l-1.61610091 2.789397H10.5606247l1.6790659 2.8942616 6.5623491-11.3043985 1.6790659 2.8802797L23.7203035 14.9327119 20.4181406 9.24905331l1.6650737-2.8662977L9.00049268 6.39673755 10.6795586 3.51645791 9.04946544.72706088H9.04246933zM16.1435187 9.82930382 12.2187023 16.5755899 8.2938858 9.82930382h7.8496329z" id="_形状"/></g></g></svg></a><div class=logo-switches></div></div><ul id=menu><li><a href=/resources title=Resources><span>Resources</span></a></li><li><a href=/blog/ title=Blog><span>Blog</span></a></li><li><a href=/publication title=Publication><span>Publication</span></a></li><li><a href=/about title=About><span>About</span></a></li></ul></nav></div></header><div class=hero-container><div class=hero><h1 class=post-title>Android View绘制流程</h1><div class=post-meta><span title='2018-03-11 15:00:39 +0800 CST'>March 11, 2018</span>&nbsp;·&nbsp;39 min&nbsp;·&nbsp;8259 words&nbsp;·&nbsp;LEOY</div></div></div><main class=main><article class=post-single><div class=post-content><h2 id=概述>概述<a hidden class=anchor aria-hidden=true href=#概述>#</a></h2><p>当一个Activity接收到焦点，它会请求对其布局进行绘制。Android框架会处理绘制的流程，但Activity必须提供布局层次的一个根节点。</p><p>绘制从布局的根节点开始，它需要对布局树进行测量并进行绘制。绘制通过遍历布局树对每个与失效区域（invalid region）相交的<code>View</code>进行绘制。依次地，每个<code>ViewGroup</code>请求它的每个子<code>View</code>进行绘制（使用<code>draw()</code>方法）并且每个<code>View</code>负责绘制它自身。因为布局树采用前序遍历，这意味着父View会在子View之前（也就是图层的下方）绘制，同时该父<code>View</code>的兄弟View会以它们在树中出现的顺序进行绘制。</p><blockquote><p>框架不会绘制失效区域外的<code>View</code>对象，并且会处理好<code>View</code>背景的绘制，你可以通过调用<code>invalidate()</code>方法来强制一个<code>View</code>进行绘制。</p></blockquote><p>布局的绘制需要经过两个过程的处理：</p><ul><li><p>测量</p><p>测量过程在<code>measure(int, int)</code>方法中实现，它是对<code>View</code>树的自上而下的遍历。在递归过程中，每个<code>View</code>将尺寸规范沿树从上往下推，在测量过程的结尾，每个<code>View</code>都存储其测量结果。</p></li><li><p>布局</p><p>布局过程在<code>layout(int, int, int, int)</code>中实现，它也是自上而下的。在这个过程中，每个父<code>View</code>负责对其所有子<code>View</code>的位置进行定位，它需要使用测量过程中计算出的视图尺寸。</p></li></ul><p>当一个<code>View</code>对象的<code>measure()</code>方法返回时，其<code>getMeasuredWidth()</code>和<code>getMeasuredHeight()</code>值必须被设定，对于该<code>View</code>的所有子孙<code>View</code>对象也是一样。一个<code>View</code>对象的测量的宽度和高度必须遵循父<code>View</code>施加的约束。这可以保证在测量过程的结尾，所有父视图都接收子视图的测量。一个父视图可能会在其子视图上多次调用<code>measure()</code>方法。例如，父视图可能使用未指定的尺寸规格对所有子视图进行测量，来找到子视图想要有多大，如果所有子视图不受约束的尺寸之和太大或者太小，这时候父视图会使用实际的尺寸规格再次调用<code>measure()</code>（也就是说，如果子视图不同意它们自己获取的空间，那么父视图会在第二次测量过程中介入并设定测量规则）。</p><blockquote><p>为了初始化一个布局，可以调用<code>requestLayout()</code>。通常当一个<code>View</code>相信它当前的边界已经不适合它了，那么它会在自身上调用该方法。</p></blockquote><p>测量过程采用两个类对尺寸进行沟通：</p><ul><li><p><code>ViewGroup.LayoutParams</code></p><p>用于<code>View</code>对象来告知它们的父级它们想要如何被测量和定位。基础<code>ViewGroup.LayoutParams</code>仅描述了<code>View</code>在宽度和高度上想要有多大。对于每个尺寸，它可以指定如下值：</p><ul><li>一个确切的数字</li><li><code>MATCH_PARENT</code>，表示<code>View</code>想和父级一样大（不包括父级的padding）</li><li><code>WRAP_CONTENT</code>，表示<code>View</code>想要刚好足够包围其内容的大小（包括padding）</li></ul></li><li><p><code>MeasureSpec</code></p><p>用于从上往下将测量需求从父级推给子级。<code>MeasureSpec</code>可以有如下三种模式：</p><ul><li><code>UNSPECIFIED</code>：一个父视图可以用他来确定一个子<code>View</code>所期望的尺寸。例如，一个<code>LinearLayout</code>可以在其子视图上调用<code>measure()</code>，其中将高度设置为<code>UNSPECIFIED</code>并且宽度设置为<code>EXACTLY</code> <code>240</code>来找出给定一个<code>240</code>像素的宽度时，子视图期望有多高。</li><li><code>EXACTLY</code>：用于父视图给子视图施加一个确定的尺寸。子视图必须使用该尺寸，并且保证它所有的后代视图都是符合该尺寸限制的。</li><li><code>AT MOST</code>：用于父视图给子视图施加一个最大的尺寸。子视图必须保证它以及其所有的后代都符合该尺寸的限制。</li></ul></li></ul><h2 id=源码分析>源码分析<a hidden class=anchor aria-hidden=true href=#源码分析>#</a></h2><h3 id=整体流程>整体流程<a hidden class=anchor aria-hidden=true href=#整体流程>#</a></h3><p>绘制从布局的根节点开始，它需要测量和和绘制布局树。
从ViewRootImpl的首次布局请求开始：</p><p>ViewRootImpl.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>TraversalRunnable</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>doTraversal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>requestLayout</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mHandlingLayoutInLayoutRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLayoutRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>scheduleTraversals</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleTraversals</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mTraversalScheduled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mTraversalScheduled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mTraversalBarrier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mHandler</span><span class=p>.</span><span class=na>getLooper</span><span class=p>().</span><span class=na>getQueue</span><span class=p>().</span><span class=na>postSyncBarrier</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mChoreographer</span><span class=p>.</span><span class=na>postCallback</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Choreographer</span><span class=p>.</span><span class=na>CALLBACK_TRAVERSAL</span><span class=p>,</span><span class=w> </span><span class=n>mTraversalRunnable</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mUnbufferedInputDispatch</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>scheduleConsumeBatchedInput</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notifyRendererOfFramePending</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pokeDrawLockIfNeeded</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>doTraversal</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mTraversalScheduled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mTraversalScheduled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mHandler</span><span class=p>.</span><span class=na>getLooper</span><span class=p>().</span><span class=na>getQueue</span><span class=p>().</span><span class=na>removeSyncBarrier</span><span class=p>(</span><span class=n>mTraversalBarrier</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mProfile</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Debug</span><span class=p>.</span><span class=na>startMethodTracing</span><span class=p>(</span><span class=s>&#34;ViewAncestor&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>performTraversals</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mProfile</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Debug</span><span class=p>.</span><span class=na>stopMethodTracing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mProfile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>performTraversals</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// cache mView since it is used so much below...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>host</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mView</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DBG</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;======================================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;performTraversals&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>host</span><span class=p>.</span><span class=na>debug</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>host</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>mAdded</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mIsInTraversal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWillDrawSoon</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>windowSizeMayChange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>newSurface</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>surfaceChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>desiredWindowWidth</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>desiredWindowHeight</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>viewVisibility</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getHostVisibility</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>viewVisibilityChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mFirst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>mViewVisibility</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>viewVisibility</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mNewSurfaceNeeded</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>viewUserVisibilityChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mFirst</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>((</span><span class=n>mViewVisibility</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>VISIBLE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=p>(</span><span class=n>viewVisibility</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>VISIBLE</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mWindowAttributesChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mWindowAttributesChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>surfaceChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CompatibilityInfo</span><span class=w> </span><span class=n>compatibilityInfo</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mDisplay</span><span class=p>.</span><span class=na>getDisplayAdjustments</span><span class=p>().</span><span class=na>getCompatibilityInfo</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>compatibilityInfo</span><span class=p>.</span><span class=na>supportsScreen</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>mLastInCompatMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mFullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLayoutRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mLastInCompatMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>params</span><span class=p>.</span><span class=na>privateFlags</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>PRIVATE_FLAG_COMPATIBLE_WINDOW</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mLastInCompatMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>params</span><span class=p>.</span><span class=na>privateFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>PRIVATE_FLAG_COMPATIBLE_WINDOW</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mLastInCompatMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindowAttributesChangesFlag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Rect</span><span class=w> </span><span class=n>frame</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWinFrame</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mFirst</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mFullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLayoutRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mContext</span><span class=p>.</span><span class=na>getResources</span><span class=p>().</span><span class=na>getConfiguration</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldUseDisplaySize</span><span class=p>(</span><span class=n>lp</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// NOTE -- system code, won&#39;t try to do compat mode.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Point</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Point</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mDisplay</span><span class=p>.</span><span class=na>getRealSize</span><span class=p>(</span><span class=n>size</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>desiredWindowWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>.</span><span class=na>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>desiredWindowHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>.</span><span class=na>y</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>desiredWindowWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dipToPx</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>screenWidthDp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>desiredWindowHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dipToPx</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>screenHeightDp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// We used to use the following condition to choose 32 bits drawing caches:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// PixelFormat.hasAlpha(lp.format) || lp.format == PixelFormat.RGBX_8888</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// However, windows are now always 32 bits by default, so choose 32 bits</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mUse32BitDrawingCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mHasWindowFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mWindowVisibility</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>viewVisibility</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mRecomputeGlobalAttributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLastConfigurationFromResources</span><span class=p>.</span><span class=na>setTo</span><span class=p>(</span><span class=n>config</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLastSystemUiVisibility</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mSystemUiVisibility</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Set the layout direction if it has not been set before (inherit is the default)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mViewLayoutDirectionInitial</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>LAYOUT_DIRECTION_INHERIT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>host</span><span class=p>.</span><span class=na>setLayoutDirection</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>getLayoutDirection</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>host</span><span class=p>.</span><span class=na>dispatchAttachedToWindow</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTreeObserver</span><span class=p>.</span><span class=na>dispatchOnWindowAttachedChange</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dispatchApplyInsets</span><span class=p>(</span><span class=n>host</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//Log.i(mTag, &#34;Screen on initialized: &#34; + attachInfo.mKeepScreenOn);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>desiredWindowWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>width</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>desiredWindowHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>height</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>desiredWindowWidth</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mWidth</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>desiredWindowHeight</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mHeight</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_ORIENTATION</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;View &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>host</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; resized to: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>frame</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mFullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mLayoutRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>windowSizeMayChange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>viewVisibilityChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mWindowVisibility</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>viewVisibility</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>host</span><span class=p>.</span><span class=na>dispatchWindowVisibilityChanged</span><span class=p>(</span><span class=n>viewVisibility</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>viewUserVisibilityChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>host</span><span class=p>.</span><span class=na>dispatchVisibilityAggregated</span><span class=p>(</span><span class=n>viewVisibility</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>VISIBLE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>viewVisibility</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>VISIBLE</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mNewSurfaceNeeded</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>endDragResizing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>destroyHardwareResources</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>viewVisibility</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>GONE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// After making a window gone, we will count it as being</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// shown for the first time the next time it gets focus.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mHasHadWindowFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Non-visible windows can&#39;t hold accessibility focus.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mWindowVisibility</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>VISIBLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>host</span><span class=p>.</span><span class=na>clearAccessibilityFocus</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Execute enqueued actions on every traversal in case a detached view enqueued an action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>getRunQueue</span><span class=p>().</span><span class=na>executeActions</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>insetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>layoutRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mLayoutRequested</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mStopped</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mReportNextDraw</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>layoutRequested</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Resources</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mView</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getResources</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mFirst</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// make sure touch mode code executes by setting cached value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// to opposite of the added touch mode.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mInTouchMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mAddedTouchMode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ensureTouchModeLocally</span><span class=p>(</span><span class=n>mAddedTouchMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mPendingOverscanInsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOverscanInsets</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>insetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mPendingContentInsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mContentInsets</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>insetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mPendingStableInsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mStableInsets</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>insetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mPendingVisibleInsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mVisibleInsets</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mVisibleInsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mPendingVisibleInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Visible insets changing to: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mVisibleInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mPendingOutsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOutsets</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>insetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPendingAlwaysConsumeNavBar</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mAlwaysConsumeNavBar</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>insetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lp</span><span class=p>.</span><span class=na>width</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>height</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>windowSizeMayChange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldUseDisplaySize</span><span class=p>(</span><span class=n>lp</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// NOTE -- system code, won&#39;t try to do compat mode.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Point</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Point</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mDisplay</span><span class=p>.</span><span class=na>getRealSize</span><span class=p>(</span><span class=n>size</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>desiredWindowWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>.</span><span class=na>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>desiredWindowHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>.</span><span class=na>y</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>res</span><span class=p>.</span><span class=na>getConfiguration</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>desiredWindowWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dipToPx</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>screenWidthDp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>desiredWindowHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dipToPx</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>screenHeightDp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Ask host how big it wants to be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>windowSizeMayChange</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>measureHierarchy</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>lp</span><span class=p>,</span><span class=w> </span><span class=n>res</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>desiredWindowWidth</span><span class=p>,</span><span class=w> </span><span class=n>desiredWindowHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>collectViewAttributes</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mForceReportNewAttributes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mForceReportNewAttributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mFirst</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mViewVisibilityChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mViewVisibilityChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>resizeMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSoftInputMode</span><span class=w> </span><span class=o>&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_MASK_ADJUST</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If we are in auto resize mode, then we need to determine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// what mode to use now.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resizeMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_ADJUST_UNSPECIFIED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mScrollContainers</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=o>=</span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>&lt;</span><span class=n>N</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mScrollContainers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>isShown</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>resizeMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_ADJUST_RESIZE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resizeMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>resizeMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_ADJUST_PAN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>lp</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_MASK_ADJUST</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>resizeMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>lp</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>lp</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>~</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_MASK_ADJUST</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>resizeMode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>params</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>host</span><span class=p>.</span><span class=na>mPrivateFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>PFLAG_REQUEST_TRANSPARENT_REGIONS</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>PixelFormat</span><span class=p>.</span><span class=na>formatHasAlpha</span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=na>format</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>params</span><span class=p>.</span><span class=na>format</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PixelFormat</span><span class=p>.</span><span class=na>TRANSLUCENT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOverscanRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=na>flags</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>FLAG_LAYOUT_IN_OVERSCAN</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mApplyInsetsRequested</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mApplyInsetsRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLastOverscanRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOverscanRequested</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dispatchApplyInsets</span><span class=p>(</span><span class=n>host</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mLayoutRequested</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Short-circuit catching a new layout request here, so</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// we don&#39;t need to go through two layout passes when things</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// change due to fitting system windows, which can happen a lot.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>windowSizeMayChange</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>measureHierarchy</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>lp</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mView</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getResources</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>desiredWindowWidth</span><span class=p>,</span><span class=w> </span><span class=n>desiredWindowHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>layoutRequested</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Clear this now, so that if anything requests a layout in the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// rest of this function we will catch it and re-run a full</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// layout pass.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLayoutRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>windowShouldResize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>layoutRequested</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>windowSizeMayChange</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>((</span><span class=n>mWidth</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mHeight</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>lp</span><span class=p>.</span><span class=na>width</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>frame</span><span class=p>.</span><span class=na>width</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>desiredWindowWidth</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>width</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mWidth</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>lp</span><span class=p>.</span><span class=na>height</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>frame</span><span class=p>.</span><span class=na>height</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>desiredWindowHeight</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>height</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mHeight</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>windowShouldResize</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>mDragResizing</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mResizeMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>RESIZE_MODE_FREEFORM</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If the activity was just relaunched, it might have unfrozen the task bounds (while</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// relaunching), so we need to force a call into window manager to pick up the latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// bounds.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>windowShouldResize</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>mActivityRelaunched</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Determine whether to compute insets.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If there are no inset listeners remaining then we may still need to compute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// insets in case the old insets were non-empty and must be reset.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>computesInternalInsets</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTreeObserver</span><span class=p>.</span><span class=na>hasComputeInternalInsetsListeners</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mHasNonEmptyGivenInternalInsets</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>insetsPending</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>relayoutResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>updatedConfiguration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>surfaceGenerationId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSurface</span><span class=p>.</span><span class=na>getGenerationId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isViewVisible</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>viewVisibility</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>VISIBLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>windowRelayoutWasForced</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mForceNextWindowRelayout</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mFirst</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>windowShouldResize</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>insetsChanged</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>viewVisibilityChanged</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>params</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mForceNextWindowRelayout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mForceNextWindowRelayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isViewVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If this window is giving internal insets to the window</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// manager, and it is being added or changing its visibility,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// then we want to first give the window manager &#34;fake&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// insets to cause it to effectively ignore the content of</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// the window during layout.  This avoids it briefly causing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// other windows to resize/move based on the raw frame of the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// window, waiting until we can finish laying out this window</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// and get back to the window manager with the ultimately</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// computed insets.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>insetsPending</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>computesInternalInsets</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>mFirst</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>viewVisibilityChanged</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSurfaceHolder</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>mSurfaceLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mDrawingAllowed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>hwInitialized</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>contentInsetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>hadSurface</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSurface</span><span class=p>.</span><span class=na>isValid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;host=w:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, h:&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, params=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// relayoutWindow may decide to destroy mSurface. As that decision</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// happens in WindowManager service, we need to be defensive here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// and stop using the surface in case it gets destroyed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>pauseSurface</span><span class=p>(</span><span class=n>mSurface</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Animations were running so we need to push a frame</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// to resume them</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mDirty</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>mHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mChoreographer</span><span class=p>.</span><span class=na>mFrameInfo</span><span class=p>.</span><span class=na>addFlags</span><span class=p>(</span><span class=n>FrameInfo</span><span class=p>.</span><span class=na>FLAG_WINDOW_LAYOUT_CHANGED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>relayoutResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>relayoutWindow</span><span class=p>(</span><span class=n>params</span><span class=p>,</span><span class=w> </span><span class=n>viewVisibility</span><span class=p>,</span><span class=w> </span><span class=n>insetsPending</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;relayout: frame=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>toShortString</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; overscan=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mPendingOverscanInsets</span><span class=p>.</span><span class=na>toShortString</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; content=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mPendingContentInsets</span><span class=p>.</span><span class=na>toShortString</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; visible=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mPendingVisibleInsets</span><span class=p>.</span><span class=na>toShortString</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; visible=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mPendingStableInsets</span><span class=p>.</span><span class=na>toShortString</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; outsets=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mPendingOutsets</span><span class=p>.</span><span class=na>toShortString</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; surface=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mSurface</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Configuration</span><span class=w> </span><span class=n>pendingMergedConfig</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mPendingMergedConfiguration</span><span class=p>.</span><span class=na>getMergedConfiguration</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pendingMergedConfig</span><span class=p>.</span><span class=na>seq</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_CONFIGURATION</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Visible with new config: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>pendingMergedConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>performConfigurationChange</span><span class=p>(</span><span class=n>mPendingMergedConfiguration</span><span class=p>,</span><span class=w> </span><span class=o>!</span><span class=n>mFirst</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>INVALID_DISPLAY</span><span class=w> </span><span class=cm>/* same display */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>pendingMergedConfig</span><span class=p>.</span><span class=na>seq</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>updatedConfiguration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>overscanInsetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mPendingOverscanInsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOverscanInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>contentInsetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mPendingContentInsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mContentInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>visibleInsetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mPendingVisibleInsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mVisibleInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>stableInsetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mPendingStableInsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mStableInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>outsetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>mPendingOutsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOutsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>surfaceSizeChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>relayoutResult</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>RELAYOUT_RES_SURFACE_RESIZED</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>alwaysConsumeNavBarChanged</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mPendingAlwaysConsumeNavBar</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mAlwaysConsumeNavBar</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>contentInsetsChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mContentInsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mPendingContentInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Content insets changing to: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mContentInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>overscanInsetsChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOverscanInsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mPendingOverscanInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Overscan insets changing to: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOverscanInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Need to relayout with content insets.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>contentInsetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stableInsetsChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mStableInsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mPendingStableInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Decor insets changing to: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mStableInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Need to relayout with content insets.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>contentInsetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>alwaysConsumeNavBarChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mAlwaysConsumeNavBar</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPendingAlwaysConsumeNavBar</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>contentInsetsChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>contentInsetsChanged</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mLastSystemUiVisibility</span><span class=w> </span><span class=o>!=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mSystemUiVisibility</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mApplyInsetsRequested</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=n>mLastOverscanRequested</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOverscanRequested</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=n>outsetsChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mLastSystemUiVisibility</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mSystemUiVisibility</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mLastOverscanRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOverscanRequested</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mOutsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mPendingOutsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mApplyInsetsRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>dispatchApplyInsets</span><span class=p>(</span><span class=n>host</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>visibleInsetsChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mVisibleInsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mPendingVisibleInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Visible insets changing to: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mVisibleInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hadSurface</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSurface</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// If we are creating a new surface, then we need to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// completely redraw it.  Also, when we get to the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// point of drawing it we will hold off and schedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// a new traversal instead.  This is so we can tell the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// window manager about all of the windows being displayed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// before actually drawing them, so it can display then</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// all at once.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>newSurface</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mFullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mPreviousTransparentRegion</span><span class=p>.</span><span class=na>setEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Only initialize up-front if transparent regions are not</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// requested, otherwise defer to see if the entire window</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// will be transparent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>hwInitialized</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>initialize</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>mSurface</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hwInitialized</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>host</span><span class=p>.</span><span class=na>mPrivateFlags</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=o>&amp;</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>PFLAG_REQUEST_TRANSPARENT_REGIONS</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=c1>// Don&#39;t pre-allocate if transparent regions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=c1>// are requested as they may not be needed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>mSurface</span><span class=p>.</span><span class=na>allocateBuffers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>OutOfResourcesException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>handleOutOfResourcesException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mSurface</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// If the surface has been removed, then reset the scroll</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// positions.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mLastScrolledFocus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mLastScrolledFocus</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mScrollY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mCurScrollY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mView</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>RootViewSurfaceTaker</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>((</span><span class=n>RootViewSurfaceTaker</span><span class=p>)</span><span class=w> </span><span class=n>mView</span><span class=p>).</span><span class=na>onRootViewScrollYChanged</span><span class=p>(</span><span class=n>mCurScrollY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mScroller</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mScroller</span><span class=p>.</span><span class=na>abortAnimation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Our surface is gone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>isEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>destroy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>surfaceGenerationId</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mSurface</span><span class=p>.</span><span class=na>getGenerationId</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=n>surfaceSizeChanged</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>windowRelayoutWasForced</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mSurfaceHolder</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mFullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Need to do updateSurface (which leads to CanvasContext::setSurface and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// re-create the EGLSurface) if either the Surface changed (as indicated by</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// generation id), or WindowManager changed the surface size. The latter is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// because on some chips, changing the consumer side&#39;s BufferQueue size may</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// not take effect immediately unless we create a new EGLSurface.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Note that frame size change doesn&#39;t always imply surface size change (eg.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// drag resizing uses fullscreen surface), need to check surfaceSizeChanged</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// flag from WindowManager.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>updateSurface</span><span class=p>(</span><span class=n>mSurface</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>OutOfResourcesException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>handleOutOfResourcesException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>freeformResizing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>relayoutResult</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>RELAYOUT_RES_DRAG_RESIZING_FREEFORM</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>dockedResizing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>relayoutResult</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>RELAYOUT_RES_DRAG_RESIZING_DOCKED</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>dragResizing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>freeformResizing</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>dockedResizing</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDragResizing</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>dragResizing</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dragResizing</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mResizeMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>freeformResizing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>?</span><span class=w> </span><span class=n>RESIZE_MODE_FREEFORM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>:</span><span class=w> </span><span class=n>RESIZE_MODE_DOCKED_DIVIDER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>startDragResizing</span><span class=p>(</span><span class=n>mPendingBackDropFrame</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>mWinFrame</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mPendingBackDropFrame</span><span class=p>),</span><span class=w> </span><span class=n>mPendingVisibleInsets</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>mPendingStableInsets</span><span class=p>,</span><span class=w> </span><span class=n>mResizeMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// We shouldn&#39;t come here, but if we come we should end the resize.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>endDragResizing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>USE_MT_RENDERER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dragResizing</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mCanvasOffsetX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWinFrame</span><span class=p>.</span><span class=na>left</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mCanvasOffsetY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWinFrame</span><span class=p>.</span><span class=na>top</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mCanvasOffsetX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mCanvasOffsetY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_ORIENTATION</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Relayout returned: frame=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>frame</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, surface=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mSurface</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mWindowLeft</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>left</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mWindowTop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>top</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// !!FIXME!! This next section handles the case where we did not get the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// window size we asked for. We should avoid this by getting a maximum size from</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the window session beforehand.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mWidth</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>width</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mHeight</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>height</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>width</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>frame</span><span class=p>.</span><span class=na>height</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSurfaceHolder</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// The app owns the surface; tell it about what is going on.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSurface</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// XXX .copyFrom() doesn&#39;t work!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//mSurfaceHolder.mSurface.copyFrom(mSurface);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>mSurface</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSurface</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>setSurfaceFrameSize</span><span class=p>(</span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>mHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>mSurfaceLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSurface</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hadSurface</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>ungetCallbacks</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mIsCreating</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>SurfaceHolder</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=n>callbacks</span><span class=o>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>getCallbacks</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>callbacks</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>SurfaceHolder</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>callbacks</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>c</span><span class=p>.</span><span class=na>surfaceCreated</span><span class=p>(</span><span class=n>mSurfaceHolder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>surfaceChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>surfaceChanged</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>surfaceGenerationId</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mSurface</span><span class=p>.</span><span class=na>getGenerationId</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>SurfaceHolder</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=n>callbacks</span><span class=o>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>getCallbacks</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>callbacks</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>SurfaceHolder</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>callbacks</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>c</span><span class=p>.</span><span class=na>surfaceChanged</span><span class=p>(</span><span class=n>mSurfaceHolder</span><span class=p>,</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>format</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>mHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mIsCreating</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hadSurface</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>ungetCallbacks</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>SurfaceHolder</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=n>callbacks</span><span class=o>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>getCallbacks</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>callbacks</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>SurfaceHolder</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>callbacks</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>c</span><span class=p>.</span><span class=na>surfaceDestroyed</span><span class=p>(</span><span class=n>mSurfaceHolder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>mSurfaceLock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>mSurface</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Surface</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>mSurfaceLock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>ThreadedRenderer</span><span class=w> </span><span class=n>threadedRenderer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>threadedRenderer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>threadedRenderer</span><span class=p>.</span><span class=na>isEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hwInitialized</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=n>mWidth</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>threadedRenderer</span><span class=p>.</span><span class=na>getWidth</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=n>mHeight</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>threadedRenderer</span><span class=p>.</span><span class=na>getHeight</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=n>mNeedsRendererSetup</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>threadedRenderer</span><span class=p>.</span><span class=na>setup</span><span class=p>(</span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>mHeight</span><span class=p>,</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>surfaceInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mNeedsRendererSetup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mStopped</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mReportNextDraw</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>focusChangedDueToTouchMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ensureTouchModeLocally</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>(</span><span class=n>relayoutResult</span><span class=o>&amp;</span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>RELAYOUT_RES_IN_TOUCH_MODE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>focusChangedDueToTouchMode</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mWidth</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>||</span><span class=w> </span><span class=n>mHeight</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>contentInsetsChanged</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>updatedConfiguration</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>childWidthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getRootMeasureSpec</span><span class=p>(</span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>width</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getRootMeasureSpec</span><span class=p>(</span><span class=n>mHeight</span><span class=p>,</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>height</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Ooops, something changed!  mWidth=&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>mWidth</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; measuredWidth=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34; mHeight=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mHeight</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34; measuredHeight=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34; coveredInsetsChanged=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>contentInsetsChanged</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=c1>// Ask host how big it wants to be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>performMeasure</span><span class=p>(</span><span class=n>childWidthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Implementation of weights from WindowManager.LayoutParams</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// We just grow the dimensions as needed and re-measure if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// needs be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>boolean</span><span class=w> </span><span class=n>measureAgain</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lp</span><span class=p>.</span><span class=na>horizontalWeight</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>width</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>((</span><span class=n>mWidth</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>width</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>horizontalWeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>childWidthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>width</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>measureAgain</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lp</span><span class=p>.</span><span class=na>verticalWeight</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>height</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>((</span><span class=n>mHeight</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>height</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>verticalWeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>childHeightMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>height</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>measureAgain</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>measureAgain</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34;And hey let&#39;s measure once more: width=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>width</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=o>+</span><span class=w> </span><span class=s>&#34; height=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>height</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>performMeasure</span><span class=p>(</span><span class=n>childWidthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>layoutRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Not the first pass and no window/insets/visibility change but the window</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// may have moved and we need check that and if so to update the left and right</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// in the attach info. We translate only the window frame since on window move</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// the window manager tells us only for the new frame but the insets are the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// same and we do not want to translate them more than once.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>maybeHandleWindowMove</span><span class=p>(</span><span class=n>frame</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>didLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>layoutRequested</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mStopped</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mReportNextDraw</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>triggerGlobalLayoutListener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>didLayout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mRecomputeGlobalAttributes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>didLayout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>performLayout</span><span class=p>(</span><span class=n>lp</span><span class=p>,</span><span class=w> </span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>mHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// By this point all views have been sized and positioned</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// We can compute the transparent area</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>host</span><span class=p>.</span><span class=na>mPrivateFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>PFLAG_REQUEST_TRANSPARENT_REGIONS</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// start out transparent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// TODO: AVOID THAT CALL BY CACHING THE RESULT?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>host</span><span class=p>.</span><span class=na>getLocationInWindow</span><span class=p>(</span><span class=n>mTmpLocation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mTransparentRegion</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mTmpLocation</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>mTmpLocation</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mTmpLocation</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>mRight</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>mLeft</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mTmpLocation</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>mBottom</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>mTop</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>host</span><span class=p>.</span><span class=na>gatherTransparentRegion</span><span class=p>(</span><span class=n>mTransparentRegion</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mTranslator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mTranslator</span><span class=p>.</span><span class=na>translateRegionInWindowToScreen</span><span class=p>(</span><span class=n>mTransparentRegion</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mTransparentRegion</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>mPreviousTransparentRegion</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mPreviousTransparentRegion</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>mTransparentRegion</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mFullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// reconfigure window manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mWindowSession</span><span class=p>.</span><span class=na>setTransparentRegion</span><span class=p>(</span><span class=n>mWindow</span><span class=p>,</span><span class=w> </span><span class=n>mTransparentRegion</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DBG</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;======================================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;performTraversals -- after setFrame&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>host</span><span class=p>.</span><span class=na>debug</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>triggerGlobalLayoutListener</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mRecomputeGlobalAttributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTreeObserver</span><span class=p>.</span><span class=na>dispatchOnGlobalLayout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>computesInternalInsets</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Clear the original insets.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>ViewTreeObserver</span><span class=p>.</span><span class=na>InternalInsetsInfo</span><span class=w> </span><span class=n>insets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mGivenInternalInsets</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>insets</span><span class=p>.</span><span class=na>reset</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Compute new insets in place.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTreeObserver</span><span class=p>.</span><span class=na>dispatchOnComputeInternalInsets</span><span class=p>(</span><span class=n>insets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mHasNonEmptyGivenInternalInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>insets</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Tell the window manager.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>insetsPending</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>mLastGivenInsets</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>insets</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mLastGivenInsets</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>insets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Translate insets to screen coordinates if needed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>contentInsets</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>visibleInsets</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Region</span><span class=w> </span><span class=n>touchableRegion</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mTranslator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>contentInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mTranslator</span><span class=p>.</span><span class=na>getTranslatedContentInsets</span><span class=p>(</span><span class=n>insets</span><span class=p>.</span><span class=na>contentInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>visibleInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mTranslator</span><span class=p>.</span><span class=na>getTranslatedVisibleInsets</span><span class=p>(</span><span class=n>insets</span><span class=p>.</span><span class=na>visibleInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>touchableRegion</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mTranslator</span><span class=p>.</span><span class=na>getTranslatedTouchableArea</span><span class=p>(</span><span class=n>insets</span><span class=p>.</span><span class=na>touchableRegion</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>contentInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>insets</span><span class=p>.</span><span class=na>contentInsets</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>visibleInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>insets</span><span class=p>.</span><span class=na>visibleInsets</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>touchableRegion</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>insets</span><span class=p>.</span><span class=na>touchableRegion</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mWindowSession</span><span class=p>.</span><span class=na>setInsets</span><span class=p>(</span><span class=n>mWindow</span><span class=p>,</span><span class=w> </span><span class=n>insets</span><span class=p>.</span><span class=na>mTouchableInsets</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>contentInsets</span><span class=p>,</span><span class=w> </span><span class=n>visibleInsets</span><span class=p>,</span><span class=w> </span><span class=n>touchableRegion</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mFirst</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>sAlwaysAssignFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// handle first focus request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_INPUT_RESIZE</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;First: mView.hasFocus()=&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=n>mView</span><span class=p>.</span><span class=na>hasFocus</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mView</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mView</span><span class=p>.</span><span class=na>hasFocus</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mView</span><span class=p>.</span><span class=na>restoreDefaultFocus</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_INPUT_RESIZE</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;First: requested focused view=&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>mView</span><span class=p>.</span><span class=na>findFocus</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_INPUT_RESIZE</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;First: existing focused view=&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=n>mView</span><span class=p>.</span><span class=na>findFocus</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>changedVisibility</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>viewVisibilityChanged</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mFirst</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>isViewVisible</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasWindowFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mHasWindowFocus</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>isViewVisible</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>regainedFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hasWindowFocus</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mLostWindowFocus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>regainedFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLostWindowFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasWindowFocus</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mHadWindowFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLostWindowFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>changedVisibility</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>regainedFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Toasts are presented as notifications - don&#39;t present them as windows as well</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>isToast</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>mWindowAttributes</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>TYPE_TOAST</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isToast</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>host</span><span class=p>.</span><span class=na>sendAccessibilityEvent</span><span class=p>(</span><span class=n>AccessibilityEvent</span><span class=p>.</span><span class=na>TYPE_WINDOW_STATE_CHANGED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mFirst</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWillDrawSoon</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mNewSurfaceNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mActivityRelaunched</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mViewVisibility</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>viewVisibility</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mHadWindowFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hasWindowFocus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasWindowFocus</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isInLocalFocusMode</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>imTarget</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>mayUseInputMethod</span><span class=p>(</span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>flags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>imTarget</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mLastWasImTarget</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mLastWasImTarget</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>imTarget</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>InputMethodManager</span><span class=w> </span><span class=n>imm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>InputMethodManager</span><span class=p>.</span><span class=na>peekInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>imm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>imTarget</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>imm</span><span class=p>.</span><span class=na>onPreWindowFocus</span><span class=p>(</span><span class=n>mView</span><span class=p>,</span><span class=w> </span><span class=n>hasWindowFocus</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>imm</span><span class=p>.</span><span class=na>onPostWindowFocus</span><span class=p>(</span><span class=n>mView</span><span class=p>,</span><span class=w> </span><span class=n>mView</span><span class=p>.</span><span class=na>findFocus</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>softInputMode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>!</span><span class=n>mHasHadWindowFocus</span><span class=p>,</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>flags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Remember if we must report the next draw.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>relayoutResult</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>RELAYOUT_RES_FIRST_TIME</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>reportNextDraw</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>cancelDraw</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTreeObserver</span><span class=p>.</span><span class=na>dispatchOnPreDraw</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>isViewVisible</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cancelDraw</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>newSurface</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPendingTransitions</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mPendingTransitions</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>mPendingTransitions</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mPendingTransitions</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>startChangingAnimations</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPendingTransitions</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>performDraw</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isViewVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Try again</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>scheduleTraversals</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPendingTransitions</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mPendingTransitions</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>mPendingTransitions</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mPendingTransitions</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>endChangingAnimations</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPendingTransitions</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mIsInTraversal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Figures out the measure spec for the root view in a window based on it&#39;s
</span></span></span><span class=line><span class=cl><span class=cm>     * layout params.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param windowSize
</span></span></span><span class=line><span class=cl><span class=cm>     *            The available width or height of the window
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param rootDimension
</span></span></span><span class=line><span class=cl><span class=cm>     *            The layout params for one dimension (width or height) of the
</span></span></span><span class=line><span class=cl><span class=cm>     *            window.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return The measure spec to use to measure the root view.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getRootMeasureSpec</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>windowSize</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>rootDimension</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>measureSpec</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>rootDimension</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Window can&#39;t resize. Force root view to be windowSize.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>measureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>windowSize</span><span class=p>,</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Window can resize. Set max size for root view.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>measureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>windowSize</span><span class=p>,</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Window wants to be an exact size. Force root view to be that size.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>measureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>rootDimension</span><span class=p>,</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>measureSpec</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>performMeasure</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>childWidthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mView</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_VIEW</span><span class=p>,</span><span class=w> </span><span class=s>&#34;measure&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mView</span><span class=p>.</span><span class=na>measure</span><span class=p>(</span><span class=n>childWidthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_VIEW</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>performLayout</span><span class=p>(</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>lp</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>desiredWindowWidth</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>desiredWindowHeight</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLayoutRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mScrollMayChange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mInLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>host</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mView</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>host</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_ORIENTATION</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>DEBUG_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Laying out &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>host</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; to (&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;)&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_VIEW</span><span class=p>,</span><span class=w> </span><span class=s>&#34;layout&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>host</span><span class=p>.</span><span class=na>layout</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>(),</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mInLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>numViewsRequestingLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mLayoutRequesters</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>numViewsRequestingLayout</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// requestLayout() was called during layout.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If no layout-request flags are set on the requesting views, there is no problem.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If some requests are still pending, then we need to clear those flags and do</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// a full request/measure/layout pass to handle this situation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>View</span><span class=o>&gt;</span><span class=w> </span><span class=n>validLayoutRequesters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getValidLayoutRequesters</span><span class=p>(</span><span class=n>mLayoutRequesters</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>validLayoutRequesters</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Set this flag to indicate that any further requests are happening during</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// the second pass, which may result in posting those requests to the next</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// frame instead</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mHandlingLayoutInLayoutRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Process fresh layout requests, then measure and layout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>numValidRequests</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>validLayoutRequesters</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>numValidRequests</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>final</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>validLayoutRequesters</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=s>&#34;View&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;requestLayout() improperly called by &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>view</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34; during layout: running second layout pass&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>view</span><span class=p>.</span><span class=na>requestLayout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>measureHierarchy</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>lp</span><span class=p>,</span><span class=w> </span><span class=n>mView</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getResources</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>desiredWindowWidth</span><span class=p>,</span><span class=w> </span><span class=n>desiredWindowHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mInLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>host</span><span class=p>.</span><span class=na>layout</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>(),</span><span class=w> </span><span class=n>host</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mHandlingLayoutInLayoutRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Check the valid requests again, this time without checking/clearing the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// layout flags, since requests happening during the second pass get noop&#39;d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>validLayoutRequesters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getValidLayoutRequesters</span><span class=p>(</span><span class=n>mLayoutRequesters</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>validLayoutRequesters</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>final</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>View</span><span class=o>&gt;</span><span class=w> </span><span class=n>finalRequesters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>validLayoutRequesters</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Post second-pass requests to the next frame</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>getRunQueue</span><span class=p>().</span><span class=na>post</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=kt>int</span><span class=w> </span><span class=n>numValidRequests</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>finalRequesters</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>numValidRequests</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=kd>final</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>finalRequesters</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=s>&#34;View&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;requestLayout() improperly called by &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>view</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                            </span><span class=s>&#34; during second layout pass: posting in next frame&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>view</span><span class=p>.</span><span class=na>requestLayout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_VIEW</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mInLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>performDraw</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mDisplayState</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Display</span><span class=p>.</span><span class=na>STATE_OFF</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mReportNextDraw</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mView</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>fullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mFullRedrawNeeded</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mFullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mIsDrawing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_VIEW</span><span class=p>,</span><span class=w> </span><span class=s>&#34;draw&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>draw</span><span class=p>(</span><span class=n>fullRedrawNeeded</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mIsDrawing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_VIEW</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// For whatever reason we didn&#39;t create a HardwareRenderer, end any</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// hardware animations that are now dangling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mPendingAnimatingRenderNodes</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mPendingAnimatingRenderNodes</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mPendingAnimatingRenderNodes</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>endAllAnimators</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mPendingAnimatingRenderNodes</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mReportNextDraw</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mReportNextDraw</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// if we&#39;re using multi-thread renderer, wait for the window frame draws</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mWindowDrawCountDown</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mWindowDrawCountDown</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Window redraw count down interruped!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mWindowDrawCountDown</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>fence</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>setStopped</span><span class=p>(</span><span class=n>mStopped</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOCAL_LOGV</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;FINISHED DRAWING: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>getTitle</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSurfaceHolder</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mSurface</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SurfaceCallbackHelper</span><span class=w> </span><span class=n>sch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SurfaceCallbackHelper</span><span class=p>(</span><span class=k>this</span><span class=p>::</span><span class=n>postDrawFinished</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SurfaceHolder</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=n>callbacks</span><span class=o>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSurfaceHolder</span><span class=p>.</span><span class=na>getCallbacks</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sch</span><span class=p>.</span><span class=na>dispatchSurfaceRedrawNeededAsync</span><span class=p>(</span><span class=n>mSurfaceHolder</span><span class=p>,</span><span class=w> </span><span class=n>callbacks</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pendingDrawFinished</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>    
</span></span></span></code></pre></div><h3 id=测量>测量<a hidden class=anchor aria-hidden=true href=#测量>#</a></h3><p>ViewRootImpl的mView是所在Window的顶级布局DecorView，它继承了FrameLayout布局，执行的<code>measure()</code>继承于View：
View.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * This is called to find out how big a view should be. The parent
</span></span></span><span class=line><span class=cl><span class=cm>     * supplies constraint information in the width and height parameters.
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * The actual measurement work of a view is performed in
</span></span></span><span class=line><span class=cl><span class=cm>     * {@link #onMeasure(int, int)}, called by this method. Therefore, only
</span></span></span><span class=line><span class=cl><span class=cm>     * {@link #onMeasure(int, int)} can and must be overridden by subclasses.
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param widthMeasureSpec Horizontal space requirements as imposed by the
</span></span></span><span class=line><span class=cl><span class=cm>     *        parent
</span></span></span><span class=line><span class=cl><span class=cm>     * @param heightMeasureSpec Vertical space requirements as imposed by the
</span></span></span><span class=line><span class=cl><span class=cm>     *        parent
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @see #onMeasure(int, int)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>measure</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>optical</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isLayoutModeOptical</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>optical</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>isLayoutModeOptical</span><span class=p>(</span><span class=n>mParent</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Insets</span><span class=w> </span><span class=n>insets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getOpticalInsets</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>oWidth</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>insets</span><span class=p>.</span><span class=na>left</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>insets</span><span class=p>.</span><span class=na>right</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>oHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>insets</span><span class=p>.</span><span class=na>top</span><span class=w>  </span><span class=o>+</span><span class=w> </span><span class=n>insets</span><span class=p>.</span><span class=na>bottom</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>widthMeasureSpec</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>adjust</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w>  </span><span class=n>optical</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=o>-</span><span class=n>oWidth</span><span class=w>  </span><span class=p>:</span><span class=w> </span><span class=n>oWidth</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>heightMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>adjust</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>optical</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=o>-</span><span class=n>oHeight</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>oHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Suppress sign extension for the low bytes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>32</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>0xffffffffL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mMeasureCache</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=n>mMeasureCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LongSparseLongArray</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>forceLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PFLAG_FORCE_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>PFLAG_FORCE_LAYOUT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Optimize layout by avoiding an extra EXACTLY pass when the view is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// already measured as the correct size. In API 23 and below, this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// extra pass is required to make LinearLayout re-distribute weight.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>specChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mOldWidthMeasureSpec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>mOldHeightMeasureSpec</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isSpecExactly</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>matchesSpecSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMeasuredWidth</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>getMeasuredHeight</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>needsLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>specChanged</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>sAlwaysRemeasureExactly</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>isSpecExactly</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>matchesSpecSize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>forceLayout</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>needsLayout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// first clears the measured dimension flag</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PFLAG_MEASURED_DIMENSION_SET</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>resolveRtlPropertiesIfNeeded</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>cacheIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>forceLayout</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>mMeasureCache</span><span class=p>.</span><span class=na>indexOfKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cacheIndex</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>sIgnoreMeasureCache</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// measure ourselves, this should set the measured dimension flag back</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>onMeasure</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPrivateFlags3</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mMeasureCache</span><span class=p>.</span><span class=na>valueAt</span><span class=p>(</span><span class=n>cacheIndex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Casting a long to int drops the high 32 bits, no mask needed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setMeasuredDimensionRaw</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>32</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPrivateFlags3</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// flag not set, setMeasuredDimension() was not invoked, we raise</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// an exception to warn the developer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PFLAG_MEASURED_DIMENSION_SET</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>PFLAG_MEASURED_DIMENSION_SET</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;View with id &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>getId</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;#onMeasure() did not set the&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; measured dimension by calling&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; setMeasuredDimension()&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mOldWidthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mOldHeightMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mMeasureCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=w> </span><span class=n>mMeasuredWidth</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>32</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=w> </span><span class=n>mMeasuredHeight</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>0xffffffffL</span><span class=p>);</span><span class=w> </span><span class=c1>// suppress sign extension</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * Measure the view and its content to determine the measured width and the
</span></span></span><span class=line><span class=cl><span class=cm>     * measured height. This method is invoked by {@link #measure(int, int)} and
</span></span></span><span class=line><span class=cl><span class=cm>     * should be overridden by subclasses to provide accurate and efficient
</span></span></span><span class=line><span class=cl><span class=cm>     * measurement of their contents.
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;em&gt;must&lt;/em&gt; call {@link #setMeasuredDimension(int, int)} to store the
</span></span></span><span class=line><span class=cl><span class=cm>     * measured width and height of this view. Failure to do so will trigger an
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by
</span></span></span><span class=line><span class=cl><span class=cm>     * {@link #measure(int, int)}. Calling the superclass&#39;
</span></span></span><span class=line><span class=cl><span class=cm>     * {@link #onMeasure(int, int)} is a valid use.
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * The base class implementation of measure defaults to the background size,
</span></span></span><span class=line><span class=cl><span class=cm>     * unless a larger size is allowed by the MeasureSpec. Subclasses should
</span></span></span><span class=line><span class=cl><span class=cm>     * override {@link #onMeasure(int, int)} to provide better measurements of
</span></span></span><span class=line><span class=cl><span class=cm>     * their content.
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * If this method is overridden, it is the subclass&#39;s responsibility to make
</span></span></span><span class=line><span class=cl><span class=cm>     * sure the measured height and width are at least the view&#39;s minimum height
</span></span></span><span class=line><span class=cl><span class=cm>     * and width ({@link #getSuggestedMinimumHeight()} and
</span></span></span><span class=line><span class=cl><span class=cm>     * {@link #getSuggestedMinimumWidth()}).
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param widthMeasureSpec horizontal space requirements as imposed by the parent.
</span></span></span><span class=line><span class=cl><span class=cm>     *                         The requirements are encoded with
</span></span></span><span class=line><span class=cl><span class=cm>     *                         {@link android.view.View.MeasureSpec}.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param heightMeasureSpec vertical space requirements as imposed by the parent.
</span></span></span><span class=line><span class=cl><span class=cm>     *                         The requirements are encoded with
</span></span></span><span class=line><span class=cl><span class=cm>     *                         {@link android.view.View.MeasureSpec}.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @see #getMeasuredWidth()
</span></span></span><span class=line><span class=cl><span class=cm>     * @see #getMeasuredHeight()
</span></span></span><span class=line><span class=cl><span class=cm>     * @see #setMeasuredDimension(int, int)
</span></span></span><span class=line><span class=cl><span class=cm>     * @see #getSuggestedMinimumHeight()
</span></span></span><span class=line><span class=cl><span class=cm>     * @see #getSuggestedMinimumWidth()
</span></span></span><span class=line><span class=cl><span class=cm>     * @see android.view.View.MeasureSpec#getMode(int)
</span></span></span><span class=line><span class=cl><span class=cm>     * @see android.view.View.MeasureSpec#getSize(int)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMeasure</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setMeasuredDimension</span><span class=p>(</span><span class=n>getDefaultSize</span><span class=p>(</span><span class=n>getSuggestedMinimumWidth</span><span class=p>(),</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>getDefaultSize</span><span class=p>(</span><span class=n>getSuggestedMinimumHeight</span><span class=p>(),</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Utility to return a default size. Uses the supplied size if the
</span></span></span><span class=line><span class=cl><span class=cm>     * MeasureSpec imposed no constraints. Will get larger if allowed
</span></span></span><span class=line><span class=cl><span class=cm>     * by the MeasureSpec.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param size Default size for this view
</span></span></span><span class=line><span class=cl><span class=cm>     * @param measureSpec Constraints imposed by the parent
</span></span></span><span class=line><span class=cl><span class=cm>     * @return The size this view should be.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getDefaultSize</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>measureSpec</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>specMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>measureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>specSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>measureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>specMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>specSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>DecorView.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMeasure</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>DisplayMetrics</span><span class=w> </span><span class=n>metrics</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getContext</span><span class=p>().</span><span class=na>getResources</span><span class=p>().</span><span class=na>getDisplayMetrics</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isPortrait</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>getResources</span><span class=p>().</span><span class=na>getConfiguration</span><span class=p>().</span><span class=na>orientation</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ORIENTATION_PORTRAIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>widthMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMode</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>heightMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMode</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>fixedWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mApplyFloatingHorizontalInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>widthMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>AT_MOST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>TypedValue</span><span class=w> </span><span class=n>tvw</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isPortrait</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>mFixedWidthMinor</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>mFixedWidthMajor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tvw</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tvw</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TypedValue</span><span class=p>.</span><span class=na>TYPE_NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>w</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tvw</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TypedValue</span><span class=p>.</span><span class=na>TYPE_DIMENSION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>tvw</span><span class=p>.</span><span class=na>getDimension</span><span class=p>(</span><span class=n>metrics</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tvw</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TypedValue</span><span class=p>.</span><span class=na>TYPE_FRACTION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>tvw</span><span class=p>.</span><span class=na>getFraction</span><span class=p>(</span><span class=n>metrics</span><span class=p>.</span><span class=na>widthPixels</span><span class=p>,</span><span class=w> </span><span class=n>metrics</span><span class=p>.</span><span class=na>widthPixels</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_MEASURE</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>mLogTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Fixed width: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>w</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>widthSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>w</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>widthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>w</span><span class=p>,</span><span class=w> </span><span class=n>widthSize</span><span class=p>),</span><span class=w> </span><span class=n>EXACTLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>fixedWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>widthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>widthSize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mFloatingInsets</span><span class=p>.</span><span class=na>left</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mFloatingInsets</span><span class=p>.</span><span class=na>right</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>AT_MOST</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mApplyFloatingHorizontalInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mApplyFloatingVerticalInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>heightMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>AT_MOST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>TypedValue</span><span class=w> </span><span class=n>tvh</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isPortrait</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>mFixedHeightMajor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>:</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>mFixedHeightMinor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tvh</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tvh</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TypedValue</span><span class=p>.</span><span class=na>TYPE_NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tvh</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TypedValue</span><span class=p>.</span><span class=na>TYPE_DIMENSION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>tvh</span><span class=p>.</span><span class=na>getDimension</span><span class=p>(</span><span class=n>metrics</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tvh</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TypedValue</span><span class=p>.</span><span class=na>TYPE_FRACTION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>tvh</span><span class=p>.</span><span class=na>getFraction</span><span class=p>(</span><span class=n>metrics</span><span class=p>.</span><span class=na>heightPixels</span><span class=p>,</span><span class=w> </span><span class=n>metrics</span><span class=p>.</span><span class=na>heightPixels</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_MEASURE</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>mLogTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Fixed height: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>heightSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>heightMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>heightSize</span><span class=p>),</span><span class=w> </span><span class=n>EXACTLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>mWindow</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>().</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>FLAG_LAYOUT_IN_SCREEN</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>heightMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>heightSize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mFloatingInsets</span><span class=p>.</span><span class=na>top</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mFloatingInsets</span><span class=p>.</span><span class=na>bottom</span><span class=p>,</span><span class=w> </span><span class=n>AT_MOST</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mApplyFloatingVerticalInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>getOutsets</span><span class=p>(</span><span class=n>mOutsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mOutsets</span><span class=p>.</span><span class=na>top</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mOutsets</span><span class=p>.</span><span class=na>bottom</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>heightMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>height</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mOutsets</span><span class=p>.</span><span class=na>top</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mOutsets</span><span class=p>.</span><span class=na>bottom</span><span class=p>,</span><span class=w> </span><span class=n>mode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mOutsets</span><span class=p>.</span><span class=na>left</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mOutsets</span><span class=p>.</span><span class=na>right</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>widthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>width</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mOutsets</span><span class=p>.</span><span class=na>left</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mOutsets</span><span class=p>.</span><span class=na>right</span><span class=p>,</span><span class=w> </span><span class=n>mode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onMeasure</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMeasuredWidth</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>measure</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>widthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>EXACTLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>fixedWidth</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>widthMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>AT_MOST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>TypedValue</span><span class=w> </span><span class=n>tv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isPortrait</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>mMinWidthMinor</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>mWindow</span><span class=p>.</span><span class=na>mMinWidthMajor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tv</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>TypedValue</span><span class=p>.</span><span class=na>TYPE_NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>min</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tv</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TypedValue</span><span class=p>.</span><span class=na>TYPE_DIMENSION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>min</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>tv</span><span class=p>.</span><span class=na>getDimension</span><span class=p>(</span><span class=n>metrics</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tv</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TypedValue</span><span class=p>.</span><span class=na>TYPE_FRACTION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>min</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>tv</span><span class=p>.</span><span class=na>getFraction</span><span class=p>(</span><span class=n>mAvailableWidth</span><span class=p>,</span><span class=w> </span><span class=n>mAvailableWidth</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>min</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_MEASURE</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>mLogTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Adjust for min width: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>min</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, value::&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>tv</span><span class=p>.</span><span class=na>coerceToString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, mAvailableWidth=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mAvailableWidth</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>width</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>min</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>widthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>min</span><span class=p>,</span><span class=w> </span><span class=n>EXACTLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>measure</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// TODO: Support height?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>measure</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>.</span><span class=na>onMeasure</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>FrameLayout.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMeasure</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getChildCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>measureMatchParentChildren</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mMatchParentChildren</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>maxHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>maxWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>childState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>child</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getChildAt</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mMeasureAllChildren</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>child</span><span class=p>.</span><span class=na>getVisibility</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>GONE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>measureChildWithMargins</span><span class=p>(</span><span class=n>child</span><span class=p>,</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>LayoutParams</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>LayoutParams</span><span class=p>)</span><span class=w> </span><span class=n>child</span><span class=p>.</span><span class=na>getLayoutParams</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>maxWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>maxWidth</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>child</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>leftMargin</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>rightMargin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>maxHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>maxHeight</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>child</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>topMargin</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>bottomMargin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>childState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>combineMeasuredStates</span><span class=p>(</span><span class=n>childState</span><span class=p>,</span><span class=w> </span><span class=n>child</span><span class=p>.</span><span class=na>getMeasuredState</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>measureMatchParentChildren</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lp</span><span class=p>.</span><span class=na>width</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>lp</span><span class=p>.</span><span class=na>height</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mMatchParentChildren</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>child</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Account for padding too</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>maxWidth</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>getPaddingLeftWithForeground</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>getPaddingRightWithForeground</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>maxHeight</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>getPaddingTopWithForeground</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>getPaddingBottomWithForeground</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Check against our minimum height and width</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>maxHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>maxHeight</span><span class=p>,</span><span class=w> </span><span class=n>getSuggestedMinimumHeight</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>maxWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>maxWidth</span><span class=p>,</span><span class=w> </span><span class=n>getSuggestedMinimumWidth</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Check against our foreground&#39;s minimum height and width</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Drawable</span><span class=w> </span><span class=n>drawable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getForeground</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>drawable</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>maxHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>maxHeight</span><span class=p>,</span><span class=w> </span><span class=n>drawable</span><span class=p>.</span><span class=na>getMinimumHeight</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>maxWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>maxWidth</span><span class=p>,</span><span class=w> </span><span class=n>drawable</span><span class=p>.</span><span class=na>getMinimumWidth</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setMeasuredDimension</span><span class=p>(</span><span class=n>resolveSizeAndState</span><span class=p>(</span><span class=n>maxWidth</span><span class=p>,</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>childState</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resolveSizeAndState</span><span class=p>(</span><span class=n>maxHeight</span><span class=p>,</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>childState</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>MEASURED_HEIGHT_STATE_SHIFT</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mMatchParentChildren</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>child</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mMatchParentChildren</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>MarginLayoutParams</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MarginLayoutParams</span><span class=p>)</span><span class=w> </span><span class=n>child</span><span class=p>.</span><span class=na>getLayoutParams</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>childWidthMeasureSpec</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lp</span><span class=p>.</span><span class=na>width</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>getMeasuredWidth</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>-</span><span class=w> </span><span class=n>getPaddingLeftWithForeground</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>getPaddingRightWithForeground</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>-</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>leftMargin</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>rightMargin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>childWidthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>childWidthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getChildMeasureSpec</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>getPaddingLeftWithForeground</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>getPaddingRightWithForeground</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>lp</span><span class=p>.</span><span class=na>leftMargin</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>rightMargin</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>lp</span><span class=p>.</span><span class=na>width</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lp</span><span class=p>.</span><span class=na>height</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>getMeasuredHeight</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>-</span><span class=w> </span><span class=n>getPaddingTopWithForeground</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>getPaddingBottomWithForeground</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>-</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>topMargin</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>bottomMargin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>childHeightMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>childHeightMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getChildMeasureSpec</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>getPaddingTopWithForeground</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>getPaddingBottomWithForeground</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>lp</span><span class=p>.</span><span class=na>topMargin</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>bottomMargin</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>lp</span><span class=p>.</span><span class=na>height</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>child</span><span class=p>.</span><span class=na>measure</span><span class=p>(</span><span class=n>childWidthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ViewGroup.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Ask one of the children of this view to measure itself, taking into
</span></span></span><span class=line><span class=cl><span class=cm>     * account both the MeasureSpec requirements for this view and its padding
</span></span></span><span class=line><span class=cl><span class=cm>     * and margins. The child must have MarginLayoutParams The heavy lifting is
</span></span></span><span class=line><span class=cl><span class=cm>     * done in getChildMeasureSpec.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param child The child to measure
</span></span></span><span class=line><span class=cl><span class=cm>     * @param parentWidthMeasureSpec The width requirements for this view
</span></span></span><span class=line><span class=cl><span class=cm>     * @param widthUsed Extra space that has been used up by the parent
</span></span></span><span class=line><span class=cl><span class=cm>     *        horizontally (possibly by other children of the parent)
</span></span></span><span class=line><span class=cl><span class=cm>     * @param parentHeightMeasureSpec The height requirements for this view
</span></span></span><span class=line><span class=cl><span class=cm>     * @param heightUsed Extra space that has been used up by the parent
</span></span></span><span class=line><span class=cl><span class=cm>     *        vertically (possibly by other children of the parent)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>measureChildWithMargins</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>child</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>parentWidthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>widthUsed</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>parentHeightMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>heightUsed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>MarginLayoutParams</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MarginLayoutParams</span><span class=p>)</span><span class=w> </span><span class=n>child</span><span class=p>.</span><span class=na>getLayoutParams</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>childWidthMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getChildMeasureSpec</span><span class=p>(</span><span class=n>parentWidthMeasureSpec</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPaddingLeft</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mPaddingRight</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>leftMargin</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>rightMargin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>widthUsed</span><span class=p>,</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>width</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getChildMeasureSpec</span><span class=p>(</span><span class=n>parentHeightMeasureSpec</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPaddingTop</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mPaddingBottom</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>topMargin</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>bottomMargin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>heightUsed</span><span class=p>,</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>height</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>child</span><span class=p>.</span><span class=na>measure</span><span class=p>(</span><span class=n>childWidthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Does the hard part of measureChildren: figuring out the MeasureSpec to
</span></span></span><span class=line><span class=cl><span class=cm>     * pass to a particular child. This method figures out the right MeasureSpec
</span></span></span><span class=line><span class=cl><span class=cm>     * for one dimension (height or width) of one child view.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * The goal is to combine information from our MeasureSpec with the
</span></span></span><span class=line><span class=cl><span class=cm>     * LayoutParams of the child to get the best possible results. For example,
</span></span></span><span class=line><span class=cl><span class=cm>     * if the this view knows its size (because its MeasureSpec has a mode of
</span></span></span><span class=line><span class=cl><span class=cm>     * EXACTLY), and the child has indicated in its LayoutParams that it wants
</span></span></span><span class=line><span class=cl><span class=cm>     * to be the same size as the parent, the parent should ask the child to
</span></span></span><span class=line><span class=cl><span class=cm>     * layout given an exact size.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param spec The requirements for this view
</span></span></span><span class=line><span class=cl><span class=cm>     * @param padding The padding of this view for the current dimension and
</span></span></span><span class=line><span class=cl><span class=cm>     *        margins, if applicable
</span></span></span><span class=line><span class=cl><span class=cm>     * @param childDimension How big the child wants to be in the current
</span></span></span><span class=line><span class=cl><span class=cm>     *        dimension
</span></span></span><span class=line><span class=cl><span class=cm>     * @return a MeasureSpec integer for the child
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getChildMeasureSpec</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>spec</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>padding</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>childDimension</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>specMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>spec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>specSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>spec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>specSize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>padding</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>resultSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>resultMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>specMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Parent has imposed an exact size on us</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>childDimension</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>childDimension</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>childDimension</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Child wants to be our size. So be it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>childDimension</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Child wants to determine its own size. It can&#39;t be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// bigger than us.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Parent has imposed a maximum size on us</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>childDimension</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Child wants a specific size... so be it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>childDimension</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>childDimension</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Child wants to be our size, but our size is not fixed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Constrain child to not be bigger than us.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>childDimension</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Child wants to determine its own size. It can&#39;t be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// bigger than us.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Parent asked to see how big we want to be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>childDimension</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Child wants a specific size... let him have it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>childDimension</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>EXACTLY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>childDimension</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>MATCH_PARENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Child wants to be our size... find out how big it should</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>sUseZeroUnspecifiedMeasureSpec</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>childDimension</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LayoutParams</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Child wants to determine its own size.... find out how</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// big it should be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>sUseZeroUnspecifiedMeasureSpec</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>UNSPECIFIED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//noinspection ResourceType</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>makeMeasureSpec</span><span class=p>(</span><span class=n>resultSize</span><span class=p>,</span><span class=w> </span><span class=n>resultMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=布局>布局<a hidden class=anchor aria-hidden=true href=#布局>#</a></h3><p>在ViewRootImpl的<code>performLayout()</code>方法中调用了DecorView的<code>layout()</code>方法，DecorView未重写FrameLayout的这一方法：
FrameLayout.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>layout</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mSuppressLayout</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>mTransition</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>mTransition</span><span class=p>.</span><span class=na>isChangingLayout</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mTransition</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mTransition</span><span class=p>.</span><span class=na>layoutChange</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>.</span><span class=na>layout</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// record the fact that we noop&#39;d it; request layout when transition finishes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mLayoutCalledWhileSuppressed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>View.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Assign a size and position to a view and all of its
</span></span></span><span class=line><span class=cl><span class=cm>     * descendants
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;This is the second phase of the layout mechanism.
</span></span></span><span class=line><span class=cl><span class=cm>     * (The first is measuring). In this phase, each parent calls
</span></span></span><span class=line><span class=cl><span class=cm>     * layout on all of its children to position them.
</span></span></span><span class=line><span class=cl><span class=cm>     * This is typically done using the child measurements
</span></span></span><span class=line><span class=cl><span class=cm>     * that were stored in the measure pass().&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;Derived classes should not override this method.
</span></span></span><span class=line><span class=cl><span class=cm>     * Derived classes with children should override
</span></span></span><span class=line><span class=cl><span class=cm>     * onLayout. In that method, they should
</span></span></span><span class=line><span class=cl><span class=cm>     * call layout on each of their children.&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param l Left position, relative to parent
</span></span></span><span class=line><span class=cl><span class=cm>     * @param t Top position, relative to parent
</span></span></span><span class=line><span class=cl><span class=cm>     * @param r Right position, relative to parent
</span></span></span><span class=line><span class=cl><span class=cm>     * @param b Bottom position, relative to parent
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@SuppressWarnings</span><span class=p>({</span><span class=s>&#34;unchecked&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>layout</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>mPrivateFlags3</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>onMeasure</span><span class=p>(</span><span class=n>mOldWidthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>mOldHeightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPrivateFlags3</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mLeft</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mTop</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mBottom</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRight</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>changed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isLayoutModeOptical</span><span class=p>(</span><span class=n>mParent</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setOpticalFrame</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>setFrame</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>changed</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>onLayout</span><span class=p>(</span><span class=n>changed</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldDrawRoundScrollbar</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>mRoundScrollbarRenderer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mRoundScrollbarRenderer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RoundScrollbarRenderer</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mRoundScrollbarRenderer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PFLAG_LAYOUT_REQUIRED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ListenerInfo</span><span class=w> </span><span class=n>li</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mListenerInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>li</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>li</span><span class=p>.</span><span class=na>mOnLayoutChangeListeners</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>OnLayoutChangeListener</span><span class=o>&gt;</span><span class=w> </span><span class=n>listenersCopy</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>OnLayoutChangeListener</span><span class=o>&gt;</span><span class=p>)</span><span class=n>li</span><span class=p>.</span><span class=na>mOnLayoutChangeListeners</span><span class=p>.</span><span class=na>clone</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>numListeners</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>listenersCopy</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>numListeners</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>listenersCopy</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>onLayoutChange</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>oldL</span><span class=p>,</span><span class=w> </span><span class=n>oldT</span><span class=p>,</span><span class=w> </span><span class=n>oldR</span><span class=p>,</span><span class=w> </span><span class=n>oldB</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PFLAG_FORCE_LAYOUT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mPrivateFlags3</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PFLAG3_IS_LAID_OUT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>mPrivateFlags3</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PFLAG3_NOTIFY_AUTOFILL_ENTER_ON_LAYOUT</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPrivateFlags3</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PFLAG3_NOTIFY_AUTOFILL_ENTER_ON_LAYOUT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>notifyEnterOrExitForAutoFillIfNeeded</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>DecorView.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onLayout</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>changed</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>bottom</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onLayout</span><span class=p>(</span><span class=n>changed</span><span class=p>,</span><span class=w> </span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>getOutsets</span><span class=p>(</span><span class=n>mOutsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mOutsets</span><span class=p>.</span><span class=na>left</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>offsetLeftAndRight</span><span class=p>(</span><span class=o>-</span><span class=n>mOutsets</span><span class=p>.</span><span class=na>left</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mOutsets</span><span class=p>.</span><span class=na>top</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>offsetTopAndBottom</span><span class=p>(</span><span class=o>-</span><span class=n>mOutsets</span><span class=p>.</span><span class=na>top</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mApplyFloatingVerticalInsets</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>offsetTopAndBottom</span><span class=p>(</span><span class=n>mFloatingInsets</span><span class=p>.</span><span class=na>top</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mApplyFloatingHorizontalInsets</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>offsetLeftAndRight</span><span class=p>(</span><span class=n>mFloatingInsets</span><span class=p>.</span><span class=na>left</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If the application changed its SystemUI metrics, we might also have to adapt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// our shadow elevation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>updateElevation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mAllowUpdateElevation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>changed</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mResizeMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>RESIZE_MODE_DOCKED_DIVIDER</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>getViewRootImpl</span><span class=p>().</span><span class=na>requestInvalidateRootRenderNode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>FrameLayout.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onLayout</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>changed</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>bottom</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>layoutChildren</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/* no force left gravity */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>layoutChildren</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>bottom</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>forceLeftGravity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getChildCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>parentLeft</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getPaddingLeftWithForeground</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>parentRight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>right</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>left</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>getPaddingRightWithForeground</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>parentTop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getPaddingTopWithForeground</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>parentBottom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bottom</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>getPaddingBottomWithForeground</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>child</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getChildAt</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>child</span><span class=p>.</span><span class=na>getVisibility</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>GONE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>LayoutParams</span><span class=w> </span><span class=n>lp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>LayoutParams</span><span class=p>)</span><span class=w> </span><span class=n>child</span><span class=p>.</span><span class=na>getLayoutParams</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>child</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>child</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>childLeft</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>childTop</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>gravity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>gravity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gravity</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>gravity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DEFAULT_CHILD_GRAVITY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>layoutDirection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLayoutDirection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>absoluteGravity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>getAbsoluteGravity</span><span class=p>(</span><span class=n>gravity</span><span class=p>,</span><span class=w> </span><span class=n>layoutDirection</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>verticalGravity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>gravity</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>VERTICAL_GRAVITY_MASK</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>absoluteGravity</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>HORIZONTAL_GRAVITY_MASK</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>case</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>CENTER_HORIZONTAL</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>childLeft</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parentLeft</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>parentRight</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>parentLeft</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>width</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>2</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lp</span><span class=p>.</span><span class=na>leftMargin</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>rightMargin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>case</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>RIGHT</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>forceLeftGravity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>childLeft</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parentRight</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>rightMargin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>case</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>LEFT</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>childLeft</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parentLeft</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>leftMargin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>verticalGravity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>case</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>TOP</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>childTop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parentTop</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>topMargin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>case</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>CENTER_VERTICAL</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>childTop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parentTop</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>parentBottom</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>parentTop</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>height</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>2</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>lp</span><span class=p>.</span><span class=na>topMargin</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>bottomMargin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>case</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>BOTTOM</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>childTop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parentBottom</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>height</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>bottomMargin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>childTop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parentTop</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lp</span><span class=p>.</span><span class=na>topMargin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>child</span><span class=p>.</span><span class=na>layout</span><span class=p>(</span><span class=n>childLeft</span><span class=p>,</span><span class=w> </span><span class=n>childTop</span><span class=p>,</span><span class=w> </span><span class=n>childLeft</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>childTop</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>height</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=绘制>绘制<a hidden class=anchor aria-hidden=true href=#绘制>#</a></h3><p>ViewRootImpl在<code>performDraw()</code>方法中调用<code>draw()</code>方法，
ViewRootImpl.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>draw</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>fullRedrawNeeded</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Surface</span><span class=w> </span><span class=n>surface</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSurface</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>surface</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_FPS</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>trackFPS</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>sFirstDrawComplete</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>sFirstDrawHandlers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sFirstDrawComplete</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sFirstDrawHandlers</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>&lt;</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mHandler</span><span class=p>.</span><span class=na>post</span><span class=p>(</span><span class=n>sFirstDrawHandlers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>scrollToRectOrFocus</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mViewScrollChanged</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mViewScrollChanged</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTreeObserver</span><span class=p>.</span><span class=na>dispatchOnScrollChanged</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>animating</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mScroller</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mScroller</span><span class=p>.</span><span class=na>computeScrollOffset</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>curScrollY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>animating</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>curScrollY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mScroller</span><span class=p>.</span><span class=na>getCurrY</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>curScrollY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mScrollY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mCurScrollY</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>curScrollY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mCurScrollY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>curScrollY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mView</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>RootViewSurfaceTaker</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>((</span><span class=n>RootViewSurfaceTaker</span><span class=p>)</span><span class=w> </span><span class=n>mView</span><span class=p>).</span><span class=na>onRootViewScrollYChanged</span><span class=p>(</span><span class=n>mCurScrollY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>appScale</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mApplicationScale</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>scalingRequired</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mScalingRequired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>resizeAlpha</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>dirty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mDirty</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSurfaceHolder</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// The app owns the surface, we won&#39;t draw.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dirty</span><span class=p>.</span><span class=na>setEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>animating</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mScroller</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mScroller</span><span class=p>.</span><span class=na>abortAnimation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fullRedrawNeeded</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mIgnoreDirtyState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dirty</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>mWidth</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>appScale</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>5f</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>mHeight</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>appScale</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>5f</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_ORIENTATION</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>DEBUG_DRAW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>mTag</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Draw &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mView</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;/&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>.</span><span class=na>getTitle</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: dirty={&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>dirty</span><span class=p>.</span><span class=na>left</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;,&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>dirty</span><span class=p>.</span><span class=na>top</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;,&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>dirty</span><span class=p>.</span><span class=na>right</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;,&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>dirty</span><span class=p>.</span><span class=na>bottom</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;} surface=&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=n>surface</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; surface.isValid()=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>surface</span><span class=p>.</span><span class=na>isValid</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, appScale:&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>appScale</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, width=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mWidth</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, height=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTreeObserver</span><span class=p>.</span><span class=na>dispatchOnDraw</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>xOffset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>mCanvasOffsetX</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>yOffset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>mCanvasOffsetY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>curScrollY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mWindowAttributes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>surfaceInsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>params</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>params</span><span class=p>.</span><span class=na>surfaceInsets</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>surfaceInsets</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>xOffset</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>surfaceInsets</span><span class=p>.</span><span class=na>left</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>yOffset</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>surfaceInsets</span><span class=p>.</span><span class=na>top</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Offset dirty rect for surface insets.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dirty</span><span class=p>.</span><span class=na>offset</span><span class=p>(</span><span class=n>surfaceInsets</span><span class=p>.</span><span class=na>left</span><span class=p>,</span><span class=w> </span><span class=n>surfaceInsets</span><span class=p>.</span><span class=na>right</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>accessibilityFocusDirty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Drawable</span><span class=w> </span><span class=n>drawable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mAccessibilityFocusDrawable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>drawable</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>bounds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mTmpInvalRect</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasFocus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getAccessibilityFocusedRect</span><span class=p>(</span><span class=n>bounds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasFocus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>bounds</span><span class=p>.</span><span class=na>setEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>bounds</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>drawable</span><span class=p>.</span><span class=na>getBounds</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>accessibilityFocusDirty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mDrawingTime</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mChoreographer</span><span class=p>.</span><span class=na>getFrameTimeNanos</span><span class=p>()</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>TimeUtils</span><span class=p>.</span><span class=na>NANOS_PER_MS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>dirty</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mIsAnimating</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>accessibilityFocusDirty</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>isEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If accessibility focus moved, always invalidate the root.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>invalidateRoot</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accessibilityFocusDirty</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mInvalidateRootRequested</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInvalidateRootRequested</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Draw with hardware renderer.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mIsAnimating</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mHardwareYOffset</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>yOffset</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mHardwareXOffset</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>xOffset</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mHardwareYOffset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>yOffset</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mHardwareXOffset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>xOffset</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>invalidateRoot</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>invalidateRoot</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>invalidateRoot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>dirty</span><span class=p>.</span><span class=na>setEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Stage the content drawn size now. It will be transferred to the renderer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// shortly before the draw commands get send to the renderer.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>updateContentDrawBounds</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mReportNextDraw</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// report next draw overrides setStopped()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// This value is re-sync&#39;d to the value of mStopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// in the handling of mReportNextDraw post-draw.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>setStopped</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>updated</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>requestDrawWindow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>draw</span><span class=p>(</span><span class=n>mView</span><span class=p>,</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// If we get here with a disabled &amp; requested hardware renderer, something went</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// wrong (an invalidate posted right before we destroyed the hardware surface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// for instance) so we should just bail out. Locking the surface with software</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// rendering at this point would lock it forever and prevent hardware renderer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// from doing its job when it comes back.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Before we request a new frame we must however attempt to reinitiliaze the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// hardware renderer if it&#39;s in requested state. This would happen after an</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// eglTerminate() for instance.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>!</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>isEnabled</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>isRequested</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mThreadedRenderer</span><span class=p>.</span><span class=na>initializeIfNeeded</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>mHeight</span><span class=p>,</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>,</span><span class=w> </span><span class=n>mSurface</span><span class=p>,</span><span class=w> </span><span class=n>surfaceInsets</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>OutOfResourcesException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>handleOutOfResourcesException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mFullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>scheduleTraversals</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>drawSoftware</span><span class=p>(</span><span class=n>surface</span><span class=p>,</span><span class=w> </span><span class=n>mAttachInfo</span><span class=p>,</span><span class=w> </span><span class=n>xOffset</span><span class=p>,</span><span class=w> </span><span class=n>yOffset</span><span class=p>,</span><span class=w> </span><span class=n>scalingRequired</span><span class=p>,</span><span class=w> </span><span class=n>dirty</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>animating</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mFullRedrawNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>scheduleTraversals</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>其中调用<code>mAttachInfo.mThreadedRenderer.draw(mView, mAttachInfo, this)</code>进入视图绘制。
ThreadedRenderer.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Draws the specified view.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param view The view to draw.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param attachInfo AttachInfo tied to the specified view.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param callbacks Callbacks invoked when drawing happens.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>draw</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>AttachInfo</span><span class=w> </span><span class=n>attachInfo</span><span class=p>,</span><span class=w> </span><span class=n>DrawCallbacks</span><span class=w> </span><span class=n>callbacks</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mIgnoreDirtyState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Choreographer</span><span class=w> </span><span class=n>choreographer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mViewRootImpl</span><span class=p>.</span><span class=na>mChoreographer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>choreographer</span><span class=p>.</span><span class=na>mFrameInfo</span><span class=p>.</span><span class=na>markDrawStart</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>updateRootDisplayList</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>callbacks</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mIgnoreDirtyState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// register animating rendernodes which started animating prior to renderer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// creation, which is typical for animators started prior to first draw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mPendingAnimatingRenderNodes</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mPendingAnimatingRenderNodes</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>registerAnimatingRenderNode</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mPendingAnimatingRenderNodes</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mPendingAnimatingRenderNodes</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// We don&#39;t need this anymore as subsequent calls to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ViewRootImpl#attachRenderNodeAnimator will go directly to us.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mPendingAnimatingRenderNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=o>[]</span><span class=w> </span><span class=n>frameInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>choreographer</span><span class=p>.</span><span class=na>mFrameInfo</span><span class=p>.</span><span class=na>mFrameInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>syncResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nSyncAndDrawFrame</span><span class=p>(</span><span class=n>mNativeProxy</span><span class=p>,</span><span class=w> </span><span class=n>frameInfo</span><span class=p>,</span><span class=w> </span><span class=n>frameInfo</span><span class=p>.</span><span class=na>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>syncResult</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>SYNC_LOST_SURFACE_REWARD_IF_FOUND</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setEnabled</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mViewRootImpl</span><span class=p>.</span><span class=na>mSurface</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Invalidate since we failed to draw. This should fetch a Surface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// if it is still needed or do nothing if we are no longer drawing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mViewRootImpl</span><span class=p>.</span><span class=na>invalidate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>syncResult</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>SYNC_INVALIDATE_REQUIRED</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>attachInfo</span><span class=p>.</span><span class=na>mViewRootImpl</span><span class=p>.</span><span class=na>invalidate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateRootDisplayList</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>DrawCallbacks</span><span class=w> </span><span class=n>callbacks</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_VIEW</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Record View#draw()&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>updateViewTreeDisplayList</span><span class=p>(</span><span class=n>view</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mRootNodeNeedsUpdate</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>mRootNode</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DisplayListCanvas</span><span class=w> </span><span class=n>canvas</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRootNode</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>mSurfaceWidth</span><span class=p>,</span><span class=w> </span><span class=n>mSurfaceHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>saveCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>canvas</span><span class=p>.</span><span class=na>save</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>canvas</span><span class=p>.</span><span class=na>translate</span><span class=p>(</span><span class=n>mInsetLeft</span><span class=p>,</span><span class=w> </span><span class=n>mInsetTop</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callbacks</span><span class=p>.</span><span class=na>onPreDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>canvas</span><span class=p>.</span><span class=na>insertReorderBarrier</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>canvas</span><span class=p>.</span><span class=na>drawRenderNode</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>updateDisplayListIfDirty</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>canvas</span><span class=p>.</span><span class=na>insertInorderBarrier</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>callbacks</span><span class=p>.</span><span class=na>onPostDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>canvas</span><span class=p>.</span><span class=na>restoreToCount</span><span class=p>(</span><span class=n>saveCount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mRootNodeNeedsUpdate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mRootNode</span><span class=p>.</span><span class=na>end</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_VIEW</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>canvas.drawRenderNode(view.updateDisplayListIfDirty())</code>
View.java</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Gets the RenderNode for the view, and updates its DisplayList (if needed and supported)
</span></span></span><span class=line><span class=cl><span class=cm>     * @hide
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@NonNull</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RenderNode</span><span class=w> </span><span class=nf>updateDisplayListIfDirty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>RenderNode</span><span class=w> </span><span class=n>renderNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRenderNode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>canHaveDisplayList</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// can&#39;t populate RenderNode, don&#39;t try</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>renderNode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PFLAG_DRAWING_CACHE_VALID</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>renderNode</span><span class=p>.</span><span class=na>isValid</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>mRecreateDisplayList</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Don&#39;t need to recreate the display list, just need to tell our</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// children to restore/recreate theirs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>renderNode</span><span class=p>.</span><span class=na>isValid</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mRecreateDisplayList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PFLAG_DRAWN</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PFLAG_DRAWING_CACHE_VALID</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PFLAG_DIRTY_MASK</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>dispatchGetDisplayList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>renderNode</span><span class=p>;</span><span class=w> </span><span class=c1>// no work needed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If we got here, we&#39;re recreating it. Mark it as such to ensure that</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// we copy in child display lists into ours in drawChild()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mRecreateDisplayList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRight</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mLeft</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mBottom</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mTop</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>layerType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLayerType</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>DisplayListCanvas</span><span class=w> </span><span class=n>canvas</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>renderNode</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>canvas</span><span class=p>.</span><span class=na>setHighContrastText</span><span class=p>(</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mHighContrastText</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>layerType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LAYER_TYPE_SOFTWARE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>buildDrawingCache</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Bitmap</span><span class=w> </span><span class=n>cache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getDrawingCache</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cache</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>canvas</span><span class=p>.</span><span class=na>drawBitmap</span><span class=p>(</span><span class=n>cache</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>mLayerPaint</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>computeScroll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>canvas</span><span class=p>.</span><span class=na>translate</span><span class=p>(</span><span class=o>-</span><span class=n>mScrollX</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>mScrollY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PFLAG_DRAWN</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PFLAG_DRAWING_CACHE_VALID</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PFLAG_DIRTY_MASK</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Fast path for layouts with no backgrounds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PFLAG_SKIP_DRAW</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>PFLAG_SKIP_DRAW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>dispatchDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>drawAutofilledHighlight</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mOverlay</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mOverlay</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mOverlay</span><span class=p>.</span><span class=na>getOverlayView</span><span class=p>().</span><span class=na>draw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>debugDraw</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>debugDrawFocus</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>draw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>renderNode</span><span class=p>.</span><span class=na>end</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>setDisplayListProperties</span><span class=p>(</span><span class=n>renderNode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PFLAG_DRAWN</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PFLAG_DRAWING_CACHE_VALID</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PFLAG_DIRTY_MASK</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>renderNode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Manually render this view (and all of its children) to the given Canvas.
</span></span></span><span class=line><span class=cl><span class=cm>     * The view must have already done a full layout before this function is
</span></span></span><span class=line><span class=cl><span class=cm>     * called.  When implementing a view, implement
</span></span></span><span class=line><span class=cl><span class=cm>     * {@link #onDraw(android.graphics.Canvas)} instead of overriding this method.
</span></span></span><span class=line><span class=cl><span class=cm>     * If you do need to override this method, call the superclass version.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param canvas The Canvas to which the View is rendered.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@CallSuper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>draw</span><span class=p>(</span><span class=n>Canvas</span><span class=w> </span><span class=n>canvas</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>privateFlags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPrivateFlags</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>dirtyOpaque</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>privateFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PFLAG_DIRTY_MASK</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>PFLAG_DIRTY_OPAQUE</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>mAttachInfo</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>mAttachInfo</span><span class=p>.</span><span class=na>mIgnoreDirtyState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mPrivateFlags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>privateFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>~</span><span class=n>PFLAG_DIRTY_MASK</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PFLAG_DRAWN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>         * Draw traversal performs several drawing steps which must be executed
</span></span></span><span class=line><span class=cl><span class=cm>         * in the appropriate order:
</span></span></span><span class=line><span class=cl><span class=cm>         *
</span></span></span><span class=line><span class=cl><span class=cm>         *      1. Draw the background
</span></span></span><span class=line><span class=cl><span class=cm>         *      2. If necessary, save the canvas&#39; layers to prepare for fading
</span></span></span><span class=line><span class=cl><span class=cm>         *      3. Draw view&#39;s content
</span></span></span><span class=line><span class=cl><span class=cm>         *      4. Draw children
</span></span></span><span class=line><span class=cl><span class=cm>         *      5. If necessary, draw the fading edges and restore layers
</span></span></span><span class=line><span class=cl><span class=cm>         *      6. Draw decorations (scrollbars for instance)
</span></span></span><span class=line><span class=cl><span class=cm>         */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Step 1, draw the background, if needed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>saveCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>dirtyOpaque</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>drawBackground</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// skip step 2 &amp; 5 if possible (common case)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>viewFlags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mViewFlags</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>horizontalEdges</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>viewFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>FADING_EDGE_HORIZONTAL</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>verticalEdges</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>viewFlags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>FADING_EDGE_VERTICAL</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>verticalEdges</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>horizontalEdges</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Step 3, draw the content</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>dirtyOpaque</span><span class=p>)</span><span class=w> </span><span class=n>onDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Step 4, draw the children</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dispatchDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>drawAutofilledHighlight</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Overlay is part of the content and draws beneath Foreground</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mOverlay</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mOverlay</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mOverlay</span><span class=p>.</span><span class=na>getOverlayView</span><span class=p>().</span><span class=na>dispatchDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Step 6, draw decorations (foreground, scrollbars)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>onDrawForeground</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Step 7, draw the default focus highlight</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>drawDefaultFocusHighlight</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>debugDraw</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>debugDrawFocus</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// we&#39;re done...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>         * Here we do the full fledged routine...
</span></span></span><span class=line><span class=cl><span class=cm>         * (this is an uncommon case where speed matters less,
</span></span></span><span class=line><span class=cl><span class=cm>         * this is why we repeat some of the tests that have been
</span></span></span><span class=line><span class=cl><span class=cm>         * done above)
</span></span></span><span class=line><span class=cl><span class=cm>         */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>drawTop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>drawBottom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>drawLeft</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>drawRight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>topFadeStrength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>bottomFadeStrength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>leftFadeStrength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>rightFadeStrength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Step 2, save the canvas&#39; layers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>paddingLeft</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPaddingLeft</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>offsetRequired</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isPaddingOffsetRequired</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>offsetRequired</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>paddingLeft</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>getLeftPaddingOffset</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>left</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mScrollX</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>paddingLeft</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>right</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>left</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mRight</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mLeft</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mPaddingRight</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>paddingLeft</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mScrollY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>getFadeTop</span><span class=p>(</span><span class=n>offsetRequired</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>bottom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>getFadeHeight</span><span class=p>(</span><span class=n>offsetRequired</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>offsetRequired</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>right</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>getRightPaddingOffset</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bottom</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>getBottomPaddingOffset</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ScrollabilityCache</span><span class=w> </span><span class=n>scrollabilityCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mScrollCache</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>fadeHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>scrollabilityCache</span><span class=p>.</span><span class=na>fadingEdgeLength</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>fadeHeight</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// clip the fade length if top and bottom fades overlap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// overlapping fades produce odd-looking artifacts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>verticalEdges</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>top</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>bottom</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>length</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>bottom</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>top</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// also clip horizontal fades if necessary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>horizontalEdges</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>left</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>right</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>length</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>right</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>left</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>verticalEdges</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>topFadeStrength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>,</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>,</span><span class=w> </span><span class=n>getTopFadingEdgeStrength</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>drawTop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>topFadeStrength</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>fadeHeight</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bottomFadeStrength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>,</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>,</span><span class=w> </span><span class=n>getBottomFadingEdgeStrength</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>drawBottom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bottomFadeStrength</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>fadeHeight</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>horizontalEdges</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>leftFadeStrength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>,</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>,</span><span class=w> </span><span class=n>getLeftFadingEdgeStrength</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>drawLeft</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>leftFadeStrength</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>fadeHeight</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rightFadeStrength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>,</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>,</span><span class=w> </span><span class=n>getRightFadingEdgeStrength</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>drawRight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rightFadeStrength</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>fadeHeight</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>saveCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>canvas</span><span class=p>.</span><span class=na>getSaveCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>solidColor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getSolidColor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>solidColor</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Canvas</span><span class=p>.</span><span class=na>HAS_ALPHA_LAYER_SAVE_FLAG</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>drawTop</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>canvas</span><span class=p>.</span><span class=na>saveLayer</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>drawBottom</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>canvas</span><span class=p>.</span><span class=na>saveLayer</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>drawLeft</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>canvas</span><span class=p>.</span><span class=na>saveLayer</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=n>left</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>drawRight</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>canvas</span><span class=p>.</span><span class=na>saveLayer</span><span class=p>(</span><span class=n>right</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>scrollabilityCache</span><span class=p>.</span><span class=na>setFadeColor</span><span class=p>(</span><span class=n>solidColor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Step 3, draw the content</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>dirtyOpaque</span><span class=p>)</span><span class=w> </span><span class=n>onDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Step 4, draw the children</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dispatchDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Step 5, draw the fade effect and restore layers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Paint</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>scrollabilityCache</span><span class=p>.</span><span class=na>paint</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Matrix</span><span class=w> </span><span class=n>matrix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>scrollabilityCache</span><span class=p>.</span><span class=na>matrix</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Shader</span><span class=w> </span><span class=n>fade</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>scrollabilityCache</span><span class=p>.</span><span class=na>shader</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>drawTop</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>setScale</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>fadeHeight</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>topFadeStrength</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>postTranslate</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fade</span><span class=p>.</span><span class=na>setLocalMatrix</span><span class=p>(</span><span class=n>matrix</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>p</span><span class=p>.</span><span class=na>setShader</span><span class=p>(</span><span class=n>fade</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>canvas</span><span class=p>.</span><span class=na>drawRect</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>drawBottom</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>setScale</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>fadeHeight</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>bottomFadeStrength</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>postRotate</span><span class=p>(</span><span class=n>180</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>postTranslate</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fade</span><span class=p>.</span><span class=na>setLocalMatrix</span><span class=p>(</span><span class=n>matrix</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>p</span><span class=p>.</span><span class=na>setShader</span><span class=p>(</span><span class=n>fade</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>canvas</span><span class=p>.</span><span class=na>drawRect</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>drawLeft</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>setScale</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>fadeHeight</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>leftFadeStrength</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>postRotate</span><span class=p>(</span><span class=o>-</span><span class=n>90</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>postTranslate</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fade</span><span class=p>.</span><span class=na>setLocalMatrix</span><span class=p>(</span><span class=n>matrix</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>p</span><span class=p>.</span><span class=na>setShader</span><span class=p>(</span><span class=n>fade</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>canvas</span><span class=p>.</span><span class=na>drawRect</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=n>left</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>drawRight</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>setScale</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>fadeHeight</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>rightFadeStrength</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>postRotate</span><span class=p>(</span><span class=n>90</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matrix</span><span class=p>.</span><span class=na>postTranslate</span><span class=p>(</span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fade</span><span class=p>.</span><span class=na>setLocalMatrix</span><span class=p>(</span><span class=n>matrix</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>p</span><span class=p>.</span><span class=na>setShader</span><span class=p>(</span><span class=n>fade</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>canvas</span><span class=p>.</span><span class=na>drawRect</span><span class=p>(</span><span class=n>right</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>bottom</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>canvas</span><span class=p>.</span><span class=na>restoreToCount</span><span class=p>(</span><span class=n>saveCount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>drawAutofilledHighlight</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Overlay is part of the content and draws beneath Foreground</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mOverlay</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>mOverlay</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mOverlay</span><span class=p>.</span><span class=na>getOverlayView</span><span class=p>().</span><span class=na>dispatchDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Step 6, draw decorations (foreground, scrollbars)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>onDrawForeground</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>debugDraw</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>debugDrawFocus</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>参考：</p><ul><li><a href=https://developer.android.com/guide/topics/ui/how-android-draws>How Android Draws Views</a></li></ul></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://epicmars.github.io/>AndroidPi</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 8" fill="currentcolor"><path d="M12 8H0l6-8z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>