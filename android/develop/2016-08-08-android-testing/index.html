<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Android测试驱动开发 | 
    风格与布局
  
</title><meta name="description" content="Android移动应用开发"><meta name="author" content="jastrelax">

<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png " sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0c344b">
<link rel="icon" href="/favicon.ico">




    
        
            <link rel="stylesheet" href="/dist/main.37ab3f61b95417873748.min.css">
        
    




<link rel="canonical" href="https://www.androidpi.com/android/develop/2016-08-08-android-testing/"><meta property="og:title" content="Android测试驱动开发" />
<meta property="og:description" content="使用迭代式开发工作流程 在迭代开发一个功能时，着手编写一个新的测试或者向已有的单元测试中添加用例和断言，测试一开始会失败，是因为功能还未实现。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.androidpi.com/android/develop/2016-08-08-android-testing/" />
<meta property="article:published_time" content="2016-08-08T16:43:22+08:00" />
<meta property="article:modified_time" content="2016-08-08T16:43:22+08:00" />
<meta itemprop="name" content="Android测试驱动开发">
<meta itemprop="description" content="使用迭代式开发工作流程 在迭代开发一个功能时，着手编写一个新的测试或者向已有的单元测试中添加用例和断言，测试一开始会失败，是因为功能还未实现。">
<meta itemprop="datePublished" content="2016-08-08T16:43:22&#43;08:00" />
<meta itemprop="dateModified" content="2016-08-08T16:43:22&#43;08:00" />
<meta itemprop="wordCount" content="3058">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android测试驱动开发"/>
<meta name="twitter:description" content="使用迭代式开发工作流程 在迭代开发一个功能时，着手编写一个新的测试或者向已有的单元测试中添加用例和断言，测试一开始会失败，是因为功能还未实现。"/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand font-weight-bold" href="https://www.androidpi.com/">风格与布局</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="main-menu">
            <ul class="navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/android/">Android</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/blockchain/">Blockchain</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/book/">Books</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/cs/">CS</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/ee/">EE</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/java/">Java</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/puzzles/">Puzzles</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/web/">Web</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/backend/">后端</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/engineering/">工程与架构</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/dev/">开发</a></li>
                
            
            </ul>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    <div class="row">
        <div class="col">
            <article>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="mb-3">Android测试驱动开发</h2>

                        <div class="content">
                            <h2 id="使用迭代式开发工作流程">使用迭代式开发工作流程</h2>
<p>在迭代开发一个功能时，着手编写一个新的测试或者向已有的单元测试中添加用例和断言，测试一开始会失败，是因为功能还未实现。</p>
<p>很重要的一点是在设计新功能时考虑随之出现的责任的单元（units of responsibility），对于每个单元，需要编写相应的单元测试。<strong>测试用例应当耗尽和单元可能进行的所有交互，包括标准交互，无效输入，以及资源不存在的情况</strong>。</p>
<p><img src="/assets/images/android/testing-workflow.png" alt="testing workflow"></p>
<p>图1. 与迭代、测试驱动开发相关的两个循环</p>
<p>整个工作流程中，包含一系列嵌套、迭代循环的流程，其中一个长的、慢的UI测试用于测试代码单元的集成。使用短的、快速的开发循环对单元自身进行测试。</p>
<h2 id="理解测试金字塔">理解测试金字塔</h2>
<p><img src="/assets/images/android/pyramid.png" alt="testing pyramid"></p>
<p>图2. 测试金字塔展示了你的app中的测试套件应该包含的三种类型的测试</p>
<p>分为大中小三种测试：</p>
<ul>
<li>小型测试：指可以独立于生产系统运行的单元测试，它们通常模拟（mock）每个主要组件并且可以在本地机器上快速运行。</li>
<li>中型测试：位于小型测试和大型测试之间的集成测试，它们集成若干组件，可以在模拟器或者真实设备上运行。</li>
<li>大型测试：通过完成一个UI工作流程来运行的集成和UI测试。它们保证关键的终端用户任务（key end-user tasks）在模拟器或真实设备上按照预期工作。</li>
</ul>
<p>尽管小型测试快速并且专注，允许你快速地处理失败，但它们也是低保真（low-fidelity）和独立的（self-contained），即使这些小型测试全部通过，我们也没有信心认为app会如期工作。对于大型测试，这种权衡则是相反的。</p>
<p>由于每种测试具有不同的特性，测试应该涵盖金字塔中的每一层。尽管每种类型的测试比例可能会根据应用的用例有所变化，通常建议这样来划分：<strong>70%小型测试，20%中型测试，10%大型测试</strong>。</p>
<p>关于测试金字塔的更多内容可以看看Google I/O 2017的相关视频<a href="https://www.youtube.com/watch?v=pK7W5npkhho&amp;start=111">Android测试驱动开发</a>的内容。</p>
<h2 id="android中的测试组件">Android中的测试组件</h2>
<p>根据测试类型和位置，Android两种测试类型，它们决定了测试的位置，要么在本地Java虚拟机中运行，要么在硬件设备或者模拟器上运行。</p>
<blockquote>
<h3 id="本地单元测试">本地单元测试</h3>
<p>位于 module-name/src/test/java/。</p>
<p>这些测试在计算机的本地 Java 虚拟机 (JVM) 上运行。 当您的测试没有 Android 框架依赖项或当您可以模拟 Android 框架依赖项时，可以利用这些测试来尽量缩短执行时间。</p>
<p>在运行时，这些测试的执行对象是去掉了所有 final 修饰符的修改版 android.jar。 这样一来，您就可以使用 Mockito 之类的常见模拟库。</p>
</blockquote>
<blockquote>
<h3 id="仪器测试">仪器测试</h3>
<p>位于 module-name/src/androidTest/java/。</p>
<p>这些测试在硬件设备或模拟器上运行。 这些测试有权访问 Instrumentation API，让您可以获取某些信息（例如您要测试的应用的 Context）， 并且允许您通过测试代码来控制受测应用。 可以在编写集成和功能 UI 测试来自动化用户交互时，或者在测试具有模拟对象无法满足的 Android 依赖项时使用这些测试。</p>
<p>由于仪器测试内置于 APK 中（与您的应用 APK 分离），因此它们必须拥有自己的 AndroidManifest.xml 文件。 不过，由于 Gradle 会自动在构建时生成该文件，因此它在您的项目源集中不可见。 您可以在必要时（例如需要为 <code>minSdkVersion</code> 指定其他值或注册测试专用的运行侦听器时）添加自己的清单文件。 构建应用时，Gradle 会将多个清单文件合并成一个清单。</p>
</blockquote>
<p>当然，您也可以通过集成测试框架来扩展测试能力，例如可以集成<a href="https://github.com/mockito/mockito">Mockito</a>在本地单元测试中测试 Android API 调用，以及集成<a href="https://developer.android.com/topic/libraries/testing-support-library/index.html?hl=zh-cn#Espresso">Espresso</a>或<a href="https://developer.android.com/topic/libraries/testing-support-library/index.html?hl=zh-cn#UIAutomator">UI Automator</a>在仪器测试中演练用户交互。</p>
<p>您可以利用<a href="https://developer.android.com/studio/test/espresso-test-recorder.html?hl=zh-cn">Espresso 测试记录器</a>自动生成 Espresso 测试。</p>
<h2 id="小型测试">小型测试</h2>
<ul>
<li><a href="http://robolectric.org/">Robolectric</a>: 如果测试中需要和Android框架进行大量的交互，可以使用这个测试库。它使用Java逻辑存根（logic stubs） 来模拟Android框架。它支持Android平台的如下几个方面：
<ul>
<li>Android 4.1以及更高的版本</li>
<li>Android Gradle 插件2.4以及更新的版本</li>
<li>组件生命周期</li>
<li>事件循环</li>
<li>所有的资源</li>
</ul>
</li>
<li><a href="http://mockito.org/">Mock对象</a>: 通过一个修订版的android.jar来运行测试用例，你可以模拟与app交互的Android框架中的元素。
如果代码包含了对资源的引用或者和Android框架的复杂交互，你应当使用另外的单元测试方法，如Robolectric或者仪器测试。</li>
<li><a href="https://github.com/hamcrest%22">Hamcrest库</a></li>
<li>仪器测试：与本地单元测试相比，用仪器测试要慢得多，除非确实需要在真机或模拟器上运行，你可以采用这种方式。</li>
</ul>
<h2 id="中型测试">中型测试</h2>
<p>完成单元测试后，验证组件在模拟器或者设备上是否运行良好。</p>
<p>它检查app在多个单元上的协作，但不测试整个app。中型测试主要模拟外部依赖的行为，例如service测试，集成测试，封闭UI测试。</p>
<p>通常这部分可以在模拟器或者基于云的测试服务上进行，这样你可以快速改变设备的配置。</p>
<h2 id="大型测试">大型测试</h2>
<p>测试涉及整个应用栈的常用的流程和用例，从UI到业务逻辑再到数据层。</p>
<p><a href="https://developer.android.com/reference/android/support/test/runner/AndroidJUnitRunner.html?hl=zh-cn">AndroidJUnitRunner</a> 类定义了基于仪器的<a href="http://junit.org/junit4/">JUnit</a> 运行器，可以在Android设备上运行JUnit3或JUnit4样式的测试类，此外它还支持Android测试支持库(ATSL)所提供的以下工具和框架：</p>
<ul>
<li>JUnit4规则：ATSL提供了管理关键app组件生命周期的代码，例如activities和services，可以在<a href="https://developer.android.com/training/testing/junit-rules.html?hl=zh-cn">JUnit4规则</a>查看。</li>
<li>Espresso：自动化UI测试</li>
<li>UI Automator</li>
<li>Android Test Orchestrator</li>
</ul>
<h2 id="应用架构与测试">应用架构与测试</h2>
<p><img src="/assets/images/android/final-architecture.png" alt="final-architecture">
图3 Android应用架构指南中建议的App架构</p>
<p>一个易于测试的架构也正好符合测试金字塔的分层架构，根据Android应用架构指南，架构分层与测试金字塔分层的关系如下：</p>
<ul>
<li>
<p>数据层：如本地Model和远程数据源适用小型单元测试。</p>
<ul>
<li>数据库的测试可以采用仪器测试。</li>
<li>为了保证测试尽量在本地进行，远程数据测试可以采用mock的服务器，这样可以完全控制请求返回的数据。实际中为了反映后端可能存在的问题，也会使用测试服进行测试，这样做似乎可以理解，因为团队可能不够大，各部分的职责可能没有划分的那么清晰。但一个重要的经验是<strong>客户端不应当信任服务端的数据</strong>，并且服务端也不会为客户端编写单元测试用例。因此要覆盖要测试的单元的各种可能的交互，测试最好在本地进行，不依赖于其它外部的资源。</li>
</ul>
<p>几个可用的本地Mock服务可以这样搭建：</p>
<ol>
<li><a href="https://github.com/NanoHttpd/nanohttpd">nanohttpd</a></li>
<li><a href="https://github.com/square/okhttp/tree/master/mockwebserver">MockWebServer</a></li>
<li><a href="https://github.com/square/retrofit/tree/master/retrofit-mock">MockRetrofit</a></li>
<li>运行本地Http服务</li>
</ol>
</li>
</ul>
<p>其中MockRetrofit适用于Repository层的测试，它仅返回接口所返回的数据，不能改变Http消息体。如果已经使用了Retrofit这样的Http库，为了方便将测试从本地转移到远程，可以采用MockWebServer或者nanohttpd这样的本地Http服务的方式，还可以使用其它脚本语言，如python，nodejs，基本上几行脚本就可以搞定了，都是直接使用基本Socket库实现的，这样包括响应数据和响应的行为都可以测到。</p>
<ul>
<li>
<p>对于数据层的Repository接口：根据业务复杂情况，适用小型或者中型本地单元测试。Repository依赖于本地Model和远程数据单元，因为已经为本地Model和远程数据交互进行过测试了，这里不用再重复这一过程，直接使用Mock的单元就可以了。</p>
</li>
<li>
<p>ViewModel层：这一部分也是无关UI的，但包含了较为复杂的业务逻辑，但每个模块仍然可以独立测试，适用中型测试。同测试Repository一样，沿用这种分层的特点，<strong>保持测试的局部性，对于底层的依赖采用Mock的对象来进行</strong>，这里可以使用Mock的Repository对象采用本地单元测试方法来进行。</p>
</li>
<li>
<p>对于UI的测试：也是与大量业务和复杂的用户交互相关的，适用大型测试，由于是与平台相关的，采用仪器测试方法。</p>
</li>
</ul>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://developer.android.com/training/testing/fundamentals.html">Android测试基础</a></li>
<li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#testing">Android架构指南</a></li>
<li><a href="https://developer.android.com/studio/test/index.html?hl=zh-cn">Android Studio 测试应用</a></li>
<li><a href="https://codelabs.developers.google.com/codelabs/android-testing/index.html#0">Android Testing Codelab</a></li>
</ul>

                        </div>
                    </div>
                </div>
            </article>
        </div>
    </div>
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    
                </ul>

                <p class="text-muted">
                    
                        Copyright &copy; 风格与布局 2020
                    
                </p>

                <p class="text-muted">
                Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with <a href="https://github.com/puresyntax71/hugo-theme-chunky-poster" target="_blank">Chunky Poster</a>.
                </p>

                <p class="text-muted">
                    <a href="http://beian.miit.gov.cn" target="_blank">蜀ICP备18005659号-1</a>
                </p>
            
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.d608eadfe5ac0688902e.min.js"></script>
        
    








    
</body>
</html>
