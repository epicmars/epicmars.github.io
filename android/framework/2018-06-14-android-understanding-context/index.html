<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" >
        <meta lang="zh">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>源码分析：理解Context | androidpi</title>
<meta name="description" content="Context一般翻译为上下文，它提供了一个应用环境的全局接口，用于访问指定应用的资源和类，以及各种应用级别的操作，如启动Activitie">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/solid.css" integrity="sha384-TbilV5Lbhlwdyc4RuIV/JhD8NR+BfMrvz4BL5QFa2we1hQu6wvREr3v6XSRfCTRp" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/brands.css" integrity="sha384-7xAnn7Zm3QC1jFjVc1A6v/toepoG3JXboQYzbM0jrPzou9OFXm/fY6Z/XiIebl/k" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/fontawesome.css" integrity="sha384-ozJwkrqb90Oa3ZNb+yKFW2lToAWYdTiF1vt8JiH5ptTGHTGcN7qdoR1F95e0kYyG" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
        
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="/css/article.css" />

    </head>

    <body>
        <div class="site-wrapper">
                <header>
    <nav>
        <a class="home" href="https://www.androidpi.com/">首页</a>
    </nav>
    
</header>
                <div class="site-main">
                    
    <div class="main">
        <div class="article">
            <aside>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#application的context">Application的Context</a></li>
    <li><a href="#activity的context">Activity的Context</a></li>
    <li><a href="#view的context">View的Context</a></li>
    <li><a href="#viewgetcontext是否可以直接转型为activity">View.getContext()是否可以直接转型为Activity</a></li>
  </ul>
</nav>
            </aside>
            <article>
                <div class="title">
                    <h1 id="title">源码分析：理解Context</h1>
                </div>
                <div class="content">
                        <p>Context一般翻译为上下文，它提供了一个应用环境的全局接口，用于访问指定应用的资源和类，以及各种应用级别的操作，如启动Activities与Service、发送广播与注册广播接收器、接收Intents、获取系统服务等等。</p>
<h2 id="application的context">Application的Context</h2>
<p>ActivityThread.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    ActivityThread thread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ActivityThread<span style="color:#f92672">();</span>
    thread<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> system<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>system<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> IActivityManager mgr <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                mgr<span style="color:#f92672">.</span><span style="color:#a6e22e">attachApplication</span><span style="color:#f92672">(</span>mAppThread<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> ex<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>ActivityManagerService.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">attachApplication</span><span style="color:#f92672">(</span>IApplicationThread thread<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> callingPid <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallingPid</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> origId <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">clearCallingIdentity</span><span style="color:#f92672">();</span>
            attachApplicationLocked<span style="color:#f92672">(</span>thread<span style="color:#f92672">,</span> callingPid<span style="color:#f92672">);</span>
            Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">restoreCallingIdentity</span><span style="color:#f92672">(</span>origId<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">attachApplicationLocked</span><span style="color:#f92672">(</span>IApplicationThread thread<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">int</span> pid<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                thread<span style="color:#f92672">.</span><span style="color:#a6e22e">bindApplication</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">,</span> appInfo<span style="color:#f92672">,</span> providers<span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mClass</span><span style="color:#f92672">,</span>
                        profilerInfo<span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mArguments</span><span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mWatcher</span><span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mUiAutomationConnection</span><span style="color:#f92672">,</span> testMode<span style="color:#f92672">,</span>
                        mBinderTransactionTrackingEnabled<span style="color:#f92672">,</span> enableTrackAllocation<span style="color:#f92672">,</span>
                        isRestrictedBackupMode <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>normalMode<span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">persistent</span><span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">new</span> Configuration<span style="color:#f92672">(</span>getGlobalConfiguration<span style="color:#f92672">()),</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">compat</span><span style="color:#f92672">,</span>
                        getCommonServicesLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">isolated</span><span style="color:#f92672">),</span>
                        mCoreSettingsObserver<span style="color:#f92672">.</span><span style="color:#a6e22e">getCoreSettingsLocked</span><span style="color:#f92672">(),</span>
                        buildSerial<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                thread<span style="color:#f92672">.</span><span style="color:#a6e22e">bindApplication</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">,</span> appInfo<span style="color:#f92672">,</span> providers<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> profilerInfo<span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> testMode<span style="color:#f92672">,</span>
                        mBinderTransactionTrackingEnabled<span style="color:#f92672">,</span> enableTrackAllocation<span style="color:#f92672">,</span>
                        isRestrictedBackupMode <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>normalMode<span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">persistent</span><span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">new</span> Configuration<span style="color:#f92672">(</span>getGlobalConfiguration<span style="color:#f92672">()),</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">compat</span><span style="color:#f92672">,</span>
                        getCommonServicesLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">isolated</span><span style="color:#f92672">),</span>
                        mCoreSettingsObserver<span style="color:#f92672">.</span><span style="color:#a6e22e">getCoreSettingsLocked</span><span style="color:#f92672">(),</span>
                        buildSerial<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</code></pre></div><p>ActivityThread.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleBindApplication</span><span style="color:#f92672">(</span>AppBindData data<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> ContextImpl appContext <span style="color:#f92672">=</span> ContextImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">createAppContext</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">loadedApk</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If the app is being launched for full backup or restore, bring it up in
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// a restricted environment with the base application class.
</span><span style="color:#75715e"></span>            app <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">loadedApk</span><span style="color:#f92672">.</span><span style="color:#a6e22e">makeApplication</span><span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">restrictedBackupMode</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            mInitialApplication <span style="color:#f92672">=</span> app<span style="color:#f92672">;</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</code></pre></div><p>LoadedApk.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> Application <span style="color:#a6e22e">makeApplication</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> forceDefaultAppClass<span style="color:#f92672">,</span>
            Instrumentation instrumentation<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mApplication <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> mApplication<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;makeApplication&#34;</span><span style="color:#f92672">);</span>

        Application app <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        String appClass <span style="color:#f92672">=</span> mApplicationInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">className</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>forceDefaultAppClass <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>appClass <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            appClass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;android.app.Application&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ClassLoader</span> cl <span style="color:#f92672">=</span> getClassLoader<span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mPackageName<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;android&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;initializeJavaContextClassLoader&#34;</span><span style="color:#f92672">);</span>
                initializeJavaContextClassLoader<span style="color:#f92672">();</span>
                Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            ContextImpl appContext <span style="color:#f92672">=</span> ContextImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">createAppContext</span><span style="color:#f92672">(</span>mActivityThread<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
            app <span style="color:#f92672">=</span> mActivityThread<span style="color:#f92672">.</span><span style="color:#a6e22e">mInstrumentation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">newApplication</span><span style="color:#f92672">(</span>
                    cl<span style="color:#f92672">,</span> appClass<span style="color:#f92672">,</span> appContext<span style="color:#f92672">);</span>
            appContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setOuterContext</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mActivityThread<span style="color:#f92672">.</span><span style="color:#a6e22e">mInstrumentation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onException</span><span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> e<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
                    <span style="color:#e6db74">&#34;Unable to instantiate application &#34;</span> <span style="color:#f92672">+</span> appClass
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        mActivityThread<span style="color:#f92672">.</span><span style="color:#a6e22e">mAllApplications</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
        mApplication <span style="color:#f92672">=</span> app<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>instrumentation <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                instrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">callApplicationOnCreate</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>instrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">onException</span><span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> e<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
                        <span style="color:#e6db74">&#34;Unable to create application &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Rewrite the R &#39;constants&#39; for all library apks.
</span><span style="color:#75715e"></span>        SparseArray<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> packageIdentifiers <span style="color:#f92672">=</span> getAssets<span style="color:#f92672">().</span><span style="color:#a6e22e">getAssignedPackageIdentifiers</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> N <span style="color:#f92672">=</span> packageIdentifiers<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> N<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> id <span style="color:#f92672">=</span> packageIdentifiers<span style="color:#f92672">.</span><span style="color:#a6e22e">keyAt</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>id <span style="color:#f92672">==</span> 0x01 <span style="color:#f92672">||</span> id <span style="color:#f92672">==</span> 0x7f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            rewriteRValues<span style="color:#f92672">(</span>getClassLoader<span style="color:#f92672">(),</span> packageIdentifiers<span style="color:#f92672">.</span><span style="color:#a6e22e">valueAt</span><span style="color:#f92672">(</span>i<span style="color:#f92672">),</span> id<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> app<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>ContextImpl.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">static</span> ContextImpl <span style="color:#a6e22e">createAppContext</span><span style="color:#f92672">(</span>ActivityThread mainThread<span style="color:#f92672">,</span> LoadedApk loadedApk<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>loadedApk <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;loadedApk&#34;</span><span style="color:#f92672">);</span>
        ContextImpl context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ContextImpl<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> mainThread<span style="color:#f92672">,</span> loadedApk<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span>
                <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        context<span style="color:#f92672">.</span><span style="color:#a6e22e">setResources</span><span style="color:#f92672">(</span>loadedApk<span style="color:#f92672">.</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> context<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h2 id="activity的context">Activity的Context</h2>
<p>ActivityThread.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> Activity <span style="color:#a6e22e">performLaunchActivity</span><span style="color:#f92672">(</span>ActivityClientRecord r<span style="color:#f92672">,</span> Intent customIntent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        ContextImpl appContext <span style="color:#f92672">=</span> createBaseContextForActivity<span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>activity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        CharSequence title <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadLabel</span><span style="color:#f92672">(</span>appContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManager</span><span style="color:#f92672">());</span>
        Configuration config <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Configuration<span style="color:#f92672">(</span>mCompatConfiguration<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">overrideConfig</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            config<span style="color:#f92672">.</span><span style="color:#a6e22e">updateFrom</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">overrideConfig</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_CONFIGURATION<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Launching activity &#34;</span>
                <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; with config &#34;</span> <span style="color:#f92672">+</span> config<span style="color:#f92672">);</span>
        Window window <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingRemoveWindow</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPreserveWindow</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            window <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingRemoveWindow</span><span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingRemoveWindow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingRemoveWindowManager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        appContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setOuterContext</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">);</span>
        activity<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span>appContext<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> getInstrumentation<span style="color:#f92672">(),</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span><span style="color:#f92672">,</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">ident</span><span style="color:#f92672">,</span> app<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">,</span> title<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">parent</span><span style="color:#f92672">,</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">embeddedID</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">lastNonConfigurationInstances</span><span style="color:#f92672">,</span> config<span style="color:#f92672">,</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">referrer</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">voiceInteractor</span><span style="color:#f92672">,</span> window<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">configCallback</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> ContextImpl <span style="color:#a6e22e">createBaseContextForActivity</span><span style="color:#f92672">(</span>ActivityClientRecord r<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> displayId<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            displayId <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getActivityDisplayId</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        ContextImpl appContext <span style="color:#f92672">=</span> ContextImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">createActivityContext</span><span style="color:#f92672">(</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">loadedApk</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span><span style="color:#f92672">,</span> displayId<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">overrideConfig</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">final</span> DisplayManagerGlobal dm <span style="color:#f92672">=</span> DisplayManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// For debugging purposes, if the activity&#39;s package name contains the value of
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// the &#34;debug.use-second-display&#34; system property as a substring, then show
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// its content on a secondary display if there is one.
</span><span style="color:#75715e"></span>        String pkgName <span style="color:#f92672">=</span> SystemProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;debug.second-display.pkg&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pkgName <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>pkgName<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">&amp;&amp;</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">loadedApk</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mPackageName</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>pkgName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> id <span style="color:#f92672">:</span> dm<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayIds</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>id <span style="color:#f92672">!=</span> Display<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_DISPLAY</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Display display <span style="color:#f92672">=</span>
                            dm<span style="color:#f92672">.</span><span style="color:#a6e22e">getCompatibleDisplay</span><span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> appContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">());</span>
                    appContext <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ContextImpl<span style="color:#f92672">)</span> appContext<span style="color:#f92672">.</span><span style="color:#a6e22e">createDisplayContext</span><span style="color:#f92672">(</span>display<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> appContext<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>Activity.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> ActivityThread aThread<span style="color:#f92672">,</span>
            Instrumentation instr<span style="color:#f92672">,</span> IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> ident<span style="color:#f92672">,</span>
            Application application<span style="color:#f92672">,</span> Intent intent<span style="color:#f92672">,</span> ActivityInfo info<span style="color:#f92672">,</span>
            CharSequence title<span style="color:#f92672">,</span> Activity parent<span style="color:#f92672">,</span> String id<span style="color:#f92672">,</span>
            NonConfigurationInstances lastNonConfigurationInstances<span style="color:#f92672">,</span>
            Configuration config<span style="color:#f92672">,</span> String referrer<span style="color:#f92672">,</span> IVoiceInteractor voiceInteractor<span style="color:#f92672">,</span>
            Window window<span style="color:#f92672">,</span> ActivityConfigCallback activityConfigCallback<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        attachBaseContext<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>

        mFragments<span style="color:#f92672">.</span><span style="color:#a6e22e">attachHost</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#75715e">/*parent*/</span><span style="color:#f92672">);</span>

        mWindow <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PhoneWindow<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> window<span style="color:#f92672">,</span> activityConfigCallback<span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setWindowControllerCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setOnWindowDismissedCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">getLayoutInflater</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setPrivateFactory</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">!=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_STATE_UNSPECIFIED</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setSoftInputMode</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">uiOptions</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setUiOptions</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">uiOptions</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        mUiThread <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>

        mMainThread <span style="color:#f92672">=</span> aThread<span style="color:#f92672">;</span>
        mInstrumentation <span style="color:#f92672">=</span> instr<span style="color:#f92672">;</span>
        mToken <span style="color:#f92672">=</span> token<span style="color:#f92672">;</span>
        mIdent <span style="color:#f92672">=</span> ident<span style="color:#f92672">;</span>
        mApplication <span style="color:#f92672">=</span> application<span style="color:#f92672">;</span>
        mIntent <span style="color:#f92672">=</span> intent<span style="color:#f92672">;</span>
        mReferrer <span style="color:#f92672">=</span> referrer<span style="color:#f92672">;</span>
        mComponent <span style="color:#f92672">=</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">();</span>
        mActivityInfo <span style="color:#f92672">=</span> info<span style="color:#f92672">;</span>
        mTitle <span style="color:#f92672">=</span> title<span style="color:#f92672">;</span>
        mParent <span style="color:#f92672">=</span> parent<span style="color:#f92672">;</span>
        mEmbeddedID <span style="color:#f92672">=</span> id<span style="color:#f92672">;</span>
        mLastNonConfigurationInstances <span style="color:#f92672">=</span> lastNonConfigurationInstances<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>voiceInteractor <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lastNonConfigurationInstances <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mVoiceInteractor <span style="color:#f92672">=</span> lastNonConfigurationInstances<span style="color:#f92672">.</span><span style="color:#a6e22e">voiceInteractor</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                mVoiceInteractor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> VoiceInteractor<span style="color:#f92672">(</span>voiceInteractor<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span>
                        Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setWindowManager</span><span style="color:#f92672">(</span>
                <span style="color:#f92672">(</span>WindowManager<span style="color:#f92672">)</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSystemService</span><span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">WINDOW_SERVICE</span><span style="color:#f92672">),</span>
                mToken<span style="color:#f92672">,</span> mComponent<span style="color:#f92672">.</span><span style="color:#a6e22e">flattenToString</span><span style="color:#f92672">(),</span>
                <span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> ActivityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_HARDWARE_ACCELERATED</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mParent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setContainer</span><span style="color:#f92672">(</span>mParent<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindow</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        mWindowManager <span style="color:#f92672">=</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindowManager</span><span style="color:#f92672">();</span>
        mCurrentConfig <span style="color:#f92672">=</span> config<span style="color:#f92672">;</span>

        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setColorMode</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">colorMode</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>ContextImpl.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">static</span> ContextImpl <span style="color:#a6e22e">createActivityContext</span><span style="color:#f92672">(</span>ActivityThread mainThread<span style="color:#f92672">,</span>
            LoadedApk loadedApk<span style="color:#f92672">,</span> ActivityInfo activityInfo<span style="color:#f92672">,</span> IBinder activityToken<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> displayId<span style="color:#f92672">,</span>
            Configuration overrideConfiguration<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>loadedApk <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;loadedApk&#34;</span><span style="color:#f92672">);</span>

        String<span style="color:#f92672">[]</span> splitDirs <span style="color:#f92672">=</span> loadedApk<span style="color:#f92672">.</span><span style="color:#a6e22e">getSplitResDirs</span><span style="color:#f92672">();</span>
        ClassLoader classLoader <span style="color:#f92672">=</span> loadedApk<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>loadedApk<span style="color:#f92672">.</span><span style="color:#a6e22e">getApplicationInfo</span><span style="color:#f92672">().</span><span style="color:#a6e22e">requestsIsolatedSplitLoading</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_RESOURCES</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;SplitDependencies&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                classLoader <span style="color:#f92672">=</span> loadedApk<span style="color:#f92672">.</span><span style="color:#a6e22e">getSplitClassLoader</span><span style="color:#f92672">(</span>activityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">splitName</span><span style="color:#f92672">);</span>
                splitDirs <span style="color:#f92672">=</span> loadedApk<span style="color:#f92672">.</span><span style="color:#a6e22e">getSplitPaths</span><span style="color:#f92672">(</span>activityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">splitName</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NameNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Nothing above us can handle a NameNotFoundException, better crash.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_RESOURCES</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        ContextImpl context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ContextImpl<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> mainThread<span style="color:#f92672">,</span> loadedApk<span style="color:#f92672">,</span> activityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">splitName</span><span style="color:#f92672">,</span>
                activityToken<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> classLoader<span style="color:#f92672">);</span>

        <span style="color:#75715e">// Clamp display ID to DEFAULT_DISPLAY if it is INVALID_DISPLAY.
</span><span style="color:#75715e"></span>        displayId <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>displayId <span style="color:#f92672">!=</span> Display<span style="color:#f92672">.</span><span style="color:#a6e22e">INVALID_DISPLAY</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> displayId <span style="color:#f92672">:</span> Display<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_DISPLAY</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> CompatibilityInfo compatInfo <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>displayId <span style="color:#f92672">==</span> Display<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_DISPLAY</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">?</span> loadedApk<span style="color:#f92672">.</span><span style="color:#a6e22e">getCompatibilityInfo</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">:</span> CompatibilityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_COMPATIBILITY_INFO</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> ResourcesManager resourcesManager <span style="color:#f92672">=</span> ResourcesManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// Create the base resources for which all configuration contexts for this Activity
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// will be rebased upon.
</span><span style="color:#75715e"></span>        context<span style="color:#f92672">.</span><span style="color:#a6e22e">setResources</span><span style="color:#f92672">(</span>resourcesManager<span style="color:#f92672">.</span><span style="color:#a6e22e">createBaseActivityResources</span><span style="color:#f92672">(</span>activityToken<span style="color:#f92672">,</span>
                loadedApk<span style="color:#f92672">.</span><span style="color:#a6e22e">getResDir</span><span style="color:#f92672">(),</span>
                splitDirs<span style="color:#f92672">,</span>
                loadedApk<span style="color:#f92672">.</span><span style="color:#a6e22e">getOverlayDirs</span><span style="color:#f92672">(),</span>
                loadedApk<span style="color:#f92672">.</span><span style="color:#a6e22e">getApplicationInfo</span><span style="color:#f92672">().</span><span style="color:#a6e22e">sharedLibraryFiles</span><span style="color:#f92672">,</span>
                displayId<span style="color:#f92672">,</span>
                overrideConfiguration<span style="color:#f92672">,</span>
                compatInfo<span style="color:#f92672">,</span>
                classLoader<span style="color:#f92672">));</span>
        context<span style="color:#f92672">.</span><span style="color:#a6e22e">mDisplay</span> <span style="color:#f92672">=</span> resourcesManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getAdjustedDisplay</span><span style="color:#f92672">(</span>displayId<span style="color:#f92672">,</span>
                context<span style="color:#f92672">.</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> context<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

</code></pre></div><h2 id="view的context">View的Context</h2>
<p>View属于一个Window，具体来说的是PhoneWindow，PhoneWindow在实例化时使用的当前Activity作为参数，在设置View时的代码如下：</p>
<p>PhoneWindow.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setContentView</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> layoutResID<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// decor, when theme attributes and the like are crystalized. Do not check the feature
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// before this happens.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mContentParent <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            installDecor<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>hasFeature<span style="color:#f92672">(</span>FEATURE_CONTENT_TRANSITIONS<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            mContentParent<span style="color:#f92672">.</span><span style="color:#a6e22e">removeAllViews</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasFeature<span style="color:#f92672">(</span>FEATURE_CONTENT_TRANSITIONS<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> Scene newScene <span style="color:#f92672">=</span> Scene<span style="color:#f92672">.</span><span style="color:#a6e22e">getSceneForLayout</span><span style="color:#f92672">(</span>mContentParent<span style="color:#f92672">,</span> layoutResID<span style="color:#f92672">,</span>
                    getContext<span style="color:#f92672">());</span>
            transitionTo<span style="color:#f92672">(</span>newScene<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            mLayoutInflater<span style="color:#f92672">.</span><span style="color:#a6e22e">inflate</span><span style="color:#f92672">(</span>layoutResID<span style="color:#f92672">,</span> mContentParent<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        mContentParent<span style="color:#f92672">.</span><span style="color:#a6e22e">requestApplyInsets</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> Callback cb <span style="color:#f92672">=</span> getCallback<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cb <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>isDestroyed<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            cb<span style="color:#f92672">.</span><span style="color:#a6e22e">onContentChanged</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        mContentParentExplicitlySet <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">PhoneWindow</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
        mLayoutInflater <span style="color:#f92672">=</span> LayoutInflater<span style="color:#f92672">.</span><span style="color:#a6e22e">from</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>LayoutInflater.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Obtains the LayoutInflater from the given context.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> LayoutInflater <span style="color:#a6e22e">from</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        LayoutInflater LayoutInflater <span style="color:#f92672">=</span>
                <span style="color:#f92672">(</span>LayoutInflater<span style="color:#f92672">)</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSystemService</span><span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">LAYOUT_INFLATER_SERVICE</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>LayoutInflater <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AssertionError<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LayoutInflater not found.&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> LayoutInflater<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>其中LayoutInflater直接从静态方法获取，那么获取到的LayoutInflater实例是没有与特定Context绑定的，但是这个Context是PhoneWindow所在Activity，那么为了让LayoutInflater绑定一个Context必须进行多态处理，那么可以发现Activity的一级父类<code>ContextThemeWrapper</code>重写了<code>getSystemService</code>方法，正是此处将Context绑定到LayoutInflater：</p>
<p>ContextThemeWrapper.java，</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getSystemService</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>LAYOUT_INFLATER_SERVICE<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>name<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mInflater <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mInflater <span style="color:#f92672">=</span> LayoutInflater<span style="color:#f92672">.</span><span style="color:#a6e22e">from</span><span style="color:#f92672">(</span>getBaseContext<span style="color:#f92672">()).</span><span style="color:#a6e22e">cloneInContext</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> mInflater<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> getBaseContext<span style="color:#f92672">().</span><span style="color:#a6e22e">getSystemService</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h2 id="viewgetcontext是否可以直接转型为activity">View.getContext()是否可以直接转型为Activity</h2>
<p>为了使用支持库的ActionBar特征有时会使用<code>AppCompatActivity</code>作为Activity的父类，此时，根据上面的分析，使用<code>LayoutInflater.from(getBaseContext())</code>方法拿到的<code>LayoutInflater</code>实际上是Activity的一个实例变量。在<code>AppCompatActivity</code>的onCreate方法中，通过调用<code>delegate.installViewFactory()</code>为该<code>LayoutInflater</code>实例设置<code>Factory2</code>变量，然后在设置界面时<code>setContentView(int res)</code>会调用到代理<code>AppCompatDelegate</code>中的<code>setContentView(int res)</code>，而该代理的实例继承了<code>AppCompatDelegateImplV9</code>，而<code>AppCompatDelegateImplV9</code>实现了<code>LayoutInflater.Factory2</code>接口，并将其设置为上面的<code>LayoutInflater</code>实例中，最终在从布局文件创建视图时，<code>AppCompatDelegateImplV9</code>对<code>LayoutInflater.Factory2</code>中方法的实现中，会使用<code>AppCompatViewInflater</code>来对单个的View进行处理，将其替换为支持库中的类：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
    <span style="color:#66d9ef">final</span> View <span style="color:#a6e22e">createView</span><span style="color:#f92672">(</span>View parent<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String name<span style="color:#f92672">,</span> <span style="color:#a6e22e">@NonNull</span> Context context<span style="color:#f92672">,</span>
            <span style="color:#a6e22e">@NonNull</span> AttributeSet attrs<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> inheritContext<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> readAndroidTheme<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> readAppTheme<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> wrapContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> Context originalContext <span style="color:#f92672">=</span> context<span style="color:#f92672">;</span>

        <span style="color:#75715e">// We can emulate Lollipop&#39;s android:theme attribute propagating down the view hierarchy
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// by using the parent&#39;s context
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>inheritContext <span style="color:#f92672">&amp;&amp;</span> parent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            context <span style="color:#f92672">=</span> parent<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>readAndroidTheme <span style="color:#f92672">||</span> readAppTheme<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// We then apply the theme on the context, if specified
</span><span style="color:#75715e"></span>            context <span style="color:#f92672">=</span> themifyContext<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">,</span> readAndroidTheme<span style="color:#f92672">,</span> readAppTheme<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>wrapContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            context <span style="color:#f92672">=</span> TintContextWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">wrap</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        View view <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// We need to &#39;inject&#39; our tint aware Views in place of the standard framework versions
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;TextView&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createTextView<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;ImageView&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createImageView<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;Button&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createButton<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;EditText&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createEditText<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;Spinner&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createSpinner<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;ImageButton&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createImageButton<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;CheckBox&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createCheckBox<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;RadioButton&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createRadioButton<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;CheckedTextView&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createCheckedTextView<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;AutoCompleteTextView&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createAutoCompleteTextView<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;MultiAutoCompleteTextView&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createMultiAutoCompleteTextView<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;RatingBar&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createRatingBar<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;SeekBar&#34;</span><span style="color:#f92672">:</span>
                view <span style="color:#f92672">=</span> createSeekBar<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
                verifyNotNull<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">// The fallback that allows extending class to take over view inflation
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// for other tags. Note that we don&#39;t check that the result is not-null.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// That allows the custom inflater path to fall back on the default one
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// later in this method.
</span><span style="color:#75715e"></span>                view <span style="color:#f92672">=</span> createView<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>view <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> originalContext <span style="color:#f92672">!=</span> context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If the original context does not equal our themed context, then we need to manually
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// inflate it using the name so that android:theme takes effect.
</span><span style="color:#75715e"></span>            view <span style="color:#f92672">=</span> createViewFromTag<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>view <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If we have created a view, check its android:onClick
</span><span style="color:#75715e"></span>            checkOnClickListener<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> view<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>可以看到，此时拿到的View所持有的<code>Context</code>已经不是原来的<code>Activity</code>了，很可能会是一个将原来<code>Activity</code>实例包裹起来的<code>ContextWrapper</code>实例。因此如果从View中拿到Context后，并不能直接转型为Activity，而是应当将其一层一层剥开，才能拿到最原始的Activity实例。</p>

                </div>
                
            </article>
        </div>
    </div>

                </div>
                <footer>
    Powered by <a target="_blank" href="https://gohugo.io/">Hugo</a> And 
    <a target="_blank" href="https://pages.github.com/">Github Pages</a>
</footer>
                <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
                

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>

                <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.12.0/styles/default.min.css">
                <script src="/js/highlight.pack.js"></script>
                <script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
                <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [
                ['$', '$'],
                ['\\(', '\\)']
            ],
            displayMath: [
                ['$$', '$$']
            ],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });
    MathJax.Hub.Queue(function () {



        var all = MathJax.Hub.getAllJax(),
            i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

    MathJax.Hub.Config({

        TeX: {
            equationNumbers: {
                autoNumber: "AMS"
            }
        }
    });
</script>
                <script type="text/javascript" src="/js/main.js"></script>
        </div>
    </body>

</html>