<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" >
        <meta lang="zh">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Window与WindowManager机制 | androidpi</title>
<meta name="description" content="接着Activity的启动流程分析Window的添加过程，与Activity相关联的window的创建发生在Activity.perform">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/solid.css" integrity="sha384-TbilV5Lbhlwdyc4RuIV/JhD8NR+BfMrvz4BL5QFa2we1hQu6wvREr3v6XSRfCTRp" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/brands.css" integrity="sha384-7xAnn7Zm3QC1jFjVc1A6v/toepoG3JXboQYzbM0jrPzou9OFXm/fY6Z/XiIebl/k" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/fontawesome.css" integrity="sha384-ozJwkrqb90Oa3ZNb+yKFW2lToAWYdTiF1vt8JiH5ptTGHTGcN7qdoR1F95e0kYyG" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
        
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="/css/article.css" />

    </head>

    <body>
        <div class="site-wrapper">
                <header>
    <nav>
        <a class="home" href="https://www.androidpi.com/">首页</a>
    </nav>
    
</header>
                <div class="site-main">
                    
    <div class="main">
        <div class="article">
            <aside>
                    <nav id="TableOfContents"></nav>
            </aside>
            <article>
                <div class="title">
                    <h1 id="title">Window与WindowManager机制</h1>
                </div>
                <div class="content">
                        <p>接着Activity的启动流程分析Window的添加过程，与Activity相关联的window的创建发生在<code>Activity.performLaunchActivity()</code>方法中，当activity实例创建后，会调用该activity的<code>attach()</code>方法，该方法中会创建window的实例，它是一个<code>PhoneWindow</code>对象，但此时该window实例还未设置布局，也未添加到WindowManager中：</p>
<p>Activity.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> ActivityThread aThread<span style="color:#f92672">,</span>
            Instrumentation instr<span style="color:#f92672">,</span> IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> ident<span style="color:#f92672">,</span>
            Application application<span style="color:#f92672">,</span> Intent intent<span style="color:#f92672">,</span> ActivityInfo info<span style="color:#f92672">,</span>
            CharSequence title<span style="color:#f92672">,</span> Activity parent<span style="color:#f92672">,</span> String id<span style="color:#f92672">,</span>
            NonConfigurationInstances lastNonConfigurationInstances<span style="color:#f92672">,</span>
            Configuration config<span style="color:#f92672">,</span> String referrer<span style="color:#f92672">,</span> IVoiceInteractor voiceInteractor<span style="color:#f92672">,</span>
            Window window<span style="color:#f92672">,</span> ActivityConfigCallback activityConfigCallback<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        attachBaseContext<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>

        mFragments<span style="color:#f92672">.</span><span style="color:#a6e22e">attachHost</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#75715e">/*parent*/</span><span style="color:#f92672">);</span>

        mWindow <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PhoneWindow<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> window<span style="color:#f92672">,</span> activityConfigCallback<span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setWindowControllerCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setOnWindowDismissedCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">getLayoutInflater</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setPrivateFactory</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">!=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_STATE_UNSPECIFIED</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setSoftInputMode</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">uiOptions</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setUiOptions</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">uiOptions</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        mUiThread <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>

        mMainThread <span style="color:#f92672">=</span> aThread<span style="color:#f92672">;</span>
        mInstrumentation <span style="color:#f92672">=</span> instr<span style="color:#f92672">;</span>
        mToken <span style="color:#f92672">=</span> token<span style="color:#f92672">;</span>
        mIdent <span style="color:#f92672">=</span> ident<span style="color:#f92672">;</span>
        mApplication <span style="color:#f92672">=</span> application<span style="color:#f92672">;</span>
        mIntent <span style="color:#f92672">=</span> intent<span style="color:#f92672">;</span>
        mReferrer <span style="color:#f92672">=</span> referrer<span style="color:#f92672">;</span>
        mComponent <span style="color:#f92672">=</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">();</span>
        mActivityInfo <span style="color:#f92672">=</span> info<span style="color:#f92672">;</span>
        mTitle <span style="color:#f92672">=</span> title<span style="color:#f92672">;</span>
        mParent <span style="color:#f92672">=</span> parent<span style="color:#f92672">;</span>
        mEmbeddedID <span style="color:#f92672">=</span> id<span style="color:#f92672">;</span>
        mLastNonConfigurationInstances <span style="color:#f92672">=</span> lastNonConfigurationInstances<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>voiceInteractor <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lastNonConfigurationInstances <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mVoiceInteractor <span style="color:#f92672">=</span> lastNonConfigurationInstances<span style="color:#f92672">.</span><span style="color:#a6e22e">voiceInteractor</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                mVoiceInteractor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> VoiceInteractor<span style="color:#f92672">(</span>voiceInteractor<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span>
                        Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setWindowManager</span><span style="color:#f92672">(</span>
                <span style="color:#f92672">(</span>WindowManager<span style="color:#f92672">)</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSystemService</span><span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">WINDOW_SERVICE</span><span style="color:#f92672">),</span>
                mToken<span style="color:#f92672">,</span> mComponent<span style="color:#f92672">.</span><span style="color:#a6e22e">flattenToString</span><span style="color:#f92672">(),</span>
                <span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> ActivityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_HARDWARE_ACCELERATED</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mParent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setContainer</span><span style="color:#f92672">(</span>mParent<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindow</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        mWindowManager <span style="color:#f92672">=</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindowManager</span><span style="color:#f92672">();</span>
        mCurrentConfig <span style="color:#f92672">=</span> config<span style="color:#f92672">;</span>

        mWidow<span style="color:#f92672">.</span><span style="color:#a6e22e">setColorMode</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">colorMode</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>这是通过<code>Window.setWindowManager()</code>设置该<code>Window</code>的<code>WindowManager</code>，它是一个<code>WindowManagerImpl</code>实例，它也被赋值给<code>Activity</code>的<code>mWindowManager</code>，并且通过<code>Activity.getSystemService(@ServiceName @NonNull String name)</code>方法返回的就是该<code>WindowManager</code>。</p>
<p>Window.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Set the window manager for use by this Window to, for example,
</span><span style="color:#75715e">     * display panels.  This is &lt;em&gt;not&lt;/em&gt; used for displaying the
</span><span style="color:#75715e">     * Window itself -- that must be done by the client.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param wm The window manager for adding new windows.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setWindowManager</span><span style="color:#f92672">(</span>WindowManager wm<span style="color:#f92672">,</span> IBinder appToken<span style="color:#f92672">,</span> String appName<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> hardwareAccelerated<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        mAppToken <span style="color:#f92672">=</span> appToken<span style="color:#f92672">;</span>
        mAppName <span style="color:#f92672">=</span> appName<span style="color:#f92672">;</span>
        mHardwareAccelerated <span style="color:#f92672">=</span> hardwareAccelerated
                <span style="color:#f92672">||</span> SystemProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getBoolean</span><span style="color:#f92672">(</span>PROPERTY_HARDWARE_UI<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>wm <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            wm <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>WindowManager<span style="color:#f92672">)</span>mContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getSystemService</span><span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">WINDOW_SERVICE</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        mWindowManager <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>WindowManagerImpl<span style="color:#f92672">)</span>wm<span style="color:#f92672">).</span><span style="color:#a6e22e">createLocalWindowManager</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>随后在Activity的onCreate()方法中通过<code>setContentView</code>为window对象设置了一个布局。onResume生命周期回调后，采用使用WindowManager将Window真正添加到其中。这里可以发现，如果不指定要设置的布局参数，它会将View的布局参数设置为<code>new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT)</code>，这也是为什么在使用<code>DialogFragment</code>时，通过<code>onCreateView</code>创建的视图的根结点布局参数会被覆盖。</p>
<p>PhoneWindow.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setContentView</span><span style="color:#f92672">(</span>View view<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        setContentView<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ViewGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">(</span>MATCH_PARENT<span style="color:#f92672">,</span> MATCH_PARENT<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>ActivityThread.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleResumeActivity</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> clearHide<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> isForward<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> reallyResume<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> seq<span style="color:#f92672">,</span> String reason<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ActivityClientRecord r <span style="color:#f92672">=</span> mActivities<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>checkAndUpdateLifecycleSeq<span style="color:#f92672">(</span>seq<span style="color:#f92672">,</span> r<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;resumeActivity&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If we are getting ready to gc after going to the background, well
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// we are back active so skip it.
</span><span style="color:#75715e"></span>        unscheduleGcIdler<span style="color:#f92672">();</span>
        mSomeActivitiesChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// TODO Push resumeArgs into the activity for consideration
</span><span style="color:#75715e"></span>        r <span style="color:#f92672">=</span> performResumeActivity<span style="color:#f92672">(</span>token<span style="color:#f92672">,</span> clearHide<span style="color:#f92672">,</span> reason<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> Activity a <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
                TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Resume &#34;</span> <span style="color:#f92672">+</span> r <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; started activity: &#34;</span> <span style="color:#f92672">+</span>
                a<span style="color:#f92672">.</span><span style="color:#a6e22e">mStartedActivity</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, hideForNow: &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">hideForNow</span>
                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, finished: &#34;</span> <span style="color:#f92672">+</span> a<span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> forwardBit <span style="color:#f92672">=</span> isForward <span style="color:#f92672">?</span>
                    WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_IS_FORWARD_NAVIGATION</span> <span style="color:#f92672">:</span> 0<span style="color:#f92672">;</span>

            <span style="color:#75715e">// If the window hasn&#39;t yet been added to the window manager,
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// and this guy didn&#39;t finish itself or start another activity,
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// then go ahead and add the window.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> willBeVisible <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>a<span style="color:#f92672">.</span><span style="color:#a6e22e">mStartedActivity</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>willBeVisible<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    willBeVisible <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">().</span><span style="color:#a6e22e">willActivityBeVisible</span><span style="color:#f92672">(</span>
                            a<span style="color:#f92672">.</span><span style="color:#a6e22e">getActivityToken</span><span style="color:#f92672">());</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>a<span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span> <span style="color:#f92672">&amp;&amp;</span> willBeVisible<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// 拿到window
</span><span style="color:#75715e"></span>                r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span> <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getWindow</span><span style="color:#f92672">();</span>
                View decor <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDecorView</span><span style="color:#f92672">();</span>
                decor<span style="color:#f92672">.</span><span style="color:#a6e22e">setVisibility</span><span style="color:#f92672">(</span>View<span style="color:#f92672">.</span><span style="color:#a6e22e">INVISIBLE</span><span style="color:#f92672">);</span>
                ViewManager wm <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindowManager</span><span style="color:#f92672">();</span>
                WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> l <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAttributes</span><span style="color:#f92672">();</span>
                a<span style="color:#f92672">.</span><span style="color:#a6e22e">mDecor</span> <span style="color:#f92672">=</span> decor<span style="color:#f92672">;</span>
                l<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_BASE_APPLICATION</span><span style="color:#f92672">;</span>
                l<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">|=</span> forwardBit<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPreserveWindow</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    a<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowAdded</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPreserveWindow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    <span style="color:#75715e">// Normally the ViewRoot sets up callbacks with the Activity
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// in addView-&gt;ViewRootImpl#setView. If we are instead reusing
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// the decor view we have to notify the view root that the
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// callbacks may have changed.
</span><span style="color:#75715e"></span>                    ViewRootImpl impl <span style="color:#f92672">=</span> decor<span style="color:#f92672">.</span><span style="color:#a6e22e">getViewRootImpl</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>impl <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        impl<span style="color:#f92672">.</span><span style="color:#a6e22e">notifyChildRebuilt</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>a<span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleFromClient</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>a<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowAdded</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        a<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowAdded</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                        <span style="color:#75715e">// 添加window
</span><span style="color:#75715e"></span>                        wm<span style="color:#f92672">.</span><span style="color:#a6e22e">addView</span><span style="color:#f92672">(</span>decor<span style="color:#f92672">,</span> l<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// The activity will get a callback for this {@link LayoutParams} change
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// earlier. However, at that time the decor will not be set (this is set
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// in this method), so no action will be taken. This call ensures the
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// callback occurs with the decor set.
</span><span style="color:#75715e"></span>                        a<span style="color:#f92672">.</span><span style="color:#a6e22e">onWindowAttributesChanged</span><span style="color:#f92672">(</span>l<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

            <span style="color:#75715e">// If the window has already been added, but during resume
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// we started another activity, then don&#39;t yet make the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// window visible.
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>willBeVisible<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
                    TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Launch &#34;</span> <span style="color:#f92672">+</span> r <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; mStartedActivity set&#34;</span><span style="color:#f92672">);</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">hideForNow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Get rid of anything left hanging around.
</span><span style="color:#75715e"></span>            cleanUpPendingRemoveWindows<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* force */</span><span style="color:#f92672">);</span>

            <span style="color:#75715e">// The window is now visible if it has been added, we are not
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// simply finishing, and we are not starting another activity.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span> <span style="color:#f92672">&amp;&amp;</span> willBeVisible
                    <span style="color:#f92672">&amp;&amp;</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mDecor</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">hideForNow</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">newConfig</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    performConfigurationChangedForActivity<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">newConfig</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_CONFIGURATION<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Resuming activity &#34;</span>
                            <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; with newConfig &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mCurrentConfig</span><span style="color:#f92672">);</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">newConfig</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Resuming &#34;</span> <span style="color:#f92672">+</span> r <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; with isForward=&#34;</span>
                        <span style="color:#f92672">+</span> isForward<span style="color:#f92672">);</span>
                WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> l <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAttributes</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>l<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span>
                        <span style="color:#f92672">&amp;</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span style="color:#f92672">)</span>
                        <span style="color:#f92672">!=</span> forwardBit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    l<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>l<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span>
                            <span style="color:#f92672">&amp;</span> <span style="color:#f92672">(~</span>WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span style="color:#f92672">))</span>
                            <span style="color:#f92672">|</span> forwardBit<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleFromClient</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        ViewManager wm <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindowManager</span><span style="color:#f92672">();</span>
                        View decor <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDecorView</span><span style="color:#f92672">();</span>
                        wm<span style="color:#f92672">.</span><span style="color:#a6e22e">updateViewLayout</span><span style="color:#f92672">(</span>decor<span style="color:#f92672">,</span> l<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

                r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleFromServer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                mNumVisibleActivities<span style="color:#f92672">++;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleFromClient</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">makeVisible</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">onlyLocalRequest</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">nextIdle</span> <span style="color:#f92672">=</span> mNewActivities<span style="color:#f92672">;</span>
                mNewActivities <span style="color:#f92672">=</span> r<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
                    TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Scheduling idle handler for &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">);</span>
                Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">addIdleHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Idler<span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">onlyLocalRequest</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// Tell the activity manager we have resumed.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>reallyResume<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">().</span><span style="color:#a6e22e">activityResumed</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">throw</span> ex<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If an exception was thrown when trying to resume, then
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// just end this activity.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">finishActivity</span><span style="color:#f92672">(</span>token<span style="color:#f92672">,</span> Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">RESULT_CANCELED</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                            Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">DONT_FINISH_TASK_WITH_ACTIVITY</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> ex<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><!-- raw HTML omitted -->
<p>现在我们聚焦到上面的<code>wm.addView(decor, l)</code>调用，其中当前Activity对应的<code>Window</code>，它是一个<code>PhoneWindow</code>实例，另外几个对象的实例定义如下：</p>
<ul>
<li>
<p><code>wm</code></p>
<p>它是与Activity的Window对象持有的一个<code>WindowManagerImpl</code>实例</p>
</li>
<li>
<p><code>decor</code></p>
<p>它是该<code>PhoneWindow</code>的<code>DecorView</code></p>
</li>
<li>
<p><code>l</code></p>
<p>它是该<code>PhoneWindow</code>的布局参数，其默认值采用如下构造器进行初始化。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">WindowManager</span> <span style="color:#66d9ef">extends</span> ViewManager <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LayoutParams</span> <span style="color:#66d9ef">extends</span> ViewGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> <span style="color:#66d9ef">implements</span> Parcelable <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_PARENT</span><span style="color:#f92672">,</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_PARENT</span><span style="color:#f92672">);</span>
            type <span style="color:#f92672">=</span> TYPE_APPLICATION<span style="color:#f92672">;</span>
            format <span style="color:#f92672">=</span> PixelFormat<span style="color:#f92672">.</span><span style="color:#a6e22e">OPAQUE</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
</ul>
<p>其中WindowManagerImpl用于为绑定到特定context、display或父window的操作提供与系统window manager进行低层级的通信，再看该它是如何添加视图的，可以发现它将添加的工作委托给了<code>WindowManagerGlobal</code>。</p>
<p>WindowManagerImpl.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addView</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@NonNull</span> View view<span style="color:#f92672">,</span> <span style="color:#a6e22e">@NonNull</span> ViewGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> params<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        applyDefaultToken<span style="color:#f92672">(</span>params<span style="color:#f92672">);</span>
        mGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">addView</span><span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> params<span style="color:#f92672">,</span> mContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplay</span><span style="color:#f92672">(),</span> mParentWindow<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>WindowManagerGlobal是一个单例，与WindowManagerImpl相同的是，它也用于为各种操作提供与系统window manager进行低层级的通信。但不与特定的context相关。</p>
<p>WindowManagerGlobal.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addView</span><span style="color:#f92672">(</span>View view<span style="color:#f92672">,</span> ViewGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> params<span style="color:#f92672">,</span>
            Display display<span style="color:#f92672">,</span> Window parentWindow<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>view <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;view must not be null&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>display <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;display must not be null&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!(</span>params <span style="color:#66d9ef">instanceof</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Params must be WindowManager.LayoutParams&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> wparams <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">)</span> params<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>parentWindow <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            parentWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">adjustLayoutParamsForSubWindow</span><span style="color:#f92672">(</span>wparams<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If there&#39;s no parent, then hardware acceleration for this view is
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// set from the application&#39;s hardware acceleration setting.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> Context context <span style="color:#f92672">=</span> view<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                    <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getApplicationInfo</span><span style="color:#f92672">().</span><span style="color:#a6e22e">flags</span>
                            <span style="color:#f92672">&amp;</span> ApplicationInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_HARDWARE_ACCELERATED</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                wparams<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">|=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_HARDWARE_ACCELERATED</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        ViewRootImpl root<span style="color:#f92672">;</span>
        View panelParentView <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mLock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Start watching for system property changes.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSystemPropertyUpdater <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mSystemPropertyUpdater <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    <span style="color:#a6e22e">@Override</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mLock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> mRoots<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span> i <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">;</span> <span style="color:#f92672">--</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                mRoots<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">).</span><span style="color:#a6e22e">loadSystemProperties</span><span style="color:#f92672">();</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">};</span>
                SystemProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">addChangeCallback</span><span style="color:#f92672">(</span>mSystemPropertyUpdater<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> findViewLocked<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>index <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mDyingViews<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>view<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Don&#39;t wait for MSG_DIE to make it&#39;s way through root&#39;s queue.
</span><span style="color:#75715e"></span>                    mRoots<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>index<span style="color:#f92672">).</span><span style="color:#a6e22e">doDie</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;View &#34;</span> <span style="color:#f92672">+</span> view
                            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; has already been added to the window manager.&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">// The previous removeView() had not completed executing. Now it has.
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// If this is a panel window, then find the window it is being
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// attached to for future reference.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>wparams<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">&gt;=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FIRST_SUB_WINDOW</span> <span style="color:#f92672">&amp;&amp;</span>
                    wparams<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">&lt;=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">LAST_SUB_WINDOW</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> mViews<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> count<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mRoots<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">).</span><span style="color:#a6e22e">mWindow</span><span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> wparams<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        panelParentView <span style="color:#f92672">=</span> mViews<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            root <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ViewRootImpl<span style="color:#f92672">(</span>view<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">(),</span> display<span style="color:#f92672">);</span>

            view<span style="color:#f92672">.</span><span style="color:#a6e22e">setLayoutParams</span><span style="color:#f92672">(</span>wparams<span style="color:#f92672">);</span>

            mViews<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>view<span style="color:#f92672">);</span>
            mRoots<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>root<span style="color:#f92672">);</span>
            mParams<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>wparams<span style="color:#f92672">);</span>

            <span style="color:#75715e">// do this last because it fires off messages to start doing things
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                root<span style="color:#f92672">.</span><span style="color:#a6e22e">setView</span><span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> wparams<span style="color:#f92672">,</span> panelParentView<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RuntimeException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// BadTokenException or InvalidDisplayException, clean up.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>index <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    removeViewLocked<span style="color:#f92672">(</span>index<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>可以发现它新建了一个<code>ViewRootImpl</code>实例，它将<code>PhoneWindow</code>的布局参数设置为<code>DecorView</code>的布局参数，然后调用<code>ViewRootImpl.setView(View view, WindowManager.LayoutParams attrs, View panelParentView)</code>方法。</p>
<p>ViewRootImpl.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * We have one child
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setView</span><span style="color:#f92672">(</span>View view<span style="color:#f92672">,</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> attrs<span style="color:#f92672">,</span> View panelParentView<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mView <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mView <span style="color:#f92672">=</span> view<span style="color:#f92672">;</span>

                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mDisplayState</span> <span style="color:#f92672">=</span> mDisplay<span style="color:#f92672">.</span><span style="color:#a6e22e">getState</span><span style="color:#f92672">();</span>
                mDisplayManager<span style="color:#f92672">.</span><span style="color:#a6e22e">registerDisplayListener</span><span style="color:#f92672">(</span>mDisplayListener<span style="color:#f92672">,</span> mHandler<span style="color:#f92672">);</span>

                mViewLayoutDirectionInitial <span style="color:#f92672">=</span> mView<span style="color:#f92672">.</span><span style="color:#a6e22e">getRawLayoutDirection</span><span style="color:#f92672">();</span>
                mFallbackEventHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">setView</span><span style="color:#f92672">(</span>view<span style="color:#f92672">);</span>
                mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">copyFrom</span><span style="color:#f92672">(</span>attrs<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span> <span style="color:#f92672">=</span> mBasePackageName<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                attrs <span style="color:#f92672">=</span> mWindowAttributes<span style="color:#f92672">;</span>
                setTag<span style="color:#f92672">();</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_KEEP_SCREEN_ON <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>mClientWindowLayoutFlags
                        <span style="color:#f92672">&amp;</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_KEEP_SCREEN_ON</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0
                        <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span><span style="color:#f92672">&amp;</span>WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_KEEP_SCREEN_ON</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;setView: FLAG_KEEP_SCREEN_ON changed from true to false!&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">// Keep track of the actual window flags supplied by the client.
</span><span style="color:#75715e"></span>                mClientWindowLayoutFlags <span style="color:#f92672">=</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span><span style="color:#f92672">;</span>

                setAccessibilityFocus<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>view <span style="color:#66d9ef">instanceof</span> RootViewSurfaceTaker<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mSurfaceHolderCallback <span style="color:#f92672">=</span>
                            <span style="color:#f92672">((</span>RootViewSurfaceTaker<span style="color:#f92672">)</span>view<span style="color:#f92672">).</span><span style="color:#a6e22e">willYouTakeTheSurface</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSurfaceHolderCallback <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mSurfaceHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TakenSurfaceHolder<span style="color:#f92672">();</span>
                        mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">setFormat</span><span style="color:#f92672">(</span>PixelFormat<span style="color:#f92672">.</span><span style="color:#a6e22e">UNKNOWN</span><span style="color:#f92672">);</span>
                        mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">addCallback</span><span style="color:#f92672">(</span>mSurfaceHolderCallback<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

                <span style="color:#75715e">// Compute surface insets required to draw at specified Z value.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// TODO: Use real shadow insets for a constant max Z.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">hasManualSurfaceInsets</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">setSurfaceInsets</span><span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">/*manual*/</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span> <span style="color:#75715e">/*preservePrevious*/</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                CompatibilityInfo compatibilityInfo <span style="color:#f92672">=</span>
                        mDisplay<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayAdjustments</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getCompatibilityInfo</span><span style="color:#f92672">();</span>
                mTranslator <span style="color:#f92672">=</span> compatibilityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getTranslator</span><span style="color:#f92672">();</span>

                <span style="color:#75715e">// If the application owns the surface, don&#39;t enable hardware acceleration
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSurfaceHolder <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    enableHardwareAcceleration<span style="color:#f92672">(</span>attrs<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">boolean</span> restore <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mTranslator <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">setCompatibilityTranslator</span><span style="color:#f92672">(</span>mTranslator<span style="color:#f92672">);</span>
                    restore <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">backup</span><span style="color:#f92672">();</span>
                    mTranslator<span style="color:#f92672">.</span><span style="color:#a6e22e">translateWindowLayout</span><span style="color:#f92672">(</span>attrs<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;WindowLayout in setView:&#34;</span> <span style="color:#f92672">+</span> attrs<span style="color:#f92672">);</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>compatibilityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">supportsScreen</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">privateFlags</span> <span style="color:#f92672">|=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PRIVATE_FLAG_COMPATIBLE_WINDOW</span><span style="color:#f92672">;</span>
                    mLastInCompatMode <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                mSoftInputMode <span style="color:#f92672">=</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span><span style="color:#f92672">;</span>
                mWindowAttributesChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                mWindowAttributesChangesFlag <span style="color:#f92672">=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EVERYTHING_CHANGED</span><span style="color:#f92672">;</span>
                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mRootView</span> <span style="color:#f92672">=</span> view<span style="color:#f92672">;</span>
                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mScalingRequired</span> <span style="color:#f92672">=</span> mTranslator <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mApplicationScale</span> <span style="color:#f92672">=</span>
                        mTranslator <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> 1<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span> <span style="color:#f92672">:</span> mTranslator<span style="color:#f92672">.</span><span style="color:#a6e22e">applicationScale</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>panelParentView <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mPanelParentWindowToken</span>
                            <span style="color:#f92672">=</span> panelParentView<span style="color:#f92672">.</span><span style="color:#a6e22e">getApplicationWindowToken</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
                mAdded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">int</span> res<span style="color:#f92672">;</span> <span style="color:#75715e">/* = WindowManagerImpl.ADD_OKAY; */</span>

                <span style="color:#75715e">// Schedule the first layout -before- adding to the window
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// manager, to make sure we do the relayout before receiving
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// any other events from the system.
</span><span style="color:#75715e"></span>                requestLayout<span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">inputFeatures</span>
                        <span style="color:#f92672">&amp;</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">INPUT_FEATURE_NO_INPUT_CHANNEL</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mInputChannel <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputChannel<span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
                mForceDecorViewVisibility <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">privateFlags</span>
                        <span style="color:#f92672">&amp;</span> PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    mOrigWindowType <span style="color:#f92672">=</span> mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span><span style="color:#f92672">;</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mRecomputeGlobalAttributes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    collectViewAttributes<span style="color:#f92672">();</span>
                    res <span style="color:#f92672">=</span> mWindowSession<span style="color:#f92672">.</span><span style="color:#a6e22e">addToDisplay</span><span style="color:#f92672">(</span>mWindow<span style="color:#f92672">,</span> mSeq<span style="color:#f92672">,</span> mWindowAttributes
                            <span style="color:#a6e22e">getHostVisibility</span><span style="color:#f92672">(),</span> mDisplay<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayId</span><span style="color:#f92672">(),</span>
                            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mContentInsets</span><span style="color:#f92672">,</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mStableInsets</span><span style="color:#f92672">,</span>
                            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOutsets</span><span style="color:#f92672">,</span> mInputChannel<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mAdded <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    mView <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mRootView</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    mInputChannel <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    mFallbackEventHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">setView</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                    unscheduleTraversals<span style="color:#f92672">();</span>
                    setAccessibilityFocus<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Adding window failed&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>restore<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">restore</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mTranslator <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mTranslator<span style="color:#f92672">.</span><span style="color:#a6e22e">translateRectInScreenToAppWindow</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mContentInsets</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                mPendingOverscanInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
                mPendingContentInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mContentInsets</span><span style="color:#f92672">);</span>
                mPendingStableInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mStableInsets</span><span style="color:#f92672">);</span>
                mPendingVisibleInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mAlwaysConsumeNavBar</span> <span style="color:#f92672">=</span>
                        <span style="color:#f92672">(</span>res <span style="color:#f92672">&amp;</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_FLAG_ALWAYS_CONSUME_NAV_BAR</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
                mPendingAlwaysConsumeNavBar <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mAlwaysConsumeNavBar</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Added window &#34;</span> <span style="color:#f92672">+</span> mWindow<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>res <span style="color:#f92672">&lt;</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_OKAY</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mRootView</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    mAdded <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    mFallbackEventHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">setView</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                    unscheduleTraversals<span style="color:#f92672">();</span>
                    setAccessibilityFocus<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>res<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">case</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">:</span>
                        <span style="color:#66d9ef">case</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_SUBWINDOW_TOKEN</span><span style="color:#f92672">:</span>
                            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">BadTokenException</span><span style="color:#f92672">(</span>
                                    <span style="color:#e6db74">&#34;Unable to add window -- token &#34;</span> <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span>
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; is not valid; is your activity running?&#34;</span><span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">case</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_NOT_APP_TOKEN</span><span style="color:#f92672">:</span>
                            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">BadTokenException</span><span style="color:#f92672">(</span>
                                    <span style="color:#e6db74">&#34;Unable to add window -- token &#34;</span> <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span>
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; is not for an application&#34;</span><span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">case</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_APP_EXITING</span><span style="color:#f92672">:</span>
                            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">BadTokenException</span><span style="color:#f92672">(</span>
                                    <span style="color:#e6db74">&#34;Unable to add window -- app for token &#34;</span> <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span>
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; is exiting&#34;</span><span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">case</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_DUPLICATE_ADD</span><span style="color:#f92672">:</span>
                            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">BadTokenException</span><span style="color:#f92672">(</span>
                                    <span style="color:#e6db74">&#34;Unable to add window -- window &#34;</span> <span style="color:#f92672">+</span> mWindow
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; has already been added&#34;</span><span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">case</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_STARTING_NOT_NEEDED</span><span style="color:#f92672">:</span>
                            <span style="color:#75715e">// Silently ignore -- we would have just removed it
</span><span style="color:#75715e"></span>                            <span style="color:#75715e">// right away, anyway.
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">case</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_MULTIPLE_SINGLETON</span><span style="color:#f92672">:</span>
                            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">BadTokenException</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Unable to add window &#34;</span>
                                    <span style="color:#f92672">+</span> mWindow <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -- another window of type &#34;</span>
                                    <span style="color:#f92672">+</span> mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; already exists&#34;</span><span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">case</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_PERMISSION_DENIED</span><span style="color:#f92672">:</span>
                            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">BadTokenException</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Unable to add window &#34;</span>
                                    <span style="color:#f92672">+</span> mWindow <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -- permission denied for window type &#34;</span>
                                    <span style="color:#f92672">+</span> mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span><span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">case</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_INVALID_DISPLAY</span><span style="color:#f92672">:</span>
                            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">InvalidDisplayException</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Unable to add window &#34;</span>
                                    <span style="color:#f92672">+</span> mWindow <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -- the specified display can not be found&#34;</span><span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">case</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_INVALID_TYPE</span><span style="color:#f92672">:</span>
                            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">InvalidDisplayException</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Unable to add window &#34;</span>
                                    <span style="color:#f92672">+</span> mWindow <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -- the specified window type &#34;</span>
                                    <span style="color:#f92672">+</span> mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; is not valid&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
                            <span style="color:#e6db74">&#34;Unable to add window -- unknown error code &#34;</span> <span style="color:#f92672">+</span> res<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>view <span style="color:#66d9ef">instanceof</span> RootViewSurfaceTaker<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mInputQueueCallback <span style="color:#f92672">=</span>
                        <span style="color:#f92672">((</span>RootViewSurfaceTaker<span style="color:#f92672">)</span>view<span style="color:#f92672">).</span><span style="color:#a6e22e">willYouTakeTheInputQueue</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mInputChannel <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mInputQueueCallback <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mInputQueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputQueue<span style="color:#f92672">();</span>
                        mInputQueueCallback<span style="color:#f92672">.</span><span style="color:#a6e22e">onInputQueueCreated</span><span style="color:#f92672">(</span>mInputQueue<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    mInputEventReceiver <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WindowInputEventReceiver<span style="color:#f92672">(</span>mInputChannel<span style="color:#f92672">,</span>
                            Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">());</span>
                <span style="color:#f92672">}</span>

                view<span style="color:#f92672">.</span><span style="color:#a6e22e">assignParent</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
                mAddedTouchMode <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>res <span style="color:#f92672">&amp;</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_FLAG_IN_TOUCH_MODE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
                mAppVisible <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>res <span style="color:#f92672">&amp;</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_FLAG_APP_VISIBLE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAccessibilityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">isEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    mAccessibilityInteractionConnectionManager<span style="color:#f92672">.</span><span style="color:#a6e22e">ensureConnection</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>view<span style="color:#f92672">.</span><span style="color:#a6e22e">getImportantForAccessibility</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">IMPORTANT_FOR_ACCESSIBILITY_AUTO</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    view<span style="color:#f92672">.</span><span style="color:#a6e22e">setImportantForAccessibility</span><span style="color:#f92672">(</span>View<span style="color:#f92672">.</span><span style="color:#a6e22e">IMPORTANT_FOR_ACCESSIBILITY_YES</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#75715e">// Set up the input pipeline.
</span><span style="color:#75715e"></span>                CharSequence counterSuffix <span style="color:#f92672">=</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">getTitle</span><span style="color:#f92672">();</span>
                mSyntheticInputStage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SyntheticInputStage<span style="color:#f92672">();</span>
                InputStage viewPostImeStage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ViewPostImeInputStage<span style="color:#f92672">(</span>mSyntheticInputStage<span style="color:#f92672">);</span>
                InputStage nativePostImeStage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NativePostImeInputStage<span style="color:#f92672">(</span>viewPostImeStage<span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;aq:native-post-ime:&#34;</span> <span style="color:#f92672">+</span> counterSuffix<span style="color:#f92672">);</span>
                InputStage earlyPostImeStage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EarlyPostImeInputStage<span style="color:#f92672">(</span>nativePostImeStage<span style="color:#f92672">);</span>
                InputStage imeStage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ImeInputStage<span style="color:#f92672">(</span>earlyPostImeStage<span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;aq:ime:&#34;</span> <span style="color:#f92672">+</span> counterSuffix<span style="color:#f92672">);</span>
                InputStage viewPreImeStage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ViewPreImeInputStage<span style="color:#f92672">(</span>imeStage<span style="color:#f92672">);</span>
                InputStage nativePreImeStage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NativePreImeInputStage<span style="color:#f92672">(</span>viewPreImeStage<span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;aq:native-pre-ime:&#34;</span> <span style="color:#f92672">+</span> counterSuffix<span style="color:#f92672">);</span>

                mFirstInputStage <span style="color:#f92672">=</span> nativePreImeStage<span style="color:#f92672">;</span>
                mFirstPostImeInputStage <span style="color:#f92672">=</span> earlyPostImeStage<span style="color:#f92672">;</span>
                mPendingInputEventQueueLengthCounterName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;aq:pending:&#34;</span> <span style="color:#f92672">+</span> counterSuffix<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">requestLayout</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mHandlingLayoutInLayoutRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            checkThread<span style="color:#f92672">();</span>
            mLayoutRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            scheduleTraversals<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>最终调用到ViewRootImpl的requestLayout()进行首次布局遍历，完成布局的绘制。然后添加Window进行界面展示，这里拿到一个窗口会话WindowSession，并调用其addToDisplay方法：</p>
<p>Session.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">addToDisplay</span><span style="color:#f92672">(</span>IWindow window<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> seq<span style="color:#f92672">,</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> attrs<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> viewVisibility<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> displayId<span style="color:#f92672">,</span> Rect outContentInsets<span style="color:#f92672">,</span> Rect outStableInsets<span style="color:#f92672">,</span>
            Rect outOutsets<span style="color:#f92672">,</span> InputChannel outInputChannel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">addWindow</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> window<span style="color:#f92672">,</span> seq<span style="color:#f92672">,</span> attrs<span style="color:#f92672">,</span> viewVisibility<span style="color:#f92672">,</span> displayId<span style="color:#f92672">,</span>
                outContentInsets<span style="color:#f92672">,</span> outStableInsets<span style="color:#f92672">,</span> outOutsets<span style="color:#f92672">,</span> outInputChannel<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> 
</code></pre></div><p>实际上调用到的是WindowManagerService的添加窗口的方法：</p>
<p>WindowManagerService.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">addWindow</span><span style="color:#f92672">(</span>Session session<span style="color:#f92672">,</span> IWindow client<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> seq<span style="color:#f92672">,</span>
            WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> attrs<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> viewVisibility<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> displayId<span style="color:#f92672">,</span>
            Rect outContentInsets<span style="color:#f92672">,</span> Rect outStableInsets<span style="color:#f92672">,</span> Rect outOutsets<span style="color:#f92672">,</span>
            InputChannel outInputChannel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> appOp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[</span>1<span style="color:#f92672">];</span>
        <span style="color:#66d9ef">int</span> res <span style="color:#f92672">=</span> mPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">checkAddPermission</span><span style="color:#f92672">(</span>attrs<span style="color:#f92672">,</span> appOp<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>res <span style="color:#f92672">!=</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_OKAY</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> res<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">boolean</span> reportNewConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        WindowState parentWindow <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> origId<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> callingUid <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallingUid</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> type <span style="color:#f92672">=</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">synchronized</span><span style="color:#f92672">(</span>mWindowMap<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mDisplayReady<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Display has not been initialialized&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">final</span> DisplayContent displayContent <span style="color:#f92672">=</span> mRoot<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayContentOrCreate</span><span style="color:#f92672">(</span>displayId<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>displayContent <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add window to a display that does not exist: &#34;</span>
                        <span style="color:#f92672">+</span> displayId <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_INVALID_DISPLAY</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">hasAccess</span><span style="color:#f92672">(</span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">mUid</span><span style="color:#f92672">)</span>
                    <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mDisplayManagerInternal<span style="color:#f92672">.</span><span style="color:#a6e22e">isUidPresentOnDisplay</span><span style="color:#f92672">(</span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">mUid</span><span style="color:#f92672">,</span> displayId<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add window to a display for which the application &#34;</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;does not have access: &#34;</span> <span style="color:#f92672">+</span> displayId <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_INVALID_DISPLAY</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mWindowMap<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>client<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Window &#34;</span> <span style="color:#f92672">+</span> client <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; is already added&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_DUPLICATE_ADD</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">&gt;=</span> FIRST_SUB_WINDOW <span style="color:#f92672">&amp;&amp;</span> type <span style="color:#f92672">&lt;=</span> LAST_SUB_WINDOW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                parentWindow <span style="color:#f92672">=</span> windowForClientLocked<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>parentWindow <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add window with token that is not a window: &#34;</span>
                          <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_SUBWINDOW_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>parentWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mAttrs</span><span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">&gt;=</span> FIRST_SUB_WINDOW
                        <span style="color:#f92672">&amp;&amp;</span> parentWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mAttrs</span><span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">&lt;=</span> LAST_SUB_WINDOW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add window with token that is a sub-window: &#34;</span>
                            <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_SUBWINDOW_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> TYPE_PRIVATE_PRESENTATION <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">isPrivate</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add private presentation window to a non-private display.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_PERMISSION_DENIED</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            AppWindowToken atoken <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> hasParent <span style="color:#f92672">=</span> parentWindow <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// Use existing parent window token for child windows since they go in the same token
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// as there parent window so we can apply the same policy on them.
</span><span style="color:#75715e"></span>            WindowToken token <span style="color:#f92672">=</span> displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindowToken</span><span style="color:#f92672">(</span>
                    hasParent <span style="color:#f92672">?</span> parentWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mAttrs</span><span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">:</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">// If this is a child window, we want to apply the same type checking rules as the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// parent window type.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> rootType <span style="color:#f92672">=</span> hasParent <span style="color:#f92672">?</span> parentWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mAttrs</span><span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">:</span> type<span style="color:#f92672">;</span>

            <span style="color:#66d9ef">boolean</span> addToastWindowRequiresToken <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>token <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">&gt;=</span> FIRST_APPLICATION_WINDOW <span style="color:#f92672">&amp;&amp;</span> rootType <span style="color:#f92672">&lt;=</span> LAST_APPLICATION_WINDOW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add application window with unknown token &#34;</span>
                          <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_INPUT_METHOD<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add input method window with unknown token &#34;</span>
                          <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_VOICE_INTERACTION<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add voice interaction window with unknown token &#34;</span>
                          <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_WALLPAPER<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add wallpaper window with unknown token &#34;</span>
                          <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_DREAM<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add Dream window with unknown token &#34;</span>
                          <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_QS_DIALOG<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add QS dialog window with unknown token &#34;</span>
                          <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_ACCESSIBILITY_OVERLAY<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add Accessibility overlay window with unknown token &#34;</span>
                            <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> TYPE_TOAST<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Apps targeting SDK above N MR1 cannot arbitrary add toast windows.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>doesAddToastWindowRequireToken<span style="color:#f92672">(</span>attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span> callingUid<span style="color:#f92672">,</span>
                            parentWindow<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add a toast window with unknown token &#34;</span>
                                <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">final</span> IBinder binder <span style="color:#f92672">=</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">:</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">();</span>
                token <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WindowToken<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> binder<span style="color:#f92672">,</span> type<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> displayContent<span style="color:#f92672">,</span>
                        session<span style="color:#f92672">.</span><span style="color:#a6e22e">mCanAddInternalSystemWindow</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">&gt;=</span> FIRST_APPLICATION_WINDOW <span style="color:#f92672">&amp;&amp;</span> rootType <span style="color:#f92672">&lt;=</span> LAST_APPLICATION_WINDOW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                atoken <span style="color:#f92672">=</span> token<span style="color:#f92672">.</span><span style="color:#a6e22e">asAppWindowToken</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>atoken <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add window with non-application token &#34;</span>
                          <span style="color:#f92672">+</span> token <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_NOT_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>atoken<span style="color:#f92672">.</span><span style="color:#a6e22e">removed</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add window with exiting application token &#34;</span>
                          <span style="color:#f92672">+</span> token <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_APP_EXITING</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_INPUT_METHOD<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>token<span style="color:#f92672">.</span><span style="color:#a6e22e">windowType</span> <span style="color:#f92672">!=</span> TYPE_INPUT_METHOD<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add input method window with bad token &#34;</span>
                            <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                      <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_VOICE_INTERACTION<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>token<span style="color:#f92672">.</span><span style="color:#a6e22e">windowType</span> <span style="color:#f92672">!=</span> TYPE_VOICE_INTERACTION<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add voice interaction window with bad token &#34;</span>
                            <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                      <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_WALLPAPER<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>token<span style="color:#f92672">.</span><span style="color:#a6e22e">windowType</span> <span style="color:#f92672">!=</span> TYPE_WALLPAPER<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add wallpaper window with bad token &#34;</span>
                            <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                      <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_DREAM<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>token<span style="color:#f92672">.</span><span style="color:#a6e22e">windowType</span> <span style="color:#f92672">!=</span> TYPE_DREAM<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add Dream window with bad token &#34;</span>
                            <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                      <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rootType <span style="color:#f92672">==</span> TYPE_ACCESSIBILITY_OVERLAY<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>token<span style="color:#f92672">.</span><span style="color:#a6e22e">windowType</span> <span style="color:#f92672">!=</span> TYPE_ACCESSIBILITY_OVERLAY<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add Accessibility overlay window with bad token &#34;</span>
                            <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> TYPE_TOAST<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Apps targeting SDK above N MR1 cannot arbitrary add toast windows.
</span><span style="color:#75715e"></span>                addToastWindowRequiresToken <span style="color:#f92672">=</span> doesAddToastWindowRequireToken<span style="color:#f92672">(</span>attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span>
                        callingUid<span style="color:#f92672">,</span> parentWindow<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>addToastWindowRequiresToken <span style="color:#f92672">&amp;&amp;</span> token<span style="color:#f92672">.</span><span style="color:#a6e22e">windowType</span> <span style="color:#f92672">!=</span> TYPE_TOAST<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add a toast window with bad token &#34;</span>
                            <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> TYPE_QS_DIALOG<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>token<span style="color:#f92672">.</span><span style="color:#a6e22e">windowType</span> <span style="color:#f92672">!=</span> TYPE_QS_DIALOG<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Attempted to add QS dialog window with bad token &#34;</span>
                            <span style="color:#f92672">+</span> attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.  Aborting.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_BAD_APP_TOKEN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>token<span style="color:#f92672">.</span><span style="color:#a6e22e">asAppWindowToken</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Non-null appWindowToken for system window of rootType=&#34;</span> <span style="color:#f92672">+</span> rootType<span style="color:#f92672">);</span>
                <span style="color:#75715e">// It is not valid to use an app token with other system types; we will
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// instead make a new token for it (as if null had been passed in for the token).
</span><span style="color:#75715e"></span>                attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                token <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WindowToken<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">(),</span> type<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> displayContent<span style="color:#f92672">,</span>
                        session<span style="color:#f92672">.</span><span style="color:#a6e22e">mCanAddInternalSystemWindow</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">final</span> WindowState win <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WindowState<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> session<span style="color:#f92672">,</span> client<span style="color:#f92672">,</span> token<span style="color:#f92672">,</span> parentWindow<span style="color:#f92672">,</span>
                    appOp<span style="color:#f92672">[</span>0<span style="color:#f92672">],</span> seq<span style="color:#f92672">,</span> attrs<span style="color:#f92672">,</span> viewVisibility<span style="color:#f92672">,</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">mUid</span><span style="color:#f92672">,</span>
                    session<span style="color:#f92672">.</span><span style="color:#a6e22e">mCanAddInternalSystemWindow</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>win<span style="color:#f92672">.</span><span style="color:#a6e22e">mDeathRecipient</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Client has apparently died, so there is no reason to
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// continue.
</span><span style="color:#75715e"></span>                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Adding window client &#34;</span> <span style="color:#f92672">+</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; that is dead, aborting.&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_APP_EXITING</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>win<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayContent</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Adding window to Display that has been removed.&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_INVALID_DISPLAY</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            mPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">adjustWindowParamsLw</span><span style="color:#f92672">(</span>win<span style="color:#f92672">.</span><span style="color:#a6e22e">mAttrs</span><span style="color:#f92672">);</span>
            win<span style="color:#f92672">.</span><span style="color:#a6e22e">setShowToOwnerOnlyLocked</span><span style="color:#f92672">(</span>mPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">checkShowToOwnerOnly</span><span style="color:#f92672">(</span>attrs<span style="color:#f92672">));</span>

            res <span style="color:#f92672">=</span> mPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareAddWindowLw</span><span style="color:#f92672">(</span>win<span style="color:#f92672">,</span> attrs<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>res <span style="color:#f92672">!=</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_OKAY</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> res<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> openInputChannels <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>outInputChannel <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                    <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">inputFeatures</span> <span style="color:#f92672">&amp;</span> INPUT_FEATURE_NO_INPUT_CHANNEL<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span>  <span style="color:#f92672">(</span>openInputChannels<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                win<span style="color:#f92672">.</span><span style="color:#a6e22e">openInputChannel</span><span style="color:#f92672">(</span>outInputChannel<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// If adding a toast requires a token for this app we always schedule hiding
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// toast windows to make sure they don&#39;t stick around longer then necessary.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// We hide instead of remove such windows as apps aren&#39;t prepared to handle
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// windows being removed under them.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">//
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// If the app is older it can add toasts without a token and hence overlay
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// other apps. To be maximally compatible with these apps we will hide the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// window after the toast timeout only if the focused window is from another
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// UID, otherwise we allow unlimited duration. When a UID looses focus we
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// schedule hiding all of its toast windows.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> TYPE_TOAST<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>getDefaultDisplayContentLocked<span style="color:#f92672">().</span><span style="color:#a6e22e">canAddToastWindowForUid</span><span style="color:#f92672">(</span>callingUid<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Adding more than one toast window for UID at a time.&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_DUPLICATE_ADD</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">// Make sure this happens before we moved focus as one can make the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// toast focusable to force it not being hidden after the timeout.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Focusable toasts are always timed out to prevent a focused app to
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// show a focusable toasts while it has focus which will be kept on
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the screen after the activity goes away.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>addToastWindowRequiresToken
                        <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_NOT_FOCUSABLE</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0
                        <span style="color:#f92672">||</span> mCurrentFocus <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>
                        <span style="color:#f92672">||</span> mCurrentFocus<span style="color:#f92672">.</span><span style="color:#a6e22e">mOwnerUid</span> <span style="color:#f92672">!=</span> callingUid<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mH<span style="color:#f92672">.</span><span style="color:#a6e22e">sendMessageDelayed</span><span style="color:#f92672">(</span>
                            mH<span style="color:#f92672">.</span><span style="color:#a6e22e">obtainMessage</span><span style="color:#f92672">(</span>H<span style="color:#f92672">.</span><span style="color:#a6e22e">WINDOW_HIDE_TIMEOUT</span><span style="color:#f92672">,</span> win<span style="color:#f92672">),</span>
                            win<span style="color:#f92672">.</span><span style="color:#a6e22e">mAttrs</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hideTimeoutMilliseconds</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// From now on, no exceptions or errors allowed!
</span><span style="color:#75715e"></span>
            res <span style="color:#f92672">=</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_OKAY</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mCurrentFocus <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mWinAddedSinceNullFocus<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>win<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>excludeWindowTypeFromTapOutTask<span style="color:#f92672">(</span>type<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">mTapExcludedWindows</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>win<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            origId <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">clearCallingIdentity</span><span style="color:#f92672">();</span>

            win<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">();</span>
            mWindowMap<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>client<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">(),</span> win<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>win<span style="color:#f92672">.</span><span style="color:#a6e22e">mAppOp</span> <span style="color:#f92672">!=</span> AppOpsManager<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_NONE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">int</span> startOpResult <span style="color:#f92672">=</span> mAppOps<span style="color:#f92672">.</span><span style="color:#a6e22e">startOpNoThrow</span><span style="color:#f92672">(</span>win<span style="color:#f92672">.</span><span style="color:#a6e22e">mAppOp</span><span style="color:#f92672">,</span> win<span style="color:#f92672">.</span><span style="color:#a6e22e">getOwningUid</span><span style="color:#f92672">(),</span>
                        win<span style="color:#f92672">.</span><span style="color:#a6e22e">getOwningPackage</span><span style="color:#f92672">());</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>startOpResult <span style="color:#f92672">!=</span> AppOpsManager<span style="color:#f92672">.</span><span style="color:#a6e22e">MODE_ALLOWED</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                        <span style="color:#f92672">(</span>startOpResult <span style="color:#f92672">!=</span> AppOpsManager<span style="color:#f92672">.</span><span style="color:#a6e22e">MODE_DEFAULT</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    win<span style="color:#f92672">.</span><span style="color:#a6e22e">setAppOpVisibilityLw</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> hideSystemAlertWindows <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mHidingNonSystemOverlayWindows<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">();</span>
            win<span style="color:#f92672">.</span><span style="color:#a6e22e">setForceHideNonSystemOverlayWindowIfNeeded</span><span style="color:#f92672">(</span>hideSystemAlertWindows<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">final</span> AppWindowToken aToken <span style="color:#f92672">=</span> token<span style="color:#f92672">.</span><span style="color:#a6e22e">asAppWindowToken</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> TYPE_APPLICATION_STARTING <span style="color:#f92672">&amp;&amp;</span> aToken <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                aToken<span style="color:#f92672">.</span><span style="color:#a6e22e">startingWindow</span> <span style="color:#f92672">=</span> win<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STARTING_WINDOW<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span> <span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;addWindow: &#34;</span> <span style="color:#f92672">+</span> aToken
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; startingWindow=&#34;</span> <span style="color:#f92672">+</span> win<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">boolean</span> imMayMove <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

            win<span style="color:#f92672">.</span><span style="color:#a6e22e">mToken</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addWindow</span><span style="color:#f92672">(</span>win<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> TYPE_INPUT_METHOD<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                win<span style="color:#f92672">.</span><span style="color:#a6e22e">mGivenInsetsPending</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                setInputMethodWindowLocked<span style="color:#f92672">(</span>win<span style="color:#f92672">);</span>
                imMayMove <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> TYPE_INPUT_METHOD_DIALOG<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">computeImeTarget</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span> <span style="color:#75715e">/* updateImeTarget */</span><span style="color:#f92672">);</span>
                imMayMove <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> TYPE_WALLPAPER<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">mWallpaperController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">clearLastWallpaperTimeoutTime</span><span style="color:#f92672">();</span>
                    displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingLayoutChanges</span> <span style="color:#f92672">|=</span> FINISH_LAYOUT_REDO_WALLPAPER<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>attrs<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span><span style="color:#f92672">&amp;</span>FLAG_SHOW_WALLPAPER<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingLayoutChanges</span> <span style="color:#f92672">|=</span> FINISH_LAYOUT_REDO_WALLPAPER<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">mWallpaperController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isBelowWallpaperTarget</span><span style="color:#f92672">(</span>win<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// If there is currently a wallpaper being shown, and
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// the base layer of the new window is below the current
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// layer of the target window, then adjust the wallpaper.
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// This is to avoid a new window being placed between the
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// wallpaper and its target.
</span><span style="color:#75715e"></span>                    displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingLayoutChanges</span> <span style="color:#f92672">|=</span> FINISH_LAYOUT_REDO_WALLPAPER<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// If the window is being added to a stack that&#39;s currently adjusted for IME,
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// make sure to apply the same adjust to this new window.
</span><span style="color:#75715e"></span>            win<span style="color:#f92672">.</span><span style="color:#a6e22e">applyAdjustForImeIfNeeded</span><span style="color:#f92672">();</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> TYPE_DOCK_DIVIDER<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mRoot<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayContent</span><span style="color:#f92672">(</span>displayId<span style="color:#f92672">).</span><span style="color:#a6e22e">getDockedDividerController</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setWindow</span><span style="color:#f92672">(</span>win<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">final</span> WindowStateAnimator winAnimator <span style="color:#f92672">=</span> win<span style="color:#f92672">.</span><span style="color:#a6e22e">mWinAnimator</span><span style="color:#f92672">;</span>
            winAnimator<span style="color:#f92672">.</span><span style="color:#a6e22e">mEnterAnimationPending</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            winAnimator<span style="color:#f92672">.</span><span style="color:#a6e22e">mEnteringAnimation</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// Check if we need to prepare a transition for replacing window first.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>atoken <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> atoken<span style="color:#f92672">.</span><span style="color:#a6e22e">isVisible</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>prepareWindowReplacementTransition<span style="color:#f92672">(</span>atoken<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If not, check if need to set up a dummy transition during display freeze
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// so that the unfreeze wait for the apps to draw. This might be needed if
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the app is relaunching.
</span><span style="color:#75715e"></span>                prepareNoneTransitionForRelaunching<span style="color:#f92672">(</span>atoken<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">isDefaultDisplay</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> DisplayInfo displayInfo <span style="color:#f92672">=</span> displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayInfo</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">final</span> Rect taskBounds<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>atoken <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> atoken<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    taskBounds <span style="color:#f92672">=</span> mTmpRect<span style="color:#f92672">;</span>
                    atoken<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getBounds</span><span style="color:#f92672">(</span>mTmpRect<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    taskBounds <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">getInsetHintLw</span><span style="color:#f92672">(</span>win<span style="color:#f92672">.</span><span style="color:#a6e22e">mAttrs</span><span style="color:#f92672">,</span> taskBounds<span style="color:#f92672">,</span> displayInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">rotation</span><span style="color:#f92672">,</span>
                        displayInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">logicalWidth</span><span style="color:#f92672">,</span> displayInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">logicalHeight</span><span style="color:#f92672">,</span> outContentInsets<span style="color:#f92672">,</span>
                        outStableInsets<span style="color:#f92672">,</span> outOutsets<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    res <span style="color:#f92672">|=</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_FLAG_ALWAYS_CONSUME_NAV_BAR</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                outContentInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">setEmpty</span><span style="color:#f92672">();</span>
                outStableInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">setEmpty</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mInTouchMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                res <span style="color:#f92672">|=</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_FLAG_IN_TOUCH_MODE</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>win<span style="color:#f92672">.</span><span style="color:#a6e22e">mAppToken</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>win<span style="color:#f92672">.</span><span style="color:#a6e22e">mAppToken</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isClientHidden</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                res <span style="color:#f92672">|=</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">ADD_FLAG_APP_VISIBLE</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            mInputMonitor<span style="color:#f92672">.</span><span style="color:#a6e22e">setUpdateInputWindowsNeededLw</span><span style="color:#f92672">();</span>

            <span style="color:#66d9ef">boolean</span> focusChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>win<span style="color:#f92672">.</span><span style="color:#a6e22e">canReceiveKeys</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                focusChanged <span style="color:#f92672">=</span> updateFocusedWindowLocked<span style="color:#f92672">(</span>UPDATE_FOCUS_WILL_ASSIGN_LAYERS<span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">false</span> <span style="color:#75715e">/*updateInputWindows*/</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>focusChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    imMayMove <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>imMayMove<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">computeImeTarget</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span> <span style="color:#75715e">/* updateImeTarget */</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Don&#39;t do layout here, the window must call
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// relayout to be displayed, so we&#39;ll do it there.
</span><span style="color:#75715e"></span>            displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">assignWindowLayers</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span> <span style="color:#75715e">/* setLayoutNeeded */</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>focusChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mInputMonitor<span style="color:#f92672">.</span><span style="color:#a6e22e">setInputFocusLw</span><span style="color:#f92672">(</span>mCurrentFocus<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">/*updateInputWindows*/</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            mInputMonitor<span style="color:#f92672">.</span><span style="color:#a6e22e">updateInputWindowsLw</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span> <span style="color:#75715e">/*force*/</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV <span style="color:#f92672">||</span> DEBUG_ADD_REMOVE<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;addWindow: New client &#34;</span>
                    <span style="color:#f92672">+</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: window=&#34;</span> <span style="color:#f92672">+</span> win <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; Callers=&#34;</span> <span style="color:#f92672">+</span> Debug<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallers</span><span style="color:#f92672">(</span>5<span style="color:#f92672">));</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>win<span style="color:#f92672">.</span><span style="color:#a6e22e">isVisibleOrAdding</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> updateOrientationFromAppTokensLocked<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> displayId<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                reportNewConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>reportNewConfig<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            sendNewConfiguration<span style="color:#f92672">(</span>displayId<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">restoreCallingIdentity</span><span style="color:#f92672">(</span>origId<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> res<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

        <span style="color:#75715e">// TODO: Move to DisplayContent
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">updateFocusedWindowLocked</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> mode<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> updateInputWindows<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        WindowState newFocus <span style="color:#f92672">=</span> mRoot<span style="color:#f92672">.</span><span style="color:#a6e22e">computeFocusedWindow</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mCurrentFocus <span style="color:#f92672">!=</span> newFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>TRACE_TAG_WINDOW_MANAGER<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;wmUpdateFocus&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">// This check makes sure that we don&#39;t already have the focus
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// change message pending.
</span><span style="color:#75715e"></span>            mH<span style="color:#f92672">.</span><span style="color:#a6e22e">removeMessages</span><span style="color:#f92672">(</span>H<span style="color:#f92672">.</span><span style="color:#a6e22e">REPORT_FOCUS_CHANGE</span><span style="color:#f92672">);</span>
            mH<span style="color:#f92672">.</span><span style="color:#a6e22e">sendEmptyMessage</span><span style="color:#f92672">(</span>H<span style="color:#f92672">.</span><span style="color:#a6e22e">REPORT_FOCUS_CHANGE</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">// TODO(multidisplay): Focused windows on default display only.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> DisplayContent displayContent <span style="color:#f92672">=</span> getDefaultDisplayContentLocked<span style="color:#f92672">();</span>
            <span style="color:#66d9ef">boolean</span> imWindowChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mInputMethodWindow <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> WindowState prevTarget <span style="color:#f92672">=</span> mInputMethodTarget<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">final</span> WindowState newTarget <span style="color:#f92672">=</span>
                        displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">computeImeTarget</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span> <span style="color:#75715e">/* updateImeTarget*/</span><span style="color:#f92672">);</span>

                imWindowChanged <span style="color:#f92672">=</span> prevTarget <span style="color:#f92672">!=</span> newTarget<span style="color:#f92672">;</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mode <span style="color:#f92672">!=</span> UPDATE_FOCUS_WILL_ASSIGN_LAYERS
                        <span style="color:#f92672">&amp;&amp;</span> mode <span style="color:#f92672">!=</span> UPDATE_FOCUS_WILL_PLACE_SURFACES<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> prevImeAnimLayer <span style="color:#f92672">=</span> mInputMethodWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mWinAnimator</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mAnimLayer</span><span style="color:#f92672">;</span>
                    displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">assignWindowLayers</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span> <span style="color:#75715e">/* setLayoutNeeded */</span><span style="color:#f92672">);</span>
                    imWindowChanged <span style="color:#f92672">|=</span>
                            prevImeAnimLayer <span style="color:#f92672">!=</span> mInputMethodWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mWinAnimator</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mAnimLayer</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>imWindowChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mWindowsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">setLayoutNeeded</span><span style="color:#f92672">();</span>
                newFocus <span style="color:#f92672">=</span> mRoot<span style="color:#f92672">.</span><span style="color:#a6e22e">computeFocusedWindow</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_FOCUS_LIGHT <span style="color:#f92672">||</span> localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Changing focus from &#34;</span> <span style="color:#f92672">+</span>
                    mCurrentFocus <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; to &#34;</span> <span style="color:#f92672">+</span> newFocus <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; Callers=&#34;</span> <span style="color:#f92672">+</span> Debug<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallers</span><span style="color:#f92672">(</span>4<span style="color:#f92672">));</span>
            <span style="color:#66d9ef">final</span> WindowState oldFocus <span style="color:#f92672">=</span> mCurrentFocus<span style="color:#f92672">;</span>
            mCurrentFocus <span style="color:#f92672">=</span> newFocus<span style="color:#f92672">;</span>
            mLosingFocus<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>newFocus<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mCurrentFocus <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mWinAddedSinceNullFocus<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
                mWinRemovedSinceNullFocus<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">int</span> focusChanged <span style="color:#f92672">=</span> mPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">focusChangedLw</span><span style="color:#f92672">(</span>oldFocus<span style="color:#f92672">,</span> newFocus<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>imWindowChanged <span style="color:#f92672">&amp;&amp;</span> oldFocus <span style="color:#f92672">!=</span> mInputMethodWindow<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Focus of the input method window changed. Perform layout if needed.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mode <span style="color:#f92672">==</span> UPDATE_FOCUS_PLACING_SURFACES<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">performLayout</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span> <span style="color:#75715e">/*initial*/</span><span style="color:#f92672">,</span>  updateInputWindows<span style="color:#f92672">);</span>
                    focusChanged <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>FINISH_LAYOUT_REDO_LAYOUT<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mode <span style="color:#f92672">==</span> UPDATE_FOCUS_WILL_PLACE_SURFACES<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Client will do the layout, but we need to assign layers
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// for handleNewWindowLocked() below.
</span><span style="color:#75715e"></span>                    displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">assignWindowLayers</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span> <span style="color:#75715e">/* setLayoutNeeded */</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>focusChanged <span style="color:#f92672">&amp;</span> FINISH_LAYOUT_REDO_LAYOUT<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// The change in focus caused us to need to do a layout.  Okay.
</span><span style="color:#75715e"></span>                displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">setLayoutNeeded</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mode <span style="color:#f92672">==</span> UPDATE_FOCUS_PLACING_SURFACES<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">performLayout</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span> <span style="color:#75715e">/*initial*/</span><span style="color:#f92672">,</span> updateInputWindows<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mode <span style="color:#f92672">!=</span> UPDATE_FOCUS_WILL_ASSIGN_LAYERS<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If we defer assigning layers, then the caller is responsible for
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// doing this part.
</span><span style="color:#75715e"></span>                mInputMonitor<span style="color:#f92672">.</span><span style="color:#a6e22e">setInputFocusLw</span><span style="color:#f92672">(</span>mCurrentFocus<span style="color:#f92672">,</span> updateInputWindows<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">adjustForImeIfNeeded</span><span style="color:#f92672">();</span>

            <span style="color:#75715e">// We may need to schedule some toast windows to be removed. The toasts for an app that
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// does not have input focus are removed within a timeout to prevent apps to redress
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// other apps&#39; UI.
</span><span style="color:#75715e"></span>            displayContent<span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleToastWindowsTimeoutIfNeededLocked</span><span style="color:#f92672">(</span>oldFocus<span style="color:#f92672">,</span> newFocus<span style="color:#f92672">);</span>

            Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>TRACE_TAG_WINDOW_MANAGER<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleMessage</span><span style="color:#f92672">(</span>Message msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_WINDOW_TRACE<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;handleMessage: entry what=&#34;</span> <span style="color:#f92672">+</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">what</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">what</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">case</span> REPORT_FOCUS_CHANGE<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
                    WindowState lastFocus<span style="color:#f92672">;</span>
                    WindowState newFocus<span style="color:#f92672">;</span>

                    AccessibilityController accessibilityController <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

                    <span style="color:#66d9ef">synchronized</span><span style="color:#f92672">(</span>mWindowMap<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// TODO(multidisplay): Accessibility supported only of default desiplay.
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAccessibilityController <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> getDefaultDisplayContentLocked<span style="color:#f92672">()</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayId</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> DEFAULT_DISPLAY<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            accessibilityController <span style="color:#f92672">=</span> mAccessibilityController<span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>

                        lastFocus <span style="color:#f92672">=</span> mLastFocus<span style="color:#f92672">;</span>
                        newFocus <span style="color:#f92672">=</span> mCurrentFocus<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lastFocus <span style="color:#f92672">==</span> newFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#75715e">// Focus is not changing, so nothing to do.
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                        mLastFocus <span style="color:#f92672">=</span> newFocus<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_FOCUS_LIGHT<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Focus moving from &#34;</span> <span style="color:#f92672">+</span> lastFocus <span style="color:#f92672">+</span>
                                <span style="color:#e6db74">&#34; to &#34;</span> <span style="color:#f92672">+</span> newFocus<span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>newFocus <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> lastFocus <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>newFocus<span style="color:#f92672">.</span><span style="color:#a6e22e">isDisplayedLw</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                            <span style="color:#75715e">//Slog.i(TAG_WM, &#34;Delaying loss of focus...&#34;);
</span><span style="color:#75715e"></span>                            mLosingFocus<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>lastFocus<span style="color:#f92672">);</span>
                            lastFocus <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>

                    <span style="color:#75715e">// First notify the accessibility manager for the change so it has
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// the windows before the newly focused one starts firing eventgs.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>accessibilityController <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        accessibilityController<span style="color:#f92672">.</span><span style="color:#a6e22e">onWindowFocusChangedNotLocked</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>

                    <span style="color:#75715e">//System.out.println(&#34;Changing focus from &#34; + lastFocus
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">//                   + &#34; to &#34; + newFocus);
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>newFocus <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_FOCUS_LIGHT<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Gaining focus: &#34;</span> <span style="color:#f92672">+</span> newFocus<span style="color:#f92672">);</span>
                        newFocus<span style="color:#f92672">.</span><span style="color:#a6e22e">reportFocusChangedSerialized</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> mInTouchMode<span style="color:#f92672">);</span>
                        notifyFocusChanged<span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>

                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lastFocus <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_FOCUS_LIGHT<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>TAG_WM<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Losing focus: &#34;</span> <span style="color:#f92672">+</span> lastFocus<span style="color:#f92672">);</span>
                        lastFocus<span style="color:#f92672">.</span><span style="color:#a6e22e">reportFocusChangedSerialized</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> mInTouchMode<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">...</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
</code></pre></div><p>WindowState.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Report a focus change.  Must be called with no locks held, and consistently
</span><span style="color:#75715e">     * from the same serialized thread (such as dispatched from a handler).
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">reportFocusChangedSerialized</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> focused<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> inTouchMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            mClient<span style="color:#f92672">.</span><span style="color:#a6e22e">windowFocusChanged</span><span style="color:#f92672">(</span>focused<span style="color:#f92672">,</span> inTouchMode<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFocusCallbacks <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> N <span style="color:#f92672">=</span> mFocusCallbacks<span style="color:#f92672">.</span><span style="color:#a6e22e">beginBroadcast</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span> i<span style="color:#f92672">&lt;</span>N<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                IWindowFocusObserver obs <span style="color:#f92672">=</span> mFocusCallbacks<span style="color:#f92672">.</span><span style="color:#a6e22e">getBroadcastItem</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>focused<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        obs<span style="color:#f92672">.</span><span style="color:#a6e22e">focusGained</span><span style="color:#f92672">(</span>mWindowId<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">());</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        obs<span style="color:#f92672">.</span><span style="color:#a6e22e">focusLost</span><span style="color:#f92672">(</span>mWindowId<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">());</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            mFocusCallbacks<span style="color:#f92672">.</span><span style="color:#a6e22e">finishBroadcast</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>IWindow.aidl</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * API back to a client window that the Window Manager uses to inform it of
</span><span style="color:#75715e"> * interesting things happening.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * {@hide}
</span><span style="color:#75715e"> */</span>
oneway <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IWindow</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * ===== NOTICE =====
</span><span style="color:#75715e">     * The first method must remain the first method. Scripts
</span><span style="color:#75715e">     * and tools rely on their transaction number to work properly.
</span><span style="color:#75715e">     */</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Invoked by the view server to tell a window to execute the specified
</span><span style="color:#75715e">     * command. Any response from the receiver must be sent through the
</span><span style="color:#75715e">     * specified file descriptor.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">executeCommand</span><span style="color:#f92672">(</span>String command<span style="color:#f92672">,</span> String parameters<span style="color:#f92672">,</span> in ParcelFileDescriptor descriptor<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">resized</span><span style="color:#f92672">(</span>in Rect frame<span style="color:#f92672">,</span> in Rect overscanInsets<span style="color:#f92672">,</span> in Rect contentInsets<span style="color:#f92672">,</span>
            in Rect visibleInsets<span style="color:#f92672">,</span> in Rect stableInsets<span style="color:#f92672">,</span> in Rect outsets<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> reportDraw<span style="color:#f92672">,</span>
            in MergedConfiguration newMergedConfiguration<span style="color:#f92672">,</span> in Rect backDropFrame<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> forceLayout<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> alwaysConsumeNavBar<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> displayId<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">moved</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> newX<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> newY<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatchAppVisibility</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> visible<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatchGetNewSurface</span><span style="color:#f92672">();</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Tell the window that it is either gaining or losing focus.  Keep it up
</span><span style="color:#75715e">     * to date on the current state showing navigational focus (touch mode) too.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">windowFocusChanged</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> hasFocus<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> inTouchMode<span style="color:#f92672">)</span>
    <span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ViewRootImpl#W.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">W</span> <span style="color:#66d9ef">extends</span> IWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">Stub</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">...</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">windowFocusChanged</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> hasFocus<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> inTouchMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> ViewRootImpl viewAncestor <span style="color:#f92672">=</span> mViewAncestor<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>viewAncestor <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                viewAncestor<span style="color:#f92672">.</span><span style="color:#a6e22e">windowFocusChanged</span><span style="color:#f92672">(</span>hasFocus<span style="color:#f92672">,</span> inTouchMode<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> 
        <span style="color:#f92672">...</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>ViewRootImpl.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">windowFocusChanged</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> hasFocus<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> inTouchMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Message msg <span style="color:#f92672">=</span> Message<span style="color:#f92672">.</span><span style="color:#a6e22e">obtain</span><span style="color:#f92672">();</span>
        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">what</span> <span style="color:#f92672">=</span> MSG_WINDOW_FOCUS_CHANGED<span style="color:#f92672">;</span>
        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">arg1</span> <span style="color:#f92672">=</span> hasFocus <span style="color:#f92672">?</span> 1 <span style="color:#f92672">:</span> 0<span style="color:#f92672">;</span>
        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">arg2</span> <span style="color:#f92672">=</span> inTouchMode <span style="color:#f92672">?</span> 1 <span style="color:#f92672">:</span> 0<span style="color:#f92672">;</span>
        mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">sendMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleMessage</span><span style="color:#f92672">(</span>Message msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">what</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">...</span>
            <span style="color:#66d9ef">case</span> MSG_WINDOW_FOCUS_CHANGED<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAdded<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">boolean</span> hasWindowFocus <span style="color:#f92672">=</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">arg1</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHasWindowFocus</span> <span style="color:#f92672">=</span> hasWindowFocus<span style="color:#f92672">;</span>

                    profileRendering<span style="color:#f92672">(</span>hasWindowFocus<span style="color:#f92672">);</span>

                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasWindowFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">boolean</span> inTouchMode <span style="color:#f92672">=</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">arg2</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
                        ensureTouchModeLocally<span style="color:#f92672">(</span>inTouchMode<span style="color:#f92672">);</span>

                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">()){</span>
                            mFullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                                <span style="color:#66d9ef">final</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> lp <span style="color:#f92672">=</span> mWindowAttributes<span style="color:#f92672">;</span>
                                <span style="color:#66d9ef">final</span> Rect surfaceInsets <span style="color:#f92672">=</span> lp <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">surfaceInsets</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initializeIfNeeded</span><span style="color:#f92672">(</span>
                                        mWidth<span style="color:#f92672">,</span> mHeight<span style="color:#f92672">,</span> mAttachInfo<span style="color:#f92672">,</span> mSurface<span style="color:#f92672">,</span> surfaceInsets<span style="color:#f92672">);</span>
                            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>OutOfResourcesException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                Log<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;OutOfResourcesException locking surface&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mWindowSession<span style="color:#f92672">.</span><span style="color:#a6e22e">outOfMemory</span><span style="color:#f92672">(</span>mWindow<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                                        Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;No processes killed for memory; killing self&#34;</span><span style="color:#f92672">);</span>
                                        Process<span style="color:#f92672">.</span><span style="color:#a6e22e">killProcess</span><span style="color:#f92672">(</span>Process<span style="color:#f92672">.</span><span style="color:#a6e22e">myPid</span><span style="color:#f92672">());</span>
                                    <span style="color:#f92672">}</span>
                                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                <span style="color:#f92672">}</span>
                                <span style="color:#75715e">// Retry in a bit.
</span><span style="color:#75715e"></span>                                sendMessageDelayed<span style="color:#f92672">(</span>obtainMessage<span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">what</span><span style="color:#f92672">,</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">arg1</span><span style="color:#f92672">,</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">arg2</span><span style="color:#f92672">),</span> 500<span style="color:#f92672">);</span>
                                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>

                    mLastWasImTarget <span style="color:#f92672">=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span>
                            <span style="color:#f92672">.</span><span style="color:#a6e22e">mayUseInputMethod</span><span style="color:#f92672">(</span>mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span><span style="color:#f92672">);</span>

                    InputMethodManager imm <span style="color:#f92672">=</span> InputMethodManager<span style="color:#f92672">.</span><span style="color:#a6e22e">peekInstance</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>imm <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mLastWasImTarget <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>isInLocalFocusMode<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        imm<span style="color:#f92672">.</span><span style="color:#a6e22e">onPreWindowFocus</span><span style="color:#f92672">(</span>mView<span style="color:#f92672">,</span> hasWindowFocus<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mView <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mKeyDispatchState</span><span style="color:#f92672">.</span><span style="color:#a6e22e">reset</span><span style="color:#f92672">();</span>
                        mView<span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchWindowFocusChanged</span><span style="color:#f92672">(</span>hasWindowFocus<span style="color:#f92672">);</span>
                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTreeObserver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchOnWindowFocusChange</span><span style="color:#f92672">(</span>hasWindowFocus<span style="color:#f92672">);</span>

                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTooltipHost</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTooltipHost</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hideTooltip</span><span style="color:#f92672">();</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>

                    <span style="color:#75715e">// Note: must be done after the focus change callbacks,
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// so all of the view state is set up correctly.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasWindowFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>imm <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mLastWasImTarget <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>isInLocalFocusMode<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                            imm<span style="color:#f92672">.</span><span style="color:#a6e22e">onPostWindowFocus</span><span style="color:#f92672">(</span>mView<span style="color:#f92672">,</span> mView<span style="color:#f92672">.</span><span style="color:#a6e22e">findFocus</span><span style="color:#f92672">(),</span>
                                    mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span><span style="color:#f92672">,</span>
                                    <span style="color:#f92672">!</span>mHasHadWindowFocus<span style="color:#f92672">,</span> mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span><span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                        <span style="color:#75715e">// Clear the forward bit.  We can just do this directly, since
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// the window manager doesn&#39;t care about it.
</span><span style="color:#75715e"></span>                        mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">&amp;=</span>
                                <span style="color:#f92672">~</span>WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">((</span>WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">)</span>mView<span style="color:#f92672">.</span><span style="color:#a6e22e">getLayoutParams</span><span style="color:#f92672">())</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">&amp;=</span>
                                    <span style="color:#f92672">~</span>WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span style="color:#f92672">;</span>
                        mHasHadWindowFocus <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mPointerCapture<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            handlePointerCaptureChanged<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">...</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>mView.dispatchWindowFocusChanged(hasWindowFocus)</p>
<p>View.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Called when the window containing this view gains or loses window focus.
</span><span style="color:#75715e">     * ViewGroups should override to route to their children.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param hasFocus True if the window containing this view now has focus,
</span><span style="color:#75715e">     *        false otherwise.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatchWindowFocusChanged</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> hasFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        onWindowFocusChanged<span style="color:#f92672">(</span>hasFocus<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>DecorView.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onWindowFocusChanged</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> hasWindowFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onWindowFocusChanged</span><span style="color:#f92672">(</span>hasWindowFocus<span style="color:#f92672">);</span>

        <span style="color:#75715e">// If the user is chording a menu shortcut, release the chord since
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// this window lost focus
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">hasFeature</span><span style="color:#f92672">(</span>Window<span style="color:#f92672">.</span><span style="color:#a6e22e">FEATURE_OPTIONS_PANEL</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>hasWindowFocus
                <span style="color:#f92672">&amp;&amp;</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mPanelChordingKey</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">closePanel</span><span style="color:#f92672">(</span>Window<span style="color:#f92672">.</span><span style="color:#a6e22e">FEATURE_OPTIONS_PANEL</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> Window<span style="color:#f92672">.</span><span style="color:#a6e22e">Callback</span> cb <span style="color:#f92672">=</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallback</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cb <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">isDestroyed</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> mFeatureId <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            cb<span style="color:#f92672">.</span><span style="color:#a6e22e">onWindowFocusChanged</span><span style="color:#f92672">(</span>hasWindowFocus<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mPrimaryActionMode <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mPrimaryActionMode<span style="color:#f92672">.</span><span style="color:#a6e22e">onWindowFocusChanged</span><span style="color:#f92672">(</span>hasWindowFocus<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFloatingActionMode <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mFloatingActionMode<span style="color:#f92672">.</span><span style="color:#a6e22e">onWindowFocusChanged</span><span style="color:#f92672">(</span>hasWindowFocus<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        updateElevation<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
</code></pre></div>
                </div>
                
            </article>
        </div>
    </div>

                </div>
                <footer>
    Powered by <a target="_blank" href="https://gohugo.io/">Hugo</a> And 
    <a target="_blank" href="https://pages.github.com/">Github Pages</a>
</footer>
                <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
                

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>

                <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.12.0/styles/default.min.css">
                <script src="/js/highlight.pack.js"></script>
                <script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
                <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [
                ['$', '$'],
                ['\\(', '\\)']
            ],
            displayMath: [
                ['$$', '$$']
            ],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });
    MathJax.Hub.Queue(function () {



        var all = MathJax.Hub.getAllJax(),
            i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

    MathJax.Hub.Config({

        TeX: {
            equationNumbers: {
                autoNumber: "AMS"
            }
        }
    });
</script>
                <script type="text/javascript" src="/js/main.js"></script>
        </div>
    </body>

</html>