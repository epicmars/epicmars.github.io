<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Android View绘制流程 | 
    风格与布局
  
</title><meta name="description" content="Android移动应用开发"><meta name="author" content="jastrelax">

<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png " sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0c344b">
<link rel="icon" href="/favicon.ico">




    
        
            <link rel="stylesheet" href="/dist/main.37ab3f61b95417873748.min.css">
        
    




<link rel="canonical" href="https://www.androidpi.com/android/framework/2018-03-08-android-view-drawing-flow/"><meta property="og:title" content="Android View绘制流程" />
<meta property="og:description" content="概述 当一个Activity接收到焦点，它会请求对其布局进行绘制。Android框架会处理绘制的流程，但Activity必须提供布局层次的一个" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.androidpi.com/android/framework/2018-03-08-android-view-drawing-flow/" />
<meta property="article:published_time" content="2018-03-11T15:00:39+08:00" />
<meta property="article:modified_time" content="2018-03-11T15:00:39+08:00" />
<meta itemprop="name" content="Android View绘制流程">
<meta itemprop="description" content="概述 当一个Activity接收到焦点，它会请求对其布局进行绘制。Android框架会处理绘制的流程，但Activity必须提供布局层次的一个">
<meta itemprop="datePublished" content="2018-03-11T15:00:39&#43;08:00" />
<meta itemprop="dateModified" content="2018-03-11T15:00:39&#43;08:00" />
<meta itemprop="wordCount" content="9983">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android View绘制流程"/>
<meta name="twitter:description" content="概述 当一个Activity接收到焦点，它会请求对其布局进行绘制。Android框架会处理绘制的流程，但Activity必须提供布局层次的一个"/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand font-weight-bold" href="https://www.androidpi.com/">风格与布局</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="main-menu">
            <ul class="navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/android/">Android</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/blockchain/">Blockchain</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/book/">Books</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/cs/">CS</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/ee/">EE</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/java/">Java</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/puzzles/">Puzzles</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/web/">Web</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/backend/">后端</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/engineering/">工程与架构</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/dev/">开发</a></li>
                
            
            </ul>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    <div class="row">
        <div class="col">
            <article>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="mb-3">Android View绘制流程</h2>

                        <div class="content">
                            <h2 id="概述">概述</h2>
<p>当一个Activity接收到焦点，它会请求对其布局进行绘制。Android框架会处理绘制的流程，但Activity必须提供布局层次的一个根节点。</p>
<p>绘制从布局的根节点开始，它需要对布局树进行测量并进行绘制。绘制通过遍历布局树对每个与失效区域（invalid region）相交的<code>View</code>进行绘制。依次地，每个<code>ViewGroup</code>请求它的每个子<code>View</code>进行绘制（使用<code>draw()</code>方法）并且每个<code>View</code>负责绘制它自身。因为布局树采用前序遍历，这意味着父View会在子View之前（也就是图层的下方）绘制，同时该父<code>View</code>的兄弟View会以它们在树中出现的顺序进行绘制。</p>
<blockquote>
<p>框架不会绘制失效区域外的<code>View</code>对象，并且会处理好<code>View</code>背景的绘制，你可以通过调用<code>invalidate()</code>方法来强制一个<code>View</code>进行绘制。</p>
</blockquote>
<p>布局的绘制需要经过两个过程的处理：</p>
<ul>
<li>
<p>测量</p>
<p>测量过程在<code>measure(int, int)</code>方法中实现，它是对<code>View</code>树的自上而下的遍历。在递归过程中，每个<code>View</code>将尺寸规范沿树从上往下推，在测量过程的结尾，每个<code>View</code>都存储其测量结果。</p>
</li>
<li>
<p>布局</p>
<p>布局过程在<code>layout(int, int, int, int)</code>中实现，它也是自上而下的。在这个过程中，每个父<code>View</code>负责对其所有子<code>View</code>的位置进行定位，它需要使用测量过程中计算出的视图尺寸。</p>
</li>
</ul>
<p>当一个<code>View</code>对象的<code>measure()</code>方法返回时，其<code>getMeasuredWidth()</code>和<code>getMeasuredHeight()</code>值必须被设定，对于该<code>View</code>的所有子孙<code>View</code>对象也是一样。一个<code>View</code>对象的测量的宽度和高度必须遵循父<code>View</code>施加的约束。这可以保证在测量过程的结尾，所有父视图都接收子视图的测量。一个父视图可能会在其子视图上多次调用<code>measure()</code>方法。例如，父视图可能使用未指定的尺寸规格对所有子视图进行测量，来找到子视图想要有多大，如果所有子视图不受约束的尺寸之和太大或者太小，这时候父视图会使用实际的尺寸规格再次调用<code>measure()</code>（也就是说，如果子视图不同意它们自己获取的空间，那么父视图会在第二次测量过程中介入并设定测量规则）。</p>
<blockquote>
<p>为了初始化一个布局，可以调用<code>requestLayout()</code>。通常当一个<code>View</code>相信它当前的边界已经不适合它了，那么它会在自身上调用该方法。</p>
</blockquote>
<p>测量过程采用两个类对尺寸进行沟通：</p>
<ul>
<li>
<p><code>ViewGroup.LayoutParams</code></p>
<p>用于<code>View</code>对象来告知它们的父级它们想要如何被测量和定位。基础<code>ViewGroup.LayoutParams</code>仅描述了<code>View</code>在宽度和高度上想要有多大。对于每个尺寸，它可以指定如下值：</p>
<ul>
<li>一个确切的数字</li>
<li><code>MATCH_PARENT</code>，表示<code>View</code>想和父级一样大（不包括父级的padding）</li>
<li><code>WRAP_CONTENT</code>，表示<code>View</code>想要刚好足够包围其内容的大小（包括padding）</li>
</ul>
</li>
<li>
<p><code>MeasureSpec</code></p>
<p>用于从上往下将测量需求从父级推给子级。<code>MeasureSpec</code>可以有如下三种模式：</p>
<ul>
<li><code>UNSPECIFIED</code>：一个父视图可以用他来确定一个子<code>View</code>所期望的尺寸。例如，一个<code>LinearLayout</code>可以在其子视图上调用<code>measure()</code>，其中将高度设置为<code>UNSPECIFIED</code>并且宽度设置为<code>EXACTLY</code> <code>240</code>来找出给定一个<code>240</code>像素的宽度时，子视图期望有多高。</li>
<li><code>EXACTLY</code>：用于父视图给子视图施加一个确定的尺寸。子视图必须使用该尺寸，并且保证它所有的后代视图都是符合该尺寸限制的。</li>
<li><code>AT MOST</code>：用于父视图给子视图施加一个最大的尺寸。子视图必须保证它以及其所有的后代都符合该尺寸的限制。</li>
</ul>
</li>
</ul>
<h2 id="源码分析">源码分析</h2>
<h3 id="整体流程">整体流程</h3>
<p>绘制从布局的根节点开始，它需要测量和和绘制布局树。
从ViewRootImpl的首次布局请求开始：</p>
<p>ViewRootImpl.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TraversalRunnable</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            doTraversal<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">requestLayout</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mHandlingLayoutInLayoutRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            checkThread<span style="color:#f92672">();</span>
            mLayoutRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            scheduleTraversals<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleTraversals</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mTraversalScheduled<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mTraversalScheduled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            mTraversalBarrier <span style="color:#f92672">=</span> mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">getLooper</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">postSyncBarrier</span><span style="color:#f92672">();</span>
            mChoreographer<span style="color:#f92672">.</span><span style="color:#a6e22e">postCallback</span><span style="color:#f92672">(</span>
                    Choreographer<span style="color:#f92672">.</span><span style="color:#a6e22e">CALLBACK_TRAVERSAL</span><span style="color:#f92672">,</span> mTraversalRunnable<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mUnbufferedInputDispatch<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                scheduleConsumeBatchedInput<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            notifyRendererOfFramePending<span style="color:#f92672">();</span>
            pokeDrawLockIfNeeded<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doTraversal</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mTraversalScheduled<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mTraversalScheduled <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">getLooper</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">removeSyncBarrier</span><span style="color:#f92672">(</span>mTraversalBarrier<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mProfile<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Debug<span style="color:#f92672">.</span><span style="color:#a6e22e">startMethodTracing</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ViewAncestor&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            performTraversals<span style="color:#f92672">();</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mProfile<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Debug<span style="color:#f92672">.</span><span style="color:#a6e22e">stopMethodTracing</span><span style="color:#f92672">();</span>
                mProfile <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">performTraversals</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// cache mView since it is used so much below...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> View host <span style="color:#f92672">=</span> mView<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DBG<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;======================================&#34;</span><span style="color:#f92672">);</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;performTraversals&#34;</span><span style="color:#f92672">);</span>
            host<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>host <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>mAdded<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>

        mIsInTraversal <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        mWillDrawSoon <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> windowSizeMayChange <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> newSurface <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> surfaceChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> lp <span style="color:#f92672">=</span> mWindowAttributes<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">int</span> desiredWindowWidth<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> desiredWindowHeight<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> viewVisibility <span style="color:#f92672">=</span> getHostVisibility<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> viewVisibilityChanged <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mFirst
                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>mViewVisibility <span style="color:#f92672">!=</span> viewVisibility <span style="color:#f92672">||</span> mNewSurfaceNeeded<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> viewUserVisibilityChanged <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mFirst <span style="color:#f92672">&amp;&amp;</span>
                <span style="color:#f92672">((</span>mViewVisibility <span style="color:#f92672">==</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">VISIBLE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">(</span>viewVisibility <span style="color:#f92672">==</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">VISIBLE</span><span style="color:#f92672">));</span>

        WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> params <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mWindowAttributesChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindowAttributesChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            surfaceChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            params <span style="color:#f92672">=</span> lp<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        CompatibilityInfo compatibilityInfo <span style="color:#f92672">=</span>
                mDisplay<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayAdjustments</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getCompatibilityInfo</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>compatibilityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">supportsScreen</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> mLastInCompatMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            params <span style="color:#f92672">=</span> lp<span style="color:#f92672">;</span>
            mFullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            mLayoutRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mLastInCompatMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                params<span style="color:#f92672">.</span><span style="color:#a6e22e">privateFlags</span> <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PRIVATE_FLAG_COMPATIBLE_WINDOW</span><span style="color:#f92672">;</span>
                mLastInCompatMode <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                params<span style="color:#f92672">.</span><span style="color:#a6e22e">privateFlags</span> <span style="color:#f92672">|=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PRIVATE_FLAG_COMPATIBLE_WINDOW</span><span style="color:#f92672">;</span>
                mLastInCompatMode <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        mWindowAttributesChangesFlag <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

        Rect frame <span style="color:#f92672">=</span> mWinFrame<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFirst<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mFullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            mLayoutRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">final</span> Configuration config <span style="color:#f92672">=</span> mContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getConfiguration</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldUseDisplaySize<span style="color:#f92672">(</span>lp<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// NOTE -- system code, won&#39;t try to do compat mode.
</span><span style="color:#75715e"></span>                Point size <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Point<span style="color:#f92672">();</span>
                mDisplay<span style="color:#f92672">.</span><span style="color:#a6e22e">getRealSize</span><span style="color:#f92672">(</span>size<span style="color:#f92672">);</span>
                desiredWindowWidth <span style="color:#f92672">=</span> size<span style="color:#f92672">.</span><span style="color:#a6e22e">x</span><span style="color:#f92672">;</span>
                desiredWindowHeight <span style="color:#f92672">=</span> size<span style="color:#f92672">.</span><span style="color:#a6e22e">y</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                desiredWindowWidth <span style="color:#f92672">=</span> dipToPx<span style="color:#f92672">(</span>config<span style="color:#f92672">.</span><span style="color:#a6e22e">screenWidthDp</span><span style="color:#f92672">);</span>
                desiredWindowHeight <span style="color:#f92672">=</span> dipToPx<span style="color:#f92672">(</span>config<span style="color:#f92672">.</span><span style="color:#a6e22e">screenHeightDp</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// We used to use the following condition to choose 32 bits drawing caches:
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// PixelFormat.hasAlpha(lp.format) || lp.format == PixelFormat.RGBX_8888
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// However, windows are now always 32 bits by default, so choose 32 bits
</span><span style="color:#75715e"></span>            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mUse32BitDrawingCache</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHasWindowFocus</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowVisibility</span> <span style="color:#f92672">=</span> viewVisibility<span style="color:#f92672">;</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mRecomputeGlobalAttributes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            mLastConfigurationFromResources<span style="color:#f92672">.</span><span style="color:#a6e22e">setTo</span><span style="color:#f92672">(</span>config<span style="color:#f92672">);</span>
            mLastSystemUiVisibility <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mSystemUiVisibility</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// Set the layout direction if it has not been set before (inherit is the default)
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mViewLayoutDirectionInitial <span style="color:#f92672">==</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">LAYOUT_DIRECTION_INHERIT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                host<span style="color:#f92672">.</span><span style="color:#a6e22e">setLayoutDirection</span><span style="color:#f92672">(</span>config<span style="color:#f92672">.</span><span style="color:#a6e22e">getLayoutDirection</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
            host<span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchAttachedToWindow</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTreeObserver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchOnWindowAttachedChange</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            dispatchApplyInsets<span style="color:#f92672">(</span>host<span style="color:#f92672">);</span>
            <span style="color:#75715e">//Log.i(mTag, &#34;Screen on initialized: &#34; + attachInfo.mKeepScreenOn);
</span><span style="color:#75715e"></span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            desiredWindowWidth <span style="color:#f92672">=</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span><span style="color:#f92672">();</span>
            desiredWindowHeight <span style="color:#f92672">=</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>desiredWindowWidth <span style="color:#f92672">!=</span> mWidth <span style="color:#f92672">||</span> desiredWindowHeight <span style="color:#f92672">!=</span> mHeight<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_ORIENTATION<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;View &#34;</span> <span style="color:#f92672">+</span> host <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; resized to: &#34;</span> <span style="color:#f92672">+</span> frame<span style="color:#f92672">);</span>
                mFullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                mLayoutRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                windowSizeMayChange <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>viewVisibilityChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowVisibility</span> <span style="color:#f92672">=</span> viewVisibility<span style="color:#f92672">;</span>
            host<span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchWindowVisibilityChanged</span><span style="color:#f92672">(</span>viewVisibility<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>viewUserVisibilityChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                host<span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchVisibilityAggregated</span><span style="color:#f92672">(</span>viewVisibility <span style="color:#f92672">==</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">VISIBLE</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>viewVisibility <span style="color:#f92672">!=</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">VISIBLE</span> <span style="color:#f92672">||</span> mNewSurfaceNeeded<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                endDragResizing<span style="color:#f92672">();</span>
                destroyHardwareResources<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>viewVisibility <span style="color:#f92672">==</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">GONE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// After making a window gone, we will count it as being
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// shown for the first time the next time it gets focus.
</span><span style="color:#75715e"></span>                mHasHadWindowFocus <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Non-visible windows can&#39;t hold accessibility focus.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowVisibility</span> <span style="color:#f92672">!=</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">VISIBLE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            host<span style="color:#f92672">.</span><span style="color:#a6e22e">clearAccessibilityFocus</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Execute enqueued actions on every traversal in case a detached view enqueued an action
</span><span style="color:#75715e"></span>        getRunQueue<span style="color:#f92672">().</span><span style="color:#a6e22e">executeActions</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHandler</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">boolean</span> insetsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">boolean</span> layoutRequested <span style="color:#f92672">=</span> mLayoutRequested <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(!</span>mStopped <span style="color:#f92672">||</span> mReportNextDraw<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>layoutRequested<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

            <span style="color:#66d9ef">final</span> Resources res <span style="color:#f92672">=</span> mView<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">();</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFirst<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// make sure touch mode code executes by setting cached value
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// to opposite of the added touch mode.
</span><span style="color:#75715e"></span>                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mInTouchMode</span> <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mAddedTouchMode<span style="color:#f92672">;</span>
                ensureTouchModeLocally<span style="color:#f92672">(</span>mAddedTouchMode<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mPendingOverscanInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOverscanInsets</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    insetsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mPendingContentInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mContentInsets</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    insetsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mPendingStableInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mStableInsets</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    insetsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mPendingVisibleInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleInsets</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleInsets</span><span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>mPendingVisibleInsets<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Visible insets changing to: &#34;</span>
                            <span style="color:#f92672">+</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleInsets</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mPendingOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOutsets</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    insetsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mPendingAlwaysConsumeNavBar <span style="color:#f92672">!=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mAlwaysConsumeNavBar</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    insetsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lp<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span> <span style="color:#f92672">==</span> ViewGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_CONTENT</span>
                        <span style="color:#f92672">||</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span> <span style="color:#f92672">==</span> ViewGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_CONTENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    windowSizeMayChange <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldUseDisplaySize<span style="color:#f92672">(</span>lp<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// NOTE -- system code, won&#39;t try to do compat mode.
</span><span style="color:#75715e"></span>                        Point size <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Point<span style="color:#f92672">();</span>
                        mDisplay<span style="color:#f92672">.</span><span style="color:#a6e22e">getRealSize</span><span style="color:#f92672">(</span>size<span style="color:#f92672">);</span>
                        desiredWindowWidth <span style="color:#f92672">=</span> size<span style="color:#f92672">.</span><span style="color:#a6e22e">x</span><span style="color:#f92672">;</span>
                        desiredWindowHeight <span style="color:#f92672">=</span> size<span style="color:#f92672">.</span><span style="color:#a6e22e">y</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        Configuration config <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span><span style="color:#a6e22e">getConfiguration</span><span style="color:#f92672">();</span>
                        desiredWindowWidth <span style="color:#f92672">=</span> dipToPx<span style="color:#f92672">(</span>config<span style="color:#f92672">.</span><span style="color:#a6e22e">screenWidthDp</span><span style="color:#f92672">);</span>
                        desiredWindowHeight <span style="color:#f92672">=</span> dipToPx<span style="color:#f92672">(</span>config<span style="color:#f92672">.</span><span style="color:#a6e22e">screenHeightDp</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Ask host how big it wants to be
</span><span style="color:#75715e"></span>            windowSizeMayChange <span style="color:#f92672">|=</span> measureHierarchy<span style="color:#f92672">(</span>host<span style="color:#f92672">,</span> lp<span style="color:#f92672">,</span> res<span style="color:#f92672">,</span>
                    desiredWindowWidth<span style="color:#f92672">,</span> desiredWindowHeight<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>collectViewAttributes<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            params <span style="color:#f92672">=</span> lp<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mForceReportNewAttributes</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mForceReportNewAttributes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            params <span style="color:#f92672">=</span> lp<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFirst <span style="color:#f92672">||</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mViewVisibilityChanged</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mViewVisibilityChanged</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span> resizeMode <span style="color:#f92672">=</span> mSoftInputMode <span style="color:#f92672">&amp;</span>
                    WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_MASK_ADJUST</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// If we are in auto resize mode, then we need to determine
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// what mode to use now.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resizeMode <span style="color:#f92672">==</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_ADJUST_UNSPECIFIED</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> N <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mScrollContainers</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span> i<span style="color:#f92672">&lt;</span>N<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mScrollContainers</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">).</span><span style="color:#a6e22e">isShown</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        resizeMode <span style="color:#f92672">=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_ADJUST_RESIZE</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resizeMode <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    resizeMode <span style="color:#f92672">=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_ADJUST_PAN</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>lp<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">&amp;</span>
                        WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_MASK_ADJUST</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> resizeMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    lp<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>lp<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">&amp;</span>
                            <span style="color:#f92672">~</span>WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_MASK_ADJUST</span><span style="color:#f92672">)</span> <span style="color:#f92672">|</span>
                            resizeMode<span style="color:#f92672">;</span>
                    params <span style="color:#f92672">=</span> lp<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>host<span style="color:#f92672">.</span><span style="color:#a6e22e">mPrivateFlags</span> <span style="color:#f92672">&amp;</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">PFLAG_REQUEST_TRANSPARENT_REGIONS</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>PixelFormat<span style="color:#f92672">.</span><span style="color:#a6e22e">formatHasAlpha</span><span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    params<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span> <span style="color:#f92672">=</span> PixelFormat<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSLUCENT</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOverscanRequested</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span>
                    <span style="color:#f92672">&amp;</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_LAYOUT_IN_OVERSCAN</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mApplyInsetsRequested<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mApplyInsetsRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            mLastOverscanRequested <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOverscanRequested</span><span style="color:#f92672">;</span>
            dispatchApplyInsets<span style="color:#f92672">(</span>host<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mLayoutRequested<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Short-circuit catching a new layout request here, so
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// we don&#39;t need to go through two layout passes when things
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// change due to fitting system windows, which can happen a lot.
</span><span style="color:#75715e"></span>                windowSizeMayChange <span style="color:#f92672">|=</span> measureHierarchy<span style="color:#f92672">(</span>host<span style="color:#f92672">,</span> lp<span style="color:#f92672">,</span>
                        mView<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">(),</span>
                        desiredWindowWidth<span style="color:#f92672">,</span> desiredWindowHeight<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>layoutRequested<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Clear this now, so that if anything requests a layout in the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// rest of this function we will catch it and re-run a full
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// layout pass.
</span><span style="color:#75715e"></span>            mLayoutRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">boolean</span> windowShouldResize <span style="color:#f92672">=</span> layoutRequested <span style="color:#f92672">&amp;&amp;</span> windowSizeMayChange
            <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">((</span>mWidth <span style="color:#f92672">!=</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> mHeight <span style="color:#f92672">!=</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">())</span>
                <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>lp<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span> <span style="color:#f92672">==</span> ViewGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_CONTENT</span> <span style="color:#f92672">&amp;&amp;</span>
                        frame<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;</span> desiredWindowWidth <span style="color:#f92672">&amp;&amp;</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> mWidth<span style="color:#f92672">)</span>
                <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>lp<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span> <span style="color:#f92672">==</span> ViewGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_CONTENT</span> <span style="color:#f92672">&amp;&amp;</span>
                        frame<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;</span> desiredWindowHeight <span style="color:#f92672">&amp;&amp;</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> mHeight<span style="color:#f92672">));</span>
        windowShouldResize <span style="color:#f92672">|=</span> mDragResizing <span style="color:#f92672">&amp;&amp;</span> mResizeMode <span style="color:#f92672">==</span> RESIZE_MODE_FREEFORM<span style="color:#f92672">;</span>

        <span style="color:#75715e">// If the activity was just relaunched, it might have unfrozen the task bounds (while
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// relaunching), so we need to force a call into window manager to pick up the latest
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// bounds.
</span><span style="color:#75715e"></span>        windowShouldResize <span style="color:#f92672">|=</span> mActivityRelaunched<span style="color:#f92672">;</span>

        <span style="color:#75715e">// Determine whether to compute insets.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// If there are no inset listeners remaining then we may still need to compute
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// insets in case the old insets were non-empty and must be reset.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> computesInternalInsets <span style="color:#f92672">=</span>
                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTreeObserver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hasComputeInternalInsetsListeners</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">||</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHasNonEmptyGivenInternalInsets</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">boolean</span> insetsPending <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> relayoutResult <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> updatedConfiguration <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> surfaceGenerationId <span style="color:#f92672">=</span> mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">getGenerationId</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> isViewVisible <span style="color:#f92672">=</span> viewVisibility <span style="color:#f92672">==</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">VISIBLE</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> windowRelayoutWasForced <span style="color:#f92672">=</span> mForceNextWindowRelayout<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFirst <span style="color:#f92672">||</span> windowShouldResize <span style="color:#f92672">||</span> insetsChanged <span style="color:#f92672">||</span>
                viewVisibilityChanged <span style="color:#f92672">||</span> params <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> mForceNextWindowRelayout<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mForceNextWindowRelayout <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isViewVisible<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If this window is giving internal insets to the window
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// manager, and it is being added or changing its visibility,
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// then we want to first give the window manager &#34;fake&#34;
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// insets to cause it to effectively ignore the content of
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the window during layout.  This avoids it briefly causing
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// other windows to resize/move based on the raw frame of the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// window, waiting until we can finish laying out this window
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// and get back to the window manager with the ultimately
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// computed insets.
</span><span style="color:#75715e"></span>                insetsPending <span style="color:#f92672">=</span> computesInternalInsets <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>mFirst <span style="color:#f92672">||</span> viewVisibilityChanged<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSurfaceHolder <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">mSurfaceLock</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
                mDrawingAllowed <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">boolean</span> hwInitialized <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">boolean</span> contentInsetsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">boolean</span> hadSurface <span style="color:#f92672">=</span> mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">();</span>

            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Log<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;host=w:&#34;</span> <span style="color:#f92672">+</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, h:&#34;</span> <span style="color:#f92672">+</span>
                            host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, params=&#34;</span> <span style="color:#f92672">+</span> params<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// relayoutWindow may decide to destroy mSurface. As that decision
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// happens in WindowManager service, we need to be defensive here
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// and stop using the surface in case it gets destroyed.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pauseSurface</span><span style="color:#f92672">(</span>mSurface<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// Animations were running so we need to push a frame
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// to resume them
</span><span style="color:#75715e"></span>                        mDirty<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> mWidth<span style="color:#f92672">,</span> mHeight<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    mChoreographer<span style="color:#f92672">.</span><span style="color:#a6e22e">mFrameInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addFlags</span><span style="color:#f92672">(</span>FrameInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_WINDOW_LAYOUT_CHANGED</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                relayoutResult <span style="color:#f92672">=</span> relayoutWindow<span style="color:#f92672">(</span>params<span style="color:#f92672">,</span> viewVisibility<span style="color:#f92672">,</span> insetsPending<span style="color:#f92672">);</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;relayout: frame=&#34;</span> <span style="color:#f92672">+</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; overscan=&#34;</span> <span style="color:#f92672">+</span> mPendingOverscanInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; content=&#34;</span> <span style="color:#f92672">+</span> mPendingContentInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; visible=&#34;</span> <span style="color:#f92672">+</span> mPendingVisibleInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; visible=&#34;</span> <span style="color:#f92672">+</span> mPendingStableInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; outsets=&#34;</span> <span style="color:#f92672">+</span> mPendingOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; surface=&#34;</span> <span style="color:#f92672">+</span> mSurface<span style="color:#f92672">);</span>

                <span style="color:#66d9ef">final</span> Configuration pendingMergedConfig <span style="color:#f92672">=</span>
                        mPendingMergedConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">getMergedConfiguration</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pendingMergedConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">seq</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_CONFIGURATION<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Visible with new config: &#34;</span>
                            <span style="color:#f92672">+</span> pendingMergedConfig<span style="color:#f92672">);</span>
                    performConfigurationChange<span style="color:#f92672">(</span>mPendingMergedConfiguration<span style="color:#f92672">,</span> <span style="color:#f92672">!</span>mFirst<span style="color:#f92672">,</span>
                            INVALID_DISPLAY <span style="color:#75715e">/* same display */</span><span style="color:#f92672">);</span>
                    pendingMergedConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">seq</span> <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                    updatedConfiguration <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> overscanInsetsChanged <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mPendingOverscanInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>
                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOverscanInsets</span><span style="color:#f92672">);</span>
                contentInsetsChanged <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mPendingContentInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>
                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mContentInsets</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> visibleInsetsChanged <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mPendingVisibleInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>
                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleInsets</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> stableInsetsChanged <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mPendingStableInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>
                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mStableInsets</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> outsetsChanged <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mPendingOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOutsets</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> surfaceSizeChanged <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>relayoutResult
                        <span style="color:#f92672">&amp;</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">RELAYOUT_RES_SURFACE_RESIZED</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> alwaysConsumeNavBarChanged <span style="color:#f92672">=</span>
                        mPendingAlwaysConsumeNavBar <span style="color:#f92672">!=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mAlwaysConsumeNavBar</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>contentInsetsChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mContentInsets</span><span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>mPendingContentInsets<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Content insets changing to: &#34;</span>
                            <span style="color:#f92672">+</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mContentInsets</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>overscanInsetsChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOverscanInsets</span><span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>mPendingOverscanInsets<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Overscan insets changing to: &#34;</span>
                            <span style="color:#f92672">+</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOverscanInsets</span><span style="color:#f92672">);</span>
                    <span style="color:#75715e">// Need to relayout with content insets.
</span><span style="color:#75715e"></span>                    contentInsetsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stableInsetsChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mStableInsets</span><span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>mPendingStableInsets<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Decor insets changing to: &#34;</span>
                            <span style="color:#f92672">+</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mStableInsets</span><span style="color:#f92672">);</span>
                    <span style="color:#75715e">// Need to relayout with content insets.
</span><span style="color:#75715e"></span>                    contentInsetsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>alwaysConsumeNavBarChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mAlwaysConsumeNavBar</span> <span style="color:#f92672">=</span> mPendingAlwaysConsumeNavBar<span style="color:#f92672">;</span>
                    contentInsetsChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>contentInsetsChanged <span style="color:#f92672">||</span> mLastSystemUiVisibility <span style="color:#f92672">!=</span>
                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mSystemUiVisibility</span> <span style="color:#f92672">||</span> mApplyInsetsRequested
                        <span style="color:#f92672">||</span> mLastOverscanRequested <span style="color:#f92672">!=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOverscanRequested</span>
                        <span style="color:#f92672">||</span> outsetsChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mLastSystemUiVisibility <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mSystemUiVisibility</span><span style="color:#f92672">;</span>
                    mLastOverscanRequested <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOverscanRequested</span><span style="color:#f92672">;</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mOutsets</span><span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>mPendingOutsets<span style="color:#f92672">);</span>
                    mApplyInsetsRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    dispatchApplyInsets<span style="color:#f92672">(</span>host<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>visibleInsetsChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleInsets</span><span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>mPendingVisibleInsets<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Visible insets changing to: &#34;</span>
                            <span style="color:#f92672">+</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleInsets</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>hadSurface<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// If we are creating a new surface, then we need to
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// completely redraw it.  Also, when we get to the
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// point of drawing it we will hold off and schedule
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// a new traversal instead.  This is so we can tell the
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// window manager about all of the windows being displayed
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// before actually drawing them, so it can display then
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// all at once.
</span><span style="color:#75715e"></span>                        newSurface <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                        mFullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                        mPreviousTransparentRegion<span style="color:#f92672">.</span><span style="color:#a6e22e">setEmpty</span><span style="color:#f92672">();</span>

                        <span style="color:#75715e">// Only initialize up-front if transparent regions are not
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// requested, otherwise defer to see if the entire window
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// will be transparent
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                                hwInitialized <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initialize</span><span style="color:#f92672">(</span>
                                        mSurface<span style="color:#f92672">);</span>
                                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hwInitialized <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>host<span style="color:#f92672">.</span><span style="color:#a6e22e">mPrivateFlags</span>
                                        <span style="color:#f92672">&amp;</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">PFLAG_REQUEST_TRANSPARENT_REGIONS</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                    <span style="color:#75715e">// Don&#39;t pre-allocate if transparent regions
</span><span style="color:#75715e"></span>                                    <span style="color:#75715e">// are requested as they may not be needed
</span><span style="color:#75715e"></span>                                    mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">allocateBuffers</span><span style="color:#f92672">();</span>
                                <span style="color:#f92672">}</span>
                            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>OutOfResourcesException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                handleOutOfResourcesException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
                                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// If the surface has been removed, then reset the scroll
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// positions.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mLastScrolledFocus <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mLastScrolledFocus<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                    mScrollY <span style="color:#f92672">=</span> mCurScrollY <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mView <span style="color:#66d9ef">instanceof</span> RootViewSurfaceTaker<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#f92672">((</span>RootViewSurfaceTaker<span style="color:#f92672">)</span> mView<span style="color:#f92672">).</span><span style="color:#a6e22e">onRootViewScrollYChanged</span><span style="color:#f92672">(</span>mCurScrollY<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mScroller <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mScroller<span style="color:#f92672">.</span><span style="color:#a6e22e">abortAnimation</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#75715e">// Our surface is gone
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span>
                            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">destroy</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>surfaceGenerationId <span style="color:#f92672">!=</span> mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">getGenerationId</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">||</span> surfaceSizeChanged <span style="color:#f92672">||</span> windowRelayoutWasForced<span style="color:#f92672">)</span>
                        <span style="color:#f92672">&amp;&amp;</span> mSurfaceHolder <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>
                        <span style="color:#f92672">&amp;&amp;</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mFullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// Need to do updateSurface (which leads to CanvasContext::setSurface and
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// re-create the EGLSurface) if either the Surface changed (as indicated by
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// generation id), or WindowManager changed the surface size. The latter is
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// because on some chips, changing the consumer side&#39;s BufferQueue size may
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// not take effect immediately unless we create a new EGLSurface.
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// Note that frame size change doesn&#39;t always imply surface size change (eg.
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// drag resizing uses fullscreen surface), need to check surfaceSizeChanged
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// flag from WindowManager.
</span><span style="color:#75715e"></span>                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateSurface</span><span style="color:#f92672">(</span>mSurface<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>OutOfResourcesException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        handleOutOfResourcesException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> freeformResizing <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>relayoutResult
                        <span style="color:#f92672">&amp;</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">RELAYOUT_RES_DRAG_RESIZING_FREEFORM</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> dockedResizing <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>relayoutResult
                        <span style="color:#f92672">&amp;</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">RELAYOUT_RES_DRAG_RESIZING_DOCKED</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> dragResizing <span style="color:#f92672">=</span> freeformResizing <span style="color:#f92672">||</span> dockedResizing<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mDragResizing <span style="color:#f92672">!=</span> dragResizing<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dragResizing<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mResizeMode <span style="color:#f92672">=</span> freeformResizing
                                <span style="color:#f92672">?</span> RESIZE_MODE_FREEFORM
                                <span style="color:#f92672">:</span> RESIZE_MODE_DOCKED_DIVIDER<span style="color:#f92672">;</span>
                        startDragResizing<span style="color:#f92672">(</span>mPendingBackDropFrame<span style="color:#f92672">,</span>
                                mWinFrame<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mPendingBackDropFrame<span style="color:#f92672">),</span> mPendingVisibleInsets<span style="color:#f92672">,</span>
                                mPendingStableInsets<span style="color:#f92672">,</span> mResizeMode<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// We shouldn&#39;t come here, but if we come we should end the resize.
</span><span style="color:#75715e"></span>                        endDragResizing<span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>USE_MT_RENDERER<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dragResizing<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mCanvasOffsetX <span style="color:#f92672">=</span> mWinFrame<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">;</span>
                        mCanvasOffsetY <span style="color:#f92672">=</span> mWinFrame<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        mCanvasOffsetX <span style="color:#f92672">=</span> mCanvasOffsetY <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_ORIENTATION<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
                    TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Relayout returned: frame=&#34;</span> <span style="color:#f92672">+</span> frame <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, surface=&#34;</span> <span style="color:#f92672">+</span> mSurface<span style="color:#f92672">);</span>

            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowLeft</span> <span style="color:#f92672">=</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">;</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowTop</span> <span style="color:#f92672">=</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// !!FIXME!! This next section handles the case where we did not get the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// window size we asked for. We should avoid this by getting a maximum size from
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the window session beforehand.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mWidth <span style="color:#f92672">!=</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> mHeight <span style="color:#f92672">!=</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                mWidth <span style="color:#f92672">=</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span><span style="color:#f92672">();</span>
                mHeight <span style="color:#f92672">=</span> frame<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSurfaceHolder <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// The app owns the surface; tell it about what is going on.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// XXX .copyFrom() doesn&#39;t work!
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">//mSurfaceHolder.mSurface.copyFrom(mSurface);
</span><span style="color:#75715e"></span>                    mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">mSurface</span> <span style="color:#f92672">=</span> mSurface<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">setSurfaceFrameSize</span><span style="color:#f92672">(</span>mWidth<span style="color:#f92672">,</span> mHeight<span style="color:#f92672">);</span>
                mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">mSurfaceLock</span><span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>hadSurface<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">ungetCallbacks</span><span style="color:#f92672">();</span>

                        mIsCreating <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                        SurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">Callback</span> callbacks<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallbacks</span><span style="color:#f92672">();</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>callbacks <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">Callback</span> c <span style="color:#f92672">:</span> callbacks<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                c<span style="color:#f92672">.</span><span style="color:#a6e22e">surfaceCreated</span><span style="color:#f92672">(</span>mSurfaceHolder<span style="color:#f92672">);</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>
                        surfaceChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>surfaceChanged <span style="color:#f92672">||</span> surfaceGenerationId <span style="color:#f92672">!=</span> mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">getGenerationId</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        SurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">Callback</span> callbacks<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallbacks</span><span style="color:#f92672">();</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>callbacks <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">Callback</span> c <span style="color:#f92672">:</span> callbacks<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                c<span style="color:#f92672">.</span><span style="color:#a6e22e">surfaceChanged</span><span style="color:#f92672">(</span>mSurfaceHolder<span style="color:#f92672">,</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">,</span>
                                        mWidth<span style="color:#f92672">,</span> mHeight<span style="color:#f92672">);</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                    mIsCreating <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hadSurface<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">ungetCallbacks</span><span style="color:#f92672">();</span>
                    SurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">Callback</span> callbacks<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallbacks</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>callbacks <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">Callback</span> c <span style="color:#f92672">:</span> callbacks<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            c<span style="color:#f92672">.</span><span style="color:#a6e22e">surfaceDestroyed</span><span style="color:#f92672">(</span>mSurfaceHolder<span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                    mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">mSurfaceLock</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                        mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">mSurface</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Surface<span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                        mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">mSurfaceLock</span><span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">final</span> ThreadedRenderer threadedRenderer <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>threadedRenderer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> threadedRenderer<span style="color:#f92672">.</span><span style="color:#a6e22e">isEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hwInitialized
                        <span style="color:#f92672">||</span> mWidth <span style="color:#f92672">!=</span> threadedRenderer<span style="color:#f92672">.</span><span style="color:#a6e22e">getWidth</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">||</span> mHeight <span style="color:#f92672">!=</span> threadedRenderer<span style="color:#f92672">.</span><span style="color:#a6e22e">getHeight</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">||</span> mNeedsRendererSetup<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    threadedRenderer<span style="color:#f92672">.</span><span style="color:#a6e22e">setup</span><span style="color:#f92672">(</span>mWidth<span style="color:#f92672">,</span> mHeight<span style="color:#f92672">,</span> mAttachInfo<span style="color:#f92672">,</span>
                            mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">surfaceInsets</span><span style="color:#f92672">);</span>
                    mNeedsRendererSetup <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mStopped <span style="color:#f92672">||</span> mReportNextDraw<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">boolean</span> focusChangedDueToTouchMode <span style="color:#f92672">=</span> ensureTouchModeLocally<span style="color:#f92672">(</span>
                        <span style="color:#f92672">(</span>relayoutResult<span style="color:#f92672">&amp;</span>WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">RELAYOUT_RES_IN_TOUCH_MODE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>focusChangedDueToTouchMode <span style="color:#f92672">||</span> mWidth <span style="color:#f92672">!=</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">||</span> mHeight <span style="color:#f92672">!=</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> contentInsetsChanged <span style="color:#f92672">||</span>
                        updatedConfiguration<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">int</span> childWidthMeasureSpec <span style="color:#f92672">=</span> getRootMeasureSpec<span style="color:#f92672">(</span>mWidth<span style="color:#f92672">,</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">int</span> childHeightMeasureSpec <span style="color:#f92672">=</span> getRootMeasureSpec<span style="color:#f92672">(</span>mHeight<span style="color:#f92672">,</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span><span style="color:#f92672">);</span>

                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Ooops, something changed!  mWidth=&#34;</span>
                            <span style="color:#f92672">+</span> mWidth <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; measuredWidth=&#34;</span> <span style="color:#f92672">+</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">()</span>
                            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; mHeight=&#34;</span> <span style="color:#f92672">+</span> mHeight
                            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; measuredHeight=&#34;</span> <span style="color:#f92672">+</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">()</span>
                            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; coveredInsetsChanged=&#34;</span> <span style="color:#f92672">+</span> contentInsetsChanged<span style="color:#f92672">);</span>

                     <span style="color:#75715e">// Ask host how big it wants to be
</span><span style="color:#75715e"></span>                    performMeasure<span style="color:#f92672">(</span>childWidthMeasureSpec<span style="color:#f92672">,</span> childHeightMeasureSpec<span style="color:#f92672">);</span>

                    <span style="color:#75715e">// Implementation of weights from WindowManager.LayoutParams
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// We just grow the dimensions as needed and re-measure if
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// needs be
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">int</span> width <span style="color:#f92672">=</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">int</span> height <span style="color:#f92672">=</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">boolean</span> measureAgain <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lp<span style="color:#f92672">.</span><span style="color:#a6e22e">horizontalWeight</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        width <span style="color:#f92672">+=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">((</span>mWidth <span style="color:#f92672">-</span> width<span style="color:#f92672">)</span> <span style="color:#f92672">*</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">horizontalWeight</span><span style="color:#f92672">);</span>
                        childWidthMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>width<span style="color:#f92672">,</span>
                                MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">);</span>
                        measureAgain <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lp<span style="color:#f92672">.</span><span style="color:#a6e22e">verticalWeight</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        height <span style="color:#f92672">+=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">((</span>mHeight <span style="color:#f92672">-</span> height<span style="color:#f92672">)</span> <span style="color:#f92672">*</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">verticalWeight</span><span style="color:#f92672">);</span>
                        childHeightMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>height<span style="color:#f92672">,</span>
                                MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">);</span>
                        measureAgain <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>

                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>measureAgain<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_LAYOUT<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span>
                                <span style="color:#e6db74">&#34;And hey let&#39;s measure once more: width=&#34;</span> <span style="color:#f92672">+</span> width
                                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; height=&#34;</span> <span style="color:#f92672">+</span> height<span style="color:#f92672">);</span>
                        performMeasure<span style="color:#f92672">(</span>childWidthMeasureSpec<span style="color:#f92672">,</span> childHeightMeasureSpec<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>

                    layoutRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Not the first pass and no window/insets/visibility change but the window
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// may have moved and we need check that and if so to update the left and right
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// in the attach info. We translate only the window frame since on window move
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the window manager tells us only for the new frame but the insets are the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// same and we do not want to translate them more than once.
</span><span style="color:#75715e"></span>            maybeHandleWindowMove<span style="color:#f92672">(</span>frame<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> didLayout <span style="color:#f92672">=</span> layoutRequested <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(!</span>mStopped <span style="color:#f92672">||</span> mReportNextDraw<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">boolean</span> triggerGlobalLayoutListener <span style="color:#f92672">=</span> didLayout
                <span style="color:#f92672">||</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mRecomputeGlobalAttributes</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>didLayout<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            performLayout<span style="color:#f92672">(</span>lp<span style="color:#f92672">,</span> mWidth<span style="color:#f92672">,</span> mHeight<span style="color:#f92672">);</span>

            <span style="color:#75715e">// By this point all views have been sized and positioned
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// We can compute the transparent area
</span><span style="color:#75715e"></span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>host<span style="color:#f92672">.</span><span style="color:#a6e22e">mPrivateFlags</span> <span style="color:#f92672">&amp;</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">PFLAG_REQUEST_TRANSPARENT_REGIONS</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// start out transparent
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// TODO: AVOID THAT CALL BY CACHING THE RESULT?
</span><span style="color:#75715e"></span>                host<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocationInWindow</span><span style="color:#f92672">(</span>mTmpLocation<span style="color:#f92672">);</span>
                mTransparentRegion<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>mTmpLocation<span style="color:#f92672">[</span>0<span style="color:#f92672">],</span> mTmpLocation<span style="color:#f92672">[</span>1<span style="color:#f92672">],</span>
                        mTmpLocation<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">mRight</span> <span style="color:#f92672">-</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">mLeft</span><span style="color:#f92672">,</span>
                        mTmpLocation<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">mBottom</span> <span style="color:#f92672">-</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">mTop</span><span style="color:#f92672">);</span>

                host<span style="color:#f92672">.</span><span style="color:#a6e22e">gatherTransparentRegion</span><span style="color:#f92672">(</span>mTransparentRegion<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mTranslator <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mTranslator<span style="color:#f92672">.</span><span style="color:#a6e22e">translateRegionInWindowToScreen</span><span style="color:#f92672">(</span>mTransparentRegion<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mTransparentRegion<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mPreviousTransparentRegion<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    mPreviousTransparentRegion<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>mTransparentRegion<span style="color:#f92672">);</span>
                    mFullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#75715e">// reconfigure window manager
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                        mWindowSession<span style="color:#f92672">.</span><span style="color:#a6e22e">setTransparentRegion</span><span style="color:#f92672">(</span>mWindow<span style="color:#f92672">,</span> mTransparentRegion<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DBG<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;======================================&#34;</span><span style="color:#f92672">);</span>
                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;performTraversals -- after setFrame&#34;</span><span style="color:#f92672">);</span>
                host<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>triggerGlobalLayoutListener<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mRecomputeGlobalAttributes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTreeObserver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchOnGlobalLayout</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>computesInternalInsets<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Clear the original insets.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> ViewTreeObserver<span style="color:#f92672">.</span><span style="color:#a6e22e">InternalInsetsInfo</span> insets <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mGivenInternalInsets</span><span style="color:#f92672">;</span>
            insets<span style="color:#f92672">.</span><span style="color:#a6e22e">reset</span><span style="color:#f92672">();</span>

            <span style="color:#75715e">// Compute new insets in place.
</span><span style="color:#75715e"></span>            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTreeObserver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchOnComputeInternalInsets</span><span style="color:#f92672">(</span>insets<span style="color:#f92672">);</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHasNonEmptyGivenInternalInsets</span> <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>insets<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">();</span>

            <span style="color:#75715e">// Tell the window manager.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>insetsPending <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>mLastGivenInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>insets<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                mLastGivenInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>insets<span style="color:#f92672">);</span>

                <span style="color:#75715e">// Translate insets to screen coordinates if needed.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">final</span> Rect contentInsets<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">final</span> Rect visibleInsets<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">final</span> Region touchableRegion<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mTranslator <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    contentInsets <span style="color:#f92672">=</span> mTranslator<span style="color:#f92672">.</span><span style="color:#a6e22e">getTranslatedContentInsets</span><span style="color:#f92672">(</span>insets<span style="color:#f92672">.</span><span style="color:#a6e22e">contentInsets</span><span style="color:#f92672">);</span>
                    visibleInsets <span style="color:#f92672">=</span> mTranslator<span style="color:#f92672">.</span><span style="color:#a6e22e">getTranslatedVisibleInsets</span><span style="color:#f92672">(</span>insets<span style="color:#f92672">.</span><span style="color:#a6e22e">visibleInsets</span><span style="color:#f92672">);</span>
                    touchableRegion <span style="color:#f92672">=</span> mTranslator<span style="color:#f92672">.</span><span style="color:#a6e22e">getTranslatedTouchableArea</span><span style="color:#f92672">(</span>insets<span style="color:#f92672">.</span><span style="color:#a6e22e">touchableRegion</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    contentInsets <span style="color:#f92672">=</span> insets<span style="color:#f92672">.</span><span style="color:#a6e22e">contentInsets</span><span style="color:#f92672">;</span>
                    visibleInsets <span style="color:#f92672">=</span> insets<span style="color:#f92672">.</span><span style="color:#a6e22e">visibleInsets</span><span style="color:#f92672">;</span>
                    touchableRegion <span style="color:#f92672">=</span> insets<span style="color:#f92672">.</span><span style="color:#a6e22e">touchableRegion</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    mWindowSession<span style="color:#f92672">.</span><span style="color:#a6e22e">setInsets</span><span style="color:#f92672">(</span>mWindow<span style="color:#f92672">,</span> insets<span style="color:#f92672">.</span><span style="color:#a6e22e">mTouchableInsets</span><span style="color:#f92672">,</span>
                            contentInsets<span style="color:#f92672">,</span> visibleInsets<span style="color:#f92672">,</span> touchableRegion<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFirst <span style="color:#f92672">&amp;&amp;</span> sAlwaysAssignFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// handle first focus request
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_INPUT_RESIZE<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;First: mView.hasFocus()=&#34;</span>
                    <span style="color:#f92672">+</span> mView<span style="color:#f92672">.</span><span style="color:#a6e22e">hasFocus</span><span style="color:#f92672">());</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mView <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mView<span style="color:#f92672">.</span><span style="color:#a6e22e">hasFocus</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    mView<span style="color:#f92672">.</span><span style="color:#a6e22e">restoreDefaultFocus</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_INPUT_RESIZE<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;First: requested focused view=&#34;</span>
                            <span style="color:#f92672">+</span> mView<span style="color:#f92672">.</span><span style="color:#a6e22e">findFocus</span><span style="color:#f92672">());</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_INPUT_RESIZE<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;First: existing focused view=&#34;</span>
                            <span style="color:#f92672">+</span> mView<span style="color:#f92672">.</span><span style="color:#a6e22e">findFocus</span><span style="color:#f92672">());</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> changedVisibility <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>viewVisibilityChanged <span style="color:#f92672">||</span> mFirst<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> isViewVisible<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> hasWindowFocus <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHasWindowFocus</span> <span style="color:#f92672">&amp;&amp;</span> isViewVisible<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> regainedFocus <span style="color:#f92672">=</span> hasWindowFocus <span style="color:#f92672">&amp;&amp;</span> mLostWindowFocus<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>regainedFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mLostWindowFocus <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>hasWindowFocus <span style="color:#f92672">&amp;&amp;</span> mHadWindowFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mLostWindowFocus <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>changedVisibility <span style="color:#f92672">||</span> regainedFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Toasts are presented as notifications - don&#39;t present them as windows as well
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> isToast <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>mWindowAttributes <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">false</span>
                    <span style="color:#f92672">:</span> <span style="color:#f92672">(</span>mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">==</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_TOAST</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isToast<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                host<span style="color:#f92672">.</span><span style="color:#a6e22e">sendAccessibilityEvent</span><span style="color:#f92672">(</span>AccessibilityEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_WINDOW_STATE_CHANGED</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        mFirst <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        mWillDrawSoon <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        mNewSurfaceNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        mActivityRelaunched <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        mViewVisibility <span style="color:#f92672">=</span> viewVisibility<span style="color:#f92672">;</span>
        mHadWindowFocus <span style="color:#f92672">=</span> hasWindowFocus<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasWindowFocus <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>isInLocalFocusMode<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> imTarget <span style="color:#f92672">=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">mayUseInputMethod</span><span style="color:#f92672">(</span>mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>imTarget <span style="color:#f92672">!=</span> mLastWasImTarget<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mLastWasImTarget <span style="color:#f92672">=</span> imTarget<span style="color:#f92672">;</span>
                InputMethodManager imm <span style="color:#f92672">=</span> InputMethodManager<span style="color:#f92672">.</span><span style="color:#a6e22e">peekInstance</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>imm <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> imTarget<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    imm<span style="color:#f92672">.</span><span style="color:#a6e22e">onPreWindowFocus</span><span style="color:#f92672">(</span>mView<span style="color:#f92672">,</span> hasWindowFocus<span style="color:#f92672">);</span>
                    imm<span style="color:#f92672">.</span><span style="color:#a6e22e">onPostWindowFocus</span><span style="color:#f92672">(</span>mView<span style="color:#f92672">,</span> mView<span style="color:#f92672">.</span><span style="color:#a6e22e">findFocus</span><span style="color:#f92672">(),</span>
                            mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span><span style="color:#f92672">,</span>
                            <span style="color:#f92672">!</span>mHasHadWindowFocus<span style="color:#f92672">,</span> mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Remember if we must report the next draw.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>relayoutResult <span style="color:#f92672">&amp;</span> WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">RELAYOUT_RES_FIRST_TIME</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            reportNextDraw<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">boolean</span> cancelDraw <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTreeObserver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchOnPreDraw</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>isViewVisible<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>cancelDraw <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>newSurface<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mPendingTransitions <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mPendingTransitions<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> mPendingTransitions<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mPendingTransitions<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">).</span><span style="color:#a6e22e">startChangingAnimations</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
                mPendingTransitions<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            performDraw<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isViewVisible<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Try again
</span><span style="color:#75715e"></span>                scheduleTraversals<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mPendingTransitions <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mPendingTransitions<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> mPendingTransitions<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mPendingTransitions<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">).</span><span style="color:#a6e22e">endChangingAnimations</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
                mPendingTransitions<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        mIsInTraversal <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

     <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Figures out the measure spec for the root view in a window based on it&#39;s
</span><span style="color:#75715e">     * layout params.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param windowSize
</span><span style="color:#75715e">     *            The available width or height of the window
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param rootDimension
</span><span style="color:#75715e">     *            The layout params for one dimension (width or height) of the
</span><span style="color:#75715e">     *            window.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @return The measure spec to use to measure the root view.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getRootMeasureSpec</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> windowSize<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> rootDimension<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> measureSpec<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>rootDimension<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">case</span> ViewGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_PARENT</span><span style="color:#f92672">:</span>
            <span style="color:#75715e">// Window can&#39;t resize. Force root view to be windowSize.
</span><span style="color:#75715e"></span>            measureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>windowSize<span style="color:#f92672">,</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> ViewGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_CONTENT</span><span style="color:#f92672">:</span>
            <span style="color:#75715e">// Window can resize. Set max size for root view.
</span><span style="color:#75715e"></span>            measureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>windowSize<span style="color:#f92672">,</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">AT_MOST</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            <span style="color:#75715e">// Window wants to be an exact size. Force root view to be that size.
</span><span style="color:#75715e"></span>            measureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>rootDimension<span style="color:#f92672">,</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> measureSpec<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">performMeasure</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> childWidthMeasureSpec<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> childHeightMeasureSpec<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mView <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_VIEW</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;measure&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            mView<span style="color:#f92672">.</span><span style="color:#a6e22e">measure</span><span style="color:#f92672">(</span>childWidthMeasureSpec<span style="color:#f92672">,</span> childHeightMeasureSpec<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_VIEW</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">performLayout</span><span style="color:#f92672">(</span>WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> lp<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> desiredWindowWidth<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> desiredWindowHeight<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        mLayoutRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        mScrollMayChange <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        mInLayout <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> View host <span style="color:#f92672">=</span> mView<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>host <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_ORIENTATION <span style="color:#f92672">||</span> DEBUG_LAYOUT<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Laying out &#34;</span> <span style="color:#f92672">+</span> host <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; to (&#34;</span> <span style="color:#f92672">+</span>
                    host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, &#34;</span> <span style="color:#f92672">+</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;)&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_VIEW</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;layout&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            host<span style="color:#f92672">.</span><span style="color:#a6e22e">layout</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">(),</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">());</span>

            mInLayout <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span> numViewsRequestingLayout <span style="color:#f92672">=</span> mLayoutRequesters<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>numViewsRequestingLayout <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// requestLayout() was called during layout.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// If no layout-request flags are set on the requesting views, there is no problem.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// If some requests are still pending, then we need to clear those flags and do
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// a full request/measure/layout pass to handle this situation.
</span><span style="color:#75715e"></span>                ArrayList<span style="color:#f92672">&lt;</span>View<span style="color:#f92672">&gt;</span> validLayoutRequesters <span style="color:#f92672">=</span> getValidLayoutRequesters<span style="color:#f92672">(</span>mLayoutRequesters<span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>validLayoutRequesters <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Set this flag to indicate that any further requests are happening during
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// the second pass, which may result in posting those requests to the next
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// frame instead
</span><span style="color:#75715e"></span>                    mHandlingLayoutInLayoutRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

                    <span style="color:#75715e">// Process fresh layout requests, then measure and layout
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">int</span> numValidRequests <span style="color:#f92672">=</span> validLayoutRequesters<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> numValidRequests<span style="color:#f92672">;</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">final</span> View view <span style="color:#f92672">=</span> validLayoutRequesters<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                        Log<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;View&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;requestLayout() improperly called by &#34;</span> <span style="color:#f92672">+</span> view <span style="color:#f92672">+</span>
                                <span style="color:#e6db74">&#34; during layout: running second layout pass&#34;</span><span style="color:#f92672">);</span>
                        view<span style="color:#f92672">.</span><span style="color:#a6e22e">requestLayout</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                    measureHierarchy<span style="color:#f92672">(</span>host<span style="color:#f92672">,</span> lp<span style="color:#f92672">,</span> mView<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">(),</span>
                            desiredWindowWidth<span style="color:#f92672">,</span> desiredWindowHeight<span style="color:#f92672">);</span>
                    mInLayout <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    host<span style="color:#f92672">.</span><span style="color:#a6e22e">layout</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">(),</span> host<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">());</span>

                    mHandlingLayoutInLayoutRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

                    <span style="color:#75715e">// Check the valid requests again, this time without checking/clearing the
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// layout flags, since requests happening during the second pass get noop&#39;d
</span><span style="color:#75715e"></span>                    validLayoutRequesters <span style="color:#f92672">=</span> getValidLayoutRequesters<span style="color:#f92672">(</span>mLayoutRequesters<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>validLayoutRequesters <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">final</span> ArrayList<span style="color:#f92672">&lt;</span>View<span style="color:#f92672">&gt;</span> finalRequesters <span style="color:#f92672">=</span> validLayoutRequesters<span style="color:#f92672">;</span>
                        <span style="color:#75715e">// Post second-pass requests to the next frame
</span><span style="color:#75715e"></span>                        getRunQueue<span style="color:#f92672">().</span><span style="color:#a6e22e">post</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                            <span style="color:#a6e22e">@Override</span>
                            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                                <span style="color:#66d9ef">int</span> numValidRequests <span style="color:#f92672">=</span> finalRequesters<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
                                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> numValidRequests<span style="color:#f92672">;</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                    <span style="color:#66d9ef">final</span> View view <span style="color:#f92672">=</span> finalRequesters<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                                    Log<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;View&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;requestLayout() improperly called by &#34;</span> <span style="color:#f92672">+</span> view <span style="color:#f92672">+</span>
                                            <span style="color:#e6db74">&#34; during second layout pass: posting in next frame&#34;</span><span style="color:#f92672">);</span>
                                    view<span style="color:#f92672">.</span><span style="color:#a6e22e">requestLayout</span><span style="color:#f92672">();</span>
                                <span style="color:#f92672">}</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">});</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_VIEW</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        mInLayout <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">performDraw</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mDisplayState</span> <span style="color:#f92672">==</span> Display<span style="color:#f92672">.</span><span style="color:#a6e22e">STATE_OFF</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mReportNextDraw<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mView <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> fullRedrawNeeded <span style="color:#f92672">=</span> mFullRedrawNeeded<span style="color:#f92672">;</span>
        mFullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

        mIsDrawing <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_VIEW</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;draw&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            draw<span style="color:#f92672">(</span>fullRedrawNeeded<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            mIsDrawing <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_VIEW</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// For whatever reason we didn&#39;t create a HardwareRenderer, end any
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// hardware animations that are now dangling
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingAnimatingRenderNodes</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingAnimatingRenderNodes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> count<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingAnimatingRenderNodes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">).</span><span style="color:#a6e22e">endAllAnimators</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingAnimatingRenderNodes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mReportNextDraw<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mReportNextDraw <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// if we&#39;re using multi-thread renderer, wait for the window frame draws
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mWindowDrawCountDown <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    mWindowDrawCountDown<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Log<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Window redraw count down interruped!&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                mWindowDrawCountDown <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fence</span><span style="color:#f92672">();</span>
                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setStopped</span><span style="color:#f92672">(</span>mStopped<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>LOCAL_LOGV<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;FINISHED DRAWING: &#34;</span> <span style="color:#f92672">+</span> mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">getTitle</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSurfaceHolder <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                SurfaceCallbackHelper sch <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SurfaceCallbackHelper<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">::</span>postDrawFinished<span style="color:#f92672">);</span>
                SurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">Callback</span> callbacks<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> mSurfaceHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallbacks</span><span style="color:#f92672">();</span>

                sch<span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchSurfaceRedrawNeededAsync</span><span style="color:#f92672">(</span>mSurfaceHolder<span style="color:#f92672">,</span> callbacks<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                pendingDrawFinished<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>    
</code></pre></div><!-- raw HTML omitted -->
<h3 id="测量">测量</h3>
<p>ViewRootImpl的mView是所在Window的顶级布局DecorView，它继承了FrameLayout布局，执行的<code>measure()</code>继承于View：
View.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * &lt;p&gt;
</span><span style="color:#75715e">     * This is called to find out how big a view should be. The parent
</span><span style="color:#75715e">     * supplies constraint information in the width and height parameters.
</span><span style="color:#75715e">     * &lt;/p&gt;
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;
</span><span style="color:#75715e">     * The actual measurement work of a view is performed in
</span><span style="color:#75715e">     * {@link #onMeasure(int, int)}, called by this method. Therefore, only
</span><span style="color:#75715e">     * {@link #onMeasure(int, int)} can and must be overridden by subclasses.
</span><span style="color:#75715e">     * &lt;/p&gt;
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param widthMeasureSpec Horizontal space requirements as imposed by the
</span><span style="color:#75715e">     *        parent
</span><span style="color:#75715e">     * @param heightMeasureSpec Vertical space requirements as imposed by the
</span><span style="color:#75715e">     *        parent
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @see #onMeasure(int, int)
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">measure</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> widthMeasureSpec<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> heightMeasureSpec<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">boolean</span> optical <span style="color:#f92672">=</span> isLayoutModeOptical<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>optical <span style="color:#f92672">!=</span> isLayoutModeOptical<span style="color:#f92672">(</span>mParent<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            Insets insets <span style="color:#f92672">=</span> getOpticalInsets<span style="color:#f92672">();</span>
            <span style="color:#66d9ef">int</span> oWidth  <span style="color:#f92672">=</span> insets<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">+</span> insets<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span> oHeight <span style="color:#f92672">=</span> insets<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span>  <span style="color:#f92672">+</span> insets<span style="color:#f92672">.</span><span style="color:#a6e22e">bottom</span><span style="color:#f92672">;</span>
            widthMeasureSpec  <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">adjust</span><span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">,</span>  optical <span style="color:#f92672">?</span> <span style="color:#f92672">-</span>oWidth  <span style="color:#f92672">:</span> oWidth<span style="color:#f92672">);</span>
            heightMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">adjust</span><span style="color:#f92672">(</span>heightMeasureSpec<span style="color:#f92672">,</span> optical <span style="color:#f92672">?</span> <span style="color:#f92672">-</span>oHeight <span style="color:#f92672">:</span> oHeight<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Suppress sign extension for the low bytes
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">long</span> key <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)</span> widthMeasureSpec <span style="color:#f92672">&lt;&lt;</span> 32 <span style="color:#f92672">|</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)</span> heightMeasureSpec <span style="color:#f92672">&amp;</span> 0xffffffffL<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mMeasureCache <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> mMeasureCache <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LongSparseLongArray<span style="color:#f92672">(</span>2<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> forceLayout <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>mPrivateFlags <span style="color:#f92672">&amp;</span> PFLAG_FORCE_LAYOUT<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> PFLAG_FORCE_LAYOUT<span style="color:#f92672">;</span>

        <span style="color:#75715e">// Optimize layout by avoiding an extra EXACTLY pass when the view is
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// already measured as the correct size. In API 23 and below, this
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// extra pass is required to make LinearLayout re-distribute weight.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> specChanged <span style="color:#f92672">=</span> widthMeasureSpec <span style="color:#f92672">!=</span> mOldWidthMeasureSpec
                <span style="color:#f92672">||</span> heightMeasureSpec <span style="color:#f92672">!=</span> mOldHeightMeasureSpec<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> isSpecExactly <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getMode</span><span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span>
                <span style="color:#f92672">&amp;&amp;</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getMode</span><span style="color:#f92672">(</span>heightMeasureSpec<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> matchesSpecSize <span style="color:#f92672">=</span> getMeasuredWidth<span style="color:#f92672">()</span> <span style="color:#f92672">==</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">)</span>
                <span style="color:#f92672">&amp;&amp;</span> getMeasuredHeight<span style="color:#f92672">()</span> <span style="color:#f92672">==</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">(</span>heightMeasureSpec<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> needsLayout <span style="color:#f92672">=</span> specChanged
                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>sAlwaysRemeasureExactly <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>isSpecExactly <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>matchesSpecSize<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>forceLayout <span style="color:#f92672">||</span> needsLayout<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// first clears the measured dimension flag
</span><span style="color:#75715e"></span>            mPrivateFlags <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>PFLAG_MEASURED_DIMENSION_SET<span style="color:#f92672">;</span>

            resolveRtlPropertiesIfNeeded<span style="color:#f92672">();</span>

            <span style="color:#66d9ef">int</span> cacheIndex <span style="color:#f92672">=</span> forceLayout <span style="color:#f92672">?</span> <span style="color:#f92672">-</span>1 <span style="color:#f92672">:</span> mMeasureCache<span style="color:#f92672">.</span><span style="color:#a6e22e">indexOfKey</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cacheIndex <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span> sIgnoreMeasureCache<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// measure ourselves, this should set the measured dimension flag back
</span><span style="color:#75715e"></span>                onMeasure<span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">,</span> heightMeasureSpec<span style="color:#f92672">);</span>
                mPrivateFlags3 <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">long</span> value <span style="color:#f92672">=</span> mMeasureCache<span style="color:#f92672">.</span><span style="color:#a6e22e">valueAt</span><span style="color:#f92672">(</span>cacheIndex<span style="color:#f92672">);</span>
                <span style="color:#75715e">// Casting a long to int drops the high 32 bits, no mask needed
</span><span style="color:#75715e"></span>                setMeasuredDimensionRaw<span style="color:#f92672">((</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>value <span style="color:#f92672">&gt;&gt;</span> 32<span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> value<span style="color:#f92672">);</span>
                mPrivateFlags3 <span style="color:#f92672">|=</span> PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// flag not set, setMeasuredDimension() was not invoked, we raise
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// an exception to warn the developer
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mPrivateFlags <span style="color:#f92672">&amp;</span> PFLAG_MEASURED_DIMENSION_SET<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> PFLAG_MEASURED_DIMENSION_SET<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;View with id &#34;</span> <span style="color:#f92672">+</span> getId<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span>
                        <span style="color:#f92672">+</span> getClass<span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;#onMeasure() did not set the&#34;</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; measured dimension by calling&#34;</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; setMeasuredDimension()&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            mPrivateFlags <span style="color:#f92672">|=</span> PFLAG_LAYOUT_REQUIRED<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        mOldWidthMeasureSpec <span style="color:#f92672">=</span> widthMeasureSpec<span style="color:#f92672">;</span>
        mOldHeightMeasureSpec <span style="color:#f92672">=</span> heightMeasureSpec<span style="color:#f92672">;</span>

        mMeasureCache<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>key<span style="color:#f92672">,</span> <span style="color:#f92672">((</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)</span> mMeasuredWidth<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;&lt;</span> 32 <span style="color:#f92672">|</span>
                <span style="color:#f92672">(</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)</span> mMeasuredHeight <span style="color:#f92672">&amp;</span> 0xffffffffL<span style="color:#f92672">);</span> <span style="color:#75715e">// suppress sign extension
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * &lt;p&gt;
</span><span style="color:#75715e">     * Measure the view and its content to determine the measured width and the
</span><span style="color:#75715e">     * measured height. This method is invoked by {@link #measure(int, int)} and
</span><span style="color:#75715e">     * should be overridden by subclasses to provide accurate and efficient
</span><span style="color:#75715e">     * measurement of their contents.
</span><span style="color:#75715e">     * &lt;/p&gt;
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;
</span><span style="color:#75715e">     * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you
</span><span style="color:#75715e">     * &lt;em&gt;must&lt;/em&gt; call {@link #setMeasuredDimension(int, int)} to store the
</span><span style="color:#75715e">     * measured width and height of this view. Failure to do so will trigger an
</span><span style="color:#75715e">     * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by
</span><span style="color:#75715e">     * {@link #measure(int, int)}. Calling the superclass&#39;
</span><span style="color:#75715e">     * {@link #onMeasure(int, int)} is a valid use.
</span><span style="color:#75715e">     * &lt;/p&gt;
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;
</span><span style="color:#75715e">     * The base class implementation of measure defaults to the background size,
</span><span style="color:#75715e">     * unless a larger size is allowed by the MeasureSpec. Subclasses should
</span><span style="color:#75715e">     * override {@link #onMeasure(int, int)} to provide better measurements of
</span><span style="color:#75715e">     * their content.
</span><span style="color:#75715e">     * &lt;/p&gt;
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;
</span><span style="color:#75715e">     * If this method is overridden, it is the subclass&#39;s responsibility to make
</span><span style="color:#75715e">     * sure the measured height and width are at least the view&#39;s minimum height
</span><span style="color:#75715e">     * and width ({@link #getSuggestedMinimumHeight()} and
</span><span style="color:#75715e">     * {@link #getSuggestedMinimumWidth()}).
</span><span style="color:#75715e">     * &lt;/p&gt;
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param widthMeasureSpec horizontal space requirements as imposed by the parent.
</span><span style="color:#75715e">     *                         The requirements are encoded with
</span><span style="color:#75715e">     *                         {@link android.view.View.MeasureSpec}.
</span><span style="color:#75715e">     * @param heightMeasureSpec vertical space requirements as imposed by the parent.
</span><span style="color:#75715e">     *                         The requirements are encoded with
</span><span style="color:#75715e">     *                         {@link android.view.View.MeasureSpec}.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @see #getMeasuredWidth()
</span><span style="color:#75715e">     * @see #getMeasuredHeight()
</span><span style="color:#75715e">     * @see #setMeasuredDimension(int, int)
</span><span style="color:#75715e">     * @see #getSuggestedMinimumHeight()
</span><span style="color:#75715e">     * @see #getSuggestedMinimumWidth()
</span><span style="color:#75715e">     * @see android.view.View.MeasureSpec#getMode(int)
</span><span style="color:#75715e">     * @see android.view.View.MeasureSpec#getSize(int)
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onMeasure</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> widthMeasureSpec<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> heightMeasureSpec<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        setMeasuredDimension<span style="color:#f92672">(</span>getDefaultSize<span style="color:#f92672">(</span>getSuggestedMinimumWidth<span style="color:#f92672">(),</span> widthMeasureSpec<span style="color:#f92672">),</span>
                getDefaultSize<span style="color:#f92672">(</span>getSuggestedMinimumHeight<span style="color:#f92672">(),</span> heightMeasureSpec<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Utility to return a default size. Uses the supplied size if the
</span><span style="color:#75715e">     * MeasureSpec imposed no constraints. Will get larger if allowed
</span><span style="color:#75715e">     * by the MeasureSpec.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param size Default size for this view
</span><span style="color:#75715e">     * @param measureSpec Constraints imposed by the parent
</span><span style="color:#75715e">     * @return The size this view should be.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getDefaultSize</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> size<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> measureSpec<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> size<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> specMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getMode</span><span style="color:#f92672">(</span>measureSpec<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">int</span> specSize <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">(</span>measureSpec<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>specMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">UNSPECIFIED</span><span style="color:#f92672">:</span>
            result <span style="color:#f92672">=</span> size<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">AT_MOST</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">case</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">:</span>
            result <span style="color:#f92672">=</span> specSize<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

</code></pre></div><p>DecorView.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onMeasure</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> widthMeasureSpec<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> heightMeasureSpec<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> DisplayMetrics metrics <span style="color:#f92672">=</span> getContext<span style="color:#f92672">().</span><span style="color:#a6e22e">getResources</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDisplayMetrics</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> isPortrait <span style="color:#f92672">=</span>
                getResources<span style="color:#f92672">().</span><span style="color:#a6e22e">getConfiguration</span><span style="color:#f92672">().</span><span style="color:#a6e22e">orientation</span> <span style="color:#f92672">==</span> ORIENTATION_PORTRAIT<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> widthMode <span style="color:#f92672">=</span> getMode<span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> heightMode <span style="color:#f92672">=</span> getMode<span style="color:#f92672">(</span>heightMeasureSpec<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">boolean</span> fixedWidth <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        mApplyFloatingHorizontalInsets <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>widthMode <span style="color:#f92672">==</span> AT_MOST<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> TypedValue tvw <span style="color:#f92672">=</span> isPortrait <span style="color:#f92672">?</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mFixedWidthMinor</span> <span style="color:#f92672">:</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mFixedWidthMajor</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tvw <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> tvw<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">!=</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_NULL</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> w<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tvw<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">==</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_DIMENSION</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    w <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> tvw<span style="color:#f92672">.</span><span style="color:#a6e22e">getDimension</span><span style="color:#f92672">(</span>metrics<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tvw<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">==</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_FRACTION</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    w <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> tvw<span style="color:#f92672">.</span><span style="color:#a6e22e">getFraction</span><span style="color:#f92672">(</span>metrics<span style="color:#f92672">.</span><span style="color:#a6e22e">widthPixels</span><span style="color:#f92672">,</span> metrics<span style="color:#f92672">.</span><span style="color:#a6e22e">widthPixels</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    w <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_MEASURE<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>mLogTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Fixed width: &#34;</span> <span style="color:#f92672">+</span> w<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> widthSize <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>w <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    widthMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>
                            Math<span style="color:#f92672">.</span><span style="color:#a6e22e">min</span><span style="color:#f92672">(</span>w<span style="color:#f92672">,</span> widthSize<span style="color:#f92672">),</span> EXACTLY<span style="color:#f92672">);</span>
                    fixedWidth <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    widthMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>
                            widthSize <span style="color:#f92672">-</span> mFloatingInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">-</span> mFloatingInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">,</span>
                            AT_MOST<span style="color:#f92672">);</span>
                    mApplyFloatingHorizontalInsets <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        mApplyFloatingVerticalInsets <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>heightMode <span style="color:#f92672">==</span> AT_MOST<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> TypedValue tvh <span style="color:#f92672">=</span> isPortrait <span style="color:#f92672">?</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mFixedHeightMajor</span>
                    <span style="color:#f92672">:</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mFixedHeightMinor</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tvh <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> tvh<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">!=</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_NULL</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> h<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tvh<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">==</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_DIMENSION</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    h <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> tvh<span style="color:#f92672">.</span><span style="color:#a6e22e">getDimension</span><span style="color:#f92672">(</span>metrics<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tvh<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">==</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_FRACTION</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    h <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> tvh<span style="color:#f92672">.</span><span style="color:#a6e22e">getFraction</span><span style="color:#f92672">(</span>metrics<span style="color:#f92672">.</span><span style="color:#a6e22e">heightPixels</span><span style="color:#f92672">,</span> metrics<span style="color:#f92672">.</span><span style="color:#a6e22e">heightPixels</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    h <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_MEASURE<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>mLogTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Fixed height: &#34;</span> <span style="color:#f92672">+</span> h<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> heightSize <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">(</span>heightMeasureSpec<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>h <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    heightMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>
                            Math<span style="color:#f92672">.</span><span style="color:#a6e22e">min</span><span style="color:#f92672">(</span>h<span style="color:#f92672">,</span> heightSize<span style="color:#f92672">),</span> EXACTLY<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">getAttributes</span><span style="color:#f92672">().</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> FLAG_LAYOUT_IN_SCREEN<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    heightMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>
                            heightSize <span style="color:#f92672">-</span> mFloatingInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span> <span style="color:#f92672">-</span> mFloatingInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">bottom</span><span style="color:#f92672">,</span> AT_MOST<span style="color:#f92672">);</span>
                    mApplyFloatingVerticalInsets <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        getOutsets<span style="color:#f92672">(</span>mOutsets<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span> <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">||</span> mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">bottom</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> mode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getMode</span><span style="color:#f92672">(</span>heightMeasureSpec<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mode <span style="color:#f92672">!=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">UNSPECIFIED</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">int</span> height <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">(</span>heightMeasureSpec<span style="color:#f92672">);</span>
                heightMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>
                        height <span style="color:#f92672">+</span> mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span> <span style="color:#f92672">+</span> mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">bottom</span><span style="color:#f92672">,</span> mode<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">||</span> mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> mode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getMode</span><span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mode <span style="color:#f92672">!=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">UNSPECIFIED</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">int</span> width <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">);</span>
                widthMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>
                        width <span style="color:#f92672">+</span> mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">+</span> mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">,</span> mode<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onMeasure</span><span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">,</span> heightMeasureSpec<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">int</span> width <span style="color:#f92672">=</span> getMeasuredWidth<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">boolean</span> measure <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

        widthMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>width<span style="color:#f92672">,</span> EXACTLY<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>fixedWidth <span style="color:#f92672">&amp;&amp;</span> widthMode <span style="color:#f92672">==</span> AT_MOST<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> TypedValue tv <span style="color:#f92672">=</span> isPortrait <span style="color:#f92672">?</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mMinWidthMinor</span> <span style="color:#f92672">:</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">mMinWidthMajor</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tv<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">!=</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_NULL</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> min<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tv<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">==</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_DIMENSION</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    min <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span>tv<span style="color:#f92672">.</span><span style="color:#a6e22e">getDimension</span><span style="color:#f92672">(</span>metrics<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tv<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">==</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_FRACTION</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    min <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span>tv<span style="color:#f92672">.</span><span style="color:#a6e22e">getFraction</span><span style="color:#f92672">(</span>mAvailableWidth<span style="color:#f92672">,</span> mAvailableWidth<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    min <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_MEASURE<span style="color:#f92672">)</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>mLogTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Adjust for min width: &#34;</span> <span style="color:#f92672">+</span> min <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, value::&#34;</span>
                        <span style="color:#f92672">+</span> tv<span style="color:#f92672">.</span><span style="color:#a6e22e">coerceToString</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, mAvailableWidth=&#34;</span> <span style="color:#f92672">+</span> mAvailableWidth<span style="color:#f92672">);</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>width <span style="color:#f92672">&lt;</span> min<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    widthMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>min<span style="color:#f92672">,</span> EXACTLY<span style="color:#f92672">);</span>
                    measure <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// TODO: Support height?
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>measure<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onMeasure</span><span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">,</span> heightMeasureSpec<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>FrameLayout.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onMeasure</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> widthMeasureSpec<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> heightMeasureSpec<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> getChildCount<span style="color:#f92672">();</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> measureMatchParentChildren <span style="color:#f92672">=</span>
                MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getMode</span><span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span> <span style="color:#f92672">||</span>
                MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getMode</span><span style="color:#f92672">(</span>heightMeasureSpec<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">;</span>
        mMatchParentChildren<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">int</span> maxHeight <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> maxWidth <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> childState <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> count<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> View child <span style="color:#f92672">=</span> getChildAt<span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mMeasureAllChildren <span style="color:#f92672">||</span> child<span style="color:#f92672">.</span><span style="color:#a6e22e">getVisibility</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> GONE<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                measureChildWithMargins<span style="color:#f92672">(</span>child<span style="color:#f92672">,</span> widthMeasureSpec<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> heightMeasureSpec<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">final</span> LayoutParams lp <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>LayoutParams<span style="color:#f92672">)</span> child<span style="color:#f92672">.</span><span style="color:#a6e22e">getLayoutParams</span><span style="color:#f92672">();</span>
                maxWidth <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>maxWidth<span style="color:#f92672">,</span>
                        child<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">leftMargin</span> <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">rightMargin</span><span style="color:#f92672">);</span>
                maxHeight <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>maxHeight<span style="color:#f92672">,</span>
                        child<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">topMargin</span> <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">bottomMargin</span><span style="color:#f92672">);</span>
                childState <span style="color:#f92672">=</span> combineMeasuredStates<span style="color:#f92672">(</span>childState<span style="color:#f92672">,</span> child<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredState</span><span style="color:#f92672">());</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>measureMatchParentChildren<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lp<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span> <span style="color:#f92672">==</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_PARENT</span> <span style="color:#f92672">||</span>
                            lp<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span> <span style="color:#f92672">==</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_PARENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mMatchParentChildren<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>child<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Account for padding too
</span><span style="color:#75715e"></span>        maxWidth <span style="color:#f92672">+=</span> getPaddingLeftWithForeground<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> getPaddingRightWithForeground<span style="color:#f92672">();</span>
        maxHeight <span style="color:#f92672">+=</span> getPaddingTopWithForeground<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> getPaddingBottomWithForeground<span style="color:#f92672">();</span>

        <span style="color:#75715e">// Check against our minimum height and width
</span><span style="color:#75715e"></span>        maxHeight <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>maxHeight<span style="color:#f92672">,</span> getSuggestedMinimumHeight<span style="color:#f92672">());</span>
        maxWidth <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>maxWidth<span style="color:#f92672">,</span> getSuggestedMinimumWidth<span style="color:#f92672">());</span>

        <span style="color:#75715e">// Check against our foreground&#39;s minimum height and width
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> Drawable drawable <span style="color:#f92672">=</span> getForeground<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawable <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            maxHeight <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>maxHeight<span style="color:#f92672">,</span> drawable<span style="color:#f92672">.</span><span style="color:#a6e22e">getMinimumHeight</span><span style="color:#f92672">());</span>
            maxWidth <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>maxWidth<span style="color:#f92672">,</span> drawable<span style="color:#f92672">.</span><span style="color:#a6e22e">getMinimumWidth</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>

        setMeasuredDimension<span style="color:#f92672">(</span>resolveSizeAndState<span style="color:#f92672">(</span>maxWidth<span style="color:#f92672">,</span> widthMeasureSpec<span style="color:#f92672">,</span> childState<span style="color:#f92672">),</span>
                resolveSizeAndState<span style="color:#f92672">(</span>maxHeight<span style="color:#f92672">,</span> heightMeasureSpec<span style="color:#f92672">,</span>
                        childState <span style="color:#f92672">&lt;&lt;</span> MEASURED_HEIGHT_STATE_SHIFT<span style="color:#f92672">));</span>

        count <span style="color:#f92672">=</span> mMatchParentChildren<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> count<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> View child <span style="color:#f92672">=</span> mMatchParentChildren<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">final</span> MarginLayoutParams lp <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>MarginLayoutParams<span style="color:#f92672">)</span> child<span style="color:#f92672">.</span><span style="color:#a6e22e">getLayoutParams</span><span style="color:#f92672">();</span>

                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> childWidthMeasureSpec<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lp<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span> <span style="color:#f92672">==</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_PARENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> width <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> getMeasuredWidth<span style="color:#f92672">()</span>
                            <span style="color:#f92672">-</span> getPaddingLeftWithForeground<span style="color:#f92672">()</span> <span style="color:#f92672">-</span> getPaddingRightWithForeground<span style="color:#f92672">()</span>
                            <span style="color:#f92672">-</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">leftMargin</span> <span style="color:#f92672">-</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">rightMargin</span><span style="color:#f92672">);</span>
                    childWidthMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>
                            width<span style="color:#f92672">,</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    childWidthMeasureSpec <span style="color:#f92672">=</span> getChildMeasureSpec<span style="color:#f92672">(</span>widthMeasureSpec<span style="color:#f92672">,</span>
                            getPaddingLeftWithForeground<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> getPaddingRightWithForeground<span style="color:#f92672">()</span> <span style="color:#f92672">+</span>
                            lp<span style="color:#f92672">.</span><span style="color:#a6e22e">leftMargin</span> <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">rightMargin</span><span style="color:#f92672">,</span>
                            lp<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> childHeightMeasureSpec<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lp<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span> <span style="color:#f92672">==</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_PARENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> height <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> getMeasuredHeight<span style="color:#f92672">()</span>
                            <span style="color:#f92672">-</span> getPaddingTopWithForeground<span style="color:#f92672">()</span> <span style="color:#f92672">-</span> getPaddingBottomWithForeground<span style="color:#f92672">()</span>
                            <span style="color:#f92672">-</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">topMargin</span> <span style="color:#f92672">-</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">bottomMargin</span><span style="color:#f92672">);</span>
                    childHeightMeasureSpec <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>
                            height<span style="color:#f92672">,</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    childHeightMeasureSpec <span style="color:#f92672">=</span> getChildMeasureSpec<span style="color:#f92672">(</span>heightMeasureSpec<span style="color:#f92672">,</span>
                            getPaddingTopWithForeground<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> getPaddingBottomWithForeground<span style="color:#f92672">()</span> <span style="color:#f92672">+</span>
                            lp<span style="color:#f92672">.</span><span style="color:#a6e22e">topMargin</span> <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">bottomMargin</span><span style="color:#f92672">,</span>
                            lp<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                child<span style="color:#f92672">.</span><span style="color:#a6e22e">measure</span><span style="color:#f92672">(</span>childWidthMeasureSpec<span style="color:#f92672">,</span> childHeightMeasureSpec<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>ViewGroup.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Ask one of the children of this view to measure itself, taking into
</span><span style="color:#75715e">     * account both the MeasureSpec requirements for this view and its padding
</span><span style="color:#75715e">     * and margins. The child must have MarginLayoutParams The heavy lifting is
</span><span style="color:#75715e">     * done in getChildMeasureSpec.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param child The child to measure
</span><span style="color:#75715e">     * @param parentWidthMeasureSpec The width requirements for this view
</span><span style="color:#75715e">     * @param widthUsed Extra space that has been used up by the parent
</span><span style="color:#75715e">     *        horizontally (possibly by other children of the parent)
</span><span style="color:#75715e">     * @param parentHeightMeasureSpec The height requirements for this view
</span><span style="color:#75715e">     * @param heightUsed Extra space that has been used up by the parent
</span><span style="color:#75715e">     *        vertically (possibly by other children of the parent)
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">measureChildWithMargins</span><span style="color:#f92672">(</span>View child<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> parentWidthMeasureSpec<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> widthUsed<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> parentHeightMeasureSpec<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> heightUsed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> MarginLayoutParams lp <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>MarginLayoutParams<span style="color:#f92672">)</span> child<span style="color:#f92672">.</span><span style="color:#a6e22e">getLayoutParams</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> childWidthMeasureSpec <span style="color:#f92672">=</span> getChildMeasureSpec<span style="color:#f92672">(</span>parentWidthMeasureSpec<span style="color:#f92672">,</span>
                mPaddingLeft <span style="color:#f92672">+</span> mPaddingRight <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">leftMargin</span> <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">rightMargin</span>
                        <span style="color:#f92672">+</span> widthUsed<span style="color:#f92672">,</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> childHeightMeasureSpec <span style="color:#f92672">=</span> getChildMeasureSpec<span style="color:#f92672">(</span>parentHeightMeasureSpec<span style="color:#f92672">,</span>
                mPaddingTop <span style="color:#f92672">+</span> mPaddingBottom <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">topMargin</span> <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">bottomMargin</span>
                        <span style="color:#f92672">+</span> heightUsed<span style="color:#f92672">,</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span><span style="color:#f92672">);</span>

        child<span style="color:#f92672">.</span><span style="color:#a6e22e">measure</span><span style="color:#f92672">(</span>childWidthMeasureSpec<span style="color:#f92672">,</span> childHeightMeasureSpec<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Does the hard part of measureChildren: figuring out the MeasureSpec to
</span><span style="color:#75715e">     * pass to a particular child. This method figures out the right MeasureSpec
</span><span style="color:#75715e">     * for one dimension (height or width) of one child view.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * The goal is to combine information from our MeasureSpec with the
</span><span style="color:#75715e">     * LayoutParams of the child to get the best possible results. For example,
</span><span style="color:#75715e">     * if the this view knows its size (because its MeasureSpec has a mode of
</span><span style="color:#75715e">     * EXACTLY), and the child has indicated in its LayoutParams that it wants
</span><span style="color:#75715e">     * to be the same size as the parent, the parent should ask the child to
</span><span style="color:#75715e">     * layout given an exact size.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param spec The requirements for this view
</span><span style="color:#75715e">     * @param padding The padding of this view for the current dimension and
</span><span style="color:#75715e">     *        margins, if applicable
</span><span style="color:#75715e">     * @param childDimension How big the child wants to be in the current
</span><span style="color:#75715e">     *        dimension
</span><span style="color:#75715e">     * @return a MeasureSpec integer for the child
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getChildMeasureSpec</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> spec<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> padding<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> childDimension<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> specMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getMode</span><span style="color:#f92672">(</span>spec<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">int</span> specSize <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">(</span>spec<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">int</span> size <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> specSize <span style="color:#f92672">-</span> padding<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">int</span> resultSize <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> resultMode <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>specMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Parent has imposed an exact size on us
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childDimension <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                resultSize <span style="color:#f92672">=</span> childDimension<span style="color:#f92672">;</span>
                resultMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childDimension <span style="color:#f92672">==</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_PARENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Child wants to be our size. So be it.
</span><span style="color:#75715e"></span>                resultSize <span style="color:#f92672">=</span> size<span style="color:#f92672">;</span>
                resultMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childDimension <span style="color:#f92672">==</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_CONTENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Child wants to determine its own size. It can&#39;t be
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// bigger than us.
</span><span style="color:#75715e"></span>                resultSize <span style="color:#f92672">=</span> size<span style="color:#f92672">;</span>
                resultMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">AT_MOST</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// Parent has imposed a maximum size on us
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">AT_MOST</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childDimension <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Child wants a specific size... so be it
</span><span style="color:#75715e"></span>                resultSize <span style="color:#f92672">=</span> childDimension<span style="color:#f92672">;</span>
                resultMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childDimension <span style="color:#f92672">==</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_PARENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Child wants to be our size, but our size is not fixed.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Constrain child to not be bigger than us.
</span><span style="color:#75715e"></span>                resultSize <span style="color:#f92672">=</span> size<span style="color:#f92672">;</span>
                resultMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">AT_MOST</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childDimension <span style="color:#f92672">==</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_CONTENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Child wants to determine its own size. It can&#39;t be
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// bigger than us.
</span><span style="color:#75715e"></span>                resultSize <span style="color:#f92672">=</span> size<span style="color:#f92672">;</span>
                resultMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">AT_MOST</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// Parent asked to see how big we want to be
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">UNSPECIFIED</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childDimension <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Child wants a specific size... let him have it
</span><span style="color:#75715e"></span>                resultSize <span style="color:#f92672">=</span> childDimension<span style="color:#f92672">;</span>
                resultMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">EXACTLY</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childDimension <span style="color:#f92672">==</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_PARENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Child wants to be our size... find out how big it should
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// be
</span><span style="color:#75715e"></span>                resultSize <span style="color:#f92672">=</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">sUseZeroUnspecifiedMeasureSpec</span> <span style="color:#f92672">?</span> 0 <span style="color:#f92672">:</span> size<span style="color:#f92672">;</span>
                resultMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">UNSPECIFIED</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childDimension <span style="color:#f92672">==</span> LayoutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_CONTENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Child wants to determine its own size.... find out how
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// big it should be
</span><span style="color:#75715e"></span>                resultSize <span style="color:#f92672">=</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">sUseZeroUnspecifiedMeasureSpec</span> <span style="color:#f92672">?</span> 0 <span style="color:#f92672">:</span> size<span style="color:#f92672">;</span>
                resultMode <span style="color:#f92672">=</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">UNSPECIFIED</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//noinspection ResourceType
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> MeasureSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">makeMeasureSpec</span><span style="color:#f92672">(</span>resultSize<span style="color:#f92672">,</span> resultMode<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h3 id="布局">布局</h3>
<p>在ViewRootImpl的<code>performLayout()</code>方法中调用了DecorView的<code>layout()</code>方法，DecorView未重写FrameLayout的这一方法：
FrameLayout.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">layout</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> l<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> t<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> r<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mSuppressLayout <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>mTransition <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>mTransition<span style="color:#f92672">.</span><span style="color:#a6e22e">isChangingLayout</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mTransition <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mTransition<span style="color:#f92672">.</span><span style="color:#a6e22e">layoutChange</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">layout</span><span style="color:#f92672">(</span>l<span style="color:#f92672">,</span> t<span style="color:#f92672">,</span> r<span style="color:#f92672">,</span> b<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// record the fact that we noop&#39;d it; request layout when transition finishes
</span><span style="color:#75715e"></span>            mLayoutCalledWhileSuppressed <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>View.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Assign a size and position to a view and all of its
</span><span style="color:#75715e">     * descendants
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;This is the second phase of the layout mechanism.
</span><span style="color:#75715e">     * (The first is measuring). In this phase, each parent calls
</span><span style="color:#75715e">     * layout on all of its children to position them.
</span><span style="color:#75715e">     * This is typically done using the child measurements
</span><span style="color:#75715e">     * that were stored in the measure pass().&lt;/p&gt;
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;Derived classes should not override this method.
</span><span style="color:#75715e">     * Derived classes with children should override
</span><span style="color:#75715e">     * onLayout. In that method, they should
</span><span style="color:#75715e">     * call layout on each of their children.&lt;/p&gt;
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param l Left position, relative to parent
</span><span style="color:#75715e">     * @param t Top position, relative to parent
</span><span style="color:#75715e">     * @param r Right position, relative to parent
</span><span style="color:#75715e">     * @param b Bottom position, relative to parent
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">({</span><span style="color:#e6db74">&#34;unchecked&#34;</span><span style="color:#f92672">})</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">layout</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> l<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> t<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> r<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mPrivateFlags3 <span style="color:#f92672">&amp;</span> PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            onMeasure<span style="color:#f92672">(</span>mOldWidthMeasureSpec<span style="color:#f92672">,</span> mOldHeightMeasureSpec<span style="color:#f92672">);</span>
            mPrivateFlags3 <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">int</span> oldL <span style="color:#f92672">=</span> mLeft<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> oldT <span style="color:#f92672">=</span> mTop<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> oldB <span style="color:#f92672">=</span> mBottom<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> oldR <span style="color:#f92672">=</span> mRight<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">boolean</span> changed <span style="color:#f92672">=</span> isLayoutModeOptical<span style="color:#f92672">(</span>mParent<span style="color:#f92672">)</span> <span style="color:#f92672">?</span>
                setOpticalFrame<span style="color:#f92672">(</span>l<span style="color:#f92672">,</span> t<span style="color:#f92672">,</span> r<span style="color:#f92672">,</span> b<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> setFrame<span style="color:#f92672">(</span>l<span style="color:#f92672">,</span> t<span style="color:#f92672">,</span> r<span style="color:#f92672">,</span> b<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>changed <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>mPrivateFlags <span style="color:#f92672">&amp;</span> PFLAG_LAYOUT_REQUIRED<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> PFLAG_LAYOUT_REQUIRED<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            onLayout<span style="color:#f92672">(</span>changed<span style="color:#f92672">,</span> l<span style="color:#f92672">,</span> t<span style="color:#f92672">,</span> r<span style="color:#f92672">,</span> b<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldDrawRoundScrollbar<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>mRoundScrollbarRenderer <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mRoundScrollbarRenderer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RoundScrollbarRenderer<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                mRoundScrollbarRenderer <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            mPrivateFlags <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>PFLAG_LAYOUT_REQUIRED<span style="color:#f92672">;</span>

            ListenerInfo li <span style="color:#f92672">=</span> mListenerInfo<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>li <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> li<span style="color:#f92672">.</span><span style="color:#a6e22e">mOnLayoutChangeListeners</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                ArrayList<span style="color:#f92672">&lt;</span>OnLayoutChangeListener<span style="color:#f92672">&gt;</span> listenersCopy <span style="color:#f92672">=</span>
                        <span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>OnLayoutChangeListener<span style="color:#f92672">&gt;)</span>li<span style="color:#f92672">.</span><span style="color:#a6e22e">mOnLayoutChangeListeners</span><span style="color:#f92672">.</span><span style="color:#a6e22e">clone</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">int</span> numListeners <span style="color:#f92672">=</span> listenersCopy<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> numListeners<span style="color:#f92672">;</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    listenersCopy<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">).</span><span style="color:#a6e22e">onLayoutChange</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> l<span style="color:#f92672">,</span> t<span style="color:#f92672">,</span> r<span style="color:#f92672">,</span> b<span style="color:#f92672">,</span> oldL<span style="color:#f92672">,</span> oldT<span style="color:#f92672">,</span> oldR<span style="color:#f92672">,</span> oldB<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        mPrivateFlags <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>PFLAG_FORCE_LAYOUT<span style="color:#f92672">;</span>
        mPrivateFlags3 <span style="color:#f92672">|=</span> PFLAG3_IS_LAID_OUT<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mPrivateFlags3 <span style="color:#f92672">&amp;</span> PFLAG3_NOTIFY_AUTOFILL_ENTER_ON_LAYOUT<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mPrivateFlags3 <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>PFLAG3_NOTIFY_AUTOFILL_ENTER_ON_LAYOUT<span style="color:#f92672">;</span>
            notifyEnterOrExitForAutoFillIfNeeded<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>DecorView.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onLayout</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> changed<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> left<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> top<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> right<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> bottom<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onLayout</span><span style="color:#f92672">(</span>changed<span style="color:#f92672">,</span> left<span style="color:#f92672">,</span> top<span style="color:#f92672">,</span> right<span style="color:#f92672">,</span> bottom<span style="color:#f92672">);</span>
        getOutsets<span style="color:#f92672">(</span>mOutsets<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            offsetLeftAndRight<span style="color:#f92672">(-</span>mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            offsetTopAndBottom<span style="color:#f92672">(-</span>mOutsets<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mApplyFloatingVerticalInsets<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            offsetTopAndBottom<span style="color:#f92672">(</span>mFloatingInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mApplyFloatingHorizontalInsets<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            offsetLeftAndRight<span style="color:#f92672">(</span>mFloatingInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If the application changed its SystemUI metrics, we might also have to adapt
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// our shadow elevation.
</span><span style="color:#75715e"></span>        updateElevation<span style="color:#f92672">();</span>
        mAllowUpdateElevation <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>changed <span style="color:#f92672">&amp;&amp;</span> mResizeMode <span style="color:#f92672">==</span> RESIZE_MODE_DOCKED_DIVIDER<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            getViewRootImpl<span style="color:#f92672">().</span><span style="color:#a6e22e">requestInvalidateRootRenderNode</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>FrameLayout.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onLayout</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> changed<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> left<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> top<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> right<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> bottom<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        layoutChildren<span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> top<span style="color:#f92672">,</span> right<span style="color:#f92672">,</span> bottom<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* no force left gravity */</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">layoutChildren</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> left<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> top<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> right<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> bottom<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> forceLeftGravity<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> getChildCount<span style="color:#f92672">();</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> parentLeft <span style="color:#f92672">=</span> getPaddingLeftWithForeground<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> parentRight <span style="color:#f92672">=</span> right <span style="color:#f92672">-</span> left <span style="color:#f92672">-</span> getPaddingRightWithForeground<span style="color:#f92672">();</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> parentTop <span style="color:#f92672">=</span> getPaddingTopWithForeground<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> parentBottom <span style="color:#f92672">=</span> bottom <span style="color:#f92672">-</span> top <span style="color:#f92672">-</span> getPaddingBottomWithForeground<span style="color:#f92672">();</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> count<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> View child <span style="color:#f92672">=</span> getChildAt<span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>child<span style="color:#f92672">.</span><span style="color:#a6e22e">getVisibility</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> GONE<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> LayoutParams lp <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>LayoutParams<span style="color:#f92672">)</span> child<span style="color:#f92672">.</span><span style="color:#a6e22e">getLayoutParams</span><span style="color:#f92672">();</span>

                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> width <span style="color:#f92672">=</span> child<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> height <span style="color:#f92672">=</span> child<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">();</span>

                <span style="color:#66d9ef">int</span> childLeft<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">int</span> childTop<span style="color:#f92672">;</span>

                <span style="color:#66d9ef">int</span> gravity <span style="color:#f92672">=</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">gravity</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>gravity <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    gravity <span style="color:#f92672">=</span> DEFAULT_CHILD_GRAVITY<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> layoutDirection <span style="color:#f92672">=</span> getLayoutDirection<span style="color:#f92672">();</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> absoluteGravity <span style="color:#f92672">=</span> Gravity<span style="color:#f92672">.</span><span style="color:#a6e22e">getAbsoluteGravity</span><span style="color:#f92672">(</span>gravity<span style="color:#f92672">,</span> layoutDirection<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> verticalGravity <span style="color:#f92672">=</span> gravity <span style="color:#f92672">&amp;</span> Gravity<span style="color:#f92672">.</span><span style="color:#a6e22e">VERTICAL_GRAVITY_MASK</span><span style="color:#f92672">;</span>

                <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>absoluteGravity <span style="color:#f92672">&amp;</span> Gravity<span style="color:#f92672">.</span><span style="color:#a6e22e">HORIZONTAL_GRAVITY_MASK</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">case</span> Gravity<span style="color:#f92672">.</span><span style="color:#a6e22e">CENTER_HORIZONTAL</span><span style="color:#f92672">:</span>
                        childLeft <span style="color:#f92672">=</span> parentLeft <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>parentRight <span style="color:#f92672">-</span> parentLeft <span style="color:#f92672">-</span> width<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> 2 <span style="color:#f92672">+</span>
                        lp<span style="color:#f92672">.</span><span style="color:#a6e22e">leftMargin</span> <span style="color:#f92672">-</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">rightMargin</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">case</span> Gravity<span style="color:#f92672">.</span><span style="color:#a6e22e">RIGHT</span><span style="color:#f92672">:</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>forceLeftGravity<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            childLeft <span style="color:#f92672">=</span> parentRight <span style="color:#f92672">-</span> width <span style="color:#f92672">-</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">rightMargin</span><span style="color:#f92672">;</span>
                            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">case</span> Gravity<span style="color:#f92672">.</span><span style="color:#a6e22e">LEFT</span><span style="color:#f92672">:</span>
                    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
                        childLeft <span style="color:#f92672">=</span> parentLeft <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">leftMargin</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>verticalGravity<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">case</span> Gravity<span style="color:#f92672">.</span><span style="color:#a6e22e">TOP</span><span style="color:#f92672">:</span>
                        childTop <span style="color:#f92672">=</span> parentTop <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">topMargin</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">case</span> Gravity<span style="color:#f92672">.</span><span style="color:#a6e22e">CENTER_VERTICAL</span><span style="color:#f92672">:</span>
                        childTop <span style="color:#f92672">=</span> parentTop <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>parentBottom <span style="color:#f92672">-</span> parentTop <span style="color:#f92672">-</span> height<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> 2 <span style="color:#f92672">+</span>
                        lp<span style="color:#f92672">.</span><span style="color:#a6e22e">topMargin</span> <span style="color:#f92672">-</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">bottomMargin</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">case</span> Gravity<span style="color:#f92672">.</span><span style="color:#a6e22e">BOTTOM</span><span style="color:#f92672">:</span>
                        childTop <span style="color:#f92672">=</span> parentBottom <span style="color:#f92672">-</span> height <span style="color:#f92672">-</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">bottomMargin</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
                        childTop <span style="color:#f92672">=</span> parentTop <span style="color:#f92672">+</span> lp<span style="color:#f92672">.</span><span style="color:#a6e22e">topMargin</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                child<span style="color:#f92672">.</span><span style="color:#a6e22e">layout</span><span style="color:#f92672">(</span>childLeft<span style="color:#f92672">,</span> childTop<span style="color:#f92672">,</span> childLeft <span style="color:#f92672">+</span> width<span style="color:#f92672">,</span> childTop <span style="color:#f92672">+</span> height<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h3 id="绘制">绘制</h3>
<p>ViewRootImpl在<code>performDraw()</code>方法中调用<code>draw()</code>方法，
ViewRootImpl.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> fullRedrawNeeded<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Surface surface <span style="color:#f92672">=</span> mSurface<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>surface<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_FPS<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            trackFPS<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>sFirstDrawComplete<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>sFirstDrawHandlers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                sFirstDrawComplete <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> sFirstDrawHandlers<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i<span style="color:#f92672">&lt;</span> count<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                    mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">post</span><span style="color:#f92672">(</span>sFirstDrawHandlers<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">));</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        scrollToRectOrFocus<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mViewScrollChanged</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mViewScrollChanged</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTreeObserver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchOnScrollChanged</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">boolean</span> animating <span style="color:#f92672">=</span> mScroller <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mScroller<span style="color:#f92672">.</span><span style="color:#a6e22e">computeScrollOffset</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> curScrollY<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>animating<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            curScrollY <span style="color:#f92672">=</span> mScroller<span style="color:#f92672">.</span><span style="color:#a6e22e">getCurrY</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            curScrollY <span style="color:#f92672">=</span> mScrollY<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mCurScrollY <span style="color:#f92672">!=</span> curScrollY<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mCurScrollY <span style="color:#f92672">=</span> curScrollY<span style="color:#f92672">;</span>
            fullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mView <span style="color:#66d9ef">instanceof</span> RootViewSurfaceTaker<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#f92672">((</span>RootViewSurfaceTaker<span style="color:#f92672">)</span> mView<span style="color:#f92672">).</span><span style="color:#a6e22e">onRootViewScrollYChanged</span><span style="color:#f92672">(</span>mCurScrollY<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">float</span> appScale <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mApplicationScale</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> scalingRequired <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mScalingRequired</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">int</span> resizeAlpha <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> Rect dirty <span style="color:#f92672">=</span> mDirty<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSurfaceHolder <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// The app owns the surface, we won&#39;t draw.
</span><span style="color:#75715e"></span>            dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">setEmpty</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>animating <span style="color:#f92672">&amp;&amp;</span> mScroller <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mScroller<span style="color:#f92672">.</span><span style="color:#a6e22e">abortAnimation</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fullRedrawNeeded<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mIgnoreDirtyState</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>mWidth <span style="color:#f92672">*</span> appScale <span style="color:#f92672">+</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">5f</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>mHeight <span style="color:#f92672">*</span> appScale <span style="color:#f92672">+</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">5f</span><span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_ORIENTATION <span style="color:#f92672">||</span> DEBUG_DRAW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>mTag<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Draw &#34;</span> <span style="color:#f92672">+</span> mView <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span>
                    <span style="color:#f92672">+</span> mWindowAttributes<span style="color:#f92672">.</span><span style="color:#a6e22e">getTitle</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: dirty={&#34;</span> <span style="color:#f92672">+</span> dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;,&#34;</span> <span style="color:#f92672">+</span> dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;,&#34;</span> <span style="color:#f92672">+</span> dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;,&#34;</span> <span style="color:#f92672">+</span> dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">bottom</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;} surface=&#34;</span>
                    <span style="color:#f92672">+</span> surface <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; surface.isValid()=&#34;</span> <span style="color:#f92672">+</span> surface<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, appScale:&#34;</span> <span style="color:#f92672">+</span>
                    appScale <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, width=&#34;</span> <span style="color:#f92672">+</span> mWidth <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, height=&#34;</span> <span style="color:#f92672">+</span> mHeight<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTreeObserver</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatchOnDraw</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">int</span> xOffset <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>mCanvasOffsetX<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> yOffset <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>mCanvasOffsetY <span style="color:#f92672">+</span> curScrollY<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> params <span style="color:#f92672">=</span> mWindowAttributes<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> Rect surfaceInsets <span style="color:#f92672">=</span> params <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">surfaceInsets</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>surfaceInsets <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            xOffset <span style="color:#f92672">-=</span> surfaceInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">;</span>
            yOffset <span style="color:#f92672">-=</span> surfaceInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">top</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// Offset dirty rect for surface insets.
</span><span style="color:#75715e"></span>            dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">offset</span><span style="color:#f92672">(</span>surfaceInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">left</span><span style="color:#f92672">,</span> surfaceInsets<span style="color:#f92672">.</span><span style="color:#a6e22e">right</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">boolean</span> accessibilityFocusDirty <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> Drawable drawable <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mAccessibilityFocusDrawable</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawable <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> Rect bounds <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mTmpInvalRect</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> hasFocus <span style="color:#f92672">=</span> getAccessibilityFocusedRect<span style="color:#f92672">(</span>bounds<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>hasFocus<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                bounds<span style="color:#f92672">.</span><span style="color:#a6e22e">setEmpty</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>bounds<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>drawable<span style="color:#f92672">.</span><span style="color:#a6e22e">getBounds</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
                accessibilityFocusDirty <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mDrawingTime</span> <span style="color:#f92672">=</span>
                mChoreographer<span style="color:#f92672">.</span><span style="color:#a6e22e">getFrameTimeNanos</span><span style="color:#f92672">()</span> <span style="color:#f92672">/</span> TimeUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">NANOS_PER_MS</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> mIsAnimating <span style="color:#f92672">||</span> accessibilityFocusDirty<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If accessibility focus moved, always invalidate the root.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">boolean</span> invalidateRoot <span style="color:#f92672">=</span> accessibilityFocusDirty <span style="color:#f92672">||</span> mInvalidateRootRequested<span style="color:#f92672">;</span>
                mInvalidateRootRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

                <span style="color:#75715e">// Draw with hardware renderer.
</span><span style="color:#75715e"></span>                mIsAnimating <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mHardwareYOffset <span style="color:#f92672">!=</span> yOffset <span style="color:#f92672">||</span> mHardwareXOffset <span style="color:#f92672">!=</span> xOffset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mHardwareYOffset <span style="color:#f92672">=</span> yOffset<span style="color:#f92672">;</span>
                    mHardwareXOffset <span style="color:#f92672">=</span> xOffset<span style="color:#f92672">;</span>
                    invalidateRoot <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>invalidateRoot<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">invalidateRoot</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>

                dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">setEmpty</span><span style="color:#f92672">();</span>

                <span style="color:#75715e">// Stage the content drawn size now. It will be transferred to the renderer
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// shortly before the draw commands get send to the renderer.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> updated <span style="color:#f92672">=</span> updateContentDrawBounds<span style="color:#f92672">();</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mReportNextDraw<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// report next draw overrides setStopped()
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// This value is re-sync&#39;d to the value of mStopped
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// in the handling of mReportNextDraw post-draw.
</span><span style="color:#75715e"></span>                    mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setStopped</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>updated<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    requestDrawWindow<span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>

                mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span>mView<span style="color:#f92672">,</span> mAttachInfo<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If we get here with a disabled &amp; requested hardware renderer, something went
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// wrong (an invalidate posted right before we destroyed the hardware surface
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// for instance) so we should just bail out. Locking the surface with software
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// rendering at this point would lock it forever and prevent hardware renderer
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// from doing its job when it comes back.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Before we request a new frame we must however attempt to reinitiliaze the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// hardware renderer if it&#39;s in requested state. This would happen after an
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// eglTerminate() for instance.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span>
                        <span style="color:#f92672">!</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isEnabled</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span>
                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isRequested</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>

                    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                        mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mThreadedRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initializeIfNeeded</span><span style="color:#f92672">(</span>
                                mWidth<span style="color:#f92672">,</span> mHeight<span style="color:#f92672">,</span> mAttachInfo<span style="color:#f92672">,</span> mSurface<span style="color:#f92672">,</span> surfaceInsets<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>OutOfResourcesException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        handleOutOfResourcesException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>

                    mFullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    scheduleTraversals<span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>drawSoftware<span style="color:#f92672">(</span>surface<span style="color:#f92672">,</span> mAttachInfo<span style="color:#f92672">,</span> xOffset<span style="color:#f92672">,</span> yOffset<span style="color:#f92672">,</span> scalingRequired<span style="color:#f92672">,</span> dirty<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>animating<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mFullRedrawNeeded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            scheduleTraversals<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>其中调用<code>mAttachInfo.mThreadedRenderer.draw(mView, mAttachInfo, this)</code>进入视图绘制。
ThreadedRenderer.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Draws the specified view.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param view The view to draw.
</span><span style="color:#75715e">     * @param attachInfo AttachInfo tied to the specified view.
</span><span style="color:#75715e">     * @param callbacks Callbacks invoked when drawing happens.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span>View view<span style="color:#f92672">,</span> AttachInfo attachInfo<span style="color:#f92672">,</span> DrawCallbacks callbacks<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mIgnoreDirtyState</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> Choreographer choreographer <span style="color:#f92672">=</span> attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mViewRootImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mChoreographer</span><span style="color:#f92672">;</span>
        choreographer<span style="color:#f92672">.</span><span style="color:#a6e22e">mFrameInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">markDrawStart</span><span style="color:#f92672">();</span>

        updateRootDisplayList<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> callbacks<span style="color:#f92672">);</span>

        attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mIgnoreDirtyState</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// register animating rendernodes which started animating prior to renderer
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// creation, which is typical for animators started prior to first draw
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingAnimatingRenderNodes</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingAnimatingRenderNodes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> count<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                registerAnimatingRenderNode<span style="color:#f92672">(</span>
                        attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingAnimatingRenderNodes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">));</span>
            <span style="color:#f92672">}</span>
            attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingAnimatingRenderNodes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// We don&#39;t need this anymore as subsequent calls to
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// ViewRootImpl#attachRenderNodeAnimator will go directly to us.
</span><span style="color:#75715e"></span>            attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingAnimatingRenderNodes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span><span style="color:#f92672">[]</span> frameInfo <span style="color:#f92672">=</span> choreographer<span style="color:#f92672">.</span><span style="color:#a6e22e">mFrameInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFrameInfo</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> syncResult <span style="color:#f92672">=</span> nSyncAndDrawFrame<span style="color:#f92672">(</span>mNativeProxy<span style="color:#f92672">,</span> frameInfo<span style="color:#f92672">,</span> frameInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>syncResult <span style="color:#f92672">&amp;</span> SYNC_LOST_SURFACE_REWARD_IF_FOUND<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            setEnabled<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mViewRootImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mSurface</span><span style="color:#f92672">.</span><span style="color:#a6e22e">release</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// Invalidate since we failed to draw. This should fetch a Surface
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// if it is still needed or do nothing if we are no longer drawing
</span><span style="color:#75715e"></span>            attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mViewRootImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">invalidate</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>syncResult <span style="color:#f92672">&amp;</span> SYNC_INVALIDATE_REQUIRED<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mViewRootImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">invalidate</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">updateRootDisplayList</span><span style="color:#f92672">(</span>View view<span style="color:#f92672">,</span> DrawCallbacks callbacks<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_VIEW</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Record View#draw()&#34;</span><span style="color:#f92672">);</span>
        updateViewTreeDisplayList<span style="color:#f92672">(</span>view<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mRootNodeNeedsUpdate <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>mRootNode<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            DisplayListCanvas canvas <span style="color:#f92672">=</span> mRootNode<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>mSurfaceWidth<span style="color:#f92672">,</span> mSurfaceHeight<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> saveCount <span style="color:#f92672">=</span> canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">();</span>
                canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">translate</span><span style="color:#f92672">(</span>mInsetLeft<span style="color:#f92672">,</span> mInsetTop<span style="color:#f92672">);</span>
                callbacks<span style="color:#f92672">.</span><span style="color:#a6e22e">onPreDraw</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

                canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">insertReorderBarrier</span><span style="color:#f92672">();</span>
                canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">drawRenderNode</span><span style="color:#f92672">(</span>view<span style="color:#f92672">.</span><span style="color:#a6e22e">updateDisplayListIfDirty</span><span style="color:#f92672">());</span>
                canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">insertInorderBarrier</span><span style="color:#f92672">();</span>

                callbacks<span style="color:#f92672">.</span><span style="color:#a6e22e">onPostDraw</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
                canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">restoreToCount</span><span style="color:#f92672">(</span>saveCount<span style="color:#f92672">);</span>
                mRootNodeNeedsUpdate <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                mRootNode<span style="color:#f92672">.</span><span style="color:#a6e22e">end</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_VIEW</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p><code>canvas.drawRenderNode(view.updateDisplayListIfDirty())</code>
View.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Gets the RenderNode for the view, and updates its DisplayList (if needed and supported)
</span><span style="color:#75715e">     * @hide
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@NonNull</span>
    <span style="color:#66d9ef">public</span> RenderNode <span style="color:#a6e22e">updateDisplayListIfDirty</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> RenderNode renderNode <span style="color:#f92672">=</span> mRenderNode<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>canHaveDisplayList<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// can&#39;t populate RenderNode, don&#39;t try
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> renderNode<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mPrivateFlags <span style="color:#f92672">&amp;</span> PFLAG_DRAWING_CACHE_VALID<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0
                <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>renderNode<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>mRecreateDisplayList<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Don&#39;t need to recreate the display list, just need to tell our
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// children to restore/recreate theirs
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>renderNode<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mRecreateDisplayList<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mPrivateFlags <span style="color:#f92672">|=</span> PFLAG_DRAWN <span style="color:#f92672">|</span> PFLAG_DRAWING_CACHE_VALID<span style="color:#f92672">;</span>
                mPrivateFlags <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>PFLAG_DIRTY_MASK<span style="color:#f92672">;</span>
                dispatchGetDisplayList<span style="color:#f92672">();</span>

                <span style="color:#66d9ef">return</span> renderNode<span style="color:#f92672">;</span> <span style="color:#75715e">// no work needed
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// If we got here, we&#39;re recreating it. Mark it as such to ensure that
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// we copy in child display lists into ours in drawChild()
</span><span style="color:#75715e"></span>            mRecreateDisplayList <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">int</span> width <span style="color:#f92672">=</span> mRight <span style="color:#f92672">-</span> mLeft<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span> height <span style="color:#f92672">=</span> mBottom <span style="color:#f92672">-</span> mTop<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span> layerType <span style="color:#f92672">=</span> getLayerType<span style="color:#f92672">();</span>

            <span style="color:#66d9ef">final</span> DisplayListCanvas canvas <span style="color:#f92672">=</span> renderNode<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>width<span style="color:#f92672">,</span> height<span style="color:#f92672">);</span>
            canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">setHighContrastText</span><span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHighContrastText</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>layerType <span style="color:#f92672">==</span> LAYER_TYPE_SOFTWARE<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    buildDrawingCache<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                    Bitmap cache <span style="color:#f92672">=</span> getDrawingCache<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cache <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">drawBitmap</span><span style="color:#f92672">(</span>cache<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> mLayerPaint<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    computeScroll<span style="color:#f92672">();</span>

                    canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">translate</span><span style="color:#f92672">(-</span>mScrollX<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>mScrollY<span style="color:#f92672">);</span>
                    mPrivateFlags <span style="color:#f92672">|=</span> PFLAG_DRAWN <span style="color:#f92672">|</span> PFLAG_DRAWING_CACHE_VALID<span style="color:#f92672">;</span>
                    mPrivateFlags <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>PFLAG_DIRTY_MASK<span style="color:#f92672">;</span>

                    <span style="color:#75715e">// Fast path for layouts with no backgrounds
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mPrivateFlags <span style="color:#f92672">&amp;</span> PFLAG_SKIP_DRAW<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> PFLAG_SKIP_DRAW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        dispatchDraw<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
                        drawAutofilledHighlight<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mOverlay <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mOverlay<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                            mOverlay<span style="color:#f92672">.</span><span style="color:#a6e22e">getOverlayView</span><span style="color:#f92672">().</span><span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debugDraw<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                            debugDrawFocus<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        draw<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                renderNode<span style="color:#f92672">.</span><span style="color:#a6e22e">end</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
                setDisplayListProperties<span style="color:#f92672">(</span>renderNode<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            mPrivateFlags <span style="color:#f92672">|=</span> PFLAG_DRAWN <span style="color:#f92672">|</span> PFLAG_DRAWING_CACHE_VALID<span style="color:#f92672">;</span>
            mPrivateFlags <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>PFLAG_DIRTY_MASK<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> renderNode<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Manually render this view (and all of its children) to the given Canvas.
</span><span style="color:#75715e">     * The view must have already done a full layout before this function is
</span><span style="color:#75715e">     * called.  When implementing a view, implement
</span><span style="color:#75715e">     * {@link #onDraw(android.graphics.Canvas)} instead of overriding this method.
</span><span style="color:#75715e">     * If you do need to override this method, call the superclass version.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param canvas The Canvas to which the View is rendered.
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@CallSuper</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span>Canvas canvas<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> privateFlags <span style="color:#f92672">=</span> mPrivateFlags<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> dirtyOpaque <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>privateFlags <span style="color:#f92672">&amp;</span> PFLAG_DIRTY_MASK<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> PFLAG_DIRTY_OPAQUE <span style="color:#f92672">&amp;&amp;</span>
                <span style="color:#f92672">(</span>mAttachInfo <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mIgnoreDirtyState</span><span style="color:#f92672">);</span>
        mPrivateFlags <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>privateFlags <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>PFLAG_DIRTY_MASK<span style="color:#f92672">)</span> <span style="color:#f92672">|</span> PFLAG_DRAWN<span style="color:#f92672">;</span>

        <span style="color:#75715e">/*
</span><span style="color:#75715e">         * Draw traversal performs several drawing steps which must be executed
</span><span style="color:#75715e">         * in the appropriate order:
</span><span style="color:#75715e">         *
</span><span style="color:#75715e">         *      1. Draw the background
</span><span style="color:#75715e">         *      2. If necessary, save the canvas&#39; layers to prepare for fading
</span><span style="color:#75715e">         *      3. Draw view&#39;s content
</span><span style="color:#75715e">         *      4. Draw children
</span><span style="color:#75715e">         *      5. If necessary, draw the fading edges and restore layers
</span><span style="color:#75715e">         *      6. Draw decorations (scrollbars for instance)
</span><span style="color:#75715e">         */</span>

        <span style="color:#75715e">// Step 1, draw the background, if needed
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> saveCount<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>dirtyOpaque<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            drawBackground<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// skip step 2 &amp; 5 if possible (common case)
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> viewFlags <span style="color:#f92672">=</span> mViewFlags<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> horizontalEdges <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>viewFlags <span style="color:#f92672">&amp;</span> FADING_EDGE_HORIZONTAL<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> verticalEdges <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>viewFlags <span style="color:#f92672">&amp;</span> FADING_EDGE_VERTICAL<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>verticalEdges <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>horizontalEdges<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Step 3, draw the content
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>dirtyOpaque<span style="color:#f92672">)</span> onDraw<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

            <span style="color:#75715e">// Step 4, draw the children
</span><span style="color:#75715e"></span>            dispatchDraw<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

            drawAutofilledHighlight<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

            <span style="color:#75715e">// Overlay is part of the content and draws beneath Foreground
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mOverlay <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mOverlay<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                mOverlay<span style="color:#f92672">.</span><span style="color:#a6e22e">getOverlayView</span><span style="color:#f92672">().</span><span style="color:#a6e22e">dispatchDraw</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Step 6, draw decorations (foreground, scrollbars)
</span><span style="color:#75715e"></span>            onDrawForeground<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

            <span style="color:#75715e">// Step 7, draw the default focus highlight
</span><span style="color:#75715e"></span>            drawDefaultFocusHighlight<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debugDraw<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                debugDrawFocus<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// we&#39;re done...
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">/*
</span><span style="color:#75715e">         * Here we do the full fledged routine...
</span><span style="color:#75715e">         * (this is an uncommon case where speed matters less,
</span><span style="color:#75715e">         * this is why we repeat some of the tests that have been
</span><span style="color:#75715e">         * done above)
</span><span style="color:#75715e">         */</span>

        <span style="color:#66d9ef">boolean</span> drawTop <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> drawBottom <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> drawLeft <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> drawRight <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">float</span> topFadeStrength <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">float</span> bottomFadeStrength <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">float</span> leftFadeStrength <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">float</span> rightFadeStrength <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// Step 2, save the canvas&#39; layers
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> paddingLeft <span style="color:#f92672">=</span> mPaddingLeft<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> offsetRequired <span style="color:#f92672">=</span> isPaddingOffsetRequired<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>offsetRequired<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            paddingLeft <span style="color:#f92672">+=</span> getLeftPaddingOffset<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">int</span> left <span style="color:#f92672">=</span> mScrollX <span style="color:#f92672">+</span> paddingLeft<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> right <span style="color:#f92672">=</span> left <span style="color:#f92672">+</span> mRight <span style="color:#f92672">-</span> mLeft <span style="color:#f92672">-</span> mPaddingRight <span style="color:#f92672">-</span> paddingLeft<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> top <span style="color:#f92672">=</span> mScrollY <span style="color:#f92672">+</span> getFadeTop<span style="color:#f92672">(</span>offsetRequired<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">int</span> bottom <span style="color:#f92672">=</span> top <span style="color:#f92672">+</span> getFadeHeight<span style="color:#f92672">(</span>offsetRequired<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>offsetRequired<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            right <span style="color:#f92672">+=</span> getRightPaddingOffset<span style="color:#f92672">();</span>
            bottom <span style="color:#f92672">+=</span> getBottomPaddingOffset<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> ScrollabilityCache scrollabilityCache <span style="color:#f92672">=</span> mScrollCache<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">float</span> fadeHeight <span style="color:#f92672">=</span> scrollabilityCache<span style="color:#f92672">.</span><span style="color:#a6e22e">fadingEdgeLength</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> length <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> fadeHeight<span style="color:#f92672">;</span>

        <span style="color:#75715e">// clip the fade length if top and bottom fades overlap
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// overlapping fades produce odd-looking artifacts
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>verticalEdges <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>top <span style="color:#f92672">+</span> length <span style="color:#f92672">&gt;</span> bottom <span style="color:#f92672">-</span> length<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            length <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>bottom <span style="color:#f92672">-</span> top<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> 2<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// also clip horizontal fades if necessary
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>horizontalEdges <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>left <span style="color:#f92672">+</span> length <span style="color:#f92672">&gt;</span> right <span style="color:#f92672">-</span> length<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            length <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>right <span style="color:#f92672">-</span> left<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> 2<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>verticalEdges<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            topFadeStrength <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">,</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">min</span><span style="color:#f92672">(</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">,</span> getTopFadingEdgeStrength<span style="color:#f92672">()));</span>
            drawTop <span style="color:#f92672">=</span> topFadeStrength <span style="color:#f92672">*</span> fadeHeight <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">;</span>
            bottomFadeStrength <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">,</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">min</span><span style="color:#f92672">(</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">,</span> getBottomFadingEdgeStrength<span style="color:#f92672">()));</span>
            drawBottom <span style="color:#f92672">=</span> bottomFadeStrength <span style="color:#f92672">*</span> fadeHeight <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>horizontalEdges<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            leftFadeStrength <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">,</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">min</span><span style="color:#f92672">(</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">,</span> getLeftFadingEdgeStrength<span style="color:#f92672">()));</span>
            drawLeft <span style="color:#f92672">=</span> leftFadeStrength <span style="color:#f92672">*</span> fadeHeight <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">;</span>
            rightFadeStrength <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">,</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">min</span><span style="color:#f92672">(</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">,</span> getRightFadingEdgeStrength<span style="color:#f92672">()));</span>
            drawRight <span style="color:#f92672">=</span> rightFadeStrength <span style="color:#f92672">*</span> fadeHeight <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        saveCount <span style="color:#f92672">=</span> canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">getSaveCount</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">int</span> solidColor <span style="color:#f92672">=</span> getSolidColor<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>solidColor <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> Canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">HAS_ALPHA_LAYER_SAVE_FLAG</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawTop<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">saveLayer</span><span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> top<span style="color:#f92672">,</span> right<span style="color:#f92672">,</span> top <span style="color:#f92672">+</span> length<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> flags<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawBottom<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">saveLayer</span><span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> bottom <span style="color:#f92672">-</span> length<span style="color:#f92672">,</span> right<span style="color:#f92672">,</span> bottom<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> flags<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawLeft<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">saveLayer</span><span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> top<span style="color:#f92672">,</span> left <span style="color:#f92672">+</span> length<span style="color:#f92672">,</span> bottom<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> flags<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawRight<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">saveLayer</span><span style="color:#f92672">(</span>right <span style="color:#f92672">-</span> length<span style="color:#f92672">,</span> top<span style="color:#f92672">,</span> right<span style="color:#f92672">,</span> bottom<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> flags<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            scrollabilityCache<span style="color:#f92672">.</span><span style="color:#a6e22e">setFadeColor</span><span style="color:#f92672">(</span>solidColor<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Step 3, draw the content
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>dirtyOpaque<span style="color:#f92672">)</span> onDraw<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

        <span style="color:#75715e">// Step 4, draw the children
</span><span style="color:#75715e"></span>        dispatchDraw<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

        <span style="color:#75715e">// Step 5, draw the fade effect and restore layers
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> Paint p <span style="color:#f92672">=</span> scrollabilityCache<span style="color:#f92672">.</span><span style="color:#a6e22e">paint</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> Matrix matrix <span style="color:#f92672">=</span> scrollabilityCache<span style="color:#f92672">.</span><span style="color:#a6e22e">matrix</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> Shader fade <span style="color:#f92672">=</span> scrollabilityCache<span style="color:#f92672">.</span><span style="color:#a6e22e">shader</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawTop<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">setScale</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> fadeHeight <span style="color:#f92672">*</span> topFadeStrength<span style="color:#f92672">);</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">postTranslate</span><span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> top<span style="color:#f92672">);</span>
            fade<span style="color:#f92672">.</span><span style="color:#a6e22e">setLocalMatrix</span><span style="color:#f92672">(</span>matrix<span style="color:#f92672">);</span>
            p<span style="color:#f92672">.</span><span style="color:#a6e22e">setShader</span><span style="color:#f92672">(</span>fade<span style="color:#f92672">);</span>
            canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">drawRect</span><span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> top<span style="color:#f92672">,</span> right<span style="color:#f92672">,</span> top <span style="color:#f92672">+</span> length<span style="color:#f92672">,</span> p<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawBottom<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">setScale</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> fadeHeight <span style="color:#f92672">*</span> bottomFadeStrength<span style="color:#f92672">);</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">postRotate</span><span style="color:#f92672">(</span>180<span style="color:#f92672">);</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">postTranslate</span><span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> bottom<span style="color:#f92672">);</span>
            fade<span style="color:#f92672">.</span><span style="color:#a6e22e">setLocalMatrix</span><span style="color:#f92672">(</span>matrix<span style="color:#f92672">);</span>
            p<span style="color:#f92672">.</span><span style="color:#a6e22e">setShader</span><span style="color:#f92672">(</span>fade<span style="color:#f92672">);</span>
            canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">drawRect</span><span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> bottom <span style="color:#f92672">-</span> length<span style="color:#f92672">,</span> right<span style="color:#f92672">,</span> bottom<span style="color:#f92672">,</span> p<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawLeft<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">setScale</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> fadeHeight <span style="color:#f92672">*</span> leftFadeStrength<span style="color:#f92672">);</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">postRotate</span><span style="color:#f92672">(-</span>90<span style="color:#f92672">);</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">postTranslate</span><span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> top<span style="color:#f92672">);</span>
            fade<span style="color:#f92672">.</span><span style="color:#a6e22e">setLocalMatrix</span><span style="color:#f92672">(</span>matrix<span style="color:#f92672">);</span>
            p<span style="color:#f92672">.</span><span style="color:#a6e22e">setShader</span><span style="color:#f92672">(</span>fade<span style="color:#f92672">);</span>
            canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">drawRect</span><span style="color:#f92672">(</span>left<span style="color:#f92672">,</span> top<span style="color:#f92672">,</span> left <span style="color:#f92672">+</span> length<span style="color:#f92672">,</span> bottom<span style="color:#f92672">,</span> p<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawRight<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">setScale</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> fadeHeight <span style="color:#f92672">*</span> rightFadeStrength<span style="color:#f92672">);</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">postRotate</span><span style="color:#f92672">(</span>90<span style="color:#f92672">);</span>
            matrix<span style="color:#f92672">.</span><span style="color:#a6e22e">postTranslate</span><span style="color:#f92672">(</span>right<span style="color:#f92672">,</span> top<span style="color:#f92672">);</span>
            fade<span style="color:#f92672">.</span><span style="color:#a6e22e">setLocalMatrix</span><span style="color:#f92672">(</span>matrix<span style="color:#f92672">);</span>
            p<span style="color:#f92672">.</span><span style="color:#a6e22e">setShader</span><span style="color:#f92672">(</span>fade<span style="color:#f92672">);</span>
            canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">drawRect</span><span style="color:#f92672">(</span>right <span style="color:#f92672">-</span> length<span style="color:#f92672">,</span> top<span style="color:#f92672">,</span> right<span style="color:#f92672">,</span> bottom<span style="color:#f92672">,</span> p<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">restoreToCount</span><span style="color:#f92672">(</span>saveCount<span style="color:#f92672">);</span>

        drawAutofilledHighlight<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

        <span style="color:#75715e">// Overlay is part of the content and draws beneath Foreground
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mOverlay <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mOverlay<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            mOverlay<span style="color:#f92672">.</span><span style="color:#a6e22e">getOverlayView</span><span style="color:#f92672">().</span><span style="color:#a6e22e">dispatchDraw</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Step 6, draw decorations (foreground, scrollbars)
</span><span style="color:#75715e"></span>        onDrawForeground<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>debugDraw<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            debugDrawFocus<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>参考：</p>
<ul>
<li><a href="https://developer.android.com/guide/topics/ui/how-android-draws">How Android Draws Views</a></li>
</ul>

                        </div>
                    </div>
                </div>
            </article>
        </div>
    </div>
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    
                </ul>

                <p class="text-muted">
                    
                        Copyright &copy; 风格与布局 2020
                    
                </p>

                <p class="text-muted">
                Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with <a href="https://github.com/puresyntax71/hugo-theme-chunky-poster" target="_blank">Chunky Poster</a>.
                </p>

                <p class="text-muted">
                    <a href="http://beian.miit.gov.cn" target="_blank">蜀ICP备18005659号-1</a>
                </p>
            
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.d608eadfe5ac0688902e.min.js"></script>
        
    








    
</body>
</html>
