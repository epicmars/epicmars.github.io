<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" >
        <meta lang="zh">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Activity启动流程：总览 | androidpi</title>
<meta name="description" content="网络上已经有许多关于这个主题的文章了，但路只有自己走一遍才会熟悉，源码的分析与理解也是一样的。因此从这篇文章开始我将开始从源码阅读中去理解A">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/solid.css" integrity="sha384-TbilV5Lbhlwdyc4RuIV/JhD8NR+BfMrvz4BL5QFa2we1hQu6wvREr3v6XSRfCTRp" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/brands.css" integrity="sha384-7xAnn7Zm3QC1jFjVc1A6v/toepoG3JXboQYzbM0jrPzou9OFXm/fY6Z/XiIebl/k" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/fontawesome.css" integrity="sha384-ozJwkrqb90Oa3ZNb+yKFW2lToAWYdTiF1vt8JiH5ptTGHTGcN7qdoR1F95e0kYyG" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
        
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="/css/article.css" />

    </head>

    <body>
        <div class="site-wrapper">
                <header>
    <nav>
        <a class="home" href="https://www.androidpi.com/">首页</a>
    </nav>
    
</header>
                <div class="site-main">
                    
    <div class="main">
        <div class="article">
            <aside>
                    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#activitymanager启动activity">ActivityManager启动Activity</a></li>
      </ul>
    </li>
  </ul>
</nav>
            </aside>
            <article>
                <div class="title">
                    <h1 id="title">Activity启动流程：总览</h1>
                </div>
                <div class="content">
                        <p>网络上已经有许多关于这个主题的文章了，但路只有自己走一遍才会熟悉，源码的分析与理解也是一样的。因此从这篇文章开始我将开始从源码阅读中去理解Android Framework层以及更多系统相关的知识点。从点到线再到面地去掌握Android开发的武艺。</p>
<h1 id="srccomandroidlauncher3launcherjava">src/com/android/launcher3/Launcher.java</h1>
<p>点击桌面应用Lanucher3的快捷方式:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Launches the intent referred by the clicked shortcut.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param v The view representing the clicked shortcut.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onClick</span><span style="color:#f92672">(</span>View v<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Make sure that rogue clicks don&#39;t get through while allapps is launching, or after the
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// view has detached (it&#39;s possible for this to happen if the view is removed mid touch).
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>v<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindowToken</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mWorkspace<span style="color:#f92672">.</span><span style="color:#a6e22e">isFinishedSwitchingState</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>v <span style="color:#66d9ef">instanceof</span> Workspace<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mWorkspace<span style="color:#f92672">.</span><span style="color:#a6e22e">isInOverviewMode</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                mWorkspace<span style="color:#f92672">.</span><span style="color:#a6e22e">exitOverviewMode</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>v <span style="color:#66d9ef">instanceof</span> CellLayout<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mWorkspace<span style="color:#f92672">.</span><span style="color:#a6e22e">isInOverviewMode</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                mWorkspace<span style="color:#f92672">.</span><span style="color:#a6e22e">exitOverviewMode</span><span style="color:#f92672">(</span>mWorkspace<span style="color:#f92672">.</span><span style="color:#a6e22e">indexOfChild</span><span style="color:#f92672">(</span>v<span style="color:#f92672">),</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        Object tag <span style="color:#f92672">=</span> v<span style="color:#f92672">.</span><span style="color:#a6e22e">getTag</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tag <span style="color:#66d9ef">instanceof</span> ShortcutInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Open shortcut
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> ShortcutInfo shortcut <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ShortcutInfo<span style="color:#f92672">)</span> tag<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">final</span> Intent intent <span style="color:#f92672">=</span> shortcut<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// Check for special shortcuts
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> String shortcutClass <span style="color:#f92672">=</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getClassName</span><span style="color:#f92672">();</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shortcutClass<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>WidgetAdder<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
                    showAllApps<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> AppsCustomizePagedView<span style="color:#f92672">.</span><span style="color:#a6e22e">ContentType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Widgets</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shortcutClass<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>MemoryDumpActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
                    MemoryDumpActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">startDump</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shortcutClass<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>ToggleWeightWatcher<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
                    toggleShowWeightWatcher<span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Start activities
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> pos <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[</span>2<span style="color:#f92672">];</span>
            v<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocationOnScreen</span><span style="color:#f92672">(</span>pos<span style="color:#f92672">);</span>
            intent<span style="color:#f92672">.</span><span style="color:#a6e22e">setSourceBounds</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Rect<span style="color:#f92672">(</span>pos<span style="color:#f92672">[</span>0<span style="color:#f92672">],</span> pos<span style="color:#f92672">[</span>1<span style="color:#f92672">],</span>
                    pos<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> v<span style="color:#f92672">.</span><span style="color:#a6e22e">getWidth</span><span style="color:#f92672">(),</span> pos<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> v<span style="color:#f92672">.</span><span style="color:#a6e22e">getHeight</span><span style="color:#f92672">()));</span>

            <span style="color:#66d9ef">boolean</span> success <span style="color:#f92672">=</span> startActivitySafely<span style="color:#f92672">(</span>v<span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> tag<span style="color:#f92672">);</span>

            mStats<span style="color:#f92672">.</span><span style="color:#a6e22e">recordLaunch</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> shortcut<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>success <span style="color:#f92672">&amp;&amp;</span> v <span style="color:#66d9ef">instanceof</span> BubbleTextView<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mWaitingForResume <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>BubbleTextView<span style="color:#f92672">)</span> v<span style="color:#f92672">;</span>
                mWaitingForResume<span style="color:#f92672">.</span><span style="color:#a6e22e">setStayPressed</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tag <span style="color:#66d9ef">instanceof</span> FolderInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>v <span style="color:#66d9ef">instanceof</span> FolderIcon<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                FolderIcon fi <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>FolderIcon<span style="color:#f92672">)</span> v<span style="color:#f92672">;</span>
                handleFolderClick<span style="color:#f92672">(</span>fi<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>v <span style="color:#f92672">==</span> mAllAppsButton<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isAllAppsVisible<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                showWorkspace<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                onClickAllAppsButton<span style="color:#f92672">(</span>v<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">startActivitySafely</span><span style="color:#f92672">(</span>View v<span style="color:#f92672">,</span> Intent intent<span style="color:#f92672">,</span> Object tag<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">boolean</span> success <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            success <span style="color:#f92672">=</span> startActivity<span style="color:#f92672">(</span>v<span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> tag<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ActivityNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">makeText</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> R<span style="color:#f92672">.</span><span style="color:#a6e22e">string</span><span style="color:#f92672">.</span><span style="color:#a6e22e">activity_not_found</span><span style="color:#f92672">,</span> Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">LENGTH_SHORT</span><span style="color:#f92672">).</span><span style="color:#a6e22e">show</span><span style="color:#f92672">();</span>
            Log<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Unable to launch. tag=&#34;</span> <span style="color:#f92672">+</span> tag <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; intent=&#34;</span> <span style="color:#f92672">+</span> intent<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> success<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">startActivity</span><span style="color:#f92672">(</span>View v<span style="color:#f92672">,</span> Intent intent<span style="color:#f92672">,</span> Object tag<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        intent<span style="color:#f92672">.</span><span style="color:#a6e22e">addFlags</span><span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_ACTIVITY_NEW_TASK</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Only launch using the new animation if the shortcut has not opted out (this is a
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// private contract between launcher and may be ignored in the future).
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> useLaunchAnimation <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>v <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                    <span style="color:#f92672">!</span>intent<span style="color:#f92672">.</span><span style="color:#a6e22e">hasExtra</span><span style="color:#f92672">(</span>INTENT_EXTRA_IGNORE_LAUNCH_ANIMATION<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>useLaunchAnimation<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                ActivityOptions opts <span style="color:#f92672">=</span> ActivityOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">makeScaleUpAnimation</span><span style="color:#f92672">(</span>v<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span>
                        v<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredWidth</span><span style="color:#f92672">(),</span> v<span style="color:#f92672">.</span><span style="color:#a6e22e">getMeasuredHeight</span><span style="color:#f92672">());</span>

                startActivity<span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> opts<span style="color:#f92672">.</span><span style="color:#a6e22e">toBundle</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                startActivity<span style="color:#f92672">(</span>intent<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>SecurityException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">makeText</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> R<span style="color:#f92672">.</span><span style="color:#a6e22e">string</span><span style="color:#f92672">.</span><span style="color:#a6e22e">activity_not_found</span><span style="color:#f92672">,</span> Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">LENGTH_SHORT</span><span style="color:#f92672">).</span><span style="color:#a6e22e">show</span><span style="color:#f92672">();</span>
            Log<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Launcher does not have the permission to launch &#34;</span> <span style="color:#f92672">+</span> intent <span style="color:#f92672">+</span>
                    <span style="color:#e6db74">&#34;. Make sure to create a MAIN intent-filter for the corresponding activity &#34;</span> <span style="color:#f92672">+</span>
                    <span style="color:#e6db74">&#34;or use the exported attribute for this activity. &#34;</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;tag=&#34;</span><span style="color:#f92672">+</span> tag <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; intent=&#34;</span> <span style="color:#f92672">+</span> intent<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><!-- raw HTML omitted -->
<p>上述过程中最终调用到Activity的<code>startActivity</code>方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startActivity</span><span style="color:#f92672">(</span>Intent intent<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> Bundle options<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>options <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            startActivityForResult<span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">,</span> options<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Note we want to go through this call for compatibility with
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// applications that may have overridden the method.
</span><span style="color:#75715e"></span>            startActivityForResult<span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>然后调用<code>startActivityForResult</code>方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Launch an activity for which you would like a result when it finished.
</span><span style="color:#75715e">     * When this activity exits, your
</span><span style="color:#75715e">     * onActivityResult() method will be called with the given requestCode.
</span><span style="color:#75715e">     * Using a negative requestCode is the same as calling
</span><span style="color:#75715e">     * {@link #startActivity} (the activity is not launched as a sub-activity).
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;Note that this method should only be used with Intent protocols
</span><span style="color:#75715e">     * that are defined to return a result.  In other protocols (such as
</span><span style="color:#75715e">     * {@link Intent#ACTION_MAIN} or {@link Intent#ACTION_VIEW}), you may
</span><span style="color:#75715e">     * not get the result when you expect.  For example, if the activity you
</span><span style="color:#75715e">     * are launching uses {@link Intent#FLAG_ACTIVITY_NEW_TASK}, it will not
</span><span style="color:#75715e">     * run in your task and thus you will immediately receive a cancel result.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;As a special case, if you call startActivityForResult() with a requestCode
</span><span style="color:#75715e">     * &gt;= 0 during the initial onCreate(Bundle savedInstanceState)/onResume() of your
</span><span style="color:#75715e">     * activity, then your window will not be displayed until a result is
</span><span style="color:#75715e">     * returned back from the started activity.  This is to avoid visible
</span><span style="color:#75715e">     * flickering when redirecting to another activity.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;This method throws {@link android.content.ActivityNotFoundException}
</span><span style="color:#75715e">     * if there was no Activity found to run the given Intent.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param intent The intent to start.
</span><span style="color:#75715e">     * @param requestCode If &gt;= 0, this code will be returned in
</span><span style="color:#75715e">     *                    onActivityResult() when the activity exits.
</span><span style="color:#75715e">     * @param options Additional options for how the Activity should be started.
</span><span style="color:#75715e">     * See {@link android.content.Context#startActivity(Intent, Bundle)}
</span><span style="color:#75715e">     * Context.startActivity(Intent, Bundle)} for more details.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @throws android.content.ActivityNotFoundException
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @see #startActivity
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startActivityForResult</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@RequiresPermission</span> Intent intent<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span>
            <span style="color:#a6e22e">@Nullable</span> Bundle options<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mParent <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            options <span style="color:#f92672">=</span> transferSpringboardActivityOptions<span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
            Instrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">ActivityResult</span> ar <span style="color:#f92672">=</span>
                mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">execStartActivity</span><span style="color:#f92672">(</span>
                    <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> mMainThread<span style="color:#f92672">.</span><span style="color:#a6e22e">getApplicationThread</span><span style="color:#f92672">(),</span> mToken<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span>
                    intent<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> options<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ar <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mMainThread<span style="color:#f92672">.</span><span style="color:#a6e22e">sendActivityResult</span><span style="color:#f92672">(</span>
                    mToken<span style="color:#f92672">,</span> mEmbeddedID<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> ar<span style="color:#f92672">.</span><span style="color:#a6e22e">getResultCode</span><span style="color:#f92672">(),</span>
                    ar<span style="color:#f92672">.</span><span style="color:#a6e22e">getResultData</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestCode <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If this start is requesting a result, we can avoid making
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the activity visible until the result is received.  Setting
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// activity hidden during this time, to avoid flickering.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// This can only be done when a result is requested because
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// that guarantees we will get information back when the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// activity is finished, no matter what happens to it.
</span><span style="color:#75715e"></span>                mStartedActivity <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            cancelInputsAndStartExitTransition<span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
            <span style="color:#75715e">// TODO Consider clearing/flushing other event sources and events for child windows.
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>options <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mParent<span style="color:#f92672">.</span><span style="color:#a6e22e">startActivityFromChild</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> options<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Note we want to go through this method for compatibility with
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// existing applications that may have overridden it.
</span><span style="color:#75715e"></span>                mParent<span style="color:#f92672">.</span><span style="color:#a6e22e">startActivityFromChild</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><!-- raw HTML omitted -->
<p>其中，参数<code>requestCode</code>为-1也就是不需要在<code>onActivityResult()</code>中返回结果，如果需要，<code>options</code>参数用于展示一个从图标到Activity界面的动画效果。进入代码正文，Activity的mParent参数是已经被弃用的ActivityGroup所遗留下的嵌套Activity问题，现在已改用Fragment。因此该参数一般为<code>null</code>，也就直接进入到类<code>Instrumentation</code>的<code>execStartActivity()</code>方法中:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Execute a startActivity call made by the application.  The default 
</span><span style="color:#75715e">     * implementation takes care of updating any active {@link ActivityMonitor}
</span><span style="color:#75715e">     * objects and dispatches this call to the system activity manager; you can
</span><span style="color:#75715e">     * override this to watch for the application to start an activity, and 
</span><span style="color:#75715e">     * modify what happens when it does.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;This method returns an {@link ActivityResult} object, which you can 
</span><span style="color:#75715e">     * use when intercepting application calls to avoid performing the start 
</span><span style="color:#75715e">     * activity action but still return the result the application is 
</span><span style="color:#75715e">     * expecting.  To do this, override this method to catch the call to start 
</span><span style="color:#75715e">     * activity so that it returns a new ActivityResult containing the results 
</span><span style="color:#75715e">     * you would like the application to see, and don&#39;t call up to the super 
</span><span style="color:#75715e">     * class.  Note that an application is only expecting a result if 
</span><span style="color:#75715e">     * &lt;var&gt;requestCode&lt;/var&gt; is &amp;gt;= 0.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;This method throws {@link android.content.ActivityNotFoundException}
</span><span style="color:#75715e">     * if there was no Activity found to run the given Intent.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param who The Context from which the activity is being started.
</span><span style="color:#75715e">     * @param contextThread The main thread of the Context from which the activity
</span><span style="color:#75715e">     *                      is being started.
</span><span style="color:#75715e">     * @param token Internal token identifying to the system who is starting 
</span><span style="color:#75715e">     *              the activity; may be null.
</span><span style="color:#75715e">     * @param target Which activity is performing the start (and thus receiving 
</span><span style="color:#75715e">     *               any result); may be null if this call is not being made
</span><span style="color:#75715e">     *               from an activity.
</span><span style="color:#75715e">     * @param intent The actual Intent to start.
</span><span style="color:#75715e">     * @param requestCode Identifier for this request&#39;s result; less than zero 
</span><span style="color:#75715e">     *                    if the caller is not expecting a result.
</span><span style="color:#75715e">     * @param options Addition options.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @return To force the return of a particular result, return an 
</span><span style="color:#75715e">     *         ActivityResult object containing the desired data; otherwise
</span><span style="color:#75715e">     *         return null.  The default implementation always returns null.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @throws android.content.ActivityNotFoundException
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @see Activity#startActivity(Intent)
</span><span style="color:#75715e">     * @see Activity#startActivityForResult(Intent, int)
</span><span style="color:#75715e">     * @see Activity#startActivityFromChild
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * {@hide}
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> ActivityResult <span style="color:#a6e22e">execStartActivity</span><span style="color:#f92672">(</span>
            Context who<span style="color:#f92672">,</span> IBinder contextThread<span style="color:#f92672">,</span> IBinder token<span style="color:#f92672">,</span> Activity target<span style="color:#f92672">,</span>
            Intent intent<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span> Bundle options<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        IApplicationThread whoThread <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>IApplicationThread<span style="color:#f92672">)</span> contextThread<span style="color:#f92672">;</span>
        Uri referrer <span style="color:#f92672">=</span> target <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">onProvideReferrer</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>referrer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            intent<span style="color:#f92672">.</span><span style="color:#a6e22e">putExtra</span><span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">EXTRA_REFERRER</span><span style="color:#f92672">,</span> referrer<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mActivityMonitors <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mSync<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> N <span style="color:#f92672">=</span> mActivityMonitors<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span> i<span style="color:#f92672">&lt;</span>N<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> ActivityMonitor am <span style="color:#f92672">=</span> mActivityMonitors<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                    ActivityResult result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>am<span style="color:#f92672">.</span><span style="color:#a6e22e">ignoreMatchingSpecificIntents</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        result <span style="color:#f92672">=</span> am<span style="color:#f92672">.</span><span style="color:#a6e22e">onStartActivity</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        am<span style="color:#f92672">.</span><span style="color:#a6e22e">mHits</span><span style="color:#f92672">++;</span>
                        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>am<span style="color:#f92672">.</span><span style="color:#a6e22e">match</span><span style="color:#f92672">(</span>who<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> intent<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        am<span style="color:#f92672">.</span><span style="color:#a6e22e">mHits</span><span style="color:#f92672">++;</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>am<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlocking</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">return</span> requestCode <span style="color:#f92672">&gt;=</span> 0 <span style="color:#f92672">?</span> am<span style="color:#f92672">.</span><span style="color:#a6e22e">getResult</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            intent<span style="color:#f92672">.</span><span style="color:#a6e22e">migrateExtraStreamToClipData</span><span style="color:#f92672">();</span>
            intent<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareToLeaveProcess</span><span style="color:#f92672">(</span>who<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">startActivity</span><span style="color:#f92672">(</span>whoThread<span style="color:#f92672">,</span> who<span style="color:#f92672">.</span><span style="color:#a6e22e">getBasePackageName</span><span style="color:#f92672">(),</span> intent<span style="color:#f92672">,</span>
                        intent<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveTypeIfNeeded</span><span style="color:#f92672">(</span>who<span style="color:#f92672">.</span><span style="color:#a6e22e">getContentResolver</span><span style="color:#f92672">()),</span>
                        token<span style="color:#f92672">,</span> target <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">mEmbeddedID</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                        requestCode<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> options<span style="color:#f92672">);</span>
            checkStartActivityResult<span style="color:#f92672">(</span>result<span style="color:#f92672">,</span> intent<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failure from system&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>这个方法的用处注释里也说的很清楚了，即：</p>
<blockquote>
<p>执行一个由应用发起的startActivity调用。默认实现是更新所有活跃的<code>ActivityMonitor</code>对象，并将该调用分发给系统 activity manager；可以重写该方法来观察activity的启动并修改启动时的行为。</p>
</blockquote>
<p>注意，这里说的一个由应用发起的startActivity调用，由于启动Activity都会调用到该方法，如果是从Launcher启动的，那么该应用就是Launcher，当然也可以是其它应用。否则便是Activity所在的应用自身了。这里涉及到谁先与ActivityManager进行通信。</p>
<p>方法中的<code>contextThread</code>参数是一个IBinder对象，是发起调用应用（简称源应用）主线程<code>ActivityThread</code>的一个<code>ApplicationThread</code>变量，在定义时直接进行实例化：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> ApplicationThread mAppThread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ApplicationThread<span style="color:#f92672">()</span>
</code></pre></div><p>那么这个<code>ApplicationThread</code>又是何方神圣，查找其定义会发现它是<code>ActivityThread</code>的一个私有内部类，也就是说只有<code>ActivityThread</code>可以直接使用该类。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApplicationThread</span> <span style="color:#66d9ef">extends</span> IApplicationThread<span style="color:#f92672">.</span><span style="color:#a6e22e">Stub</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>它继承了<code>IApplicationThread.Stub</code>，看名字就像一个aidl接口生成的类，找到该aidl代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * System private API for communicating with the application.  This is given to
</span><span style="color:#75715e"> * the activity manager by an application  when it starts up, for the activity
</span><span style="color:#75715e"> * manager to tell the application about things it needs to do.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * {@hide}
</span><span style="color:#75715e"> */</span>
oneway <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IApplicationThread</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">schedulePauseActivity</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> finished<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> userLeaving<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> configChanges<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> dontReport<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleStopActivity</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> showWindow<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> configChanges<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleWindowVisibility</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> showWindow<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleResumeActivity</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> procState<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> isForward<span style="color:#f92672">,</span>
            in Bundle resumeArgs<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleSendResult</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span> in List<span style="color:#f92672">&lt;</span>ResultInfo<span style="color:#f92672">&gt;</span> results<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleLaunchActivity</span><span style="color:#f92672">(</span>in Intent intent<span style="color:#f92672">,</span> IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> ident<span style="color:#f92672">,</span>
            in ActivityInfo info<span style="color:#f92672">,</span> in Configuration curConfig<span style="color:#f92672">,</span> in Configuration overrideConfig<span style="color:#f92672">,</span>
            in CompatibilityInfo compatInfo<span style="color:#f92672">,</span> in String referrer<span style="color:#f92672">,</span> IVoiceInteractor voiceInteractor<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> procState<span style="color:#f92672">,</span> in Bundle state<span style="color:#f92672">,</span> in PersistableBundle persistentState<span style="color:#f92672">,</span>
            in List<span style="color:#f92672">&lt;</span>ResultInfo<span style="color:#f92672">&gt;</span> pendingResults<span style="color:#f92672">,</span> in List<span style="color:#f92672">&lt;</span>ReferrerIntent<span style="color:#f92672">&gt;</span> pendingNewIntents<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> notResumed<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> isForward<span style="color:#f92672">,</span> in ProfilerInfo profilerInfo<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleNewIntent</span><span style="color:#f92672">(</span>
            in List<span style="color:#f92672">&lt;</span>ReferrerIntent<span style="color:#f92672">&gt;</span> intent<span style="color:#f92672">,</span> IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> andPause<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleDestroyActivity</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> finished<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> configChanges<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleReceiver</span><span style="color:#f92672">(</span>in Intent intent<span style="color:#f92672">,</span> in ActivityInfo info<span style="color:#f92672">,</span>
            in CompatibilityInfo compatInfo<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> resultCode<span style="color:#f92672">,</span> in String data<span style="color:#f92672">,</span> in Bundle extras<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> sync<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> sendingUser<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> processState<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleCreateService</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span> in ServiceInfo info<span style="color:#f92672">,</span>
            in CompatibilityInfo compatInfo<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> processState<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleStopService</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bindApplication</span><span style="color:#f92672">(</span>in String packageName<span style="color:#f92672">,</span> in ApplicationInfo info<span style="color:#f92672">,</span>
            in List<span style="color:#f92672">&lt;</span>ProviderInfo<span style="color:#f92672">&gt;</span> providers<span style="color:#f92672">,</span> in ComponentName testName<span style="color:#f92672">,</span>
            in ProfilerInfo profilerInfo<span style="color:#f92672">,</span> in Bundle testArguments<span style="color:#f92672">,</span>
            IInstrumentationWatcher testWatcher<span style="color:#f92672">,</span> IUiAutomationConnection uiAutomationConnection<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> debugMode<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> enableBinderTracking<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> trackAllocation<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> restrictedBackupMode<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> persistent<span style="color:#f92672">,</span> in Configuration config<span style="color:#f92672">,</span>
            in CompatibilityInfo compatInfo<span style="color:#f92672">,</span> in Map services<span style="color:#f92672">,</span>
            in Bundle coreSettings<span style="color:#f92672">,</span> in String buildSerial<span style="color:#f92672">);</span>
    <span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>注释上说：</p>
<blockquote>
<p>IApplicationThread用于和应用进行通信，在应用启动时将其传给activity manager，然后activity manager通知应用应该进行的操作。</p>
</blockquote>
<p>随后通过调用<code>ActivityManager.getService().startActivity()</code>方法，并将这个<code>IApplicationThread</code>对象作为参数传入，这里开始启动流程进入另一个阶段。</p>
<p>上面<code>execStartActivity()</code>方法的另一个参数<code>mToken</code>也是一个IBinder对象，在<code>attach()</code>方法中赋值，这里暂不讨论。</p>
<h3 id="activitymanager启动activity">ActivityManager启动Activity</h3>
<p><code>ActivityManager.getService()</code>方法用于获取ActivityManagerService的代理，它是系统服务的一部分，负责管理四大组件的启动、生命周期调度，以及应用进程的管理和调度等工作。</p>
<p>ActivityManager.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> IActivityManager <span style="color:#a6e22e">getService</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> IActivityManagerSingleton<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Singleton<span style="color:#f92672">&lt;</span>IActivityManager<span style="color:#f92672">&gt;</span> IActivityManagerSingleton <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> Singleton<span style="color:#f92672">&lt;</span>IActivityManager<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">protected</span> IActivityManager <span style="color:#a6e22e">create</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> IBinder b <span style="color:#f92672">=</span> ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTIVITY_SERVICE</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">final</span> IActivityManager am <span style="color:#f92672">=</span> IActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">Stub</span><span style="color:#f92672">.</span><span style="color:#a6e22e">asInterface</span><span style="color:#f92672">(</span>b<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> am<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">};</span>
</code></pre></div><p>那么，ActivityManagerService是何时注册的，从<code>SystemServer</code>启动的代码中，可以看出：
SystemServer.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startBootstrapServices</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">...</span>
            <span style="color:#75715e">// Activity manager runs the show.
</span><span style="color:#75715e"></span>        traceBeginAndSlog<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;StartActivityManager&#34;</span><span style="color:#f92672">);</span>
        mActivityManagerService <span style="color:#f92672">=</span> mSystemServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">startService</span><span style="color:#f92672">(</span>
                ActivityManagerService<span style="color:#f92672">.</span><span style="color:#a6e22e">Lifecycle</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">();</span>
        mActivityManagerService<span style="color:#f92672">.</span><span style="color:#a6e22e">setSystemServiceManager</span><span style="color:#f92672">(</span>mSystemServiceManager<span style="color:#f92672">);</span>
        mActivityManagerService<span style="color:#f92672">.</span><span style="color:#a6e22e">setInstaller</span><span style="color:#f92672">(</span>installer<span style="color:#f92672">);</span>
        traceEnd<span style="color:#f92672">()</span>
    <span style="color:#f92672">...</span>
            <span style="color:#75715e">// Set up the Application instance for the system process and get started.
</span><span style="color:#75715e"></span>        traceBeginAndSlog<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SetSystemProcess&#34;</span><span style="color:#f92672">);</span>
        mActivityManagerService<span style="color:#f92672">.</span><span style="color:#a6e22e">setSystemProcess</span><span style="color:#f92672">();</span>
        traceEnd<span style="color:#f92672">();</span>
    <span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>然后，<code>mActivityManagerService.setSystemProcess()</code>调用如下，这是它将自身注册到了<code>ServiceManager</code>。
ActivityManagerService.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setSystemProcess</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTIVITY_SERVICE</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span>ProcessStats<span style="color:#f92672">.</span><span style="color:#a6e22e">SERVICE_NAME</span><span style="color:#f92672">,</span> mProcessStats<span style="color:#f92672">);</span>
            ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;meminfo&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> MemBinder<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">));</span>
            ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;gfxinfo&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> GraphicsBinder<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">));</span>
            ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;dbinfo&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> DbBinder<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">));</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>MONITOR_CPU_USAGE<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;cpuinfo&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> CpuBinder<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">));</span>
            <span style="color:#f92672">}</span>
            ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;permission&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> PermissionController<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">));</span>
            ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;processinfo&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ProcessInfoService<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">));</span>

            ApplicationInfo info <span style="color:#f92672">=</span> mContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getApplicationInfo</span><span style="color:#f92672">(</span>
                    <span style="color:#e6db74">&#34;android&#34;</span><span style="color:#f92672">,</span> STOCK_PM_FLAGS <span style="color:#f92672">|</span> MATCH_SYSTEM_ONLY<span style="color:#f92672">);</span>
            mSystemThread<span style="color:#f92672">.</span><span style="color:#a6e22e">installSystemApplicationInfo</span><span style="color:#f92672">(</span>info<span style="color:#f92672">,</span> getClass<span style="color:#f92672">().</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">());</span>

            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                ProcessRecord app <span style="color:#f92672">=</span> newProcessRecordLocked<span style="color:#f92672">(</span>info<span style="color:#f92672">,</span> info<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
                app<span style="color:#f92672">.</span><span style="color:#a6e22e">persistent</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                app<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span> <span style="color:#f92672">=</span> MY_PID<span style="color:#f92672">;</span>
                app<span style="color:#f92672">.</span><span style="color:#a6e22e">maxAdj</span> <span style="color:#f92672">=</span> ProcessList<span style="color:#f92672">.</span><span style="color:#a6e22e">SYSTEM_ADJ</span><span style="color:#f92672">;</span>
                app<span style="color:#f92672">.</span><span style="color:#a6e22e">makeActive</span><span style="color:#f92672">(</span>mSystemThread<span style="color:#f92672">.</span><span style="color:#a6e22e">getApplicationThread</span><span style="color:#f92672">(),</span> mProcessStats<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mPidsSelfLocked<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mPidsSelfLocked<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">,</span> app<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                updateLruProcessLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                updateOomAdjLocked<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>PackageManager<span style="color:#f92672">.</span><span style="color:#a6e22e">NameNotFoundException</span> e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
                    <span style="color:#e6db74">&#34;Unable to find android system package&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>因此<code>ServiceManager.getService(Context.ACTIVITY_SERVICE)</code>拿到的是<code>ActivityManagerService</code>，它继承了IActivityManager.Stub，这里也是一个aidl接口，它提供了与activity manager service通信的API，提供的是从应用到activity manager的调用。</p>
<p>IActivityManager.aidl</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * System private API for talking with the activity manager service.  This
</span><span style="color:#75715e"> * provides calls from the application back to the activity manager.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * {@hide}
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IActivityManager</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">startActivity</span><span style="color:#f92672">(</span>in IApplicationThread caller<span style="color:#f92672">,</span> in String callingPackage<span style="color:#f92672">,</span> in Intent intent<span style="color:#f92672">,</span>
        in String resolvedType<span style="color:#f92672">,</span> in IBinder resultTo<span style="color:#f92672">,</span> in String resultWho<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">int</span> flags<span style="color:#f92672">,</span> in ProfilerInfo profilerInfo<span style="color:#f92672">,</span> in Bundle options<span style="color:#f92672">);</span>
    <span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>那么，很显然，<code>ActivityManager.getService().startActivity()</code>会利用Binder作进程间通信。</p>
<p>ActivityManagerService.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">startActivity</span><span style="color:#f92672">(</span>IApplicationThread caller<span style="color:#f92672">,</span> String callingPackage<span style="color:#f92672">,</span>
            Intent intent<span style="color:#f92672">,</span> String resolvedType<span style="color:#f92672">,</span> IBinder resultTo<span style="color:#f92672">,</span> String resultWho<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> startFlags<span style="color:#f92672">,</span> ProfilerInfo profilerInfo<span style="color:#f92672">,</span> Bundle bOptions<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 获取源进程的UserId
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> startActivityAsUser<span style="color:#f92672">(</span>caller<span style="color:#f92672">,</span> callingPackage<span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">,</span> resultTo<span style="color:#f92672">,</span>
                resultWho<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span> profilerInfo<span style="color:#f92672">,</span> bOptions<span style="color:#f92672">,</span>
                UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallingUserId</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">startActivityAsUser</span><span style="color:#f92672">(</span>IApplicationThread caller<span style="color:#f92672">,</span> String callingPackage<span style="color:#f92672">,</span>
            Intent intent<span style="color:#f92672">,</span> String resolvedType<span style="color:#f92672">,</span> IBinder resultTo<span style="color:#f92672">,</span> String resultWho<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> startFlags<span style="color:#f92672">,</span> ProfilerInfo profilerInfo<span style="color:#f92672">,</span> Bundle bOptions<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> userId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        enforceNotIsolatedCaller<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;startActivity&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// 检查用户权限
</span><span style="color:#75715e"></span>        userId <span style="color:#f92672">=</span> mUserController<span style="color:#f92672">.</span><span style="color:#a6e22e">handleIncomingUser</span><span style="color:#f92672">(</span>Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallingPid</span><span style="color:#f92672">(),</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallingUid</span><span style="color:#f92672">(),</span>
                userId<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> ALLOW_FULL_ONLY<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startActivity&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// TODO: Switch to user app stacks here.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> mActivityStarter<span style="color:#f92672">.</span><span style="color:#a6e22e">startActivityMayWait</span><span style="color:#f92672">(</span>caller<span style="color:#f92672">,</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">,</span> callingPackage<span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span>
                resolvedType<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> resultTo<span style="color:#f92672">,</span> resultWho<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span>
                profilerInfo<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> bOptions<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> userId<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startActivityAsUser&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>ActivityStarter.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">startActivityMayWait</span><span style="color:#f92672">(</span>IApplicationThread caller<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> callingUid<span style="color:#f92672">,</span>
            String callingPackage<span style="color:#f92672">,</span> Intent intent<span style="color:#f92672">,</span> String resolvedType<span style="color:#f92672">,</span>
            IVoiceInteractionSession voiceSession<span style="color:#f92672">,</span> IVoiceInteractor voiceInteractor<span style="color:#f92672">,</span>
            IBinder resultTo<span style="color:#f92672">,</span> String resultWho<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> startFlags<span style="color:#f92672">,</span>
            ProfilerInfo profilerInfo<span style="color:#f92672">,</span> WaitResult outResult<span style="color:#f92672">,</span>
            Configuration globalConfig<span style="color:#f92672">,</span> Bundle bOptions<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> ignoreTargetSecurity<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> userId<span style="color:#f92672">,</span>
            TaskRecord inTask<span style="color:#f92672">,</span> String reason<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Refuse possible leaked file descriptors
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>intent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">hasFileDescriptors</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;File descriptors passed in Intent&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mActivityMetricsLogger</span><span style="color:#f92672">.</span><span style="color:#a6e22e">notifyActivityLaunching</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">boolean</span> componentSpecified <span style="color:#f92672">=</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// Save a copy in case ephemeral needs it
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> Intent ephemeralIntent <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Intent<span style="color:#f92672">(</span>intent<span style="color:#f92672">);</span>
        <span style="color:#75715e">// Don&#39;t modify the client&#39;s object!
</span><span style="color:#75715e"></span>        intent <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Intent<span style="color:#f92672">(</span>intent<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>componentSpecified
                <span style="color:#f92672">&amp;&amp;</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getData</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                <span style="color:#f92672">&amp;&amp;</span> Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_VIEW</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getAction</span><span style="color:#f92672">())</span>
                <span style="color:#f92672">&amp;&amp;</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManagerInternalLocked</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">isInstantAppInstallerComponent</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// intercept intents targeted directly to the ephemeral installer the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// ephemeral installer should never be started with a raw URL; instead
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// adjust the intent so it looks like a &#34;normal&#34; instant app launch
</span><span style="color:#75715e"></span>            intent<span style="color:#f92672">.</span><span style="color:#a6e22e">setComponent</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#75715e">/*component*/</span><span style="color:#f92672">);</span>
            componentSpecified <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        ResolveInfo rInfo <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveIntent</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">,</span> userId<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rInfo <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            UserInfo userInfo <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(</span>userId<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>userInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> userInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">isManagedProfile</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Special case for managed profiles, if attempting to launch non-cryto aware
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// app in a locked managed profile from an unlocked parent allow it to resolve
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// as user will be sent via confirm credentials to unlock the profile.
</span><span style="color:#75715e"></span>                UserManager userManager <span style="color:#f92672">=</span> UserManager<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mContext</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">boolean</span> profileLockedAndParentUnlockingOrUnlocked <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">long</span> token <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">clearCallingIdentity</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    UserInfo parent <span style="color:#f92672">=</span> userManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getProfileParent</span><span style="color:#f92672">(</span>userId<span style="color:#f92672">);</span>
                    profileLockedAndParentUnlockingOrUnlocked <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>parent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                            <span style="color:#f92672">&amp;&amp;</span> userManager<span style="color:#f92672">.</span><span style="color:#a6e22e">isUserUnlockingOrUnlocked</span><span style="color:#f92672">(</span>parent<span style="color:#f92672">.</span><span style="color:#a6e22e">id</span><span style="color:#f92672">)</span>
                            <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>userManager<span style="color:#f92672">.</span><span style="color:#a6e22e">isUserUnlockingOrUnlocked</span><span style="color:#f92672">(</span>userId<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                    Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">restoreCallingIdentity</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>profileLockedAndParentUnlockingOrUnlocked<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    rInfo <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveIntent</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">,</span> userId<span style="color:#f92672">,</span>
                            PackageManager<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_DIRECT_BOOT_AWARE</span>
                                    <span style="color:#f92672">|</span> PackageManager<span style="color:#f92672">.</span><span style="color:#a6e22e">MATCH_DIRECT_BOOT_UNAWARE</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// Collect information about the target of the Intent.
</span><span style="color:#75715e"></span>        ActivityInfo aInfo <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveActivity</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> rInfo<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span> profilerInfo<span style="color:#f92672">);</span>

        ActivityOptions options <span style="color:#f92672">=</span> ActivityOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">fromBundle</span><span style="color:#f92672">(</span>bOptions<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mService<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> realCallingPid <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallingPid</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> realCallingUid <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallingUid</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">int</span> callingPid<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>callingUid <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                callingPid <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>caller <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                callingPid <span style="color:#f92672">=</span> realCallingPid<span style="color:#f92672">;</span>
                callingUid <span style="color:#f92672">=</span> realCallingUid<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                callingPid <span style="color:#f92672">=</span> callingUid <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">final</span> ActivityStack stack <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mFocusedStack</span><span style="color:#f92672">;</span>
            stack<span style="color:#f92672">.</span><span style="color:#a6e22e">mConfigWillChange</span> <span style="color:#f92672">=</span> globalConfig <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                    <span style="color:#f92672">&amp;&amp;</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getGlobalConfiguration</span><span style="color:#f92672">().</span><span style="color:#a6e22e">diff</span><span style="color:#f92672">(</span>globalConfig<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_CONFIGURATION<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_CONFIGURATION<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;Starting activity when config will change = &#34;</span> <span style="color:#f92672">+</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">mConfigWillChange</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> origId <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">clearCallingIdentity</span><span style="color:#f92672">();</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>aInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span>
                    <span style="color:#f92672">(</span>aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">privateFlags</span>
                            <span style="color:#f92672">&amp;</span> ApplicationInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">PRIVATE_FLAG_CANT_SAVE_STATE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// This may be a heavy-weight process!  Check to see if we already
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// have another, different heavy-weight process running.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> ProcessRecord heavy <span style="color:#f92672">=</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mHeavyWeightProcess</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>heavy <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>heavy<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span>
                            <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>heavy<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">int</span> appCallingUid <span style="color:#f92672">=</span> callingUid<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>caller <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            ProcessRecord callerApp <span style="color:#f92672">=</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getRecordForAppLocked</span><span style="color:#f92672">(</span>caller<span style="color:#f92672">);</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>callerApp <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                appCallingUid <span style="color:#f92672">=</span> callerApp<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Unable to find app for caller &#34;</span> <span style="color:#f92672">+</span> caller
                                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; (pid=&#34;</span> <span style="color:#f92672">+</span> callingPid <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) when starting: &#34;</span>
                                        <span style="color:#f92672">+</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
                                ActivityOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">abort</span><span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
                                <span style="color:#66d9ef">return</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_PERMISSION_DENIED</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>

                        IIntentSender target <span style="color:#f92672">=</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getIntentSenderLocked</span><span style="color:#f92672">(</span>
                                ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">INTENT_SENDER_ACTIVITY</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;android&#34;</span><span style="color:#f92672">,</span>
                                appCallingUid<span style="color:#f92672">,</span> userId<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Intent<span style="color:#f92672">[]</span> <span style="color:#f92672">{</span> intent <span style="color:#f92672">},</span>
                                <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span> <span style="color:#f92672">{</span> resolvedType <span style="color:#f92672">},</span> PendingIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_CANCEL_CURRENT</span>
                                        <span style="color:#f92672">|</span> PendingIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_ONE_SHOT</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>

                        Intent newIntent <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Intent<span style="color:#f92672">();</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestCode <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#75715e">// Caller is requesting a result.
</span><span style="color:#75715e"></span>                            newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">putExtra</span><span style="color:#f92672">(</span>HeavyWeightSwitcherActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">KEY_HAS_RESULT</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                        newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">putExtra</span><span style="color:#f92672">(</span>HeavyWeightSwitcherActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">KEY_INTENT</span><span style="color:#f92672">,</span>
                                <span style="color:#66d9ef">new</span> IntentSender<span style="color:#f92672">(</span>target<span style="color:#f92672">));</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>heavy<span style="color:#f92672">.</span><span style="color:#a6e22e">activities</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            ActivityRecord hist <span style="color:#f92672">=</span> heavy<span style="color:#f92672">.</span><span style="color:#a6e22e">activities</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
                            newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">putExtra</span><span style="color:#f92672">(</span>HeavyWeightSwitcherActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">KEY_CUR_APP</span><span style="color:#f92672">,</span>
                                    hist<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">);</span>
                            newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">putExtra</span><span style="color:#f92672">(</span>HeavyWeightSwitcherActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">KEY_CUR_TASK</span><span style="color:#f92672">,</span>
                                    hist<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">taskId</span><span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                        newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">putExtra</span><span style="color:#f92672">(</span>HeavyWeightSwitcherActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">KEY_NEW_APP</span><span style="color:#f92672">,</span>
                                aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">);</span>
                        newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">setFlags</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getFlags</span><span style="color:#f92672">());</span>
                        newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">setClassName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;android&#34;</span><span style="color:#f92672">,</span>
                                HeavyWeightSwitcherActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
                        intent <span style="color:#f92672">=</span> newIntent<span style="color:#f92672">;</span>
                        resolvedType <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        caller <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        callingUid <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallingUid</span><span style="color:#f92672">();</span>
                        callingPid <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallingPid</span><span style="color:#f92672">();</span>
                        componentSpecified <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                        rInfo <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveIntent</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span> <span style="color:#75715e">/*resolvedType*/</span><span style="color:#f92672">,</span> userId<span style="color:#f92672">);</span>
                        aInfo <span style="color:#f92672">=</span> rInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> rInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>aInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            aInfo <span style="color:#f92672">=</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getActivityInfoForUser</span><span style="color:#f92672">(</span>aInfo<span style="color:#f92672">,</span> userId<span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">final</span> ActivityRecord<span style="color:#f92672">[]</span> outRecord <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ActivityRecord<span style="color:#f92672">[</span>1<span style="color:#f92672">];</span>
            <span style="color:#66d9ef">int</span> res <span style="color:#f92672">=</span> startActivityLocked<span style="color:#f92672">(</span>caller<span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> ephemeralIntent<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">,</span>
                    aInfo<span style="color:#f92672">,</span> rInfo<span style="color:#f92672">,</span> voiceSession<span style="color:#f92672">,</span> voiceInteractor<span style="color:#f92672">,</span>
                    resultTo<span style="color:#f92672">,</span> resultWho<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> callingPid<span style="color:#f92672">,</span>
                    callingUid<span style="color:#f92672">,</span> callingPackage<span style="color:#f92672">,</span> realCallingPid<span style="color:#f92672">,</span> realCallingUid<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span>
                    options<span style="color:#f92672">,</span> ignoreTargetSecurity<span style="color:#f92672">,</span> componentSpecified<span style="color:#f92672">,</span> outRecord<span style="color:#f92672">,</span> inTask<span style="color:#f92672">,</span>
                    reason<span style="color:#f92672">);</span>

            Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">restoreCallingIdentity</span><span style="color:#f92672">(</span>origId<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stack<span style="color:#f92672">.</span><span style="color:#a6e22e">mConfigWillChange</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If the caller also wants to switch to a new configuration,
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// do so now.  This allows a clean switch, as we are waiting
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// for the current activity to pause (so we will not destroy
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// it), and have not yet started the next activity.
</span><span style="color:#75715e"></span>                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">enforceCallingPermission</span><span style="color:#f92672">(</span>android<span style="color:#f92672">.</span><span style="color:#a6e22e">Manifest</span><span style="color:#f92672">.</span><span style="color:#a6e22e">permission</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CHANGE_CONFIGURATION</span><span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;updateConfiguration()&#34;</span><span style="color:#f92672">);</span>
                stack<span style="color:#f92672">.</span><span style="color:#a6e22e">mConfigWillChange</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_CONFIGURATION<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_CONFIGURATION<span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;Updating to new configuration after starting activity.&#34;</span><span style="color:#f92672">);</span>
                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateConfigurationLocked</span><span style="color:#f92672">(</span>globalConfig<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outResult <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> res<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>res <span style="color:#f92672">==</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_SUCCESS</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mWaitingActivityLaunched</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>outResult<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">do</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">wait</span><span style="color:#f92672">();</span>
                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">result</span> <span style="color:#f92672">!=</span> START_TASK_TO_FRONT
                            <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">timeout</span> <span style="color:#f92672">&amp;&amp;</span> outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">who</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">result</span> <span style="color:#f92672">==</span> START_TASK_TO_FRONT<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        res <span style="color:#f92672">=</span> START_TASK_TO_FRONT<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>res <span style="color:#f92672">==</span> START_TASK_TO_FRONT<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> ActivityRecord r <span style="color:#f92672">=</span> outRecord<span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>

                    <span style="color:#75715e">// ActivityRecord may represent a different activity, but it should not be in
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// the resumed state.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">nowVisible</span> <span style="color:#f92672">&amp;&amp;</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> RESUMED<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">timeout</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                        outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">who</span> <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">realActivity</span><span style="color:#f92672">;</span>
                        outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">totalTime</span> <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                        outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">thisTime</span> <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">thisTime</span> <span style="color:#f92672">=</span> SystemClock<span style="color:#f92672">.</span><span style="color:#a6e22e">uptimeMillis</span><span style="color:#f92672">();</span>
                        mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">waitActivityVisible</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">realActivity</span><span style="color:#f92672">,</span> outResult<span style="color:#f92672">);</span>
                        <span style="color:#75715e">// Note: the timeout variable is not currently not ever set.
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">do</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">wait</span><span style="color:#f92672">();</span>
                            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">timeout</span> <span style="color:#f92672">&amp;&amp;</span> outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">who</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mActivityMetricsLogger</span><span style="color:#f92672">.</span><span style="color:#a6e22e">notifyActivityLaunched</span><span style="color:#f92672">(</span>res<span style="color:#f92672">,</span> outRecord<span style="color:#f92672">[</span>0<span style="color:#f92672">]);</span>
            <span style="color:#66d9ef">return</span> res<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">startActivityLocked</span><span style="color:#f92672">(</span>IApplicationThread caller<span style="color:#f92672">,</span> Intent intent<span style="color:#f92672">,</span> Intent ephemeralIntent<span style="color:#f92672">,</span>
            String resolvedType<span style="color:#f92672">,</span> ActivityInfo aInfo<span style="color:#f92672">,</span> ResolveInfo rInfo<span style="color:#f92672">,</span>
            IVoiceInteractionSession voiceSession<span style="color:#f92672">,</span> IVoiceInteractor voiceInteractor<span style="color:#f92672">,</span>
            IBinder resultTo<span style="color:#f92672">,</span> String resultWho<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> callingPid<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> callingUid<span style="color:#f92672">,</span>
            String callingPackage<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> realCallingPid<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> realCallingUid<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> startFlags<span style="color:#f92672">,</span>
            ActivityOptions options<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> ignoreTargetSecurity<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> componentSpecified<span style="color:#f92672">,</span>
            ActivityRecord<span style="color:#f92672">[]</span> outActivity<span style="color:#f92672">,</span> TaskRecord inTask<span style="color:#f92672">,</span> String reason<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>TextUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>reason<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Need to specify a reason.&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        mLastStartReason <span style="color:#f92672">=</span> reason<span style="color:#f92672">;</span>
        mLastStartActivityTimeMs <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
        mLastStartActivityRecord<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        mLastStartActivityResult <span style="color:#f92672">=</span> startActivity<span style="color:#f92672">(</span>caller<span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> ephemeralIntent<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">,</span>
                aInfo<span style="color:#f92672">,</span> rInfo<span style="color:#f92672">,</span> voiceSession<span style="color:#f92672">,</span> voiceInteractor<span style="color:#f92672">,</span> resultTo<span style="color:#f92672">,</span> resultWho<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span>
                callingPid<span style="color:#f92672">,</span> callingUid<span style="color:#f92672">,</span> callingPackage<span style="color:#f92672">,</span> realCallingPid<span style="color:#f92672">,</span> realCallingUid<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span>
                options<span style="color:#f92672">,</span> ignoreTargetSecurity<span style="color:#f92672">,</span> componentSpecified<span style="color:#f92672">,</span> mLastStartActivityRecord<span style="color:#f92672">,</span>
                inTask<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outActivity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// mLastStartActivityRecord[0] is set in the call to startActivity above.
</span><span style="color:#75715e"></span>            outActivity<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> mLastStartActivityRecord<span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Aborted results are treated as successes externally, but we must track them internally.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> mLastStartActivityResult <span style="color:#f92672">!=</span> START_ABORTED <span style="color:#f92672">?</span> mLastStartActivityResult <span style="color:#f92672">:</span> START_SUCCESS<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/** DO NOT call this method directly. Use {@link #startActivityLocked} instead. */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">startActivity</span><span style="color:#f92672">(</span>IApplicationThread caller<span style="color:#f92672">,</span> Intent intent<span style="color:#f92672">,</span> Intent ephemeralIntent<span style="color:#f92672">,</span>
            String resolvedType<span style="color:#f92672">,</span> ActivityInfo aInfo<span style="color:#f92672">,</span> ResolveInfo rInfo<span style="color:#f92672">,</span>
            IVoiceInteractionSession voiceSession<span style="color:#f92672">,</span> IVoiceInteractor voiceInteractor<span style="color:#f92672">,</span>
            IBinder resultTo<span style="color:#f92672">,</span> String resultWho<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> callingPid<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> callingUid<span style="color:#f92672">,</span>
            String callingPackage<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> realCallingPid<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> realCallingUid<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> startFlags<span style="color:#f92672">,</span>
            ActivityOptions options<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> ignoreTargetSecurity<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> componentSpecified<span style="color:#f92672">,</span>
            ActivityRecord<span style="color:#f92672">[]</span> outActivity<span style="color:#f92672">,</span> TaskRecord inTask<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> err <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_SUCCESS</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// Pull the optional Ephemeral Installer-only bundle out of the options early.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> Bundle verificationBundle
                <span style="color:#f92672">=</span> options <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> options<span style="color:#f92672">.</span><span style="color:#a6e22e">popAppVerificationBundle</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        ProcessRecord callerApp <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>caller <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 获取源进程记录
</span><span style="color:#75715e"></span>            callerApp <span style="color:#f92672">=</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getRecordForAppLocked</span><span style="color:#f92672">(</span>caller<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>callerApp <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                callingPid <span style="color:#f92672">=</span> callerApp<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">;</span>
                callingUid <span style="color:#f92672">=</span> callerApp<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Unable to find app for caller &#34;</span> <span style="color:#f92672">+</span> caller
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; (pid=&#34;</span> <span style="color:#f92672">+</span> callingPid <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) when starting: &#34;</span>
                        <span style="color:#f92672">+</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
                err <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_PERMISSION_DENIED</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> userId <span style="color:#f92672">=</span> aInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserId</span><span style="color:#f92672">(</span>aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">)</span> <span style="color:#f92672">:</span> 0<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>err <span style="color:#f92672">==</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_SUCCESS</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;START u&#34;</span> <span style="color:#f92672">+</span> userId <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; {&#34;</span> <span style="color:#f92672">+</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;} from uid &#34;</span> <span style="color:#f92672">+</span> callingUid<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        ActivityRecord sourceRecord <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        ActivityRecord resultRecord <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resultTo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            sourceRecord <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">isInAnyStackLocked</span><span style="color:#f92672">(</span>resultTo<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_RESULTS<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_RESULTS<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;Will send result to &#34;</span> <span style="color:#f92672">+</span> resultTo <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &#34;</span> <span style="color:#f92672">+</span> sourceRecord<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sourceRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestCode <span style="color:#f92672">&gt;=</span> 0 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>sourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">finishing</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    resultRecord <span style="color:#f92672">=</span> sourceRecord<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> launchFlags <span style="color:#f92672">=</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getFlags</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>launchFlags <span style="color:#f92672">&amp;</span> Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_ACTIVITY_FORWARD_RESULT</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0 <span style="color:#f92672">&amp;&amp;</span> sourceRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Transfer the result target from the source activity to the new
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// one being started, including any failures.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestCode <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                ActivityOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">abort</span><span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_FORWARD_AND_REQUEST_CONFLICT</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            resultRecord <span style="color:#f92672">=</span> sourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">resultTo</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resultRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>resultRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">isInStackLocked</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                resultRecord <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            resultWho <span style="color:#f92672">=</span> sourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">resultWho</span><span style="color:#f92672">;</span>
            requestCode <span style="color:#f92672">=</span> sourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">requestCode</span><span style="color:#f92672">;</span>
            sourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">resultTo</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resultRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                resultRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">removeResultsLocked</span><span style="color:#f92672">(</span>sourceRecord<span style="color:#f92672">,</span> resultWho<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">launchedFromUid</span> <span style="color:#f92672">==</span> callingUid<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// The new activity is being launched from the same uid as the previous
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// activity in the flow, and asking to forward its result back to the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// previous.  In this case the activity is serving as a trampoline between
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the two, so we also want to update its launchedFromPackage to be the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// same as the previous activity.  Note that this is safe, since we know
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// these two packages come from the same uid; the caller could just as
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// well have supplied that same package name itself.  This specifially
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// deals with the case of an intent picker/chooser being launched in the app
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// flow to redirect to an activity picked by the user, where we want the final
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// activity to consider it to have been launched by the previous app activity.
</span><span style="color:#75715e"></span>                callingPackage <span style="color:#f92672">=</span> sourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">launchedFromPackage</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>err <span style="color:#f92672">==</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_SUCCESS</span> <span style="color:#f92672">&amp;&amp;</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// We couldn&#39;t find a class that can handle the given Intent.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// That&#39;s the end of that!
</span><span style="color:#75715e"></span>            err <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_INTENT_NOT_RESOLVED</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>err <span style="color:#f92672">==</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_SUCCESS</span> <span style="color:#f92672">&amp;&amp;</span> aInfo <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// We couldn&#39;t find the specific class specified in the Intent.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// Also the end of the line.
</span><span style="color:#75715e"></span>            err <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_CLASS_NOT_FOUND</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>err <span style="color:#f92672">==</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_SUCCESS</span> <span style="color:#f92672">&amp;&amp;</span> sourceRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                <span style="color:#f92672">&amp;&amp;</span> sourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">voiceSession</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If this activity is being launched as part of a voice session, we need
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// to ensure that it is safe to do so.  If the upcoming activity will also
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// be part of the voice session, we can only launch it if it has explicitly
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// said it supports the VOICE category, or it is a part of the calling app.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>launchFlags <span style="color:#f92672">&amp;</span> FLAG_ACTIVITY_NEW_TASK<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0
                    <span style="color:#f92672">&amp;&amp;</span> sourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    intent<span style="color:#f92672">.</span><span style="color:#a6e22e">addCategory</span><span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">CATEGORY_VOICE</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>AppGlobals<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">activitySupportsIntent</span><span style="color:#f92672">(</span>
                            intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">(),</span> intent<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span>
                                <span style="color:#e6db74">&#34;Activity being started in current voice task does not support voice: &#34;</span>
                                        <span style="color:#f92672">+</span> intent<span style="color:#f92672">);</span>
                        err <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_NOT_VOICE_COMPATIBLE</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Failure checking voice capabilities&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                    err <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_NOT_VOICE_COMPATIBLE</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>err <span style="color:#f92672">==</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_SUCCESS</span> <span style="color:#f92672">&amp;&amp;</span> voiceSession <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If the caller is starting a new voice session, just make sure the target
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// is actually allowing it to run this way.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>AppGlobals<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">activitySupportsIntent</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">(),</span>
                        intent<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span>
                            <span style="color:#e6db74">&#34;Activity being started in new voice task does not support: &#34;</span>
                                    <span style="color:#f92672">+</span> intent<span style="color:#f92672">);</span>
                    err <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_NOT_VOICE_COMPATIBLE</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Failure checking voice capabilities&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                err <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_NOT_VOICE_COMPATIBLE</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> ActivityStack resultStack <span style="color:#f92672">=</span> resultRecord <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">:</span> resultRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">getStack</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>err <span style="color:#f92672">!=</span> START_SUCCESS<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resultRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                resultStack<span style="color:#f92672">.</span><span style="color:#a6e22e">sendActivityResultLocked</span><span style="color:#f92672">(</span>
                        <span style="color:#f92672">-</span>1<span style="color:#f92672">,</span> resultRecord<span style="color:#f92672">,</span> resultWho<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> RESULT_CANCELED<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            ActivityOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">abort</span><span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> err<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">boolean</span> abort <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">checkStartAnyActivityPermission</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> aInfo<span style="color:#f92672">,</span> resultWho<span style="color:#f92672">,</span>
                requestCode<span style="color:#f92672">,</span> callingPid<span style="color:#f92672">,</span> callingUid<span style="color:#f92672">,</span> callingPackage<span style="color:#f92672">,</span> ignoreTargetSecurity<span style="color:#f92672">,</span> callerApp<span style="color:#f92672">,</span>
                resultRecord<span style="color:#f92672">,</span> resultStack<span style="color:#f92672">,</span> options<span style="color:#f92672">);</span>
        abort <span style="color:#f92672">|=</span> <span style="color:#f92672">!</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mIntentFirewall</span><span style="color:#f92672">.</span><span style="color:#a6e22e">checkStartActivity</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> callingUid<span style="color:#f92672">,</span>
                callingPid<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">,</span> aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mController</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// The Intent we give to the watcher has the extra data
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// stripped off, since it can contain private information.
</span><span style="color:#75715e"></span>                Intent watchIntent <span style="color:#f92672">=</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">cloneFilter</span><span style="color:#f92672">();</span>
                abort <span style="color:#f92672">|=</span> <span style="color:#f92672">!</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">activityStarting</span><span style="color:#f92672">(</span>watchIntent<span style="color:#f92672">,</span>
                        aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mController</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        mInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">setStates</span><span style="color:#f92672">(</span>userId<span style="color:#f92672">,</span> realCallingPid<span style="color:#f92672">,</span> realCallingUid<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span> callingPackage<span style="color:#f92672">);</span>
        mInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">intercept</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> rInfo<span style="color:#f92672">,</span> aInfo<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">,</span> inTask<span style="color:#f92672">,</span> callingPid<span style="color:#f92672">,</span> callingUid<span style="color:#f92672">,</span>
                options<span style="color:#f92672">);</span>
        intent <span style="color:#f92672">=</span> mInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">mIntent</span><span style="color:#f92672">;</span>
        rInfo <span style="color:#f92672">=</span> mInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">mRInfo</span><span style="color:#f92672">;</span>
        aInfo <span style="color:#f92672">=</span> mInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">mAInfo</span><span style="color:#f92672">;</span>
        resolvedType <span style="color:#f92672">=</span> mInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">mResolvedType</span><span style="color:#f92672">;</span>
        inTask <span style="color:#f92672">=</span> mInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">mInTask</span><span style="color:#f92672">;</span>
        callingPid <span style="color:#f92672">=</span> mInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">mCallingPid</span><span style="color:#f92672">;</span>
        callingUid <span style="color:#f92672">=</span> mInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">mCallingUid</span><span style="color:#f92672">;</span>
        options <span style="color:#f92672">=</span> mInterceptor<span style="color:#f92672">.</span><span style="color:#a6e22e">mActivityOptions</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>abort<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resultRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                resultStack<span style="color:#f92672">.</span><span style="color:#a6e22e">sendActivityResultLocked</span><span style="color:#f92672">(-</span>1<span style="color:#f92672">,</span> resultRecord<span style="color:#f92672">,</span> resultWho<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span>
                        RESULT_CANCELED<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// We pretend to the caller that it was really started, but
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// they will just get a cancel result.
</span><span style="color:#75715e"></span>            ActivityOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">abort</span><span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> START_ABORTED<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If permissions need a review before any of the app components can run, we
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// launch the review activity and pass a pending intent to start the activity
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// we are to launching now after the review is completed.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mPermissionReviewRequired</span> <span style="color:#f92672">&amp;&amp;</span> aInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManagerInternalLocked</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isPermissionsReviewRequired</span><span style="color:#f92672">(</span>
                    aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span> userId<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                IIntentSender target <span style="color:#f92672">=</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getIntentSenderLocked</span><span style="color:#f92672">(</span>
                        ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">INTENT_SENDER_ACTIVITY</span><span style="color:#f92672">,</span> callingPackage<span style="color:#f92672">,</span>
                        callingUid<span style="color:#f92672">,</span> userId<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Intent<span style="color:#f92672">[]{</span>intent<span style="color:#f92672">},</span>
                        <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]{</span>resolvedType<span style="color:#f92672">},</span> PendingIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_CANCEL_CURRENT</span>
                                <span style="color:#f92672">|</span> PendingIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_ONE_SHOT</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>

                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getFlags</span><span style="color:#f92672">();</span>
                Intent newIntent <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Intent<span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_REVIEW_PERMISSIONS</span><span style="color:#f92672">);</span>
                newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">setFlags</span><span style="color:#f92672">(</span>flags
                        <span style="color:#f92672">|</span> Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS</span><span style="color:#f92672">);</span>
                newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">putExtra</span><span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">EXTRA_PACKAGE_NAME</span><span style="color:#f92672">,</span> aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">);</span>
                newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">putExtra</span><span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">EXTRA_INTENT</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> IntentSender<span style="color:#f92672">(</span>target<span style="color:#f92672">));</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resultRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    newIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">putExtra</span><span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">EXTRA_RESULT_NEEDED</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                intent <span style="color:#f92672">=</span> newIntent<span style="color:#f92672">;</span>

                resolvedType <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                callingUid <span style="color:#f92672">=</span> realCallingUid<span style="color:#f92672">;</span>
                callingPid <span style="color:#f92672">=</span> realCallingPid<span style="color:#f92672">;</span>

                rInfo <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveIntent</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">,</span> userId<span style="color:#f92672">);</span>
                aInfo <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveActivity</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> rInfo<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">null</span> <span style="color:#75715e">/*profilerInfo*/</span><span style="color:#f92672">);</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PERMISSIONS_REVIEW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;START u&#34;</span> <span style="color:#f92672">+</span> userId <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; {&#34;</span> <span style="color:#f92672">+</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
                            <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;} from uid &#34;</span> <span style="color:#f92672">+</span> callingUid <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; on display &#34;</span>
                            <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mFocusedStack</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>
                            <span style="color:#f92672">?</span> DEFAULT_DISPLAY <span style="color:#f92672">:</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mFocusedStack</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mDisplayId</span><span style="color:#f92672">));</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If we have an ephemeral app, abort the process of launching the resolved intent.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Instead, launch the ephemeral installer. Once the installer is finished, it
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// starts either the intent we resolved here [on install error] or the ephemeral
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// app [on install success].
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> rInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">auxiliaryInfo</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            intent <span style="color:#f92672">=</span> createLaunchIntent<span style="color:#f92672">(</span>rInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">auxiliaryInfo</span><span style="color:#f92672">,</span> ephemeralIntent<span style="color:#f92672">,</span>
                    callingPackage<span style="color:#f92672">,</span> verificationBundle<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">,</span> userId<span style="color:#f92672">);</span>
            resolvedType <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            callingUid <span style="color:#f92672">=</span> realCallingUid<span style="color:#f92672">;</span>
            callingPid <span style="color:#f92672">=</span> realCallingPid<span style="color:#f92672">;</span>

            aInfo <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveActivity</span><span style="color:#f92672">(</span>intent<span style="color:#f92672">,</span> rInfo<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span> <span style="color:#75715e">/*profilerInfo*/</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        ActivityRecord r <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ActivityRecord<span style="color:#f92672">(</span>mService<span style="color:#f92672">,</span> callerApp<span style="color:#f92672">,</span> callingPid<span style="color:#f92672">,</span> callingUid<span style="color:#f92672">,</span>
                callingPackage<span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> resolvedType<span style="color:#f92672">,</span> aInfo<span style="color:#f92672">,</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getGlobalConfiguration</span><span style="color:#f92672">(),</span>
                resultRecord<span style="color:#f92672">,</span> resultWho<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> componentSpecified<span style="color:#f92672">,</span> voiceSession <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                mSupervisor<span style="color:#f92672">,</span> options<span style="color:#f92672">,</span> sourceRecord<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outActivity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            outActivity<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> r<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">appTimeTracker</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> sourceRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If the caller didn&#39;t specify an explicit time tracker, we want to continue
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// tracking under any it has.
</span><span style="color:#75715e"></span>            r<span style="color:#f92672">.</span><span style="color:#a6e22e">appTimeTracker</span> <span style="color:#f92672">=</span> sourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">appTimeTracker</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> ActivityStack stack <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mFocusedStack</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>voiceSession <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>stack<span style="color:#f92672">.</span><span style="color:#a6e22e">mResumedActivity</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>
                <span style="color:#f92672">||</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">mResumedActivity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> callingUid<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">checkAppSwitchAllowedLocked</span><span style="color:#f92672">(</span>callingPid<span style="color:#f92672">,</span> callingUid<span style="color:#f92672">,</span>
                    realCallingPid<span style="color:#f92672">,</span> realCallingUid<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Activity start&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                PendingActivityLaunch pal <span style="color:#f92672">=</span>  <span style="color:#66d9ef">new</span> PendingActivityLaunch<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span>
                        sourceRecord<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span> stack<span style="color:#f92672">,</span> callerApp<span style="color:#f92672">);</span>
                mPendingActivityLaunches<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>pal<span style="color:#f92672">);</span>
                ActivityOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">abort</span><span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">START_SWITCHES_CANCELED</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mDidAppSwitch</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// This is the second allowed switch since we stopped switches,
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// so now just generally allow switches.  Use case: user presses
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// home (switches disabled, switch to home, mDidAppSwitch now true);
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// user taps a home icon (coming from home so allowed, we hit here
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// and now allow anyone to switch again).
</span><span style="color:#75715e"></span>            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mAppSwitchesAllowedTime</span> <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mDidAppSwitch</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        doPendingActivityLaunchesLocked<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> startActivity<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> sourceRecord<span style="color:#f92672">,</span> voiceSession<span style="color:#f92672">,</span> voiceInteractor<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
                options<span style="color:#f92672">,</span> inTask<span style="color:#f92672">,</span> outActivity<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">startActivity</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ActivityRecord r<span style="color:#f92672">,</span> ActivityRecord sourceRecord<span style="color:#f92672">,</span>
            IVoiceInteractionSession voiceSession<span style="color:#f92672">,</span> IVoiceInteractor voiceInteractor<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> startFlags<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> doResume<span style="color:#f92672">,</span> ActivityOptions options<span style="color:#f92672">,</span> TaskRecord inTask<span style="color:#f92672">,</span>
            ActivityRecord<span style="color:#f92672">[]</span> outActivity<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> START_CANCELED<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">deferSurfaceLayout</span><span style="color:#f92672">();</span>
            result <span style="color:#f92672">=</span> startActivityUnchecked<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> sourceRecord<span style="color:#f92672">,</span> voiceSession<span style="color:#f92672">,</span> voiceInteractor<span style="color:#f92672">,</span>
                    startFlags<span style="color:#f92672">,</span> doResume<span style="color:#f92672">,</span> options<span style="color:#f92672">,</span> inTask<span style="color:#f92672">,</span> outActivity<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If we are not able to proceed, disassociate the activity from the task. Leaving an
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// activity in an incomplete state can lead to issues, such as performing operations
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// without a window container.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">isStartResultSuccessful</span><span style="color:#f92672">(</span>result<span style="color:#f92672">)</span>
                    <span style="color:#f92672">&amp;&amp;</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">removeActivity</span><span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">continueSurfaceLayout</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        postStartActivityProcessing<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> result<span style="color:#f92672">,</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">getLastStack</span><span style="color:#f92672">().</span><span style="color:#a6e22e">mStackId</span><span style="color:#f92672">,</span>  mSourceRecord<span style="color:#f92672">,</span>
                mTargetStack<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Note: This method should only be called from {@link startActivity}.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">startActivityUnchecked</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ActivityRecord r<span style="color:#f92672">,</span> ActivityRecord sourceRecord<span style="color:#f92672">,</span>
            IVoiceInteractionSession voiceSession<span style="color:#f92672">,</span> IVoiceInteractor voiceInteractor<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> startFlags<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> doResume<span style="color:#f92672">,</span> ActivityOptions options<span style="color:#f92672">,</span> TaskRecord inTask<span style="color:#f92672">,</span>
            ActivityRecord<span style="color:#f92672">[]</span> outActivity<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        setInitialState<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> options<span style="color:#f92672">,</span> inTask<span style="color:#f92672">,</span> doResume<span style="color:#f92672">,</span> startFlags<span style="color:#f92672">,</span> sourceRecord<span style="color:#f92672">,</span> voiceSession<span style="color:#f92672">,</span>
                voiceInteractor<span style="color:#f92672">);</span>

        computeLaunchingTaskFlags<span style="color:#f92672">();</span>

        computeSourceStack<span style="color:#f92672">();</span>

        mIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">setFlags</span><span style="color:#f92672">(</span>mLaunchFlags<span style="color:#f92672">);</span>

        ActivityRecord reusedActivity <span style="color:#f92672">=</span> getReusableIntentActivity<span style="color:#f92672">();</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> preferredLaunchStackId <span style="color:#f92672">=</span>
                <span style="color:#f92672">(</span>mOptions <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> mOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">getLaunchStackId</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> INVALID_STACK_ID<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> preferredLaunchDisplayId <span style="color:#f92672">=</span>
                <span style="color:#f92672">(</span>mOptions <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> mOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">getLaunchDisplayId</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> DEFAULT_DISPLAY<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>reusedActivity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// When the flags NEW_TASK and CLEAR_TASK are set, then the task gets reused but
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// still needs to be a lock task mode violation since the task gets cleared out and
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the device would otherwise leave the locked task.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">isLockTaskModeViolation</span><span style="color:#f92672">(</span>reusedActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">(),</span>
                    <span style="color:#f92672">(</span>mLaunchFlags <span style="color:#f92672">&amp;</span> <span style="color:#f92672">(</span>FLAG_ACTIVITY_NEW_TASK <span style="color:#f92672">|</span> FLAG_ACTIVITY_CLEAR_TASK<span style="color:#f92672">))</span>
                            <span style="color:#f92672">==</span> <span style="color:#f92672">(</span>FLAG_ACTIVITY_NEW_TASK <span style="color:#f92672">|</span> FLAG_ACTIVITY_CLEAR_TASK<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
                mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">showLockTaskToast</span><span style="color:#f92672">();</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startActivityUnchecked: Attempt to violate Lock Task Mode&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> START_RETURN_LOCK_TASK_MODE_VIOLATION<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">setTask</span><span style="color:#f92672">(</span>reusedActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>reusedActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">intent</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// This task was started because of movement of the activity based on affinity...
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Now that we are actually launching it, we can assign the base intent.
</span><span style="color:#75715e"></span>                reusedActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setIntent</span><span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// This code path leads to delivering a new intent, we want to make sure we schedule it
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// as the first operation, in case the activity will be resumed as a result of later
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// operations.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mLaunchFlags <span style="color:#f92672">&amp;</span> FLAG_ACTIVITY_CLEAR_TOP<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0
                    <span style="color:#f92672">||</span> isDocumentLaunchesIntoExisting<span style="color:#f92672">(</span>mLaunchFlags<span style="color:#f92672">)</span>
                    <span style="color:#f92672">||</span> mLaunchSingleInstance <span style="color:#f92672">||</span> mLaunchSingleTask<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> TaskRecord task <span style="color:#f92672">=</span> reusedActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">();</span>

                <span style="color:#75715e">// In this situation we want to remove all activities from the task up to the one
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// being started. In most cases this means we are resetting the task to its initial
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// state.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">final</span> ActivityRecord top <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span><span style="color:#a6e22e">performClearTaskForReuseLocked</span><span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">,</span>
                        mLaunchFlags<span style="color:#f92672">);</span>

                <span style="color:#75715e">// The above code can remove {@code reusedActivity} from the task, leading to the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the {@code ActivityRecord} removing its reference to the {@code TaskRecord}. The
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// task reference is needed in the call below to
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// {@link setTargetStackAndMoveToFrontIfNeeded}.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>reusedActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    reusedActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">setTask</span><span style="color:#f92672">(</span>task<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>top <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>top<span style="color:#f92672">.</span><span style="color:#a6e22e">frontOfTask</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// Activity aliases may mean we use different intents for the top activity,
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// so make sure the task now has the identity of the new intent.
</span><span style="color:#75715e"></span>                        top<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setIntent</span><span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    deliverNewIntent<span style="color:#f92672">(</span>top<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            sendPowerHintForLaunchStartIfNeeded<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span> <span style="color:#75715e">/* forceSend */</span><span style="color:#f92672">,</span> reusedActivity<span style="color:#f92672">);</span>

            reusedActivity <span style="color:#f92672">=</span> setTargetStackAndMoveToFrontIfNeeded<span style="color:#f92672">(</span>reusedActivity<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">final</span> ActivityRecord outResult <span style="color:#f92672">=</span>
                    outActivity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> outActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">?</span> outActivity<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// When there is a reused activity and the current result is a trampoline activity,
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// set the reused activity as the result.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outResult <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">finishing</span> <span style="color:#f92672">||</span> outResult<span style="color:#f92672">.</span><span style="color:#a6e22e">noDisplay</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                outActivity<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> reusedActivity<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mStartFlags <span style="color:#f92672">&amp;</span> START_FLAG_ONLY_IF_NEEDED<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// We don&#39;t need to start a new activity, and the client said not to do anything
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// if that is the case, so this is it!  And for paranoia, make sure we have
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// correctly resumed the top activity.
</span><span style="color:#75715e"></span>                resumeTargetStackIfNeeded<span style="color:#f92672">();</span>
                <span style="color:#66d9ef">return</span> START_RETURN_INTENT_TO_CALLER<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            setTaskFromIntentActivity<span style="color:#f92672">(</span>reusedActivity<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mAddingToTask <span style="color:#f92672">&amp;&amp;</span> mReuseTask <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// We didn&#39;t do anything...  but it was needed (a.k.a., client don&#39;t use that
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// intent!)  And for paranoia, make sure we have correctly resumed the top activity.
</span><span style="color:#75715e"></span>                resumeTargetStackIfNeeded<span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outActivity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> outActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    outActivity<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> reusedActivity<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">return</span> START_TASK_TO_FRONT<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> ActivityStack sourceStack <span style="color:#f92672">=</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">resultTo</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                    <span style="color:#f92672">?</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">resultTo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getStack</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sourceStack <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                sourceStack<span style="color:#f92672">.</span><span style="color:#a6e22e">sendActivityResultLocked</span><span style="color:#f92672">(-</span>1 <span style="color:#75715e">/* callingUid */</span><span style="color:#f92672">,</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">resultTo</span><span style="color:#f92672">,</span>
                        mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">resultWho</span><span style="color:#f92672">,</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">requestCode</span><span style="color:#f92672">,</span> RESULT_CANCELED<span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* data */</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            ActivityOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">abort</span><span style="color:#f92672">(</span>mOptions<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> START_CLASS_NOT_FOUND<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If the activity being launched is the same as the one currently at the top, then
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// we need to check if it should only be launched once.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> ActivityStack topStack <span style="color:#f92672">=</span> mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mFocusedStack</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> ActivityRecord topFocused <span style="color:#f92672">=</span> topStack<span style="color:#f92672">.</span><span style="color:#a6e22e">topActivity</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> ActivityRecord top <span style="color:#f92672">=</span> topStack<span style="color:#f92672">.</span><span style="color:#a6e22e">topRunningNonDelayedActivityLocked</span><span style="color:#f92672">(</span>mNotTop<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> dontStart <span style="color:#f92672">=</span> top <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">resultTo</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>
                <span style="color:#f92672">&amp;&amp;</span> top<span style="color:#f92672">.</span><span style="color:#a6e22e">realActivity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">realActivity</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">&amp;&amp;</span> top<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span> <span style="color:#f92672">==</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span>
                <span style="color:#f92672">&amp;&amp;</span> top<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> top<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">((</span>mLaunchFlags <span style="color:#f92672">&amp;</span> FLAG_ACTIVITY_SINGLE_TOP<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0
                <span style="color:#f92672">||</span> mLaunchSingleTop <span style="color:#f92672">||</span> mLaunchSingleTask<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dontStart<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// For paranoia, make sure we have correctly resumed the top activity.
</span><span style="color:#75715e"></span>            topStack<span style="color:#f92672">.</span><span style="color:#a6e22e">mLastPausedActivity</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mDoResume<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resumeFocusedStackTopActivityLocked</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            ActivityOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">abort</span><span style="color:#f92672">(</span>mOptions<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mStartFlags <span style="color:#f92672">&amp;</span> START_FLAG_ONLY_IF_NEEDED<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// We don&#39;t need to start a new activity, and the client said not to do
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// anything if that is the case, so this is it!
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> START_RETURN_INTENT_TO_CALLER<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            deliverNewIntent<span style="color:#f92672">(</span>top<span style="color:#f92672">);</span>

            <span style="color:#75715e">// Don&#39;t use mStartActivity.task to show the toast. We&#39;re not starting a new activity
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// but reusing &#39;top&#39;. Fields in mStartActivity may not be fully initialized.
</span><span style="color:#75715e"></span>            mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">handleNonResizableTaskIfNeeded</span><span style="color:#f92672">(</span>top<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">(),</span> preferredLaunchStackId<span style="color:#f92672">,</span>
                    preferredLaunchDisplayId<span style="color:#f92672">,</span> topStack<span style="color:#f92672">.</span><span style="color:#a6e22e">mStackId</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">return</span> START_DELIVERED_TO_TOP<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">boolean</span> newTask <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> TaskRecord taskToAffiliate <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>mLaunchTaskBehind <span style="color:#f92672">&amp;&amp;</span> mSourceRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">?</span> mSourceRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// Should this be considered a new task?
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> START_SUCCESS<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">resultTo</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mInTask <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mAddingToTask
                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>mLaunchFlags <span style="color:#f92672">&amp;</span> FLAG_ACTIVITY_NEW_TASK<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            newTask <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            result <span style="color:#f92672">=</span> setTaskFromReuseOrCreateNewTask<span style="color:#f92672">(</span>
                    taskToAffiliate<span style="color:#f92672">,</span> preferredLaunchStackId<span style="color:#f92672">,</span> topStack<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSourceRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            result <span style="color:#f92672">=</span> setTaskFromSourceRecord<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mInTask <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            result <span style="color:#f92672">=</span> setTaskFromInTask<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// This not being started from an existing activity, and not part of a new task...
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// just put it in the top task, though these days this case should never happen.
</span><span style="color:#75715e"></span>            setTaskToCurrentTopOrCreateNewTask<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">!=</span> START_SUCCESS<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        mService<span style="color:#f92672">.</span><span style="color:#a6e22e">grantUriPermissionFromIntentLocked</span><span style="color:#f92672">(</span>mCallingUid<span style="color:#f92672">,</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span>
                mIntent<span style="color:#f92672">,</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getUriPermissionsLocked</span><span style="color:#f92672">(),</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">);</span>
        mService<span style="color:#f92672">.</span><span style="color:#a6e22e">grantEphemeralAccessLocked</span><span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">,</span> mIntent<span style="color:#f92672">,</span>
                mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">appInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">,</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getAppId</span><span style="color:#f92672">(</span>mCallingUid<span style="color:#f92672">));</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mSourceRecord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setTaskToReturnTo</span><span style="color:#f92672">(</span>mSourceRecord<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>newTask<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            EventLog<span style="color:#f92672">.</span><span style="color:#a6e22e">writeEvent</span><span style="color:#f92672">(</span>
                    EventLogTags<span style="color:#f92672">.</span><span style="color:#a6e22e">AM_CREATE_TASK</span><span style="color:#f92672">,</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">,</span>
                    mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">taskId</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        ActivityStack<span style="color:#f92672">.</span><span style="color:#a6e22e">logStartActivity</span><span style="color:#f92672">(</span>
                EventLogTags<span style="color:#f92672">.</span><span style="color:#a6e22e">AM_CREATE_ACTIVITY</span><span style="color:#f92672">,</span> mStartActivity<span style="color:#f92672">,</span> mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">());</span>
        mTargetStack<span style="color:#f92672">.</span><span style="color:#a6e22e">mLastPausedActivity</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        sendPowerHintForLaunchStartIfNeeded<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span> <span style="color:#75715e">/* forceSend */</span><span style="color:#f92672">,</span> mStartActivity<span style="color:#f92672">);</span>

        mTargetStack<span style="color:#f92672">.</span><span style="color:#a6e22e">startActivityLocked</span><span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">,</span> topFocused<span style="color:#f92672">,</span> newTask<span style="color:#f92672">,</span> mKeepCurTransition<span style="color:#f92672">,</span>
                mOptions<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mDoResume<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> ActivityRecord topTaskActivity <span style="color:#f92672">=</span>
                    mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">topRunningActivityLocked</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mTargetStack<span style="color:#f92672">.</span><span style="color:#a6e22e">isFocusable</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>topTaskActivity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> topTaskActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">mTaskOverlay</span>
                    <span style="color:#f92672">&amp;&amp;</span> mStartActivity <span style="color:#f92672">!=</span> topTaskActivity<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If the activity is not focusable, we can&#39;t resume it, but still would like to
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// make sure it becomes visible as it starts (this will also trigger entry
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// animation). An example of this are PIP activities.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Also, we don&#39;t want to resume activities in a task that currently has an overlay
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// as the starting activity just needs to be in the visible paused state until the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// over is removed.
</span><span style="color:#75715e"></span>                mTargetStack<span style="color:#f92672">.</span><span style="color:#a6e22e">ensureActivitiesVisibleLocked</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#f92672">!</span>PRESERVE_WINDOWS<span style="color:#f92672">);</span>
                <span style="color:#75715e">// Go ahead and tell window manager to execute app transition for this activity
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// since the app transition will not be triggered through the resume channel.
</span><span style="color:#75715e"></span>                mWindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">executeAppTransition</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If the target stack was not previously focusable (previous top running activity
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// on that stack was not visible) then any prior calls to move the stack to the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// will not update the focused stack.  If starting the new activity now allows the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// task stack to be focusable, then ensure that we now update the focused stack
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// accordingly.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mTargetStack<span style="color:#f92672">.</span><span style="color:#a6e22e">isFocusable</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">isFocusedStack</span><span style="color:#f92672">(</span>mTargetStack<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    mTargetStack<span style="color:#f92672">.</span><span style="color:#a6e22e">moveToFront</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;startActivityUnchecked&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resumeFocusedStackTopActivityLocked</span><span style="color:#f92672">(</span>mTargetStack<span style="color:#f92672">,</span> mStartActivity<span style="color:#f92672">,</span>
                        mOptions<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            mTargetStack<span style="color:#f92672">.</span><span style="color:#a6e22e">addRecentActivityLocked</span><span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">updateUserStackLocked</span><span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">,</span> mTargetStack<span style="color:#f92672">);</span>

        mSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">handleNonResizableTaskIfNeeded</span><span style="color:#f92672">(</span>mStartActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">(),</span> preferredLaunchStackId<span style="color:#f92672">,</span>
                preferredLaunchDisplayId<span style="color:#f92672">,</span> mTargetStack<span style="color:#f92672">.</span><span style="color:#a6e22e">mStackId</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> START_SUCCESS<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>ActivityStackSupervisor.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">resumeFocusedStackTopActivityLocked</span><span style="color:#f92672">(</span>
            ActivityStack targetStack<span style="color:#f92672">,</span> ActivityRecord target<span style="color:#f92672">,</span> ActivityOptions targetOptions<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>readyToResume<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>targetStack <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> isFocusedStack<span style="color:#f92672">(</span>targetStack<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> targetStack<span style="color:#f92672">.</span><span style="color:#a6e22e">resumeTopActivityUncheckedLocked</span><span style="color:#f92672">(</span>target<span style="color:#f92672">,</span> targetOptions<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> ActivityRecord r <span style="color:#f92672">=</span> mFocusedStack<span style="color:#f92672">.</span><span style="color:#a6e22e">topRunningActivityLocked</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">!=</span> RESUMED<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mFocusedStack<span style="color:#f92672">.</span><span style="color:#a6e22e">resumeTopActivityUncheckedLocked</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> RESUMED<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Kick off any lingering app transitions form the MoveTaskToFront operation.
</span><span style="color:#75715e"></span>            mFocusedStack<span style="color:#f92672">.</span><span style="color:#a6e22e">executeAppTransition</span><span style="color:#f92672">(</span>targetOptions<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    
</code></pre></div><p>ActivityStack.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Ensure that the top activity in the stack is resumed.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param prev The previously resumed activity, for when in the process
</span><span style="color:#75715e">     * of pausing; can be null to call from elsewhere.
</span><span style="color:#75715e">     * @param options Activity options.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @return Returns true if something is being resumed, or false if
</span><span style="color:#75715e">     * nothing happened.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * NOTE: It is not safe to call this method directly as it can cause an activity in a
</span><span style="color:#75715e">     *       non-focused stack to be resumed.
</span><span style="color:#75715e">     *       Use {@link ActivityStackSupervisor#resumeFocusedStackTopActivityLocked} to resume the
</span><span style="color:#75715e">     *       right activity for the current system state.
</span><span style="color:#75715e">     */</span>
<span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">resumeTopActivityUncheckedLocked</span><span style="color:#f92672">(</span>ActivityRecord prev<span style="color:#f92672">,</span> ActivityOptions options<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">inResumeTopActivity</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Don&#39;t even start recursing.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">boolean</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Protect against recursion.
</span><span style="color:#75715e"></span>            mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">inResumeTopActivity</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            result <span style="color:#f92672">=</span> resumeTopActivityInnerLocked<span style="color:#f92672">(</span>prev<span style="color:#f92672">,</span> options<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">inResumeTopActivity</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// When resuming the top activity, it may be necessary to pause the top activity (for
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// example, returning to the lock screen. We suppress the normal pause logic in
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// {@link #resumeTopActivityUncheckedLocked}, since the top activity is resumed at the end.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// We call the {@link ActivityStackSupervisor#checkReadyForSleepLocked} again here to ensure
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// any necessary pause logic occurs. In the case where the Activity will be shown regardless
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// of the lock screen, the call to {@link ActivityStackSupervisor#checkReadyForSleepLocked}
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// is skipped.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> ActivityRecord next <span style="color:#f92672">=</span> topRunningActivityLocked<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span> <span style="color:#75715e">/* focusableOnly */</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>next <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">canTurnScreenOn</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            checkReadyForSleep<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">resumeTopActivityInnerLocked</span><span style="color:#f92672">(</span>ActivityRecord prev<span style="color:#f92672">,</span> ActivityOptions options<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mBooting</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mBooted</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Not ready yet!
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Find the next top-most activity to resume in this stack that is not finishing and is
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// focusable. If it is not focusable, we will fall into the case below to resume the
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// top activity in the next focusable task.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> ActivityRecord next <span style="color:#f92672">=</span> topRunningActivityLocked<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span> <span style="color:#75715e">/* focusableOnly */</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> hasRunningActivity <span style="color:#f92672">=</span> next <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// TODO: Maybe this entire condition can get removed?
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasRunningActivity <span style="color:#f92672">&amp;&amp;</span> getDisplay<span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">cancelInitializingActivities</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// Remember how we&#39;ll process this pause/resume situation, and ensure
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// that the state is reset however we wind up proceeding.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> userLeaving <span style="color:#f92672">=</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mUserLeaving</span><span style="color:#f92672">;</span>
        mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mUserLeaving</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>hasRunningActivity<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// There are no activities left in the stack, let&#39;s look somewhere else.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> resumeTopActivityInNextFocusableStack<span style="color:#f92672">(</span>prev<span style="color:#f92672">,</span> options<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;noMoreActivities&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        next<span style="color:#f92672">.</span><span style="color:#a6e22e">delayedResume</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// If the top activity is the resumed one, nothing to do.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mResumedActivity <span style="color:#f92672">==</span> next <span style="color:#f92672">&amp;&amp;</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> ActivityState<span style="color:#f92672">.</span><span style="color:#a6e22e">RESUMED</span> <span style="color:#f92672">&amp;&amp;</span>
                    mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">allResumedActivitiesComplete</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Make sure we have executed any pending transitions, since there
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// should be nothing left to do at this point.
</span><span style="color:#75715e"></span>            executeAppTransition<span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;resumeTopActivityLocked: Top activity resumed &#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> TaskRecord nextTask <span style="color:#f92672">=</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> TaskRecord prevTask <span style="color:#f92672">=</span> prev <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> prev<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prevTask <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> prevTask<span style="color:#f92672">.</span><span style="color:#a6e22e">getStack</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">this</span> <span style="color:#f92672">&amp;&amp;</span>
                prevTask<span style="color:#f92672">.</span><span style="color:#a6e22e">isOverHomeStack</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> prev<span style="color:#f92672">.</span><span style="color:#a6e22e">finishing</span> <span style="color:#f92672">&amp;&amp;</span> prev<span style="color:#f92672">.</span><span style="color:#a6e22e">frontOfTask</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span>  mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prevTask <span style="color:#f92672">==</span> nextTask<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                prevTask<span style="color:#f92672">.</span><span style="color:#a6e22e">setFrontOfTask</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prevTask <span style="color:#f92672">!=</span> topTask<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// This task is going away but it was supposed to return to the home stack.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Now the task above it has to return to the home task instead.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> taskNdx <span style="color:#f92672">=</span> mTaskHistory<span style="color:#f92672">.</span><span style="color:#a6e22e">indexOf</span><span style="color:#f92672">(</span>prevTask<span style="color:#f92672">)</span> <span style="color:#f92672">+</span> 1<span style="color:#f92672">;</span>
                mTaskHistory<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>taskNdx<span style="color:#f92672">).</span><span style="color:#a6e22e">setTaskToReturnTo</span><span style="color:#f92672">(</span>HOME_ACTIVITY_TYPE<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isOnHomeDisplay<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isHomeStack<span style="color:#f92672">()){</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;resumeTopActivityLocked: Launching home next&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> isOnHomeDisplay<span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span>
                        mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resumeHomeStackTask</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;prevFinished&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If we are sleeping, and there is no resumed activity, and the top
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// activity is paused, well that is the state we want.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldSleepOrShutDownActivities<span style="color:#f92672">()</span>
                <span style="color:#f92672">&amp;&amp;</span> mLastPausedActivity <span style="color:#f92672">==</span> next
                <span style="color:#f92672">&amp;&amp;</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">allPausedActivitiesComplete</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Make sure we have executed any pending transitions, since there
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// should be nothing left to do at this point.
</span><span style="color:#75715e"></span>            executeAppTransition<span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;resumeTopActivityLocked: Going to sleep and all paused&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Make sure that the user who owns this activity is started.  If not,
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// we will just leave it as is because someone should be bringing
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// another user&#39;s activities to the top of the stack.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mUserController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hasStartedUserState</span><span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Skipping resume of top activity &#34;</span> <span style="color:#f92672">+</span> next
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: user &#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; is stopped&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// The activity may be waiting for stop, but that is no longer
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// appropriate for it.
</span><span style="color:#75715e"></span>        mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mStoppingActivities</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>next<span style="color:#f92672">);</span>
        mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mGoingToSleepActivities</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>next<span style="color:#f92672">);</span>
        next<span style="color:#f92672">.</span><span style="color:#a6e22e">sleeping</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mActivitiesWaitingForVisibleActivity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>next<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_SWITCH<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Resuming &#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">);</span>

        <span style="color:#75715e">// If we are currently pausing an activity, then don&#39;t do anything until that is done.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">allPausedActivitiesComplete</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH <span style="color:#f92672">||</span> DEBUG_PAUSE <span style="color:#f92672">||</span> DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PAUSE<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;resumeTopActivityLocked: Skip resume: some activity pausing.&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">setLaunchSource</span><span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">boolean</span> lastResumedCanPip <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> ActivityStack lastFocusedStack <span style="color:#f92672">=</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">getLastStack</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lastFocusedStack <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> lastFocusedStack <span style="color:#f92672">!=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// So, why aren&#39;t we using prev here??? See the param comment on the method. prev doesn&#39;t
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// represent the last resumed activity. However, the last focus stack does if it isn&#39;t null.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> ActivityRecord lastResumed <span style="color:#f92672">=</span> lastFocusedStack<span style="color:#f92672">.</span><span style="color:#a6e22e">mResumedActivity</span><span style="color:#f92672">;</span>
            lastResumedCanPip <span style="color:#f92672">=</span> lastResumed <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> lastResumed<span style="color:#f92672">.</span><span style="color:#a6e22e">checkEnterPictureInPictureState</span><span style="color:#f92672">(</span>
                    <span style="color:#e6db74">&#34;resumeTopActivity&#34;</span><span style="color:#f92672">,</span> userLeaving <span style="color:#75715e">/* beforeStopping */</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// If the flag RESUME_WHILE_PAUSING is set, then continue to schedule the previous activity
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// to be paused, while at the same time resuming the new resume activity only if the
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// previous activity can&#39;t go into Pip since we want to give Pip activities a chance to
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// enter Pip before resuming the next activity.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> resumeWhilePausing <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> FLAG_RESUME_WHILE_PAUSING<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0
                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>lastResumedCanPip<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">boolean</span> pausing <span style="color:#f92672">=</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">pauseBackStacks</span><span style="color:#f92672">(</span>userLeaving<span style="color:#f92672">,</span> next<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mResumedActivity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;resumeTopActivityLocked: Pausing &#34;</span> <span style="color:#f92672">+</span> mResumedActivity<span style="color:#f92672">);</span>
            pausing <span style="color:#f92672">|=</span> startPausingLocked<span style="color:#f92672">(</span>userLeaving<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> next<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pausing <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>resumeWhilePausing<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH <span style="color:#f92672">||</span> DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;resumeTopActivityLocked: Skip resume: need to start pausing&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">// At this point we want to put the upcoming activity&#39;s process
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// at the top of the LRU list, since we know we will be needing it
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// very soon and it would be a waste to let it get killed if it
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// happens to be sitting towards the end.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateLruProcessLocked</span><span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mResumedActivity <span style="color:#f92672">==</span> next <span style="color:#f92672">&amp;&amp;</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> ActivityState<span style="color:#f92672">.</span><span style="color:#a6e22e">RESUMED</span> <span style="color:#f92672">&amp;&amp;</span>
                mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">allResumedActivitiesComplete</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// It is possible for the activity to be resumed when we paused back stacks above if the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// next activity doesn&#39;t have to wait for pause to complete.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// So, nothing else to-do except:
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// Make sure we have executed any pending transitions, since there
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// should be nothing left to do at this point.
</span><span style="color:#75715e"></span>            executeAppTransition<span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;resumeTopActivityLocked: Top activity resumed (dontWaitForPause) &#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If the most recent activity was noHistory but was only stopped rather
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// than stopped+finished because the device went to sleep, we need to make
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// sure to finish it as we&#39;re making a new activity topmost.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldSleepActivities<span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> mLastNoHistoryActivity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span>
                <span style="color:#f92672">!</span>mLastNoHistoryActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">finishing</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;no-history finish of &#34;</span> <span style="color:#f92672">+</span> mLastNoHistoryActivity <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; on new resume&#34;</span><span style="color:#f92672">);</span>
            requestFinishActivityLocked<span style="color:#f92672">(</span>mLastNoHistoryActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span><span style="color:#f92672">,</span> Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">RESULT_CANCELED</span><span style="color:#f92672">,</span>
                    <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;resume-no-history&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            mLastNoHistoryActivity <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prev <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> prev <span style="color:#f92672">!=</span> next<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mActivitiesWaitingForVisibleActivity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">)</span>
                    <span style="color:#f92672">&amp;&amp;</span> next <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">nowVisible</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mActivitiesWaitingForVisibleActivity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_SWITCH<span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;Resuming top, waiting visible to hide: &#34;</span> <span style="color:#f92672">+</span> prev<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// The next activity is already visible, so hide the previous
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// activity&#39;s windows right now so we can show the new one ASAP.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// We only do this if the previous is finishing, which should mean
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// it is on top of the one being resumed so hiding it quickly
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// is good.  Otherwise, we want to do the normal route of allowing
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the resumed activity to be shown so we can decide if the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// previous should actually be hidden depending on whether the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// new one is found to be full-screen or not.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prev<span style="color:#f92672">.</span><span style="color:#a6e22e">finishing</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    prev<span style="color:#f92672">.</span><span style="color:#a6e22e">setVisibility</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_SWITCH<span style="color:#f92672">,</span>
                            <span style="color:#e6db74">&#34;Not waiting for visible to hide: &#34;</span> <span style="color:#f92672">+</span> prev <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, waitingVisible=&#34;</span>
                            <span style="color:#f92672">+</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mActivitiesWaitingForVisibleActivity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">)</span>
                            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, nowVisible=&#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">nowVisible</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_SWITCH<span style="color:#f92672">,</span>
                            <span style="color:#e6db74">&#34;Previous already visible but still waiting to hide: &#34;</span> <span style="color:#f92672">+</span> prev
                            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, waitingVisible=&#34;</span>
                            <span style="color:#f92672">+</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mActivitiesWaitingForVisibleActivity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">)</span>
                            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, nowVisible=&#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">nowVisible</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Launching this app&#39;s activity, make sure the app is no longer
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// considered stopped.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            AppGlobals<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setPackageStoppedState</span><span style="color:#f92672">(</span>
                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">);</span> <span style="color:#75715e">/* TODO: Verify if correct userid */</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IllegalArgumentException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Failed trying to unstop package &#34;</span>
                    <span style="color:#f92672">+</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// We are starting up the next activity, so tell the window manager
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// that the previous one will be hidden soon.  This way it can know
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// to ignore it when computing the desired screen orientation.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">boolean</span> anim <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prev <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prev<span style="color:#f92672">.</span><span style="color:#a6e22e">finishing</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_TRANSITION<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_TRANSITION<span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;Prepare close transition: prev=&#34;</span> <span style="color:#f92672">+</span> prev<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mNoAnimActivities<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    anim <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    mWindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareAppTransition</span><span style="color:#f92672">(</span>TRANSIT_NONE<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    mWindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareAppTransition</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span>
                            <span style="color:#f92672">?</span> TRANSIT_ACTIVITY_CLOSE
                            <span style="color:#f92672">:</span> TRANSIT_TASK_CLOSE<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                prev<span style="color:#f92672">.</span><span style="color:#a6e22e">setVisibility</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_TRANSITION<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_TRANSITION<span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;Prepare open transition: prev=&#34;</span> <span style="color:#f92672">+</span> prev<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mNoAnimActivities<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>next<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    anim <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    mWindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareAppTransition</span><span style="color:#f92672">(</span>TRANSIT_NONE<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    mWindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareAppTransition</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span>
                            <span style="color:#f92672">?</span> TRANSIT_ACTIVITY_OPEN
                            <span style="color:#f92672">:</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">mLaunchTaskBehind</span>
                                    <span style="color:#f92672">?</span> TRANSIT_TASK_OPEN_BEHIND
                                    <span style="color:#f92672">:</span> TRANSIT_TASK_OPEN<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_TRANSITION<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_TRANSITION<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Prepare open transition: no previous&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mNoAnimActivities<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>next<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                anim <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                mWindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareAppTransition</span><span style="color:#f92672">(</span>TRANSIT_NONE<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                mWindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareAppTransition</span><span style="color:#f92672">(</span>TRANSIT_ACTIVITY_OPEN<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        Bundle resumeAnimOptions <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>anim<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            ActivityOptions opts <span style="color:#f92672">=</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">getOptionsForTargetActivityLocked</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>opts <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                resumeAnimOptions <span style="color:#f92672">=</span> opts<span style="color:#f92672">.</span><span style="color:#a6e22e">toBundle</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            next<span style="color:#f92672">.</span><span style="color:#a6e22e">applyOptionsLocked</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            next<span style="color:#f92672">.</span><span style="color:#a6e22e">clearOptionsLocked</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        ActivityStack lastStack <span style="color:#f92672">=</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">getLastStack</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_SWITCH<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Resume running: &#34;</span> <span style="color:#f92672">+</span> next
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; stopped=&#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">stopped</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; visible=&#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">visible</span><span style="color:#f92672">);</span>

            <span style="color:#75715e">// If the previous activity is translucent, force a visibility update of
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the next activity, so that it&#39;s added to WM&#39;s opening app list, and
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// transition animation can be set up properly.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// For example, pressing Home button with a translucent activity in focus.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// Launcher is already visible in this case. If we don&#39;t add it to opening
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// apps, maybeUpdateTransitToWallpaper() will fail to identify this as a
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// TRANSIT_WALLPAPER_OPEN animation, and run some funny animation.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> lastActivityTranslucent <span style="color:#f92672">=</span> lastStack <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                    <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(!</span>lastStack<span style="color:#f92672">.</span><span style="color:#a6e22e">mFullscreen</span>
                    <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>lastStack<span style="color:#f92672">.</span><span style="color:#a6e22e">mLastPausedActivity</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                    <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>lastStack<span style="color:#f92672">.</span><span style="color:#a6e22e">mLastPausedActivity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fullscreen</span><span style="color:#f92672">));</span>

            <span style="color:#75715e">// The contained logic must be synchronized, since we are both changing the visibility
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// and updating the {@link Configuration}. {@link ActivityRecord#setVisibility} will
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// ultimately cause the client code to schedule a layout. Since layouts retrieve the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// current {@link Configuration}, we must ensure that the below code updates it before
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the layout can occur.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">synchronized</span><span style="color:#f92672">(</span>mWindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindowManagerLock</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// This activity is now becoming visible.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">visible</span> <span style="color:#f92672">||</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">stopped</span> <span style="color:#f92672">||</span> lastActivityTranslucent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">setVisibility</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#75715e">// schedule launch ticks to collect information about slow apps.
</span><span style="color:#75715e"></span>                next<span style="color:#f92672">.</span><span style="color:#a6e22e">startLaunchTickingLocked</span><span style="color:#f92672">();</span>

                ActivityRecord lastResumedActivity <span style="color:#f92672">=</span>
                        lastStack <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">:</span>lastStack<span style="color:#f92672">.</span><span style="color:#a6e22e">mResumedActivity</span><span style="color:#f92672">;</span>
                ActivityState lastState <span style="color:#f92672">=</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">;</span>

                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateCpuStats</span><span style="color:#f92672">();</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Moving to RESUMED: &#34;</span> <span style="color:#f92672">+</span> next
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; (in existing)&#34;</span><span style="color:#f92672">);</span>

                setResumedActivityLocked<span style="color:#f92672">(</span>next<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;resumeTopActivityInnerLocked&#34;</span><span style="color:#f92672">);</span>

                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateLruProcessLocked</span><span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                updateLRUListLocked<span style="color:#f92672">(</span>next<span style="color:#f92672">);</span>
                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateOomAdjLocked</span><span style="color:#f92672">();</span>

                <span style="color:#75715e">// Have the window manager re-evaluate the orientation of
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the screen based on the new activity order.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">boolean</span> notUpdated <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">isFocusedStack</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>

                    <span style="color:#75715e">// We have special rotation behavior when Keyguard is locked. Make sure all
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// activity visibilities are set correctly as well as the transition is updated
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// if needed to get the correct rotation behavior.
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// TODO: Remove this once visibilities are set correctly immediately when
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// starting an activity.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mKeyguardController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isKeyguardLocked</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">ensureActivitiesVisibleLocked</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#75715e">/* starting */</span><span style="color:#f92672">,</span>
                                0 <span style="color:#75715e">/* configChanges */</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* preserveWindows */</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">final</span> Configuration config <span style="color:#f92672">=</span> mWindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">updateOrientationFromAppTokens</span><span style="color:#f92672">(</span>
                            mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayOverrideConfiguration</span><span style="color:#f92672">(</span>mDisplayId<span style="color:#f92672">),</span>
                            next<span style="color:#f92672">.</span><span style="color:#a6e22e">mayFreezeScreenLocked</span><span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                                    mDisplayId<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>config <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        next<span style="color:#f92672">.</span><span style="color:#a6e22e">frozenBeforeDestroy</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    notUpdated <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateDisplayOverrideConfigurationLocked</span><span style="color:#f92672">(</span>config<span style="color:#f92672">,</span> next<span style="color:#f92672">,</span>
                            <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* deferResume */</span><span style="color:#f92672">,</span> mDisplayId<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>notUpdated<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// The configuration update wasn&#39;t able to keep the existing
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// instance of the activity, and instead started a new one.
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// We should be all done, but let&#39;s just make sure our activity
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// is still at the top and schedule another run if something
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// weird happened.
</span><span style="color:#75715e"></span>                    ActivityRecord nextNext <span style="color:#f92672">=</span> topRunningActivityLocked<span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH <span style="color:#f92672">||</span> DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span>
                            <span style="color:#e6db74">&#34;Activity config changed during resume: &#34;</span> <span style="color:#f92672">+</span> next
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, new next: &#34;</span> <span style="color:#f92672">+</span> nextNext<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nextNext <span style="color:#f92672">!=</span> next<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// Do over!
</span><span style="color:#75715e"></span>                        mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleResumeTopActivities</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">visible</span> <span style="color:#f92672">||</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">stopped</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        next<span style="color:#f92672">.</span><span style="color:#a6e22e">setVisibility</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">completeResumeLocked</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Deliver all pending results.
</span><span style="color:#75715e"></span>                    ArrayList<span style="color:#f92672">&lt;</span>ResultInfo<span style="color:#f92672">&gt;</span> a <span style="color:#f92672">=</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">results</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>a <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> N <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">finishing</span> <span style="color:#f92672">&amp;&amp;</span> N <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_RESULTS<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_RESULTS<span style="color:#f92672">,</span>
                                    <span style="color:#e6db74">&#34;Delivering results to &#34;</span> <span style="color:#f92672">+</span> next <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> a<span style="color:#f92672">);</span>
                            next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleSendResult</span><span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span><span style="color:#f92672">,</span> a<span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>

                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">newIntents</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleNewIntent</span><span style="color:#f92672">(</span>
                                next<span style="color:#f92672">.</span><span style="color:#a6e22e">newIntents</span><span style="color:#f92672">,</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* andPause */</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>

                    <span style="color:#75715e">// Well the app will no longer be stopped.
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// Clear app token stopped state in window manager if needed.
</span><span style="color:#75715e"></span>                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">notifyAppResumed</span><span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">stopped</span><span style="color:#f92672">);</span>

                    EventLog<span style="color:#f92672">.</span><span style="color:#a6e22e">writeEvent</span><span style="color:#f92672">(</span>EventLogTags<span style="color:#f92672">.</span><span style="color:#a6e22e">AM_RESUME_ACTIVITY</span><span style="color:#f92672">,</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">,</span>
                            System<span style="color:#f92672">.</span><span style="color:#a6e22e">identityHashCode</span><span style="color:#f92672">(</span>next<span style="color:#f92672">),</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">taskId</span><span style="color:#f92672">,</span>
                            next<span style="color:#f92672">.</span><span style="color:#a6e22e">shortComponentName</span><span style="color:#f92672">);</span>

                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">sleeping</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    mService<span style="color:#f92672">.</span><span style="color:#a6e22e">showUnsupportedZoomDialogIfNeededLocked</span><span style="color:#f92672">(</span>next<span style="color:#f92672">);</span>
                    mService<span style="color:#f92672">.</span><span style="color:#a6e22e">showAskCompatModeDialogLocked</span><span style="color:#f92672">(</span>next<span style="color:#f92672">);</span>
                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pendingUiClean</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">forceProcessStateUpTo</span><span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mTopProcessState</span><span style="color:#f92672">);</span>
                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">clearOptionsLocked</span><span style="color:#f92672">();</span>
                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleResumeActivity</span><span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span><span style="color:#f92672">,</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">repProcState</span><span style="color:#f92672">,</span>
                            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">isNextTransitionForward</span><span style="color:#f92672">(),</span> resumeAnimOptions<span style="color:#f92672">);</span>

                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;resumeTopActivityLocked: Resumed &#34;</span>
                            <span style="color:#f92672">+</span> next<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Whoops, need to restart this activity!
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Resume failed; resetting state to &#34;</span>
                            <span style="color:#f92672">+</span> lastState <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">);</span>
                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> lastState<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lastStack <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        lastStack<span style="color:#f92672">.</span><span style="color:#a6e22e">mResumedActivity</span> <span style="color:#f92672">=</span> lastResumedActivity<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Restarting because process died: &#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">hasBeenLaunched</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        next<span style="color:#f92672">.</span><span style="color:#a6e22e">hasBeenLaunched</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>SHOW_APP_STARTING_PREVIEW <span style="color:#f92672">&amp;&amp;</span> lastStack <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span>
                            mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">isFrontStackOnDisplay</span><span style="color:#f92672">(</span>lastStack<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        next<span style="color:#f92672">.</span><span style="color:#a6e22e">showStartingWindow</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#75715e">/* prev */</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* newTask */</span><span style="color:#f92672">,</span>
                                <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* taskSwitch */</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">startSpecificActivityLocked</span><span style="color:#f92672">(</span>next<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// From this point on, if something goes wrong there is no way
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// to recover the activity.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                next<span style="color:#f92672">.</span><span style="color:#a6e22e">completeResumeLocked</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If any exception gets thrown, toss away this
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// activity and try the next one.
</span><span style="color:#75715e"></span>                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Exception thrown during resume of &#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                requestFinishActivityLocked<span style="color:#f92672">(</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span><span style="color:#f92672">,</span> Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">RESULT_CANCELED</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;resume-exception&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Whoops, need to restart this activity!
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>next<span style="color:#f92672">.</span><span style="color:#a6e22e">hasBeenLaunched</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                next<span style="color:#f92672">.</span><span style="color:#a6e22e">hasBeenLaunched</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>SHOW_APP_STARTING_PREVIEW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    next<span style="color:#f92672">.</span><span style="color:#a6e22e">showStartingWindow</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#75715e">/* prev */</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* newTask */</span><span style="color:#f92672">,</span>
                            <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* taskSwich */</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_SWITCH<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Restarting: &#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;resumeTopActivityLocked: Restarting &#34;</span> <span style="color:#f92672">+</span> next<span style="color:#f92672">);</span>
            mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">startSpecificActivityLocked</span><span style="color:#f92672">(</span>next<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STACK<span style="color:#f92672">)</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">validateTopActivitiesLocked</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Start pausing the currently resumed activity.  It is an error to call this if there
</span><span style="color:#75715e">     * is already an activity being paused or there is no resumed activity.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param userLeaving True if this should result in an onUserLeaving to the current activity.
</span><span style="color:#75715e">     * @param uiSleeping True if this is happening with the user interface going to sleep (the
</span><span style="color:#75715e">     * screen turning off).
</span><span style="color:#75715e">     * @param resuming The activity we are currently trying to resume or null if this is not being
</span><span style="color:#75715e">     *                 called as part of resuming the top activity, so we shouldn&#39;t try to instigate
</span><span style="color:#75715e">     *                 a resume here if not null.
</span><span style="color:#75715e">     * @param pauseImmediately True if the caller does not want to wait for the activity callback to
</span><span style="color:#75715e">     *                         complete pausing.
</span><span style="color:#75715e">     * @return Returns true if an activity now is in the PAUSING state, and we are waiting for
</span><span style="color:#75715e">     * it to tell us when it is done.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">startPausingLocked</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> userLeaving<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> uiSleeping<span style="color:#f92672">,</span>
            ActivityRecord resuming<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> pauseImmediately<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mPausingActivity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">wtf</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Going to pause when pause is already pending for &#34;</span> <span style="color:#f92672">+</span> mPausingActivity
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; state=&#34;</span> <span style="color:#f92672">+</span> mPausingActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>shouldSleepActivities<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Avoid recursion among check for sleep and complete pause during sleeping.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Because activity will be paused immediately after resume, just let pause
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// be completed by the order of activity paused from clients.
</span><span style="color:#75715e"></span>                completePauseLocked<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> resuming<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        ActivityRecord prev <span style="color:#f92672">=</span> mResumedActivity<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prev <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resuming <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">wtf</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Trying to pause when nothing is resumed&#34;</span><span style="color:#f92672">);</span>
                mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resumeFocusedStackTopActivityLocked</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Moving to PAUSING: &#34;</span> <span style="color:#f92672">+</span> prev<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PAUSE<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PAUSE<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Start pausing: &#34;</span> <span style="color:#f92672">+</span> prev<span style="color:#f92672">);</span>
        mResumedActivity <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        mPausingActivity <span style="color:#f92672">=</span> prev<span style="color:#f92672">;</span>
        mLastPausedActivity <span style="color:#f92672">=</span> prev<span style="color:#f92672">;</span>
        mLastNoHistoryActivity <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>prev<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getFlags</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;</span> Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_ACTIVITY_NO_HISTORY</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0
                <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>prev<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> ActivityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_NO_HISTORY</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0 <span style="color:#f92672">?</span> prev <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        prev<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> ActivityState<span style="color:#f92672">.</span><span style="color:#a6e22e">PAUSING</span><span style="color:#f92672">;</span>
        prev<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">touchActiveTime</span><span style="color:#f92672">();</span>
        clearLaunchTime<span style="color:#f92672">(</span>prev<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">final</span> ActivityRecord next <span style="color:#f92672">=</span> mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">topRunningActivityLocked</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mHasRecents</span>
                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>next <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">noDisplay</span> <span style="color:#f92672">||</span> next<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> prev<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">||</span> uiSleeping<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            prev<span style="color:#f92672">.</span><span style="color:#a6e22e">mUpdateTaskThumbnailWhenHidden</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        stopFullyDrawnTraceIfNeeded<span style="color:#f92672">();</span>

        mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateCpuStats</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prev<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> prev<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PAUSE<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PAUSE<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Enqueueing pending pause: &#34;</span> <span style="color:#f92672">+</span> prev<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                EventLog<span style="color:#f92672">.</span><span style="color:#a6e22e">writeEvent</span><span style="color:#f92672">(</span>EventLogTags<span style="color:#f92672">.</span><span style="color:#a6e22e">AM_PAUSE_ACTIVITY</span><span style="color:#f92672">,</span>
                        prev<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">,</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">identityHashCode</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">),</span>
                        prev<span style="color:#f92672">.</span><span style="color:#a6e22e">shortComponentName</span><span style="color:#f92672">);</span>
                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateUsageStats</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                prev<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">.</span><span style="color:#a6e22e">schedulePauseActivity</span><span style="color:#f92672">(</span>prev<span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span><span style="color:#f92672">,</span> prev<span style="color:#f92672">.</span><span style="color:#a6e22e">finishing</span><span style="color:#f92672">,</span>
                        userLeaving<span style="color:#f92672">,</span> prev<span style="color:#f92672">.</span><span style="color:#a6e22e">configChangeFlags</span><span style="color:#f92672">,</span> pauseImmediately<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Ignore exception, if process died other code will cleanup.
</span><span style="color:#75715e"></span>                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Exception thrown during pause&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                mPausingActivity <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                mLastPausedActivity <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                mLastNoHistoryActivity <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            mPausingActivity <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            mLastPausedActivity <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            mLastNoHistoryActivity <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If we are not going to sleep, we want to ensure the device is
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// awake until the next activity is started.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>uiSleeping <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">isSleepingOrShuttingDownLocked</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">acquireLaunchWakelock</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mPausingActivity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Have the window manager pause its key dispatching until the new
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// activity has started.  If we&#39;re pausing the activity just because
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the screen is being turned off and the UI is sleeping, don&#39;t interrupt
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// key dispatch; the same activity will pick it up again on wakeup.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>uiSleeping<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                prev<span style="color:#f92672">.</span><span style="color:#a6e22e">pauseKeyDispatchingLocked</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PAUSE<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                 Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PAUSE<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Key dispatch not paused for screen off&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pauseImmediately<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If the caller said they don&#39;t want to wait for the pause, then complete
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the pause now.
</span><span style="color:#75715e"></span>                completePauseLocked<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> resuming<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                schedulePauseTimeout<span style="color:#f92672">(</span>prev<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// This activity failed to schedule the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// pause, so just treat it as being paused now.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PAUSE<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PAUSE<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Activity not running, resuming next.&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resuming <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">resumeFocusedStackTopActivityLocked</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
</code></pre></div><p>如果要启动的activity的进程还不存在，那么会执行到<code>mStackSupervisor.startSpecificActivityLocked(next, true, true);</code>。
ActivityStackSupervisor.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startSpecificActivityLocked</span><span style="color:#f92672">(</span>ActivityRecord r<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> andResume<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> checkConfig<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Is this activity&#39;s application already running?
</span><span style="color:#75715e"></span>        ProcessRecord app <span style="color:#f92672">=</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessRecordLocked</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>

        r<span style="color:#f92672">.</span><span style="color:#a6e22e">getStack</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setLaunchTime</span><span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span><span style="color:#f92672">&amp;</span>ActivityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_MULTIPROCESS</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0
                        <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#e6db74">&#34;android&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Don&#39;t add this if it is a platform component that is marked
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// to run in multiple processes, because this is actually
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// part of the framework so doesn&#39;t make sense to track as a
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// separate apk in the process.
</span><span style="color:#75715e"></span>                    app<span style="color:#f92672">.</span><span style="color:#a6e22e">addPackage</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">versionCode</span><span style="color:#f92672">,</span>
                            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mProcessStats</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                realStartActivityLocked<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> app<span style="color:#f92672">,</span> andResume<span style="color:#f92672">,</span> checkConfig<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Exception when starting activity &#34;</span>
                        <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">flattenToShortString</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// If a dead object exception was thrown -- fall through to
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// restart the application.
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>

        mService<span style="color:#f92672">.</span><span style="color:#a6e22e">startProcessLocked</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span>
                <span style="color:#e6db74">&#34;activity&#34;</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>接着调用AMS的启动进程方法<code>startProcessLocked()</code>：
ActivityManagerService.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">final</span> ProcessRecord <span style="color:#a6e22e">startProcessLocked</span><span style="color:#f92672">(</span>String processName<span style="color:#f92672">,</span>
            ApplicationInfo info<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> knownToBeDead<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> intentFlags<span style="color:#f92672">,</span>
            String hostingType<span style="color:#f92672">,</span> ComponentName hostingName<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> allowWhileBooting<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> isolated<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> keepIfLarge<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> startProcessLocked<span style="color:#f92672">(</span>processName<span style="color:#f92672">,</span> info<span style="color:#f92672">,</span> knownToBeDead<span style="color:#f92672">,</span> intentFlags<span style="color:#f92672">,</span> hostingType<span style="color:#f92672">,</span>
                hostingName<span style="color:#f92672">,</span> allowWhileBooting<span style="color:#f92672">,</span> isolated<span style="color:#f92672">,</span> 0 <span style="color:#75715e">/* isolatedUid */</span><span style="color:#f92672">,</span> keepIfLarge<span style="color:#f92672">,</span>
                <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* ABI override */</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* entryPoint */</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* entryPointArgs */</span><span style="color:#f92672">,</span>
                <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* crashHandler */</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">final</span> ProcessRecord <span style="color:#a6e22e">startProcessLocked</span><span style="color:#f92672">(</span>String processName<span style="color:#f92672">,</span> ApplicationInfo info<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> knownToBeDead<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> intentFlags<span style="color:#f92672">,</span> String hostingType<span style="color:#f92672">,</span> ComponentName hostingName<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> allowWhileBooting<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> isolated<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> isolatedUid<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> keepIfLarge<span style="color:#f92672">,</span>
            String abiOverride<span style="color:#f92672">,</span> String entryPoint<span style="color:#f92672">,</span> String<span style="color:#f92672">[]</span> entryPointArgs<span style="color:#f92672">,</span> Runnable crashHandler<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> startTime <span style="color:#f92672">=</span> SystemClock<span style="color:#f92672">.</span><span style="color:#a6e22e">elapsedRealtime</span><span style="color:#f92672">();</span>
        ProcessRecord app<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isolated<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            app <span style="color:#f92672">=</span> getProcessRecordLocked<span style="color:#f92672">(</span>processName<span style="color:#f92672">,</span> info<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">,</span> keepIfLarge<span style="color:#f92672">);</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: after getProcessRecord&#34;</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>intentFlags <span style="color:#f92672">&amp;</span> Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_FROM_BACKGROUND</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If we are in the background, then check to see if this process
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// is bad.  If so, we will just silently fail.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAppErrors<span style="color:#f92672">.</span><span style="color:#a6e22e">isBadProcessLocked</span><span style="color:#f92672">(</span>info<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PROCESSES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Bad process: &#34;</span> <span style="color:#f92672">+</span> info<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span>
                            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> info<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// When the user is explicitly starting a process, then clear its
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// crash count so that we won&#39;t make it bad until they see at
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// least one crash dialog again, and make the process good again
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// if it had been bad.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PROCESSES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Clearing bad process: &#34;</span> <span style="color:#f92672">+</span> info<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> info<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">);</span>
                mAppErrors<span style="color:#f92672">.</span><span style="color:#a6e22e">resetProcessCrashTimeLocked</span><span style="color:#f92672">(</span>info<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAppErrors<span style="color:#f92672">.</span><span style="color:#a6e22e">isBadProcessLocked</span><span style="color:#f92672">(</span>info<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    EventLog<span style="color:#f92672">.</span><span style="color:#a6e22e">writeEvent</span><span style="color:#f92672">(</span>EventLogTags<span style="color:#f92672">.</span><span style="color:#a6e22e">AM_PROC_GOOD</span><span style="color:#f92672">,</span>
                            UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserId</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">),</span> info<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">,</span>
                            info<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">);</span>
                    mAppErrors<span style="color:#f92672">.</span><span style="color:#a6e22e">clearBadProcessLocked</span><span style="color:#f92672">(</span>info<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">bad</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If this is an isolated process, it can&#39;t re-use an existing process.
</span><span style="color:#75715e"></span>            app <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// We don&#39;t have to do anything more if:
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// (1) There is an existing application record; and
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// (2) The caller doesn&#39;t think it is dead, OR there is no thread
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//     object attached to it so we know it couldn&#39;t have crashed; and
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// (3) There is a pid assigned to it, so it is either starting or
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//     already running.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PROCESSES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PROCESSES<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: name=&#34;</span> <span style="color:#f92672">+</span> processName
                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; app=&#34;</span> <span style="color:#f92672">+</span> app <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; knownToBeDead=&#34;</span> <span style="color:#f92672">+</span> knownToBeDead
                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; thread=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>app <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; pid=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>app <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">));</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((!</span>knownToBeDead <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">killed</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// We already have the app running, or are waiting for it to
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// come up (we have a pid but not yet its thread), so keep it.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PROCESSES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PROCESSES<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;App already running: &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">);</span>
                <span style="color:#75715e">// If this is a new package in the process, add the package to the list
</span><span style="color:#75715e"></span>                app<span style="color:#f92672">.</span><span style="color:#a6e22e">addPackage</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span> info<span style="color:#f92672">.</span><span style="color:#a6e22e">versionCode</span><span style="color:#f92672">,</span> mProcessStats<span style="color:#f92672">);</span>
                checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: done, added package to proc&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> app<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// An application record is attached to a previous process,
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// clean it up now.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PROCESSES <span style="color:#f92672">||</span> DEBUG_CLEANUP<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PROCESSES<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;App died: &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">);</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: bad proc running, killing&#34;</span><span style="color:#f92672">);</span>
            killProcessGroup<span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">);</span>
            handleAppDiedLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: done killing old proc&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        String hostingNameStr <span style="color:#f92672">=</span> hostingName <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                <span style="color:#f92672">?</span> hostingName<span style="color:#f92672">.</span><span style="color:#a6e22e">flattenToShortString</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: creating new process record&#34;</span><span style="color:#f92672">);</span>
            app <span style="color:#f92672">=</span> newProcessRecordLocked<span style="color:#f92672">(</span>info<span style="color:#f92672">,</span> processName<span style="color:#f92672">,</span> isolated<span style="color:#f92672">,</span> isolatedUid<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Failed making new process record for &#34;</span>
                        <span style="color:#f92672">+</span> processName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> info<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; isolated=&#34;</span> <span style="color:#f92672">+</span> isolated<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">crashHandler</span> <span style="color:#f92672">=</span> crashHandler<span style="color:#f92672">;</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: done creating new process record&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If this is a new package in the process, add the package to the list
</span><span style="color:#75715e"></span>            app<span style="color:#f92672">.</span><span style="color:#a6e22e">addPackage</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span> info<span style="color:#f92672">.</span><span style="color:#a6e22e">versionCode</span><span style="color:#f92672">,</span> mProcessStats<span style="color:#f92672">);</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: added package to existing proc&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If the system is not ready yet, then hold off on starting this
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// process until it is.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mProcessesReady
                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>isAllowedWhileBooting<span style="color:#f92672">(</span>info<span style="color:#f92672">)</span>
                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>allowWhileBooting<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mProcessesOnHold<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>app<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                mProcessesOnHold<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PROCESSES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PROCESSES<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;System not ready, putting on hold: &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">);</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: returning with proc on hold&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> app<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: stepping in to startProcess&#34;</span><span style="color:#f92672">);</span>
        startProcessLocked<span style="color:#f92672">(</span>
                app<span style="color:#f92672">,</span> hostingType<span style="color:#f92672">,</span> hostingNameStr<span style="color:#f92672">,</span> abiOverride<span style="color:#f92672">,</span> entryPoint<span style="color:#f92672">,</span> entryPointArgs<span style="color:#f92672">);</span>
        checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: done starting proc!&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> app <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isAllowedWhileBooting</span><span style="color:#f92672">(</span>ApplicationInfo ai<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>ai<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span><span style="color:#f92672">&amp;</span>ApplicationInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_PERSISTENT</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startProcessLocked</span><span style="color:#f92672">(</span>ProcessRecord app<span style="color:#f92672">,</span>
            String hostingType<span style="color:#f92672">,</span> String hostingNameStr<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        startProcessLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> hostingType<span style="color:#f92672">,</span> hostingNameStr<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* abiOverride */</span><span style="color:#f92672">,</span>
                <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* entryPoint */</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* entryPointArgs */</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startProcessLocked</span><span style="color:#f92672">(</span>ProcessRecord app<span style="color:#f92672">,</span> String hostingType<span style="color:#f92672">,</span>
            String hostingNameStr<span style="color:#f92672">,</span> String abiOverride<span style="color:#f92672">,</span> String entryPoint<span style="color:#f92672">,</span> String<span style="color:#f92672">[]</span> entryPointArgs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        startProcessLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> hostingType<span style="color:#f92672">,</span> hostingNameStr<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* disableHiddenApiChecks */</span><span style="color:#f92672">,</span>
                <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* abiOverride */</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* entryPoint */</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* entryPointArgs */</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startProcessLocked</span><span style="color:#f92672">(</span>ProcessRecord app<span style="color:#f92672">,</span> String hostingType<span style="color:#f92672">,</span>
            String hostingNameStr<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> disableHiddenApiChecks<span style="color:#f92672">,</span> String abiOverride<span style="color:#f92672">,</span>
            String entryPoint<span style="color:#f92672">,</span> String<span style="color:#f92672">[]</span> entryPointArgs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> startTime <span style="color:#f92672">=</span> SystemClock<span style="color:#f92672">.</span><span style="color:#a6e22e">elapsedRealtime</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span> <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">&amp;&amp;</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span> <span style="color:#f92672">!=</span> MY_PID<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: removing from pids map&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mPidsSelfLocked<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mPidsSelfLocked<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">);</span>
                mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">removeMessages</span><span style="color:#f92672">(</span>PROC_START_TIMEOUT_MSG<span style="color:#f92672">,</span> app<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: done removing from pids map&#34;</span><span style="color:#f92672">);</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">setPid</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PROCESSES <span style="color:#f92672">&amp;&amp;</span> mProcessesOnHold<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>app<span style="color:#f92672">))</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PROCESSES<span style="color:#f92672">,</span>
                <span style="color:#e6db74">&#34;startProcessLocked removing on hold: &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">);</span>
        mProcessesOnHold<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>

        checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: starting to update cpu stats&#34;</span><span style="color:#f92672">);</span>
        updateCpuStats<span style="color:#f92672">();</span>
        checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: done updating cpu stats&#34;</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> userId <span style="color:#f92672">=</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserId</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">);</span>
                AppGlobals<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">checkPackageStartable</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span> userId<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowAsRuntimeException</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">int</span> uid <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> gids <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span> mountExternal <span style="color:#f92672">=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">MOUNT_EXTERNAL_NONE</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">isolated</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> permGids <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: getting gids from package manager&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">final</span> IPackageManager pm <span style="color:#f92672">=</span> AppGlobals<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManager</span><span style="color:#f92672">();</span>
                    permGids <span style="color:#f92672">=</span> pm<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageGids</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span>
                            MATCH_DEBUG_TRIAGED_MISSING<span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">);</span>
                    StorageManagerInternal storageManagerInternal <span style="color:#f92672">=</span> LocalServices<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span>
                            StorageManagerInternal<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
                    mountExternal <span style="color:#f92672">=</span> storageManagerInternal<span style="color:#f92672">.</span><span style="color:#a6e22e">getExternalStorageMountMode</span><span style="color:#f92672">(</span>uid<span style="color:#f92672">,</span>
                            app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowAsRuntimeException</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>

                <span style="color:#75715e">/*
</span><span style="color:#75715e">                 * Add shared application and profile GIDs so applications can share some
</span><span style="color:#75715e">                 * resources like shared libraries and access user-wide resources
</span><span style="color:#75715e">                 */</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ArrayUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>permGids<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    gids <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[</span>3<span style="color:#f92672">];</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    gids <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[</span>permGids<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">+</span> 3<span style="color:#f92672">];</span>
                    System<span style="color:#f92672">.</span><span style="color:#a6e22e">arraycopy</span><span style="color:#f92672">(</span>permGids<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> gids<span style="color:#f92672">,</span> 3<span style="color:#f92672">,</span> permGids<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                gids<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getSharedAppGid</span><span style="color:#f92672">(</span>UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getAppId</span><span style="color:#f92672">(</span>uid<span style="color:#f92672">));</span>
                gids<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getCacheAppGid</span><span style="color:#f92672">(</span>UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getAppId</span><span style="color:#f92672">(</span>uid<span style="color:#f92672">));</span>
                gids<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserGid</span><span style="color:#f92672">(</span>UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserId</span><span style="color:#f92672">(</span>uid<span style="color:#f92672">));</span>

                <span style="color:#75715e">// Replace any invalid GIDs
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>gids<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">ERR_GID</span><span style="color:#f92672">)</span> gids<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> gids<span style="color:#f92672">[</span>2<span style="color:#f92672">];</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>gids<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">ERR_GID</span><span style="color:#f92672">)</span> gids<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> gids<span style="color:#f92672">[</span>2<span style="color:#f92672">];</span>
            <span style="color:#f92672">}</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: building args&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFactoryTest <span style="color:#f92672">!=</span> FactoryTest<span style="color:#f92672">.</span><span style="color:#a6e22e">FACTORY_TEST_OFF</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFactoryTest <span style="color:#f92672">==</span> FactoryTest<span style="color:#f92672">.</span><span style="color:#a6e22e">FACTORY_TEST_LOW_LEVEL</span>
                        <span style="color:#f92672">&amp;&amp;</span> mTopComponent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                        <span style="color:#f92672">&amp;&amp;</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>mTopComponent<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageName</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
                    uid <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFactoryTest <span style="color:#f92672">==</span> FactoryTest<span style="color:#f92672">.</span><span style="color:#a6e22e">FACTORY_TEST_HIGH_LEVEL</span>
                        <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span><span style="color:#f92672">&amp;</span>ApplicationInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_FACTORY_TEST</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    uid <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">int</span> runtimeFlags <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> ApplicationInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_DEBUGGABLE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_ENABLE_JDWP</span><span style="color:#f92672">;</span>
                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_JAVA_DEBUGGABLE</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// Also turn on CheckJNI for debuggable apps. It&#39;s quite
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// awkward to turn on otherwise.
</span><span style="color:#75715e"></span>                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_ENABLE_CHECKJNI</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// Run the app in safe mode if its manifest requests so or the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// system is booted in safe mode.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> ApplicationInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_VM_SAFE_MODE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0 <span style="color:#f92672">||</span>
                mSafeMode <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_ENABLE_SAFEMODE</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>SystemProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;debug.checkjni&#34;</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_ENABLE_CHECKJNI</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            String genDebugInfoProperty <span style="color:#f92672">=</span> SystemProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;debug.generate-debug-info&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>genDebugInfoProperty<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>genDebugInfoProperty<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_GENERATE_DEBUG_INFO</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            String genMiniDebugInfoProperty <span style="color:#f92672">=</span> SystemProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;dalvik.vm.minidebuginfo&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>genMiniDebugInfoProperty<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>genMiniDebugInfoProperty<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_GENERATE_MINI_DEBUG_INFO</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>SystemProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;debug.jni.logging&#34;</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_ENABLE_JNI_LOGGING</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>SystemProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;debug.assert&#34;</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_ENABLE_ASSERT</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mNativeDebuggingApp <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mNativeDebuggingApp<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Enable all debug flags required by the native debugger.
</span><span style="color:#75715e"></span>                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_ALWAYS_JIT</span><span style="color:#f92672">;</span>          <span style="color:#75715e">// Don&#39;t interpret anything
</span><span style="color:#75715e"></span>                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_GENERATE_DEBUG_INFO</span><span style="color:#f92672">;</span> <span style="color:#75715e">// Generate debug info
</span><span style="color:#75715e"></span>                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_NATIVE_DEBUGGABLE</span><span style="color:#f92672">;</span>   <span style="color:#75715e">// Disbale optimizations
</span><span style="color:#75715e"></span>                mNativeDebuggingApp <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isPrivilegedApp</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span>
                    <span style="color:#f92672">!</span>SystemProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getBoolean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;pm.dexopt.priv-apps&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">DISABLE_VERIFIER</span><span style="color:#f92672">;</span>
                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">ONLY_USE_SYSTEM_OAT_FILES</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAllowedToUseHiddenApi</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span>
                    <span style="color:#f92672">!</span>disableHiddenApiChecks <span style="color:#f92672">&amp;&amp;</span>
                    <span style="color:#f92672">!</span>mHiddenApiBlacklist<span style="color:#f92672">.</span><span style="color:#a6e22e">isDisabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// This app is not allowed to use undocumented and private APIs, or blacklisting is
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// enabled. Set up its runtime with the appropriate flag.
</span><span style="color:#75715e"></span>                runtimeFlags <span style="color:#f92672">|=</span> Zygote<span style="color:#f92672">.</span><span style="color:#a6e22e">ENABLE_HIDDEN_API_CHECKS</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            String invokeWith <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> ApplicationInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_DEBUGGABLE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Debuggable apps may include a wrapper script with their library directory.
</span><span style="color:#75715e"></span>                String wrapperFileName <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">nativeLibraryDir</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/wrap.sh&#34;</span><span style="color:#f92672">;</span>
                StrictMode<span style="color:#f92672">.</span><span style="color:#a6e22e">ThreadPolicy</span> oldPolicy <span style="color:#f92672">=</span> StrictMode<span style="color:#f92672">.</span><span style="color:#a6e22e">allowThreadDiskReads</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>wrapperFileName<span style="color:#f92672">).</span><span style="color:#a6e22e">exists</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        invokeWith <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/system/bin/logwrapper &#34;</span> <span style="color:#f92672">+</span> wrapperFileName<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                    StrictMode<span style="color:#f92672">.</span><span style="color:#a6e22e">setThreadPolicy</span><span style="color:#f92672">(</span>oldPolicy<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            String requiredAbi <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>abiOverride <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> abiOverride <span style="color:#f92672">:</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">primaryCpuAbi</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requiredAbi <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                requiredAbi <span style="color:#f92672">=</span> Build<span style="color:#f92672">.</span><span style="color:#a6e22e">SUPPORTED_ABIS</span><span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>
            <span style="color:#f92672">}</span>

            String instructionSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">primaryCpuAbi</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                instructionSet <span style="color:#f92672">=</span> VMRuntime<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstructionSet</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">primaryCpuAbi</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            app<span style="color:#f92672">.</span><span style="color:#a6e22e">gids</span> <span style="color:#f92672">=</span> gids<span style="color:#f92672">;</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">requiredAbi</span> <span style="color:#f92672">=</span> requiredAbi<span style="color:#f92672">;</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">instructionSet</span> <span style="color:#f92672">=</span> instructionSet<span style="color:#f92672">;</span>

            <span style="color:#75715e">// the per-user SELinux context must be set
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>TextUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">seInfoUser</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">wtf</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;SELinux tag not defined&#34;</span><span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SELinux tag not defined for &#34;</span>
                        <span style="color:#f92672">+</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; (uid &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;)&#34;</span><span style="color:#f92672">));</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">final</span> String seInfo <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">seInfo</span>
                    <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>TextUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">seInfoUser</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">:</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">seInfoUser</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">// Start the process.  It will either succeed and return a result containing
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the PID of the new process, or else throw a RuntimeException.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> isActivityProcess <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>entryPoint <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>entryPoint <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> entryPoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;android.app.ActivityThread&#34;</span><span style="color:#f92672">;</span>
            Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Start proc: &#34;</span> <span style="color:#f92672">+</span>
                    app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">);</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: asking zygote to start proc&#34;</span><span style="color:#f92672">);</span>
            ProcessStartResult startResult<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hostingType<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;webview_service&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                startResult <span style="color:#f92672">=</span> startWebView<span style="color:#f92672">(</span>entryPoint<span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span> uid<span style="color:#f92672">,</span> uid<span style="color:#f92672">,</span> gids<span style="color:#f92672">,</span> runtimeFlags<span style="color:#f92672">,</span> mountExternal<span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetSdkVersion</span><span style="color:#f92672">,</span> seInfo<span style="color:#f92672">,</span> requiredAbi<span style="color:#f92672">,</span> instructionSet<span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dataDir</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> entryPointArgs<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                startResult <span style="color:#f92672">=</span> Process<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>entryPoint<span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span> uid<span style="color:#f92672">,</span> uid<span style="color:#f92672">,</span> gids<span style="color:#f92672">,</span> runtimeFlags<span style="color:#f92672">,</span> mountExternal<span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetSdkVersion</span><span style="color:#f92672">,</span> seInfo<span style="color:#f92672">,</span> requiredAbi<span style="color:#f92672">,</span> instructionSet<span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dataDir</span><span style="color:#f92672">,</span> invokeWith<span style="color:#f92672">,</span> entryPointArgs<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: returned from zygote!&#34;</span><span style="color:#f92672">);</span>
            Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">);</span>

            mBatteryStatsService<span style="color:#f92672">.</span><span style="color:#a6e22e">noteProcessStart</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">);</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: done updating battery stats&#34;</span><span style="color:#f92672">);</span>

            EventLog<span style="color:#f92672">.</span><span style="color:#a6e22e">writeEvent</span><span style="color:#f92672">(</span>EventLogTags<span style="color:#f92672">.</span><span style="color:#a6e22e">AM_PROC_START</span><span style="color:#f92672">,</span>
                    UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserId</span><span style="color:#f92672">(</span>uid<span style="color:#f92672">),</span> startResult<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">,</span> uid<span style="color:#f92672">,</span>
                    app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span> hostingType<span style="color:#f92672">,</span>
                    hostingNameStr <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> hostingNameStr <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                AppGlobals<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">logAppProcessStartIfNeeded</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">,</span>
                        seInfo<span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sourceDir</span><span style="color:#f92672">,</span> startResult<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Ignore
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">persistent</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Watchdog<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">processStarted</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span> startResult<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: building log message&#34;</span><span style="color:#f92672">);</span>
            StringBuilder buf <span style="color:#f92672">=</span> mStringBuilder<span style="color:#f92672">;</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">setLength</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Start proc &#34;</span><span style="color:#f92672">);</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>startResult<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">);</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;:&#39;</span><span style="color:#f92672">);</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">);</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">);</span>
            UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">formatUid</span><span style="color:#f92672">(</span>buf<span style="color:#f92672">,</span> uid<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isActivityProcess<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34; [&#34;</span><span style="color:#f92672">);</span>
                buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>entryPoint<span style="color:#f92672">);</span>
                buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;]&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34; for &#34;</span><span style="color:#f92672">);</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>hostingType<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hostingNameStr <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">);</span>
                buf<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>hostingNameStr<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> buf<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">setPid</span><span style="color:#f92672">(</span>startResult<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">);</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">usingWrapper</span> <span style="color:#f92672">=</span> startResult<span style="color:#f92672">.</span><span style="color:#a6e22e">usingWrapper</span><span style="color:#f92672">;</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">removed</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">killed</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">killedByAm</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: starting to update pids map&#34;</span><span style="color:#f92672">);</span>
            ProcessRecord oldApp<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mPidsSelfLocked<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                oldApp <span style="color:#f92672">=</span> mPidsSelfLocked<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>startResult<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// If there is already an app occupying that pid that hasn&#39;t been cleaned up
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>oldApp <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">isolated</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Clean up anything relating to this pid first
</span><span style="color:#75715e"></span>                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Reusing pid &#34;</span> <span style="color:#f92672">+</span> startResult<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; while app is still mapped to it&#34;</span><span style="color:#f92672">);</span>
                cleanUpApplicationRecordLocked<span style="color:#f92672">(</span>oldApp<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">true</span> <span style="color:#75715e">/*replacingPid*/</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mPidsSelfLocked<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mPidsSelfLocked</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>startResult<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">,</span> app<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isActivityProcess<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Message msg <span style="color:#f92672">=</span> mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">obtainMessage</span><span style="color:#f92672">(</span>PROC_START_TIMEOUT_MSG<span style="color:#f92672">);</span>
                    msg<span style="color:#f92672">.</span><span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> app<span style="color:#f92672">;</span>
                    mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">sendMessageDelayed</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> startResult<span style="color:#f92672">.</span><span style="color:#a6e22e">usingWrapper</span>
                            <span style="color:#f92672">?</span> PROC_START_TIMEOUT_WITH_WRAPPER <span style="color:#f92672">:</span> PROC_START_TIMEOUT<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: done updating pids map&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RuntimeException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Failure starting process &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>

            <span style="color:#75715e">// Something went very wrong while trying to start this process; one
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// common case is when the package is frozen due to an active
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// upgrade. To recover, clean up any active bookkeeping related to
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// starting this process. (We already invoked this method once when
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the package was initially frozen through KILL_APPLICATION_MSG, so
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// it doesn&#39;t hurt to use it again.)
</span><span style="color:#75715e"></span>            forceStopPackageLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getAppId</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>
                    <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserId</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;start failure&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>新的应用启动的入口是主线程ActivityThread的main方法，这里可以看到使用Lopper为主线程启动了消息循环，然后调用<code>attach()</code>方法:
ActivityThread.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ActivityThreadMain&#34;</span><span style="color:#f92672">);</span>

        <span style="color:#75715e">// CloseGuard defaults to true and can be quite spammy.  We
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// disable it here, but selectively enable it later (via
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// StrictMode) on debug builds, but using DropBox, not logs.
</span><span style="color:#75715e"></span>        CloseGuard<span style="color:#f92672">.</span><span style="color:#a6e22e">setEnabled</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>

        Environment<span style="color:#f92672">.</span><span style="color:#a6e22e">initForCurrentUser</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// Set the reporter for event logging in libcore
</span><span style="color:#75715e"></span>        EventLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">setReporter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> EventLoggingReporter<span style="color:#f92672">());</span>

        <span style="color:#75715e">// Make sure TrustedCertificateStore looks in the right place for CA certificates
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> File configDir <span style="color:#f92672">=</span> Environment<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserConfigDirectory</span><span style="color:#f92672">(</span>UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">myUserId</span><span style="color:#f92672">());</span>
        TrustedCertificateStore<span style="color:#f92672">.</span><span style="color:#a6e22e">setDefaultUserDirectory</span><span style="color:#f92672">(</span>configDir<span style="color:#f92672">);</span>

        Process<span style="color:#f92672">.</span><span style="color:#a6e22e">setArgV0</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&lt;pre-initialized&gt;&#34;</span><span style="color:#f92672">);</span>

        Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareMainLooper</span><span style="color:#f92672">();</span>

        ActivityThread thread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ActivityThread<span style="color:#f92672">();</span>
        thread<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sMainThreadHandler <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            sMainThreadHandler <span style="color:#f92672">=</span> thread<span style="color:#f92672">.</span><span style="color:#a6e22e">getHandler</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setMessageLogging</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span>
                    LogPrinter<span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ActivityThread&#34;</span><span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// End of event ActivityThreadMain.
</span><span style="color:#75715e"></span>        Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">);</span>
        Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">loop</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Main thread loop unexpectedly exited&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> system<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sCurrentActivityThread <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>
        mSystemThread <span style="color:#f92672">=</span> system<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>system<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            ViewRootImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">addFirstDrawHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    ensureJitEnabled<span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">});</span>
            android<span style="color:#f92672">.</span><span style="color:#a6e22e">ddm</span><span style="color:#f92672">.</span><span style="color:#a6e22e">DdmHandleAppName</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setAppName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&lt;pre-initialized&gt;&#34;</span><span style="color:#f92672">,</span>
                                                    UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">myUserId</span><span style="color:#f92672">());</span>
            RuntimeInit<span style="color:#f92672">.</span><span style="color:#a6e22e">setApplicationObject</span><span style="color:#f92672">(</span>mAppThread<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">());</span>
            <span style="color:#66d9ef">final</span> IActivityManager mgr <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                mgr<span style="color:#f92672">.</span><span style="color:#a6e22e">attachApplication</span><span style="color:#f92672">(</span>mAppThread<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> ex<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// Watch for getting close to heap limit.
</span><span style="color:#75715e"></span>            BinderInternal<span style="color:#f92672">.</span><span style="color:#a6e22e">addGcWatcher</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mSomeActivitiesChanged<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                    Runtime runtime <span style="color:#f92672">=</span> Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">long</span> dalvikMax <span style="color:#f92672">=</span> runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">maxMemory</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">long</span> dalvikUsed <span style="color:#f92672">=</span> runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">totalMemory</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">freeMemory</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dalvikUsed <span style="color:#f92672">&gt;</span> <span style="color:#f92672">((</span>3<span style="color:#f92672">*</span>dalvikMax<span style="color:#f92672">)/</span>4<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_MEMORY_TRIM<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Dalvik max=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>dalvikMax<span style="color:#f92672">/</span>1024<span style="color:#f92672">)</span>
                                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; total=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">totalMemory</span><span style="color:#f92672">()/</span>1024<span style="color:#f92672">)</span>
                                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; used=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>dalvikUsed<span style="color:#f92672">/</span>1024<span style="color:#f92672">));</span>
                        mSomeActivitiesChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                            mgr<span style="color:#f92672">.</span><span style="color:#a6e22e">releaseSomeActivities</span><span style="color:#f92672">(</span>mAppThread<span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">});</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Don&#39;t set application object here -- if the system crashes,
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// we can&#39;t display an alert, we just want to die die die.
</span><span style="color:#75715e"></span>            android<span style="color:#f92672">.</span><span style="color:#a6e22e">ddm</span><span style="color:#f92672">.</span><span style="color:#a6e22e">DdmHandleAppName</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setAppName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;system_process&#34;</span><span style="color:#f92672">,</span>
                    UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">myUserId</span><span style="color:#f92672">());</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                mInstrumentation <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Instrumentation<span style="color:#f92672">();</span>
                ContextImpl context <span style="color:#f92672">=</span> ContextImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">createAppContext</span><span style="color:#f92672">(</span>
                        <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> getSystemContext<span style="color:#f92672">().</span><span style="color:#a6e22e">mLoadedApk</span><span style="color:#f92672">);</span>
                mInitialApplication <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">mLoadedApk</span><span style="color:#f92672">.</span><span style="color:#a6e22e">makeApplication</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
                mInitialApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">onCreate</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
                        <span style="color:#e6db74">&#34;Unable to instantiate Application():&#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// add dropbox logging to libcore
</span><span style="color:#75715e"></span>        DropBox<span style="color:#f92672">.</span><span style="color:#a6e22e">setReporter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DropBoxReporter<span style="color:#f92672">());</span>

        ViewRootImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">ConfigChangedCallback</span> configChangedCallback
                <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Configuration globalConfig<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mResourcesManager<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// We need to apply this change to the resources immediately, because upon returning
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the view hierarchy will be informed about it.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mResourcesManager<span style="color:#f92672">.</span><span style="color:#a6e22e">applyConfigurationToResourcesLocked</span><span style="color:#f92672">(</span>globalConfig<span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">null</span> <span style="color:#75715e">/* compat */</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    updateLocaleListFromAppContext<span style="color:#f92672">(</span>mInitialApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">getApplicationContext</span><span style="color:#f92672">(),</span>
                            mResourcesManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getConfiguration</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getLocales</span><span style="color:#f92672">());</span>

                    <span style="color:#75715e">// This actually changed the resources! Tell everyone about it.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mPendingConfiguration <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>
                            <span style="color:#f92672">||</span> mPendingConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">isOtherSeqNewer</span><span style="color:#f92672">(</span>globalConfig<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        mPendingConfiguration <span style="color:#f92672">=</span> globalConfig<span style="color:#f92672">;</span>
                        sendMessage<span style="color:#f92672">(</span>H<span style="color:#f92672">.</span><span style="color:#a6e22e">CONFIGURATION_CHANGED</span><span style="color:#f92672">,</span> globalConfig<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">};</span>
        ViewRootImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">addConfigCallback</span><span style="color:#f92672">(</span>configChangedCallback<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>这里获取AMS代理，然后调用AMS的<code>attachApplication()</code>，并将主线程的ApplicationThread对象传入，以进行IPC通信。
ActivityManagerService.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">attachApplication</span><span style="color:#f92672">(</span>IApplicationThread thread<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> callingPid <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallingPid</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> origId <span style="color:#f92672">=</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">clearCallingIdentity</span><span style="color:#f92672">();</span>
            attachApplicationLocked<span style="color:#f92672">(</span>thread<span style="color:#f92672">,</span> callingPid<span style="color:#f92672">);</span>
            Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">restoreCallingIdentity</span><span style="color:#f92672">(</span>origId<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">attachApplicationLocked</span><span style="color:#f92672">(</span>IApplicationThread thread<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> pid<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#75715e">// Find the application record that is being attached...  either via
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// the pid if we are running in multiple processes, or just pull the
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// next app record if we are emulating process with anonymous threads.
</span><span style="color:#75715e"></span>        ProcessRecord app<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> startTime <span style="color:#f92672">=</span> SystemClock<span style="color:#f92672">.</span><span style="color:#a6e22e">uptimeMillis</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pid <span style="color:#f92672">!=</span> MY_PID <span style="color:#f92672">&amp;&amp;</span> pid <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mPidsSelfLocked<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                app <span style="color:#f92672">=</span> mPidsSelfLocked<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>pid<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            app <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;No pending application record for pid &#34;</span> <span style="color:#f92672">+</span> pid
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; (IApplicationThread &#34;</span> <span style="color:#f92672">+</span> thread <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;); dropping process&#34;</span><span style="color:#f92672">);</span>
            EventLog<span style="color:#f92672">.</span><span style="color:#a6e22e">writeEvent</span><span style="color:#f92672">(</span>EventLogTags<span style="color:#f92672">.</span><span style="color:#a6e22e">AM_DROP_PROCESS</span><span style="color:#f92672">,</span> pid<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pid <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">&amp;&amp;</span> pid <span style="color:#f92672">!=</span> MY_PID<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                killProcessQuiet<span style="color:#f92672">(</span>pid<span style="color:#f92672">);</span>
                <span style="color:#75715e">//TODO: killProcessGroup(app.info.uid, pid);
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    thread<span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleExit</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Ignore exceptions.
</span><span style="color:#75715e"></span>                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If this application record is still attached to a previous
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// process, clean it up now.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            handleAppDiedLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Tell the process all about itself.
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_ALL<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
                TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Binding process pid &#34;</span> <span style="color:#f92672">+</span> pid <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; to record &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">final</span> String processName <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            AppDeathRecipient adr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AppDeathRecipient<span style="color:#f92672">(</span>
                    app<span style="color:#f92672">,</span> pid<span style="color:#f92672">,</span> thread<span style="color:#f92672">);</span>
            thread<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">().</span><span style="color:#a6e22e">linkToDeath</span><span style="color:#f92672">(</span>adr<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">deathRecipient</span> <span style="color:#f92672">=</span> adr<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">resetPackageList</span><span style="color:#f92672">(</span>mProcessStats<span style="color:#f92672">);</span>
            startProcessLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;link fail&#34;</span><span style="color:#f92672">,</span> processName<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        EventLog<span style="color:#f92672">.</span><span style="color:#a6e22e">writeEvent</span><span style="color:#f92672">(</span>EventLogTags<span style="color:#f92672">.</span><span style="color:#a6e22e">AM_PROC_BOUND</span><span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">pid</span><span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">);</span>

        app<span style="color:#f92672">.</span><span style="color:#a6e22e">makeActive</span><span style="color:#f92672">(</span>thread<span style="color:#f92672">,</span> mProcessStats<span style="color:#f92672">);</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">curAdj</span> <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">setAdj</span> <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">verifiedAdj</span> <span style="color:#f92672">=</span> ProcessList<span style="color:#f92672">.</span><span style="color:#a6e22e">INVALID_ADJ</span><span style="color:#f92672">;</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">curSchedGroup</span> <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">setSchedGroup</span> <span style="color:#f92672">=</span> ProcessList<span style="color:#f92672">.</span><span style="color:#a6e22e">SCHED_GROUP_DEFAULT</span><span style="color:#f92672">;</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">forcingToImportant</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        updateProcessForegroundLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">hasShownUi</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">debugging</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">cached</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">killedByAm</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">killed</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>


        <span style="color:#75715e">// We carefully use the same state that PackageManager uses for
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// filtering, since we use this flag to decide if we need to install
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// providers when user is unlocked later
</span><span style="color:#75715e"></span>        app<span style="color:#f92672">.</span><span style="color:#a6e22e">unlocked</span> <span style="color:#f92672">=</span> StorageManager<span style="color:#f92672">.</span><span style="color:#a6e22e">isUserKeyUnlocked</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">);</span>

        mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">removeMessages</span><span style="color:#f92672">(</span>PROC_START_TIMEOUT_MSG<span style="color:#f92672">,</span> app<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">boolean</span> normalMode <span style="color:#f92672">=</span> mProcessesReady <span style="color:#f92672">||</span> isAllowedWhileBooting<span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">);</span>
        List<span style="color:#f92672">&lt;</span>ProviderInfo<span style="color:#f92672">&gt;</span> providers <span style="color:#f92672">=</span> normalMode <span style="color:#f92672">?</span> generateApplicationProvidersLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>providers <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> checkAppInLaunchingProvidersLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            Message msg <span style="color:#f92672">=</span> mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">obtainMessage</span><span style="color:#f92672">(</span>CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG<span style="color:#f92672">);</span>
            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> app<span style="color:#f92672">;</span>
            mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">sendMessageDelayed</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> CONTENT_PROVIDER_PUBLISH_TIMEOUT<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;attachApplicationLocked: before bindApplication&#34;</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>normalMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">i</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Launching preboot mode app: &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_ALL<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
            TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;New app record &#34;</span> <span style="color:#f92672">+</span> app
            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; thread=&#34;</span> <span style="color:#f92672">+</span> thread<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; pid=&#34;</span> <span style="color:#f92672">+</span> pid<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> testMode <span style="color:#f92672">=</span> ApplicationThreadConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_OFF</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mDebugApp <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mDebugApp<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                testMode <span style="color:#f92672">=</span> mWaitForDebugger
                    <span style="color:#f92672">?</span> ApplicationThreadConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_WAIT</span>
                    <span style="color:#f92672">:</span> ApplicationThreadConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG_ON</span><span style="color:#f92672">;</span>
                app<span style="color:#f92672">.</span><span style="color:#a6e22e">debugging</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mDebugTransient<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mDebugApp <span style="color:#f92672">=</span> mOrigDebugApp<span style="color:#f92672">;</span>
                    mWaitForDebugger <span style="color:#f92672">=</span> mOrigWaitForDebugger<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">boolean</span> enableTrackAllocation <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mTrackAllocationApp <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mTrackAllocationApp<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                enableTrackAllocation <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                mTrackAllocationApp <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// If the app is being launched for restore or full backup, set it up specially
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> isRestrictedBackupMode <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mBackupTarget <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mBackupAppName<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                isRestrictedBackupMode <span style="color:#f92672">=</span> mBackupTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">appInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">&gt;=</span> FIRST_APPLICATION_UID
                        <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">((</span>mBackupTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">backupMode</span> <span style="color:#f92672">==</span> BackupRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">RESTORE</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>mBackupTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">backupMode</span> <span style="color:#f92672">==</span> BackupRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">RESTORE_FULL</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>mBackupTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">backupMode</span> <span style="color:#f92672">==</span> BackupRecord<span style="color:#f92672">.</span><span style="color:#a6e22e">BACKUP_FULL</span><span style="color:#f92672">));</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                notifyPackageUse<span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mClass</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageName</span><span style="color:#f92672">(),</span>
                                 PackageManager<span style="color:#f92672">.</span><span style="color:#a6e22e">NOTIFY_PACKAGE_USE_INSTRUMENTATION</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_CONFIGURATION<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_CONFIGURATION<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Binding proc &#34;</span>
                    <span style="color:#f92672">+</span> processName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; with config &#34;</span> <span style="color:#f92672">+</span> getGlobalConfiguration<span style="color:#f92672">());</span>
            ApplicationInfo appInfo <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mTargetInfo</span> <span style="color:#f92672">:</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">;</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">compat</span> <span style="color:#f92672">=</span> compatibilityInfoForPackageLocked<span style="color:#f92672">(</span>appInfo<span style="color:#f92672">);</span>

            ProfilerInfo profilerInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            String preBindAgent <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mProfileApp <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mProfileApp<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                mProfileProc <span style="color:#f92672">=</span> app<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mProfilerInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Send a profiler info object to the app if either a file is given, or
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// an agent should be loaded at bind-time.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">boolean</span> needsInfo <span style="color:#f92672">=</span> mProfilerInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">profileFile</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                            <span style="color:#f92672">||</span> mProfilerInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">attachAgentDuringBind</span><span style="color:#f92672">;</span>
                    profilerInfo <span style="color:#f92672">=</span> needsInfo <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> ProfilerInfo<span style="color:#f92672">(</span>mProfilerInfo<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mProfilerInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">agent</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        preBindAgent <span style="color:#f92672">=</span> mProfilerInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">agent</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mProfileFile</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                profilerInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProfilerInfo<span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mProfileFile</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAppAgentMap <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mAppAgentMap<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// We need to do a debuggable check here. See setAgentApp for why the check is
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// postponed to here.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> ApplicationInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_DEBUGGABLE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    String agent <span style="color:#f92672">=</span> mAppAgentMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">);</span>
                    <span style="color:#75715e">// Do not overwrite already requested agent.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>profilerInfo <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        profilerInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProfilerInfo<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>
                                mAppAgentMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">),</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>profilerInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">agent</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        profilerInfo <span style="color:#f92672">=</span> profilerInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">setAgent</span><span style="color:#f92672">(</span>mAppAgentMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">),</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>profilerInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> profilerInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">profileFd</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                profilerInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">profileFd</span> <span style="color:#f92672">=</span> profilerInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">profileFd</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dup</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// We deprecated Build.SERIAL and it is not accessible to
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// apps that target the v2 security sandbox. Since access to
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the serial is now behind a permission we push down the value.
</span><span style="color:#75715e"></span>            String buildSerial <span style="color:#f92672">=</span> appInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">targetSandboxVersion</span> <span style="color:#f92672">&lt;</span> 2
                    <span style="color:#f92672">?</span> sTheRealBuildSerial <span style="color:#f92672">:</span> Build<span style="color:#f92672">.</span><span style="color:#a6e22e">UNKNOWN</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// Check if this is a secondary process that should be incorporated into some
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// currently active instrumentation.  (Note we do this AFTER all of the profiling
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// stuff above because profiling can currently happen only in the primary
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// instrumentation process.)
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mActiveInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">&amp;&amp;</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> mActiveInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span> i <span style="color:#f92672">&gt;=</span> 0 <span style="color:#f92672">&amp;&amp;</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> i<span style="color:#f92672">--)</span> <span style="color:#f92672">{</span>
                    ActiveInstrumentation aInstr <span style="color:#f92672">=</span> mActiveInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>aInstr<span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span> <span style="color:#f92672">&amp;&amp;</span> aInstr<span style="color:#f92672">.</span><span style="color:#a6e22e">mTargetInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>aInstr<span style="color:#f92672">.</span><span style="color:#a6e22e">mTargetProcesses</span><span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#75715e">// This is the wildcard mode, where every process brought up for
</span><span style="color:#75715e"></span>                            <span style="color:#75715e">// the target instrumentation should be included.
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>aInstr<span style="color:#f92672">.</span><span style="color:#a6e22e">mTargetInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                                app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span> <span style="color:#f92672">=</span> aInstr<span style="color:#f92672">;</span>
                                aInstr<span style="color:#f92672">.</span><span style="color:#a6e22e">mRunningProcesses</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String proc <span style="color:#f92672">:</span> aInstr<span style="color:#f92672">.</span><span style="color:#a6e22e">mTargetProcesses</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>proc<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                                    app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span> <span style="color:#f92672">=</span> aInstr<span style="color:#f92672">;</span>
                                    aInstr<span style="color:#f92672">.</span><span style="color:#a6e22e">mRunningProcesses</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
                                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                                <span style="color:#f92672">}</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// If we were asked to attach an agent on startup, do so now, before we&#39;re binding
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// application code.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preBindAgent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                thread<span style="color:#f92672">.</span><span style="color:#a6e22e">attachAgent</span><span style="color:#f92672">(</span>preBindAgent<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;attachApplicationLocked: immediately before bindApplication&#34;</span><span style="color:#f92672">);</span>
            mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">mActivityMetricsLogger</span><span style="color:#f92672">.</span><span style="color:#a6e22e">notifyBindApplication</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                thread<span style="color:#f92672">.</span><span style="color:#a6e22e">bindApplication</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">,</span> appInfo<span style="color:#f92672">,</span> providers<span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mClass</span><span style="color:#f92672">,</span>
                        profilerInfo<span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mArguments</span><span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mWatcher</span><span style="color:#f92672">,</span>
                        app<span style="color:#f92672">.</span><span style="color:#a6e22e">instr</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mUiAutomationConnection</span><span style="color:#f92672">,</span> testMode<span style="color:#f92672">,</span>
                        mBinderTransactionTrackingEnabled<span style="color:#f92672">,</span> enableTrackAllocation<span style="color:#f92672">,</span>
                        isRestrictedBackupMode <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>normalMode<span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">persistent</span><span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">new</span> Configuration<span style="color:#f92672">(</span>getGlobalConfiguration<span style="color:#f92672">()),</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">compat</span><span style="color:#f92672">,</span>
                        getCommonServicesLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">isolated</span><span style="color:#f92672">),</span>
                        mCoreSettingsObserver<span style="color:#f92672">.</span><span style="color:#a6e22e">getCoreSettingsLocked</span><span style="color:#f92672">(),</span>
                        buildSerial<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                thread<span style="color:#f92672">.</span><span style="color:#a6e22e">bindApplication</span><span style="color:#f92672">(</span>processName<span style="color:#f92672">,</span> appInfo<span style="color:#f92672">,</span> providers<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> profilerInfo<span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> testMode<span style="color:#f92672">,</span>
                        mBinderTransactionTrackingEnabled<span style="color:#f92672">,</span> enableTrackAllocation<span style="color:#f92672">,</span>
                        isRestrictedBackupMode <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>normalMode<span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">persistent</span><span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">new</span> Configuration<span style="color:#f92672">(</span>getGlobalConfiguration<span style="color:#f92672">()),</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">compat</span><span style="color:#f92672">,</span>
                        getCommonServicesLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">isolated</span><span style="color:#f92672">),</span>
                        mCoreSettingsObserver<span style="color:#f92672">.</span><span style="color:#a6e22e">getCoreSettingsLocked</span><span style="color:#f92672">(),</span>
                        buildSerial<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;attachApplicationLocked: immediately after bindApplication&#34;</span><span style="color:#f92672">);</span>
            updateLruProcessLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;attachApplicationLocked: after updateLruProcessLocked&#34;</span><span style="color:#f92672">);</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">lastRequestedGc</span> <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">lastLowMemory</span> <span style="color:#f92672">=</span> SystemClock<span style="color:#f92672">.</span><span style="color:#a6e22e">uptimeMillis</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// todo: Yikes!  What should we do?  For now we will try to
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// start another process, but that could easily get us in
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// an infinite loop of restarting processes...
</span><span style="color:#75715e"></span>            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">wtf</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Exception thrown during bind of &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>

            app<span style="color:#f92672">.</span><span style="color:#a6e22e">resetPackageList</span><span style="color:#f92672">(</span>mProcessStats<span style="color:#f92672">);</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">unlinkDeathRecipient</span><span style="color:#f92672">();</span>
            startProcessLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;bind fail&#34;</span><span style="color:#f92672">,</span> processName<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Remove this record from the list of starting applications.
</span><span style="color:#75715e"></span>        mPersistentStartingProcesses<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_PROCESSES <span style="color:#f92672">&amp;&amp;</span> mProcessesOnHold<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>app<span style="color:#f92672">))</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PROCESSES<span style="color:#f92672">,</span>
                <span style="color:#e6db74">&#34;Attach application locked removing on hold: &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">);</span>
        mProcessesOnHold<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">boolean</span> badApp <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> didSomething <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// See if the top visible activity is waiting to run in this process...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>normalMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mStackSupervisor<span style="color:#f92672">.</span><span style="color:#a6e22e">attachApplicationLocked</span><span style="color:#f92672">(</span>app<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    didSomething <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">wtf</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Exception thrown launching activities in &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                badApp <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Find any services that should be running in this process...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>badApp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                didSomething <span style="color:#f92672">|=</span> mServices<span style="color:#f92672">.</span><span style="color:#a6e22e">attachApplicationLocked</span><span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> processName<span style="color:#f92672">);</span>
                checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;attachApplicationLocked: after mServices.attachApplicationLocked&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">wtf</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Exception thrown starting services in &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                badApp <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Check if a next-broadcast receiver is in this process...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>badApp <span style="color:#f92672">&amp;&amp;</span> isPendingBroadcastProcessLocked<span style="color:#f92672">(</span>pid<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                didSomething <span style="color:#f92672">|=</span> sendPendingBroadcastsLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
                checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;attachApplicationLocked: after sendPendingBroadcastsLocked&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// If the app died trying to launch the receiver we declare it &#39;bad&#39;
</span><span style="color:#75715e"></span>                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">wtf</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Exception thrown dispatching broadcasts in &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                badApp <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Check whether the next backup agent is in this process...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>badApp <span style="color:#f92672">&amp;&amp;</span> mBackupTarget <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mBackupTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span> <span style="color:#f92672">==</span> app<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_BACKUP<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_BACKUP<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;New app is backup target, launching agent for &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">);</span>
            notifyPackageUse<span style="color:#f92672">(</span>mBackupTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">appInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span>
                             PackageManager<span style="color:#f92672">.</span><span style="color:#a6e22e">NOTIFY_PACKAGE_USE_BACKUP</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                thread<span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleCreateBackupAgent</span><span style="color:#f92672">(</span>mBackupTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">appInfo</span><span style="color:#f92672">,</span>
                        compatibilityInfoForPackageLocked<span style="color:#f92672">(</span>mBackupTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">appInfo</span><span style="color:#f92672">),</span>
                        mBackupTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">backupMode</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">wtf</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Exception thrown creating backup agent in &#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                badApp <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>badApp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            app<span style="color:#f92672">.</span><span style="color:#a6e22e">kill</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;error during init&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            handleAppDiedLocked<span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>didSomething<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            updateOomAdjLocked<span style="color:#f92672">();</span>
            checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;attachApplicationLocked: after updateOomAdjLocked&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

</code></pre></div><p>继续查看Activity相关调用流程，接着会调用到ActivityStackSupervisor的<code>attachApplicationLocked()</code>方法:
ActivityStackSupervisor.java，最终和上述需要启动的activity的进程已存在的情况一样，都会调用到<code>realStartActivityLocked()</code>方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">attachApplicationLocked</span><span style="color:#f92672">(</span>ProcessRecord app<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> RemoteException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> String processName <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">boolean</span> didSomething <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> displayNdx <span style="color:#f92672">=</span> mActivityDisplays<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span> displayNdx <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">;</span> <span style="color:#f92672">--</span>displayNdx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            ArrayList<span style="color:#f92672">&lt;</span>ActivityStack<span style="color:#f92672">&gt;</span> stacks <span style="color:#f92672">=</span> mActivityDisplays<span style="color:#f92672">.</span><span style="color:#a6e22e">valueAt</span><span style="color:#f92672">(</span>displayNdx<span style="color:#f92672">).</span><span style="color:#a6e22e">mStacks</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> stackNdx <span style="color:#f92672">=</span> stacks<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span> stackNdx <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">;</span> <span style="color:#f92672">--</span>stackNdx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> ActivityStack stack <span style="color:#f92672">=</span> stacks<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>stackNdx<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isFocusedStack<span style="color:#f92672">(</span>stack<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                stack<span style="color:#f92672">.</span><span style="color:#a6e22e">getAllRunningVisibleActivitiesLocked</span><span style="color:#f92672">(</span>mTmpActivityList<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">final</span> ActivityRecord top <span style="color:#f92672">=</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">topRunningActivityLocked</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> size <span style="color:#f92672">=</span> mTmpActivityList<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> size<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> ActivityRecord activity <span style="color:#f92672">=</span> mTmpActivityList<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>activity<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> activity<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span>
                            <span style="color:#f92672">&amp;&amp;</span> processName<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>realStartActivityLocked<span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> app<span style="color:#f92672">,</span>
                                    top <span style="color:#f92672">==</span> activity <span style="color:#75715e">/* andResume */</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span> <span style="color:#75715e">/* checkConfig */</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                                didSomething <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Exception in new application when starting activity &#34;</span>
                                    <span style="color:#f92672">+</span> top<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">flattenToShortString</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
                            <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>didSomething<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            ensureActivitiesVisibleLocked<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#f92672">!</span>PRESERVE_WINDOWS<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> didSomething<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">realStartActivityLocked</span><span style="color:#f92672">(</span>ActivityRecord r<span style="color:#f92672">,</span> ProcessRecord app<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> andResume<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> checkConfig<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> RemoteException <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>allPausedActivitiesComplete<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// While there are activities pausing we skipping starting any new activities until
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// pauses are complete. NOTE: that we also do this for activities that are starting in
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the paused state because they will first be resumed then paused on the client side.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH <span style="color:#f92672">||</span> DEBUG_PAUSE <span style="color:#f92672">||</span> DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_PAUSE<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;realStartActivityLocked: Skipping start of r=&#34;</span> <span style="color:#f92672">+</span> r
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; some activities pausing...&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">final</span> TaskRecord task <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">getTask</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> ActivityStack stack <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span><span style="color:#a6e22e">getStack</span><span style="color:#f92672">();</span>

        beginDeferResume<span style="color:#f92672">();</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">startFreezingScreenLocked</span><span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>

            <span style="color:#75715e">// schedule launch ticks to collect information about slow apps.
</span><span style="color:#75715e"></span>            r<span style="color:#f92672">.</span><span style="color:#a6e22e">startLaunchTickingLocked</span><span style="color:#f92672">();</span>

            r<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> app<span style="color:#f92672">;</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mKeyguardController<span style="color:#f92672">.</span><span style="color:#a6e22e">isKeyguardLocked</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">notifyUnknownVisibilityLaunched</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Have the window manager re-evaluate the orientation of the screen based on the new
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// activity order.  Note that as a result of this, it can call back into the activity
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// manager with a new orientation.  We don&#39;t care about that, because the activity is
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// not currently running so we are just restarting it anyway.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>checkConfig<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> displayId <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayId</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">final</span> Configuration config <span style="color:#f92672">=</span> mWindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">updateOrientationFromAppTokens</span><span style="color:#f92672">(</span>
                        getDisplayOverrideConfiguration<span style="color:#f92672">(</span>displayId<span style="color:#f92672">),</span>
                        r<span style="color:#f92672">.</span><span style="color:#a6e22e">mayFreezeScreenLocked</span><span style="color:#f92672">(</span>app<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> displayId<span style="color:#f92672">);</span>
                <span style="color:#75715e">// Deferring resume here because we&#39;re going to launch new activity shortly.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// We don&#39;t want to perform a redundant launch of the same record while ensuring
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// configurations and trying to resume top activity of focused stack.
</span><span style="color:#75715e"></span>                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateDisplayOverrideConfigurationLocked</span><span style="color:#f92672">(</span>config<span style="color:#f92672">,</span> r<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span> <span style="color:#75715e">/* deferResume */</span><span style="color:#f92672">,</span>
                        displayId<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">getStack</span><span style="color:#f92672">().</span><span style="color:#a6e22e">checkKeyguardVisibility</span><span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span> <span style="color:#75715e">/* shouldBeVisible */</span><span style="color:#f92672">,</span>
                    <span style="color:#66d9ef">true</span> <span style="color:#75715e">/* isTop */</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// We only set the visibility to true if the activity is allowed to be visible
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// based on
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// keyguard state. This avoids setting this into motion in window manager that is
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// later cancelled due to later calls to ensure visible activities that set
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// visibility back to false.
</span><span style="color:#75715e"></span>                r<span style="color:#f92672">.</span><span style="color:#a6e22e">setVisibility</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> applicationInfoUid <span style="color:#f92672">=</span>
                    <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span> <span style="color:#f92672">!=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">appInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> applicationInfoUid<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">wtf</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;User ID for activity changing for &#34;</span> <span style="color:#f92672">+</span> r
                                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; appInfo.uid=&#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">appInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uid</span>
                                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; info.ai.uid=&#34;</span> <span style="color:#f92672">+</span> applicationInfoUid
                                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; old=&#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; new=&#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            app<span style="color:#f92672">.</span><span style="color:#a6e22e">waitingToKill</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">launchCount</span><span style="color:#f92672">++;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">lastLaunchTime</span> <span style="color:#f92672">=</span> SystemClock<span style="color:#f92672">.</span><span style="color:#a6e22e">uptimeMillis</span><span style="color:#f92672">();</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_ALL<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Launching: &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">int</span> idx <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">activities</span><span style="color:#f92672">.</span><span style="color:#a6e22e">indexOf</span><span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>idx <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                app<span style="color:#f92672">.</span><span style="color:#a6e22e">activities</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateLruProcessLocked</span><span style="color:#f92672">(</span>app<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">updateOomAdjLocked</span><span style="color:#f92672">();</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>task<span style="color:#f92672">.</span><span style="color:#a6e22e">mLockTaskAuth</span> <span style="color:#f92672">==</span> LOCK_TASK_AUTH_LAUNCHABLE <span style="color:#f92672">||</span>
                    task<span style="color:#f92672">.</span><span style="color:#a6e22e">mLockTaskAuth</span> <span style="color:#f92672">==</span> LOCK_TASK_AUTH_LAUNCHABLE_PRIV<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                setLockTaskModeLocked<span style="color:#f92672">(</span>task<span style="color:#f92672">,</span> LOCK_TASK_MODE_LOCKED<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;mLockTaskAuth==LAUNCHABLE&#34;</span><span style="color:#f92672">,</span>
                        <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RemoteException<span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
                List<span style="color:#f92672">&lt;</span>ResultInfo<span style="color:#f92672">&gt;</span> results <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                List<span style="color:#f92672">&lt;</span>ReferrerIntent<span style="color:#f92672">&gt;</span> newIntents <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>andResume<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// We don&#39;t need to deliver new intents and/or set results if activity is going
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// to pause immediately after launch.
</span><span style="color:#75715e"></span>                    results <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">results</span><span style="color:#f92672">;</span>
                    newIntents <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">newIntents</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_SWITCH<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_SWITCH<span style="color:#f92672">,</span>
                        <span style="color:#e6db74">&#34;Launching: &#34;</span> <span style="color:#f92672">+</span> r <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; icicle=&#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">icicle</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; with results=&#34;</span> <span style="color:#f92672">+</span> results
                                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; newIntents=&#34;</span> <span style="color:#f92672">+</span> newIntents <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; andResume=&#34;</span> <span style="color:#f92672">+</span> andResume<span style="color:#f92672">);</span>
                EventLog<span style="color:#f92672">.</span><span style="color:#a6e22e">writeEvent</span><span style="color:#f92672">(</span>EventLogTags<span style="color:#f92672">.</span><span style="color:#a6e22e">AM_RESTART_ACTIVITY</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">userId</span><span style="color:#f92672">,</span>
                        System<span style="color:#f92672">.</span><span style="color:#a6e22e">identityHashCode</span><span style="color:#f92672">(</span>r<span style="color:#f92672">),</span> task<span style="color:#f92672">.</span><span style="color:#a6e22e">taskId</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">shortComponentName</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">isHomeActivity</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Home process is the root process of the task.
</span><span style="color:#75715e"></span>                    mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mHomeProcess</span> <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span><span style="color:#a6e22e">mActivities</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>0<span style="color:#f92672">).</span><span style="color:#a6e22e">app</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">notifyPackageUse</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getPackageName</span><span style="color:#f92672">(),</span>
                        PackageManager<span style="color:#f92672">.</span><span style="color:#a6e22e">NOTIFY_PACKAGE_USE_ACTIVITY</span><span style="color:#f92672">);</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">sleeping</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">forceNewConfig</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">showUnsupportedZoomDialogIfNeededLocked</span><span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
                mService<span style="color:#f92672">.</span><span style="color:#a6e22e">showAskCompatModeDialogLocked</span><span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">compat</span> <span style="color:#f92672">=</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">compatibilityInfoForPackageLocked</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">);</span>
                ProfilerInfo profilerInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mProfileApp</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mProfileApp</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mProfileProc</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mProfileProc</span> <span style="color:#f92672">==</span> app<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mProfileProc</span> <span style="color:#f92672">=</span> app<span style="color:#f92672">;</span>
                        ProfilerInfo profilerInfoSvc <span style="color:#f92672">=</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mProfilerInfo</span><span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>profilerInfoSvc <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> profilerInfoSvc<span style="color:#f92672">.</span><span style="color:#a6e22e">profileFile</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>profilerInfoSvc<span style="color:#f92672">.</span><span style="color:#a6e22e">profileFd</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                                    profilerInfoSvc<span style="color:#f92672">.</span><span style="color:#a6e22e">profileFd</span> <span style="color:#f92672">=</span> profilerInfoSvc<span style="color:#f92672">.</span><span style="color:#a6e22e">profileFd</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dup</span><span style="color:#f92672">();</span>
                                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                    profilerInfoSvc<span style="color:#f92672">.</span><span style="color:#a6e22e">closeFd</span><span style="color:#f92672">();</span>
                                <span style="color:#f92672">}</span>
                            <span style="color:#f92672">}</span>

                            profilerInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProfilerInfo<span style="color:#f92672">(</span>profilerInfoSvc<span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

                app<span style="color:#f92672">.</span><span style="color:#a6e22e">hasShownUi</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                app<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingUiClean</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                app<span style="color:#f92672">.</span><span style="color:#a6e22e">forceProcessStateUpTo</span><span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mTopProcessState</span><span style="color:#f92672">);</span>
                <span style="color:#75715e">// Because we could be starting an Activity in the system process this may not go
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// across a Binder interface which would create a new Configuration. Consequently
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// we have to always create a new Configuration here.
</span><span style="color:#75715e"></span>
                <span style="color:#66d9ef">final</span> MergedConfiguration mergedConfiguration <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MergedConfiguration<span style="color:#f92672">(</span>
                        mService<span style="color:#f92672">.</span><span style="color:#a6e22e">getGlobalConfiguration</span><span style="color:#f92672">(),</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">getMergedOverrideConfiguration</span><span style="color:#f92672">());</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">setLastReportedConfiguration</span><span style="color:#f92672">(</span>mergedConfiguration<span style="color:#f92672">);</span>

                logIfTransactionTooLarge<span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">icicle</span><span style="color:#f92672">);</span>
                app<span style="color:#f92672">.</span><span style="color:#a6e22e">thread</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleLaunchActivity</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Intent<span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">),</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span><span style="color:#f92672">,</span>
                        System<span style="color:#f92672">.</span><span style="color:#a6e22e">identityHashCode</span><span style="color:#f92672">(</span>r<span style="color:#f92672">),</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">,</span>
                        <span style="color:#75715e">// TODO: Have this take the merged configuration instead of separate global
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// and override configs.
</span><span style="color:#75715e"></span>                        mergedConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">getGlobalConfiguration</span><span style="color:#f92672">(),</span>
                        mergedConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">getOverrideConfiguration</span><span style="color:#f92672">(),</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">compat</span><span style="color:#f92672">,</span>
                        r<span style="color:#f92672">.</span><span style="color:#a6e22e">launchedFromPackage</span><span style="color:#f92672">,</span> task<span style="color:#f92672">.</span><span style="color:#a6e22e">voiceInteractor</span><span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">repProcState</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">icicle</span><span style="color:#f92672">,</span>
                        r<span style="color:#f92672">.</span><span style="color:#a6e22e">persistentState</span><span style="color:#f92672">,</span> results<span style="color:#f92672">,</span> newIntents<span style="color:#f92672">,</span> <span style="color:#f92672">!</span>andResume<span style="color:#f92672">,</span>
                        mService<span style="color:#f92672">.</span><span style="color:#a6e22e">isNextTransitionForward</span><span style="color:#f92672">(),</span> profilerInfo<span style="color:#f92672">);</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">privateFlags</span> <span style="color:#f92672">&amp;</span> ApplicationInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">PRIVATE_FLAG_CANT_SAVE_STATE</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// This may be a heavy-weight process!  Note that the package
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// manager will ensure that only activity can run in the main
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// process of the .apk, which is the only thing that will be
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// considered heavy-weight.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mHeavyWeightProcess</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                                <span style="color:#f92672">&amp;&amp;</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mHeavyWeightProcess</span> <span style="color:#f92672">!=</span> app<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Starting new heavy weight process &#34;</span> <span style="color:#f92672">+</span> app
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; when already running &#34;</span>
                                    <span style="color:#f92672">+</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mHeavyWeightProcess</span><span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                        mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mHeavyWeightProcess</span> <span style="color:#f92672">=</span> app<span style="color:#f92672">;</span>
                        Message msg <span style="color:#f92672">=</span> mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mHandler</span><span style="color:#f92672">.</span><span style="color:#a6e22e">obtainMessage</span><span style="color:#f92672">(</span>
                                ActivityManagerService<span style="color:#f92672">.</span><span style="color:#a6e22e">POST_HEAVY_NOTIFICATION_MSG</span><span style="color:#f92672">);</span>
                        msg<span style="color:#f92672">.</span><span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> r<span style="color:#f92672">;</span>
                        mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mHandler</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">launchFailed</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// This is the second time we failed -- finish activity
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// and give up.
</span><span style="color:#75715e"></span>                    Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Second failure launching &#34;</span>
                            <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">flattenToShortString</span><span style="color:#f92672">()</span>
                            <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, giving up&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                    mService<span style="color:#f92672">.</span><span style="color:#a6e22e">appDiedLocked</span><span style="color:#f92672">(</span>app<span style="color:#f92672">);</span>
                    stack<span style="color:#f92672">.</span><span style="color:#a6e22e">requestFinishActivityLocked</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span><span style="color:#f92672">,</span> Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">RESULT_CANCELED</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                            <span style="color:#e6db74">&#34;2nd-crash&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#75715e">// This is the first time we failed -- restart process and
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// retry.
</span><span style="color:#75715e"></span>                r<span style="color:#f92672">.</span><span style="color:#a6e22e">launchFailed</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                app<span style="color:#f92672">.</span><span style="color:#a6e22e">activities</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            endDeferResume<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        r<span style="color:#f92672">.</span><span style="color:#a6e22e">launchFailed</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stack<span style="color:#f92672">.</span><span style="color:#a6e22e">updateLRUListLocked</span><span style="color:#f92672">(</span>r<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Activity &#34;</span> <span style="color:#f92672">+</span> r <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; being launched, but already in LRU list&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>andResume <span style="color:#f92672">&amp;&amp;</span> readyToResume<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// As part of the process of launching, ActivityThread also performs
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// a resume.
</span><span style="color:#75715e"></span>            stack<span style="color:#f92672">.</span><span style="color:#a6e22e">minimalResumeActivityLocked</span><span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// This activity is not starting in the resumed state... which should look like we asked
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// it to pause+stop (but remain visible), and it has done so and reported back the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// current icicle and other state.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_STATES<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG_STATES<span style="color:#f92672">,</span>
                    <span style="color:#e6db74">&#34;Moving to PAUSED: &#34;</span> <span style="color:#f92672">+</span> r <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; (starting in paused state)&#34;</span><span style="color:#f92672">);</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> PAUSED<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Launch the new version setup screen if needed.  We do this -after-
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// launching the initial activity (that is, home), so that it can have
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// a chance to initialize itself while in the background, making the
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// switch back to it faster and look better.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isFocusedStack<span style="color:#f92672">(</span>stack<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">startSetupActivityLocked</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Update any services we are bound to that might care about whether
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// their client may have activities.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mService<span style="color:#f92672">.</span><span style="color:#a6e22e">mServices</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateServiceConnectionActivitiesLocked</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">app</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>    
</code></pre></div><p>如果要启动的activity进程已经存在了，那么使用IApplicationThread对象调用最终回调activity自身的生命周期方法，对于前一个activity，会执行onPause的回调，对于当前启动的activity会执行onResume回调。</p>
<p>ActivityThread#ApplicationThread.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">                <span style="color:#75715e">// we use token to identify this activity without having to send the
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// activity itself back to the activity manager. (matters more with ipc)
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleLaunchActivity</span><span style="color:#f92672">(</span>Intent intent<span style="color:#f92672">,</span> IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> ident<span style="color:#f92672">,</span>
                ActivityInfo info<span style="color:#f92672">,</span> Configuration curConfig<span style="color:#f92672">,</span> Configuration overrideConfig<span style="color:#f92672">,</span>
                CompatibilityInfo compatInfo<span style="color:#f92672">,</span> String referrer<span style="color:#f92672">,</span> IVoiceInteractor voiceInteractor<span style="color:#f92672">,</span>
                <span style="color:#66d9ef">int</span> procState<span style="color:#f92672">,</span> Bundle state<span style="color:#f92672">,</span> PersistableBundle persistentState<span style="color:#f92672">,</span>
                List<span style="color:#f92672">&lt;</span>ResultInfo<span style="color:#f92672">&gt;</span> pendingResults<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>ReferrerIntent<span style="color:#f92672">&gt;</span> pendingNewIntents<span style="color:#f92672">,</span>
                <span style="color:#66d9ef">boolean</span> notResumed<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> isForward<span style="color:#f92672">,</span> ProfilerInfo profilerInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

            updateProcessState<span style="color:#f92672">(</span>procState<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>

            ActivityClientRecord r <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ActivityClientRecord<span style="color:#f92672">();</span>

            r<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">=</span> token<span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">ident</span> <span style="color:#f92672">=</span> ident<span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span> <span style="color:#f92672">=</span> intent<span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">referrer</span> <span style="color:#f92672">=</span> referrer<span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">voiceInteractor</span> <span style="color:#f92672">=</span> voiceInteractor<span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span> <span style="color:#f92672">=</span> info<span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">compatInfo</span> <span style="color:#f92672">=</span> compatInfo<span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> state<span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">persistentState</span> <span style="color:#f92672">=</span> persistentState<span style="color:#f92672">;</span>

            r<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingResults</span> <span style="color:#f92672">=</span> pendingResults<span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingIntents</span> <span style="color:#f92672">=</span> pendingNewIntents<span style="color:#f92672">;</span>

            r<span style="color:#f92672">.</span><span style="color:#a6e22e">startsNotResumed</span> <span style="color:#f92672">=</span> notResumed<span style="color:#f92672">;</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">isForward</span> <span style="color:#f92672">=</span> isForward<span style="color:#f92672">;</span>

            r<span style="color:#f92672">.</span><span style="color:#a6e22e">profilerInfo</span> <span style="color:#f92672">=</span> profilerInfo<span style="color:#f92672">;</span>

            r<span style="color:#f92672">.</span><span style="color:#a6e22e">overrideConfig</span> <span style="color:#f92672">=</span> overrideConfig<span style="color:#f92672">;</span>
            updatePendingConfiguration<span style="color:#f92672">(</span>curConfig<span style="color:#f92672">);</span>

            sendMessage<span style="color:#f92672">(</span>H<span style="color:#f92672">.</span><span style="color:#a6e22e">LAUNCH_ACTIVITY</span><span style="color:#f92672">,</span> r<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">schedulePauseActivity</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> finished<span style="color:#f92672">,</span>
                <span style="color:#66d9ef">boolean</span> userLeaving<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> configChanges<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> dontReport<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> seq <span style="color:#f92672">=</span> getLifecycleSeq<span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_ORDER<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;pauseActivity &#34;</span> <span style="color:#f92672">+</span> ActivityThread<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; operation received seq: &#34;</span> <span style="color:#f92672">+</span> seq<span style="color:#f92672">);</span>
            sendMessage<span style="color:#f92672">(</span>
                    finished <span style="color:#f92672">?</span> H<span style="color:#f92672">.</span><span style="color:#a6e22e">PAUSE_ACTIVITY_FINISHING</span> <span style="color:#f92672">:</span> H<span style="color:#f92672">.</span><span style="color:#a6e22e">PAUSE_ACTIVITY</span><span style="color:#f92672">,</span>
                    token<span style="color:#f92672">,</span>
                    <span style="color:#f92672">(</span>userLeaving <span style="color:#f92672">?</span> USER_LEAVING <span style="color:#f92672">:</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">|</span> <span style="color:#f92672">(</span>dontReport <span style="color:#f92672">?</span> DONT_REPORT <span style="color:#f92672">:</span> 0<span style="color:#f92672">),</span>
                    configChanges<span style="color:#f92672">,</span>
                    seq<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleResumeActivity</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> processState<span style="color:#f92672">,</span>
                <span style="color:#66d9ef">boolean</span> isForward<span style="color:#f92672">,</span> Bundle resumeArgs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> seq <span style="color:#f92672">=</span> getLifecycleSeq<span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_ORDER<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">d</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;resumeActivity &#34;</span> <span style="color:#f92672">+</span> ActivityThread<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; operation received seq: &#34;</span> <span style="color:#f92672">+</span> seq<span style="color:#f92672">);</span>
            updateProcessState<span style="color:#f92672">(</span>processState<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            sendMessage<span style="color:#f92672">(</span>H<span style="color:#f92672">.</span><span style="color:#a6e22e">RESUME_ACTIVITY</span><span style="color:#f92672">,</span> token<span style="color:#f92672">,</span> isForward <span style="color:#f92672">?</span> 1 <span style="color:#f92672">:</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> seq<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
</code></pre></div><p>在消息LAUNCH_ACTIVITY发送出去后，由ActivityThread的Handler进行接收并处理，调用到<code>handleLaunchActivity()</code>方法：
ActivityThread.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleLaunchActivity</span><span style="color:#f92672">(</span>ActivityClientRecord r<span style="color:#f92672">,</span> Intent customIntent<span style="color:#f92672">,</span> String reason<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// If we are getting ready to gc after going to the background, well
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// we are back active so skip it.
</span><span style="color:#75715e"></span>        unscheduleGcIdler<span style="color:#f92672">();</span>
        mSomeActivitiesChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">profilerInfo</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mProfiler<span style="color:#f92672">.</span><span style="color:#a6e22e">setProfiler</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">profilerInfo</span><span style="color:#f92672">);</span>
            mProfiler<span style="color:#f92672">.</span><span style="color:#a6e22e">startProfiling</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Make sure we are running with the most recent config.
</span><span style="color:#75715e"></span>        handleConfigurationChanged<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
            TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Handling launch of &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">);</span>

        <span style="color:#75715e">// Initialize before creating the activity
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>ThreadedRenderer<span style="color:#f92672">.</span><span style="color:#a6e22e">sRendererDisabled</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            GraphicsEnvironment<span style="color:#f92672">.</span><span style="color:#a6e22e">earlyInitEGL</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        WindowManagerGlobal<span style="color:#f92672">.</span><span style="color:#a6e22e">initialize</span><span style="color:#f92672">();</span>

        Activity a <span style="color:#f92672">=</span> performLaunchActivity<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> customIntent<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>a <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">createdConfig</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Configuration<span style="color:#f92672">(</span>mConfiguration<span style="color:#f92672">);</span>
            reportSizeConfigurations<span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
            Bundle oldState <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">;</span>
            handleResumeActivity<span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">isForward</span><span style="color:#f92672">,</span>
                    <span style="color:#f92672">!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">startsNotResumed</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">lastProcessedSeq</span><span style="color:#f92672">,</span> reason<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span> <span style="color:#f92672">&amp;&amp;</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">startsNotResumed</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// The activity manager actually wants this one to start out paused, because it
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// needs to be visible but isn&#39;t in the foreground. We accomplish this by going
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// through the normal startup (because activities expect to go through onResume()
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// the first time they run, before their window is displayed), and then pausing it.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// However, in this case we do -not- need to do the full pause cycle (of freezing
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// and such) because the activity manager assumes it can just retain the current
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// state it has.
</span><span style="color:#75715e"></span>                performPauseActivityIfNeeded<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> reason<span style="color:#f92672">);</span>

                <span style="color:#75715e">// We need to keep around the original state, in case we need to be created again.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// But we only do this for pre-Honeycomb apps, which always save their state when
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// pausing, so we can not have them save their state when restarting from a paused
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// state. For HC and later, we want to (and can) let the state be saved as the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// normal part of stopping the activity.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">isPreHoneycomb</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> oldState<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If there was an error, for any reason, tell the activity manager to stop us.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">finishActivity</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span><span style="color:#f92672">,</span> Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">RESULT_CANCELED</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                            Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">DONT_FINISH_TASK_WITH_ACTIVITY</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> ex<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> Activity <span style="color:#a6e22e">performLaunchActivity</span><span style="color:#f92672">(</span>ActivityClientRecord r<span style="color:#f92672">,</span> Intent customIntent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// System.out.println(&#34;##### [&#34; + System.currentTimeMillis() + &#34;] ActivityThread.performLaunchActivity(&#34; + r + &#34;)&#34;);
</span><span style="color:#75715e"></span>
        ActivityInfo aInfo <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">loadedApk</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">loadedApk</span> <span style="color:#f92672">=</span> getLoadedApk<span style="color:#f92672">(</span>aInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">compatInfo</span><span style="color:#f92672">,</span>
                    Context<span style="color:#f92672">.</span><span style="color:#a6e22e">CONTEXT_INCLUDE_CODE</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        ComponentName component <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>component <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            component <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resolveActivity</span><span style="color:#f92672">(</span>
                mInitialApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManager</span><span style="color:#f92672">());</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setComponent</span><span style="color:#f92672">(</span>component<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetActivity</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            component <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ComponentName<span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">packageName</span><span style="color:#f92672">,</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetActivity</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        ContextImpl appContext <span style="color:#f92672">=</span> createBaseContextForActivity<span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
        Activity activity <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ClassLoader</span> cl <span style="color:#f92672">=</span> appContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span>
            activity <span style="color:#f92672">=</span> mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">newActivity</span><span style="color:#f92672">(</span>
                    cl<span style="color:#f92672">,</span> component<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassName</span><span style="color:#f92672">(),</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">);</span>
            StrictMode<span style="color:#f92672">.</span><span style="color:#a6e22e">incrementExpectedActivityCount</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">());</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setExtrasClassLoader</span><span style="color:#f92672">(</span>cl<span style="color:#f92672">);</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">prepareToEnterProcess</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setClassLoader</span><span style="color:#f92672">(</span>cl<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">onException</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> e<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
                    <span style="color:#e6db74">&#34;Unable to instantiate activity &#34;</span> <span style="color:#f92672">+</span> component
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            Application app <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">loadedApk</span><span style="color:#f92672">.</span><span style="color:#a6e22e">makeApplication</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> mInstrumentation<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Performing launch of &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
                    TAG<span style="color:#f92672">,</span> r <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: app=&#34;</span> <span style="color:#f92672">+</span> app
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, appName=&#34;</span> <span style="color:#f92672">+</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageName</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, pkg=&#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">loadedApk</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageName</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, comp=&#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, dir=&#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">loadedApk</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAppDir</span><span style="color:#f92672">());</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>activity <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                CharSequence title <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadLabel</span><span style="color:#f92672">(</span>appContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getPackageManager</span><span style="color:#f92672">());</span>
                Configuration config <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Configuration<span style="color:#f92672">(</span>mCompatConfiguration<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">overrideConfig</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    config<span style="color:#f92672">.</span><span style="color:#a6e22e">updateFrom</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">overrideConfig</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_CONFIGURATION<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Launching activity &#34;</span>
                        <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; with config &#34;</span> <span style="color:#f92672">+</span> config<span style="color:#f92672">);</span>
                Window window <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingRemoveWindow</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPreserveWindow</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    window <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingRemoveWindow</span><span style="color:#f92672">;</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingRemoveWindow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPendingRemoveWindowManager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                appContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setOuterContext</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">);</span>
                activity<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span>appContext<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> getInstrumentation<span style="color:#f92672">(),</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span><span style="color:#f92672">,</span>
                        r<span style="color:#f92672">.</span><span style="color:#a6e22e">ident</span><span style="color:#f92672">,</span> app<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">,</span> title<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">parent</span><span style="color:#f92672">,</span>
                        r<span style="color:#f92672">.</span><span style="color:#a6e22e">embeddedID</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">lastNonConfigurationInstances</span><span style="color:#f92672">,</span> config<span style="color:#f92672">,</span>
                        r<span style="color:#f92672">.</span><span style="color:#a6e22e">referrer</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">voiceInteractor</span><span style="color:#f92672">,</span> window<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">configCallback</span><span style="color:#f92672">);</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>customIntent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    activity<span style="color:#f92672">.</span><span style="color:#a6e22e">mIntent</span> <span style="color:#f92672">=</span> customIntent<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">lastNonConfigurationInstances</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                checkAndBlockForNetworkAccess<span style="color:#f92672">();</span>
                activity<span style="color:#f92672">.</span><span style="color:#a6e22e">mStartedActivity</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">int</span> theme <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getThemeResource</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>theme <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    activity<span style="color:#f92672">.</span><span style="color:#a6e22e">setTheme</span><span style="color:#f92672">(</span>theme<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>

                activity<span style="color:#f92672">.</span><span style="color:#a6e22e">mCalled</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">isPersistable</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">callActivityOnCreate</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">persistentState</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">callActivityOnCreate</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>activity<span style="color:#f92672">.</span><span style="color:#a6e22e">mCalled</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> SuperNotCalledException<span style="color:#f92672">(</span>
                        <span style="color:#e6db74">&#34;Activity &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span>
                        <span style="color:#e6db74">&#34; did not call through to super.onCreate()&#34;</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span> <span style="color:#f92672">=</span> activity<span style="color:#f92672">;</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">stopped</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    activity<span style="color:#f92672">.</span><span style="color:#a6e22e">performStart</span><span style="color:#f92672">();</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">stopped</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">isPersistable</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">persistentState</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">callActivityOnRestoreInstanceState</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">,</span>
                                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">persistentState</span><span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">callActivityOnRestoreInstanceState</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    activity<span style="color:#f92672">.</span><span style="color:#a6e22e">mCalled</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">isPersistable</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">callActivityOnPostCreate</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">,</span>
                                r<span style="color:#f92672">.</span><span style="color:#a6e22e">persistentState</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">callActivityOnPostCreate</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>activity<span style="color:#f92672">.</span><span style="color:#a6e22e">mCalled</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> SuperNotCalledException<span style="color:#f92672">(</span>
                            <span style="color:#e6db74">&#34;Activity &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span>
                            <span style="color:#e6db74">&#34; did not call through to super.onPostCreate()&#34;</span><span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">paused</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

            mActivities<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span><span style="color:#f92672">,</span> r<span style="color:#f92672">);</span>

        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>SuperNotCalledException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>

        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">onException</span><span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> e<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
                    <span style="color:#e6db74">&#34;Unable to start activity &#34;</span> <span style="color:#f92672">+</span> component
                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> activity<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>要启动的activity对象的创建等过程发生在<code>performLaunchActivity()</code>方法中：</p>
<ol>
<li>创建Context对象</li>
<li>创建Activity对象</li>
<li>创建Application对象</li>
<li>调用<code>Activity.attach()</code>方法，将Activity与Context及Application相关联。此处会创建Window，其实例时一个PhoneWindow对象。</li>
<li>调用Activity的<code>onCreate(), onStart()</code>生命周期回调。</li>
</ol>
<p>Activity.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> ActivityThread aThread<span style="color:#f92672">,</span>
            Instrumentation instr<span style="color:#f92672">,</span> IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> ident<span style="color:#f92672">,</span>
            Application application<span style="color:#f92672">,</span> Intent intent<span style="color:#f92672">,</span> ActivityInfo info<span style="color:#f92672">,</span>
            CharSequence title<span style="color:#f92672">,</span> Activity parent<span style="color:#f92672">,</span> String id<span style="color:#f92672">,</span>
            NonConfigurationInstances lastNonConfigurationInstances<span style="color:#f92672">,</span>
            Configuration config<span style="color:#f92672">,</span> String referrer<span style="color:#f92672">,</span> IVoiceInteractor voiceInteractor<span style="color:#f92672">,</span>
            Window window<span style="color:#f92672">,</span> ActivityConfigCallback activityConfigCallback<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        attachBaseContext<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>

        mFragments<span style="color:#f92672">.</span><span style="color:#a6e22e">attachHost</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#75715e">/*parent*/</span><span style="color:#f92672">);</span>

        mWindow <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PhoneWindow<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> window<span style="color:#f92672">,</span> activityConfigCallback<span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setWindowControllerCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setOnWindowDismissedCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">getLayoutInflater</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setPrivateFactory</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">!=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_STATE_UNSPECIFIED</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setSoftInputMode</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">uiOptions</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setUiOptions</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">uiOptions</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        mUiThread <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">();</span>

        mMainThread <span style="color:#f92672">=</span> aThread<span style="color:#f92672">;</span>
        mInstrumentation <span style="color:#f92672">=</span> instr<span style="color:#f92672">;</span>
        mToken <span style="color:#f92672">=</span> token<span style="color:#f92672">;</span>
        mIdent <span style="color:#f92672">=</span> ident<span style="color:#f92672">;</span>
        mApplication <span style="color:#f92672">=</span> application<span style="color:#f92672">;</span>
        mIntent <span style="color:#f92672">=</span> intent<span style="color:#f92672">;</span>
        mReferrer <span style="color:#f92672">=</span> referrer<span style="color:#f92672">;</span>
        mComponent <span style="color:#f92672">=</span> intent<span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">();</span>
        mActivityInfo <span style="color:#f92672">=</span> info<span style="color:#f92672">;</span>
        mTitle <span style="color:#f92672">=</span> title<span style="color:#f92672">;</span>
        mParent <span style="color:#f92672">=</span> parent<span style="color:#f92672">;</span>
        mEmbeddedID <span style="color:#f92672">=</span> id<span style="color:#f92672">;</span>
        mLastNonConfigurationInstances <span style="color:#f92672">=</span> lastNonConfigurationInstances<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>voiceInteractor <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lastNonConfigurationInstances <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                mVoiceInteractor <span style="color:#f92672">=</span> lastNonConfigurationInstances<span style="color:#f92672">.</span><span style="color:#a6e22e">voiceInteractor</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                mVoiceInteractor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> VoiceInteractor<span style="color:#f92672">(</span>voiceInteractor<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span>
                        Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myLooper</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setWindowManager</span><span style="color:#f92672">(</span>
                <span style="color:#f92672">(</span>WindowManager<span style="color:#f92672">)</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getSystemService</span><span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">WINDOW_SERVICE</span><span style="color:#f92672">),</span>
                mToken<span style="color:#f92672">,</span> mComponent<span style="color:#f92672">.</span><span style="color:#a6e22e">flattenToString</span><span style="color:#f92672">(),</span>
                <span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">flags</span> <span style="color:#f92672">&amp;</span> ActivityInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_HARDWARE_ACCELERATED</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mParent <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">setContainer</span><span style="color:#f92672">(</span>mParent<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindow</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        mWindowManager <span style="color:#f92672">=</span> mWindow<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindowManager</span><span style="color:#f92672">();</span>
        mCurrentConfig <span style="color:#f92672">=</span> config<span style="color:#f92672">;</span>

        mWidow<span style="color:#f92672">.</span><span style="color:#a6e22e">setColorMode</span><span style="color:#f92672">(</span>info<span style="color:#f92672">.</span><span style="color:#a6e22e">colorMode</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>ActivityThread在<code>performLaunchActivity()</code>返回后，接着调用<code>handleResumeActivity()</code>, 这里会先调用<code>performResumeActivity()</code>进行生命周期回调，至此，启动到可见的全部生命周期回调完毕。
ActivityThread.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleResumeActivity</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> clearHide<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> isForward<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> reallyResume<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> seq<span style="color:#f92672">,</span> String reason<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ActivityClientRecord r <span style="color:#f92672">=</span> mActivities<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>checkAndUpdateLifecycleSeq<span style="color:#f92672">(</span>seq<span style="color:#f92672">,</span> r<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;resumeActivity&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If we are getting ready to gc after going to the background, well
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// we are back active so skip it.
</span><span style="color:#75715e"></span>        unscheduleGcIdler<span style="color:#f92672">();</span>
        mSomeActivitiesChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// TODO Push resumeArgs into the activity for consideration
</span><span style="color:#75715e"></span>        r <span style="color:#f92672">=</span> performResumeActivity<span style="color:#f92672">(</span>token<span style="color:#f92672">,</span> clearHide<span style="color:#f92672">,</span> reason<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> Activity a <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
                TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Resume &#34;</span> <span style="color:#f92672">+</span> r <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; started activity: &#34;</span> <span style="color:#f92672">+</span>
                a<span style="color:#f92672">.</span><span style="color:#a6e22e">mStartedActivity</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, hideForNow: &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">hideForNow</span>
                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, finished: &#34;</span> <span style="color:#f92672">+</span> a<span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span><span style="color:#f92672">);</span>

            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> forwardBit <span style="color:#f92672">=</span> isForward <span style="color:#f92672">?</span>
                    WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_IS_FORWARD_NAVIGATION</span> <span style="color:#f92672">:</span> 0<span style="color:#f92672">;</span>

            <span style="color:#75715e">// If the window hasn&#39;t yet been added to the window manager,
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// and this guy didn&#39;t finish itself or start another activity,
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// then go ahead and add the window.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> willBeVisible <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>a<span style="color:#f92672">.</span><span style="color:#a6e22e">mStartedActivity</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>willBeVisible<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    willBeVisible <span style="color:#f92672">=</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">().</span><span style="color:#a6e22e">willActivityBeVisible</span><span style="color:#f92672">(</span>
                            a<span style="color:#f92672">.</span><span style="color:#a6e22e">getActivityToken</span><span style="color:#f92672">());</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>a<span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span> <span style="color:#f92672">&amp;&amp;</span> willBeVisible<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span> <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getWindow</span><span style="color:#f92672">();</span>
                View decor <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDecorView</span><span style="color:#f92672">();</span>
                decor<span style="color:#f92672">.</span><span style="color:#a6e22e">setVisibility</span><span style="color:#f92672">(</span>View<span style="color:#f92672">.</span><span style="color:#a6e22e">INVISIBLE</span><span style="color:#f92672">);</span>
                ViewManager wm <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindowManager</span><span style="color:#f92672">();</span>
                WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> l <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAttributes</span><span style="color:#f92672">();</span>
                a<span style="color:#f92672">.</span><span style="color:#a6e22e">mDecor</span> <span style="color:#f92672">=</span> decor<span style="color:#f92672">;</span>
                l<span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">=</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_BASE_APPLICATION</span><span style="color:#f92672">;</span>
                l<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">|=</span> forwardBit<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPreserveWindow</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    a<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowAdded</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">mPreserveWindow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                    <span style="color:#75715e">// Normally the ViewRoot sets up callbacks with the Activity
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// in addView-&gt;ViewRootImpl#setView. If we are instead reusing
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// the decor view we have to notify the view root that the
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// callbacks may have changed.
</span><span style="color:#75715e"></span>                    ViewRootImpl impl <span style="color:#f92672">=</span> decor<span style="color:#f92672">.</span><span style="color:#a6e22e">getViewRootImpl</span><span style="color:#f92672">();</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>impl <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        impl<span style="color:#f92672">.</span><span style="color:#a6e22e">notifyChildRebuilt</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>a<span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleFromClient</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>a<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowAdded</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        a<span style="color:#f92672">.</span><span style="color:#a6e22e">mWindowAdded</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                        wm<span style="color:#f92672">.</span><span style="color:#a6e22e">addView</span><span style="color:#f92672">(</span>decor<span style="color:#f92672">,</span> l<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// The activity will get a callback for this {@link LayoutParams} change
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// earlier. However, at that time the decor will not be set (this is set
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// in this method), so no action will be taken. This call ensures the
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// callback occurs with the decor set.
</span><span style="color:#75715e"></span>                        a<span style="color:#f92672">.</span><span style="color:#a6e22e">onWindowAttributesChanged</span><span style="color:#f92672">(</span>l<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

            <span style="color:#75715e">// If the window has already been added, but during resume
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// we started another activity, then don&#39;t yet make the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// window visible.
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>willBeVisible<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
                    TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Launch &#34;</span> <span style="color:#f92672">+</span> r <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; mStartedActivity set&#34;</span><span style="color:#f92672">);</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">hideForNow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Get rid of anything left hanging around.
</span><span style="color:#75715e"></span>            cleanUpPendingRemoveWindows<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">/* force */</span><span style="color:#f92672">);</span>

            <span style="color:#75715e">// The window is now visible if it has been added, we are not
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// simply finishing, and we are not starting another activity.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span> <span style="color:#f92672">&amp;&amp;</span> willBeVisible
                    <span style="color:#f92672">&amp;&amp;</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mDecor</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">hideForNow</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">newConfig</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    performConfigurationChangedForActivity<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">newConfig</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_CONFIGURATION<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Resuming activity &#34;</span>
                            <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; with newConfig &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mCurrentConfig</span><span style="color:#f92672">);</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">newConfig</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Resuming &#34;</span> <span style="color:#f92672">+</span> r <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; with isForward=&#34;</span>
                        <span style="color:#f92672">+</span> isForward<span style="color:#f92672">);</span>
                WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> l <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAttributes</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>l<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span>
                        <span style="color:#f92672">&amp;</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span style="color:#f92672">)</span>
                        <span style="color:#f92672">!=</span> forwardBit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    l<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>l<span style="color:#f92672">.</span><span style="color:#a6e22e">softInputMode</span>
                            <span style="color:#f92672">&amp;</span> <span style="color:#f92672">(~</span>WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span style="color:#f92672">))</span>
                            <span style="color:#f92672">|</span> forwardBit<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleFromClient</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        ViewManager wm <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span><span style="color:#a6e22e">getWindowManager</span><span style="color:#f92672">();</span>
                        View decor <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">window</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDecorView</span><span style="color:#f92672">();</span>
                        wm<span style="color:#f92672">.</span><span style="color:#a6e22e">updateViewLayout</span><span style="color:#f92672">(</span>decor<span style="color:#f92672">,</span> l<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

                r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleFromServer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                mNumVisibleActivities<span style="color:#f92672">++;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mVisibleFromClient</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">makeVisible</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">onlyLocalRequest</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">nextIdle</span> <span style="color:#f92672">=</span> mNewActivities<span style="color:#f92672">;</span>
                mNewActivities <span style="color:#f92672">=</span> r<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>
                    TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Scheduling idle handler for &#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">);</span>
                Looper<span style="color:#f92672">.</span><span style="color:#a6e22e">myQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">addIdleHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Idler<span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">onlyLocalRequest</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// Tell the activity manager we have resumed.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>reallyResume<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">().</span><span style="color:#a6e22e">activityResumed</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">throw</span> ex<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If an exception was thrown when trying to resume, then
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// just end this activity.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">finishActivity</span><span style="color:#f92672">(</span>token<span style="color:#f92672">,</span> Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">RESULT_CANCELED</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                            Activity<span style="color:#f92672">.</span><span style="color:#a6e22e">DONT_FINISH_TASK_WITH_ACTIVITY</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> ex<span style="color:#f92672">.</span><span style="color:#a6e22e">rethrowFromSystemServer</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> ActivityClientRecord <span style="color:#a6e22e">performResumeActivity</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> clearHide<span style="color:#f92672">,</span> String reason<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ActivityClientRecord r <span style="color:#f92672">=</span> mActivities<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localLOGV<span style="color:#f92672">)</span> Slog<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Performing resume of &#34;</span> <span style="color:#f92672">+</span> r
                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; finished=&#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFinished</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>clearHide<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">hideForNow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mStartedActivity</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onStateNotSaved</span><span style="color:#f92672">();</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFragments</span><span style="color:#f92672">.</span><span style="color:#a6e22e">noteStateNotSaved</span><span style="color:#f92672">();</span>
                checkAndBlockForNetworkAccess<span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingIntents</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    deliverNewIntents<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingIntents</span><span style="color:#f92672">);</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingIntents</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingResults</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    deliverResults<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingResults</span><span style="color:#f92672">);</span>
                    r<span style="color:#f92672">.</span><span style="color:#a6e22e">pendingResults</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">performResume</span><span style="color:#f92672">();</span>

                <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mResourcesManager<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// If there is a pending local relaunch that was requested when the activity was
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// paused, it will put the activity into paused state when it finally happens.
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// Since the activity resumed before being relaunched, we don&#39;t want that to
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// happen, so we need to clear the request to relaunch paused.
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> mRelaunchingActivities<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span> i <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">;</span> i<span style="color:#f92672">--)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">final</span> ActivityClientRecord relaunching <span style="color:#f92672">=</span> mRelaunchingActivities<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>relaunching<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">==</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">token</span>
                                <span style="color:#f92672">&amp;&amp;</span> relaunching<span style="color:#f92672">.</span><span style="color:#a6e22e">onlyLocalRequest</span> <span style="color:#f92672">&amp;&amp;</span> relaunching<span style="color:#f92672">.</span><span style="color:#a6e22e">startsNotResumed</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            relaunching<span style="color:#f92672">.</span><span style="color:#a6e22e">startsNotResumed</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

                EventLog<span style="color:#f92672">.</span><span style="color:#a6e22e">writeEvent</span><span style="color:#f92672">(</span>LOG_AM_ON_RESUME_CALLED<span style="color:#f92672">,</span> UserHandle<span style="color:#f92672">.</span><span style="color:#a6e22e">myUserId</span><span style="color:#f92672">(),</span>
                        r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponentName</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getClassName</span><span style="color:#f92672">(),</span> reason<span style="color:#f92672">);</span>

                r<span style="color:#f92672">.</span><span style="color:#a6e22e">paused</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">stopped</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                r<span style="color:#f92672">.</span><span style="color:#a6e22e">persistentState</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">onException</span><span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">,</span> e<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>
                        <span style="color:#e6db74">&#34;Unable to resume activity &#34;</span>
                        <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getComponent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toShortString</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> r<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div>
                </div>
                
            </article>
        </div>
    </div>

                </div>
                <footer>
    Powered by <a target="_blank" href="https://gohugo.io/">Hugo</a> And 
    <a target="_blank" href="https://pages.github.com/">Github Pages</a>
</footer>
                <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
                

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>

                <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.12.0/styles/default.min.css">
                <script src="/js/highlight.pack.js"></script>
                <script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
                <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [
                ['$', '$'],
                ['\\(', '\\)']
            ],
            displayMath: [
                ['$$', '$$']
            ],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });
    MathJax.Hub.Queue(function () {



        var all = MathJax.Hub.getAllJax(),
            i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

    MathJax.Hub.Config({

        TeX: {
            equationNumbers: {
                autoNumber: "AMS"
            }
        }
    });
</script>
                <script type="text/javascript" src="/js/main.js"></script>
        </div>
    </body>

</html>