<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Android View事件处理机制与分发流程 | 
    风格与布局
  
</title><meta name="description" content="Android移动应用开发"><meta name="author" content="jastrelax">

<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png " sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0c344b">
<link rel="icon" href="/favicon.ico">




    
        
            <link rel="stylesheet" href="/dist/main.37ab3f61b95417873748.min.css">
        
    




<link rel="canonical" href="https://www.androidpi.com/android/framework/2018-03-11-android-view-event-dispatching/"><meta property="og:title" content="Android View事件处理机制与分发流程" />
<meta property="og:description" content="View类还包含一系列嵌套接口以及您可以更加轻松定义的回调。 这些接口称为事件侦听器，是您捕获用户与UI之间交互的票证。 尽管您通常会使用事件侦" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.androidpi.com/android/framework/2018-03-11-android-view-event-dispatching/" />
<meta property="article:published_time" content="2018-03-11T16:00:39+08:00" />
<meta property="article:modified_time" content="2018-03-11T16:00:39+08:00" />
<meta itemprop="name" content="Android View事件处理机制与分发流程">
<meta itemprop="description" content="View类还包含一系列嵌套接口以及您可以更加轻松定义的回调。 这些接口称为事件侦听器，是您捕获用户与UI之间交互的票证。 尽管您通常会使用事件侦">
<meta itemprop="datePublished" content="2018-03-11T16:00:39&#43;08:00" />
<meta itemprop="dateModified" content="2018-03-11T16:00:39&#43;08:00" />
<meta itemprop="wordCount" content="3491">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android View事件处理机制与分发流程"/>
<meta name="twitter:description" content="View类还包含一系列嵌套接口以及您可以更加轻松定义的回调。 这些接口称为事件侦听器，是您捕获用户与UI之间交互的票证。 尽管您通常会使用事件侦"/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand font-weight-bold" href="https://www.androidpi.com/">风格与布局</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="main-menu">
            <ul class="navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/android/">Android</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/blockchain/">Blockchain</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/book/">Books</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/cs/">CS</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/ee/">EE</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/java/">Java</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/puzzles/">Puzzles</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/web/">Web</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/backend/">后端</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/engineering/">工程与架构</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/dev/">开发</a></li>
                
            
            </ul>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    <div class="row">
        <div class="col">
            <article>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="mb-3">Android View事件处理机制与分发流程</h2>

                        <div class="content">
                            <p>View类还包含一系列嵌套接口以及您可以更加轻松定义的回调。 这些接口称为事件侦听器，是您捕获用户与UI之间交互的票证。</p>
<p>尽管您通常会使用事件侦听器来侦听用户交互，但有时您确实需要扩展View类以构建自定义组件。也许，您想扩展 Button类来丰富某些内容的样式。 在这种情况下，您将能够使用该类的事件处理程序为类定义默认事件行为。</p>
<h2 id="api">API</h2>
<h3 id="事件侦听器event-listeners">事件侦听器（Event Listeners）</h3>
<p>事件侦听器是View类中包含一个回调方法的接口。 当用户与UI项目之间的交互触发已注册此视图的侦听器时，Android框架将调用这些方法。</p>
<p>各事件侦听器接口包含的回调方法如下：</p>
<ul>
<li>
<p>onClick()</p>
<p>在 View.OnClickListener 中。 当用户触摸项目（处于触摸模式下）时，或者使用导航键或轨迹球聚焦于项目，然后按适用的“Enter”键或按下轨迹球时，将调用此方法。</p>
</li>
<li>
<p>onLongClick()</p>
<p>在 View.OnLongClickListener 中。 当用户触摸并按住项目（处于触摸模式下）时，或者使用导航键或轨迹球聚焦于项目，然后按住适用的“Enter”键或按住轨迹球（持续一秒钟）时，将调用此方法。</p>
</li>
<li>
<p>onFocusChange()</p>
<p>在 View.OnFocusChangeListener 中。 当用户使用导航键或轨迹球导航到或远离项目时，将调用此方法。
onKey()
在 View.OnKeyListener 中。 当用户聚焦于项目并按下或释放设备上的硬按键时，将调用此方法。</p>
</li>
<li>
<p>onTouch()</p>
<p>在 View.OnTouchListener 中。 当用户执行可视为触摸事件的操作时，其中包括按下、释放或屏幕上的任何移动手势（在项目边界内），将调用此方法。</p>
</li>
<li>
<p>onCreateContextMenu()</p>
<p>在 View.OnCreateContextMenuListener 中。 当（因持续“长按”而）生成上下文菜单时，将调用此方法。请参见菜单开发者指南中有关上下文菜单的阐述。
这些方法是其相应接口的唯一成员。</p>
</li>
</ul>
<p>请注意，上述示例中的 onClick() 回调没有返回值，但是其他某些事件侦听器方法必须返回布尔值。具体原因取决于事件。 对于这几个事件侦听器，必须返回布尔值的原因如下：</p>
<ul>
<li>onLongClick()：此方法返回一个布尔值，表示您是否已处理完事件，以及是否应该将它继续传下去。 也就是说，返回 true 表示您已经处理事件且事件应就此停止；如果您尚未处理事件和/或事件应该继续传递给其他任何点击侦听器，则返回 false。</li>
<li>onKey()：此方法返回一个布尔值，表示您是否已处理完事件，以及是否应该将它继续传下去。 也就是说，返回 true 表示您已经处理事件且事件应就此停止；如果您尚未处理事件和/或事件应该继续传递给其他任何按键侦听器，则返回 false。</li>
<li>onTouch()： 此方法返回一个布尔值，表示侦听器是否处理完此事件。重要的是，此事件可以拥有多个分先后顺序的操作。 因此，如果在收到关闭操作事件时返回 false，则表示您并未处理完此事件，而且对其后续操作也不感兴趣。 因此，您无需执行事件内的任何其他操作，如手势或最终操作事件。</li>
</ul>
<h3 id="事件处理程序event-handlers">事件处理程序(Event Handlers)</h3>
<p>如果您从视图构建自定义组件，则将能够定义几种用作默认事件处理程序的回调方法。在有关自定义组件的文档中，您将了解某些用于事件处理的常见回调，其中包括：</p>
<ul>
<li>onKeyDown(int, KeyEvent)：在发生新的按键事件时调用</li>
<li>onKeyUp(int, KeyEvent)：在发生按键弹起事件时调用</li>
<li>onTrackballEvent(MotionEvent)：在发生轨迹球运动事件时调用</li>
<li>onTouchEvent(MotionEvent)：在发生触摸屏运动事件时调用</li>
<li>onFocusChanged(boolean, int, Rect)：在视图获得或失去焦点时调用</li>
</ul>
<p>还有一些其他方法值得您注意，尽管它们并非 View 类的一部分，但可能会直接影响所能采取的事件处理方式。 因此，在管理布局内更复杂的事件时，请考虑使用以下其他方法：</p>
<ul>
<li>Activity.dispatchTouchEvent(MotionEvent)：此方法允许 Activity 在分派给窗口之前截获所有触摸事件。</li>
<li>ViewGroup.onInterceptTouchEvent(MotionEvent)：此方法允许 ViewGroup 监视分派给子视图的事件。</li>
<li>ViewParent.requestDisallowInterceptTouchEvent(boolean)： 对父视图调用此方法表明不应使用 onInterceptTouchEvent(MotionEvent) 截获触摸事件。</li>
</ul>
<h2 id="事件分发流程">事件分发流程</h2>
<p>将一个动作(鼠标、手写笔、触摸、轨迹球)事件MotionEvent进行分发过程，目的是将产生的动作事件分发给特定的对象进行消费。分发的层级由上至下从Activity到Window再到View。</p>
<p>这里的事件分发指各个组件的<code>dispatchTouchEvent(MotionEvent ev)</code>方法:</p>
<ul>
<li>
<p>首先事件从Activity开始分发，首先它让Window进行事件分发，如果事件未被消费，则直接由Activity的onTouchEvent()消费。</p>
</li>
<li>
<p>Window事件分发，Window的实现类为PhoneWindow，PhoneWindow将事件直接传递给顶级DecorView进行分发。</p>
</li>
<li>
<p>View事件分发</p>
<ul>
<li>
<p>ViewGroup事件分发</p>
<ul>
<li>不拦截事件，事件将沿着View层次嵌套结构继续向下分发，直到事件被消费。如果向下分发过程中事件未被消费，则事件将沿着原来的传递路径向上传递，直到事件被消费。</li>
<li>事件被拦截，将由拦截事件的ViewGroup来消费事件，如果未消费将事件向上传递，直到被消费。</li>
</ul>
<p>这里需要注意的是，对于每次接收到ACTION_DOWN事件，mFirstTouchTarget会置为空，FLAG_DISALLOW_INTERCEPT标志位被重置，ViewGroup总是调用onInterceptTouchEvent()来判断是否进行拦截。因此如果ACTION_DOWN被拦截，那么后续其它事件都由它自身来处理。如果ACTION_DOWN未被拦截，那么mFirstTouchTarget不为空，对于后续其它事件，子View通过调用ViewParent的requestDisallowInterceptTouchEvent()方法来控制对onInterceptTouchEvent(）的调用。如果后续某个事件被拦截，子View会接收到ACTION_CANCEL事件，该事件后续事件将由拦截该事件的ViewGroup来消费。如果未拦截，则按照正常分发流程处理。</p>
</li>
<li>
<p>常规View事件分发与消费</p>
<p>如果OnTouchListener不为空并且enabled为true，事件由OnTouchListener消费，否则由onTouchEvent消费。如果OnTouchListener的onTouch方法返回false，事件将也由onTouchEvent消费。</p>
</li>
</ul>
</li>
</ul>
<h2 id="源码分析">源码分析</h2>
<p>ViewGroup.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">dispatchTouchEvent</span><span style="color:#f92672">(</span>MotionEvent ev<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mInputEventConsistencyVerifier <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mInputEventConsistencyVerifier<span style="color:#f92672">.</span><span style="color:#a6e22e">onTouchEvent</span><span style="color:#f92672">(</span>ev<span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// If the event targets the accessibility focused view and this is it, start
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// normal event dispatch. Maybe a descendant is what will handle the click.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ev<span style="color:#f92672">.</span><span style="color:#a6e22e">isTargetAccessibilityFocus</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> isAccessibilityFocusedViewOrHost<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            ev<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetAccessibilityFocus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">boolean</span> handled <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>onFilterTouchEventForSecurity<span style="color:#f92672">(</span>ev<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> action <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getAction</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> actionMasked <span style="color:#f92672">=</span> action <span style="color:#f92672">&amp;</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_MASK</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// Handle an initial down.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_DOWN</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Throw away all previous state when starting a new touch gesture.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// The framework may have dropped the up or cancel event for the previous gesture
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// due to an app switch, ANR, or some other state change.
</span><span style="color:#75715e"></span>                cancelAndClearTouchTargets<span style="color:#f92672">(</span>ev<span style="color:#f92672">);</span>
                resetTouchState<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Check for interception.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> intercepted<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_DOWN</span>
                    <span style="color:#f92672">||</span> mFirstTouchTarget <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> disallowIntercept <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>mGroupFlags <span style="color:#f92672">&amp;</span> FLAG_DISALLOW_INTERCEPT<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>disallowIntercept<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    intercepted <span style="color:#f92672">=</span> onInterceptTouchEvent<span style="color:#f92672">(</span>ev<span style="color:#f92672">);</span>
                    ev<span style="color:#f92672">.</span><span style="color:#a6e22e">setAction</span><span style="color:#f92672">(</span>action<span style="color:#f92672">);</span> <span style="color:#75715e">// restore action in case it was changed
</span><span style="color:#75715e"></span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    intercepted <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// There are no touch targets and this action is not an initial down
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// so this view group continues to intercept touches.
</span><span style="color:#75715e"></span>                intercepted <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// If intercepted, start normal event dispatch. Also if there is already
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// a view that is handling the gesture, do normal event dispatch.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>intercepted <span style="color:#f92672">||</span> mFirstTouchTarget <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                ev<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetAccessibilityFocus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Check for cancelation.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> canceled <span style="color:#f92672">=</span> resetCancelNextUpFlag<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span>
                    <span style="color:#f92672">||</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_CANCEL</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// Update list of touch targets for pointer down, if needed.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> split <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>mGroupFlags <span style="color:#f92672">&amp;</span> FLAG_SPLIT_MOTION_EVENTS<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">;</span>
            TouchTarget newTouchTarget <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">boolean</span> alreadyDispatchedToNewTouchTarget <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>canceled <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>intercepted<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

                <span style="color:#75715e">// If the event is targeting accessiiblity focus we give it to the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// view that has accessibility focus and if it does not handle it
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// we clear the flag and dispatch the event to all children as usual.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// We are looking up the accessibility focused host to avoid keeping
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// state since these events are very rare.
</span><span style="color:#75715e"></span>                View childWithAccessibilityFocus <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">isTargetAccessibilityFocus</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">?</span> findChildWithAccessibilityFocus<span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_DOWN</span>
                        <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>split <span style="color:#f92672">&amp;&amp;</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_POINTER_DOWN</span><span style="color:#f92672">)</span>
                        <span style="color:#f92672">||</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_HOVER_MOVE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> actionIndex <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getActionIndex</span><span style="color:#f92672">();</span> <span style="color:#75715e">// always 0 for down
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> idBitsToAssign <span style="color:#f92672">=</span> split <span style="color:#f92672">?</span> 1 <span style="color:#f92672">&lt;&lt;</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getPointerId</span><span style="color:#f92672">(</span>actionIndex<span style="color:#f92672">)</span>
                            <span style="color:#f92672">:</span> TouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">ALL_POINTER_IDS</span><span style="color:#f92672">;</span>

                    <span style="color:#75715e">// Clean up earlier touch targets for this pointer id in case they
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// have become out of sync.
</span><span style="color:#75715e"></span>                    removePointersFromTouchTargets<span style="color:#f92672">(</span>idBitsToAssign<span style="color:#f92672">);</span>

                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> childrenCount <span style="color:#f92672">=</span> mChildrenCount<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>newTouchTarget <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> childrenCount <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">float</span> x <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getX</span><span style="color:#f92672">(</span>actionIndex<span style="color:#f92672">);</span>
                        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">float</span> y <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getY</span><span style="color:#f92672">(</span>actionIndex<span style="color:#f92672">);</span>
                        <span style="color:#75715e">// Find a child that can receive the event.
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// Scan children from front to back.
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">final</span> ArrayList<span style="color:#f92672">&lt;</span>View<span style="color:#f92672">&gt;</span> preorderedList <span style="color:#f92672">=</span> buildTouchDispatchChildList<span style="color:#f92672">();</span>
                        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> customOrder <span style="color:#f92672">=</span> preorderedList <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>
                                <span style="color:#f92672">&amp;&amp;</span> isChildrenDrawingOrderEnabled<span style="color:#f92672">();</span>
                        <span style="color:#66d9ef">final</span> View<span style="color:#f92672">[]</span> children <span style="color:#f92672">=</span> mChildren<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> childrenCount <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span> i <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">;</span> i<span style="color:#f92672">--)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> childIndex <span style="color:#f92672">=</span> getAndVerifyPreorderedIndex<span style="color:#f92672">(</span>
                                    childrenCount<span style="color:#f92672">,</span> i<span style="color:#f92672">,</span> customOrder<span style="color:#f92672">);</span>
                            <span style="color:#66d9ef">final</span> View child <span style="color:#f92672">=</span> getAndVerifyPreorderedView<span style="color:#f92672">(</span>
                                    preorderedList<span style="color:#f92672">,</span> children<span style="color:#f92672">,</span> childIndex<span style="color:#f92672">);</span>

                            <span style="color:#75715e">// If there is a view that has accessibility focus we want it
</span><span style="color:#75715e"></span>                            <span style="color:#75715e">// to get the event first and if not handled we will perform a
</span><span style="color:#75715e"></span>                            <span style="color:#75715e">// normal dispatch. We may do a double iteration but this is
</span><span style="color:#75715e"></span>                            <span style="color:#75715e">// safer given the timeframe.
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childWithAccessibilityFocus <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>childWithAccessibilityFocus <span style="color:#f92672">!=</span> child<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                    <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
                                <span style="color:#f92672">}</span>
                                childWithAccessibilityFocus <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                                i <span style="color:#f92672">=</span> childrenCount <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>

                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>canViewReceivePointerEvents<span style="color:#f92672">(</span>child<span style="color:#f92672">)</span>
                                    <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>isTransformedTouchPointInView<span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> y<span style="color:#f92672">,</span> child<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                                ev<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetAccessibilityFocus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>

                            newTouchTarget <span style="color:#f92672">=</span> getTouchTarget<span style="color:#f92672">(</span>child<span style="color:#f92672">);</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>newTouchTarget <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                <span style="color:#75715e">// Child is already receiving touch within its bounds.
</span><span style="color:#75715e"></span>                                <span style="color:#75715e">// Give it the new pointer in addition to the ones it is handling.
</span><span style="color:#75715e"></span>                                newTouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">pointerIdBits</span> <span style="color:#f92672">|=</span> idBitsToAssign<span style="color:#f92672">;</span>
                                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>

                            resetCancelNextUpFlag<span style="color:#f92672">(</span>child<span style="color:#f92672">);</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dispatchTransformedTouchEvent<span style="color:#f92672">(</span>ev<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> child<span style="color:#f92672">,</span> idBitsToAssign<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                                <span style="color:#75715e">// Child wants to receive touch within its bounds.
</span><span style="color:#75715e"></span>                                mLastTouchDownTime <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getDownTime</span><span style="color:#f92672">();</span>
                                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preorderedList <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                    <span style="color:#75715e">// childIndex points into presorted list, find original index
</span><span style="color:#75715e"></span>                                    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> j <span style="color:#f92672">&lt;</span> childrenCount<span style="color:#f92672">;</span> j<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>children<span style="color:#f92672">[</span>childIndex<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> mChildren<span style="color:#f92672">[</span>j<span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
                                            mLastTouchDownIndex <span style="color:#f92672">=</span> j<span style="color:#f92672">;</span>
                                            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                                        <span style="color:#f92672">}</span>
                                    <span style="color:#f92672">}</span>
                                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                                    mLastTouchDownIndex <span style="color:#f92672">=</span> childIndex<span style="color:#f92672">;</span>
                                <span style="color:#f92672">}</span>
                                mLastTouchDownX <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getX</span><span style="color:#f92672">();</span>
                                mLastTouchDownY <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getY</span><span style="color:#f92672">();</span>
                                newTouchTarget <span style="color:#f92672">=</span> addTouchTarget<span style="color:#f92672">(</span>child<span style="color:#f92672">,</span> idBitsToAssign<span style="color:#f92672">);</span>
                                alreadyDispatchedToNewTouchTarget <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>

                            <span style="color:#75715e">// The accessibility focus didn&#39;t handle the event, so clear
</span><span style="color:#75715e"></span>                            <span style="color:#75715e">// the flag and do a normal dispatch to all children.
</span><span style="color:#75715e"></span>                            ev<span style="color:#f92672">.</span><span style="color:#a6e22e">setTargetAccessibilityFocus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preorderedList <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> preorderedList<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>

                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>newTouchTarget <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mFirstTouchTarget <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// Did not find a child to receive the event.
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// Assign the pointer to the least recently added target.
</span><span style="color:#75715e"></span>                        newTouchTarget <span style="color:#f92672">=</span> mFirstTouchTarget<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>newTouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            newTouchTarget <span style="color:#f92672">=</span> newTouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                        newTouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">pointerIdBits</span> <span style="color:#f92672">|=</span> idBitsToAssign<span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Dispatch to touch targets.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mFirstTouchTarget <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// No touch targets so treat this as an ordinary view.
</span><span style="color:#75715e"></span>                handled <span style="color:#f92672">=</span> dispatchTransformedTouchEvent<span style="color:#f92672">(</span>ev<span style="color:#f92672">,</span> canceled<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                        TouchTarget<span style="color:#f92672">.</span><span style="color:#a6e22e">ALL_POINTER_IDS</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Dispatch to touch targets, excluding the new touch target if we already
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// dispatched to it.  Cancel touch targets if necessary.
</span><span style="color:#75715e"></span>                TouchTarget predecessor <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                TouchTarget target <span style="color:#f92672">=</span> mFirstTouchTarget<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>target <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">final</span> TouchTarget next <span style="color:#f92672">=</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>alreadyDispatchedToNewTouchTarget <span style="color:#f92672">&amp;&amp;</span> target <span style="color:#f92672">==</span> newTouchTarget<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        handled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> cancelChild <span style="color:#f92672">=</span> resetCancelNextUpFlag<span style="color:#f92672">(</span>target<span style="color:#f92672">.</span><span style="color:#a6e22e">child</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">||</span> intercepted<span style="color:#f92672">;</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dispatchTransformedTouchEvent<span style="color:#f92672">(</span>ev<span style="color:#f92672">,</span> cancelChild<span style="color:#f92672">,</span>
                                target<span style="color:#f92672">.</span><span style="color:#a6e22e">child</span><span style="color:#f92672">,</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">pointerIdBits</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                            handled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cancelChild<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>predecessor <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                mFirstTouchTarget <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                                predecessor<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
                            <span style="color:#f92672">}</span>
                            target<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
                            target <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
                            <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                    predecessor <span style="color:#f92672">=</span> target<span style="color:#f92672">;</span>
                    target <span style="color:#f92672">=</span> next<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// Update list of touch targets for pointer up or cancel, if needed.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>canceled
                    <span style="color:#f92672">||</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_UP</span>
                    <span style="color:#f92672">||</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_HOVER_MOVE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                resetTouchState<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>split <span style="color:#f92672">&amp;&amp;</span> actionMasked <span style="color:#f92672">==</span> MotionEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_POINTER_UP</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> actionIndex <span style="color:#f92672">=</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getActionIndex</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> idBitsToRemove <span style="color:#f92672">=</span> 1 <span style="color:#f92672">&lt;&lt;</span> ev<span style="color:#f92672">.</span><span style="color:#a6e22e">getPointerId</span><span style="color:#f92672">(</span>actionIndex<span style="color:#f92672">);</span>
                removePointersFromTouchTargets<span style="color:#f92672">(</span>idBitsToRemove<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>handled <span style="color:#f92672">&amp;&amp;</span> mInputEventConsistencyVerifier <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mInputEventConsistencyVerifier<span style="color:#f92672">.</span><span style="color:#a6e22e">onUnhandledEvent</span><span style="color:#f92672">(</span>ev<span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> handled<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </div>
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    
                </ul>

                <p class="text-muted">
                    
                        Copyright &copy; 风格与布局 2020
                    
                </p>

                <p class="text-muted">
                Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with <a href="https://github.com/puresyntax71/hugo-theme-chunky-poster" target="_blank">Chunky Poster</a>.
                </p>

                <p class="text-muted">
                    <a href="http://beian.miit.gov.cn" target="_blank">蜀ICP备18005659号-1</a>
                </p>
            
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.d608eadfe5ac0688902e.min.js"></script>
        
    








    
</body>
</html>
