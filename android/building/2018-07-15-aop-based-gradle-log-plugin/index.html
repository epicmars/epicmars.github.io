<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" >
        <meta lang="zh">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Android应用构建：基于AOP的Gradle日志插件开发 | 风格与布局</title>
<meta name="description" content="什么是AOP 在OOP的程序结构中，不同的类型可以对现实或虚拟的事物及其行为进行建模，不同类型的对象之间相互协作，完成所需的工作。也就是说OO">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/solid.css" integrity="sha384-TbilV5Lbhlwdyc4RuIV/JhD8NR+BfMrvz4BL5QFa2we1hQu6wvREr3v6XSRfCTRp" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/brands.css" integrity="sha384-7xAnn7Zm3QC1jFjVc1A6v/toepoG3JXboQYzbM0jrPzou9OFXm/fY6Z/XiIebl/k" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/fontawesome.css" integrity="sha384-ozJwkrqb90Oa3ZNb+yKFW2lToAWYdTiF1vt8JiH5ptTGHTGcN7qdoR1F95e0kYyG" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
        
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="/css/article.css" />

    </head>

    <body>
        <div class="site-wrapper">
                <header>
    <nav>
        <a class="home" href="https://www.androidpi.com/">首页</a>
    </nav>
    
</header>
                <div class="site-main">
                    
    <div class="main">
        <div class="article">
            <aside>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#什么是aop">什么是AOP</a></li>
    <li><a href="#基于aop的日志插件">基于AOP的日志插件</a></li>
    <li><a href="#android-gradle-api">Android Gradle API</a>
      <ul>
        <li><a href="#转换范围">转换范围</a></li>
        <li><a href="#转换内容">转换内容</a></li>
        <li><a href="#源码分析">源码分析</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
            </aside>
            <article>
                <div class="title">
                    <h1 id="title">Android应用构建：基于AOP的Gradle日志插件开发</h1>
                </div>
                <div class="content">
                        <h2 id="什么是aop">什么是AOP</h2>
<p>在OOP的程序结构中，不同的类型可以对现实或虚拟的事物及其行为进行建模，不同类型的对象之间相互协作，完成所需的工作。也就是说OOP的程序结构中的基本单位是类，它的通过其封装、继承、多态的机制提供了构造复杂软件的基石。随着OOP的不断发展，我们常常会有另一种需求，即一种超越类型系统的，让不同的类和对象具有我们所需要的状态和行为的能力。例如，我们常常可以使用流程图来表示所做工作的流程路线，尽管存在各种可能的分支和环路，我们总可以将这些工作拆分成一条条逻辑流。对此我们可以不关心OOP模型中的类型，而仅对这些逻辑流进行<strong>横切</strong>，然后在<strong>切面</strong>上进行编程，这便是AOP所提供的另一种模块化概念，它的基本单位是切面。AOP的概念是对OOP的一种补充，使其更加强大。</p>
<h2 id="基于aop的日志插件">基于AOP的日志插件</h2>
<p>根据AOP所提供的能力，当我们需要在特定位置或者逻辑流中实现日志记录的功能时，由于需要记录日志的地方可能遍布整个项目中不同类型对象的不同地方，根据我们实际的业务需要，这些日志记录点仍然具有某些共同之处，这也就是我们要寻找或指定的切面，例如控件的点击事件、HTTP请求等，因此基于AOP的编程十分适用于这种无关具体类型的事务。</p>
<p>在Android开发中，有时需要记录用户在界面中的点击事件，我们便从实现这样的一个AOP日志插件开始。</p>
<p>Java中AOP的实现方式有如下<a href="https://www.ibm.com/developerworks/cn/java/j-lo-asm30/index.html">若干种方式</a>：</p>
<table>
<thead>
<tr>
<th>AOP 底层技术</th>
<th>功能</th>
<th>性能</th>
<th>面向接口编程</th>
<th>编程难度</th>
</tr>
</thead>
<tbody>
<tr>
<td>直接改写 class 文件</td>
<td>完全控制类</td>
<td>无明显性能代价</td>
<td>不要求</td>
<td>高，要求对 class 文件结构和 Java 字节码有深刻了解</td>
</tr>
<tr>
<td>JDK Instrument</td>
<td>完全控制类</td>
<td>无论是否改写，每个类装入时都要执行 hook 程序</td>
<td>不要求</td>
<td>高，要求对 class 文件结构和 Java 字节码有深刻了解</td>
</tr>
<tr>
<td>JDK Proxy</td>
<td>只能改写 method</td>
<td>反射引入性能代价</td>
<td>要求</td>
<td>低</td>
</tr>
<tr>
<td>ASM</td>
<td>几乎能完全控制类</td>
<td>无明显性能代价</td>
<td>不要求</td>
<td>中，能操纵需要改写部分的 Java 字节码</td>
</tr>
<tr>
<td>AspectJ</td>
<td>在切入点控制类</td>
<td>无明显性能代价</td>
<td>不要求</td>
<td>低，熟悉AspectJ的API即可</td>
</tr>
</tbody>
</table>
<h2 id="android-gradle-api">Android Gradle API</h2>
<p>Android Gradle API提供了用于Hook到构建流程的接口和组件，实际上Android工程中引入的Gradle构建工具也是基于此API进行编写的。该编程接口是基于<code>Transform</code>类的，提供了用于对class文件和应用资源进行处理的接口，处理的步骤位于javac之后，Androis Studio 3.1中默认dex编译器为D8，如果在构建脚本中添加了对Java 8的支持，即加入了desugar的步骤，根据对D8选项的配置，默认<code>Transform</code>所在的步骤为javac和desugar之后，它处理的是与Java 7兼容的字节码文件，如果配置<code>android.enableD8.desugaring = true</code>，那么desugar会集成到D8中，此时，<code>Transform</code>所在步骤在javac之后，desugar之前，直接处理Java 8兼容的字节码文件。</p>
<h3 id="转换范围">转换范围</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">   <span style="color:#75715e">/**
</span><span style="color:#75715e">     * The scope of the content.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;
</span><span style="color:#75715e">     * This indicates what the content represents, so that Transforms can apply to only part(s)
</span><span style="color:#75715e">     * of the classes or resources that the build manipulates.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">enum</span> Scope <span style="color:#66d9ef">implements</span> ScopeType <span style="color:#f92672">{</span>
        <span style="color:#75715e">/** Only the project content（仅项目本身） */</span>
        PROJECT<span style="color:#f92672">(</span>0x01<span style="color:#f92672">),</span>
        <span style="color:#75715e">/** Only the sub-projects（仅子项目）. */</span>
        SUB_PROJECTS<span style="color:#f92672">(</span>0x04<span style="color:#f92672">),</span>
        <span style="color:#75715e">/** Only the external libraries（仅外部依赖，包括本地jar包依赖和远程依赖） */</span>
        EXTERNAL_LIBRARIES<span style="color:#f92672">(</span>0x10<span style="color:#f92672">),</span>
        <span style="color:#75715e">/** Code that is being tested by the current variant, including dependencies （由当前变体进行测试的代码，包括依赖）*/</span>
        TESTED_CODE<span style="color:#f92672">(</span>0x20<span style="color:#f92672">),</span>
        <span style="color:#75715e">/** Local or remote dependencies that are provided-only （仅参与编译的本地或远程依赖）*/</span>
        PROVIDED_ONLY<span style="color:#f92672">(</span>0x40<span style="color:#f92672">),</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</code></pre></div><h3 id="转换内容">转换内容</h3>
<p>默认内容为类和资源：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * The type of of the content.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">enum</span> DefaultContentType <span style="color:#66d9ef">implements</span> ContentType <span style="color:#f92672">{</span>
        <span style="color:#75715e">/**
</span><span style="color:#75715e">         * The content is compiled Java code. This can be in a Jar file or in a folder. If
</span><span style="color:#75715e">         * in a folder, it is expected to in sub-folders matching package names.
</span><span style="color:#75715e">         */</span>
        CLASSES<span style="color:#f92672">(</span>0x01<span style="color:#f92672">),</span>

        <span style="color:#75715e">/** The content is standard Java resources. */</span>
        RESOURCES<span style="color:#f92672">(</span>0x02<span style="color:#f92672">);</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</code></pre></div><h3 id="源码分析">源码分析</h3>
<p><img src="/assets/images/android/build/transform-init.jpg" alt="Transform初始化"></p>
<p>从注册一个<code>Transform</code>开始，这里是一个自定义的插件，它将自定义的<code>AopLoggerTransform</code>注册到<code>AppExtension</code>中，这个<code>AppExtension</code>是通过在Application模块的构建脚本<code>build.gradle</code>应用Android插件（<code>apply plugin: 'com.android.application'</code>）而创建的，对于Library模块(<code>apply plugin: 'com.android.library'</code>)，有一个对应的<code>LibraryExtension</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AopLoggerPlugin</span> <span style="color:#66d9ef">implements</span> Plugin<span style="color:#f92672">&lt;</span>Project<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>Project project<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        project<span style="color:#f92672">.</span><span style="color:#a6e22e">getExtensions</span><span style="color:#f92672">().</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>AopLoggerExtension<span style="color:#f92672">.</span><span style="color:#a6e22e">EXTENSION_LOGGER</span><span style="color:#f92672">,</span> AopLoggerExtension<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        project<span style="color:#f92672">.</span><span style="color:#a6e22e">getExtensions</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getByType</span><span style="color:#f92672">(</span>AppExtension<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">registerTransform</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> AopLoggerTransform<span style="color:#f92672">(</span>project<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseExtension</span> <span style="color:#66d9ef">implements</span> AndroidConfig <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Override</span>
    <span style="color:#a6e22e">@NonNull</span>
    <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>Transform<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getTransforms</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> ImmutableList<span style="color:#f92672">.</span><span style="color:#a6e22e">copyOf</span><span style="color:#f92672">(</span>transforms<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><h4 id="转换流和任务初始化">转换流和任务初始化</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApplicationTaskManager</span> <span style="color:#66d9ef">extends</span> TaskManager <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addCompileTask</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@NonNull</span> VariantScope variantScope<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        JavaCompile javacTask <span style="color:#f92672">=</span> createJavacTask<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">);</span>
        <span style="color:#75715e">// 判断是否支持Java 8并且配置是有效的
</span><span style="color:#75715e"></span>        VariantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">Java8LangSupport</span> java8LangSupport <span style="color:#f92672">=</span> variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getJava8LangSupportType</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>java8LangSupport <span style="color:#f92672">==</span> VariantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">Java8LangSupport</span><span style="color:#f92672">.</span><span style="color:#a6e22e">INVALID</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// 如果仍使用retrolambda进行Java 8的支持会给出一个警告
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Only warn for users of retrolambda
</span><span style="color:#75715e"></span>        String pluginName <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>java8LangSupport <span style="color:#f92672">==</span> VariantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">Java8LangSupport</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RETROLAMBDA</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            pluginName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;me.tatarka.retrolambda&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pluginName <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            String warningMsg <span style="color:#f92672">=</span>
                    String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span>
                            <span style="color:#e6db74">&#34;One of the plugins you are using supports Java 8 &#34;</span>
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;language features. To try the support built into&#34;</span>
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; the Android plugin, remove the following from &#34;</span>
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;your build.gradle:\n&#34;</span>
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;    apply plugin: &#39;%s&#39;\n&#34;</span>
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;To learn more, go to https://d.android.com/r/&#34;</span>
                                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;tools/java-8-support-message.html\n&#34;</span><span style="color:#f92672">,</span>
                            pluginName<span style="color:#f92672">);</span>

            androidBuilder
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">getIssueReporter</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">reportWarning</span><span style="color:#f92672">(</span>EvalIssueReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">Type</span><span style="color:#f92672">.</span><span style="color:#a6e22e">GENERIC</span><span style="color:#f92672">,</span> warningMsg<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// 为javac的输出以及javac前后的字节码hooks创建不同流
</span><span style="color:#75715e"></span>        addJavacClassesStream<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">);</span>
        <span style="color:#75715e">// 将javac任务添加到顶级编译任务的依赖中
</span><span style="color:#75715e"></span>        setJavaCompilerTask<span style="color:#f92672">(</span>javacTask<span style="color:#f92672">,</span> variantScope<span style="color:#f92672">);</span>
        <span style="color:#75715e">// 创建javac编译后的任务
</span><span style="color:#75715e"></span>        createPostCompilationTasks<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

     <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Add stream of classes compiled by javac to transform manager.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * This should not be called for classes that will also be compiled from source by jack.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addJavacClassesStream</span><span style="color:#f92672">(</span>VariantScope scope<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// create separate streams for the output of JAVAC and for the pre/post javac
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// bytecode hooks
</span><span style="color:#75715e"></span>        scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransformManager</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">addStream</span><span style="color:#f92672">(</span>
                        OriginalStream<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">(</span>project<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;javac-output&#34;</span><span style="color:#f92672">)</span>
                                <span style="color:#75715e">// Need both classes and resources because some annotation
</span><span style="color:#75715e"></span>                                <span style="color:#75715e">// processors generate resources
</span><span style="color:#75715e"></span>                                <span style="color:#f92672">.</span><span style="color:#a6e22e">addContentTypes</span><span style="color:#f92672">(</span>
                                        DefaultContentType<span style="color:#f92672">.</span><span style="color:#a6e22e">CLASSES</span><span style="color:#f92672">,</span> DefaultContentType<span style="color:#f92672">.</span><span style="color:#a6e22e">RESOURCES</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">addScope</span><span style="color:#f92672">(</span>Scope<span style="color:#f92672">.</span><span style="color:#a6e22e">PROJECT</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">setFileCollection</span><span style="color:#f92672">(</span>scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getOutput</span><span style="color:#f92672">(</span>JAVAC<span style="color:#f92672">))</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">());</span>

        scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransformManager</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">addStream</span><span style="color:#f92672">(</span>
                        OriginalStream<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">(</span>project<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;pre-javac-generated-bytecode&#34;</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">addContentTypes</span><span style="color:#f92672">(</span>
                                        DefaultContentType<span style="color:#f92672">.</span><span style="color:#a6e22e">CLASSES</span><span style="color:#f92672">,</span> DefaultContentType<span style="color:#f92672">.</span><span style="color:#a6e22e">RESOURCES</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">addScope</span><span style="color:#f92672">(</span>Scope<span style="color:#f92672">.</span><span style="color:#a6e22e">PROJECT</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">setFileCollection</span><span style="color:#f92672">(</span>
                                        scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getVariantData</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAllPreJavacGeneratedBytecode</span><span style="color:#f92672">())</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">());</span>

        scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransformManager</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">addStream</span><span style="color:#f92672">(</span>
                        OriginalStream<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">(</span>project<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;post-javac-generated-bytecode&#34;</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">addContentTypes</span><span style="color:#f92672">(</span>
                                        DefaultContentType<span style="color:#f92672">.</span><span style="color:#a6e22e">CLASSES</span><span style="color:#f92672">,</span> DefaultContentType<span style="color:#f92672">.</span><span style="color:#a6e22e">RESOURCES</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">addScope</span><span style="color:#f92672">(</span>Scope<span style="color:#f92672">.</span><span style="color:#a6e22e">PROJECT</span><span style="color:#f92672">)</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">setFileCollection</span><span style="color:#f92672">(</span>
                                        scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getVariantData</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAllPostJavacGeneratedBytecode</span><span style="color:#f92672">())</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">());</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>scope<span style="color:#f92672">.</span><span style="color:#a6e22e">hasOutput</span><span style="color:#f92672">(</span>TaskOutputHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">TaskOutputType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RUNTIME_R_CLASS_CLASSES</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransformManager</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">addStream</span><span style="color:#f92672">(</span>
                            OriginalStream<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">(</span>project<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;final-r-classes&#34;</span><span style="color:#f92672">)</span>
                                    <span style="color:#f92672">.</span><span style="color:#a6e22e">addContentTypes</span><span style="color:#f92672">(</span>
                                            DefaultContentType<span style="color:#f92672">.</span><span style="color:#a6e22e">CLASSES</span><span style="color:#f92672">,</span>
                                            DefaultContentType<span style="color:#f92672">.</span><span style="color:#a6e22e">RESOURCES</span><span style="color:#f92672">)</span>
                                    <span style="color:#f92672">.</span><span style="color:#a6e22e">addScope</span><span style="color:#f92672">(</span>Scope<span style="color:#f92672">.</span><span style="color:#a6e22e">PROJECT</span><span style="color:#f92672">)</span>
                                    <span style="color:#f92672">.</span><span style="color:#a6e22e">setFileCollection</span><span style="color:#f92672">(</span>
                                            scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getOutput</span><span style="color:#f92672">(</span>
                                                    TaskOutputHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">TaskOutputType</span>
                                                            <span style="color:#f92672">.</span><span style="color:#a6e22e">RUNTIME_R_CLASS_CLASSES</span><span style="color:#f92672">))</span>
                                    <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TaskManager</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Creates the post-compilation tasks for the given Variant.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * These tasks create the dex file from the .class files, plus optional intermediary steps like
</span><span style="color:#75715e">     * proguard and jacoco
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">createPostCompilationTasks</span><span style="color:#f92672">(</span>

            <span style="color:#a6e22e">@NonNull</span> <span style="color:#66d9ef">final</span> VariantScope variantScope<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        checkNotNull<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getJavacTask</span><span style="color:#f92672">());</span>

        <span style="color:#66d9ef">final</span> BaseVariantData variantData <span style="color:#f92672">=</span> variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getVariantData</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> GradleVariantConfiguration config <span style="color:#f92672">=</span> variantData<span style="color:#f92672">.</span><span style="color:#a6e22e">getVariantConfiguration</span><span style="color:#f92672">();</span>

        TransformManager transformManager <span style="color:#f92672">=</span> variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransformManager</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// ---- Code Coverage first -----
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">boolean</span> isTestCoverageEnabled <span style="color:#f92672">=</span>
                config<span style="color:#f92672">.</span><span style="color:#a6e22e">getBuildType</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isTestCoverageEnabled</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>config<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isForTesting</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstantRunBuildContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isInInstantRunMode</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isTestCoverageEnabled<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            createJacocoTransform<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        maybeCreateDesugarTask<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">,</span> config<span style="color:#f92672">.</span><span style="color:#a6e22e">getMinSdkVersion</span><span style="color:#f92672">(),</span> transformManager<span style="color:#f92672">);</span>

        AndroidConfig extension <span style="color:#f92672">=</span> variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getGlobalScope</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getExtension</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// Merge Java Resources.
</span><span style="color:#75715e"></span>        createMergeJavaResTransform<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">);</span>

        <span style="color:#75715e">// ----- External Transforms -----
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// apply all the external transforms.
</span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>Transform<span style="color:#f92672">&gt;</span> customTransforms <span style="color:#f92672">=</span> extension<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransforms</span><span style="color:#f92672">();</span>
        List<span style="color:#f92672">&lt;</span>List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;&gt;</span> customTransformsDependencies <span style="color:#f92672">=</span> extension<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransformsDependencies</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">,</span> count <span style="color:#f92672">=</span> customTransforms<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> i <span style="color:#f92672">&lt;</span> count<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            Transform transform <span style="color:#f92672">=</span> customTransforms<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>

            List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> deps <span style="color:#f92672">=</span> customTransformsDependencies<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
            transformManager
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">addTransform</span><span style="color:#f92672">(</span>taskFactory<span style="color:#f92672">,</span> variantScope<span style="color:#f92672">,</span> transform<span style="color:#f92672">)</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">ifPresent</span><span style="color:#f92672">(</span>
                            t <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
                                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>deps<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                                    t<span style="color:#f92672">.</span><span style="color:#a6e22e">dependsOn</span><span style="color:#f92672">(</span>deps<span style="color:#f92672">);</span>
                                <span style="color:#f92672">}</span>

                                <span style="color:#75715e">// if the task is a no-op then we make assemble task depend on it.
</span><span style="color:#75715e"></span>                                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getScopes</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                                    variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getAssembleTask</span><span style="color:#f92672">().</span><span style="color:#a6e22e">dependsOn</span><span style="color:#f92672">(</span>t<span style="color:#f92672">);</span>
                                <span style="color:#f92672">}</span>
                            <span style="color:#f92672">});</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ----- Android studio profiling transforms
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String jar <span style="color:#f92672">:</span> getAdvancedProfilingTransforms<span style="color:#f92672">(</span>projectOptions<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getVariantConfiguration</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getBuildType</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isDebuggable</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">&amp;&amp;</span> variantData<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>VariantType<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT</span><span style="color:#f92672">)</span>
                    <span style="color:#f92672">&amp;&amp;</span> jar <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                transformManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addTransform</span><span style="color:#f92672">(</span>
                        taskFactory<span style="color:#f92672">,</span> variantScope<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> CustomClassTransform<span style="color:#f92672">(</span>jar<span style="color:#f92672">));</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ----- Minify next -----
</span><span style="color:#75715e"></span>        maybeCreateJavaCodeShrinkerTransform<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">);</span>

        maybeCreateResourcesShrinkerTransform<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">);</span>

        <span style="color:#75715e">// ----- 10x support
</span><span style="color:#75715e"></span>
        PreColdSwapTask preColdSwapTask <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstantRunBuildContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isInInstantRunMode</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>

            DefaultTask allActionsAnchorTask <span style="color:#f92672">=</span> createInstantRunAllActionsTasks<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">assert</span> variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstantRunTaskManager</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            preColdSwapTask <span style="color:#f92672">=</span>
                    variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstantRunTaskManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">createPreColdswapTask</span><span style="color:#f92672">(</span>projectOptions<span style="color:#f92672">);</span>
            preColdSwapTask<span style="color:#f92672">.</span><span style="color:#a6e22e">dependsOn</span><span style="color:#f92672">(</span>allActionsAnchorTask<span style="color:#f92672">);</span>

            <span style="color:#75715e">// force pre-dexing to be true as we rely on individual slices to be packaged
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// separately.
</span><span style="color:#75715e"></span>            extension<span style="color:#f92672">.</span><span style="color:#a6e22e">getDexOptions</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setPreDexLibraries</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstantRunTaskManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">createSlicerTask</span><span style="color:#f92672">();</span>

            extension<span style="color:#f92672">.</span><span style="color:#a6e22e">getDexOptions</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setJumboMode</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// ----- Multi-Dex support
</span><span style="color:#75715e"></span>
        DexingType dexingType <span style="color:#f92672">=</span> variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getDexingType</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// Upgrade from legacy multi-dex to native multi-dex if possible when using with a device
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dexingType <span style="color:#f92672">==</span> DexingType<span style="color:#f92672">.</span><span style="color:#a6e22e">LEGACY_MULTIDEX</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getVariantConfiguration</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isMultiDexEnabled</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">&amp;&amp;</span> variantScope
                                    <span style="color:#f92672">.</span><span style="color:#a6e22e">getVariantConfiguration</span><span style="color:#f92672">()</span>
                                    <span style="color:#f92672">.</span><span style="color:#a6e22e">getMinSdkVersionWithTargetDeviceApi</span><span style="color:#f92672">()</span>
                                    <span style="color:#f92672">.</span><span style="color:#a6e22e">getFeatureLevel</span><span style="color:#f92672">()</span>
                            <span style="color:#f92672">&gt;=</span> 21<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                dexingType <span style="color:#f92672">=</span> DexingType<span style="color:#f92672">.</span><span style="color:#a6e22e">NATIVE_MULTIDEX</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        Optional<span style="color:#f92672">&lt;</span>TransformTask<span style="color:#f92672">&gt;</span> multiDexClassListTask<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dexingType <span style="color:#f92672">==</span> DexingType<span style="color:#f92672">.</span><span style="color:#a6e22e">LEGACY_MULTIDEX</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">boolean</span> proguardInPipeline <span style="color:#f92672">=</span> variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getCodeShrinker</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> CodeShrinker<span style="color:#f92672">.</span><span style="color:#a6e22e">PROGUARD</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">// If ProGuard will be used, we&#39;ll end up with a &#34;fat&#34; jar anyway. If we&#39;re using the
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// new dexing pipeline, we&#39;ll use the new MainDexListTransform below, so there&#39;s no need
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// for merging all classes into a single jar.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>proguardInPipeline <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>usingIncrementalDexing<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Create a transform to jar the inputs into a single jar. Merge the classes only,
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// no need to package the resources since they are not used during the computation.
</span><span style="color:#75715e"></span>                JarMergingTransform jarMergingTransform <span style="color:#f92672">=</span>
                        <span style="color:#66d9ef">new</span> JarMergingTransform<span style="color:#f92672">(</span>TransformManager<span style="color:#f92672">.</span><span style="color:#a6e22e">SCOPE_FULL_PROJECT</span><span style="color:#f92672">);</span>
                transformManager
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">addTransform</span><span style="color:#f92672">(</span>taskFactory<span style="color:#f92672">,</span> variantScope<span style="color:#f92672">,</span> jarMergingTransform<span style="color:#f92672">)</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">ifPresent</span><span style="color:#f92672">(</span>variantScope<span style="color:#f92672">::</span>addColdSwapBuildTask<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// ---------
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// create the transform that&#39;s going to take the code and the proguard keep list
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// from above and compute the main class list.
</span><span style="color:#75715e"></span>            Transform multiDexTransform<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>usingIncrementalDexing<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>projectOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>BooleanOption<span style="color:#f92672">.</span><span style="color:#a6e22e">ENABLE_D8_MAIN_DEX_LIST</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    multiDexTransform <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> D8MainDexListTransform<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    multiDexTransform <span style="color:#f92672">=</span>
                            <span style="color:#66d9ef">new</span> MainDexListTransform<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">,</span> extension<span style="color:#f92672">.</span><span style="color:#a6e22e">getDexOptions</span><span style="color:#f92672">());</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                multiDexTransform <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MultiDexTransform<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">,</span> extension<span style="color:#f92672">.</span><span style="color:#a6e22e">getDexOptions</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
            multiDexClassListTask <span style="color:#f92672">=</span>
                    transformManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addTransform</span><span style="color:#f92672">(</span>taskFactory<span style="color:#f92672">,</span> variantScope<span style="color:#f92672">,</span> multiDexTransform<span style="color:#f92672">);</span>
            multiDexClassListTask<span style="color:#f92672">.</span><span style="color:#a6e22e">ifPresent</span><span style="color:#f92672">(</span>variantScope<span style="color:#f92672">::</span>addColdSwapBuildTask<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            multiDexClassListTask <span style="color:#f92672">=</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">empty</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>


        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>usingIncrementalDexing<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            createNewDexTasks<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">,</span> multiDexClassListTask<span style="color:#f92672">.</span><span style="color:#a6e22e">orElse</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">),</span> dexingType<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            createDexTasks<span style="color:#f92672">(</span>variantScope<span style="color:#f92672">,</span> multiDexClassListTask<span style="color:#f92672">.</span><span style="color:#a6e22e">orElse</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">),</span> dexingType<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preColdSwapTask <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>DefaultTask task <span style="color:#f92672">:</span> variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getColdSwapBuildTasks</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                task<span style="color:#f92672">.</span><span style="color:#a6e22e">dependsOn</span><span style="color:#f92672">(</span>preColdSwapTask<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ---- Create tasks to publish the pipeline output as needed.
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">final</span> File intermediatesDir <span style="color:#f92672">=</span> variantScope<span style="color:#f92672">.</span><span style="color:#a6e22e">getGlobalScope</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getIntermediatesDir</span><span style="color:#f92672">();</span>
        createPipelineToPublishTask<span style="color:#f92672">(</span>
                variantScope<span style="color:#f92672">,</span>
                transformManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getPipelineOutputAsFileCollection</span><span style="color:#f92672">(</span>StreamFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">DEX</span><span style="color:#f92672">),</span>
                FileUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">join</span><span style="color:#f92672">(</span>intermediatesDir<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;bundling&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;dex&#34;</span><span style="color:#f92672">),</span>
                PUBLISHED_DEX<span style="color:#f92672">);</span>

        createPipelineToPublishTask<span style="color:#f92672">(</span>
                variantScope<span style="color:#f92672">,</span>
                transformManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getPipelineOutputAsFileCollection</span><span style="color:#f92672">(</span>StreamFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">RESOURCES</span><span style="color:#f92672">),</span>
                FileUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">join</span><span style="color:#f92672">(</span>intermediatesDir<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;bundling&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;java-res&#34;</span><span style="color:#f92672">),</span>
                PUBLISHED_JAVA_RES<span style="color:#f92672">);</span>

        createPipelineToPublishTask<span style="color:#f92672">(</span>
                variantScope<span style="color:#f92672">,</span>
                transformManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getPipelineOutputAsFileCollection</span><span style="color:#f92672">(</span>StreamFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">NATIVE_LIBS</span><span style="color:#f92672">),</span>
                FileUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">join</span><span style="color:#f92672">(</span>intermediatesDir<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;bundling&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;native-libs&#34;</span><span style="color:#f92672">),</span>
                PUBLISHED_NATIVE_LIBS<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="转换任务transformtask的添加">转换任务（<code>TransformTask</code>）的添加</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Manages the transforms for a variant.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * &lt;p&gt;The actual execution is handled by Gradle through the tasks.
</span><span style="color:#75715e"> * Instead it&#39;s a means to more easily configure a series of transforms that consume each other&#39;s
</span><span style="color:#75715e"> * inputs when several of these transform are optional.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TransformManager</span> <span style="color:#66d9ef">extends</span> FilterableStreamCollection <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Adds a Transform.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;This makes the current transform consumes whatever Streams are currently available and
</span><span style="color:#75715e">     * creates new ones for the transform output.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;his also creates a {@link TransformTask} to run the transform and wire it up with the
</span><span style="color:#75715e">     * dependencies of the consumed streams.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param taskFactory the task factory
</span><span style="color:#75715e">     * @param scope the current scope
</span><span style="color:#75715e">     * @param transform the transform to add
</span><span style="color:#75715e">     * @param callback a callback that is run when the task is actually configured
</span><span style="color:#75715e">     * @param &lt;T&gt; the type of the transform
</span><span style="color:#75715e">     * @return {@code Optional&lt;AndroidTask&lt;Transform&gt;&gt;} containing the AndroidTask for the given
</span><span style="color:#75715e">     *     transform task if it was able to create it
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@NonNull</span>
    <span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T <span style="color:#66d9ef">extends</span> Transform<span style="color:#f92672">&gt;</span> Optional<span style="color:#f92672">&lt;</span>TransformTask<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">addTransform</span><span style="color:#f92672">(</span>
            <span style="color:#a6e22e">@NonNull</span> TaskFactory taskFactory<span style="color:#f92672">,</span>
            <span style="color:#a6e22e">@NonNull</span> TransformVariantScope scope<span style="color:#f92672">,</span>
            <span style="color:#a6e22e">@NonNull</span> T transform<span style="color:#f92672">,</span>
            <span style="color:#a6e22e">@Nullable</span> TransformTask<span style="color:#f92672">.</span><span style="color:#a6e22e">ConfigActionCallback</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> callback<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>validateTransform<span style="color:#f92672">(</span>transform<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// validate either throws an exception, or records the problem during sync
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// so it&#39;s safe to just return null here.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">empty</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        List<span style="color:#f92672">&lt;</span>TransformStream<span style="color:#f92672">&gt;</span> inputStreams <span style="color:#f92672">=</span> Lists<span style="color:#f92672">.</span><span style="color:#a6e22e">newArrayList</span><span style="color:#f92672">();</span>
        String taskName <span style="color:#f92672">=</span> scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getTaskName</span><span style="color:#f92672">(</span>getTaskNamePrefix<span style="color:#f92672">(</span>transform<span style="color:#f92672">));</span>

        <span style="color:#75715e">// get referenced-only streams
</span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>TransformStream<span style="color:#f92672">&gt;</span> referencedStreams <span style="color:#f92672">=</span> grabReferencedStreams<span style="color:#f92672">(</span>transform<span style="color:#f92672">);</span>

        <span style="color:#75715e">// find input streams, and compute output streams for the transform.
</span><span style="color:#75715e"></span>        IntermediateStream outputStream <span style="color:#f92672">=</span> findTransformStreams<span style="color:#f92672">(</span>
                transform<span style="color:#f92672">,</span>
                scope<span style="color:#f92672">,</span>
                inputStreams<span style="color:#f92672">,</span>
                taskName<span style="color:#f92672">,</span>
                scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getGlobalScope</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getBuildDir</span><span style="color:#f92672">());</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>inputStreams<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> referencedStreams<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// didn&#39;t find any match. Means there is a broken order somewhere in the streams.
</span><span style="color:#75715e"></span>            issueReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">reportError</span><span style="color:#f92672">(</span>
                    Type<span style="color:#f92672">.</span><span style="color:#a6e22e">GENERIC</span><span style="color:#f92672">,</span>
                    String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span>
                            <span style="color:#e6db74">&#34;Unable to add Transform &#39;%s&#39; on variant &#39;%s&#39;: requested streams not available: %s+%s / %s&#34;</span><span style="color:#f92672">,</span>
                            transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span>
                            scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getFullVariantName</span><span style="color:#f92672">(),</span>
                            transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getScopes</span><span style="color:#f92672">(),</span>
                            transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getReferencedScopes</span><span style="color:#f92672">(),</span>
                            transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputTypes</span><span style="color:#f92672">()));</span>
            <span style="color:#66d9ef">return</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">empty</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">//noinspection PointlessBooleanExpression
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG <span style="color:#f92672">&amp;&amp;</span> logger<span style="color:#f92672">.</span><span style="color:#a6e22e">isEnabled</span><span style="color:#f92672">(</span>LogLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ADDED TRANSFORM(&#34;</span> <span style="color:#f92672">+</span> scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getFullVariantName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;):&#34;</span><span style="color:#f92672">);</span>
            logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\tName: &#34;</span> <span style="color:#f92672">+</span> transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
            logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\tTask: &#34;</span> <span style="color:#f92672">+</span> taskName<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>TransformStream sd <span style="color:#f92672">:</span> inputStreams<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\tInputStream: &#34;</span> <span style="color:#f92672">+</span> sd<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>TransformStream sd <span style="color:#f92672">:</span> referencedStreams<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\tRef&#39;edStream: &#34;</span> <span style="color:#f92672">+</span> sd<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outputStream <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\tOutputStream: &#34;</span> <span style="color:#f92672">+</span> outputStream<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        transforms<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>transform<span style="color:#f92672">);</span>

        <span style="color:#75715e">// create the task...
</span><span style="color:#75715e"></span>        TransformTask task <span style="color:#f92672">=</span>
                taskFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>
                        <span style="color:#66d9ef">new</span> TransformTask<span style="color:#f92672">.</span><span style="color:#a6e22e">ConfigAction</span><span style="color:#f92672">&lt;&gt;(</span>
                                scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getFullVariantName</span><span style="color:#f92672">(),</span>
                                taskName<span style="color:#f92672">,</span>
                                transform<span style="color:#f92672">,</span>
                                inputStreams<span style="color:#f92672">,</span>
                                referencedStreams<span style="color:#f92672">,</span>
                                outputStream<span style="color:#f92672">,</span>
                                recorder<span style="color:#f92672">,</span>
                                callback<span style="color:#f92672">));</span>

        <span style="color:#66d9ef">return</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">ofNullable</span><span style="color:#f92672">(</span>task<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

     <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Finds the stream the transform consumes, and return them.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;This also removes them from the instance list. They will be replaced with the output
</span><span style="color:#75715e">     * stream(s) from the transform.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * &lt;p&gt;This returns an optional output stream.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param transform the transform.
</span><span style="color:#75715e">     * @param scope the scope the transform is applied to.
</span><span style="color:#75715e">     * @param inputStreams the out list of input streams for the transform.
</span><span style="color:#75715e">     * @param taskName the name of the task that will run the transform
</span><span style="color:#75715e">     * @param buildDir the build dir of the project.
</span><span style="color:#75715e">     * @return the output stream if any.
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@Nullable</span>
    <span style="color:#66d9ef">private</span> IntermediateStream <span style="color:#a6e22e">findTransformStreams</span><span style="color:#f92672">(</span>
            <span style="color:#a6e22e">@NonNull</span> Transform transform<span style="color:#f92672">,</span>
            <span style="color:#a6e22e">@NonNull</span> TransformVariantScope scope<span style="color:#f92672">,</span>
            <span style="color:#a6e22e">@NonNull</span> List<span style="color:#f92672">&lt;</span>TransformStream<span style="color:#f92672">&gt;</span> inputStreams<span style="color:#f92672">,</span>
            <span style="color:#a6e22e">@NonNull</span> String taskName<span style="color:#f92672">,</span>
            <span style="color:#a6e22e">@NonNull</span> File buildDir<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        Set<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> Scope<span style="color:#f92672">&gt;</span> requestedScopes <span style="color:#f92672">=</span> transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getScopes</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestedScopes<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// this is a no-op transform.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        Set<span style="color:#f92672">&lt;</span>ContentType<span style="color:#f92672">&gt;</span> requestedTypes <span style="color:#f92672">=</span> transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputTypes</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// list to hold the list of unused streams in the manager after everything is done.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// they&#39;ll be put back in the streams collection, along with the new outputs.
</span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>TransformStream<span style="color:#f92672">&gt;</span> oldStreams <span style="color:#f92672">=</span> Lists<span style="color:#f92672">.</span><span style="color:#a6e22e">newArrayListWithExpectedSize</span><span style="color:#f92672">(</span>streams<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>TransformStream stream <span style="color:#f92672">:</span> streams<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// streams may contain more than we need. In this case, we&#39;ll make a copy of the stream
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// with the remaining types/scopes. It&#39;ll be up to the TransformTask to make
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// sure that the content of the stream is usable (for instance when a stream
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// may contain two scopes, these scopes could be combined or not, impacting consumption)
</span><span style="color:#75715e"></span>            Set<span style="color:#f92672">&lt;</span>ContentType<span style="color:#f92672">&gt;</span> availableTypes <span style="color:#f92672">=</span> stream<span style="color:#f92672">.</span><span style="color:#a6e22e">getContentTypes</span><span style="color:#f92672">();</span>
            Set<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> Scope<span style="color:#f92672">&gt;</span> availableScopes <span style="color:#f92672">=</span> stream<span style="color:#f92672">.</span><span style="color:#a6e22e">getScopes</span><span style="color:#f92672">();</span>

            Set<span style="color:#f92672">&lt;</span>ContentType<span style="color:#f92672">&gt;</span> commonTypes <span style="color:#f92672">=</span> Sets<span style="color:#f92672">.</span><span style="color:#a6e22e">intersection</span><span style="color:#f92672">(</span>requestedTypes<span style="color:#f92672">,</span>
                    availableTypes<span style="color:#f92672">);</span>
            Set<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> Scope<span style="color:#f92672">&gt;</span> commonScopes <span style="color:#f92672">=</span> Sets<span style="color:#f92672">.</span><span style="color:#a6e22e">intersection</span><span style="color:#f92672">(</span>requestedScopes<span style="color:#f92672">,</span> availableScopes<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>commonTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>commonScopes<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>

                <span style="color:#75715e">// check if we need to make another stream from this one with less scopes/types.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>commonScopes<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>availableScopes<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>commonTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>availableTypes<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// first the stream that gets consumed. It consumes only the common types/scopes
</span><span style="color:#75715e"></span>                    inputStreams<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>stream<span style="color:#f92672">.</span><span style="color:#a6e22e">makeRestrictedCopy</span><span style="color:#f92672">(</span>commonTypes<span style="color:#f92672">,</span> commonScopes<span style="color:#f92672">));</span>

                    <span style="color:#75715e">// Now we could have two more streams. One with the requestedScope but the remainingTypes, and the other one with the remaining scopes and all the types.
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// compute remaining scopes/types.
</span><span style="color:#75715e"></span>                    Sets<span style="color:#f92672">.</span><span style="color:#a6e22e">SetView</span><span style="color:#f92672">&lt;</span>ContentType<span style="color:#f92672">&gt;</span> remainingTypes <span style="color:#f92672">=</span>
                            Sets<span style="color:#f92672">.</span><span style="color:#a6e22e">difference</span><span style="color:#f92672">(</span>availableTypes<span style="color:#f92672">,</span> commonTypes<span style="color:#f92672">);</span>
                    Sets<span style="color:#f92672">.</span><span style="color:#a6e22e">SetView</span><span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> Scope<span style="color:#f92672">&gt;</span> remainingScopes <span style="color:#f92672">=</span> Sets<span style="color:#f92672">.</span><span style="color:#a6e22e">difference</span><span style="color:#f92672">(</span>availableScopes<span style="color:#f92672">,</span> commonScopes<span style="color:#f92672">);</span>

                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>remainingTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        oldStreams<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>
                                stream<span style="color:#f92672">.</span><span style="color:#a6e22e">makeRestrictedCopy</span><span style="color:#f92672">(</span>
                                        remainingTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">immutableCopy</span><span style="color:#f92672">(),</span> availableScopes<span style="color:#f92672">));</span>
                    <span style="color:#f92672">}</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>remainingScopes<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        oldStreams<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>
                                stream<span style="color:#f92672">.</span><span style="color:#a6e22e">makeRestrictedCopy</span><span style="color:#f92672">(</span>
                                        availableTypes<span style="color:#f92672">,</span> remainingScopes<span style="color:#f92672">.</span><span style="color:#a6e22e">immutableCopy</span><span style="color:#f92672">()));</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// stream is an exact match (or at least subset) for the request,
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// so we add it as it.
</span><span style="color:#75715e"></span>                    inputStreams<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>stream<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// stream is not used, keep it around.
</span><span style="color:#75715e"></span>                oldStreams<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>stream<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// create the output stream.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// create single combined output stream for all types and scopes
</span><span style="color:#75715e"></span>        Set<span style="color:#f92672">&lt;</span>ContentType<span style="color:#f92672">&gt;</span> outputTypes <span style="color:#f92672">=</span> transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getOutputTypes</span><span style="color:#f92672">();</span>

        File outRootFolder <span style="color:#f92672">=</span> FileUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">join</span><span style="color:#f92672">(</span>buildDir<span style="color:#f92672">,</span> StringHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">toStrings</span><span style="color:#f92672">(</span>
                AndroidProject<span style="color:#f92672">.</span><span style="color:#a6e22e">FD_INTERMEDIATES</span><span style="color:#f92672">,</span>
                FD_TRANSFORMS<span style="color:#f92672">,</span>
                transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span>
                scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getDirectorySegments</span><span style="color:#f92672">()));</span>

        <span style="color:#75715e">// update the list of available streams.
</span><span style="color:#75715e"></span>        streams<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        streams<span style="color:#f92672">.</span><span style="color:#a6e22e">addAll</span><span style="color:#f92672">(</span>oldStreams<span style="color:#f92672">);</span>

        <span style="color:#75715e">// create the output
</span><span style="color:#75715e"></span>        IntermediateStream outptStream <span style="color:#f92672">=</span>
                IntermediateStream<span style="color:#f92672">.</span><span style="color:#a6e22e">builder</span><span style="color:#f92672">(</span>
                                project<span style="color:#f92672">,</span> transform<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">+</span> scope<span style="color:#f92672">.</span><span style="color:#a6e22e">getFullVariantName</span><span style="color:#f92672">())</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">addContentTypes</span><span style="color:#f92672">(</span>outputTypes<span style="color:#f92672">)</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">addScopes</span><span style="color:#f92672">(</span>requestedScopes<span style="color:#f92672">)</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">setRootLocation</span><span style="color:#f92672">(</span>outRootFolder<span style="color:#f92672">)</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">setTaskName</span><span style="color:#f92672">(</span>taskName<span style="color:#f92672">)</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// and add it to the list of available streams for next transforms.
</span><span style="color:#75715e"></span>        streams<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>outputStream<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> outputStream<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p><code>findTransformStreams()</code>方法中，首先创建了一个<code>oldStreams</code>用于持有最终未使用的流。然后遍历当前可用的流<code>streams</code>，获取每个流<code>stream</code>的内容<code>ContentType</code>和范围<code>Scope</code>，然后计算转换器请求的流和这个输入流的内容和范围的交集。然后判断内容和范围的交集是否为空：</p>
<ul>
<li>如果没有交集，说明该输入流未被使用，它会加入到<code>oldStreams</code>中。</li>
<li>如果存在交集，判断交集和可用流提供的内容和范围是否一致：
<ul>
<li>如果一致，则直接将该流<code>stream</code>加如到转换器的输入流<code>inputStreams</code></li>
<li>如果不一致，表明提供的流的范围和内容存在转换器不需要的部分
<ul>
<li>首先创建该<code>stream</code>的由内容和范围交集所限定的一个复本，并加入到<code>inputStreams</code></li>
<li>然后处理该<code>stream</code>剩余内容和范围的部分，这部分未被使用，它们会被加入到<code>oldStreams</code>中
<ul>
<li>如果剩余内容不为空，根据该内容和原范围创建<code>stream</code>复本并加入到<code>oldStreams</code></li>
<li>如果剩余范围不为空，根据该范围和原内容创建<code>stream</code>复本并加入到<code>oldStreams</code>
最后创建输出流<code>outputStream</code>，并将未使用的<code>oldStreams</code>和<code>outputStream</code>都加入到<code>streams</code>中供下一个转换器消费。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="转换流水线transform-pipeline">转换流水线（transform pipeline）</h4>
<p>最终实际上是根据自定义的<code>Transform</code>创建对应的<code>TransformTask</code>并将其加入到构建任务依赖结构中。<code>TransformManager</code>维护一个供<code>Transform</code>消费的转换流<code>List&lt;TransformStream&gt; streams</code>，在创建转换任务之前，其初始化为javac提供的<code>OriginalStream</code>。在添加自定义<code>Transform</code>的过程中，核心方法是<code>findTransformStreams()</code>，该方法根据<code>Transform</code>对<code>stream</code>流的消费，对<code>streams</code>进行更新，其中<code>Transform</code>的输出流会加入到其中，这样当前<code>Transform</code>的输出会添加到下一个<code>Transform</code>的输入中，这样就组成了<code>Transform</code>的流水线。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="http://google.github.io/android-gradle-dsl/javadoc/current/">Android Gradle API</a></li>
<li><a href="http://google.github.io/android-gradle-dsl/current/">Android Gradle DSL</a></li>
<li><a href="https://docs.gradle.org/current/userguide/custom_plugins.html">自定义插件</a></li>
<li><a href="https://github.com/evant/gradle-retrolambda">gradle-retrolambda</a></li>
<li><a href="https://blog.csdn.net/sbsujjbcy/article/details/50839263">Android 热修复使用Gradle Plugin1.5改造Nuwa插件</a></li>
<li><a href="https://www.jianshu.com/p/37df81365edf">如何理解 Transform API</a></li>
<li><a href="https://blog.csdn.net/eclipsexys/article/details/54425414">看AspectJ在Android中的强势插入</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-asm30/index.html">AOP 的利器：ASM 3.0 介绍</a></li>
</ul>

                </div>
                
            </article>
        </div>
    </div>

                </div>
                <footer>
    Powered by <a target="_blank" href="https://gohugo.io/">Hugo</a> And 
    <a target="_blank" href="https://pages.github.com/">Github Pages</a>
</footer>
                <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
                

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>

                <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.12.0/styles/default.min.css">
                <script src="/js/highlight.pack.js"></script>
                <script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
                <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [
                ['$', '$'],
                ['\\(', '\\)']
            ],
            displayMath: [
                ['$$', '$$']
            ],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });
    MathJax.Hub.Queue(function () {



        var all = MathJax.Hub.getAllJax(),
            i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

    MathJax.Hub.Config({

        TeX: {
            equationNumbers: {
                autoNumber: "AMS"
            }
        }
    });
</script>
                <script type="text/javascript" src="/js/main.js"></script>
        </div>
    </body>

</html>